(function(window, undefined) {
    "use strict";
    var Hammer = function(element, options) {
        return new Hammer.Instance(element, options || {});
    };
    Hammer.defaults = {
        stop_browser_behavior: {
            userSelect: "none",
            touchAction: "none",
            touchCallout: "none",
            contentZooming: "none",
            userDrag: "none",
            tapHighlightColor: "rgba(0,0,0,0)"
        }
    };
    Hammer.HAS_POINTEREVENTS = navigator.pointerEnabled || navigator.msPointerEnabled;
    Hammer.HAS_TOUCHEVENTS = "ontouchstart" in window;
    Hammer.MOBILE_REGEX = /mobile|tablet|ip(ad|hone|od)|android/i;
    Hammer.NO_MOUSEEVENTS = Hammer.HAS_TOUCHEVENTS && navigator.userAgent.match(Hammer.MOBILE_REGEX);
    Hammer.EVENT_TYPES = {};
    Hammer.DIRECTION_DOWN = "down";
    Hammer.DIRECTION_LEFT = "left";
    Hammer.DIRECTION_UP = "up";
    Hammer.DIRECTION_RIGHT = "right";
    Hammer.POINTER_MOUSE = "mouse";
    Hammer.POINTER_TOUCH = "touch";
    Hammer.POINTER_PEN = "pen";
    Hammer.EVENT_START = "start";
    Hammer.EVENT_MOVE = "move";
    Hammer.EVENT_END = "end";
    Hammer.DOCUMENT = document;
    Hammer.plugins = {};
    Hammer.READY = false;
    function setup() {
        if (Hammer.READY) {
            return;
        }
        Hammer.event.determineEventTypes();
        for (var name in Hammer.gestures) {
            if (Hammer.gestures.hasOwnProperty(name)) {
                Hammer.detection.register(Hammer.gestures[name]);
            }
        }
        Hammer.event.onTouch(Hammer.DOCUMENT, Hammer.EVENT_MOVE, Hammer.detection.detect);
        Hammer.event.onTouch(Hammer.DOCUMENT, Hammer.EVENT_END, Hammer.detection.detect);
        Hammer.READY = true;
    }
    Hammer.Instance = function(element, options) {
        var self = this;
        setup();
        this.element = element;
        this.enabled = true;
        this.options = Hammer.utils.extend(Hammer.utils.extend({}, Hammer.defaults), options || {});
        if (this.options.stop_browser_behavior) {
            Hammer.utils.stopDefaultBrowserBehavior(this.element, this.options.stop_browser_behavior);
        }
        Hammer.event.onTouch(element, Hammer.EVENT_START, function(ev) {
            if (self.enabled) {
                Hammer.detection.startDetect(self, ev);
            }
        });
        return this;
    };
    Hammer.Instance.prototype = {
        on: function onEvent(gesture, handler) {
            var gestures = gesture.split(" ");
            for (var t = 0; t < gestures.length; t++) {
                this.element.addEventListener(gestures[t], handler, false);
            }
            return this;
        },
        off: function offEvent(gesture, handler) {
            var gestures = gesture.split(" ");
            for (var t = 0; t < gestures.length; t++) {
                this.element.removeEventListener(gestures[t], handler, false);
            }
            return this;
        },
        trigger: function triggerEvent(gesture, eventData) {
            var event = Hammer.DOCUMENT.createEvent("Event");
            event.initEvent(gesture, true, true);
            event.gesture = eventData;
            var element = this.element;
            if (Hammer.utils.hasParent(eventData.target, element)) {
                element = eventData.target;
            }
            element.dispatchEvent(event);
            return this;
        },
        enable: function enable(state) {
            this.enabled = state;
            return this;
        }
    };
    var last_move_event = null;
    var enable_detect = false;
    var touch_triggered = false;
    Hammer.event = {
        bindDom: function(element, type, handler) {
            var types = type.split(" ");
            for (var t = 0; t < types.length; t++) {
                element.addEventListener(types[t], handler, false);
            }
        },
        onTouch: function onTouch(element, eventType, handler) {
            var self = this;
            this.bindDom(element, Hammer.EVENT_TYPES[eventType], function bindDomOnTouch(ev) {
                var sourceEventType = ev.type.toLowerCase();
                if (sourceEventType.match(/mouse/) && touch_triggered) {
                    return;
                } else if (sourceEventType.match(/touch/) || sourceEventType.match(/pointerdown/) || sourceEventType.match(/mouse/) && ev.which === 1) {
                    enable_detect = true;
                }
                if (sourceEventType.match(/touch|pointer/)) {
                    touch_triggered = true;
                }
                var count_touches = 0;
                if (enable_detect) {
                    if (Hammer.HAS_POINTEREVENTS && eventType != Hammer.EVENT_END) {
                        count_touches = Hammer.PointerEvent.updatePointer(eventType, ev);
                    } else if (sourceEventType.match(/touch/)) {
                        count_touches = ev.touches.length;
                    } else if (!touch_triggered) {
                        count_touches = sourceEventType.match(/up/) ? 0 : 1;
                    }
                    if (count_touches > 0 && eventType == Hammer.EVENT_END) {
                        eventType = Hammer.EVENT_MOVE;
                    } else if (!count_touches) {
                        eventType = Hammer.EVENT_END;
                    }
                    if (!count_touches && last_move_event !== null) {
                        ev = last_move_event;
                    } else {
                        last_move_event = ev;
                    }
                    handler.call(Hammer.detection, self.collectEventData(element, eventType, ev));
                    if (Hammer.HAS_POINTEREVENTS && eventType == Hammer.EVENT_END) {
                        count_touches = Hammer.PointerEvent.updatePointer(eventType, ev);
                    }
                }
                if (!count_touches) {
                    last_move_event = null;
                    enable_detect = false;
                    touch_triggered = false;
                    Hammer.PointerEvent.reset();
                }
            });
        },
        determineEventTypes: function determineEventTypes() {
            var types;
            if (Hammer.HAS_POINTEREVENTS) {
                types = Hammer.PointerEvent.getEvents();
            } else if (Hammer.NO_MOUSEEVENTS) {
                types = [ "touchstart", "touchmove", "touchend touchcancel" ];
            } else {
                types = [ "touchstart mousedown", "touchmove mousemove", "touchend touchcancel mouseup" ];
            }
            Hammer.EVENT_TYPES[Hammer.EVENT_START] = types[0];
            Hammer.EVENT_TYPES[Hammer.EVENT_MOVE] = types[1];
            Hammer.EVENT_TYPES[Hammer.EVENT_END] = types[2];
        },
        getTouchList: function getTouchList(ev) {
            if (Hammer.HAS_POINTEREVENTS) {
                return Hammer.PointerEvent.getTouchList();
            } else if (ev.touches) {
                return ev.touches;
            } else {
                return [ {
                    identifier: 1,
                    pageX: ev.pageX,
                    pageY: ev.pageY,
                    target: ev.target
                } ];
            }
        },
        collectEventData: function collectEventData(element, eventType, ev) {
            var touches = this.getTouchList(ev, eventType);
            var pointerType = Hammer.POINTER_TOUCH;
            if (ev.type.match(/mouse/) || Hammer.PointerEvent.matchType(Hammer.POINTER_MOUSE, ev)) {
                pointerType = Hammer.POINTER_MOUSE;
            }
            return {
                center: Hammer.utils.getCenter(touches),
                timeStamp: new Date().getTime(),
                target: ev.target,
                touches: touches,
                eventType: eventType,
                pointerType: pointerType,
                srcEvent: ev,
                preventDefault: function() {
                    if (this.srcEvent.preventManipulation) {
                        this.srcEvent.preventManipulation();
                    }
                    if (this.srcEvent.preventDefault) {
                        this.srcEvent.preventDefault();
                    }
                },
                stopPropagation: function() {
                    this.srcEvent.stopPropagation();
                },
                stopDetect: function() {
                    return Hammer.detection.stopDetect();
                }
            };
        }
    };
    Hammer.PointerEvent = {
        pointers: {},
        getTouchList: function() {
            var self = this;
            var touchlist = [];
            Object.keys(self.pointers).sort().forEach(function(id) {
                touchlist.push(self.pointers[id]);
            });
            return touchlist;
        },
        updatePointer: function(type, pointerEvent) {
            if (type == Hammer.EVENT_END) {
                this.pointers = {};
            } else {
                pointerEvent.identifier = pointerEvent.pointerId;
                this.pointers[pointerEvent.pointerId] = pointerEvent;
            }
            return Object.keys(this.pointers).length;
        },
        matchType: function(pointerType, ev) {
            if (!ev.pointerType) {
                return false;
            }
            var types = {};
            types[Hammer.POINTER_MOUSE] = ev.pointerType == ev.MSPOINTER_TYPE_MOUSE || ev.pointerType == Hammer.POINTER_MOUSE;
            types[Hammer.POINTER_TOUCH] = ev.pointerType == ev.MSPOINTER_TYPE_TOUCH || ev.pointerType == Hammer.POINTER_TOUCH;
            types[Hammer.POINTER_PEN] = ev.pointerType == ev.MSPOINTER_TYPE_PEN || ev.pointerType == Hammer.POINTER_PEN;
            return types[pointerType];
        },
        getEvents: function() {
            return [ "pointerdown MSPointerDown", "pointermove MSPointerMove", "pointerup pointercancel MSPointerUp MSPointerCancel" ];
        },
        reset: function() {
            this.pointers = {};
        }
    };
    Hammer.utils = {
        extend: function extend(dest, src, merge) {
            for (var key in src) {
                if (dest[key] !== undefined && merge) {
                    continue;
                }
                dest[key] = src[key];
            }
            return dest;
        },
        hasParent: function(node, parent) {
            while (node) {
                if (node == parent) {
                    return true;
                }
                node = node.parentNode;
            }
            return false;
        },
        getCenter: function getCenter(touches) {
            var valuesX = [], valuesY = [];
            for (var t = 0, len = touches.length; t < len; t++) {
                valuesX.push(touches[t].pageX);
                valuesY.push(touches[t].pageY);
            }
            return {
                pageX: (Math.min.apply(Math, valuesX) + Math.max.apply(Math, valuesX)) / 2,
                pageY: (Math.min.apply(Math, valuesY) + Math.max.apply(Math, valuesY)) / 2
            };
        },
        getVelocity: function getVelocity(delta_time, delta_x, delta_y) {
            return {
                x: Math.abs(delta_x / delta_time) || 0,
                y: Math.abs(delta_y / delta_time) || 0
            };
        },
        getAngle: function getAngle(touch1, touch2) {
            var y = touch2.pageY - touch1.pageY, x = touch2.pageX - touch1.pageX;
            return Math.atan2(y, x) * 180 / Math.PI;
        },
        getDirection: function getDirection(touch1, touch2) {
            var x = Math.abs(touch1.pageX - touch2.pageX), y = Math.abs(touch1.pageY - touch2.pageY);
            if (x >= y) {
                return touch1.pageX - touch2.pageX > 0 ? Hammer.DIRECTION_LEFT : Hammer.DIRECTION_RIGHT;
            } else {
                return touch1.pageY - touch2.pageY > 0 ? Hammer.DIRECTION_UP : Hammer.DIRECTION_DOWN;
            }
        },
        getDistance: function getDistance(touch1, touch2) {
            var x = touch2.pageX - touch1.pageX, y = touch2.pageY - touch1.pageY;
            return Math.sqrt(x * x + y * y);
        },
        getScale: function getScale(start, end) {
            if (start.length >= 2 && end.length >= 2) {
                return this.getDistance(end[0], end[1]) / this.getDistance(start[0], start[1]);
            }
            return 1;
        },
        getRotation: function getRotation(start, end) {
            if (start.length >= 2 && end.length >= 2) {
                return this.getAngle(end[1], end[0]) - this.getAngle(start[1], start[0]);
            }
            return 0;
        },
        isVertical: function isVertical(direction) {
            return direction == Hammer.DIRECTION_UP || direction == Hammer.DIRECTION_DOWN;
        },
        stopDefaultBrowserBehavior: function stopDefaultBrowserBehavior(element, css_props) {
            var prop, vendors = [ "webkit", "khtml", "moz", "ms", "o", "" ];
            if (!css_props || !element.style) {
                return;
            }
            for (var i = 0; i < vendors.length; i++) {
                for (var p in css_props) {
                    if (css_props.hasOwnProperty(p)) {
                        prop = p;
                        if (vendors[i]) {
                            prop = vendors[i] + prop.substring(0, 1).toUpperCase() + prop.substring(1);
                        }
                        element.style[prop] = css_props[p];
                    }
                }
            }
            if (css_props.userSelect == "none") {
                element.onselectstart = function() {
                    return false;
                };
            }
        }
    };
    Hammer.detection = {
        gestures: [],
        current: null,
        previous: null,
        stopped: false,
        startDetect: function startDetect(inst, eventData) {
            if (this.current) {
                return;
            }
            this.stopped = false;
            this.current = {
                inst: inst,
                startEvent: Hammer.utils.extend({}, eventData),
                lastEvent: false,
                name: ""
            };
            this.detect(eventData);
        },
        detect: function detect(eventData) {
            if (!this.current || this.stopped) {
                return;
            }
            eventData = this.extendEventData(eventData);
            var inst_options = this.current.inst.options;
            for (var g = 0, len = this.gestures.length; g < len; g++) {
                var gesture = this.gestures[g];
                if (!this.stopped && inst_options[gesture.name] !== false) {
                    if (gesture.handler.call(gesture, eventData, this.current.inst) === false) {
                        this.stopDetect();
                        break;
                    }
                }
            }
            if (this.current) {
                this.current.lastEvent = eventData;
            }
            if (eventData.eventType == Hammer.EVENT_END && !eventData.touches.length - 1) {
                this.stopDetect();
            }
            return eventData;
        },
        stopDetect: function stopDetect() {
            this.previous = Hammer.utils.extend({}, this.current);
            this.current = null;
            this.stopped = true;
        },
        extendEventData: function extendEventData(ev) {
            var startEv = this.current.startEvent;
            if (startEv && (ev.touches.length != startEv.touches.length || ev.touches === startEv.touches)) {
                startEv.touches = [];
                for (var i = 0, len = ev.touches.length; i < len; i++) {
                    startEv.touches.push(Hammer.utils.extend({}, ev.touches[i]));
                }
            }
            var delta_time = ev.timeStamp - startEv.timeStamp, delta_x = ev.center.pageX - startEv.center.pageX, delta_y = ev.center.pageY - startEv.center.pageY, velocity = Hammer.utils.getVelocity(delta_time, delta_x, delta_y);
            Hammer.utils.extend(ev, {
                deltaTime: delta_time,
                deltaX: delta_x,
                deltaY: delta_y,
                velocityX: velocity.x,
                velocityY: velocity.y,
                distance: Hammer.utils.getDistance(startEv.center, ev.center),
                angle: Hammer.utils.getAngle(startEv.center, ev.center),
                direction: Hammer.utils.getDirection(startEv.center, ev.center),
                scale: Hammer.utils.getScale(startEv.touches, ev.touches),
                rotation: Hammer.utils.getRotation(startEv.touches, ev.touches),
                startEvent: startEv
            });
            return ev;
        },
        register: function register(gesture) {
            var options = gesture.defaults || {};
            if (options[gesture.name] === undefined) {
                options[gesture.name] = true;
            }
            Hammer.utils.extend(Hammer.defaults, options, true);
            gesture.index = gesture.index || 1e3;
            this.gestures.push(gesture);
            this.gestures.sort(function(a, b) {
                if (a.index < b.index) {
                    return -1;
                }
                if (a.index > b.index) {
                    return 1;
                }
                return 0;
            });
            return this.gestures;
        }
    };
    Hammer.gestures = Hammer.gestures || {};
    Hammer.gestures.Hold = {
        name: "hold",
        index: 10,
        defaults: {
            hold_timeout: 500,
            hold_threshold: 1
        },
        timer: null,
        handler: function holdGesture(ev, inst) {
            switch (ev.eventType) {
              case Hammer.EVENT_START:
                clearTimeout(this.timer);
                Hammer.detection.current.name = this.name;
                this.timer = setTimeout(function() {
                    if (Hammer.detection.current.name == "hold") {
                        inst.trigger("hold", ev);
                    }
                }, inst.options.hold_timeout);
                break;

              case Hammer.EVENT_MOVE:
                if (ev.distance > inst.options.hold_threshold) {
                    clearTimeout(this.timer);
                }
                break;

              case Hammer.EVENT_END:
                clearTimeout(this.timer);
                break;
            }
        }
    };
    Hammer.gestures.Tap = {
        name: "tap",
        index: 100,
        defaults: {
            tap_max_touchtime: 250,
            tap_max_distance: 10,
            tap_always: true,
            doubletap_distance: 20,
            doubletap_interval: 300
        },
        handler: function tapGesture(ev, inst) {
            if (ev.eventType == Hammer.EVENT_END) {
                var prev = Hammer.detection.previous, did_doubletap = false;
                if (ev.deltaTime > inst.options.tap_max_touchtime || ev.distance > inst.options.tap_max_distance) {
                    return;
                }
                if (prev && prev.name == "tap" && ev.timeStamp - prev.lastEvent.timeStamp < inst.options.doubletap_interval && ev.distance < inst.options.doubletap_distance) {
                    inst.trigger("doubletap", ev);
                    did_doubletap = true;
                }
                if (!did_doubletap || inst.options.tap_always) {
                    Hammer.detection.current.name = "tap";
                    inst.trigger(Hammer.detection.current.name, ev);
                }
            }
        }
    };
    Hammer.gestures.Swipe = {
        name: "swipe",
        index: 40,
        defaults: {
            swipe_max_touches: 1,
            swipe_velocity: .7
        },
        handler: function swipeGesture(ev, inst) {
            if (ev.eventType == Hammer.EVENT_END) {
                if (inst.options.swipe_max_touches > 0 && ev.touches.length > inst.options.swipe_max_touches) {
                    return;
                }
                if (ev.velocityX > inst.options.swipe_velocity || ev.velocityY > inst.options.swipe_velocity) {
                    inst.trigger(this.name, ev);
                    inst.trigger(this.name + ev.direction, ev);
                }
            }
        }
    };
    Hammer.gestures.Drag = {
        name: "drag",
        index: 50,
        defaults: {
            drag_min_distance: 10,
            drag_max_touches: 1,
            drag_block_horizontal: false,
            drag_block_vertical: false,
            drag_lock_to_axis: false,
            drag_lock_min_distance: 25
        },
        triggered: false,
        handler: function dragGesture(ev, inst) {
            if (Hammer.detection.current.name != this.name && this.triggered) {
                inst.trigger(this.name + "end", ev);
                this.triggered = false;
                return;
            }
            if (inst.options.drag_max_touches > 0 && ev.touches.length > inst.options.drag_max_touches) {
                return;
            }
            switch (ev.eventType) {
              case Hammer.EVENT_START:
                this.triggered = false;
                break;

              case Hammer.EVENT_MOVE:
                if (ev.distance < inst.options.drag_min_distance && Hammer.detection.current.name != this.name) {
                    return;
                }
                Hammer.detection.current.name = this.name;
                if (Hammer.detection.current.lastEvent.drag_locked_to_axis || inst.options.drag_lock_to_axis && inst.options.drag_lock_min_distance <= ev.distance) {
                    ev.drag_locked_to_axis = true;
                }
                var last_direction = Hammer.detection.current.lastEvent.direction;
                if (ev.drag_locked_to_axis && last_direction !== ev.direction) {
                    if (Hammer.utils.isVertical(last_direction)) {
                        ev.direction = ev.deltaY < 0 ? Hammer.DIRECTION_UP : Hammer.DIRECTION_DOWN;
                    } else {
                        ev.direction = ev.deltaX < 0 ? Hammer.DIRECTION_LEFT : Hammer.DIRECTION_RIGHT;
                    }
                }
                if (!this.triggered) {
                    inst.trigger(this.name + "start", ev);
                    this.triggered = true;
                }
                inst.trigger(this.name, ev);
                inst.trigger(this.name + ev.direction, ev);
                if (inst.options.drag_block_vertical && Hammer.utils.isVertical(ev.direction) || inst.options.drag_block_horizontal && !Hammer.utils.isVertical(ev.direction)) {
                    ev.preventDefault();
                }
                break;

              case Hammer.EVENT_END:
                if (this.triggered) {
                    inst.trigger(this.name + "end", ev);
                }
                this.triggered = false;
                break;
            }
        }
    };
    Hammer.gestures.Transform = {
        name: "transform",
        index: 45,
        defaults: {
            transform_min_scale: .01,
            transform_min_rotation: 1,
            transform_always_block: false
        },
        triggered: false,
        handler: function transformGesture(ev, inst) {
            if (Hammer.detection.current.name != this.name && this.triggered) {
                inst.trigger(this.name + "end", ev);
                this.triggered = false;
                return;
            }
            if (ev.touches.length < 2) {
                return;
            }
            if (inst.options.transform_always_block) {
                ev.preventDefault();
            }
            switch (ev.eventType) {
              case Hammer.EVENT_START:
                this.triggered = false;
                break;

              case Hammer.EVENT_MOVE:
                var scale_threshold = Math.abs(1 - ev.scale);
                var rotation_threshold = Math.abs(ev.rotation);
                if (scale_threshold < inst.options.transform_min_scale && rotation_threshold < inst.options.transform_min_rotation) {
                    return;
                }
                Hammer.detection.current.name = this.name;
                if (!this.triggered) {
                    inst.trigger(this.name + "start", ev);
                    this.triggered = true;
                }
                inst.trigger(this.name, ev);
                if (rotation_threshold > inst.options.transform_min_rotation) {
                    inst.trigger("rotate", ev);
                }
                if (scale_threshold > inst.options.transform_min_scale) {
                    inst.trigger("pinch", ev);
                    inst.trigger("pinch" + (ev.scale < 1 ? "in" : "out"), ev);
                }
                break;

              case Hammer.EVENT_END:
                if (this.triggered) {
                    inst.trigger(this.name + "end", ev);
                }
                this.triggered = false;
                break;
            }
        }
    };
    Hammer.gestures.Touch = {
        name: "touch",
        index: -Infinity,
        defaults: {
            prevent_default: false,
            prevent_mouseevents: false
        },
        handler: function touchGesture(ev, inst) {
            if (inst.options.prevent_mouseevents && ev.pointerType == Hammer.POINTER_MOUSE) {
                ev.stopDetect();
                return;
            }
            if (inst.options.prevent_default) {
                ev.preventDefault();
            }
            if (ev.eventType == Hammer.EVENT_START) {
                inst.trigger(this.name, ev);
            }
        }
    };
    Hammer.gestures.Release = {
        name: "release",
        index: Infinity,
        handler: function releaseGesture(ev, inst) {
            if (ev.eventType == Hammer.EVENT_END) {
                inst.trigger(this.name, ev);
            }
        }
    };
    if (typeof module === "object" && typeof module.exports === "object") {
        module.exports = Hammer;
    } else {
        window.Hammer = Hammer;
        if (typeof window.define === "function" && window.define.amd) {
            window.define("hammer", [], function() {
                return Hammer;
            });
        }
    }
})(this);

(function($, undefined) {
    "use strict";
    if ($ === undefined) {
        return;
    }
    Hammer.event.bindDom = function(element, eventTypes, handler) {
        $(element).on(eventTypes, function(ev) {
            var data = ev.originalEvent || ev;
            if (data.pageX === undefined) {
                data.pageX = ev.pageX;
                data.pageY = ev.pageY;
            }
            if (!data.target) {
                data.target = ev.target;
            }
            if (data.which === undefined) {
                data.which = data.button;
            }
            if (!data.preventDefault) {
                data.preventDefault = ev.preventDefault;
            }
            if (!data.stopPropagation) {
                data.stopPropagation = ev.stopPropagation;
            }
            handler.call(this, data);
        });
    };
    Hammer.Instance.prototype.on = function(types, handler) {
        return $(this.element).on(types, handler);
    };
    Hammer.Instance.prototype.off = function(types, handler) {
        return $(this.element).off(types, handler);
    };
    Hammer.Instance.prototype.trigger = function(gesture, eventData) {
        var el = $(this.element);
        if (el.has(eventData.target).length) {
            el = $(eventData.target);
        }
        return el.trigger({
            type: gesture,
            gesture: eventData
        });
    };
    $.fn.hammer = function(options) {
        return this.each(function() {
            var el = $(this);
            var inst = el.data("hammer");
            if (!inst) {
                el.data("hammer", new Hammer(this, options || {}));
            } else if (inst && options) {
                Hammer.utils.extend(inst.options, options);
            }
        });
    };
})(window.jQuery || window.Zepto);

tfl.customValidation = {
    onfocusout: false,
    onfocusin: false,
    onkeyup: false,
    onclick: false,
    ignore: '.val-ignore, :hidden, :disabled, [type="file"]',
    showErrors: function(errorMap, errorList) {
        $(window).trigger("validationFired", errorMap);
        var $errorWrappers = tfl.forms.getErrorWrappers($(this.successList));
        tfl.forms.removeValidationClass($errorWrappers);
        tfl.forms.removeValidationAssistiveText($errorWrappers);
        var invalidElements = [];
        for (var i = 0; i < errorList.length; i++) {
            invalidElements.push(errorList[i].element);
        }
        var $invalidElements = $(invalidElements);
        tfl.forms.addValidationClass($invalidElements);
        tfl.forms.addErrorsToLabels(errorList);
        this.defaultShowErrors();
    }
};

(function(factory) {
    if (typeof define === "function" && define.amd) {
        define([ "jquery" ], factory);
    } else if (typeof module === "object" && module.exports) {
        module.exports = factory(require("jquery"));
    } else {
        factory(jQuery);
    }
})(function($) {
    $.extend($.fn, {
        validate: function(options) {
            if (!this.length) {
                if (options && options.debug && window.console) {
                    console.warn("Nothing selected, can't validate, returning nothing.");
                }
                return;
            }
            var validator = $.data(this[0], "validator");
            if (validator) {
                return validator;
            }
            this.attr("novalidate", "novalidate");
            validator = new $.validator(options, this[0]);
            $.data(this[0], "validator", validator);
            if (validator.settings.onsubmit) {
                this.on("click.validate", ":submit", function(event) {
                    if (validator.settings.submitHandler) {
                        validator.submitButton = event.target;
                    }
                    if ($(this).hasClass("cancel")) {
                        validator.cancelSubmit = true;
                    }
                    if ($(this).attr("formnovalidate") !== undefined) {
                        validator.cancelSubmit = true;
                    }
                });
                this.on("submit.validate", function(event) {
                    if (validator.settings.debug) {
                        event.preventDefault();
                    }
                    function handle() {
                        var hidden, result;
                        if (validator.settings.submitHandler) {
                            if (validator.submitButton) {
                                hidden = $("<input type='hidden'/>").attr("name", validator.submitButton.name).val($(validator.submitButton).val()).appendTo(validator.currentForm);
                            }
                            result = validator.settings.submitHandler.call(validator, validator.currentForm, event);
                            if (validator.submitButton) {
                                hidden.remove();
                            }
                            if (result !== undefined) {
                                return result;
                            }
                            return false;
                        }
                        return true;
                    }
                    if (validator.cancelSubmit) {
                        validator.cancelSubmit = false;
                        return handle();
                    }
                    if (validator.form()) {
                        if (validator.pendingRequest) {
                            validator.formSubmitted = true;
                            return false;
                        }
                        return handle();
                    } else {
                        validator.focusInvalid();
                        return false;
                    }
                });
            }
            return validator;
        },
        valid: function() {
            var valid, validator, errorList;
            if ($(this[0]).is("form")) {
                valid = this.validate().form();
            } else {
                errorList = [];
                valid = true;
                validator = $(this[0].form).validate();
                this.each(function() {
                    valid = validator.element(this) && valid;
                    if (!valid) {
                        errorList = errorList.concat(validator.errorList);
                    }
                });
                validator.errorList = errorList;
            }
            return valid;
        },
        rules: function(command, argument) {
            if (!this.length) {
                return;
            }
            var element = this[0], settings, staticRules, existingRules, data, param, filtered;
            if (command) {
                settings = $.data(element.form, "validator").settings;
                staticRules = settings.rules;
                existingRules = $.validator.staticRules(element);
                switch (command) {
                  case "add":
                    $.extend(existingRules, $.validator.normalizeRule(argument));
                    delete existingRules.messages;
                    staticRules[element.name] = existingRules;
                    if (argument.messages) {
                        settings.messages[element.name] = $.extend(settings.messages[element.name], argument.messages);
                    }
                    break;

                  case "remove":
                    if (!argument) {
                        delete staticRules[element.name];
                        return existingRules;
                    }
                    filtered = {};
                    $.each(argument.split(/\s/), function(index, method) {
                        filtered[method] = existingRules[method];
                        delete existingRules[method];
                        if (method === "required") {
                            $(element).removeAttr("aria-required");
                        }
                    });
                    return filtered;
                }
            }
            data = $.validator.normalizeRules($.extend({}, $.validator.classRules(element), $.validator.attributeRules(element), $.validator.dataRules(element), $.validator.staticRules(element)), element);
            if (data.required) {
                param = data.required;
                delete data.required;
                data = $.extend({
                    required: param
                }, data);
                $(element).attr("aria-required", "true");
            }
            if (data.remote) {
                param = data.remote;
                delete data.remote;
                data = $.extend(data, {
                    remote: param
                });
            }
            return data;
        }
    });
    $.extend($.expr[":"], {
        blank: function(a) {
            return !$.trim("" + $(a).val());
        },
        filled: function(a) {
            var val = $(a).val();
            return val !== null && !!$.trim("" + val);
        },
        unchecked: function(a) {
            return !$(a).prop("checked");
        }
    });
    $.validator = function(options, form) {
        if (tfl && tfl.hasOwnProperty("customValidation")) {
            this.settings = $.extend(true, {}, $.validator.defaults, options, tfl.customValidation);
        } else {
            this.settings = $.extend(true, {}, $.validator.defaults);
        }
        this.currentForm = form;
        this.init();
    };
    $.validator.format = function(source, params) {
        if (arguments.length === 1) {
            return function() {
                var args = $.makeArray(arguments);
                args.unshift(source);
                return $.validator.format.apply(this, args);
            };
        }
        if (params === undefined) {
            return source;
        }
        if (arguments.length > 2 && params.constructor !== Array) {
            params = $.makeArray(arguments).slice(1);
        }
        if (params.constructor !== Array) {
            params = [ params ];
        }
        $.each(params, function(i, n) {
            source = source.replace(new RegExp("\\{" + i + "\\}", "g"), function() {
                return n;
            });
        });
        return source;
    };
    $.extend($.validator, {
        defaults: {
            messages: {},
            groups: {},
            rules: {},
            errorClass: "error",
            pendingClass: "pending",
            validClass: "valid",
            errorElement: "label",
            focusCleanup: false,
            focusInvalid: true,
            errorContainer: $([]),
            errorLabelContainer: $([]),
            onsubmit: true,
            ignore: ":hidden",
            ignoreTitle: false,
            onfocusin: function(element) {
                this.lastActive = element;
                if (this.settings.focusCleanup) {
                    if (this.settings.unhighlight) {
                        this.settings.unhighlight.call(this, element, this.settings.errorClass, this.settings.validClass);
                    }
                    this.hideThese(this.errorsFor(element));
                }
            },
            onfocusout: function(element) {
                if (!this.checkable(element) && (element.name in this.submitted || !this.optional(element))) {
                    this.element(element);
                }
            },
            onkeyup: function(element, event) {
                var excludedKeys = [ 16, 17, 18, 20, 35, 36, 37, 38, 39, 40, 45, 144, 225 ];
                if (event.which === 9 && this.elementValue(element) === "" || $.inArray(event.keyCode, excludedKeys) !== -1) {
                    return;
                } else if (element.name in this.submitted || element.name in this.invalid) {
                    this.element(element);
                }
            },
            onclick: function(element) {
                if (element.name in this.submitted) {
                    this.element(element);
                } else if (element.parentNode.name in this.submitted) {
                    this.element(element.parentNode);
                }
            },
            highlight: function(element, errorClass, validClass) {
                if (element.type === "radio") {
                    this.findByName(element.name).addClass(errorClass).removeClass(validClass);
                } else {
                    $(element).addClass(errorClass).removeClass(validClass);
                }
            },
            unhighlight: function(element, errorClass, validClass) {
                if (element.type === "radio") {
                    this.findByName(element.name).removeClass(errorClass).addClass(validClass);
                } else {
                    $(element).removeClass(errorClass).addClass(validClass);
                }
            }
        },
        setDefaults: function(settings) {
            $.extend($.validator.defaults, settings);
        },
        messages: {
            required: "This field is required.",
            remote: "Please fix this field.",
            email: "Please enter a valid email address.",
            url: "Please enter a valid URL.",
            date: "Please enter a valid date.",
            dateISO: "Please enter a valid date ( ISO ).",
            number: "Please enter a valid number.",
            digits: "Please enter only digits.",
            equalTo: "Please enter the same value again.",
            maxlength: $.validator.format("Please enter no more than {0} characters."),
            minlength: $.validator.format("Please enter at least {0} characters."),
            rangelength: $.validator.format("Please enter a value between {0} and {1} characters long."),
            range: $.validator.format("Please enter a value between {0} and {1}."),
            max: $.validator.format("Please enter a value less than or equal to {0}."),
            min: $.validator.format("Please enter a value greater than or equal to {0}."),
            step: $.validator.format("Please enter a multiple of {0}.")
        },
        autoCreateRanges: false,
        prototype: {
            init: function() {
                this.labelContainer = $(this.settings.errorLabelContainer);
                this.errorContext = this.labelContainer.length && this.labelContainer || $(this.currentForm);
                this.containers = $(this.settings.errorContainer).add(this.settings.errorLabelContainer);
                this.submitted = {};
                this.valueCache = {};
                this.pendingRequest = 0;
                this.pending = {};
                this.invalid = {};
                this.reset();
                var groups = this.groups = {}, rules;
                $.each(this.settings.groups, function(key, value) {
                    if (typeof value === "string") {
                        value = value.split(/\s/);
                    }
                    $.each(value, function(index, name) {
                        groups[name] = key;
                    });
                });
                rules = this.settings.rules;
                $.each(rules, function(key, value) {
                    rules[key] = $.validator.normalizeRule(value);
                });
                function delegate(event) {
                    var validator = $.data(this.form, "validator"), eventType = "on" + event.type.replace(/^validate/, ""), settings = validator.settings;
                    if (settings[eventType] && !$(this).is(settings.ignore)) {
                        settings[eventType].call(validator, this, event);
                    }
                }
                $(this.currentForm).on("focusin.validate focusout.validate keyup.validate", ":text, [type='password'], [type='file'], select, textarea, [type='number'], [type='search'], " + "[type='tel'], [type='url'], [type='email'], [type='datetime'], [type='date'], [type='month'], " + "[type='week'], [type='time'], [type='datetime-local'], [type='range'], [type='color'], " + "[type='radio'], [type='checkbox'], [contenteditable]", delegate).on("click.validate", "select, option, [type='radio'], [type='checkbox']", delegate);
                if (this.settings.invalidHandler) {
                    $(this.currentForm).on("invalid-form.validate", this.settings.invalidHandler);
                }
                $(this.currentForm).find("[required], [data-rule-required], .required").attr("aria-required", "true");
            },
            form: function() {
                this.checkForm();
                $.extend(this.submitted, this.errorMap);
                this.invalid = $.extend({}, this.errorMap);
                if (!this.valid()) {
                    $(this.currentForm).triggerHandler("invalid-form", [ this ]);
                }
                this.showErrors();
                return this.valid();
            },
            checkForm: function() {
                this.prepareForm();
                for (var i = 0, elements = this.currentElements = this.elements(); elements[i]; i++) {
                    this.check(elements[i]);
                }
                return this.valid();
            },
            element: function(element) {
                var cleanElement = this.clean(element), checkElement = this.validationTargetFor(cleanElement), v = this, result = true, rs, group;
                if (checkElement === undefined) {
                    delete this.invalid[cleanElement.name];
                } else {
                    this.prepareElement(checkElement);
                    this.currentElements = $(checkElement);
                    group = this.groups[checkElement.name];
                    if (group) {
                        $.each(this.groups, function(name, testgroup) {
                            if (testgroup === group && name !== checkElement.name) {
                                cleanElement = v.validationTargetFor(v.clean(v.findByName(name)));
                                if (cleanElement && cleanElement.name in v.invalid) {
                                    v.currentElements.push(cleanElement);
                                    result = result && v.check(cleanElement);
                                }
                            }
                        });
                    }
                    rs = this.check(checkElement) !== false;
                    result = result && rs;
                    if (rs) {
                        this.invalid[checkElement.name] = false;
                    } else {
                        this.invalid[checkElement.name] = true;
                    }
                    if (!this.numberOfInvalids()) {
                        this.toHide = this.toHide.add(this.containers);
                    }
                    this.showErrors();
                    $(element).attr("aria-invalid", !rs);
                }
                return result;
            },
            showErrors: function(errors) {
                if (errors) {
                    var validator = this;
                    $.extend(this.errorMap, errors);
                    this.errorList = $.map(this.errorMap, function(message, name) {
                        return {
                            message: message,
                            element: validator.findByName(name)[0]
                        };
                    });
                    this.successList = $.grep(this.successList, function(element) {
                        return !(element.name in errors);
                    });
                }
                if (this.settings.showErrors) {
                    this.settings.showErrors.call(this, this.errorMap, this.errorList);
                } else {
                    this.defaultShowErrors();
                }
            },
            resetForm: function() {
                if ($.fn.resetForm) {
                    $(this.currentForm).resetForm();
                }
                this.invalid = {};
                this.submitted = {};
                this.prepareForm();
                this.hideErrors();
                var elements = this.elements().removeData("previousValue").removeAttr("aria-invalid");
                this.resetElements(elements);
            },
            resetElements: function(elements) {
                var i;
                if (this.settings.unhighlight) {
                    for (i = 0; elements[i]; i++) {
                        this.settings.unhighlight.call(this, elements[i], this.settings.errorClass, "");
                        this.findByName(elements[i].name).removeClass(this.settings.validClass);
                    }
                } else {
                    elements.removeClass(this.settings.errorClass).removeClass(this.settings.validClass);
                }
            },
            numberOfInvalids: function() {
                return this.objectLength(this.invalid);
            },
            objectLength: function(obj) {
                var count = 0, i;
                for (i in obj) {
                    if (obj[i]) {
                        count++;
                    }
                }
                return count;
            },
            hideErrors: function() {
                this.hideThese(this.toHide);
            },
            hideThese: function(errors) {
                errors.not(this.containers).text("");
                this.addWrapper(errors).hide();
            },
            valid: function() {
                return this.size() === 0;
            },
            size: function() {
                return this.errorList.length;
            },
            focusInvalid: function() {
                if (this.settings.focusInvalid) {
                    try {
                        $(this.findLastActive() || this.errorList.length && this.errorList[0].element || []).filter(":visible").focus().trigger("focusin");
                    } catch (e) {}
                }
            },
            findLastActive: function() {
                var lastActive = this.lastActive;
                return lastActive && $.grep(this.errorList, function(n) {
                    return n.element.name === lastActive.name;
                }).length === 1 && lastActive;
            },
            elements: function() {
                var validator = this, rulesCache = {};
                return $(this.currentForm).find("input, select, textarea, [contenteditable]").not(":submit, :reset, :image, :disabled").not(this.settings.ignore).filter(function() {
                    var name = this.name || $(this).attr("name");
                    if (!name && validator.settings.debug && window.console) {
                        console.error("%o has no name assigned", this);
                    }
                    if (this.hasAttribute("contenteditable")) {
                        this.form = $(this).closest("form")[0];
                    }
                    if (name in rulesCache || !validator.objectLength($(this).rules())) {
                        return false;
                    }
                    rulesCache[name] = true;
                    return true;
                });
            },
            clean: function(selector) {
                return $(selector)[0];
            },
            errors: function() {
                var errorClass = this.settings.errorClass.split(" ").join(".");
                return $(this.settings.errorElement + "." + errorClass, this.errorContext);
            },
            resetInternals: function() {
                this.successList = [];
                this.errorList = [];
                this.errorMap = {};
                this.toShow = $([]);
                this.toHide = $([]);
            },
            reset: function() {
                this.resetInternals();
                this.currentElements = $([]);
            },
            prepareForm: function() {
                this.reset();
                this.toHide = this.errors().add(this.containers);
            },
            prepareElement: function(element) {
                this.reset();
                this.toHide = this.errorsFor(element);
            },
            elementValue: function(element) {
                var $element = $(element), type = element.type, val, idx;
                if (type === "radio" || type === "checkbox") {
                    return this.findByName(element.name).filter(":checked").val();
                } else if (type === "number" && typeof element.validity !== "undefined") {
                    return element.validity.badInput ? "NaN" : $element.val();
                }
                if (element.hasAttribute("contenteditable")) {
                    val = $element.text();
                } else {
                    val = $element.val();
                }
                if (type === "file") {
                    if (val.substr(0, 12) === "C:\\fakepath\\") {
                        return val.substr(12);
                    }
                    idx = val.lastIndexOf("/");
                    if (idx >= 0) {
                        return val.substr(idx + 1);
                    }
                    idx = val.lastIndexOf("\\");
                    if (idx >= 0) {
                        return val.substr(idx + 1);
                    }
                    return val;
                }
                if (typeof val === "string") {
                    return val.replace(/\r/g, "");
                }
                return val;
            },
            check: function(element) {
                element = this.validationTargetFor(this.clean(element));
                var rules = $(element).rules(), rulesCount = $.map(rules, function(n, i) {
                    return i;
                }).length, dependencyMismatch = false, val = this.elementValue(element), result, method, rule;
                if (typeof rules.normalizer === "function") {
                    val = rules.normalizer.call(element, val);
                    if (typeof val !== "string") {
                        throw new TypeError("The normalizer should return a string value.");
                    }
                    delete rules.normalizer;
                }
                for (method in rules) {
                    rule = {
                        method: method,
                        parameters: rules[method]
                    };
                    try {
                        result = $.validator.methods[method].call(this, val, element, rule.parameters);
                        if (result === "dependency-mismatch" && rulesCount === 1) {
                            dependencyMismatch = true;
                            continue;
                        }
                        dependencyMismatch = false;
                        if (result === "pending") {
                            this.toHide = this.toHide.not(this.errorsFor(element));
                            return;
                        }
                        if (!result) {
                            this.formatAndAdd(element, rule);
                            return false;
                        }
                    } catch (e) {
                        if (this.settings.debug && window.console) {
                            console.log("Exception occurred when checking element " + element.id + ", check the '" + rule.method + "' method.", e);
                        }
                        if (e instanceof TypeError) {
                            e.message += ".  Exception occurred when checking element " + element.id + ", check the '" + rule.method + "' method.";
                        }
                        throw e;
                    }
                }
                if (dependencyMismatch) {
                    return;
                }
                if (this.objectLength(rules)) {
                    this.successList.push(element);
                }
                return true;
            },
            customDataMessage: function(element, method) {
                return $(element).data("msg" + method.charAt(0).toUpperCase() + method.substring(1).toLowerCase()) || $(element).data("msg");
            },
            customMessage: function(name, method) {
                var m = this.settings.messages[name];
                return m && (m.constructor === String ? m : m[method]);
            },
            findDefined: function() {
                for (var i = 0; i < arguments.length; i++) {
                    if (arguments[i] !== undefined) {
                        return arguments[i];
                    }
                }
                return undefined;
            },
            defaultMessage: function(element, rule) {
                var message = this.findDefined(this.customMessage(element.name, rule.method), this.customDataMessage(element, rule.method), !this.settings.ignoreTitle && element.title || undefined, $.validator.messages[rule.method], "<strong>Warning: No message defined for " + element.name + "</strong>"), theregex = /\$?\{(\d+)\}/g;
                if (typeof message === "function") {
                    message = message.call(this, rule.parameters, element);
                } else if (theregex.test(message)) {
                    message = $.validator.format(message.replace(theregex, "{$1}"), rule.parameters);
                }
                return message;
            },
            formatAndAdd: function(element, rule) {
                var message = this.defaultMessage(element, rule);
                this.errorList.push({
                    message: message,
                    element: element,
                    method: rule.method
                });
                this.errorMap[element.name] = message;
                this.submitted[element.name] = message;
            },
            addWrapper: function(toToggle) {
                if (this.settings.wrapper) {
                    toToggle = toToggle.add(toToggle.parent(this.settings.wrapper));
                }
                return toToggle;
            },
            defaultShowErrors: function() {
                var i, elements, error;
                for (i = 0; this.errorList[i]; i++) {
                    error = this.errorList[i];
                    if (this.settings.highlight) {
                        this.settings.highlight.call(this, error.element, this.settings.errorClass, this.settings.validClass);
                    }
                    this.showLabel(error.element, error.message);
                }
                if (this.errorList.length) {
                    this.toShow = this.toShow.add(this.containers);
                }
                if (this.settings.success) {
                    for (i = 0; this.successList[i]; i++) {
                        this.showLabel(this.successList[i]);
                    }
                }
                if (this.settings.unhighlight) {
                    for (i = 0, elements = this.validElements(); elements[i]; i++) {
                        this.settings.unhighlight.call(this, elements[i], this.settings.errorClass, this.settings.validClass);
                    }
                }
                this.toHide = this.toHide.not(this.toShow);
                this.hideErrors();
                this.addWrapper(this.toShow).show();
            },
            validElements: function() {
                return this.currentElements.not(this.invalidElements());
            },
            invalidElements: function() {
                return $(this.errorList).map(function() {
                    return this.element;
                });
            },
            showLabel: function(element, message) {
                var place, group, errorID, v, error = this.errorsFor(element), elementID = this.idOrName(element), describedBy = $(element).attr("aria-describedby");
                if (error.length) {
                    error.removeClass(this.settings.validClass).addClass(this.settings.errorClass);
                    error.html(message);
                } else {
                    error = $("<" + this.settings.errorElement + ">").attr("id", elementID + "-error").addClass(this.settings.errorClass).html(message || "");
                    place = error;
                    if (this.settings.wrapper) {
                        place = error.hide().show().wrap("<" + this.settings.wrapper + "/>").parent();
                    }
                    if (this.labelContainer.length) {
                        this.labelContainer.append(place);
                    } else if (this.settings.errorPlacement) {
                        this.settings.errorPlacement(place, $(element));
                    } else {
                        place.insertAfter(element);
                    }
                    if (error.is("label")) {
                        error.attr("for", elementID);
                    } else if (error.parents("label[for='" + this.escapeCssMeta(elementID) + "']").length === 0) {
                        errorID = error.attr("id");
                        if (!describedBy) {
                            describedBy = errorID;
                        } else if (!describedBy.match(new RegExp("\\b" + this.escapeCssMeta(errorID) + "\\b"))) {
                            describedBy += " " + errorID;
                        }
                        $(element).attr("aria-describedby", describedBy);
                        group = this.groups[element.name];
                        if (group) {
                            v = this;
                            $.each(v.groups, function(name, testgroup) {
                                if (testgroup === group) {
                                    $("[name='" + v.escapeCssMeta(name) + "']", v.currentForm).attr("aria-describedby", error.attr("id"));
                                }
                            });
                        }
                    }
                }
                if (!message && this.settings.success) {
                    error.text("");
                    if (typeof this.settings.success === "string") {
                        error.addClass(this.settings.success);
                    } else {
                        this.settings.success(error, element);
                    }
                }
                this.toShow = this.toShow.add(error);
            },
            errorsFor: function(element) {
                var name = this.escapeCssMeta(this.idOrName(element)), describer = $(element).attr("aria-describedby"), selector = "label[for='" + name + "'], label[for='" + name + "'] *";
                if (describer) {
                    selector = selector + ", #" + this.escapeCssMeta(describer).replace(/\s+/g, ", #");
                }
                return this.errors().filter(selector);
            },
            escapeCssMeta: function(string) {
                return string.replace(/([\\!"#$%&'()*+,./:;<=>?@\[\]^`{|}~])/g, "\\$1");
            },
            idOrName: function(element) {
                return this.groups[element.name] || (this.checkable(element) ? element.name : element.id || element.name);
            },
            validationTargetFor: function(element) {
                if (this.checkable(element)) {
                    element = this.findByName(element.name);
                }
                return $(element).not(this.settings.ignore)[0];
            },
            checkable: function(element) {
                return /radio|checkbox/i.test(element.type);
            },
            findByName: function(name) {
                return $(this.currentForm).find("[name='" + this.escapeCssMeta(name) + "']");
            },
            getLength: function(value, element) {
                switch (element.nodeName.toLowerCase()) {
                  case "select":
                    return $("option:selected", element).length;

                  case "input":
                    if (this.checkable(element)) {
                        return this.findByName(element.name).filter(":checked").length;
                    }
                }
                return value.length;
            },
            depend: function(param, element) {
                return this.dependTypes[typeof param] ? this.dependTypes[typeof param](param, element) : true;
            },
            dependTypes: {
                boolean: function(param) {
                    return param;
                },
                string: function(param, element) {
                    return !!$(param, element.form).length;
                },
                function: function(param, element) {
                    return param(element);
                }
            },
            optional: function(element) {
                var val = this.elementValue(element);
                return !$.validator.methods.required.call(this, val, element) && "dependency-mismatch";
            },
            startRequest: function(element) {
                if (!this.pending[element.name]) {
                    this.pendingRequest++;
                    $(element).addClass(this.settings.pendingClass);
                    this.pending[element.name] = true;
                }
            },
            stopRequest: function(element, valid) {
                this.pendingRequest--;
                if (this.pendingRequest < 0) {
                    this.pendingRequest = 0;
                }
                delete this.pending[element.name];
                $(element).removeClass(this.settings.pendingClass);
                if (valid && this.pendingRequest === 0 && this.formSubmitted && this.form()) {
                    $(this.currentForm).submit();
                    this.formSubmitted = false;
                } else if (!valid && this.pendingRequest === 0 && this.formSubmitted) {
                    $(this.currentForm).triggerHandler("invalid-form", [ this ]);
                    this.formSubmitted = false;
                }
            },
            previousValue: function(element, method) {
                return $.data(element, "previousValue") || $.data(element, "previousValue", {
                    old: null,
                    valid: true,
                    message: this.defaultMessage(element, {
                        method: method
                    })
                });
            },
            destroy: function() {
                this.resetForm();
                $(this.currentForm).off(".validate").removeData("validator").find(".validate-equalTo-blur").off(".validate-equalTo").removeClass("validate-equalTo-blur");
            }
        },
        classRuleSettings: {
            required: {
                required: true
            },
            email: {
                email: true
            },
            url: {
                url: true
            },
            date: {
                date: true
            },
            dateISO: {
                dateISO: true
            },
            number: {
                number: true
            },
            digits: {
                digits: true
            },
            creditcard: {
                creditcard: true
            }
        },
        addClassRules: function(className, rules) {
            if (className.constructor === String) {
                this.classRuleSettings[className] = rules;
            } else {
                $.extend(this.classRuleSettings, className);
            }
        },
        classRules: function(element) {
            var rules = {}, classes = $(element).attr("class");
            if (classes) {
                $.each(classes.split(" "), function() {
                    if (this in $.validator.classRuleSettings) {
                        $.extend(rules, $.validator.classRuleSettings[this]);
                    }
                });
            }
            return rules;
        },
        normalizeAttributeRule: function(rules, type, method, value) {
            if (/min|max|step/.test(method) && (type === null || /number|range|text/.test(type))) {
                value = Number(value);
                if (isNaN(value)) {
                    value = undefined;
                }
            }
            if (value || value === 0) {
                rules[method] = value;
            } else if (type === method && type !== "range") {
                rules[method] = true;
            }
        },
        attributeRules: function(element) {
            var rules = {}, $element = $(element), type = element.getAttribute("type"), method, value;
            for (method in $.validator.methods) {
                if (method === "required") {
                    value = element.getAttribute(method);
                    if (value === "") {
                        value = true;
                    }
                    value = !!value;
                } else {
                    value = $element.attr(method);
                }
                this.normalizeAttributeRule(rules, type, method, value);
            }
            if (rules.maxlength && /-1|2147483647|524288/.test(rules.maxlength)) {
                delete rules.maxlength;
            }
            return rules;
        },
        dataRules: function(element) {
            var rules = {}, $element = $(element), type = element.getAttribute("type"), method, value;
            for (method in $.validator.methods) {
                value = $element.data("rule" + method.charAt(0).toUpperCase() + method.substring(1).toLowerCase());
                this.normalizeAttributeRule(rules, type, method, value);
            }
            return rules;
        },
        staticRules: function(element) {
            var rules = {}, validator = $.data(element.form, "validator");
            if (validator.settings.rules) {
                rules = $.validator.normalizeRule(validator.settings.rules[element.name]) || {};
            }
            return rules;
        },
        normalizeRules: function(rules, element) {
            $.each(rules, function(prop, val) {
                if (val === false) {
                    delete rules[prop];
                    return;
                }
                if (val.param || val.depends) {
                    var keepRule = true;
                    switch (typeof val.depends) {
                      case "string":
                        keepRule = !!$(val.depends, element.form).length;
                        break;

                      case "function":
                        keepRule = val.depends.call(element, element);
                        break;
                    }
                    if (keepRule) {
                        rules[prop] = val.param !== undefined ? val.param : true;
                    } else {
                        $.data(element.form, "validator").resetElements($(element));
                        delete rules[prop];
                    }
                }
            });
            $.each(rules, function(rule, parameter) {
                rules[rule] = $.isFunction(parameter) && rule !== "normalizer" ? parameter(element) : parameter;
            });
            $.each([ "minlength", "maxlength" ], function() {
                if (rules[this]) {
                    rules[this] = Number(rules[this]);
                }
            });
            $.each([ "rangelength", "range" ], function() {
                var parts;
                if (rules[this]) {
                    if ($.isArray(rules[this])) {
                        rules[this] = [ Number(rules[this][0]), Number(rules[this][1]) ];
                    } else if (typeof rules[this] === "string") {
                        parts = rules[this].replace(/[\[\]]/g, "").split(/[\s,]+/);
                        rules[this] = [ Number(parts[0]), Number(parts[1]) ];
                    }
                }
            });
            if ($.validator.autoCreateRanges) {
                if (rules.min != null && rules.max != null) {
                    rules.range = [ rules.min, rules.max ];
                    delete rules.min;
                    delete rules.max;
                }
                if (rules.minlength != null && rules.maxlength != null) {
                    rules.rangelength = [ rules.minlength, rules.maxlength ];
                    delete rules.minlength;
                    delete rules.maxlength;
                }
            }
            return rules;
        },
        normalizeRule: function(data) {
            if (typeof data === "string") {
                var transformed = {};
                $.each(data.split(/\s/), function() {
                    transformed[this] = true;
                });
                data = transformed;
            }
            return data;
        },
        addMethod: function(name, method, message) {
            $.validator.methods[name] = method;
            $.validator.messages[name] = message !== undefined ? message : $.validator.messages[name];
            if (method.length < 3) {
                $.validator.addClassRules(name, $.validator.normalizeRule(name));
            }
        },
        methods: {
            required: function(value, element, param) {
                if (!this.depend(param, element)) {
                    return "dependency-mismatch";
                }
                if (element.nodeName.toLowerCase() === "select") {
                    var val = $(element).val();
                    return val && val.length > 0;
                }
                if (this.checkable(element)) {
                    return this.getLength(value, element) > 0;
                }
                return value.length > 0;
            },
            email: function(value, element) {
                return this.optional(element) || /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(value);
            },
            url: function(value, element) {
                return this.optional(element) || /^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test(value);
            },
            date: function(value, element) {
                return this.optional(element) || !/Invalid|NaN/.test(new Date(value).toString());
            },
            dateISO: function(value, element) {
                return this.optional(element) || /^\d{4}[\/\-](0?[1-9]|1[012])[\/\-](0?[1-9]|[12][0-9]|3[01])$/.test(value);
            },
            number: function(value, element) {
                return this.optional(element) || /^(?:-?\d+|-?\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/.test(value);
            },
            digits: function(value, element) {
                return this.optional(element) || /^\d+$/.test(value);
            },
            minlength: function(value, element, param) {
                var length = $.isArray(value) ? value.length : this.getLength(value, element);
                return this.optional(element) || length >= param;
            },
            maxlength: function(value, element, param) {
                var length = $.isArray(value) ? value.length : this.getLength(value, element);
                return this.optional(element) || length <= param;
            },
            rangelength: function(value, element, param) {
                var length = $.isArray(value) ? value.length : this.getLength(value, element);
                return this.optional(element) || length >= param[0] && length <= param[1];
            },
            min: function(value, element, param) {
                return this.optional(element) || value >= param;
            },
            max: function(value, element, param) {
                return this.optional(element) || value <= param;
            },
            range: function(value, element, param) {
                return this.optional(element) || value >= param[0] && value <= param[1];
            },
            step: function(value, element, param) {
                var type = $(element).attr("type"), errorMessage = "Step attribute on input type " + type + " is not supported.", supportedTypes = [ "text", "number", "range" ], re = new RegExp("\\b" + type + "\\b"), notSupported = type && !re.test(supportedTypes.join());
                if (notSupported) {
                    throw new Error(errorMessage);
                }
                return this.optional(element) || value % param === 0;
            },
            equalTo: function(value, element, param) {
                var target = $(param);
                if (this.settings.onfocusout && target.not(".validate-equalTo-blur").length) {
                    target.addClass("validate-equalTo-blur").on("blur.validate-equalTo", function() {
                        $(element).valid();
                    });
                }
                return value === target.val();
            },
            remote: function(value, element, param, method) {
                if (this.optional(element)) {
                    return "dependency-mismatch";
                }
                method = typeof method === "string" && method || "remote";
                var previous = this.previousValue(element, method), validator, data, optionDataString;
                if (!this.settings.messages[element.name]) {
                    this.settings.messages[element.name] = {};
                }
                previous.originalMessage = previous.originalMessage || this.settings.messages[element.name][method];
                this.settings.messages[element.name][method] = previous.message;
                param = typeof param === "string" && {
                    url: param
                } || param;
                optionDataString = $.param($.extend({
                    data: value
                }, param.data));
                if (previous.old === optionDataString) {
                    return previous.valid;
                }
                previous.old = optionDataString;
                validator = this;
                this.startRequest(element);
                data = {};
                data[element.name] = value;
                $.ajax($.extend(true, {
                    mode: "abort",
                    port: "validate" + element.name,
                    dataType: "json",
                    data: data,
                    context: validator.currentForm,
                    success: function(response) {
                        var valid = response === true || response === "true", errors, message, submitted;
                        validator.settings.messages[element.name][method] = previous.originalMessage;
                        if (valid) {
                            submitted = validator.formSubmitted;
                            validator.resetInternals();
                            validator.toHide = validator.errorsFor(element);
                            validator.formSubmitted = submitted;
                            validator.successList.push(element);
                            validator.invalid[element.name] = false;
                            validator.showErrors();
                        } else {
                            errors = {};
                            message = response || validator.defaultMessage(element, {
                                method: method,
                                parameters: value
                            });
                            errors[element.name] = previous.message = message;
                            validator.invalid[element.name] = true;
                            validator.showErrors(errors);
                        }
                        previous.valid = valid;
                        validator.stopRequest(element, valid);
                    }
                }, param));
                return "pending";
            }
        }
    });
    var pendingRequests = {}, ajax;
    if ($.ajaxPrefilter) {
        $.ajaxPrefilter(function(settings, _, xhr) {
            var port = settings.port;
            if (settings.mode === "abort") {
                if (pendingRequests[port]) {
                    pendingRequests[port].abort();
                }
                pendingRequests[port] = xhr;
            }
        });
    } else {
        ajax = $.ajax;
        $.ajax = function(settings) {
            var mode = ("mode" in settings ? settings : $.ajaxSettings).mode, port = ("port" in settings ? settings : $.ajaxSettings).port;
            if (mode === "abort") {
                if (pendingRequests[port]) {
                    pendingRequests[port].abort();
                }
                pendingRequests[port] = ajax.apply(this, arguments);
                return pendingRequests[port];
            }
            return ajax.apply(this, arguments);
        };
    }
});

(function($) {
    var $jQval = $.validator, adapters, data_validation = "unobtrusiveValidation";
    function setValidationValues(options, ruleName, value) {
        options.rules[ruleName] = value;
        if (options.message) {
            options.messages[ruleName] = options.message;
        }
    }
    function splitAndTrim(value) {
        return value.replace(/^\s+|\s+$/g, "").split(/\s*,\s*/g);
    }
    function escapeAttributeValue(value) {
        return value.replace(/([!"#$%&'()*+,./:;<=>?@\[\\\]^`{|}~])/g, "\\$1");
    }
    function getModelPrefix(fieldName) {
        return fieldName.substr(0, fieldName.lastIndexOf(".") + 1);
    }
    function appendModelPrefix(value, prefix) {
        if (value.indexOf("*.") === 0) {
            value = value.replace("*.", prefix);
        }
        return value;
    }
    function onError(error, inputElement) {
        var container = $(this).find("[data-valmsg-for='" + escapeAttributeValue(inputElement[0].name) + "']"), replaceAttrValue = container.attr("data-valmsg-replace"), replace = replaceAttrValue ? $.parseJSON(replaceAttrValue) !== false : null;
        container.removeClass("field-validation-valid").addClass("field-validation-error");
        error.data("unobtrusiveContainer", container);
        if (replace) {
            container.empty();
            error.removeClass("input-validation-error").appendTo(container);
        } else {
            error.hide();
        }
    }
    function onErrors(event, validator) {
        var container = $(this).find("[data-valmsg-summary=true]"), list = container.find("ul");
        if (list && list.length && validator.errorList.length) {
            list.empty();
            container.addClass("validation-summary-errors").removeClass("validation-summary-valid");
            $.each(validator.errorList, function() {
                $("<li />").html(this.message).appendTo(list);
            });
        }
    }
    function onSuccess(error) {
        var container = error.data("unobtrusiveContainer"), replaceAttrValue = container.attr("data-valmsg-replace"), replace = replaceAttrValue ? $.parseJSON(replaceAttrValue) : null;
        if (container) {
            container.addClass("field-validation-valid").removeClass("field-validation-error");
            error.removeData("unobtrusiveContainer");
            if (replace) {
                container.empty();
            }
        }
    }
    function onReset(event) {
        var $form = $(this), key = "__jquery_unobtrusive_validation_form_reset";
        if ($form.data(key)) {
            return;
        }
        $form.data(key, true);
        try {
            $form.data("validator").resetForm();
        } finally {
            $form.removeData(key);
        }
        $form.find(".validation-summary-errors").addClass("validation-summary-valid").removeClass("validation-summary-errors");
        $form.find(".field-validation-error").addClass("field-validation-valid").removeClass("field-validation-error").removeData("unobtrusiveContainer").find(">*").removeData("unobtrusiveContainer");
    }
    function validationInfo(form) {
        var $form = $(form), result = $form.data(data_validation), onResetProxy = $.proxy(onReset, form), defaultOptions = $jQval.unobtrusive.options || {}, execInContext = function(name, args) {
            var func = defaultOptions[name];
            func && $.isFunction(func) && func.apply(form, args);
        };
        if (!result) {
            result = {
                options: {
                    errorClass: defaultOptions.errorClass || "input-validation-error",
                    errorElement: defaultOptions.errorElement || "span",
                    errorPlacement: function() {
                        onError.apply(form, arguments);
                        execInContext("errorPlacement", arguments);
                    },
                    invalidHandler: function() {
                        onErrors.apply(form, arguments);
                        execInContext("invalidHandler", arguments);
                    },
                    messages: {},
                    rules: {},
                    success: function() {
                        onSuccess.apply(form, arguments);
                        execInContext("success", arguments);
                    }
                },
                attachValidation: function() {
                    $form.off("reset." + data_validation, onResetProxy).on("reset." + data_validation, onResetProxy).validate(this.options);
                },
                validate: function() {
                    $form.validate();
                    return $form.valid();
                }
            };
            $form.data(data_validation, result);
        }
        return result;
    }
    $jQval.unobtrusive = {
        adapters: [],
        parseElement: function(element, skipAttach) {
            var $element = $(element), form = $element.parents("form")[0], valInfo, rules, messages;
            if (!form) {
                return;
            }
            valInfo = validationInfo(form);
            valInfo.options.rules[element.name] = rules = {};
            valInfo.options.messages[element.name] = messages = {};
            $.each(this.adapters, function() {
                var prefix = "data-val-" + this.name, message = $element.attr(prefix), paramValues = {};
                if (message !== undefined) {
                    prefix += "-";
                    $.each(this.params, function() {
                        paramValues[this] = $element.attr(prefix + this);
                    });
                    this.adapt({
                        element: element,
                        form: form,
                        message: message,
                        params: paramValues,
                        rules: rules,
                        messages: messages
                    });
                }
            });
            $.extend(rules, {
                __dummy__: true
            });
            if (!skipAttach) {
                valInfo.attachValidation();
            }
        },
        parse: function(selector) {
            var $selector = $(selector), $forms = $selector.parents().addBack().filter("form").add($selector.find("form")).has("[data-val=true]");
            $selector.find("[data-val=true]").each(function() {
                $jQval.unobtrusive.parseElement(this, true);
            });
            $forms.each(function() {
                var info = validationInfo(this);
                if (info) {
                    info.attachValidation();
                }
            });
        }
    };
    adapters = $jQval.unobtrusive.adapters;
    adapters.add = function(adapterName, params, fn) {
        if (!fn) {
            fn = params;
            params = [];
        }
        this.push({
            name: adapterName,
            params: params,
            adapt: fn
        });
        return this;
    };
    adapters.addBool = function(adapterName, ruleName) {
        return this.add(adapterName, function(options) {
            setValidationValues(options, ruleName || adapterName, true);
        });
    };
    adapters.addMinMax = function(adapterName, minRuleName, maxRuleName, minMaxRuleName, minAttribute, maxAttribute) {
        return this.add(adapterName, [ minAttribute || "min", maxAttribute || "max" ], function(options) {
            var min = options.params.min, max = options.params.max;
            if (min && max) {
                setValidationValues(options, minMaxRuleName, [ min, max ]);
            } else if (min) {
                setValidationValues(options, minRuleName, min);
            } else if (max) {
                setValidationValues(options, maxRuleName, max);
            }
        });
    };
    adapters.addSingleVal = function(adapterName, attribute, ruleName) {
        return this.add(adapterName, [ attribute || "val" ], function(options) {
            setValidationValues(options, ruleName || adapterName, options.params[attribute]);
        });
    };
    $jQval.addMethod("__dummy__", function(value, element, params) {
        return true;
    });
    $jQval.addMethod("regex", function(value, element, params) {
        var match;
        if (this.optional(element)) {
            return true;
        }
        match = new RegExp(params).exec(value);
        return match && match.index === 0 && match[0].length === value.length;
    });
    $jQval.addMethod("nonalphamin", function(value, element, nonalphamin) {
        var match;
        if (nonalphamin) {
            match = value.match(/\W/g);
            match = match && match.length >= nonalphamin;
        }
        return match;
    });
    if ($jQval.methods.extension) {
        adapters.addSingleVal("accept", "mimtype");
        adapters.addSingleVal("extension", "extension");
    } else {
        adapters.addSingleVal("extension", "extension", "accept");
    }
    adapters.addSingleVal("regex", "pattern");
    adapters.addBool("creditcard").addBool("date").addBool("digits").addBool("email").addBool("number").addBool("url");
    adapters.addMinMax("length", "minlength", "maxlength", "rangelength").addMinMax("range", "min", "max", "range");
    adapters.addMinMax("minlength", "minlength").addMinMax("maxlength", "minlength", "maxlength");
    adapters.add("equalto", [ "other" ], function(options) {
        var prefix = getModelPrefix(options.element.name), other = options.params.other, fullOtherName = appendModelPrefix(other, prefix), element = $(options.form).find(":input").filter("[name='" + escapeAttributeValue(fullOtherName) + "']")[0];
        setValidationValues(options, "equalTo", element);
    });
    adapters.add("required", function(options) {
        if (options.element.tagName.toUpperCase() !== "INPUT" || options.element.type.toUpperCase() !== "CHECKBOX") {
            setValidationValues(options, "required", true);
        }
    });
    adapters.add("remote", [ "url", "type", "additionalfields" ], function(options) {
        var value = {
            url: options.params.url,
            type: options.params.type || "GET",
            data: {}
        }, prefix = getModelPrefix(options.element.name);
        $.each(splitAndTrim(options.params.additionalfields || options.element.name), function(i, fieldName) {
            var paramName = appendModelPrefix(fieldName, prefix);
            value.data[paramName] = function() {
                var field = $(options.form).find(":input").filter("[name='" + escapeAttributeValue(paramName) + "']");
                if (field.is(":checkbox")) {
                    return field.filter(":checked").val() || field.filter(":hidden").val() || "";
                } else if (field.is(":radio")) {
                    return field.filter(":checked").val() || "";
                }
                return field.val();
            };
        });
        setValidationValues(options, "remote", value);
    });
    adapters.add("password", [ "min", "nonalphamin", "regex" ], function(options) {
        if (options.params.min) {
            setValidationValues(options, "minlength", options.params.min);
        }
        if (options.params.nonalphamin) {
            setValidationValues(options, "nonalphamin", options.params.nonalphamin);
        }
        if (options.params.regex) {
            setValidationValues(options, "regex", options.params.regex);
        }
    });
    $(function() {
        $jQval.unobtrusive.parse(document);
    });
})(jQuery);

(function($) {
    $.fn.appendAround = function() {
        return this.each(function() {
            var $self = $(this), att = "data-set", $set = $("[" + att + "='" + $self.closest("[" + att + "]").attr(att) + "']");
            function appendToVisibleContainer() {
                if ($self.is(":hidden")) {
                    $self.appendTo($set.filter(":visible:eq(0)"));
                }
                $(window).trigger("append-around-complete");
            }
            appendToVisibleContainer();
            $(window).on("changeBreakpoint", appendToVisibleContainer);
        });
    };
})(jQuery);

(function($) {
    "use strict";
    var lastSize = 0;
    var interval = null;
    var sorted = null;
    $.fn.resetBreakpoints = function() {
        $(window).unbind("resize");
        lastSize = 0;
    };
    $.fn.setBreakpoints = function(settings) {
        var options = jQuery.extend({
            distinct: true,
            useInnerWidth: true,
            breakpoints: [ {
                name: "Small",
                resolution: 10
            }, {
                name: "Medium",
                resolution: 580
            }, {
                name: "Large",
                resolution: 900
            } ]
        }, settings);
        sorted = options.breakpoints.sort(function(a, b) {
            return b.resolution - a.resolution;
        });
        $(window).on("resize", function() {
            var w;
            if ("innerWidth" in window) {
                w = window.innerWidth;
            } else {
                w = $(window).width();
            }
            var done = false;
            var changed = false;
            for (var bp in sorted) {
                var currentBP = options.breakpoints[bp].resolution;
                if (!done && w >= currentBP && lastSize < currentBP) {
                    if (options.distinct) {
                        for (var x in sorted) {
                            if ($("body").hasClass("breakpoint-" + options.breakpoints[x].name)) {
                                $("body").removeClass("breakpoint-" + options.breakpoints[x].name);
                                $(window).trigger("exitBreakpoint" + options.breakpoints[x].name);
                            }
                        }
                        done = true;
                    }
                    $("body").addClass("breakpoint-" + options.breakpoints[bp].name);
                    $(window).trigger("enterBreakpoint" + options.breakpoints[bp].name);
                    changed = true;
                }
                if (w < options.breakpoints[bp].resolution && lastSize >= options.breakpoints[bp].resolution) {
                    $("body").removeClass("breakpoint-" + options.breakpoints[bp].name);
                    $(window).trigger("exitBreakpoint" + options.breakpoints[bp].name);
                    changed = true;
                }
                if (options.distinct && w >= options.breakpoints[bp].resolution && w < options.breakpoints[bp - 1].resolution && lastSize > w && lastSize > 0 && !$("body").hasClass("breakpoint-" + options.breakpoints[bp].name)) {
                    $("body").addClass("breakpoint-" + options.breakpoints[bp].name);
                    $(window).trigger("enterBreakpoint" + options.breakpoints[bp].name);
                    changed = true;
                }
            }
            if (changed) {
                $(window).trigger("changeBreakpoint");
            }
            if (lastSize !== w) {
                lastSize = w;
            }
        });
        $(window).resize();
    };
})(jQuery);

(function($, document, undefined) {
    var pluses = /\+/g;
    function raw(s) {
        return s;
    }
    function decoded(s) {
        return decodeURIComponent(s.replace(pluses, " "));
    }
    var config = $.cookie = function(key, value, options) {
        if (value !== undefined) {
            options = $.extend({}, config.defaults, options);
            if (value === null) {
                options.expires = -1;
            }
            if (typeof options.expires === "number") {
                var days = options.expires, t = options.expires = new Date();
                t.setDate(t.getDate() + days);
            }
            value = config.json ? JSON.stringify(value) : String(value);
            return document.cookie = [ encodeURIComponent(key), "=", config.raw ? value : encodeURIComponent(value), options.expires ? "; expires=" + options.expires.toUTCString() : "", options.path ? "; path=" + options.path : "", options.domain ? "; domain=" + options.domain : "", options.secure ? "; secure" : "" ].join("");
        }
        var decode = config.raw ? raw : decoded;
        var cookies = document.cookie.split("; ");
        for (var i = 0, l = cookies.length; i < l; i++) {
            var parts = cookies[i].split("=");
            if (decode(parts.shift()) === key) {
                var cookie = decode(parts.join("="));
                return config.json ? JSON.parse(cookie) : cookie;
            }
        }
        return null;
    };
    config.defaults = {};
    $.removeCookie = function(key, options) {
        if ($.cookie(key) !== null) {
            $.cookie(key, null, options);
            return true;
        }
        return false;
    };
})(jQuery, document);

(function($) {
    $.fn.pajinate = function(options) {
        var current_page = "current_page";
        var items_per_page = "items_per_page";
        var meta;
        var defaults = {
            item_container_id: ".content",
            items_per_page: 10,
            nav_panel_id: ".page_navigation",
            nav_info_id: ".info_text",
            num_page_links_to_display: 20,
            start_page: 0,
            wrap_around: false,
            nav_label_first: "First",
            nav_label_prev: "Prev",
            nav_label_next: "Next",
            nav_label_last: "Last",
            nav_order: [ "first", "prev", "num", "next", "last" ],
            nav_label_info: "Showing {0}-{1} of {2} results",
            show_first_last: true,
            abort_on_small_lists: false,
            jquery_ui: false,
            jquery_ui_active: "ui-state-highlight",
            jquery_ui_default: "ui-state-default",
            jquery_ui_disabled: "ui-state-disabled"
        };
        var options = $.extend(defaults, options);
        var $item_container;
        var $page_container;
        var $items;
        var $nav_panels;
        var total_page_no_links;
        var jquery_ui_default_class = options.jquery_ui ? options.jquery_ui_default : "";
        var jquery_ui_active_class = options.jquery_ui ? options.jquery_ui_active : "";
        var jquery_ui_disabled_class = options.jquery_ui ? options.jquery_ui_disabled : "";
        return this.each(function() {
            $page_container = $(this);
            $item_container = $(this).find(options.item_container_id);
            $items = $page_container.find(options.item_container_id).children();
            if (options.abort_on_small_lists && options.items_per_page >= $items.size()) return $page_container;
            meta = $page_container;
            meta.data(current_page, 0);
            meta.data(items_per_page, options.items_per_page);
            var total_items = $item_container.children().size();
            var number_of_pages = Math.ceil(total_items / options.items_per_page);
            var more = '<span class="ellipse more">...</span>';
            var less = '<span class="ellipse less">...</span>';
            var first = !options.show_first_last ? "" : '<a class="first_link ' + jquery_ui_default_class + '" href="">' + options.nav_label_first + "</a>";
            var last = !options.show_first_last ? "" : '<a class="last_link ' + jquery_ui_default_class + '" href="">' + options.nav_label_last + "</a>";
            var navigation_html = "";
            for (var i = 0; i < options.nav_order.length; i++) {
                switch (options.nav_order[i]) {
                  case "first":
                    navigation_html += first;
                    break;

                  case "last":
                    navigation_html += last;
                    break;

                  case "next":
                    navigation_html += '<a id="next-link" class="next_link hide-text ' + jquery_ui_default_class + '" href="">' + options.nav_label_next + "</a>";
                    break;

                  case "prev":
                    navigation_html += '<a id="prev-link" class="previous_link hide-text ' + jquery_ui_default_class + '" href="">' + options.nav_label_prev + "</a>";
                    break;

                  case "num":
                    navigation_html += less;
                    var current_link = 0;
                    while (number_of_pages > current_link) {
                        navigation_html += '<a class="page_link ' + jquery_ui_default_class + '" href="" data-longdesc="' + current_link + '">' + (current_link + 1) + "</a>";
                        current_link++;
                    }
                    navigation_html += more;
                    break;

                  default:
                    break;
                }
            }
            $nav_panels = $page_container.find(options.nav_panel_id);
            $nav_panels.html(navigation_html).each(function() {
                $(this).find(".page_link:first").addClass("first");
                $(this).find(".page_link:last").addClass("last");
            });
            $nav_panels.children(".ellipse").hide();
            $nav_panels.find(".previous_link").next().next().addClass("active_page " + jquery_ui_active_class);
            $items.hide();
            $items.slice(0, meta.data(items_per_page)).show();
            total_page_no_links = $page_container.find(options.nav_panel_id + ":first").children(".page_link").size();
            options.num_page_links_to_display = Math.min(options.num_page_links_to_display, total_page_no_links);
            $nav_panels.children(".page_link").hide();
            $nav_panels.each(function() {
                $(this).children(".page_link").slice(0, options.num_page_links_to_display).show();
            });
            $page_container.find(".first_link").click(function(e) {
                e.preventDefault();
                movePageNumbersRight($(this), 0);
                $("#PageNumber").val(0);
                gotopage(0);
            });
            $page_container.find(".last_link").click(function(e) {
                e.preventDefault();
                var lastPage = total_page_no_links - 1;
                movePageNumbersLeft($(this), lastPage);
                $("#PageNumber").val(lastPage);
                gotopage(lastPage);
            });
            $page_container.find(".previous_link").click(function(e) {
                e.preventDefault();
                $("#PageNumber").val(parseInt(meta.data(current_page)) - 1);
                showPrevPage($(this));
            });
            $page_container.find(".next_link").click(function(e) {
                e.preventDefault();
                $("#PageNumber").val(parseInt(meta.data(current_page)) + 1);
                showNextPage($(this));
            });
            $page_container.find(".page_link").click(function(e) {
                e.preventDefault();
                $("#PageNumber").val($(this).attr("data-longdesc"));
                gotopage($(this).attr("data-longdesc"));
            });
            if ($("#PageNumber") !== undefined && $("#PageNumber").val() !== undefined && $("#PageNumber").val() !== "") {
                gotopage(parseInt($("#PageNumber").val(), 10));
            } else {
                gotopage(parseInt(options.start_page));
            }
            toggleMoreLess();
            if (!options.wrap_around) tagNextPrev();
        });
        function showPrevPage(e) {
            new_page = parseInt(meta.data(current_page)) - 1;
            if ($(e).siblings(".active_page").prev(".page_link").length == true) {
                movePageNumbersRight(e, new_page);
                gotopage(new_page);
            } else if (options.wrap_around) {
                gotopage(total_page_no_links - 1);
            }
        }
        function showNextPage(e) {
            new_page = parseInt(meta.data(current_page)) + 1;
            if ($(e).siblings(".active_page").next(".page_link").length == true) {
                movePageNumbersLeft(e, new_page);
                gotopage(new_page);
            } else if (options.wrap_around) {
                gotopage(0);
            }
        }
        function gotopage(page_num) {
            page_num = parseInt(page_num, 10);
            var ipp = parseInt(meta.data(items_per_page));
            start_from = page_num * ipp;
            end_on = start_from + ipp;
            var items = $items.hide().slice(start_from, end_on);
            items.show();
            $page_container.find(options.nav_panel_id).children(".page_link[data-longdesc=" + page_num + "]").addClass("active_page " + jquery_ui_active_class).siblings(".active_page").removeClass("active_page " + jquery_ui_active_class);
            meta.data(current_page, page_num);
            var $current_page = parseInt(meta.data(current_page) + 1);
            var total_items = $item_container.children().size();
            var $number_of_pages = Math.ceil(total_items / options.items_per_page);
            $page_container.find(options.nav_info_id).html(options.nav_label_info.replace("{0}", start_from + 1).replace("{1}", start_from + items.length).replace("{2}", $items.length).replace("{3}", $current_page).replace("{4}", $number_of_pages));
            toggleMoreLess();
            tagNextPrev();
            if (typeof options.onPageDisplayed !== "undefined") {
                options.onPageDisplayed.call(this, page_num + 1);
            }
        }
        function movePageNumbersLeft(e, new_p) {
            var new_page = new_p;
            var $current_active_link = $(e).siblings(".active_page");
            if ($current_active_link.siblings(".page_link[data-longdesc=" + new_page + "]").css("display") == "none") {
                $nav_panels.each(function() {
                    $(this).children(".page_link").hide().slice(parseInt(new_page - options.num_page_links_to_display + 1), new_page + 1).show();
                });
            }
        }
        function movePageNumbersRight(e, new_p) {
            var new_page = new_p;
            var $current_active_link = $(e).siblings(".active_page");
            if ($current_active_link.siblings(".page_link[data-longdesc=" + new_page + "]").css("display") == "none") {
                $nav_panels.each(function() {
                    $(this).children(".page_link").hide().slice(new_page, new_page + parseInt(options.num_page_links_to_display)).show();
                });
            }
        }
        function toggleMoreLess() {
            if (!$nav_panels.children(".page_link:visible").hasClass("last")) {
                $nav_panels.children(".more").show();
            } else {
                $nav_panels.children(".more").hide();
            }
            if (!$nav_panels.children(".page_link:visible").hasClass("first")) {
                $nav_panels.children(".less").show();
            } else {
                $nav_panels.children(".less").hide();
            }
        }
        function tagNextPrev() {
            if ($nav_panels.children(".last").hasClass("active_page")) {
                $nav_panels.children(".next_link").add(".last_link").addClass("no_more " + jquery_ui_disabled_class);
            } else {
                $nav_panels.children(".next_link").add(".last_link").removeClass("no_more " + jquery_ui_disabled_class);
            }
            if ($nav_panels.children(".first").hasClass("active_page")) {
                $nav_panels.children(".previous_link").add(".first_link").addClass("no_more " + jquery_ui_disabled_class);
            } else {
                $nav_panels.children(".previous_link").add(".first_link").removeClass("no_more " + jquery_ui_disabled_class);
            }
        }
    };
})(jQuery);

(function(e) {
    var i = {
        FOCUSSABLE_ELEMS: [ "input", "select", "textarea", "button" ],
        isTabbable: function(e) {
            return i.hasTabindex(e) && i.isFocussable(e) && i.isVisible(e);
        },
        hasTabindex: function(e) {
            return e.tabIndex >= 0;
        },
        isVisible: function(i) {
            return e(i).is(":visible");
        },
        isFocussable: function(e) {
            var n = e.nodeName, t = RegExp(i.FOCUSSABLE_ELEMS.join("|"), "gi");
            return t.test(n) && !e.disabled ? !0 : /a/i.test(n) && e.href ? !0 : !1;
        }
    };
    e.expr[":"].tabbable = i.isTabbable;
})(jQuery);

(function($) {
    $.fn.clearSearch = function(options) {
        var settings = $.extend({
            clearClass: "clear_input",
            divClass: this.clearClass + "_div",
            focusAfterClear: true,
            linkText: "&times;",
            distanceFromEdge: 5
        }, options);
        return this.each(function() {
            var $this = $(this), btn;
            if (!$this.parent().hasClass(settings.divClass)) {
                $this.wrap('<div style="position: relative;" class="' + settings.divClass + '">' + $this.html() + "</div>");
                $this.after('<a href="javascript:void(0)" style="position: absolute; cursor: pointer;" class="' + settings.clearClass + '">' + settings.linkText + "</a>");
            }
            btn = $this.next();
            function clearField() {
                $this.val("").change();
                triggerBtn();
                if (settings.focusAfterClear) {
                    $this.focus();
                }
                if (typeof settings.callback === "function") {
                    settings.callback();
                }
            }
            function triggerBtn() {
                if (hasText()) {
                    btn.show();
                } else {
                    btn.hide();
                }
                update();
            }
            function hasText() {
                return $this.val().replace(/^\s+|\s+$/g, "").length > 0;
            }
            function update() {
                var height = $this.outerHeight();
                btn.css({
                    top: height / 2 - btn.height() / 2,
                    right: settings.distanceFromEdge
                });
            }
            btn.on("click", clearField);
            $this.on("keyup keydown change focus", triggerBtn);
            triggerBtn();
        });
    };
})(jQuery);

(function($, undefined) {
    var uuid = 0, runiqueId = /^ui-id-\d+$/;
    $.ui = $.ui || {};
    $.extend($.ui, {
        version: "1.10.4",
        keyCode: {
            BACKSPACE: 8,
            COMMA: 188,
            DELETE: 46,
            DOWN: 40,
            END: 35,
            ENTER: 13,
            ESCAPE: 27,
            HOME: 36,
            LEFT: 37,
            NUMPAD_ADD: 107,
            NUMPAD_DECIMAL: 110,
            NUMPAD_DIVIDE: 111,
            NUMPAD_ENTER: 108,
            NUMPAD_MULTIPLY: 106,
            NUMPAD_SUBTRACT: 109,
            PAGE_DOWN: 34,
            PAGE_UP: 33,
            PERIOD: 190,
            RIGHT: 39,
            SPACE: 32,
            TAB: 9,
            UP: 38
        }
    });
    $.fn.extend({
        focus: function(orig) {
            return function(delay, fn) {
                return typeof delay === "number" ? this.each(function() {
                    var elem = this;
                    setTimeout(function() {
                        $(elem).focus();
                        if (fn) {
                            fn.call(elem);
                        }
                    }, delay);
                }) : orig.apply(this, arguments);
            };
        }($.fn.focus),
        scrollParent: function() {
            var scrollParent;
            if ($.ui.ie && /(static|relative)/.test(this.css("position")) || /absolute/.test(this.css("position"))) {
                scrollParent = this.parents().filter(function() {
                    return /(relative|absolute|fixed)/.test($.css(this, "position")) && /(auto|scroll)/.test($.css(this, "overflow") + $.css(this, "overflow-y") + $.css(this, "overflow-x"));
                }).eq(0);
            } else {
                scrollParent = this.parents().filter(function() {
                    return /(auto|scroll)/.test($.css(this, "overflow") + $.css(this, "overflow-y") + $.css(this, "overflow-x"));
                }).eq(0);
            }
            return /fixed/.test(this.css("position")) || !scrollParent.length ? $(document) : scrollParent;
        },
        zIndex: function(zIndex) {
            if (zIndex !== undefined) {
                return this.css("zIndex", zIndex);
            }
            if (this.length) {
                var elem = $(this[0]), position, value;
                while (elem.length && elem[0] !== document) {
                    position = elem.css("position");
                    if (position === "absolute" || position === "relative" || position === "fixed") {
                        value = parseInt(elem.css("zIndex"), 10);
                        if (!isNaN(value) && value !== 0) {
                            return value;
                        }
                    }
                    elem = elem.parent();
                }
            }
            return 0;
        },
        uniqueId: function() {
            return this.each(function() {
                if (!this.id) {
                    this.id = "ui-id-" + ++uuid;
                }
            });
        },
        removeUniqueId: function() {
            return this.each(function() {
                if (runiqueId.test(this.id)) {
                    $(this).removeAttr("id");
                }
            });
        }
    });
    function focusable(element, isTabIndexNotNaN) {
        var map, mapName, img, nodeName = element.nodeName.toLowerCase();
        if ("area" === nodeName) {
            map = element.parentNode;
            mapName = map.name;
            if (!element.href || !mapName || map.nodeName.toLowerCase() !== "map") {
                return false;
            }
            img = $("img[usemap=#" + mapName + "]")[0];
            return !!img && visible(img);
        }
        return (/input|select|textarea|button|object/.test(nodeName) ? !element.disabled : "a" === nodeName ? element.href || isTabIndexNotNaN : isTabIndexNotNaN) && visible(element);
    }
    function visible(element) {
        return $.expr.filters.visible(element) && !$(element).parents().addBack().filter(function() {
            return $.css(this, "visibility") === "hidden";
        }).length;
    }
    $.extend($.expr[":"], {
        data: $.expr.createPseudo ? $.expr.createPseudo(function(dataName) {
            return function(elem) {
                return !!$.data(elem, dataName);
            };
        }) : function(elem, i, match) {
            return !!$.data(elem, match[3]);
        },
        focusable: function(element) {
            return focusable(element, !isNaN($.attr(element, "tabindex")));
        },
        tabbable: function(element) {
            var tabIndex = $.attr(element, "tabindex"), isTabIndexNaN = isNaN(tabIndex);
            return (isTabIndexNaN || tabIndex >= 0) && focusable(element, !isTabIndexNaN);
        }
    });
    if (!$("<a>").outerWidth(1).jquery) {
        $.each([ "Width", "Height" ], function(i, name) {
            var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ], type = name.toLowerCase(), orig = {
                innerWidth: $.fn.innerWidth,
                innerHeight: $.fn.innerHeight,
                outerWidth: $.fn.outerWidth,
                outerHeight: $.fn.outerHeight
            };
            function reduce(elem, size, border, margin) {
                $.each(side, function() {
                    size -= parseFloat($.css(elem, "padding" + this)) || 0;
                    if (border) {
                        size -= parseFloat($.css(elem, "border" + this + "Width")) || 0;
                    }
                    if (margin) {
                        size -= parseFloat($.css(elem, "margin" + this)) || 0;
                    }
                });
                return size;
            }
            $.fn["inner" + name] = function(size) {
                if (size === undefined) {
                    return orig["inner" + name].call(this);
                }
                return this.each(function() {
                    $(this).css(type, reduce(this, size) + "px");
                });
            };
            $.fn["outer" + name] = function(size, margin) {
                if (typeof size !== "number") {
                    return orig["outer" + name].call(this, size);
                }
                return this.each(function() {
                    $(this).css(type, reduce(this, size, true, margin) + "px");
                });
            };
        });
    }
    if (!$.fn.addBack) {
        $.fn.addBack = function(selector) {
            return this.add(selector == null ? this.prevObject : this.prevObject.filter(selector));
        };
    }
    if ($("<a>").data("a-b", "a").removeData("a-b").data("a-b")) {
        $.fn.removeData = function(removeData) {
            return function(key) {
                if (arguments.length) {
                    return removeData.call(this, $.camelCase(key));
                } else {
                    return removeData.call(this);
                }
            };
        }($.fn.removeData);
    }
    $.ui.ie = !!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());
    $.support.selectstart = "onselectstart" in document.createElement("div");
    $.fn.extend({
        disableSelection: function() {
            return this.bind(($.support.selectstart ? "selectstart" : "mousedown") + ".ui-disableSelection", function(event) {
                event.preventDefault();
            });
        },
        enableSelection: function() {
            return this.unbind(".ui-disableSelection");
        }
    });
    $.extend($.ui, {
        plugin: {
            add: function(module, option, set) {
                var i, proto = $.ui[module].prototype;
                for (i in set) {
                    proto.plugins[i] = proto.plugins[i] || [];
                    proto.plugins[i].push([ option, set[i] ]);
                }
            },
            call: function(instance, name, args) {
                var i, set = instance.plugins[name];
                if (!set || !instance.element[0].parentNode || instance.element[0].parentNode.nodeType === 11) {
                    return;
                }
                for (i = 0; i < set.length; i++) {
                    if (instance.options[set[i][0]]) {
                        set[i][1].apply(instance.element, args);
                    }
                }
            }
        },
        hasScroll: function(el, a) {
            if ($(el).css("overflow") === "hidden") {
                return false;
            }
            var scroll = a && a === "left" ? "scrollLeft" : "scrollTop", has = false;
            if (el[scroll] > 0) {
                return true;
            }
            el[scroll] = 1;
            has = el[scroll] > 0;
            el[scroll] = 0;
            return has;
        }
    });
})(jQuery);

(function($, undefined) {
    var uuid = 0, slice = Array.prototype.slice, _cleanData = $.cleanData;
    $.cleanData = function(elems) {
        for (var i = 0, elem; (elem = elems[i]) != null; i++) {
            try {
                $(elem).triggerHandler("remove");
            } catch (e) {}
        }
        _cleanData(elems);
    };
    $.widget = function(name, base, prototype) {
        var fullName, existingConstructor, constructor, basePrototype, proxiedPrototype = {}, namespace = name.split(".")[0];
        name = name.split(".")[1];
        fullName = namespace + "-" + name;
        if (!prototype) {
            prototype = base;
            base = $.Widget;
        }
        $.expr[":"][fullName.toLowerCase()] = function(elem) {
            return !!$.data(elem, fullName);
        };
        $[namespace] = $[namespace] || {};
        existingConstructor = $[namespace][name];
        constructor = $[namespace][name] = function(options, element) {
            if (!this._createWidget) {
                return new constructor(options, element);
            }
            if (arguments.length) {
                this._createWidget(options, element);
            }
        };
        $.extend(constructor, existingConstructor, {
            version: prototype.version,
            _proto: $.extend({}, prototype),
            _childConstructors: []
        });
        basePrototype = new base();
        basePrototype.options = $.widget.extend({}, basePrototype.options);
        $.each(prototype, function(prop, value) {
            if (!$.isFunction(value)) {
                proxiedPrototype[prop] = value;
                return;
            }
            proxiedPrototype[prop] = function() {
                var _super = function() {
                    return base.prototype[prop].apply(this, arguments);
                }, _superApply = function(args) {
                    return base.prototype[prop].apply(this, args);
                };
                return function() {
                    var __super = this._super, __superApply = this._superApply, returnValue;
                    this._super = _super;
                    this._superApply = _superApply;
                    returnValue = value.apply(this, arguments);
                    this._super = __super;
                    this._superApply = __superApply;
                    return returnValue;
                };
            }();
        });
        constructor.prototype = $.widget.extend(basePrototype, {
            widgetEventPrefix: existingConstructor ? basePrototype.widgetEventPrefix || name : name
        }, proxiedPrototype, {
            constructor: constructor,
            namespace: namespace,
            widgetName: name,
            widgetFullName: fullName
        });
        if (existingConstructor) {
            $.each(existingConstructor._childConstructors, function(i, child) {
                var childPrototype = child.prototype;
                $.widget(childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto);
            });
            delete existingConstructor._childConstructors;
        } else {
            base._childConstructors.push(constructor);
        }
        $.widget.bridge(name, constructor);
    };
    $.widget.extend = function(target) {
        var input = slice.call(arguments, 1), inputIndex = 0, inputLength = input.length, key, value;
        for (;inputIndex < inputLength; inputIndex++) {
            for (key in input[inputIndex]) {
                value = input[inputIndex][key];
                if (input[inputIndex].hasOwnProperty(key) && value !== undefined) {
                    if ($.isPlainObject(value)) {
                        target[key] = $.isPlainObject(target[key]) ? $.widget.extend({}, target[key], value) : $.widget.extend({}, value);
                    } else {
                        target[key] = value;
                    }
                }
            }
        }
        return target;
    };
    $.widget.bridge = function(name, object) {
        var fullName = object.prototype.widgetFullName || name;
        $.fn[name] = function(options) {
            var isMethodCall = typeof options === "string", args = slice.call(arguments, 1), returnValue = this;
            options = !isMethodCall && args.length ? $.widget.extend.apply(null, [ options ].concat(args)) : options;
            if (isMethodCall) {
                this.each(function() {
                    var methodValue, instance = $.data(this, fullName);
                    if (!instance) {
                        return $.error("cannot call methods on " + name + " prior to initialization; " + "attempted to call method '" + options + "'");
                    }
                    if (!$.isFunction(instance[options]) || options.charAt(0) === "_") {
                        return $.error("no such method '" + options + "' for " + name + " widget instance");
                    }
                    methodValue = instance[options].apply(instance, args);
                    if (methodValue !== instance && methodValue !== undefined) {
                        returnValue = methodValue && methodValue.jquery ? returnValue.pushStack(methodValue.get()) : methodValue;
                        return false;
                    }
                });
            } else {
                this.each(function() {
                    var instance = $.data(this, fullName);
                    if (instance) {
                        instance.option(options || {})._init();
                    } else {
                        $.data(this, fullName, new object(options, this));
                    }
                });
            }
            return returnValue;
        };
    };
    $.Widget = function() {};
    $.Widget._childConstructors = [];
    $.Widget.prototype = {
        widgetName: "widget",
        widgetEventPrefix: "",
        defaultElement: "<div>",
        options: {
            disabled: false,
            create: null
        },
        _createWidget: function(options, element) {
            element = $(element || this.defaultElement || this)[0];
            this.element = $(element);
            this.uuid = uuid++;
            this.eventNamespace = "." + this.widgetName + this.uuid;
            this.options = $.widget.extend({}, this.options, this._getCreateOptions(), options);
            this.bindings = $();
            this.hoverable = $();
            this.focusable = $();
            if (element !== this) {
                $.data(element, this.widgetFullName, this);
                this._on(true, this.element, {
                    remove: function(event) {
                        if (event.target === element) {
                            this.destroy();
                        }
                    }
                });
                this.document = $(element.style ? element.ownerDocument : element.document || element);
                this.window = $(this.document[0].defaultView || this.document[0].parentWindow);
            }
            this._create();
            this._trigger("create", null, this._getCreateEventData());
            this._init();
        },
        _getCreateOptions: $.noop,
        _getCreateEventData: $.noop,
        _create: $.noop,
        _init: $.noop,
        destroy: function() {
            this._destroy();
            this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName));
            this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName + "-disabled " + "ui-state-disabled");
            this.bindings.unbind(this.eventNamespace);
            this.hoverable.removeClass("ui-state-hover");
            this.focusable.removeClass("ui-state-focus");
        },
        _destroy: $.noop,
        widget: function() {
            return this.element;
        },
        option: function(key, value) {
            var options = key, parts, curOption, i;
            if (arguments.length === 0) {
                return $.widget.extend({}, this.options);
            }
            if (typeof key === "string") {
                options = {};
                parts = key.split(".");
                key = parts.shift();
                if (parts.length) {
                    curOption = options[key] = $.widget.extend({}, this.options[key]);
                    for (i = 0; i < parts.length - 1; i++) {
                        curOption[parts[i]] = curOption[parts[i]] || {};
                        curOption = curOption[parts[i]];
                    }
                    key = parts.pop();
                    if (arguments.length === 1) {
                        return curOption[key] === undefined ? null : curOption[key];
                    }
                    curOption[key] = value;
                } else {
                    if (arguments.length === 1) {
                        return this.options[key] === undefined ? null : this.options[key];
                    }
                    options[key] = value;
                }
            }
            this._setOptions(options);
            return this;
        },
        _setOptions: function(options) {
            var key;
            for (key in options) {
                this._setOption(key, options[key]);
            }
            return this;
        },
        _setOption: function(key, value) {
            this.options[key] = value;
            if (key === "disabled") {
                this.widget().toggleClass(this.widgetFullName + "-disabled ui-state-disabled", !!value).attr("aria-disabled", value);
                this.hoverable.removeClass("ui-state-hover");
                this.focusable.removeClass("ui-state-focus");
            }
            return this;
        },
        enable: function() {
            return this._setOption("disabled", false);
        },
        disable: function() {
            return this._setOption("disabled", true);
        },
        _on: function(suppressDisabledCheck, element, handlers) {
            var delegateElement, instance = this;
            if (typeof suppressDisabledCheck !== "boolean") {
                handlers = element;
                element = suppressDisabledCheck;
                suppressDisabledCheck = false;
            }
            if (!handlers) {
                handlers = element;
                element = this.element;
                delegateElement = this.widget();
            } else {
                element = delegateElement = $(element);
                this.bindings = this.bindings.add(element);
            }
            $.each(handlers, function(event, handler) {
                function handlerProxy() {
                    if (!suppressDisabledCheck && (instance.options.disabled === true || $(this).hasClass("ui-state-disabled"))) {
                        return;
                    }
                    return (typeof handler === "string" ? instance[handler] : handler).apply(instance, arguments);
                }
                if (typeof handler !== "string") {
                    handlerProxy.guid = handler.guid = handler.guid || handlerProxy.guid || $.guid++;
                }
                var match = event.match(/^(\w+)\s*(.*)$/), eventName = match[1] + instance.eventNamespace, selector = match[2];
                if (selector) {
                    delegateElement.delegate(selector, eventName, handlerProxy);
                } else {
                    element.bind(eventName, handlerProxy);
                }
            });
        },
        _off: function(element, eventName) {
            eventName = (eventName || "").split(" ").join(this.eventNamespace + " ") + this.eventNamespace;
            element.unbind(eventName).undelegate(eventName);
        },
        _delay: function(handler, delay) {
            function handlerProxy() {
                return (typeof handler === "string" ? instance[handler] : handler).apply(instance, arguments);
            }
            var instance = this;
            return setTimeout(handlerProxy, delay || 0);
        },
        _hoverable: function(element) {
            this.hoverable = this.hoverable.add(element);
            this._on(element, {
                mouseenter: function(event) {
                    $(event.currentTarget).addClass("ui-state-hover");
                },
                mouseleave: function(event) {
                    $(event.currentTarget).removeClass("ui-state-hover");
                }
            });
        },
        _focusable: function(element) {
            this.focusable = this.focusable.add(element);
            this._on(element, {
                focusin: function(event) {
                    $(event.currentTarget).addClass("ui-state-focus");
                },
                focusout: function(event) {
                    $(event.currentTarget).removeClass("ui-state-focus");
                }
            });
        },
        _trigger: function(type, event, data) {
            var prop, orig, callback = this.options[type];
            data = data || {};
            event = $.Event(event);
            event.type = (type === this.widgetEventPrefix ? type : this.widgetEventPrefix + type).toLowerCase();
            event.target = this.element[0];
            orig = event.originalEvent;
            if (orig) {
                for (prop in orig) {
                    if (!(prop in event)) {
                        event[prop] = orig[prop];
                    }
                }
            }
            this.element.trigger(event, data);
            return !($.isFunction(callback) && callback.apply(this.element[0], [ event ].concat(data)) === false || event.isDefaultPrevented());
        }
    };
    $.each({
        show: "fadeIn",
        hide: "fadeOut"
    }, function(method, defaultEffect) {
        $.Widget.prototype["_" + method] = function(element, options, callback) {
            if (typeof options === "string") {
                options = {
                    effect: options
                };
            }
            var hasOptions, effectName = !options ? method : options === true || typeof options === "number" ? defaultEffect : options.effect || defaultEffect;
            options = options || {};
            if (typeof options === "number") {
                options = {
                    duration: options
                };
            }
            hasOptions = !$.isEmptyObject(options);
            options.complete = callback;
            if (options.delay) {
                element.delay(options.delay);
            }
            if (hasOptions && $.effects && $.effects.effect[effectName]) {
                element[method](options);
            } else if (effectName !== method && element[effectName]) {
                element[effectName](options.duration, options.easing, callback);
            } else {
                element.queue(function(next) {
                    $(this)[method]();
                    if (callback) {
                        callback.call(element[0]);
                    }
                    next();
                });
            }
        };
    });
})(jQuery);

(function($, undefined) {
    var mouseHandled = false;
    $(document).mouseup(function() {
        mouseHandled = false;
    });
    $.widget("ui.mouse", {
        version: "1.10.4",
        options: {
            cancel: "input,textarea,button,select,option",
            distance: 1,
            delay: 0
        },
        _mouseInit: function() {
            var that = this;
            this.element.bind("mousedown." + this.widgetName, function(event) {
                return that._mouseDown(event);
            }).bind("click." + this.widgetName, function(event) {
                if (true === $.data(event.target, that.widgetName + ".preventClickEvent")) {
                    $.removeData(event.target, that.widgetName + ".preventClickEvent");
                    event.stopImmediatePropagation();
                    return false;
                }
            });
            this.started = false;
        },
        _mouseDestroy: function() {
            this.element.unbind("." + this.widgetName);
            if (this._mouseMoveDelegate) {
                $(document).unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
            }
        },
        _mouseDown: function(event) {
            if (mouseHandled) {
                return;
            }
            this._mouseStarted && this._mouseUp(event);
            this._mouseDownEvent = event;
            var that = this, btnIsLeft = event.which === 1, elIsCancel = typeof this.options.cancel === "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false;
            if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
                return true;
            }
            this.mouseDelayMet = !this.options.delay;
            if (!this.mouseDelayMet) {
                this._mouseDelayTimer = setTimeout(function() {
                    that.mouseDelayMet = true;
                }, this.options.delay);
            }
            if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
                this._mouseStarted = this._mouseStart(event) !== false;
                if (!this._mouseStarted) {
                    event.preventDefault();
                    return true;
                }
            }
            if (true === $.data(event.target, this.widgetName + ".preventClickEvent")) {
                $.removeData(event.target, this.widgetName + ".preventClickEvent");
            }
            this._mouseMoveDelegate = function(event) {
                return that._mouseMove(event);
            };
            this._mouseUpDelegate = function(event) {
                return that._mouseUp(event);
            };
            $(document).bind("mousemove." + this.widgetName, this._mouseMoveDelegate).bind("mouseup." + this.widgetName, this._mouseUpDelegate);
            event.preventDefault();
            mouseHandled = true;
            return true;
        },
        _mouseMove: function(event) {
            if ($.ui.ie && (!document.documentMode || document.documentMode < 9) && !event.button) {
                return this._mouseUp(event);
            }
            if (this._mouseStarted) {
                this._mouseDrag(event);
                return event.preventDefault();
            }
            if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
                this._mouseStarted = this._mouseStart(this._mouseDownEvent, event) !== false;
                this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event);
            }
            return !this._mouseStarted;
        },
        _mouseUp: function(event) {
            $(document).unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
            if (this._mouseStarted) {
                this._mouseStarted = false;
                if (event.target === this._mouseDownEvent.target) {
                    $.data(event.target, this.widgetName + ".preventClickEvent", true);
                }
                this._mouseStop(event);
            }
            return false;
        },
        _mouseDistanceMet: function(event) {
            return Math.max(Math.abs(this._mouseDownEvent.pageX - event.pageX), Math.abs(this._mouseDownEvent.pageY - event.pageY)) >= this.options.distance;
        },
        _mouseDelayMet: function() {
            return this.mouseDelayMet;
        },
        _mouseStart: function() {},
        _mouseDrag: function() {},
        _mouseStop: function() {},
        _mouseCapture: function() {
            return true;
        }
    });
})(jQuery);

(function($, undefined) {
    $.ui = $.ui || {};
    var cachedScrollbarWidth, max = Math.max, abs = Math.abs, round = Math.round, rhorizontal = /left|center|right/, rvertical = /top|center|bottom/, roffset = /[\+\-]\d+(\.[\d]+)?%?/, rposition = /^\w+/, rpercent = /%$/, _position = $.fn.position;
    function getOffsets(offsets, width, height) {
        return [ parseFloat(offsets[0]) * (rpercent.test(offsets[0]) ? width / 100 : 1), parseFloat(offsets[1]) * (rpercent.test(offsets[1]) ? height / 100 : 1) ];
    }
    function parseCss(element, property) {
        return parseInt($.css(element, property), 10) || 0;
    }
    function getDimensions(elem) {
        var raw = elem[0];
        if (raw.nodeType === 9) {
            return {
                width: elem.width(),
                height: elem.height(),
                offset: {
                    top: 0,
                    left: 0
                }
            };
        }
        if ($.isWindow(raw)) {
            return {
                width: elem.width(),
                height: elem.height(),
                offset: {
                    top: elem.scrollTop(),
                    left: elem.scrollLeft()
                }
            };
        }
        if (raw.preventDefault) {
            return {
                width: 0,
                height: 0,
                offset: {
                    top: raw.pageY,
                    left: raw.pageX
                }
            };
        }
        return {
            width: elem.outerWidth(),
            height: elem.outerHeight(),
            offset: elem.offset()
        };
    }
    $.position = {
        scrollbarWidth: function() {
            if (cachedScrollbarWidth !== undefined) {
                return cachedScrollbarWidth;
            }
            var w1, w2, div = $("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"), innerDiv = div.children()[0];
            $("body").append(div);
            w1 = innerDiv.offsetWidth;
            div.css("overflow", "scroll");
            w2 = innerDiv.offsetWidth;
            if (w1 === w2) {
                w2 = div[0].clientWidth;
            }
            div.remove();
            return cachedScrollbarWidth = w1 - w2;
        },
        getScrollInfo: function(within) {
            var overflowX = within.isWindow || within.isDocument ? "" : within.element.css("overflow-x"), overflowY = within.isWindow || within.isDocument ? "" : within.element.css("overflow-y"), hasOverflowX = overflowX === "scroll" || overflowX === "auto" && within.width < within.element[0].scrollWidth, hasOverflowY = overflowY === "scroll" || overflowY === "auto" && within.height < within.element[0].scrollHeight;
            return {
                width: hasOverflowY ? $.position.scrollbarWidth() : 0,
                height: hasOverflowX ? $.position.scrollbarWidth() : 0
            };
        },
        getWithinInfo: function(element) {
            var withinElement = $(element || window), isWindow = $.isWindow(withinElement[0]), isDocument = !!withinElement[0] && withinElement[0].nodeType === 9;
            return {
                element: withinElement,
                isWindow: isWindow,
                isDocument: isDocument,
                offset: withinElement.offset() || {
                    left: 0,
                    top: 0
                },
                scrollLeft: withinElement.scrollLeft(),
                scrollTop: withinElement.scrollTop(),
                width: isWindow ? withinElement.width() : withinElement.outerWidth(),
                height: isWindow ? withinElement.height() : withinElement.outerHeight()
            };
        }
    };
    $.fn.position = function(options) {
        if (!options || !options.of) {
            return _position.apply(this, arguments);
        }
        options = $.extend({}, options);
        var atOffset, targetWidth, targetHeight, targetOffset, basePosition, dimensions, target = $(options.of), within = $.position.getWithinInfo(options.within), scrollInfo = $.position.getScrollInfo(within), collision = (options.collision || "flip").split(" "), offsets = {};
        dimensions = getDimensions(target);
        if (target[0].preventDefault) {
            options.at = "left top";
        }
        targetWidth = dimensions.width;
        targetHeight = dimensions.height;
        targetOffset = dimensions.offset;
        basePosition = $.extend({}, targetOffset);
        $.each([ "my", "at" ], function() {
            var pos = (options[this] || "").split(" "), horizontalOffset, verticalOffset;
            if (pos.length === 1) {
                pos = rhorizontal.test(pos[0]) ? pos.concat([ "center" ]) : rvertical.test(pos[0]) ? [ "center" ].concat(pos) : [ "center", "center" ];
            }
            pos[0] = rhorizontal.test(pos[0]) ? pos[0] : "center";
            pos[1] = rvertical.test(pos[1]) ? pos[1] : "center";
            horizontalOffset = roffset.exec(pos[0]);
            verticalOffset = roffset.exec(pos[1]);
            offsets[this] = [ horizontalOffset ? horizontalOffset[0] : 0, verticalOffset ? verticalOffset[0] : 0 ];
            options[this] = [ rposition.exec(pos[0])[0], rposition.exec(pos[1])[0] ];
        });
        if (collision.length === 1) {
            collision[1] = collision[0];
        }
        if (options.at[0] === "right") {
            basePosition.left += targetWidth;
        } else if (options.at[0] === "center") {
            basePosition.left += targetWidth / 2;
        }
        if (options.at[1] === "bottom") {
            basePosition.top += targetHeight;
        } else if (options.at[1] === "center") {
            basePosition.top += targetHeight / 2;
        }
        atOffset = getOffsets(offsets.at, targetWidth, targetHeight);
        basePosition.left += atOffset[0];
        basePosition.top += atOffset[1];
        return this.each(function() {
            var collisionPosition, using, elem = $(this), elemWidth = elem.outerWidth(), elemHeight = elem.outerHeight(), marginLeft = parseCss(this, "marginLeft"), marginTop = parseCss(this, "marginTop"), collisionWidth = elemWidth + marginLeft + parseCss(this, "marginRight") + scrollInfo.width, collisionHeight = elemHeight + marginTop + parseCss(this, "marginBottom") + scrollInfo.height, position = $.extend({}, basePosition), myOffset = getOffsets(offsets.my, elem.outerWidth(), elem.outerHeight());
            if (options.my[0] === "right") {
                position.left -= elemWidth;
            } else if (options.my[0] === "center") {
                position.left -= elemWidth / 2;
            }
            if (options.my[1] === "bottom") {
                position.top -= elemHeight;
            } else if (options.my[1] === "center") {
                position.top -= elemHeight / 2;
            }
            position.left += myOffset[0];
            position.top += myOffset[1];
            if (!$.support.offsetFractions) {
                position.left = round(position.left);
                position.top = round(position.top);
            }
            collisionPosition = {
                marginLeft: marginLeft,
                marginTop: marginTop
            };
            $.each([ "left", "top" ], function(i, dir) {
                if ($.ui.position[collision[i]]) {
                    $.ui.position[collision[i]][dir](position, {
                        targetWidth: targetWidth,
                        targetHeight: targetHeight,
                        elemWidth: elemWidth,
                        elemHeight: elemHeight,
                        collisionPosition: collisionPosition,
                        collisionWidth: collisionWidth,
                        collisionHeight: collisionHeight,
                        offset: [ atOffset[0] + myOffset[0], atOffset[1] + myOffset[1] ],
                        my: options.my,
                        at: options.at,
                        within: within,
                        elem: elem
                    });
                }
            });
            if (options.using) {
                using = function(props) {
                    var left = targetOffset.left - position.left, right = left + targetWidth - elemWidth, top = targetOffset.top - position.top, bottom = top + targetHeight - elemHeight, feedback = {
                        target: {
                            element: target,
                            left: targetOffset.left,
                            top: targetOffset.top,
                            width: targetWidth,
                            height: targetHeight
                        },
                        element: {
                            element: elem,
                            left: position.left,
                            top: position.top,
                            width: elemWidth,
                            height: elemHeight
                        },
                        horizontal: right < 0 ? "left" : left > 0 ? "right" : "center",
                        vertical: bottom < 0 ? "top" : top > 0 ? "bottom" : "middle"
                    };
                    if (targetWidth < elemWidth && abs(left + right) < targetWidth) {
                        feedback.horizontal = "center";
                    }
                    if (targetHeight < elemHeight && abs(top + bottom) < targetHeight) {
                        feedback.vertical = "middle";
                    }
                    if (max(abs(left), abs(right)) > max(abs(top), abs(bottom))) {
                        feedback.important = "horizontal";
                    } else {
                        feedback.important = "vertical";
                    }
                    options.using.call(this, props, feedback);
                };
            }
            elem.offset($.extend(position, {
                using: using
            }));
        });
    };
    $.ui.position = {
        fit: {
            left: function(position, data) {
                var within = data.within, withinOffset = within.isWindow ? within.scrollLeft : within.offset.left, outerWidth = within.width, collisionPosLeft = position.left - data.collisionPosition.marginLeft, overLeft = withinOffset - collisionPosLeft, overRight = collisionPosLeft + data.collisionWidth - outerWidth - withinOffset, newOverRight;
                if (data.collisionWidth > outerWidth) {
                    if (overLeft > 0 && overRight <= 0) {
                        newOverRight = position.left + overLeft + data.collisionWidth - outerWidth - withinOffset;
                        position.left += overLeft - newOverRight;
                    } else if (overRight > 0 && overLeft <= 0) {
                        position.left = withinOffset;
                    } else {
                        if (overLeft > overRight) {
                            position.left = withinOffset + outerWidth - data.collisionWidth;
                        } else {
                            position.left = withinOffset;
                        }
                    }
                } else if (overLeft > 0) {
                    position.left += overLeft;
                } else if (overRight > 0) {
                    position.left -= overRight;
                } else {
                    position.left = max(position.left - collisionPosLeft, position.left);
                }
            },
            top: function(position, data) {
                var within = data.within, withinOffset = within.isWindow ? within.scrollTop : within.offset.top, outerHeight = data.within.height, collisionPosTop = position.top - data.collisionPosition.marginTop, overTop = withinOffset - collisionPosTop, overBottom = collisionPosTop + data.collisionHeight - outerHeight - withinOffset, newOverBottom;
                if (data.collisionHeight > outerHeight) {
                    if (overTop > 0 && overBottom <= 0) {
                        newOverBottom = position.top + overTop + data.collisionHeight - outerHeight - withinOffset;
                        position.top += overTop - newOverBottom;
                    } else if (overBottom > 0 && overTop <= 0) {
                        position.top = withinOffset;
                    } else {
                        if (overTop > overBottom) {
                            position.top = withinOffset + outerHeight - data.collisionHeight;
                        } else {
                            position.top = withinOffset;
                        }
                    }
                } else if (overTop > 0) {
                    position.top += overTop;
                } else if (overBottom > 0) {
                    position.top -= overBottom;
                } else {
                    position.top = max(position.top - collisionPosTop, position.top);
                }
            }
        },
        flip: {
            left: function(position, data) {
                var within = data.within, withinOffset = within.offset.left + within.scrollLeft, outerWidth = within.width, offsetLeft = within.isWindow ? within.scrollLeft : within.offset.left, collisionPosLeft = position.left - data.collisionPosition.marginLeft, overLeft = collisionPosLeft - offsetLeft, overRight = collisionPosLeft + data.collisionWidth - outerWidth - offsetLeft, myOffset = data.my[0] === "left" ? -data.elemWidth : data.my[0] === "right" ? data.elemWidth : 0, atOffset = data.at[0] === "left" ? data.targetWidth : data.at[0] === "right" ? -data.targetWidth : 0, offset = -2 * data.offset[0], newOverRight, newOverLeft;
                if (overLeft < 0) {
                    newOverRight = position.left + myOffset + atOffset + offset + data.collisionWidth - outerWidth - withinOffset;
                    if (newOverRight < 0 || newOverRight < abs(overLeft)) {
                        position.left += myOffset + atOffset + offset;
                    }
                } else if (overRight > 0) {
                    newOverLeft = position.left - data.collisionPosition.marginLeft + myOffset + atOffset + offset - offsetLeft;
                    if (newOverLeft > 0 || abs(newOverLeft) < overRight) {
                        position.left += myOffset + atOffset + offset;
                    }
                }
            },
            top: function(position, data) {
                var within = data.within, withinOffset = within.offset.top + within.scrollTop, outerHeight = within.height, offsetTop = within.isWindow ? within.scrollTop : within.offset.top, collisionPosTop = position.top - data.collisionPosition.marginTop, overTop = collisionPosTop - offsetTop, overBottom = collisionPosTop + data.collisionHeight - outerHeight - offsetTop, top = data.my[1] === "top", myOffset = top ? -data.elemHeight : data.my[1] === "bottom" ? data.elemHeight : 0, atOffset = data.at[1] === "top" ? data.targetHeight : data.at[1] === "bottom" ? -data.targetHeight : 0, offset = -2 * data.offset[1], newOverTop, newOverBottom;
                if (overTop < 0) {
                    newOverBottom = position.top + myOffset + atOffset + offset + data.collisionHeight - outerHeight - withinOffset;
                    if (position.top + myOffset + atOffset + offset > overTop && (newOverBottom < 0 || newOverBottom < abs(overTop))) {
                        position.top += myOffset + atOffset + offset;
                    }
                } else if (overBottom > 0) {
                    newOverTop = position.top - data.collisionPosition.marginTop + myOffset + atOffset + offset - offsetTop;
                    if (position.top + myOffset + atOffset + offset > overBottom && (newOverTop > 0 || abs(newOverTop) < overBottom)) {
                        position.top += myOffset + atOffset + offset;
                    }
                }
            }
        },
        flipfit: {
            left: function() {
                $.ui.position.flip.left.apply(this, arguments);
                $.ui.position.fit.left.apply(this, arguments);
            },
            top: function() {
                $.ui.position.flip.top.apply(this, arguments);
                $.ui.position.fit.top.apply(this, arguments);
            }
        }
    };
    (function() {
        var testElement, testElementParent, testElementStyle, offsetLeft, i, body = document.getElementsByTagName("body")[0], div = document.createElement("div");
        testElement = document.createElement(body ? "div" : "body");
        testElementStyle = {
            visibility: "hidden",
            width: 0,
            height: 0,
            border: 0,
            margin: 0,
            background: "none"
        };
        if (body) {
            $.extend(testElementStyle, {
                position: "absolute",
                left: "-1000px",
                top: "-1000px"
            });
        }
        for (i in testElementStyle) {
            testElement.style[i] = testElementStyle[i];
        }
        testElement.appendChild(div);
        testElementParent = body || document.documentElement;
        testElementParent.insertBefore(testElement, testElementParent.firstChild);
        div.style.cssText = "position: absolute; left: 10.7432222px;";
        offsetLeft = $(div).offset().left;
        $.support.offsetFractions = offsetLeft > 10 && offsetLeft < 11;
        testElement.innerHTML = "";
        testElementParent.removeChild(testElement);
    })();
})(jQuery);

(function($, undefined) {
    $.extend($.ui, {
        datepicker: {
            version: "1.10.4"
        }
    });
    var PROP_NAME = "datepicker", instActive;
    function Datepicker() {
        this._curInst = null;
        this._keyEvent = false;
        this._disabledInputs = [];
        this._datepickerShowing = false;
        this._inDialog = false;
        this._mainDivId = "ui-datepicker-div";
        this._inlineClass = "ui-datepicker-inline";
        this._appendClass = "ui-datepicker-append";
        this._triggerClass = "ui-datepicker-trigger";
        this._dialogClass = "ui-datepicker-dialog";
        this._disableClass = "ui-datepicker-disabled";
        this._unselectableClass = "ui-datepicker-unselectable";
        this._currentClass = "ui-datepicker-current-day";
        this._dayOverClass = "ui-datepicker-days-cell-over";
        this.regional = [];
        this.regional[""] = {
            closeText: "Done",
            prevText: "Prev",
            nextText: "Next",
            currentText: "Today",
            monthNames: [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
            monthNamesShort: [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ],
            dayNames: [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ],
            dayNamesShort: [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" ],
            dayNamesMin: [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
            weekHeader: "Wk",
            dateFormat: "mm/dd/yy",
            firstDay: 0,
            isRTL: false,
            showMonthAfterYear: false,
            yearSuffix: ""
        };
        this._defaults = {
            showOn: "focus",
            showAnim: "fadeIn",
            showOptions: {},
            defaultDate: null,
            appendText: "",
            buttonText: "...",
            buttonImage: "",
            buttonImageOnly: false,
            hideIfNoPrevNext: false,
            navigationAsDateFormat: false,
            gotoCurrent: false,
            changeMonth: false,
            changeYear: false,
            yearRange: "c-10:c+10",
            showOtherMonths: false,
            selectOtherMonths: false,
            showWeek: false,
            calculateWeek: this.iso8601Week,
            shortYearCutoff: "+10",
            minDate: null,
            maxDate: null,
            duration: "fast",
            beforeShowDay: null,
            beforeShow: null,
            onSelect: null,
            onChangeMonthYear: null,
            onClose: null,
            numberOfMonths: 1,
            showCurrentAtPos: 0,
            stepMonths: 1,
            stepBigMonths: 12,
            altField: "",
            altFormat: "",
            constrainInput: true,
            showButtonPanel: false,
            autoSize: false,
            disabled: false
        };
        $.extend(this._defaults, this.regional[""]);
        this.dpDiv = bindHover($("<div id='" + this._mainDivId + "' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"));
    }
    $.extend(Datepicker.prototype, {
        markerClassName: "hasDatepicker",
        maxRows: 4,
        _widgetDatepicker: function() {
            return this.dpDiv;
        },
        setDefaults: function(settings) {
            extendRemove(this._defaults, settings || {});
            return this;
        },
        _attachDatepicker: function(target, settings) {
            var nodeName, inline, inst;
            nodeName = target.nodeName.toLowerCase();
            inline = nodeName === "div" || nodeName === "span";
            if (!target.id) {
                this.uuid += 1;
                target.id = "dp" + this.uuid;
            }
            inst = this._newInst($(target), inline);
            inst.settings = $.extend({}, settings || {});
            if (nodeName === "input") {
                this._connectDatepicker(target, inst);
            } else if (inline) {
                this._inlineDatepicker(target, inst);
            }
        },
        _newInst: function(target, inline) {
            var id = target[0].id.replace(/([^A-Za-z0-9_\-])/g, "\\\\$1");
            return {
                id: id,
                input: target,
                selectedDay: 0,
                selectedMonth: 0,
                selectedYear: 0,
                drawMonth: 0,
                drawYear: 0,
                inline: inline,
                dpDiv: !inline ? this.dpDiv : bindHover($("<div class='" + this._inlineClass + " ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))
            };
        },
        _connectDatepicker: function(target, inst) {
            var input = $(target);
            inst.append = $([]);
            inst.trigger = $([]);
            if (input.hasClass(this.markerClassName)) {
                return;
            }
            this._attachments(input, inst);
            input.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp);
            this._autoSize(inst);
            $.data(target, PROP_NAME, inst);
            if (inst.settings.disabled) {
                this._disableDatepicker(target);
            }
        },
        _attachments: function(input, inst) {
            var showOn, buttonText, buttonImage, appendText = this._get(inst, "appendText"), isRTL = this._get(inst, "isRTL");
            if (inst.append) {
                inst.append.remove();
            }
            if (appendText) {
                inst.append = $("<span class='" + this._appendClass + "'>" + appendText + "</span>");
                input[isRTL ? "before" : "after"](inst.append);
            }
            input.unbind("focus", this._showDatepicker);
            if (inst.trigger) {
                inst.trigger.remove();
            }
            showOn = this._get(inst, "showOn");
            if (showOn === "focus" || showOn === "both") {
                input.focus(this._showDatepicker);
            }
            if (showOn === "button" || showOn === "both") {
                buttonText = this._get(inst, "buttonText");
                buttonImage = this._get(inst, "buttonImage");
                inst.trigger = $(this._get(inst, "buttonImageOnly") ? $("<img/>").addClass(this._triggerClass).attr({
                    src: buttonImage,
                    alt: buttonText,
                    title: buttonText
                }) : $("<button type='button'></button>").addClass(this._triggerClass).html(!buttonImage ? buttonText : $("<img/>").attr({
                    src: buttonImage,
                    alt: buttonText,
                    title: buttonText
                })));
                input[isRTL ? "before" : "after"](inst.trigger);
                inst.trigger.click(function() {
                    if ($.datepicker._datepickerShowing && $.datepicker._lastInput === input[0]) {
                        $.datepicker._hideDatepicker();
                    } else if ($.datepicker._datepickerShowing && $.datepicker._lastInput !== input[0]) {
                        $.datepicker._hideDatepicker();
                        $.datepicker._showDatepicker(input[0]);
                    } else {
                        $.datepicker._showDatepicker(input[0]);
                    }
                    return false;
                });
            }
        },
        _autoSize: function(inst) {
            if (this._get(inst, "autoSize") && !inst.inline) {
                var findMax, max, maxI, i, date = new Date(2009, 12 - 1, 20), dateFormat = this._get(inst, "dateFormat");
                if (dateFormat.match(/[DM]/)) {
                    findMax = function(names) {
                        max = 0;
                        maxI = 0;
                        for (i = 0; i < names.length; i++) {
                            if (names[i].length > max) {
                                max = names[i].length;
                                maxI = i;
                            }
                        }
                        return maxI;
                    };
                    date.setMonth(findMax(this._get(inst, dateFormat.match(/MM/) ? "monthNames" : "monthNamesShort")));
                    date.setDate(findMax(this._get(inst, dateFormat.match(/DD/) ? "dayNames" : "dayNamesShort")) + 20 - date.getDay());
                }
                inst.input.attr("size", this._formatDate(inst, date).length);
            }
        },
        _inlineDatepicker: function(target, inst) {
            var divSpan = $(target);
            if (divSpan.hasClass(this.markerClassName)) {
                return;
            }
            divSpan.addClass(this.markerClassName).append(inst.dpDiv);
            $.data(target, PROP_NAME, inst);
            this._setDate(inst, this._getDefaultDate(inst), true);
            this._updateDatepicker(inst);
            this._updateAlternate(inst);
            if (inst.settings.disabled) {
                this._disableDatepicker(target);
            }
            inst.dpDiv.css("display", "block");
        },
        _dialogDatepicker: function(input, date, onSelect, settings, pos) {
            var id, browserWidth, browserHeight, scrollX, scrollY, inst = this._dialogInst;
            if (!inst) {
                this.uuid += 1;
                id = "dp" + this.uuid;
                this._dialogInput = $("<input type='text' id='" + id + "' style='position: absolute; top: -100px; width: 0px;'/>");
                this._dialogInput.keydown(this._doKeyDown);
                $("body").append(this._dialogInput);
                inst = this._dialogInst = this._newInst(this._dialogInput, false);
                inst.settings = {};
                $.data(this._dialogInput[0], PROP_NAME, inst);
            }
            extendRemove(inst.settings, settings || {});
            date = date && date.constructor === Date ? this._formatDate(inst, date) : date;
            this._dialogInput.val(date);
            this._pos = pos ? pos.length ? pos : [ pos.pageX, pos.pageY ] : null;
            if (!this._pos) {
                browserWidth = document.documentElement.clientWidth;
                browserHeight = document.documentElement.clientHeight;
                scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
                scrollY = document.documentElement.scrollTop || document.body.scrollTop;
                this._pos = [ browserWidth / 2 - 100 + scrollX, browserHeight / 2 - 150 + scrollY ];
            }
            this._dialogInput.css("left", this._pos[0] + 20 + "px").css("top", this._pos[1] + "px");
            inst.settings.onSelect = onSelect;
            this._inDialog = true;
            this.dpDiv.addClass(this._dialogClass);
            this._showDatepicker(this._dialogInput[0]);
            if ($.blockUI) {
                $.blockUI(this.dpDiv);
            }
            $.data(this._dialogInput[0], PROP_NAME, inst);
            return this;
        },
        _destroyDatepicker: function(target) {
            var nodeName, $target = $(target), inst = $.data(target, PROP_NAME);
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            $.removeData(target, PROP_NAME);
            if (nodeName === "input") {
                inst.append.remove();
                inst.trigger.remove();
                $target.removeClass(this.markerClassName).unbind("focus", this._showDatepicker).unbind("keydown", this._doKeyDown).unbind("keypress", this._doKeyPress).unbind("keyup", this._doKeyUp);
            } else if (nodeName === "div" || nodeName === "span") {
                $target.removeClass(this.markerClassName).empty();
            }
        },
        _enableDatepicker: function(target) {
            var nodeName, inline, $target = $(target), inst = $.data(target, PROP_NAME);
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            if (nodeName === "input") {
                target.disabled = false;
                inst.trigger.filter("button").each(function() {
                    this.disabled = false;
                }).end().filter("img").css({
                    opacity: "1.0",
                    cursor: ""
                });
            } else if (nodeName === "div" || nodeName === "span") {
                inline = $target.children("." + this._inlineClass);
                inline.children().removeClass("ui-state-disabled");
                inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled", false);
            }
            this._disabledInputs = $.map(this._disabledInputs, function(value) {
                return value === target ? null : value;
            });
        },
        _disableDatepicker: function(target) {
            var nodeName, inline, $target = $(target), inst = $.data(target, PROP_NAME);
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            if (nodeName === "input") {
                target.disabled = true;
                inst.trigger.filter("button").each(function() {
                    this.disabled = true;
                }).end().filter("img").css({
                    opacity: "0.5",
                    cursor: "default"
                });
            } else if (nodeName === "div" || nodeName === "span") {
                inline = $target.children("." + this._inlineClass);
                inline.children().addClass("ui-state-disabled");
                inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled", true);
            }
            this._disabledInputs = $.map(this._disabledInputs, function(value) {
                return value === target ? null : value;
            });
            this._disabledInputs[this._disabledInputs.length] = target;
        },
        _isDisabledDatepicker: function(target) {
            if (!target) {
                return false;
            }
            for (var i = 0; i < this._disabledInputs.length; i++) {
                if (this._disabledInputs[i] === target) {
                    return true;
                }
            }
            return false;
        },
        _getInst: function(target) {
            try {
                return $.data(target, PROP_NAME);
            } catch (err) {
                throw "Missing instance data for this datepicker";
            }
        },
        _optionDatepicker: function(target, name, value) {
            var settings, date, minDate, maxDate, inst = this._getInst(target);
            if (arguments.length === 2 && typeof name === "string") {
                return name === "defaults" ? $.extend({}, $.datepicker._defaults) : inst ? name === "all" ? $.extend({}, inst.settings) : this._get(inst, name) : null;
            }
            settings = name || {};
            if (typeof name === "string") {
                settings = {};
                settings[name] = value;
            }
            if (inst) {
                if (this._curInst === inst) {
                    this._hideDatepicker();
                }
                date = this._getDateDatepicker(target, true);
                minDate = this._getMinMaxDate(inst, "min");
                maxDate = this._getMinMaxDate(inst, "max");
                extendRemove(inst.settings, settings);
                if (minDate !== null && settings.dateFormat !== undefined && settings.minDate === undefined) {
                    inst.settings.minDate = this._formatDate(inst, minDate);
                }
                if (maxDate !== null && settings.dateFormat !== undefined && settings.maxDate === undefined) {
                    inst.settings.maxDate = this._formatDate(inst, maxDate);
                }
                if ("disabled" in settings) {
                    if (settings.disabled) {
                        this._disableDatepicker(target);
                    } else {
                        this._enableDatepicker(target);
                    }
                }
                this._attachments($(target), inst);
                this._autoSize(inst);
                this._setDate(inst, date);
                this._updateAlternate(inst);
                this._updateDatepicker(inst);
            }
        },
        _changeDatepicker: function(target, name, value) {
            this._optionDatepicker(target, name, value);
        },
        _refreshDatepicker: function(target) {
            var inst = this._getInst(target);
            if (inst) {
                this._updateDatepicker(inst);
            }
        },
        _setDateDatepicker: function(target, date) {
            var inst = this._getInst(target);
            if (inst) {
                this._setDate(inst, date);
                this._updateDatepicker(inst);
                this._updateAlternate(inst);
            }
        },
        _getDateDatepicker: function(target, noDefault) {
            var inst = this._getInst(target);
            if (inst && !inst.inline) {
                this._setDateFromField(inst, noDefault);
            }
            return inst ? this._getDate(inst) : null;
        },
        _doKeyDown: function(event) {
            var onSelect, dateStr, sel, inst = $.datepicker._getInst(event.target), handled = true, isRTL = inst.dpDiv.is(".ui-datepicker-rtl");
            inst._keyEvent = true;
            if ($.datepicker._datepickerShowing) {
                switch (event.keyCode) {
                  case 9:
                    $.datepicker._hideDatepicker();
                    handled = false;
                    break;

                  case 13:
                    sel = $("td." + $.datepicker._dayOverClass + ":not(." + $.datepicker._currentClass + ")", inst.dpDiv);
                    if (sel[0]) {
                        $.datepicker._selectDay(event.target, inst.selectedMonth, inst.selectedYear, sel[0]);
                    }
                    onSelect = $.datepicker._get(inst, "onSelect");
                    if (onSelect) {
                        dateStr = $.datepicker._formatDate(inst);
                        onSelect.apply(inst.input ? inst.input[0] : null, [ dateStr, inst ]);
                    } else {
                        $.datepicker._hideDatepicker();
                    }
                    return false;

                  case 27:
                    $.datepicker._hideDatepicker();
                    break;

                  case 33:
                    $.datepicker._adjustDate(event.target, event.ctrlKey ? -$.datepicker._get(inst, "stepBigMonths") : -$.datepicker._get(inst, "stepMonths"), "M");
                    break;

                  case 34:
                    $.datepicker._adjustDate(event.target, event.ctrlKey ? +$.datepicker._get(inst, "stepBigMonths") : +$.datepicker._get(inst, "stepMonths"), "M");
                    break;

                  case 35:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._clearDate(event.target);
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 36:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._gotoToday(event.target);
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 37:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, isRTL ? +1 : -1, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    if (event.originalEvent.altKey) {
                        $.datepicker._adjustDate(event.target, event.ctrlKey ? -$.datepicker._get(inst, "stepBigMonths") : -$.datepicker._get(inst, "stepMonths"), "M");
                    }
                    break;

                  case 38:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, -7, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 39:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, isRTL ? -1 : +1, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    if (event.originalEvent.altKey) {
                        $.datepicker._adjustDate(event.target, event.ctrlKey ? +$.datepicker._get(inst, "stepBigMonths") : +$.datepicker._get(inst, "stepMonths"), "M");
                    }
                    break;

                  case 40:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, +7, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  default:
                    handled = false;
                }
            } else if (event.keyCode === 36 && event.ctrlKey) {
                $.datepicker._showDatepicker(this);
            } else {
                handled = false;
            }
            if (handled) {
                event.preventDefault();
                event.stopPropagation();
            }
        },
        _doKeyPress: function(event) {
            var chars, chr, inst = $.datepicker._getInst(event.target);
            if ($.datepicker._get(inst, "constrainInput")) {
                chars = $.datepicker._possibleChars($.datepicker._get(inst, "dateFormat"));
                chr = String.fromCharCode(event.charCode == null ? event.keyCode : event.charCode);
                return event.ctrlKey || event.metaKey || (chr < " " || !chars || chars.indexOf(chr) > -1);
            }
        },
        _doKeyUp: function(event) {
            var date, inst = $.datepicker._getInst(event.target);
            if (inst.input.val() !== inst.lastVal) {
                try {
                    date = $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"), inst.input ? inst.input.val() : null, $.datepicker._getFormatConfig(inst));
                    if (date) {
                        $.datepicker._setDateFromField(inst);
                        $.datepicker._updateAlternate(inst);
                        $.datepicker._updateDatepicker(inst);
                    }
                } catch (err) {}
            }
            return true;
        },
        _showDatepicker: function(input) {
            input = input.target || input;
            if (input.nodeName.toLowerCase() !== "input") {
                input = $("input", input.parentNode)[0];
            }
            if ($.datepicker._isDisabledDatepicker(input) || $.datepicker._lastInput === input) {
                return;
            }
            var inst, beforeShow, beforeShowSettings, isFixed, offset, showAnim, duration;
            inst = $.datepicker._getInst(input);
            if ($.datepicker._curInst && $.datepicker._curInst !== inst) {
                $.datepicker._curInst.dpDiv.stop(true, true);
                if (inst && $.datepicker._datepickerShowing) {
                    $.datepicker._hideDatepicker($.datepicker._curInst.input[0]);
                }
            }
            beforeShow = $.datepicker._get(inst, "beforeShow");
            beforeShowSettings = beforeShow ? beforeShow.apply(input, [ input, inst ]) : {};
            if (beforeShowSettings === false) {
                return;
            }
            extendRemove(inst.settings, beforeShowSettings);
            inst.lastVal = null;
            $.datepicker._lastInput = input;
            $.datepicker._setDateFromField(inst);
            if ($.datepicker._inDialog) {
                input.value = "";
            }
            if (!$.datepicker._pos) {
                $.datepicker._pos = $.datepicker._findPos(input);
                $.datepicker._pos[1] += input.offsetHeight;
            }
            isFixed = false;
            $(input).parents().each(function() {
                isFixed |= $(this).css("position") === "fixed";
                return !isFixed;
            });
            offset = {
                left: $.datepicker._pos[0],
                top: $.datepicker._pos[1]
            };
            $.datepicker._pos = null;
            inst.dpDiv.empty();
            inst.dpDiv.css({
                position: "absolute",
                display: "block",
                top: "-1000px"
            });
            $.datepicker._updateDatepicker(inst);
            offset = $.datepicker._checkOffset(inst, offset, isFixed);
            inst.dpDiv.css({
                position: $.datepicker._inDialog && $.blockUI ? "static" : isFixed ? "fixed" : "absolute",
                display: "none",
                left: offset.left + "px",
                top: offset.top + "px"
            });
            if (!inst.inline) {
                showAnim = $.datepicker._get(inst, "showAnim");
                duration = $.datepicker._get(inst, "duration");
                inst.dpDiv.zIndex($(input).zIndex() + 1);
                $.datepicker._datepickerShowing = true;
                if ($.effects && $.effects.effect[showAnim]) {
                    inst.dpDiv.show(showAnim, $.datepicker._get(inst, "showOptions"), duration);
                } else {
                    inst.dpDiv[showAnim || "show"](showAnim ? duration : null);
                }
                if ($.datepicker._shouldFocusInput(inst)) {
                    inst.input.focus();
                }
                $.datepicker._curInst = inst;
            }
        },
        _updateDatepicker: function(inst) {
            this.maxRows = 4;
            instActive = inst;
            inst.dpDiv.empty().append(this._generateHTML(inst));
            this._attachHandlers(inst);
            inst.dpDiv.find("." + this._dayOverClass + " a").mouseover();
            var origyearshtml, numMonths = this._getNumberOfMonths(inst), cols = numMonths[1], width = 17;
            inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width("");
            if (cols > 1) {
                inst.dpDiv.addClass("ui-datepicker-multi-" + cols).css("width", width * cols + "em");
            }
            inst.dpDiv[(numMonths[0] !== 1 || numMonths[1] !== 1 ? "add" : "remove") + "Class"]("ui-datepicker-multi");
            inst.dpDiv[(this._get(inst, "isRTL") ? "add" : "remove") + "Class"]("ui-datepicker-rtl");
            if (inst === $.datepicker._curInst && $.datepicker._datepickerShowing && $.datepicker._shouldFocusInput(inst)) {
                inst.input.focus();
            }
            if (inst.yearshtml) {
                origyearshtml = inst.yearshtml;
                setTimeout(function() {
                    if (origyearshtml === inst.yearshtml && inst.yearshtml) {
                        inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml);
                    }
                    origyearshtml = inst.yearshtml = null;
                }, 0);
            }
        },
        _shouldFocusInput: function(inst) {
            return inst.input && inst.input.is(":visible") && !inst.input.is(":disabled") && !inst.input.is(":focus");
        },
        _checkOffset: function(inst, offset, isFixed) {
            var dpWidth = inst.dpDiv.outerWidth(), dpHeight = inst.dpDiv.outerHeight(), inputWidth = inst.input ? inst.input.outerWidth() : 0, inputHeight = inst.input ? inst.input.outerHeight() : 0, viewWidth = document.documentElement.clientWidth + (isFixed ? 0 : $(document).scrollLeft()), viewHeight = document.documentElement.clientHeight + (isFixed ? 0 : $(document).scrollTop());
            offset.left -= this._get(inst, "isRTL") ? dpWidth - inputWidth : 0;
            offset.left -= isFixed && offset.left === inst.input.offset().left ? $(document).scrollLeft() : 0;
            offset.top -= isFixed && offset.top === inst.input.offset().top + inputHeight ? $(document).scrollTop() : 0;
            offset.left -= Math.min(offset.left, offset.left + dpWidth > viewWidth && viewWidth > dpWidth ? Math.abs(offset.left + dpWidth - viewWidth) : 0);
            offset.top -= Math.min(offset.top, offset.top + dpHeight > viewHeight && viewHeight > dpHeight ? Math.abs(dpHeight + inputHeight) : 0);
            return offset;
        },
        _findPos: function(obj) {
            var position, inst = this._getInst(obj), isRTL = this._get(inst, "isRTL");
            while (obj && (obj.type === "hidden" || obj.nodeType !== 1 || $.expr.filters.hidden(obj))) {
                obj = obj[isRTL ? "previousSibling" : "nextSibling"];
            }
            position = $(obj).offset();
            return [ position.left, position.top ];
        },
        _hideDatepicker: function(input) {
            var showAnim, duration, postProcess, onClose, inst = this._curInst;
            if (!inst || input && inst !== $.data(input, PROP_NAME)) {
                return;
            }
            if (this._datepickerShowing) {
                showAnim = this._get(inst, "showAnim");
                duration = this._get(inst, "duration");
                postProcess = function() {
                    $.datepicker._tidyDialog(inst);
                };
                if ($.effects && ($.effects.effect[showAnim] || $.effects[showAnim])) {
                    inst.dpDiv.hide(showAnim, $.datepicker._get(inst, "showOptions"), duration, postProcess);
                } else {
                    inst.dpDiv[showAnim === "slideDown" ? "slideUp" : showAnim === "fadeIn" ? "fadeOut" : "hide"](showAnim ? duration : null, postProcess);
                }
                if (!showAnim) {
                    postProcess();
                }
                this._datepickerShowing = false;
                onClose = this._get(inst, "onClose");
                if (onClose) {
                    onClose.apply(inst.input ? inst.input[0] : null, [ inst.input ? inst.input.val() : "", inst ]);
                }
                this._lastInput = null;
                if (this._inDialog) {
                    this._dialogInput.css({
                        position: "absolute",
                        left: "0",
                        top: "-100px"
                    });
                    if ($.blockUI) {
                        $.unblockUI();
                        $("body").append(this.dpDiv);
                    }
                }
                this._inDialog = false;
            }
        },
        _tidyDialog: function(inst) {
            inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar");
        },
        _checkExternalClick: function(event) {
            if (!$.datepicker._curInst) {
                return;
            }
            var $target = $(event.target), inst = $.datepicker._getInst($target[0]);
            if ($target[0].id !== $.datepicker._mainDivId && $target.parents("#" + $.datepicker._mainDivId).length === 0 && !$target.hasClass($.datepicker.markerClassName) && !$target.closest("." + $.datepicker._triggerClass).length && $.datepicker._datepickerShowing && !($.datepicker._inDialog && $.blockUI) || $target.hasClass($.datepicker.markerClassName) && $.datepicker._curInst !== inst) {
                $.datepicker._hideDatepicker();
            }
        },
        _adjustDate: function(id, offset, period) {
            var target = $(id), inst = this._getInst(target[0]);
            if (this._isDisabledDatepicker(target[0])) {
                return;
            }
            this._adjustInstDate(inst, offset + (period === "M" ? this._get(inst, "showCurrentAtPos") : 0), period);
            this._updateDatepicker(inst);
        },
        _gotoToday: function(id) {
            var date, target = $(id), inst = this._getInst(target[0]);
            if (this._get(inst, "gotoCurrent") && inst.currentDay) {
                inst.selectedDay = inst.currentDay;
                inst.drawMonth = inst.selectedMonth = inst.currentMonth;
                inst.drawYear = inst.selectedYear = inst.currentYear;
            } else {
                date = new Date();
                inst.selectedDay = date.getDate();
                inst.drawMonth = inst.selectedMonth = date.getMonth();
                inst.drawYear = inst.selectedYear = date.getFullYear();
            }
            this._notifyChange(inst);
            this._adjustDate(target);
        },
        _selectMonthYear: function(id, select, period) {
            var target = $(id), inst = this._getInst(target[0]);
            inst["selected" + (period === "M" ? "Month" : "Year")] = inst["draw" + (period === "M" ? "Month" : "Year")] = parseInt(select.options[select.selectedIndex].value, 10);
            this._notifyChange(inst);
            this._adjustDate(target);
        },
        _selectDay: function(id, month, year, td) {
            var inst, target = $(id);
            if ($(td).hasClass(this._unselectableClass) || this._isDisabledDatepicker(target[0])) {
                return;
            }
            inst = this._getInst(target[0]);
            inst.selectedDay = inst.currentDay = $("a", td).html();
            inst.selectedMonth = inst.currentMonth = month;
            inst.selectedYear = inst.currentYear = year;
            this._selectDate(id, this._formatDate(inst, inst.currentDay, inst.currentMonth, inst.currentYear));
        },
        _clearDate: function(id) {
            var target = $(id);
            this._selectDate(target, "");
        },
        _selectDate: function(id, dateStr) {
            var onSelect, target = $(id), inst = this._getInst(target[0]);
            dateStr = dateStr != null ? dateStr : this._formatDate(inst);
            if (inst.input) {
                inst.input.val(dateStr);
            }
            this._updateAlternate(inst);
            onSelect = this._get(inst, "onSelect");
            if (onSelect) {
                onSelect.apply(inst.input ? inst.input[0] : null, [ dateStr, inst ]);
            } else if (inst.input) {
                inst.input.trigger("change");
            }
            if (inst.inline) {
                this._updateDatepicker(inst);
            } else {
                this._hideDatepicker();
                this._lastInput = inst.input[0];
                if (typeof inst.input[0] !== "object") {
                    inst.input.focus();
                }
                this._lastInput = null;
            }
        },
        _updateAlternate: function(inst) {
            var altFormat, date, dateStr, altField = this._get(inst, "altField");
            if (altField) {
                altFormat = this._get(inst, "altFormat") || this._get(inst, "dateFormat");
                date = this._getDate(inst);
                dateStr = this.formatDate(altFormat, date, this._getFormatConfig(inst));
                $(altField).each(function() {
                    $(this).val(dateStr);
                });
            }
        },
        noWeekends: function(date) {
            var day = date.getDay();
            return [ day > 0 && day < 6, "" ];
        },
        iso8601Week: function(date) {
            var time, checkDate = new Date(date.getTime());
            checkDate.setDate(checkDate.getDate() + 4 - (checkDate.getDay() || 7));
            time = checkDate.getTime();
            checkDate.setMonth(0);
            checkDate.setDate(1);
            return Math.floor(Math.round((time - checkDate) / 864e5) / 7) + 1;
        },
        parseDate: function(format, value, settings) {
            if (format == null || value == null) {
                throw "Invalid arguments";
            }
            value = typeof value === "object" ? value.toString() : value + "";
            if (value === "") {
                return null;
            }
            var iFormat, dim, extra, iValue = 0, shortYearCutoffTemp = (settings ? settings.shortYearCutoff : null) || this._defaults.shortYearCutoff, shortYearCutoff = typeof shortYearCutoffTemp !== "string" ? shortYearCutoffTemp : new Date().getFullYear() % 100 + parseInt(shortYearCutoffTemp, 10), dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort, dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames, monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort, monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames, year = -1, month = -1, day = -1, doy = -1, literal = false, date, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            }, getNumber = function(match) {
                var isDoubled = lookAhead(match), size = match === "@" ? 14 : match === "!" ? 20 : match === "y" && isDoubled ? 4 : match === "o" ? 3 : 2, digits = new RegExp("^\\d{1," + size + "}"), num = value.substring(iValue).match(digits);
                if (!num) {
                    throw "Missing number at position " + iValue;
                }
                iValue += num[0].length;
                return parseInt(num[0], 10);
            }, getName = function(match, shortNames, longNames) {
                var index = -1, names = $.map(lookAhead(match) ? longNames : shortNames, function(v, k) {
                    return [ [ k, v ] ];
                }).sort(function(a, b) {
                    return -(a[1].length - b[1].length);
                });
                $.each(names, function(i, pair) {
                    var name = pair[1];
                    if (value.substr(iValue, name.length).toLowerCase() === name.toLowerCase()) {
                        index = pair[0];
                        iValue += name.length;
                        return false;
                    }
                });
                if (index !== -1) {
                    return index + 1;
                } else {
                    throw "Unknown name at position " + iValue;
                }
            }, checkLiteral = function() {
                if (value.charAt(iValue) !== format.charAt(iFormat)) {
                    throw "Unexpected literal at position " + iValue;
                }
                iValue++;
            };
            for (iFormat = 0; iFormat < format.length; iFormat++) {
                if (literal) {
                    if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                        literal = false;
                    } else {
                        checkLiteral();
                    }
                } else {
                    switch (format.charAt(iFormat)) {
                      case "d":
                        day = getNumber("d");
                        break;

                      case "D":
                        getName("D", dayNamesShort, dayNames);
                        break;

                      case "o":
                        doy = getNumber("o");
                        break;

                      case "m":
                        month = getNumber("m");
                        break;

                      case "M":
                        month = getName("M", monthNamesShort, monthNames);
                        break;

                      case "y":
                        year = getNumber("y");
                        break;

                      case "@":
                        date = new Date(getNumber("@"));
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        day = date.getDate();
                        break;

                      case "!":
                        date = new Date((getNumber("!") - this._ticksTo1970) / 1e4);
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        day = date.getDate();
                        break;

                      case "'":
                        if (lookAhead("'")) {
                            checkLiteral();
                        } else {
                            literal = true;
                        }
                        break;

                      default:
                        checkLiteral();
                    }
                }
            }
            if (iValue < value.length) {
                extra = value.substr(iValue);
                if (!/^\s+/.test(extra)) {
                    throw "Extra/unparsed characters found in date: " + extra;
                }
            }
            if (year === -1) {
                year = new Date().getFullYear();
            } else if (year < 100) {
                year += new Date().getFullYear() - new Date().getFullYear() % 100 + (year <= shortYearCutoff ? 0 : -100);
            }
            if (doy > -1) {
                month = 1;
                day = doy;
                do {
                    dim = this._getDaysInMonth(year, month - 1);
                    if (day <= dim) {
                        break;
                    }
                    month++;
                    day -= dim;
                } while (true);
            }
            date = this._daylightSavingAdjust(new Date(year, month - 1, day));
            if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                throw "Invalid date";
            }
            return date;
        },
        ATOM: "yy-mm-dd",
        COOKIE: "D, dd M yy",
        ISO_8601: "yy-mm-dd",
        RFC_822: "D, d M y",
        RFC_850: "DD, dd-M-y",
        RFC_1036: "D, d M y",
        RFC_1123: "D, d M yy",
        RFC_2822: "D, d M yy",
        RSS: "D, d M y",
        TICKS: "!",
        TIMESTAMP: "@",
        W3C: "yy-mm-dd",
        _ticksTo1970: ((1970 - 1) * 365 + Math.floor(1970 / 4) - Math.floor(1970 / 100) + Math.floor(1970 / 400)) * 24 * 60 * 60 * 1e7,
        formatDate: function(format, date, settings) {
            if (!date) {
                return "";
            }
            var iFormat, dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort, dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames, monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort, monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            }, formatNumber = function(match, value, len) {
                var num = "" + value;
                if (lookAhead(match)) {
                    while (num.length < len) {
                        num = "0" + num;
                    }
                }
                return num;
            }, formatName = function(match, value, shortNames, longNames) {
                return lookAhead(match) ? longNames[value] : shortNames[value];
            }, output = "", literal = false;
            if (date) {
                for (iFormat = 0; iFormat < format.length; iFormat++) {
                    if (literal) {
                        if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                            literal = false;
                        } else {
                            output += format.charAt(iFormat);
                        }
                    } else {
                        switch (format.charAt(iFormat)) {
                          case "d":
                            output += formatNumber("d", date.getDate(), 2);
                            break;

                          case "D":
                            output += formatName("D", date.getDay(), dayNamesShort, dayNames);
                            break;

                          case "o":
                            output += formatNumber("o", Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 864e5), 3);
                            break;

                          case "m":
                            output += formatNumber("m", date.getMonth() + 1, 2);
                            break;

                          case "M":
                            output += formatName("M", date.getMonth(), monthNamesShort, monthNames);
                            break;

                          case "y":
                            output += lookAhead("y") ? date.getFullYear() : (date.getYear() % 100 < 10 ? "0" : "") + date.getYear() % 100;
                            break;

                          case "@":
                            output += date.getTime();
                            break;

                          case "!":
                            output += date.getTime() * 1e4 + this._ticksTo1970;
                            break;

                          case "'":
                            if (lookAhead("'")) {
                                output += "'";
                            } else {
                                literal = true;
                            }
                            break;

                          default:
                            output += format.charAt(iFormat);
                        }
                    }
                }
            }
            return output;
        },
        _possibleChars: function(format) {
            var iFormat, chars = "", literal = false, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            };
            for (iFormat = 0; iFormat < format.length; iFormat++) {
                if (literal) {
                    if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                        literal = false;
                    } else {
                        chars += format.charAt(iFormat);
                    }
                } else {
                    switch (format.charAt(iFormat)) {
                      case "d":
                      case "m":
                      case "y":
                      case "@":
                        chars += "0123456789";
                        break;

                      case "D":
                      case "M":
                        return null;

                      case "'":
                        if (lookAhead("'")) {
                            chars += "'";
                        } else {
                            literal = true;
                        }
                        break;

                      default:
                        chars += format.charAt(iFormat);
                    }
                }
            }
            return chars;
        },
        _get: function(inst, name) {
            return inst.settings[name] !== undefined ? inst.settings[name] : this._defaults[name];
        },
        _setDateFromField: function(inst, noDefault) {
            if (inst.input.val() === inst.lastVal) {
                return;
            }
            var dateFormat = this._get(inst, "dateFormat"), dates = inst.lastVal = inst.input ? inst.input.val() : null, defaultDate = this._getDefaultDate(inst), date = defaultDate, settings = this._getFormatConfig(inst);
            try {
                date = this.parseDate(dateFormat, dates, settings) || defaultDate;
            } catch (event) {
                dates = noDefault ? "" : dates;
            }
            inst.selectedDay = date.getDate();
            inst.drawMonth = inst.selectedMonth = date.getMonth();
            inst.drawYear = inst.selectedYear = date.getFullYear();
            inst.currentDay = dates ? date.getDate() : 0;
            inst.currentMonth = dates ? date.getMonth() : 0;
            inst.currentYear = dates ? date.getFullYear() : 0;
            this._adjustInstDate(inst);
        },
        _getDefaultDate: function(inst) {
            return this._restrictMinMax(inst, this._determineDate(inst, this._get(inst, "defaultDate"), new Date()));
        },
        _determineDate: function(inst, date, defaultDate) {
            var offsetNumeric = function(offset) {
                var date = new Date();
                date.setDate(date.getDate() + offset);
                return date;
            }, offsetString = function(offset) {
                try {
                    return $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"), offset, $.datepicker._getFormatConfig(inst));
                } catch (e) {}
                var date = (offset.toLowerCase().match(/^c/) ? $.datepicker._getDate(inst) : null) || new Date(), year = date.getFullYear(), month = date.getMonth(), day = date.getDate(), pattern = /([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g, matches = pattern.exec(offset);
                while (matches) {
                    switch (matches[2] || "d") {
                      case "d":
                      case "D":
                        day += parseInt(matches[1], 10);
                        break;

                      case "w":
                      case "W":
                        day += parseInt(matches[1], 10) * 7;
                        break;

                      case "m":
                      case "M":
                        month += parseInt(matches[1], 10);
                        day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
                        break;

                      case "y":
                      case "Y":
                        year += parseInt(matches[1], 10);
                        day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
                        break;
                    }
                    matches = pattern.exec(offset);
                }
                return new Date(year, month, day);
            }, newDate = date == null || date === "" ? defaultDate : typeof date === "string" ? offsetString(date) : typeof date === "number" ? isNaN(date) ? defaultDate : offsetNumeric(date) : new Date(date.getTime());
            newDate = newDate && newDate.toString() === "Invalid Date" ? defaultDate : newDate;
            if (newDate) {
                newDate.setHours(0);
                newDate.setMinutes(0);
                newDate.setSeconds(0);
                newDate.setMilliseconds(0);
            }
            return this._daylightSavingAdjust(newDate);
        },
        _daylightSavingAdjust: function(date) {
            if (!date) {
                return null;
            }
            date.setHours(date.getHours() > 12 ? date.getHours() + 2 : 0);
            return date;
        },
        _setDate: function(inst, date, noChange) {
            var clear = !date, origMonth = inst.selectedMonth, origYear = inst.selectedYear, newDate = this._restrictMinMax(inst, this._determineDate(inst, date, new Date()));
            inst.selectedDay = inst.currentDay = newDate.getDate();
            inst.drawMonth = inst.selectedMonth = inst.currentMonth = newDate.getMonth();
            inst.drawYear = inst.selectedYear = inst.currentYear = newDate.getFullYear();
            if ((origMonth !== inst.selectedMonth || origYear !== inst.selectedYear) && !noChange) {
                this._notifyChange(inst);
            }
            this._adjustInstDate(inst);
            if (inst.input) {
                inst.input.val(clear ? "" : this._formatDate(inst));
            }
        },
        _getDate: function(inst) {
            var startDate = !inst.currentYear || inst.input && inst.input.val() === "" ? null : this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay));
            return startDate;
        },
        _attachHandlers: function(inst) {
            var stepMonths = this._get(inst, "stepMonths"), id = "#" + inst.id.replace(/\\\\/g, "\\");
            inst.dpDiv.find("[data-handler]").map(function() {
                var handler = {
                    prev: function() {
                        $.datepicker._adjustDate(id, -stepMonths, "M");
                    },
                    next: function() {
                        $.datepicker._adjustDate(id, +stepMonths, "M");
                    },
                    hide: function() {
                        $.datepicker._hideDatepicker();
                    },
                    today: function() {
                        $.datepicker._gotoToday(id);
                    },
                    selectDay: function() {
                        $.datepicker._selectDay(id, +this.getAttribute("data-month"), +this.getAttribute("data-year"), this);
                        return false;
                    },
                    selectMonth: function() {
                        $.datepicker._selectMonthYear(id, this, "M");
                        return false;
                    },
                    selectYear: function() {
                        $.datepicker._selectMonthYear(id, this, "Y");
                        return false;
                    }
                };
                $(this).bind(this.getAttribute("data-event"), handler[this.getAttribute("data-handler")]);
            });
        },
        _generateHTML: function(inst) {
            var maxDraw, prevText, prev, nextText, next, currentText, gotoDate, controls, buttonPanel, firstDay, showWeek, dayNames, dayNamesMin, monthNames, monthNamesShort, beforeShowDay, showOtherMonths, selectOtherMonths, defaultDate, html, dow, row, group, col, selectedDate, cornerClass, calender, thead, day, daysInMonth, leadDays, curRows, numRows, printDate, dRow, tbody, daySettings, otherMonth, unselectable, tempDate = new Date(), today = this._daylightSavingAdjust(new Date(tempDate.getFullYear(), tempDate.getMonth(), tempDate.getDate())), isRTL = this._get(inst, "isRTL"), showButtonPanel = this._get(inst, "showButtonPanel"), hideIfNoPrevNext = this._get(inst, "hideIfNoPrevNext"), navigationAsDateFormat = this._get(inst, "navigationAsDateFormat"), numMonths = this._getNumberOfMonths(inst), showCurrentAtPos = this._get(inst, "showCurrentAtPos"), stepMonths = this._get(inst, "stepMonths"), isMultiMonth = numMonths[0] !== 1 || numMonths[1] !== 1, currentDate = this._daylightSavingAdjust(!inst.currentDay ? new Date(9999, 9, 9) : new Date(inst.currentYear, inst.currentMonth, inst.currentDay)), minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), drawMonth = inst.drawMonth - showCurrentAtPos, drawYear = inst.drawYear;
            if (drawMonth < 0) {
                drawMonth += 12;
                drawYear--;
            }
            if (maxDate) {
                maxDraw = this._daylightSavingAdjust(new Date(maxDate.getFullYear(), maxDate.getMonth() - numMonths[0] * numMonths[1] + 1, maxDate.getDate()));
                maxDraw = minDate && maxDraw < minDate ? minDate : maxDraw;
                while (this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1)) > maxDraw) {
                    drawMonth--;
                    if (drawMonth < 0) {
                        drawMonth = 11;
                        drawYear--;
                    }
                }
            }
            inst.drawMonth = drawMonth;
            inst.drawYear = drawYear;
            prevText = this._get(inst, "prevText");
            prevText = !navigationAsDateFormat ? prevText : this.formatDate(prevText, this._daylightSavingAdjust(new Date(drawYear, drawMonth - stepMonths, 1)), this._getFormatConfig(inst));
            prev = this._canAdjustMonth(inst, -1, drawYear, drawMonth) ? "<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click'" + " title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "e" : "w") + "'>" + prevText + "</span></a>" : hideIfNoPrevNext ? "" : "<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "e" : "w") + "'>" + prevText + "</span></a>";
            nextText = this._get(inst, "nextText");
            nextText = !navigationAsDateFormat ? nextText : this.formatDate(nextText, this._daylightSavingAdjust(new Date(drawYear, drawMonth + stepMonths, 1)), this._getFormatConfig(inst));
            next = this._canAdjustMonth(inst, +1, drawYear, drawMonth) ? "<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click'" + " title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "w" : "e") + "'>" + nextText + "</span></a>" : hideIfNoPrevNext ? "" : "<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "w" : "e") + "'>" + nextText + "</span></a>";
            currentText = this._get(inst, "currentText");
            gotoDate = this._get(inst, "gotoCurrent") && inst.currentDay ? currentDate : today;
            currentText = !navigationAsDateFormat ? currentText : this.formatDate(currentText, gotoDate, this._getFormatConfig(inst));
            controls = !inst.inline ? "<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>" + this._get(inst, "closeText") + "</button>" : "";
            buttonPanel = showButtonPanel ? "<div class='ui-datepicker-buttonpane ui-widget-content'>" + (isRTL ? controls : "") + (this._isInRange(inst, gotoDate) ? "<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'" + ">" + currentText + "</button>" : "") + (isRTL ? "" : controls) + "</div>" : "";
            firstDay = parseInt(this._get(inst, "firstDay"), 10);
            firstDay = isNaN(firstDay) ? 0 : firstDay;
            showWeek = this._get(inst, "showWeek");
            dayNames = this._get(inst, "dayNames");
            dayNamesMin = this._get(inst, "dayNamesMin");
            monthNames = this._get(inst, "monthNames");
            monthNamesShort = this._get(inst, "monthNamesShort");
            beforeShowDay = this._get(inst, "beforeShowDay");
            showOtherMonths = this._get(inst, "showOtherMonths");
            selectOtherMonths = this._get(inst, "selectOtherMonths");
            defaultDate = this._getDefaultDate(inst);
            html = "";
            dow;
            for (row = 0; row < numMonths[0]; row++) {
                group = "";
                this.maxRows = 4;
                for (col = 0; col < numMonths[1]; col++) {
                    selectedDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, inst.selectedDay));
                    cornerClass = " ui-corner-all";
                    calender = "";
                    if (isMultiMonth) {
                        calender += "<div class='ui-datepicker-group";
                        if (numMonths[1] > 1) {
                            switch (col) {
                              case 0:
                                calender += " ui-datepicker-group-first";
                                cornerClass = " ui-corner-" + (isRTL ? "right" : "left");
                                break;

                              case numMonths[1] - 1:
                                calender += " ui-datepicker-group-last";
                                cornerClass = " ui-corner-" + (isRTL ? "left" : "right");
                                break;

                              default:
                                calender += " ui-datepicker-group-middle";
                                cornerClass = "";
                                break;
                            }
                        }
                        calender += "'>";
                    }
                    calender += "<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix" + cornerClass + "'>" + (/all|left/.test(cornerClass) && row === 0 ? isRTL ? next : prev : "") + (/all|right/.test(cornerClass) && row === 0 ? isRTL ? prev : next : "") + this._generateMonthYearHeader(inst, drawMonth, drawYear, minDate, maxDate, row > 0 || col > 0, monthNames, monthNamesShort) + "</div><table class='ui-datepicker-calendar'><thead>" + "<tr>";
                    thead = showWeek ? "<th class='ui-datepicker-week-col'>" + this._get(inst, "weekHeader") + "</th>" : "";
                    for (dow = 0; dow < 7; dow++) {
                        day = (dow + firstDay) % 7;
                        thead += "<th" + ((dow + firstDay + 6) % 7 >= 5 ? " class='ui-datepicker-week-end'" : "") + ">" + "<span title='" + dayNames[day] + "'>" + dayNamesMin[day] + "</span></th>";
                    }
                    calender += thead + "</tr></thead><tbody>";
                    daysInMonth = this._getDaysInMonth(drawYear, drawMonth);
                    if (drawYear === inst.selectedYear && drawMonth === inst.selectedMonth) {
                        inst.selectedDay = Math.min(inst.selectedDay, daysInMonth);
                    }
                    leadDays = (this._getFirstDayOfMonth(drawYear, drawMonth) - firstDay + 7) % 7;
                    curRows = Math.ceil((leadDays + daysInMonth) / 7);
                    numRows = isMultiMonth ? this.maxRows > curRows ? this.maxRows : curRows : curRows;
                    this.maxRows = numRows;
                    printDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1 - leadDays));
                    for (dRow = 0; dRow < numRows; dRow++) {
                        calender += "<tr>";
                        tbody = !showWeek ? "" : "<td class='ui-datepicker-week-col'>" + this._get(inst, "calculateWeek")(printDate) + "</td>";
                        for (dow = 0; dow < 7; dow++) {
                            daySettings = beforeShowDay ? beforeShowDay.apply(inst.input ? inst.input[0] : null, [ printDate ]) : [ true, "" ];
                            otherMonth = printDate.getMonth() !== drawMonth;
                            unselectable = otherMonth && !selectOtherMonths || !daySettings[0] || minDate && printDate < minDate || maxDate && printDate > maxDate;
                            tbody += "<td class='" + ((dow + firstDay + 6) % 7 >= 5 ? " ui-datepicker-week-end" : "") + (otherMonth ? " ui-datepicker-other-month" : "") + (printDate.getTime() === selectedDate.getTime() && drawMonth === inst.selectedMonth && inst._keyEvent || defaultDate.getTime() === printDate.getTime() && defaultDate.getTime() === selectedDate.getTime() ? " " + this._dayOverClass : "") + (unselectable ? " " + this._unselectableClass + " ui-state-disabled" : "") + (otherMonth && !showOtherMonths ? "" : " " + daySettings[1] + (printDate.getTime() === currentDate.getTime() ? " " + this._currentClass : "") + (printDate.getTime() === today.getTime() ? " ui-datepicker-today" : "")) + "'" + ((!otherMonth || showOtherMonths) && daySettings[2] ? " title='" + daySettings[2].replace(/'/g, "&#39;") + "'" : "") + (unselectable ? "" : " data-handler='selectDay' data-event='click' data-month='" + printDate.getMonth() + "' data-year='" + printDate.getFullYear() + "'") + ">" + (otherMonth && !showOtherMonths ? "&#xa0;" : unselectable ? "<span class='ui-state-default'>" + printDate.getDate() + "</span>" : "<a class='ui-state-default" + (printDate.getTime() === today.getTime() ? " ui-state-highlight" : "") + (printDate.getTime() === currentDate.getTime() ? " ui-state-active" : "") + (otherMonth ? " ui-priority-secondary" : "") + "' href='#'>" + printDate.getDate() + "</a>") + "</td>";
                            printDate.setDate(printDate.getDate() + 1);
                            printDate = this._daylightSavingAdjust(printDate);
                        }
                        calender += tbody + "</tr>";
                    }
                    drawMonth++;
                    if (drawMonth > 11) {
                        drawMonth = 0;
                        drawYear++;
                    }
                    calender += "</tbody></table>" + (isMultiMonth ? "</div>" + (numMonths[0] > 0 && col === numMonths[1] - 1 ? "<div class='ui-datepicker-row-break'></div>" : "") : "");
                    group += calender;
                }
                html += group;
            }
            html += buttonPanel;
            inst._keyEvent = false;
            return html;
        },
        _generateMonthYearHeader: function(inst, drawMonth, drawYear, minDate, maxDate, secondary, monthNames, monthNamesShort) {
            var inMinYear, inMaxYear, month, years, thisYear, determineYear, year, endYear, changeMonth = this._get(inst, "changeMonth"), changeYear = this._get(inst, "changeYear"), showMonthAfterYear = this._get(inst, "showMonthAfterYear"), html = "<div class='ui-datepicker-title'>", monthHtml = "";
            if (secondary || !changeMonth) {
                monthHtml += "<span class='ui-datepicker-month'>" + monthNames[drawMonth] + "</span>";
            } else {
                inMinYear = minDate && minDate.getFullYear() === drawYear;
                inMaxYear = maxDate && maxDate.getFullYear() === drawYear;
                monthHtml += "<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>";
                for (month = 0; month < 12; month++) {
                    if ((!inMinYear || month >= minDate.getMonth()) && (!inMaxYear || month <= maxDate.getMonth())) {
                        monthHtml += "<option value='" + month + "'" + (month === drawMonth ? " selected='selected'" : "") + ">" + monthNamesShort[month] + "</option>";
                    }
                }
                monthHtml += "</select>";
            }
            if (!showMonthAfterYear) {
                html += monthHtml + (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "");
            }
            if (!inst.yearshtml) {
                inst.yearshtml = "";
                if (secondary || !changeYear) {
                    html += "<span class='ui-datepicker-year'>" + drawYear + "</span>";
                } else {
                    years = this._get(inst, "yearRange").split(":");
                    thisYear = new Date().getFullYear();
                    determineYear = function(value) {
                        var year = value.match(/c[+\-].*/) ? drawYear + parseInt(value.substring(1), 10) : value.match(/[+\-].*/) ? thisYear + parseInt(value, 10) : parseInt(value, 10);
                        return isNaN(year) ? thisYear : year;
                    };
                    year = determineYear(years[0]);
                    endYear = Math.max(year, determineYear(years[1] || ""));
                    year = minDate ? Math.max(year, minDate.getFullYear()) : year;
                    endYear = maxDate ? Math.min(endYear, maxDate.getFullYear()) : endYear;
                    inst.yearshtml += "<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";
                    for (;year <= endYear; year++) {
                        inst.yearshtml += "<option value='" + year + "'" + (year === drawYear ? " selected='selected'" : "") + ">" + year + "</option>";
                    }
                    inst.yearshtml += "</select>";
                    html += inst.yearshtml;
                    inst.yearshtml = null;
                }
            }
            html += this._get(inst, "yearSuffix");
            if (showMonthAfterYear) {
                html += (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "") + monthHtml;
            }
            html += "</div>";
            return html;
        },
        _adjustInstDate: function(inst, offset, period) {
            var year = inst.drawYear + (period === "Y" ? offset : 0), month = inst.drawMonth + (period === "M" ? offset : 0), day = Math.min(inst.selectedDay, this._getDaysInMonth(year, month)) + (period === "D" ? offset : 0), date = this._restrictMinMax(inst, this._daylightSavingAdjust(new Date(year, month, day)));
            inst.selectedDay = date.getDate();
            inst.drawMonth = inst.selectedMonth = date.getMonth();
            inst.drawYear = inst.selectedYear = date.getFullYear();
            if (period === "M" || period === "Y") {
                this._notifyChange(inst);
            }
        },
        _restrictMinMax: function(inst, date) {
            var minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), newDate = minDate && date < minDate ? minDate : date;
            return maxDate && newDate > maxDate ? maxDate : newDate;
        },
        _notifyChange: function(inst) {
            var onChange = this._get(inst, "onChangeMonthYear");
            if (onChange) {
                onChange.apply(inst.input ? inst.input[0] : null, [ inst.selectedYear, inst.selectedMonth + 1, inst ]);
            }
        },
        _getNumberOfMonths: function(inst) {
            var numMonths = this._get(inst, "numberOfMonths");
            return numMonths == null ? [ 1, 1 ] : typeof numMonths === "number" ? [ 1, numMonths ] : numMonths;
        },
        _getMinMaxDate: function(inst, minMax) {
            return this._determineDate(inst, this._get(inst, minMax + "Date"), null);
        },
        _getDaysInMonth: function(year, month) {
            return 32 - this._daylightSavingAdjust(new Date(year, month, 32)).getDate();
        },
        _getFirstDayOfMonth: function(year, month) {
            return new Date(year, month, 1).getDay();
        },
        _canAdjustMonth: function(inst, offset, curYear, curMonth) {
            var numMonths = this._getNumberOfMonths(inst), date = this._daylightSavingAdjust(new Date(curYear, curMonth + (offset < 0 ? offset : numMonths[0] * numMonths[1]), 1));
            if (offset < 0) {
                date.setDate(this._getDaysInMonth(date.getFullYear(), date.getMonth()));
            }
            return this._isInRange(inst, date);
        },
        _isInRange: function(inst, date) {
            var yearSplit, currentYear, minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), minYear = null, maxYear = null, years = this._get(inst, "yearRange");
            if (years) {
                yearSplit = years.split(":");
                currentYear = new Date().getFullYear();
                minYear = parseInt(yearSplit[0], 10);
                maxYear = parseInt(yearSplit[1], 10);
                if (yearSplit[0].match(/[+\-].*/)) {
                    minYear += currentYear;
                }
                if (yearSplit[1].match(/[+\-].*/)) {
                    maxYear += currentYear;
                }
            }
            return (!minDate || date.getTime() >= minDate.getTime()) && (!maxDate || date.getTime() <= maxDate.getTime()) && (!minYear || date.getFullYear() >= minYear) && (!maxYear || date.getFullYear() <= maxYear);
        },
        _getFormatConfig: function(inst) {
            var shortYearCutoff = this._get(inst, "shortYearCutoff");
            shortYearCutoff = typeof shortYearCutoff !== "string" ? shortYearCutoff : new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10);
            return {
                shortYearCutoff: shortYearCutoff,
                dayNamesShort: this._get(inst, "dayNamesShort"),
                dayNames: this._get(inst, "dayNames"),
                monthNamesShort: this._get(inst, "monthNamesShort"),
                monthNames: this._get(inst, "monthNames")
            };
        },
        _formatDate: function(inst, day, month, year) {
            if (!day) {
                inst.currentDay = inst.selectedDay;
                inst.currentMonth = inst.selectedMonth;
                inst.currentYear = inst.selectedYear;
            }
            var date = day ? typeof day === "object" ? day : this._daylightSavingAdjust(new Date(year, month, day)) : this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay));
            return this.formatDate(this._get(inst, "dateFormat"), date, this._getFormatConfig(inst));
        }
    });
    function bindHover(dpDiv) {
        var selector = "button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";
        return dpDiv.delegate(selector, "mouseout", function() {
            $(this).removeClass("ui-state-hover");
            if (this.className.indexOf("ui-datepicker-prev") !== -1) {
                $(this).removeClass("ui-datepicker-prev-hover");
            }
            if (this.className.indexOf("ui-datepicker-next") !== -1) {
                $(this).removeClass("ui-datepicker-next-hover");
            }
        }).delegate(selector, "mouseover", function() {
            if (!$.datepicker._isDisabledDatepicker(instActive.inline ? dpDiv.parent()[0] : instActive.input[0])) {
                $(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover");
                $(this).addClass("ui-state-hover");
                if (this.className.indexOf("ui-datepicker-prev") !== -1) {
                    $(this).addClass("ui-datepicker-prev-hover");
                }
                if (this.className.indexOf("ui-datepicker-next") !== -1) {
                    $(this).addClass("ui-datepicker-next-hover");
                }
            }
        });
    }
    function extendRemove(target, props) {
        $.extend(target, props);
        for (var name in props) {
            if (props[name] == null) {
                target[name] = props[name];
            }
        }
        return target;
    }
    $.fn.datepicker = function(options) {
        if (!this.length) {
            return this;
        }
        if (!$.datepicker.initialized) {
            $(document).mousedown($.datepicker._checkExternalClick);
            $.datepicker.initialized = true;
        }
        if ($("#" + $.datepicker._mainDivId).length === 0) {
            $("body").append($.datepicker.dpDiv);
        }
        var otherArgs = Array.prototype.slice.call(arguments, 1);
        if (typeof options === "string" && (options === "isDisabled" || options === "getDate" || options === "widget")) {
            return $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this[0] ].concat(otherArgs));
        }
        if (options === "option" && arguments.length === 2 && typeof arguments[1] === "string") {
            return $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this[0] ].concat(otherArgs));
        }
        return this.each(function() {
            typeof options === "string" ? $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this ].concat(otherArgs)) : $.datepicker._attachDatepicker(this, options);
        });
    };
    $.datepicker = new Datepicker();
    $.datepicker.initialized = false;
    $.datepicker.uuid = new Date().getTime();
    $.datepicker.version = "1.10.4";
})(jQuery);

$.extend($.easing, {
    easeInQuint: function(x, t, b, c, d) {
        return c * (t = t / d) * t * t * t * t + b;
    },
    easeOutQuint: function(x, t, b, c, d) {
        return c * ((t = t / d - 1) * t * t * t * t + 1) + b;
    },
    easeInOutQuint: function(x, t, b, c, d) {
        if ((t /= d / 2) < 1) return c / 2 * t * t * t * t * t + b;
        return c / 2 * ((t -= 2) * t * t * t * t + 2) + b;
    }
});

(function(factory) {
    if (typeof define === "function" && define.amd) {
        define([ "jquery" ], factory);
    } else {
        factory(jQuery);
    }
})(function($) {
    $.ui = $.ui || {};
    $.extend($.ui, {
        version: "1.11.4",
        keyCode: {
            BACKSPACE: 8,
            COMMA: 188,
            DELETE: 46,
            DOWN: 40,
            END: 35,
            ENTER: 13,
            ESCAPE: 27,
            HOME: 36,
            LEFT: 37,
            PAGE_DOWN: 34,
            PAGE_UP: 33,
            PERIOD: 190,
            RIGHT: 39,
            SPACE: 32,
            TAB: 9,
            UP: 38
        }
    });
    $.fn.extend({
        scrollParent: function(includeHidden) {
            var position = this.css("position"), excludeStaticParent = position === "absolute", overflowRegex = includeHidden ? /(auto|scroll|hidden)/ : /(auto|scroll)/, scrollParent = this.parents().filter(function() {
                var parent = $(this);
                if (excludeStaticParent && parent.css("position") === "static") {
                    return false;
                }
                return overflowRegex.test(parent.css("overflow") + parent.css("overflow-y") + parent.css("overflow-x"));
            }).eq(0);
            return position === "fixed" || !scrollParent.length ? $(this[0].ownerDocument || document) : scrollParent;
        },
        uniqueId: function() {
            var uuid = 0;
            return function() {
                return this.each(function() {
                    if (!this.id) {
                        this.id = "ui-id-" + ++uuid;
                    }
                });
            };
        }(),
        removeUniqueId: function() {
            return this.each(function() {
                if (/^ui-id-\d+$/.test(this.id)) {
                    $(this).removeAttr("id");
                }
            });
        }
    });
    function focusable(element, isTabIndexNotNaN) {
        var map, mapName, img, nodeName = element.nodeName.toLowerCase();
        if ("area" === nodeName) {
            map = element.parentNode;
            mapName = map.name;
            if (!element.href || !mapName || map.nodeName.toLowerCase() !== "map") {
                return false;
            }
            img = $("img[usemap='#" + mapName + "']")[0];
            return !!img && visible(img);
        }
        return (/^(input|select|textarea|button|object)$/.test(nodeName) ? !element.disabled : "a" === nodeName ? element.href || isTabIndexNotNaN : isTabIndexNotNaN) && visible(element);
    }
    function visible(element) {
        return $.expr.filters.visible(element) && !$(element).parents().addBack().filter(function() {
            return $.css(this, "visibility") === "hidden";
        }).length;
    }
    $.extend($.expr[":"], {
        data: $.expr.createPseudo ? $.expr.createPseudo(function(dataName) {
            return function(elem) {
                return !!$.data(elem, dataName);
            };
        }) : function(elem, i, match) {
            return !!$.data(elem, match[3]);
        },
        focusable: function(element) {
            return focusable(element, !isNaN($.attr(element, "tabindex")));
        },
        tabbable: function(element) {
            var tabIndex = $.attr(element, "tabindex"), isTabIndexNaN = isNaN(tabIndex);
            return (isTabIndexNaN || tabIndex >= 0) && focusable(element, !isTabIndexNaN);
        }
    });
    if (!$("<a>").outerWidth(1).jquery) {
        $.each([ "Width", "Height" ], function(i, name) {
            var side = name === "Width" ? [ "Left", "Right" ] : [ "Top", "Bottom" ], type = name.toLowerCase(), orig = {
                innerWidth: $.fn.innerWidth,
                innerHeight: $.fn.innerHeight,
                outerWidth: $.fn.outerWidth,
                outerHeight: $.fn.outerHeight
            };
            function reduce(elem, size, border, margin) {
                $.each(side, function() {
                    size -= parseFloat($.css(elem, "padding" + this)) || 0;
                    if (border) {
                        size -= parseFloat($.css(elem, "border" + this + "Width")) || 0;
                    }
                    if (margin) {
                        size -= parseFloat($.css(elem, "margin" + this)) || 0;
                    }
                });
                return size;
            }
            $.fn["inner" + name] = function(size) {
                if (size === undefined) {
                    return orig["inner" + name].call(this);
                }
                return this.each(function() {
                    $(this).css(type, reduce(this, size) + "px");
                });
            };
            $.fn["outer" + name] = function(size, margin) {
                if (typeof size !== "number") {
                    return orig["outer" + name].call(this, size);
                }
                return this.each(function() {
                    $(this).css(type, reduce(this, size, true, margin) + "px");
                });
            };
        });
    }
    if (!$.fn.addBack) {
        $.fn.addBack = function(selector) {
            return this.add(selector == null ? this.prevObject : this.prevObject.filter(selector));
        };
    }
    if ($("<a>").data("a-b", "a").removeData("a-b").data("a-b")) {
        $.fn.removeData = function(removeData) {
            return function(key) {
                if (arguments.length) {
                    return removeData.call(this, $.camelCase(key));
                } else {
                    return removeData.call(this);
                }
            };
        }($.fn.removeData);
    }
    $.ui.ie = !!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());
    $.fn.extend({
        focus: function(orig) {
            return function(delay, fn) {
                return typeof delay === "number" ? this.each(function() {
                    var elem = this;
                    setTimeout(function() {
                        $(elem).focus();
                        if (fn) {
                            fn.call(elem);
                        }
                    }, delay);
                }) : orig.apply(this, arguments);
            };
        }($.fn.focus),
        disableSelection: function() {
            var eventType = "onselectstart" in document.createElement("div") ? "selectstart" : "mousedown";
            return function() {
                return this.bind(eventType + ".ui-disableSelection", function(event) {
                    event.preventDefault();
                });
            };
        }(),
        enableSelection: function() {
            return this.unbind(".ui-disableSelection");
        },
        zIndex: function(zIndex) {
            if (zIndex !== undefined) {
                return this.css("zIndex", zIndex);
            }
            if (this.length) {
                var elem = $(this[0]), position, value;
                while (elem.length && elem[0] !== document) {
                    position = elem.css("position");
                    if (position === "absolute" || position === "relative" || position === "fixed") {
                        value = parseInt(elem.css("zIndex"), 10);
                        if (!isNaN(value) && value !== 0) {
                            return value;
                        }
                    }
                    elem = elem.parent();
                }
            }
            return 0;
        }
    });
    $.ui.plugin = {
        add: function(module, option, set) {
            var i, proto = $.ui[module].prototype;
            for (i in set) {
                proto.plugins[i] = proto.plugins[i] || [];
                proto.plugins[i].push([ option, set[i] ]);
            }
        },
        call: function(instance, name, args, allowDisconnected) {
            var i, set = instance.plugins[name];
            if (!set) {
                return;
            }
            if (!allowDisconnected && (!instance.element[0].parentNode || instance.element[0].parentNode.nodeType === 11)) {
                return;
            }
            for (i = 0; i < set.length; i++) {
                if (instance.options[set[i][0]]) {
                    set[i][1].apply(instance.element, args);
                }
            }
        }
    };
    var widget_uuid = 0, widget_slice = Array.prototype.slice;
    $.cleanData = function(orig) {
        return function(elems) {
            var events, elem, i;
            for (i = 0; (elem = elems[i]) != null; i++) {
                try {
                    events = $._data(elem, "events");
                    if (events && events.remove) {
                        $(elem).triggerHandler("remove");
                    }
                } catch (e) {}
            }
            orig(elems);
        };
    }($.cleanData);
    $.widget = function(name, base, prototype) {
        var fullName, existingConstructor, constructor, basePrototype, proxiedPrototype = {}, namespace = name.split(".")[0];
        name = name.split(".")[1];
        fullName = namespace + "-" + name;
        if (!prototype) {
            prototype = base;
            base = $.Widget;
        }
        $.expr[":"][fullName.toLowerCase()] = function(elem) {
            return !!$.data(elem, fullName);
        };
        $[namespace] = $[namespace] || {};
        existingConstructor = $[namespace][name];
        constructor = $[namespace][name] = function(options, element) {
            if (!this._createWidget) {
                return new constructor(options, element);
            }
            if (arguments.length) {
                this._createWidget(options, element);
            }
        };
        $.extend(constructor, existingConstructor, {
            version: prototype.version,
            _proto: $.extend({}, prototype),
            _childConstructors: []
        });
        basePrototype = new base();
        basePrototype.options = $.widget.extend({}, basePrototype.options);
        $.each(prototype, function(prop, value) {
            if (!$.isFunction(value)) {
                proxiedPrototype[prop] = value;
                return;
            }
            proxiedPrototype[prop] = function() {
                var _super = function() {
                    return base.prototype[prop].apply(this, arguments);
                }, _superApply = function(args) {
                    return base.prototype[prop].apply(this, args);
                };
                return function() {
                    var __super = this._super, __superApply = this._superApply, returnValue;
                    this._super = _super;
                    this._superApply = _superApply;
                    returnValue = value.apply(this, arguments);
                    this._super = __super;
                    this._superApply = __superApply;
                    return returnValue;
                };
            }();
        });
        constructor.prototype = $.widget.extend(basePrototype, {
            widgetEventPrefix: existingConstructor ? basePrototype.widgetEventPrefix || name : name
        }, proxiedPrototype, {
            constructor: constructor,
            namespace: namespace,
            widgetName: name,
            widgetFullName: fullName
        });
        if (existingConstructor) {
            $.each(existingConstructor._childConstructors, function(i, child) {
                var childPrototype = child.prototype;
                $.widget(childPrototype.namespace + "." + childPrototype.widgetName, constructor, child._proto);
            });
            delete existingConstructor._childConstructors;
        } else {
            base._childConstructors.push(constructor);
        }
        $.widget.bridge(name, constructor);
        return constructor;
    };
    $.widget.extend = function(target) {
        var input = widget_slice.call(arguments, 1), inputIndex = 0, inputLength = input.length, key, value;
        for (;inputIndex < inputLength; inputIndex++) {
            for (key in input[inputIndex]) {
                value = input[inputIndex][key];
                if (input[inputIndex].hasOwnProperty(key) && value !== undefined) {
                    if ($.isPlainObject(value)) {
                        target[key] = $.isPlainObject(target[key]) ? $.widget.extend({}, target[key], value) : $.widget.extend({}, value);
                    } else {
                        target[key] = value;
                    }
                }
            }
        }
        return target;
    };
    $.widget.bridge = function(name, object) {
        var fullName = object.prototype.widgetFullName || name;
        $.fn[name] = function(options) {
            var isMethodCall = typeof options === "string", args = widget_slice.call(arguments, 1), returnValue = this;
            if (isMethodCall) {
                this.each(function() {
                    var methodValue, instance = $.data(this, fullName);
                    if (options === "instance") {
                        returnValue = instance;
                        return false;
                    }
                    if (!instance) {
                        return $.error("cannot call methods on " + name + " prior to initialization; " + "attempted to call method '" + options + "'");
                    }
                    if (!$.isFunction(instance[options]) || options.charAt(0) === "_") {
                        return $.error("no such method '" + options + "' for " + name + " widget instance");
                    }
                    methodValue = instance[options].apply(instance, args);
                    if (methodValue !== instance && methodValue !== undefined) {
                        returnValue = methodValue && methodValue.jquery ? returnValue.pushStack(methodValue.get()) : methodValue;
                        return false;
                    }
                });
            } else {
                if (args.length) {
                    options = $.widget.extend.apply(null, [ options ].concat(args));
                }
                this.each(function() {
                    var instance = $.data(this, fullName);
                    if (instance) {
                        instance.option(options || {});
                        if (instance._init) {
                            instance._init();
                        }
                    } else {
                        $.data(this, fullName, new object(options, this));
                    }
                });
            }
            return returnValue;
        };
    };
    $.Widget = function() {};
    $.Widget._childConstructors = [];
    $.Widget.prototype = {
        widgetName: "widget",
        widgetEventPrefix: "",
        defaultElement: "<div>",
        options: {
            disabled: false,
            create: null
        },
        _createWidget: function(options, element) {
            element = $(element || this.defaultElement || this)[0];
            this.element = $(element);
            this.uuid = widget_uuid++;
            this.eventNamespace = "." + this.widgetName + this.uuid;
            this.bindings = $();
            this.hoverable = $();
            this.focusable = $();
            if (element !== this) {
                $.data(element, this.widgetFullName, this);
                this._on(true, this.element, {
                    remove: function(event) {
                        if (event.target === element) {
                            this.destroy();
                        }
                    }
                });
                this.document = $(element.style ? element.ownerDocument : element.document || element);
                this.window = $(this.document[0].defaultView || this.document[0].parentWindow);
            }
            this.options = $.widget.extend({}, this.options, this._getCreateOptions(), options);
            this._create();
            this._trigger("create", null, this._getCreateEventData());
            this._init();
        },
        _getCreateOptions: $.noop,
        _getCreateEventData: $.noop,
        _create: $.noop,
        _init: $.noop,
        destroy: function() {
            this._destroy();
            this.element.unbind(this.eventNamespace).removeData(this.widgetFullName).removeData($.camelCase(this.widgetFullName));
            this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName + "-disabled " + "ui-state-disabled");
            this.bindings.unbind(this.eventNamespace);
            this.hoverable.removeClass("ui-state-hover");
            this.focusable.removeClass("ui-state-focus");
        },
        _destroy: $.noop,
        widget: function() {
            return this.element;
        },
        option: function(key, value) {
            var options = key, parts, curOption, i;
            if (arguments.length === 0) {
                return $.widget.extend({}, this.options);
            }
            if (typeof key === "string") {
                options = {};
                parts = key.split(".");
                key = parts.shift();
                if (parts.length) {
                    curOption = options[key] = $.widget.extend({}, this.options[key]);
                    for (i = 0; i < parts.length - 1; i++) {
                        curOption[parts[i]] = curOption[parts[i]] || {};
                        curOption = curOption[parts[i]];
                    }
                    key = parts.pop();
                    if (arguments.length === 1) {
                        return curOption[key] === undefined ? null : curOption[key];
                    }
                    curOption[key] = value;
                } else {
                    if (arguments.length === 1) {
                        return this.options[key] === undefined ? null : this.options[key];
                    }
                    options[key] = value;
                }
            }
            this._setOptions(options);
            return this;
        },
        _setOptions: function(options) {
            var key;
            for (key in options) {
                this._setOption(key, options[key]);
            }
            return this;
        },
        _setOption: function(key, value) {
            this.options[key] = value;
            if (key === "disabled") {
                this.widget().toggleClass(this.widgetFullName + "-disabled", !!value);
                if (value) {
                    this.hoverable.removeClass("ui-state-hover");
                    this.focusable.removeClass("ui-state-focus");
                }
            }
            return this;
        },
        enable: function() {
            return this._setOptions({
                disabled: false
            });
        },
        disable: function() {
            return this._setOptions({
                disabled: true
            });
        },
        _on: function(suppressDisabledCheck, element, handlers) {
            var delegateElement, instance = this;
            if (typeof suppressDisabledCheck !== "boolean") {
                handlers = element;
                element = suppressDisabledCheck;
                suppressDisabledCheck = false;
            }
            if (!handlers) {
                handlers = element;
                element = this.element;
                delegateElement = this.widget();
            } else {
                element = delegateElement = $(element);
                this.bindings = this.bindings.add(element);
            }
            $.each(handlers, function(event, handler) {
                function handlerProxy() {
                    if (!suppressDisabledCheck && (instance.options.disabled === true || $(this).hasClass("ui-state-disabled"))) {
                        return;
                    }
                    return (typeof handler === "string" ? instance[handler] : handler).apply(instance, arguments);
                }
                if (typeof handler !== "string") {
                    handlerProxy.guid = handler.guid = handler.guid || handlerProxy.guid || $.guid++;
                }
                var match = event.match(/^([\w:-]*)\s*(.*)$/), eventName = match[1] + instance.eventNamespace, selector = match[2];
                if (selector) {
                    delegateElement.delegate(selector, eventName, handlerProxy);
                } else {
                    element.bind(eventName, handlerProxy);
                }
            });
        },
        _off: function(element, eventName) {
            eventName = (eventName || "").split(" ").join(this.eventNamespace + " ") + this.eventNamespace;
            element.unbind(eventName).undelegate(eventName);
            this.bindings = $(this.bindings.not(element).get());
            this.focusable = $(this.focusable.not(element).get());
            this.hoverable = $(this.hoverable.not(element).get());
        },
        _delay: function(handler, delay) {
            function handlerProxy() {
                return (typeof handler === "string" ? instance[handler] : handler).apply(instance, arguments);
            }
            var instance = this;
            return setTimeout(handlerProxy, delay || 0);
        },
        _hoverable: function(element) {
            this.hoverable = this.hoverable.add(element);
            this._on(element, {
                mouseenter: function(event) {
                    $(event.currentTarget).addClass("ui-state-hover");
                },
                mouseleave: function(event) {
                    $(event.currentTarget).removeClass("ui-state-hover");
                }
            });
        },
        _focusable: function(element) {
            this.focusable = this.focusable.add(element);
            this._on(element, {
                focusin: function(event) {
                    $(event.currentTarget).addClass("ui-state-focus");
                },
                focusout: function(event) {
                    $(event.currentTarget).removeClass("ui-state-focus");
                }
            });
        },
        _trigger: function(type, event, data) {
            var prop, orig, callback = this.options[type];
            data = data || {};
            event = $.Event(event);
            event.type = (type === this.widgetEventPrefix ? type : this.widgetEventPrefix + type).toLowerCase();
            event.target = this.element[0];
            orig = event.originalEvent;
            if (orig) {
                for (prop in orig) {
                    if (!(prop in event)) {
                        event[prop] = orig[prop];
                    }
                }
            }
            this.element.trigger(event, data);
            return !($.isFunction(callback) && callback.apply(this.element[0], [ event ].concat(data)) === false || event.isDefaultPrevented());
        }
    };
    $.each({
        show: "fadeIn",
        hide: "fadeOut"
    }, function(method, defaultEffect) {
        $.Widget.prototype["_" + method] = function(element, options, callback) {
            if (typeof options === "string") {
                options = {
                    effect: options
                };
            }
            var hasOptions, effectName = !options ? method : options === true || typeof options === "number" ? defaultEffect : options.effect || defaultEffect;
            options = options || {};
            if (typeof options === "number") {
                options = {
                    duration: options
                };
            }
            hasOptions = !$.isEmptyObject(options);
            options.complete = callback;
            if (options.delay) {
                element.delay(options.delay);
            }
            if (hasOptions && $.effects && $.effects.effect[effectName]) {
                element[method](options);
            } else if (effectName !== method && element[effectName]) {
                element[effectName](options.duration, options.easing, callback);
            } else {
                element.queue(function(next) {
                    $(this)[method]();
                    if (callback) {
                        callback.call(element[0]);
                    }
                    next();
                });
            }
        };
    });
    var widget = $.widget;
    var mouseHandled = false;
    $(document).mouseup(function() {
        mouseHandled = false;
    });
    var mouse = $.widget("ui.mouse", {
        version: "1.11.4",
        options: {
            cancel: "input,textarea,button,select,option",
            distance: 1,
            delay: 0
        },
        _mouseInit: function() {
            var that = this;
            this.element.bind("mousedown." + this.widgetName, function(event) {
                return that._mouseDown(event);
            }).bind("click." + this.widgetName, function(event) {
                if (true === $.data(event.target, that.widgetName + ".preventClickEvent")) {
                    $.removeData(event.target, that.widgetName + ".preventClickEvent");
                    event.stopImmediatePropagation();
                    return false;
                }
            });
            this.started = false;
        },
        _mouseDestroy: function() {
            this.element.unbind("." + this.widgetName);
            if (this._mouseMoveDelegate) {
                this.document.unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
            }
        },
        _mouseDown: function(event) {
            if (mouseHandled) {
                return;
            }
            this._mouseMoved = false;
            this._mouseStarted && this._mouseUp(event);
            this._mouseDownEvent = event;
            var that = this, btnIsLeft = event.which === 1, elIsCancel = typeof this.options.cancel === "string" && event.target.nodeName ? $(event.target).closest(this.options.cancel).length : false;
            if (!btnIsLeft || elIsCancel || !this._mouseCapture(event)) {
                return true;
            }
            this.mouseDelayMet = !this.options.delay;
            if (!this.mouseDelayMet) {
                this._mouseDelayTimer = setTimeout(function() {
                    that.mouseDelayMet = true;
                }, this.options.delay);
            }
            if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
                this._mouseStarted = this._mouseStart(event) !== false;
                if (!this._mouseStarted) {
                    event.preventDefault();
                    return true;
                }
            }
            if (true === $.data(event.target, this.widgetName + ".preventClickEvent")) {
                $.removeData(event.target, this.widgetName + ".preventClickEvent");
            }
            this._mouseMoveDelegate = function(event) {
                return that._mouseMove(event);
            };
            this._mouseUpDelegate = function(event) {
                return that._mouseUp(event);
            };
            this.document.bind("mousemove." + this.widgetName, this._mouseMoveDelegate).bind("mouseup." + this.widgetName, this._mouseUpDelegate);
            event.preventDefault();
            mouseHandled = true;
            return true;
        },
        _mouseMove: function(event) {
            if (this._mouseMoved) {
                if ($.ui.ie && (!document.documentMode || document.documentMode < 9) && !event.button) {
                    return this._mouseUp(event);
                } else if (!event.which) {
                    return this._mouseUp(event);
                }
            }
            if (event.which || event.button) {
                this._mouseMoved = true;
            }
            if (this._mouseStarted) {
                this._mouseDrag(event);
                return event.preventDefault();
            }
            if (this._mouseDistanceMet(event) && this._mouseDelayMet(event)) {
                this._mouseStarted = this._mouseStart(this._mouseDownEvent, event) !== false;
                this._mouseStarted ? this._mouseDrag(event) : this._mouseUp(event);
            }
            return !this._mouseStarted;
        },
        _mouseUp: function(event) {
            this.document.unbind("mousemove." + this.widgetName, this._mouseMoveDelegate).unbind("mouseup." + this.widgetName, this._mouseUpDelegate);
            if (this._mouseStarted) {
                this._mouseStarted = false;
                if (event.target === this._mouseDownEvent.target) {
                    $.data(event.target, this.widgetName + ".preventClickEvent", true);
                }
                this._mouseStop(event);
            }
            mouseHandled = false;
            return false;
        },
        _mouseDistanceMet: function(event) {
            return Math.max(Math.abs(this._mouseDownEvent.pageX - event.pageX), Math.abs(this._mouseDownEvent.pageY - event.pageY)) >= this.options.distance;
        },
        _mouseDelayMet: function() {
            return this.mouseDelayMet;
        },
        _mouseStart: function() {},
        _mouseDrag: function() {},
        _mouseStop: function() {},
        _mouseCapture: function() {
            return true;
        }
    });
    (function() {
        $.ui = $.ui || {};
        var cachedScrollbarWidth, supportsOffsetFractions, max = Math.max, abs = Math.abs, round = Math.round, rhorizontal = /left|center|right/, rvertical = /top|center|bottom/, roffset = /[\+\-]\d+(\.[\d]+)?%?/, rposition = /^\w+/, rpercent = /%$/, _position = $.fn.position;
        function getOffsets(offsets, width, height) {
            return [ parseFloat(offsets[0]) * (rpercent.test(offsets[0]) ? width / 100 : 1), parseFloat(offsets[1]) * (rpercent.test(offsets[1]) ? height / 100 : 1) ];
        }
        function parseCss(element, property) {
            return parseInt($.css(element, property), 10) || 0;
        }
        function getDimensions(elem) {
            var raw = elem[0];
            if (raw.nodeType === 9) {
                return {
                    width: elem.width(),
                    height: elem.height(),
                    offset: {
                        top: 0,
                        left: 0
                    }
                };
            }
            if ($.isWindow(raw)) {
                return {
                    width: elem.width(),
                    height: elem.height(),
                    offset: {
                        top: elem.scrollTop(),
                        left: elem.scrollLeft()
                    }
                };
            }
            if (raw.preventDefault) {
                return {
                    width: 0,
                    height: 0,
                    offset: {
                        top: raw.pageY,
                        left: raw.pageX
                    }
                };
            }
            return {
                width: elem.outerWidth(),
                height: elem.outerHeight(),
                offset: elem.offset()
            };
        }
        $.position = {
            scrollbarWidth: function() {
                if (cachedScrollbarWidth !== undefined) {
                    return cachedScrollbarWidth;
                }
                var w1, w2, div = $("<div style='display:block;position:absolute;width:50px;height:50px;overflow:hidden;'><div style='height:100px;width:auto;'></div></div>"), innerDiv = div.children()[0];
                $("body").append(div);
                w1 = innerDiv.offsetWidth;
                div.css("overflow", "scroll");
                w2 = innerDiv.offsetWidth;
                if (w1 === w2) {
                    w2 = div[0].clientWidth;
                }
                div.remove();
                return cachedScrollbarWidth = w1 - w2;
            },
            getScrollInfo: function(within) {
                var overflowX = within.isWindow || within.isDocument ? "" : within.element.css("overflow-x"), overflowY = within.isWindow || within.isDocument ? "" : within.element.css("overflow-y"), hasOverflowX = overflowX === "scroll" || overflowX === "auto" && within.width < within.element[0].scrollWidth, hasOverflowY = overflowY === "scroll" || overflowY === "auto" && within.height < within.element[0].scrollHeight;
                return {
                    width: hasOverflowY ? $.position.scrollbarWidth() : 0,
                    height: hasOverflowX ? $.position.scrollbarWidth() : 0
                };
            },
            getWithinInfo: function(element) {
                var withinElement = $(element || window), isWindow = $.isWindow(withinElement[0]), isDocument = !!withinElement[0] && withinElement[0].nodeType === 9;
                return {
                    element: withinElement,
                    isWindow: isWindow,
                    isDocument: isDocument,
                    offset: withinElement.offset() || {
                        left: 0,
                        top: 0
                    },
                    scrollLeft: withinElement.scrollLeft(),
                    scrollTop: withinElement.scrollTop(),
                    width: isWindow || isDocument ? withinElement.width() : withinElement.outerWidth(),
                    height: isWindow || isDocument ? withinElement.height() : withinElement.outerHeight()
                };
            }
        };
        $.fn.position = function(options) {
            if (!options || !options.of) {
                return _position.apply(this, arguments);
            }
            options = $.extend({}, options);
            var atOffset, targetWidth, targetHeight, targetOffset, basePosition, dimensions, target = $(options.of), within = $.position.getWithinInfo(options.within), scrollInfo = $.position.getScrollInfo(within), collision = (options.collision || "flip").split(" "), offsets = {};
            dimensions = getDimensions(target);
            if (target[0].preventDefault) {
                options.at = "left top";
            }
            targetWidth = dimensions.width;
            targetHeight = dimensions.height;
            targetOffset = dimensions.offset;
            basePosition = $.extend({}, targetOffset);
            $.each([ "my", "at" ], function() {
                var pos = (options[this] || "").split(" "), horizontalOffset, verticalOffset;
                if (pos.length === 1) {
                    pos = rhorizontal.test(pos[0]) ? pos.concat([ "center" ]) : rvertical.test(pos[0]) ? [ "center" ].concat(pos) : [ "center", "center" ];
                }
                pos[0] = rhorizontal.test(pos[0]) ? pos[0] : "center";
                pos[1] = rvertical.test(pos[1]) ? pos[1] : "center";
                horizontalOffset = roffset.exec(pos[0]);
                verticalOffset = roffset.exec(pos[1]);
                offsets[this] = [ horizontalOffset ? horizontalOffset[0] : 0, verticalOffset ? verticalOffset[0] : 0 ];
                options[this] = [ rposition.exec(pos[0])[0], rposition.exec(pos[1])[0] ];
            });
            if (collision.length === 1) {
                collision[1] = collision[0];
            }
            if (options.at[0] === "right") {
                basePosition.left += targetWidth;
            } else if (options.at[0] === "center") {
                basePosition.left += targetWidth / 2;
            }
            if (options.at[1] === "bottom") {
                basePosition.top += targetHeight;
            } else if (options.at[1] === "center") {
                basePosition.top += targetHeight / 2;
            }
            atOffset = getOffsets(offsets.at, targetWidth, targetHeight);
            basePosition.left += atOffset[0];
            basePosition.top += atOffset[1];
            return this.each(function() {
                var collisionPosition, using, elem = $(this), elemWidth = elem.outerWidth(), elemHeight = elem.outerHeight(), marginLeft = parseCss(this, "marginLeft"), marginTop = parseCss(this, "marginTop"), collisionWidth = elemWidth + marginLeft + parseCss(this, "marginRight") + scrollInfo.width, collisionHeight = elemHeight + marginTop + parseCss(this, "marginBottom") + scrollInfo.height, position = $.extend({}, basePosition), myOffset = getOffsets(offsets.my, elem.outerWidth(), elem.outerHeight());
                if (options.my[0] === "right") {
                    position.left -= elemWidth;
                } else if (options.my[0] === "center") {
                    position.left -= elemWidth / 2;
                }
                if (options.my[1] === "bottom") {
                    position.top -= elemHeight;
                } else if (options.my[1] === "center") {
                    position.top -= elemHeight / 2;
                }
                position.left += myOffset[0];
                position.top += myOffset[1];
                if (!supportsOffsetFractions) {
                    position.left = round(position.left);
                    position.top = round(position.top);
                }
                collisionPosition = {
                    marginLeft: marginLeft,
                    marginTop: marginTop
                };
                $.each([ "left", "top" ], function(i, dir) {
                    if ($.ui.position[collision[i]]) {
                        $.ui.position[collision[i]][dir](position, {
                            targetWidth: targetWidth,
                            targetHeight: targetHeight,
                            elemWidth: elemWidth,
                            elemHeight: elemHeight,
                            collisionPosition: collisionPosition,
                            collisionWidth: collisionWidth,
                            collisionHeight: collisionHeight,
                            offset: [ atOffset[0] + myOffset[0], atOffset[1] + myOffset[1] ],
                            my: options.my,
                            at: options.at,
                            within: within,
                            elem: elem
                        });
                    }
                });
                if (options.using) {
                    using = function(props) {
                        var left = targetOffset.left - position.left, right = left + targetWidth - elemWidth, top = targetOffset.top - position.top, bottom = top + targetHeight - elemHeight, feedback = {
                            target: {
                                element: target,
                                left: targetOffset.left,
                                top: targetOffset.top,
                                width: targetWidth,
                                height: targetHeight
                            },
                            element: {
                                element: elem,
                                left: position.left,
                                top: position.top,
                                width: elemWidth,
                                height: elemHeight
                            },
                            horizontal: right < 0 ? "left" : left > 0 ? "right" : "center",
                            vertical: bottom < 0 ? "top" : top > 0 ? "bottom" : "middle"
                        };
                        if (targetWidth < elemWidth && abs(left + right) < targetWidth) {
                            feedback.horizontal = "center";
                        }
                        if (targetHeight < elemHeight && abs(top + bottom) < targetHeight) {
                            feedback.vertical = "middle";
                        }
                        if (max(abs(left), abs(right)) > max(abs(top), abs(bottom))) {
                            feedback.important = "horizontal";
                        } else {
                            feedback.important = "vertical";
                        }
                        options.using.call(this, props, feedback);
                    };
                }
                elem.offset($.extend(position, {
                    using: using
                }));
            });
        };
        $.ui.position = {
            fit: {
                left: function(position, data) {
                    var within = data.within, withinOffset = within.isWindow ? within.scrollLeft : within.offset.left, outerWidth = within.width, collisionPosLeft = position.left - data.collisionPosition.marginLeft, overLeft = withinOffset - collisionPosLeft, overRight = collisionPosLeft + data.collisionWidth - outerWidth - withinOffset, newOverRight;
                    if (data.collisionWidth > outerWidth) {
                        if (overLeft > 0 && overRight <= 0) {
                            newOverRight = position.left + overLeft + data.collisionWidth - outerWidth - withinOffset;
                            position.left += overLeft - newOverRight;
                        } else if (overRight > 0 && overLeft <= 0) {
                            position.left = withinOffset;
                        } else {
                            if (overLeft > overRight) {
                                position.left = withinOffset + outerWidth - data.collisionWidth;
                            } else {
                                position.left = withinOffset;
                            }
                        }
                    } else if (overLeft > 0) {
                        position.left += overLeft;
                    } else if (overRight > 0) {
                        position.left -= overRight;
                    } else {
                        position.left = max(position.left - collisionPosLeft, position.left);
                    }
                },
                top: function(position, data) {
                    var within = data.within, withinOffset = within.isWindow ? within.scrollTop : within.offset.top, outerHeight = data.within.height, collisionPosTop = position.top - data.collisionPosition.marginTop, overTop = withinOffset - collisionPosTop, overBottom = collisionPosTop + data.collisionHeight - outerHeight - withinOffset, newOverBottom;
                    if (data.collisionHeight > outerHeight) {
                        if (overTop > 0 && overBottom <= 0) {
                            newOverBottom = position.top + overTop + data.collisionHeight - outerHeight - withinOffset;
                            position.top += overTop - newOverBottom;
                        } else if (overBottom > 0 && overTop <= 0) {
                            position.top = withinOffset;
                        } else {
                            if (overTop > overBottom) {
                                position.top = withinOffset + outerHeight - data.collisionHeight;
                            } else {
                                position.top = withinOffset;
                            }
                        }
                    } else if (overTop > 0) {
                        position.top += overTop;
                    } else if (overBottom > 0) {
                        position.top -= overBottom;
                    } else {
                        position.top = max(position.top - collisionPosTop, position.top);
                    }
                }
            },
            flip: {
                left: function(position, data) {
                    var within = data.within, withinOffset = within.offset.left + within.scrollLeft, outerWidth = within.width, offsetLeft = within.isWindow ? within.scrollLeft : within.offset.left, collisionPosLeft = position.left - data.collisionPosition.marginLeft, overLeft = collisionPosLeft - offsetLeft, overRight = collisionPosLeft + data.collisionWidth - outerWidth - offsetLeft, myOffset = data.my[0] === "left" ? -data.elemWidth : data.my[0] === "right" ? data.elemWidth : 0, atOffset = data.at[0] === "left" ? data.targetWidth : data.at[0] === "right" ? -data.targetWidth : 0, offset = -2 * data.offset[0], newOverRight, newOverLeft;
                    if (overLeft < 0) {
                        newOverRight = position.left + myOffset + atOffset + offset + data.collisionWidth - outerWidth - withinOffset;
                        if (newOverRight < 0 || newOverRight < abs(overLeft)) {
                            position.left += myOffset + atOffset + offset;
                        }
                    } else if (overRight > 0) {
                        newOverLeft = position.left - data.collisionPosition.marginLeft + myOffset + atOffset + offset - offsetLeft;
                        if (newOverLeft > 0 || abs(newOverLeft) < overRight) {
                            position.left += myOffset + atOffset + offset;
                        }
                    }
                },
                top: function(position, data) {
                    var within = data.within, withinOffset = within.offset.top + within.scrollTop, outerHeight = within.height, offsetTop = within.isWindow ? within.scrollTop : within.offset.top, collisionPosTop = position.top - data.collisionPosition.marginTop, overTop = collisionPosTop - offsetTop, overBottom = collisionPosTop + data.collisionHeight - outerHeight - offsetTop, top = data.my[1] === "top", myOffset = top ? -data.elemHeight : data.my[1] === "bottom" ? data.elemHeight : 0, atOffset = data.at[1] === "top" ? data.targetHeight : data.at[1] === "bottom" ? -data.targetHeight : 0, offset = -2 * data.offset[1], newOverTop, newOverBottom;
                    if (overTop < 0) {
                        newOverBottom = position.top + myOffset + atOffset + offset + data.collisionHeight - outerHeight - withinOffset;
                        if (newOverBottom < 0 || newOverBottom < abs(overTop)) {
                            position.top += myOffset + atOffset + offset;
                        }
                    } else if (overBottom > 0) {
                        newOverTop = position.top - data.collisionPosition.marginTop + myOffset + atOffset + offset - offsetTop;
                        if (newOverTop > 0 || abs(newOverTop) < overBottom) {
                            position.top += myOffset + atOffset + offset;
                        }
                    }
                }
            },
            flipfit: {
                left: function() {
                    $.ui.position.flip.left.apply(this, arguments);
                    $.ui.position.fit.left.apply(this, arguments);
                },
                top: function() {
                    $.ui.position.flip.top.apply(this, arguments);
                    $.ui.position.fit.top.apply(this, arguments);
                }
            }
        };
        (function() {
            var testElement, testElementParent, testElementStyle, offsetLeft, i, body = document.getElementsByTagName("body")[0], div = document.createElement("div");
            testElement = document.createElement(body ? "div" : "body");
            testElementStyle = {
                visibility: "hidden",
                width: 0,
                height: 0,
                border: 0,
                margin: 0,
                background: "none"
            };
            if (body) {
                $.extend(testElementStyle, {
                    position: "absolute",
                    left: "-1000px",
                    top: "-1000px"
                });
            }
            for (i in testElementStyle) {
                testElement.style[i] = testElementStyle[i];
            }
            testElement.appendChild(div);
            testElementParent = body || document.documentElement;
            testElementParent.insertBefore(testElement, testElementParent.firstChild);
            div.style.cssText = "position: absolute; left: 10.7432222px;";
            offsetLeft = $(div).offset().left;
            supportsOffsetFractions = offsetLeft > 10 && offsetLeft < 11;
            testElement.innerHTML = "";
            testElementParent.removeChild(testElement);
        })();
    })();
    var position = $.ui.position;
    var accordion = $.widget("ui.accordion", {
        version: "1.11.4",
        options: {
            active: 0,
            animate: {},
            collapsible: false,
            event: "click",
            header: "> li > :first-child,> :not(li):even",
            heightStyle: "auto",
            icons: {
                activeHeader: "ui-icon-triangle-1-s",
                header: "ui-icon-triangle-1-e"
            },
            activate: null,
            beforeActivate: null
        },
        hideProps: {
            borderTopWidth: "hide",
            borderBottomWidth: "hide",
            paddingTop: "hide",
            paddingBottom: "hide",
            height: "hide"
        },
        showProps: {
            borderTopWidth: "show",
            borderBottomWidth: "show",
            paddingTop: "show",
            paddingBottom: "show",
            height: "show"
        },
        _create: function() {
            var options = this.options;
            this.prevShow = this.prevHide = $();
            this.element.addClass("ui-accordion ui-widget ui-helper-reset").attr("role", "tablist");
            if (!options.collapsible && (options.active === false || options.active == null)) {
                options.active = 0;
            }
            this._processPanels();
            if (options.active < 0) {
                options.active += this.headers.length;
            }
            this._refresh();
        },
        _getCreateEventData: function() {
            return {
                header: this.active,
                panel: !this.active.length ? $() : this.active.next()
            };
        },
        _createIcons: function() {
            var icons = this.options.icons;
            if (icons) {
                $("<span>").addClass("ui-accordion-header-icon ui-icon " + icons.header).prependTo(this.headers);
                this.active.children(".ui-accordion-header-icon").removeClass(icons.header).addClass(icons.activeHeader);
                this.headers.addClass("ui-accordion-icons");
            }
        },
        _destroyIcons: function() {
            this.headers.removeClass("ui-accordion-icons").children(".ui-accordion-header-icon").remove();
        },
        _destroy: function() {
            var contents;
            this.element.removeClass("ui-accordion ui-widget ui-helper-reset").removeAttr("role");
            this.headers.removeClass("ui-accordion-header ui-accordion-header-active ui-state-default " + "ui-corner-all ui-state-active ui-state-disabled ui-corner-top").removeAttr("role").removeAttr("aria-expanded").removeAttr("aria-selected").removeAttr("aria-controls").removeAttr("tabIndex").removeUniqueId();
            this._destroyIcons();
            contents = this.headers.next().removeClass("ui-helper-reset ui-widget-content ui-corner-bottom " + "ui-accordion-content ui-accordion-content-active ui-state-disabled").css("display", "").removeAttr("role").removeAttr("aria-hidden").removeAttr("aria-labelledby").removeUniqueId();
            if (this.options.heightStyle !== "content") {
                contents.css("height", "");
            }
        },
        _setOption: function(key, value) {
            if (key === "active") {
                this._activate(value);
                return;
            }
            if (key === "event") {
                if (this.options.event) {
                    this._off(this.headers, this.options.event);
                }
                this._setupEvents(value);
            }
            this._super(key, value);
            if (key === "collapsible" && !value && this.options.active === false) {
                this._activate(0);
            }
            if (key === "icons") {
                this._destroyIcons();
                if (value) {
                    this._createIcons();
                }
            }
            if (key === "disabled") {
                this.element.toggleClass("ui-state-disabled", !!value).attr("aria-disabled", value);
                this.headers.add(this.headers.next()).toggleClass("ui-state-disabled", !!value);
            }
        },
        _keydown: function(event) {
            if (event.altKey || event.ctrlKey) {
                return;
            }
            var keyCode = $.ui.keyCode, length = this.headers.length, currentIndex = this.headers.index(event.target), toFocus = false;
            switch (event.keyCode) {
              case keyCode.RIGHT:
              case keyCode.DOWN:
                toFocus = this.headers[(currentIndex + 1) % length];
                break;

              case keyCode.LEFT:
              case keyCode.UP:
                toFocus = this.headers[(currentIndex - 1 + length) % length];
                break;

              case keyCode.SPACE:
              case keyCode.ENTER:
                this._eventHandler(event);
                break;

              case keyCode.HOME:
                toFocus = this.headers[0];
                break;

              case keyCode.END:
                toFocus = this.headers[length - 1];
                break;
            }
            if (toFocus) {
                $(event.target).attr("tabIndex", -1);
                $(toFocus).attr("tabIndex", 0);
                toFocus.focus();
                event.preventDefault();
            }
        },
        _panelKeyDown: function(event) {
            if (event.keyCode === $.ui.keyCode.UP && event.ctrlKey) {
                $(event.currentTarget).prev().focus();
            }
        },
        refresh: function() {
            var options = this.options;
            this._processPanels();
            if (options.active === false && options.collapsible === true || !this.headers.length) {
                options.active = false;
                this.active = $();
            } else if (options.active === false) {
                this._activate(0);
            } else if (this.active.length && !$.contains(this.element[0], this.active[0])) {
                if (this.headers.length === this.headers.find(".ui-state-disabled").length) {
                    options.active = false;
                    this.active = $();
                } else {
                    this._activate(Math.max(0, options.active - 1));
                }
            } else {
                options.active = this.headers.index(this.active);
            }
            this._destroyIcons();
            this._refresh();
        },
        _processPanels: function() {
            var prevHeaders = this.headers, prevPanels = this.panels;
            this.headers = this.element.find(this.options.header).addClass("ui-accordion-header ui-state-default ui-corner-all");
            this.panels = this.headers.next().addClass("ui-accordion-content ui-helper-reset ui-widget-content ui-corner-bottom").filter(":not(.ui-accordion-content-active)").hide();
            if (prevPanels) {
                this._off(prevHeaders.not(this.headers));
                this._off(prevPanels.not(this.panels));
            }
        },
        _refresh: function() {
            var maxHeight, options = this.options, heightStyle = options.heightStyle, parent = this.element.parent();
            this.active = this._findActive(options.active).addClass("ui-accordion-header-active ui-state-active ui-corner-top").removeClass("ui-corner-all");
            this.active.next().addClass("ui-accordion-content-active").show();
            this.headers.attr("role", "tab").each(function() {
                var header = $(this), headerId = header.uniqueId().attr("id"), panel = header.next(), panelId = panel.uniqueId().attr("id");
                header.attr("aria-controls", panelId);
                panel.attr("aria-labelledby", headerId);
            }).next().attr("role", "tabpanel");
            this.headers.not(this.active).attr({
                "aria-selected": "false",
                "aria-expanded": "false",
                tabIndex: -1
            }).next().attr({
                "aria-hidden": "true"
            }).hide();
            if (!this.active.length) {
                this.headers.eq(0).attr("tabIndex", 0);
            } else {
                this.active.attr({
                    "aria-selected": "true",
                    "aria-expanded": "true",
                    tabIndex: 0
                }).next().attr({
                    "aria-hidden": "false"
                });
            }
            this._createIcons();
            this._setupEvents(options.event);
            if (heightStyle === "fill") {
                maxHeight = parent.height();
                this.element.siblings(":visible").each(function() {
                    var elem = $(this), position = elem.css("position");
                    if (position === "absolute" || position === "fixed") {
                        return;
                    }
                    maxHeight -= elem.outerHeight(true);
                });
                this.headers.each(function() {
                    maxHeight -= $(this).outerHeight(true);
                });
                this.headers.next().each(function() {
                    $(this).height(Math.max(0, maxHeight - $(this).innerHeight() + $(this).height()));
                }).css("overflow", "auto");
            } else if (heightStyle === "auto") {
                maxHeight = 0;
                this.headers.next().each(function() {
                    maxHeight = Math.max(maxHeight, $(this).css("height", "").height());
                }).height(maxHeight);
            }
        },
        _activate: function(index) {
            var active = this._findActive(index)[0];
            if (active === this.active[0]) {
                return;
            }
            active = active || this.active[0];
            this._eventHandler({
                target: active,
                currentTarget: active,
                preventDefault: $.noop
            });
        },
        _findActive: function(selector) {
            return typeof selector === "number" ? this.headers.eq(selector) : $();
        },
        _setupEvents: function(event) {
            var events = {
                keydown: "_keydown"
            };
            if (event) {
                $.each(event.split(" "), function(index, eventName) {
                    events[eventName] = "_eventHandler";
                });
            }
            this._off(this.headers.add(this.headers.next()));
            this._on(this.headers, events);
            this._on(this.headers.next(), {
                keydown: "_panelKeyDown"
            });
            this._hoverable(this.headers);
            this._focusable(this.headers);
        },
        _eventHandler: function(event) {
            var options = this.options, active = this.active, clicked = $(event.currentTarget), clickedIsActive = clicked[0] === active[0], collapsing = clickedIsActive && options.collapsible, toShow = collapsing ? $() : clicked.next(), toHide = active.next(), eventData = {
                oldHeader: active,
                oldPanel: toHide,
                newHeader: collapsing ? $() : clicked,
                newPanel: toShow
            };
            event.preventDefault();
            if (clickedIsActive && !options.collapsible || this._trigger("beforeActivate", event, eventData) === false) {
                return;
            }
            options.active = collapsing ? false : this.headers.index(clicked);
            this.active = clickedIsActive ? $() : clicked;
            this._toggle(eventData);
            active.removeClass("ui-accordion-header-active ui-state-active");
            if (options.icons) {
                active.children(".ui-accordion-header-icon").removeClass(options.icons.activeHeader).addClass(options.icons.header);
            }
            if (!clickedIsActive) {
                clicked.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top");
                if (options.icons) {
                    clicked.children(".ui-accordion-header-icon").removeClass(options.icons.header).addClass(options.icons.activeHeader);
                }
                clicked.next().addClass("ui-accordion-content-active");
            }
        },
        _toggle: function(data) {
            var toShow = data.newPanel, toHide = this.prevShow.length ? this.prevShow : data.oldPanel;
            this.prevShow.add(this.prevHide).stop(true, true);
            this.prevShow = toShow;
            this.prevHide = toHide;
            if (this.options.animate) {
                this._animate(toShow, toHide, data);
            } else {
                toHide.hide();
                toShow.show();
                this._toggleComplete(data);
            }
            toHide.attr({
                "aria-hidden": "true"
            });
            toHide.prev().attr({
                "aria-selected": "false",
                "aria-expanded": "false"
            });
            if (toShow.length && toHide.length) {
                toHide.prev().attr({
                    tabIndex: -1,
                    "aria-expanded": "false"
                });
            } else if (toShow.length) {
                this.headers.filter(function() {
                    return parseInt($(this).attr("tabIndex"), 10) === 0;
                }).attr("tabIndex", -1);
            }
            toShow.attr("aria-hidden", "false").prev().attr({
                "aria-selected": "true",
                "aria-expanded": "true",
                tabIndex: 0
            });
        },
        _animate: function(toShow, toHide, data) {
            var total, easing, duration, that = this, adjust = 0, boxSizing = toShow.css("box-sizing"), down = toShow.length && (!toHide.length || toShow.index() < toHide.index()), animate = this.options.animate || {}, options = down && animate.down || animate, complete = function() {
                that._toggleComplete(data);
            };
            if (typeof options === "number") {
                duration = options;
            }
            if (typeof options === "string") {
                easing = options;
            }
            easing = easing || options.easing || animate.easing;
            duration = duration || options.duration || animate.duration;
            if (!toHide.length) {
                return toShow.animate(this.showProps, duration, easing, complete);
            }
            if (!toShow.length) {
                return toHide.animate(this.hideProps, duration, easing, complete);
            }
            total = toShow.show().outerHeight();
            toHide.animate(this.hideProps, {
                duration: duration,
                easing: easing,
                step: function(now, fx) {
                    fx.now = Math.round(now);
                }
            });
            toShow.hide().animate(this.showProps, {
                duration: duration,
                easing: easing,
                complete: complete,
                step: function(now, fx) {
                    fx.now = Math.round(now);
                    if (fx.prop !== "height") {
                        if (boxSizing === "content-box") {
                            adjust += fx.now;
                        }
                    } else if (that.options.heightStyle !== "content") {
                        fx.now = Math.round(total - toHide.outerHeight() - adjust);
                        adjust = 0;
                    }
                }
            });
        },
        _toggleComplete: function(data) {
            var toHide = data.oldPanel;
            toHide.removeClass("ui-accordion-content-active").prev().removeClass("ui-corner-top").addClass("ui-corner-all");
            if (toHide.length) {
                toHide.parent()[0].className = toHide.parent()[0].className;
            }
            this._trigger("activate", null, data);
        }
    });
    var menu = $.widget("ui.menu", {
        version: "1.11.4",
        defaultElement: "<ul>",
        delay: 300,
        options: {
            icons: {
                submenu: "ui-icon-carat-1-e"
            },
            items: "> *",
            menus: "ul",
            position: {
                my: "left-1 top",
                at: "right top"
            },
            role: "menu",
            blur: null,
            focus: null,
            select: null
        },
        _create: function() {
            this.activeMenu = this.element;
            this.mouseHandled = false;
            this.element.uniqueId().addClass("ui-menu ui-widget ui-widget-content").toggleClass("ui-menu-icons", !!this.element.find(".ui-icon").length).attr({
                role: this.options.role,
                tabIndex: 0
            });
            if (this.options.disabled) {
                this.element.addClass("ui-state-disabled").attr("aria-disabled", "true");
            }
            this._on({
                "mousedown .ui-menu-item": function(event) {
                    event.preventDefault();
                },
                "click .ui-menu-item": function(event) {
                    var target = $(event.target);
                    if (!this.mouseHandled && target.not(".ui-state-disabled").length) {
                        this.select(event);
                        if (!event.isPropagationStopped()) {
                            this.mouseHandled = true;
                        }
                        if (target.has(".ui-menu").length) {
                            this.expand(event);
                        } else if (!this.element.is(":focus") && $(this.document[0].activeElement).closest(".ui-menu").length) {
                            this.element.trigger("focus", [ true ]);
                            if (this.active && this.active.parents(".ui-menu").length === 1) {
                                clearTimeout(this.timer);
                            }
                        }
                    }
                },
                "mouseenter .ui-menu-item": function(event) {
                    if (this.previousFilter) {
                        return;
                    }
                    var target = $(event.currentTarget);
                    target.siblings(".ui-state-active").removeClass("ui-state-active");
                    this.focus(event, target);
                },
                mouseleave: "collapseAll",
                "mouseleave .ui-menu": "collapseAll",
                focus: function(event, keepActiveItem) {
                    var item = this.active || this.element.find(this.options.items).eq(0);
                    if (!keepActiveItem) {
                        this.focus(event, item);
                    }
                },
                blur: function(event) {
                    this._delay(function() {
                        if (!$.contains(this.element[0], this.document[0].activeElement)) {
                            this.collapseAll(event);
                        }
                    });
                },
                keydown: "_keydown"
            });
            this.refresh();
            this._on(this.document, {
                click: function(event) {
                    if (this._closeOnDocumentClick(event)) {
                        this.collapseAll(event);
                    }
                    this.mouseHandled = false;
                }
            });
        },
        _destroy: function() {
            this.element.removeAttr("aria-activedescendant").find(".ui-menu").addBack().removeClass("ui-menu ui-widget ui-widget-content ui-menu-icons ui-front").removeAttr("role").removeAttr("tabIndex").removeAttr("aria-labelledby").removeAttr("aria-expanded").removeAttr("aria-hidden").removeAttr("aria-disabled").removeUniqueId().show();
            this.element.find(".ui-menu-item").removeClass("ui-menu-item").removeAttr("role").removeAttr("aria-disabled").removeUniqueId().removeClass("ui-state-hover").removeAttr("tabIndex").removeAttr("role").removeAttr("aria-haspopup").children().each(function() {
                var elem = $(this);
                if (elem.data("ui-menu-submenu-carat")) {
                    elem.remove();
                }
            });
            this.element.find(".ui-menu-divider").removeClass("ui-menu-divider ui-widget-content");
        },
        _keydown: function(event) {
            var match, prev, character, skip, preventDefault = true;
            switch (event.keyCode) {
              case $.ui.keyCode.PAGE_UP:
                this.previousPage(event);
                break;

              case $.ui.keyCode.PAGE_DOWN:
                this.nextPage(event);
                break;

              case $.ui.keyCode.HOME:
                this._move("first", "first", event);
                break;

              case $.ui.keyCode.END:
                this._move("last", "last", event);
                break;

              case $.ui.keyCode.UP:
                this.previous(event);
                break;

              case $.ui.keyCode.DOWN:
                this.next(event);
                break;

              case $.ui.keyCode.LEFT:
                this.collapse(event);
                break;

              case $.ui.keyCode.RIGHT:
                if (this.active && !this.active.is(".ui-state-disabled")) {
                    this.expand(event);
                }
                break;

              case $.ui.keyCode.ENTER:
              case $.ui.keyCode.SPACE:
                this._activate(event);
                break;

              case $.ui.keyCode.ESCAPE:
                this.collapse(event);
                break;

              default:
                preventDefault = false;
                prev = this.previousFilter || "";
                character = String.fromCharCode(event.keyCode);
                skip = false;
                clearTimeout(this.filterTimer);
                if (character === prev) {
                    skip = true;
                } else {
                    character = prev + character;
                }
                match = this._filterMenuItems(character);
                match = skip && match.index(this.active.next()) !== -1 ? this.active.nextAll(".ui-menu-item") : match;
                if (!match.length) {
                    character = String.fromCharCode(event.keyCode);
                    match = this._filterMenuItems(character);
                }
                if (match.length) {
                    this.focus(event, match);
                    this.previousFilter = character;
                    this.filterTimer = this._delay(function() {
                        delete this.previousFilter;
                    }, 1e3);
                } else {
                    delete this.previousFilter;
                }
            }
            if (preventDefault) {
                event.preventDefault();
            }
        },
        _activate: function(event) {
            if (!this.active.is(".ui-state-disabled")) {
                if (this.active.is("[aria-haspopup='true']")) {
                    this.expand(event);
                } else {
                    this.select(event);
                }
            }
        },
        refresh: function() {
            var menus, items, that = this, icon = this.options.icons.submenu, submenus = this.element.find(this.options.menus);
            this.element.toggleClass("ui-menu-icons", !!this.element.find(".ui-icon").length);
            submenus.filter(":not(.ui-menu)").addClass("ui-menu ui-widget ui-widget-content ui-front").hide().attr({
                role: this.options.role,
                "aria-hidden": "true",
                "aria-expanded": "false"
            }).each(function() {
                var menu = $(this), item = menu.parent(), submenuCarat = $("<span>").addClass("ui-menu-icon ui-icon " + icon).data("ui-menu-submenu-carat", true);
                item.attr("aria-haspopup", "true").prepend(submenuCarat);
                menu.attr("aria-labelledby", item.attr("id"));
            });
            menus = submenus.add(this.element);
            items = menus.find(this.options.items);
            items.not(".ui-menu-item").each(function() {
                var item = $(this);
                if (that._isDivider(item)) {
                    item.addClass("ui-widget-content ui-menu-divider");
                }
            });
            items.not(".ui-menu-item, .ui-menu-divider").addClass("ui-menu-item").uniqueId().attr({
                tabIndex: -1,
                role: this._itemRole()
            });
            items.filter(".ui-state-disabled").attr("aria-disabled", "true");
            if (this.active && !$.contains(this.element[0], this.active[0])) {
                this.blur();
            }
        },
        _itemRole: function() {
            return {
                menu: "menuitem",
                listbox: "option"
            }[this.options.role];
        },
        _setOption: function(key, value) {
            if (key === "icons") {
                this.element.find(".ui-menu-icon").removeClass(this.options.icons.submenu).addClass(value.submenu);
            }
            if (key === "disabled") {
                this.element.toggleClass("ui-state-disabled", !!value).attr("aria-disabled", value);
            }
            this._super(key, value);
        },
        focus: function(event, item) {
            var nested, focused;
            this.blur(event, event && event.type === "focus");
            this._scrollIntoView(item);
            this.active = item.first();
            focused = this.active.addClass("ui-state-focus").removeClass("ui-state-active");
            if (this.options.role) {
                this.element.attr("aria-activedescendant", focused.attr("id"));
            }
            this.active.parent().closest(".ui-menu-item").addClass("ui-state-active");
            if (event && event.type === "keydown") {
                this._close();
            } else {
                this.timer = this._delay(function() {
                    this._close();
                }, this.delay);
            }
            nested = item.children(".ui-menu");
            if (nested.length && event && /^mouse/.test(event.type)) {
                this._startOpening(nested);
            }
            this.activeMenu = item.parent();
            this._trigger("focus", event, {
                item: item
            });
        },
        _scrollIntoView: function(item) {
            var borderTop, paddingTop, offset, scroll, elementHeight, itemHeight;
            if (this._hasScroll()) {
                borderTop = parseFloat($.css(this.activeMenu[0], "borderTopWidth")) || 0;
                paddingTop = parseFloat($.css(this.activeMenu[0], "paddingTop")) || 0;
                offset = item.offset().top - this.activeMenu.offset().top - borderTop - paddingTop;
                scroll = this.activeMenu.scrollTop();
                elementHeight = this.activeMenu.height();
                itemHeight = item.outerHeight();
                if (offset < 0) {
                    this.activeMenu.scrollTop(scroll + offset);
                } else if (offset + itemHeight > elementHeight) {
                    this.activeMenu.scrollTop(scroll + offset - elementHeight + itemHeight);
                }
            }
        },
        blur: function(event, fromFocus) {
            if (!fromFocus) {
                clearTimeout(this.timer);
            }
            if (!this.active) {
                return;
            }
            this.active.removeClass("ui-state-focus");
            this.active = null;
            this._trigger("blur", event, {
                item: this.active
            });
        },
        _startOpening: function(submenu) {
            clearTimeout(this.timer);
            if (submenu.attr("aria-hidden") !== "true") {
                return;
            }
            this.timer = this._delay(function() {
                this._close();
                this._open(submenu);
            }, this.delay);
        },
        _open: function(submenu) {
            var position = $.extend({
                of: this.active
            }, this.options.position);
            clearTimeout(this.timer);
            this.element.find(".ui-menu").not(submenu.parents(".ui-menu")).hide().attr("aria-hidden", "true");
            submenu.show().removeAttr("aria-hidden").attr("aria-expanded", "true").position(position);
        },
        collapseAll: function(event, all) {
            clearTimeout(this.timer);
            this.timer = this._delay(function() {
                var currentMenu = all ? this.element : $(event && event.target).closest(this.element.find(".ui-menu"));
                if (!currentMenu.length) {
                    currentMenu = this.element;
                }
                this._close(currentMenu);
                this.blur(event);
                this.activeMenu = currentMenu;
            }, this.delay);
        },
        _close: function(startMenu) {
            if (!startMenu) {
                startMenu = this.active ? this.active.parent() : this.element;
            }
            startMenu.find(".ui-menu").hide().attr("aria-hidden", "true").attr("aria-expanded", "false").end().find(".ui-state-active").not(".ui-state-focus").removeClass("ui-state-active");
        },
        _closeOnDocumentClick: function(event) {
            return !$(event.target).closest(".ui-menu").length;
        },
        _isDivider: function(item) {
            return !/[^\-\u2014\u2013\s]/.test(item.text());
        },
        collapse: function(event) {
            var newItem = this.active && this.active.parent().closest(".ui-menu-item", this.element);
            if (newItem && newItem.length) {
                this._close();
                this.focus(event, newItem);
            }
        },
        expand: function(event) {
            var newItem = this.active && this.active.children(".ui-menu ").find(this.options.items).first();
            if (newItem && newItem.length) {
                this._open(newItem.parent());
                this._delay(function() {
                    this.focus(event, newItem);
                });
            }
        },
        next: function(event) {
            this._move("next", "first", event);
        },
        previous: function(event) {
            this._move("prev", "last", event);
        },
        isFirstItem: function() {
            return this.active && !this.active.prevAll(".ui-menu-item").length;
        },
        isLastItem: function() {
            return this.active && !this.active.nextAll(".ui-menu-item").length;
        },
        _move: function(direction, filter, event) {
            var next;
            if (this.active) {
                if (direction === "first" || direction === "last") {
                    next = this.active[direction === "first" ? "prevAll" : "nextAll"](".ui-menu-item").eq(-1);
                } else {
                    next = this.active[direction + "All"](".ui-menu-item").eq(0);
                }
            }
            if (!next || !next.length || !this.active) {
                next = this.activeMenu.find(this.options.items)[filter]();
            }
            this.focus(event, next);
        },
        nextPage: function(event) {
            var item, base, height;
            if (!this.active) {
                this.next(event);
                return;
            }
            if (this.isLastItem()) {
                return;
            }
            if (this._hasScroll()) {
                base = this.active.offset().top;
                height = this.element.height();
                this.active.nextAll(".ui-menu-item").each(function() {
                    item = $(this);
                    return item.offset().top - base - height < 0;
                });
                this.focus(event, item);
            } else {
                this.focus(event, this.activeMenu.find(this.options.items)[!this.active ? "first" : "last"]());
            }
        },
        previousPage: function(event) {
            var item, base, height;
            if (!this.active) {
                this.next(event);
                return;
            }
            if (this.isFirstItem()) {
                return;
            }
            if (this._hasScroll()) {
                base = this.active.offset().top;
                height = this.element.height();
                this.active.prevAll(".ui-menu-item").each(function() {
                    item = $(this);
                    return item.offset().top - base + height > 0;
                });
                this.focus(event, item);
            } else {
                this.focus(event, this.activeMenu.find(this.options.items).first());
            }
        },
        _hasScroll: function() {
            return this.element.outerHeight() < this.element.prop("scrollHeight");
        },
        select: function(event) {
            this.active = this.active || $(event.target).closest(".ui-menu-item");
            var ui = {
                item: this.active
            };
            if (!this.active.has(".ui-menu").length) {
                this.collapseAll(event, true);
            }
            this._trigger("select", event, ui);
        },
        _filterMenuItems: function(character) {
            var escapedCharacter = character.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&"), regex = new RegExp("^" + escapedCharacter, "i");
            return this.activeMenu.find(this.options.items).filter(".ui-menu-item").filter(function() {
                return regex.test($.trim($(this).text()));
            });
        }
    });
    $.widget("ui.autocomplete", {
        version: "1.11.4",
        defaultElement: "<input>",
        options: {
            appendTo: null,
            autoFocus: false,
            delay: 300,
            minLength: 1,
            position: {
                my: "left top",
                at: "left bottom",
                collision: "none"
            },
            source: null,
            change: null,
            close: null,
            focus: null,
            open: null,
            response: null,
            search: null,
            select: null
        },
        requestIndex: 0,
        pending: 0,
        _create: function() {
            var suppressKeyPress, suppressKeyPressRepeat, suppressInput, nodeName = this.element[0].nodeName.toLowerCase(), isTextarea = nodeName === "textarea", isInput = nodeName === "input";
            this.isMultiLine = isTextarea ? true : isInput ? false : this.element.prop("isContentEditable");
            this.valueMethod = this.element[isTextarea || isInput ? "val" : "text"];
            this.isNewMenu = true;
            this.element.addClass("ui-autocomplete-input").attr("autocomplete", "off");
            this._on(this.element, {
                keydown: function(event) {
                    if (this.element.prop("readOnly")) {
                        suppressKeyPress = true;
                        suppressInput = true;
                        suppressKeyPressRepeat = true;
                        return;
                    }
                    suppressKeyPress = false;
                    suppressInput = false;
                    suppressKeyPressRepeat = false;
                    var keyCode = $.ui.keyCode;
                    switch (event.keyCode) {
                      case keyCode.PAGE_UP:
                        suppressKeyPress = true;
                        this._move("previousPage", event);
                        break;

                      case keyCode.PAGE_DOWN:
                        suppressKeyPress = true;
                        this._move("nextPage", event);
                        break;

                      case keyCode.UP:
                        suppressKeyPress = true;
                        this._keyEvent("previous", event);
                        break;

                      case keyCode.DOWN:
                        suppressKeyPress = true;
                        this._keyEvent("next", event);
                        break;

                      case keyCode.ENTER:
                        if (this.menu.active) {
                            suppressKeyPress = true;
                            event.preventDefault();
                            this.menu.select(event);
                        }
                        break;

                      case keyCode.TAB:
                        if (this.menu.active) {
                            this.menu.select(event);
                        }
                        break;

                      case keyCode.ESCAPE:
                        if (this.menu.element.is(":visible")) {
                            if (!this.isMultiLine) {
                                this._value(this.term);
                            }
                            this.close(event);
                            event.preventDefault();
                        }
                        break;

                      default:
                        suppressKeyPressRepeat = true;
                        this._searchTimeout(event);
                        break;
                    }
                },
                keypress: function(event) {
                    if (suppressKeyPress) {
                        suppressKeyPress = false;
                        if (!this.isMultiLine || this.menu.element.is(":visible")) {
                            event.preventDefault();
                        }
                        return;
                    }
                    if (suppressKeyPressRepeat) {
                        return;
                    }
                    var keyCode = $.ui.keyCode;
                    switch (event.keyCode) {
                      case keyCode.PAGE_UP:
                        this._move("previousPage", event);
                        break;

                      case keyCode.PAGE_DOWN:
                        this._move("nextPage", event);
                        break;

                      case keyCode.UP:
                        this._keyEvent("previous", event);
                        break;

                      case keyCode.DOWN:
                        this._keyEvent("next", event);
                        break;
                    }
                },
                input: function(event) {
                    if (suppressInput) {
                        suppressInput = false;
                        event.preventDefault();
                        return;
                    }
                    this._searchTimeout(event);
                },
                focus: function() {
                    this.selectedItem = null;
                    this.previous = this._value();
                },
                blur: function(event) {
                    if (this.cancelBlur) {
                        delete this.cancelBlur;
                        return;
                    }
                    clearTimeout(this.searching);
                    this.close(event);
                    this._change(event);
                }
            });
            this._initSource();
            this.menu = $("<ul>").addClass("ui-autocomplete ui-front").appendTo(this._appendTo()).menu({
                role: null
            }).hide().menu("instance");
            this._on(this.menu.element, {
                mousedown: function(event) {
                    event.preventDefault();
                    this.cancelBlur = true;
                    this._delay(function() {
                        delete this.cancelBlur;
                    });
                    var menuElement = this.menu.element[0];
                    if (!$(event.target).closest(".ui-menu-item").length) {
                        this._delay(function() {
                            var that = this;
                            this.document.one("mousedown", function(event) {
                                if (event.target !== that.element[0] && event.target !== menuElement && !$.contains(menuElement, event.target)) {
                                    that.close();
                                }
                            });
                        });
                    }
                },
                menufocus: function(event, ui) {
                    var label, item;
                    if (this.isNewMenu) {
                        this.isNewMenu = false;
                        if (event.originalEvent && /^mouse/.test(event.originalEvent.type)) {
                            this.menu.blur();
                            this.document.one("mousemove", function() {
                                $(event.target).trigger(event.originalEvent);
                            });
                            return;
                        }
                    }
                    item = ui.item.data("ui-autocomplete-item");
                    if (false !== this._trigger("focus", event, {
                        item: item
                    })) {
                        if (event.originalEvent && /^key/.test(event.originalEvent.type)) {
                            this._value(item.value);
                        }
                    }
                    label = ui.item.attr("aria-label") || item.value;
                    if (label && $.trim(label).length) {
                        this.liveRegion.children().hide();
                        $("<div>").text(label).appendTo(this.liveRegion);
                    }
                },
                menuselect: function(event, ui) {
                    var item = ui.item.data("ui-autocomplete-item"), previous = this.previous;
                    if (this.element[0] !== this.document[0].activeElement) {
                        this.element.focus();
                        this.previous = previous;
                        this._delay(function() {
                            this.previous = previous;
                            this.selectedItem = item;
                        });
                    }
                    if (false !== this._trigger("select", event, {
                        item: item
                    })) {
                        this._value(item.value);
                    }
                    this.term = this._value();
                    this.close(event);
                    this.selectedItem = item;
                }
            });
            this.liveRegion = $("<span>", {
                role: "status",
                "aria-live": "assertive",
                "aria-relevant": "additions"
            }).addClass("ui-helper-hidden-accessible").appendTo(this.document[0].body);
            this._on(this.window, {
                beforeunload: function() {
                    this.element.removeAttr("autocomplete");
                }
            });
        },
        _destroy: function() {
            clearTimeout(this.searching);
            this.element.removeClass("ui-autocomplete-input").removeAttr("autocomplete");
            this.menu.element.remove();
            this.liveRegion.remove();
        },
        _setOption: function(key, value) {
            this._super(key, value);
            if (key === "source") {
                this._initSource();
            }
            if (key === "appendTo") {
                this.menu.element.appendTo(this._appendTo());
            }
            if (key === "disabled" && value && this.xhr) {
                this.xhr.abort();
            }
        },
        _appendTo: function() {
            var element = this.options.appendTo;
            if (element) {
                element = element.jquery || element.nodeType ? $(element) : this.document.find(element).eq(0);
            }
            if (!element || !element[0]) {
                element = this.element.closest(".ui-front");
            }
            if (!element.length) {
                element = this.document[0].body;
            }
            return element;
        },
        _initSource: function() {
            var array, url, that = this;
            if ($.isArray(this.options.source)) {
                array = this.options.source;
                this.source = function(request, response) {
                    response($.ui.autocomplete.filter(array, request.term));
                };
            } else if (typeof this.options.source === "string") {
                url = this.options.source;
                this.source = function(request, response) {
                    if (that.xhr) {
                        that.xhr.abort();
                    }
                    that.xhr = $.ajax({
                        url: url,
                        data: request,
                        dataType: "json",
                        success: function(data) {
                            response(data);
                        },
                        error: function() {
                            response([]);
                        }
                    });
                };
            } else {
                this.source = this.options.source;
            }
        },
        _searchTimeout: function(event) {
            clearTimeout(this.searching);
            this.searching = this._delay(function() {
                var equalValues = this.term === this._value(), menuVisible = this.menu.element.is(":visible"), modifierKey = event.altKey || event.ctrlKey || event.metaKey || event.shiftKey;
                if (!equalValues || equalValues && !menuVisible && !modifierKey) {
                    this.selectedItem = null;
                    this.search(null, event);
                }
            }, this.options.delay);
        },
        search: function(value, event) {
            value = value != null ? value : this._value();
            this.term = this._value();
            if (value.length < this.options.minLength) {
                return this.close(event);
            }
            if (this._trigger("search", event) === false) {
                return;
            }
            return this._search(value);
        },
        _search: function(value) {
            this.pending++;
            this.element.addClass("ui-autocomplete-loading");
            this.cancelSearch = false;
            this.source({
                term: value
            }, this._response());
        },
        _response: function() {
            var index = ++this.requestIndex;
            return $.proxy(function(content) {
                if (index === this.requestIndex) {
                    this.__response(content);
                }
                this.pending--;
                if (!this.pending) {
                    this.element.removeClass("ui-autocomplete-loading");
                }
            }, this);
        },
        __response: function(content) {
            if (content) {
                content = this._normalize(content);
            }
            this._trigger("response", null, {
                content: content
            });
            if (!this.options.disabled && content && content.length && !this.cancelSearch) {
                this._suggest(content);
                this._trigger("open");
            } else {
                this._close();
            }
        },
        close: function(event) {
            this.cancelSearch = true;
            this._close(event);
        },
        _close: function(event) {
            if (this.menu.element.is(":visible")) {
                this.menu.element.hide();
                this.menu.blur();
                this.isNewMenu = true;
                this._trigger("close", event);
            }
        },
        _change: function(event) {
            if (this.previous !== this._value()) {
                this._trigger("change", event, {
                    item: this.selectedItem
                });
            }
        },
        _normalize: function(items) {
            if (items.length && items[0].label && items[0].value) {
                return items;
            }
            return $.map(items, function(item) {
                if (typeof item === "string") {
                    return {
                        label: item,
                        value: item
                    };
                }
                return $.extend({}, item, {
                    label: item.label || item.value,
                    value: item.value || item.label
                });
            });
        },
        _suggest: function(items) {
            var ul = this.menu.element.empty();
            this._renderMenu(ul, items);
            this.isNewMenu = true;
            this.menu.refresh();
            ul.show();
            this._resizeMenu();
            ul.position($.extend({
                of: this.element
            }, this.options.position));
            if (this.options.autoFocus) {
                this.menu.next();
            }
        },
        _resizeMenu: function() {
            var ul = this.menu.element;
            ul.outerWidth(Math.max(ul.width("").outerWidth() + 1, this.element.outerWidth()));
        },
        _renderMenu: function(ul, items) {
            var that = this;
            $.each(items, function(index, item) {
                that._renderItemData(ul, item);
            });
        },
        _renderItemData: function(ul, item) {
            return this._renderItem(ul, item).data("ui-autocomplete-item", item);
        },
        _renderItem: function(ul, item) {
            return $("<li>").text(item.label).appendTo(ul);
        },
        _move: function(direction, event) {
            if (!this.menu.element.is(":visible")) {
                this.search(null, event);
                return;
            }
            if (this.menu.isFirstItem() && /^previous/.test(direction) || this.menu.isLastItem() && /^next/.test(direction)) {
                if (!this.isMultiLine) {
                    this._value(this.term);
                }
                this.menu.blur();
                return;
            }
            this.menu[direction](event);
        },
        widget: function() {
            return this.menu.element;
        },
        _value: function() {
            return this.valueMethod.apply(this.element, arguments);
        },
        _keyEvent: function(keyEvent, event) {
            if (!this.isMultiLine || this.menu.element.is(":visible")) {
                this._move(keyEvent, event);
                event.preventDefault();
            }
        }
    });
    $.extend($.ui.autocomplete, {
        escapeRegex: function(value) {
            return value.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g, "\\$&");
        },
        filter: function(array, term) {
            var matcher = new RegExp($.ui.autocomplete.escapeRegex(term), "i");
            return $.grep(array, function(value) {
                return matcher.test(value.label || value.value || value);
            });
        }
    });
    $.widget("ui.autocomplete", $.ui.autocomplete, {
        options: {
            messages: {
                noResults: "No search results.",
                results: function(amount) {
                    return amount + (amount > 1 ? " results are" : " result is") + " available, use up and down arrow keys to navigate.";
                }
            }
        },
        __response: function(content) {
            var message;
            this._superApply(arguments);
            if (this.options.disabled || this.cancelSearch) {
                return;
            }
            if (content && content.length) {
                message = this.options.messages.results(content.length);
            } else {
                message = this.options.messages.noResults;
            }
            this.liveRegion.children().hide();
            $("<div>").text(message).appendTo(this.liveRegion);
        }
    });
    var autocomplete = $.ui.autocomplete;
    var lastActive, baseClasses = "ui-button ui-widget ui-state-default ui-corner-all", typeClasses = "ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only", formResetHandler = function() {
        var form = $(this);
        setTimeout(function() {
            form.find(":ui-button").button("refresh");
        }, 1);
    }, radioGroup = function(radio) {
        var name = radio.name, form = radio.form, radios = $([]);
        if (name) {
            name = name.replace(/'/g, "\\'");
            if (form) {
                radios = $(form).find("[name='" + name + "'][type=radio]");
            } else {
                radios = $("[name='" + name + "'][type=radio]", radio.ownerDocument).filter(function() {
                    return !this.form;
                });
            }
        }
        return radios;
    };
    $.widget("ui.button", {
        version: "1.11.4",
        defaultElement: "<button>",
        options: {
            disabled: null,
            text: true,
            label: null,
            icons: {
                primary: null,
                secondary: null
            }
        },
        _create: function() {
            this.element.closest("form").unbind("reset" + this.eventNamespace).bind("reset" + this.eventNamespace, formResetHandler);
            if (typeof this.options.disabled !== "boolean") {
                this.options.disabled = !!this.element.prop("disabled");
            } else {
                this.element.prop("disabled", this.options.disabled);
            }
            this._determineButtonType();
            this.hasTitle = !!this.buttonElement.attr("title");
            var that = this, options = this.options, toggleButton = this.type === "checkbox" || this.type === "radio", activeClass = !toggleButton ? "ui-state-active" : "";
            if (options.label === null) {
                options.label = this.type === "input" ? this.buttonElement.val() : this.buttonElement.html();
            }
            this._hoverable(this.buttonElement);
            this.buttonElement.addClass(baseClasses).attr("role", "button").bind("mouseenter" + this.eventNamespace, function() {
                if (options.disabled) {
                    return;
                }
                if (this === lastActive) {
                    $(this).addClass("ui-state-active");
                }
            }).bind("mouseleave" + this.eventNamespace, function() {
                if (options.disabled) {
                    return;
                }
                $(this).removeClass(activeClass);
            }).bind("click" + this.eventNamespace, function(event) {
                if (options.disabled) {
                    event.preventDefault();
                    event.stopImmediatePropagation();
                }
            });
            this._on({
                focus: function() {
                    this.buttonElement.addClass("ui-state-focus");
                },
                blur: function() {
                    this.buttonElement.removeClass("ui-state-focus");
                }
            });
            if (toggleButton) {
                this.element.bind("change" + this.eventNamespace, function() {
                    that.refresh();
                });
            }
            if (this.type === "checkbox") {
                this.buttonElement.bind("click" + this.eventNamespace, function() {
                    if (options.disabled) {
                        return false;
                    }
                });
            } else if (this.type === "radio") {
                this.buttonElement.bind("click" + this.eventNamespace, function() {
                    if (options.disabled) {
                        return false;
                    }
                    $(this).addClass("ui-state-active");
                    that.buttonElement.attr("aria-pressed", "true");
                    var radio = that.element[0];
                    radioGroup(radio).not(radio).map(function() {
                        return $(this).button("widget")[0];
                    }).removeClass("ui-state-active").attr("aria-pressed", "false");
                });
            } else {
                this.buttonElement.bind("mousedown" + this.eventNamespace, function() {
                    if (options.disabled) {
                        return false;
                    }
                    $(this).addClass("ui-state-active");
                    lastActive = this;
                    that.document.one("mouseup", function() {
                        lastActive = null;
                    });
                }).bind("mouseup" + this.eventNamespace, function() {
                    if (options.disabled) {
                        return false;
                    }
                    $(this).removeClass("ui-state-active");
                }).bind("keydown" + this.eventNamespace, function(event) {
                    if (options.disabled) {
                        return false;
                    }
                    if (event.keyCode === $.ui.keyCode.SPACE || event.keyCode === $.ui.keyCode.ENTER) {
                        $(this).addClass("ui-state-active");
                    }
                }).bind("keyup" + this.eventNamespace + " blur" + this.eventNamespace, function() {
                    $(this).removeClass("ui-state-active");
                });
                if (this.buttonElement.is("a")) {
                    this.buttonElement.keyup(function(event) {
                        if (event.keyCode === $.ui.keyCode.SPACE) {
                            $(this).click();
                        }
                    });
                }
            }
            this._setOption("disabled", options.disabled);
            this._resetButton();
        },
        _determineButtonType: function() {
            var ancestor, labelSelector, checked;
            if (this.element.is("[type=checkbox]")) {
                this.type = "checkbox";
            } else if (this.element.is("[type=radio]")) {
                this.type = "radio";
            } else if (this.element.is("input")) {
                this.type = "input";
            } else {
                this.type = "button";
            }
            if (this.type === "checkbox" || this.type === "radio") {
                ancestor = this.element.parents().last();
                labelSelector = "label[for='" + this.element.attr("id") + "']";
                this.buttonElement = ancestor.find(labelSelector);
                if (!this.buttonElement.length) {
                    ancestor = ancestor.length ? ancestor.siblings() : this.element.siblings();
                    this.buttonElement = ancestor.filter(labelSelector);
                    if (!this.buttonElement.length) {
                        this.buttonElement = ancestor.find(labelSelector);
                    }
                }
                this.element.addClass("ui-helper-hidden-accessible");
                checked = this.element.is(":checked");
                if (checked) {
                    this.buttonElement.addClass("ui-state-active");
                }
                this.buttonElement.prop("aria-pressed", checked);
            } else {
                this.buttonElement = this.element;
            }
        },
        widget: function() {
            return this.buttonElement;
        },
        _destroy: function() {
            this.element.removeClass("ui-helper-hidden-accessible");
            this.buttonElement.removeClass(baseClasses + " ui-state-active " + typeClasses).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html());
            if (!this.hasTitle) {
                this.buttonElement.removeAttr("title");
            }
        },
        _setOption: function(key, value) {
            this._super(key, value);
            if (key === "disabled") {
                this.widget().toggleClass("ui-state-disabled", !!value);
                this.element.prop("disabled", !!value);
                if (value) {
                    if (this.type === "checkbox" || this.type === "radio") {
                        this.buttonElement.removeClass("ui-state-focus");
                    } else {
                        this.buttonElement.removeClass("ui-state-focus ui-state-active");
                    }
                }
                return;
            }
            this._resetButton();
        },
        refresh: function() {
            var isDisabled = this.element.is("input, button") ? this.element.is(":disabled") : this.element.hasClass("ui-button-disabled");
            if (isDisabled !== this.options.disabled) {
                this._setOption("disabled", isDisabled);
            }
            if (this.type === "radio") {
                radioGroup(this.element[0]).each(function() {
                    if ($(this).is(":checked")) {
                        $(this).button("widget").addClass("ui-state-active").attr("aria-pressed", "true");
                    } else {
                        $(this).button("widget").removeClass("ui-state-active").attr("aria-pressed", "false");
                    }
                });
            } else if (this.type === "checkbox") {
                if (this.element.is(":checked")) {
                    this.buttonElement.addClass("ui-state-active").attr("aria-pressed", "true");
                } else {
                    this.buttonElement.removeClass("ui-state-active").attr("aria-pressed", "false");
                }
            }
        },
        _resetButton: function() {
            if (this.type === "input") {
                if (this.options.label) {
                    this.element.val(this.options.label);
                }
                return;
            }
            var buttonElement = this.buttonElement.removeClass(typeClasses), buttonText = $("<span></span>", this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(buttonElement.empty()).text(), icons = this.options.icons, multipleIcons = icons.primary && icons.secondary, buttonClasses = [];
            if (icons.primary || icons.secondary) {
                if (this.options.text) {
                    buttonClasses.push("ui-button-text-icon" + (multipleIcons ? "s" : icons.primary ? "-primary" : "-secondary"));
                }
                if (icons.primary) {
                    buttonElement.prepend("<span class='ui-button-icon-primary ui-icon " + icons.primary + "'></span>");
                }
                if (icons.secondary) {
                    buttonElement.append("<span class='ui-button-icon-secondary ui-icon " + icons.secondary + "'></span>");
                }
                if (!this.options.text) {
                    buttonClasses.push(multipleIcons ? "ui-button-icons-only" : "ui-button-icon-only");
                    if (!this.hasTitle) {
                        buttonElement.attr("title", $.trim(buttonText));
                    }
                }
            } else {
                buttonClasses.push("ui-button-text-only");
            }
            buttonElement.addClass(buttonClasses.join(" "));
        }
    });
    $.widget("ui.buttonset", {
        version: "1.11.4",
        options: {
            items: "button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"
        },
        _create: function() {
            this.element.addClass("ui-buttonset");
        },
        _init: function() {
            this.refresh();
        },
        _setOption: function(key, value) {
            if (key === "disabled") {
                this.buttons.button("option", key, value);
            }
            this._super(key, value);
        },
        refresh: function() {
            var rtl = this.element.css("direction") === "rtl", allButtons = this.element.find(this.options.items), existingButtons = allButtons.filter(":ui-button");
            allButtons.not(":ui-button").button();
            existingButtons.button("refresh");
            this.buttons = allButtons.map(function() {
                return $(this).button("widget")[0];
            }).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(rtl ? "ui-corner-right" : "ui-corner-left").end().filter(":last").addClass(rtl ? "ui-corner-left" : "ui-corner-right").end().end();
        },
        _destroy: function() {
            this.element.removeClass("ui-buttonset");
            this.buttons.map(function() {
                return $(this).button("widget")[0];
            }).removeClass("ui-corner-left ui-corner-right").end().button("destroy");
        }
    });
    var button = $.ui.button;
    $.extend($.ui, {
        datepicker: {
            version: "1.11.4"
        }
    });
    var datepicker_instActive;
    function datepicker_getZindex(elem) {
        var position, value;
        while (elem.length && elem[0] !== document) {
            position = elem.css("position");
            if (position === "absolute" || position === "relative" || position === "fixed") {
                value = parseInt(elem.css("zIndex"), 10);
                if (!isNaN(value) && value !== 0) {
                    return value;
                }
            }
            elem = elem.parent();
        }
        return 0;
    }
    function Datepicker() {
        this._curInst = null;
        this._keyEvent = false;
        this._disabledInputs = [];
        this._datepickerShowing = false;
        this._inDialog = false;
        this._mainDivId = "ui-datepicker-div";
        this._inlineClass = "ui-datepicker-inline";
        this._appendClass = "ui-datepicker-append";
        this._triggerClass = "ui-datepicker-trigger";
        this._dialogClass = "ui-datepicker-dialog";
        this._disableClass = "ui-datepicker-disabled";
        this._unselectableClass = "ui-datepicker-unselectable";
        this._currentClass = "ui-datepicker-current-day";
        this._dayOverClass = "ui-datepicker-days-cell-over";
        this.regional = [];
        this.regional[""] = {
            closeText: "Close",
            prevText: "Prev",
            nextText: "Next",
            currentText: "Today",
            monthNames: [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
            monthNamesShort: [ "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" ],
            dayNames: [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ],
            dayNamesShort: [ "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" ],
            dayNamesMin: [ "Su", "Mo", "Tu", "We", "Th", "Fr", "Sa" ],
            weekHeader: "Wk",
            dateFormat: "mm/dd/yy",
            firstDay: 0,
            isRTL: false,
            showMonthAfterYear: false,
            yearSuffix: ""
        };
        this._defaults = {
            showOn: "focus",
            showAnim: "fadeIn",
            showOptions: {},
            defaultDate: null,
            appendText: "",
            buttonText: "...",
            buttonImage: "",
            buttonImageOnly: false,
            buttonClasses: "",
            hideIfNoPrevNext: false,
            navigationAsDateFormat: false,
            gotoCurrent: false,
            changeMonth: false,
            changeYear: false,
            yearRange: "c-10:c+10",
            showOtherMonths: false,
            selectOtherMonths: false,
            showWeek: false,
            calculateWeek: this.iso8601Week,
            shortYearCutoff: "+10",
            minDate: null,
            maxDate: null,
            duration: "fast",
            beforeShowDay: null,
            beforeShow: null,
            onSelect: null,
            onChangeMonthYear: null,
            onClose: null,
            numberOfMonths: 1,
            showCurrentAtPos: 0,
            stepMonths: 1,
            stepBigMonths: 12,
            altField: "",
            altFormat: "",
            constrainInput: true,
            showButtonPanel: false,
            autoSize: false,
            disabled: false
        };
        $.extend(this._defaults, this.regional[""]);
        this.regional.en = $.extend(true, {}, this.regional[""]);
        this.regional["en-US"] = $.extend(true, {}, this.regional.en);
        this.dpDiv = datepicker_bindHover($("<div id='" + this._mainDivId + "' class='ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"));
    }
    $.extend(Datepicker.prototype, {
        markerClassName: "hasDatepicker",
        maxRows: 4,
        _widgetDatepicker: function() {
            return this.dpDiv;
        },
        setDefaults: function(settings) {
            datepicker_extendRemove(this._defaults, settings || {});
            return this;
        },
        _attachDatepicker: function(target, settings) {
            var nodeName, inline, inst;
            nodeName = target.nodeName.toLowerCase();
            inline = nodeName === "div" || nodeName === "span";
            if (!target.id) {
                this.uuid += 1;
                target.id = "dp" + this.uuid;
            }
            inst = this._newInst($(target), inline);
            inst.settings = $.extend({}, settings || {});
            if (nodeName === "input") {
                this._connectDatepicker(target, inst);
            } else if (inline) {
                this._inlineDatepicker(target, inst);
            }
            var cb = this._get(inst, "callback");
            if (cb && typeof cb === "function") {
                setTimeout(function() {
                    cb();
                }, 0);
            }
        },
        _newInst: function(target, inline) {
            var id = target[0].id.replace(/([^A-Za-z0-9_\-])/g, "\\\\$1");
            return {
                id: id,
                input: target,
                selectedDay: 0,
                selectedMonth: 0,
                selectedYear: 0,
                drawMonth: 0,
                drawYear: 0,
                inline: inline,
                dpDiv: !inline ? this.dpDiv : datepicker_bindHover($("<div class='" + this._inlineClass + " ui-datepicker ui-widget ui-widget-content ui-helper-clearfix ui-corner-all'></div>"))
            };
        },
        _connectDatepicker: function(target, inst) {
            var input = $(target);
            inst.append = $([]);
            inst.trigger = $([]);
            if (input.hasClass(this.markerClassName)) {
                return;
            }
            this._attachments(input, inst);
            input.addClass(this.markerClassName).keydown(this._doKeyDown).keypress(this._doKeyPress).keyup(this._doKeyUp);
            this._autoSize(inst);
            $.data(target, "datepicker", inst);
            if (inst.settings.disabled) {
                this._disableDatepicker(target);
            }
        },
        _attachments: function(input, inst) {
            var showOn, buttonText, buttonImage, appendText = this._get(inst, "appendText"), isRTL = this._get(inst, "isRTL");
            if (inst.append) {
                inst.append.remove();
            }
            if (appendText) {
                inst.append = $("<span class='" + this._appendClass + "'>" + appendText + "</span>");
                input[isRTL ? "before" : "after"](inst.append);
            }
            input.unbind("focus", this._showDatepicker);
            if (inst.trigger) {
                inst.trigger.remove();
            }
            showOn = this._get(inst, "showOn");
            if (showOn === "focus" || showOn === "both") {
                input.focus(this._showDatepicker);
            }
            if (showOn === "button" || showOn === "both") {
                buttonText = this._get(inst, "buttonText");
                buttonImage = this._get(inst, "buttonImage");
                buttonClasses = this._get(inst, "buttonClasses");
                inst.trigger = $(this._get(inst, "buttonImageOnly") ? $("<img/>").addClass(this._triggerClass).attr({
                    src: buttonImage,
                    alt: buttonText,
                    title: buttonText
                }) : $("<button type='button' class='calendar-icon'></button>").addClass(this._triggerClass + " " + buttonClasses).html(!buttonImage ? buttonText : $("<img/>").attr({
                    src: buttonImage,
                    alt: buttonText,
                    title: buttonText
                })));
                input[isRTL ? "before" : "after"](inst.trigger);
                inst.trigger.click(function() {
                    if ($.datepicker._datepickerShowing && $.datepicker._lastInput === input[0]) {
                        $.datepicker._hideDatepicker();
                    } else if ($.datepicker._datepickerShowing && $.datepicker._lastInput !== input[0]) {
                        $.datepicker._hideDatepicker();
                        $.datepicker._showDatepicker(input[0]);
                    } else {
                        $.datepicker._showDatepicker(input[0]);
                    }
                    return false;
                });
            }
        },
        _autoSize: function(inst) {
            if (this._get(inst, "autoSize") && !inst.inline) {
                var findMax, max, maxI, i, date = new Date(2009, 12 - 1, 20), dateFormat = this._get(inst, "dateFormat");
                if (dateFormat.match(/[DM]/)) {
                    findMax = function(names) {
                        max = 0;
                        maxI = 0;
                        for (i = 0; i < names.length; i++) {
                            if (names[i].length > max) {
                                max = names[i].length;
                                maxI = i;
                            }
                        }
                        return maxI;
                    };
                    date.setMonth(findMax(this._get(inst, dateFormat.match(/MM/) ? "monthNames" : "monthNamesShort")));
                    date.setDate(findMax(this._get(inst, dateFormat.match(/DD/) ? "dayNames" : "dayNamesShort")) + 20 - date.getDay());
                }
                inst.input.attr("size", this._formatDate(inst, date).length);
            }
        },
        _inlineDatepicker: function(target, inst) {
            var divSpan = $(target);
            if (divSpan.hasClass(this.markerClassName)) {
                return;
            }
            divSpan.addClass(this.markerClassName).append(inst.dpDiv);
            $.data(target, "datepicker", inst);
            this._setDate(inst, this._getDefaultDate(inst), true);
            this._updateDatepicker(inst);
            this._updateAlternate(inst);
            if (inst.settings.disabled) {
                this._disableDatepicker(target);
            }
            inst.dpDiv.css("display", "block");
        },
        _dialogDatepicker: function(input, date, onSelect, settings, pos) {
            var id, browserWidth, browserHeight, scrollX, scrollY, inst = this._dialogInst;
            if (!inst) {
                this.uuid += 1;
                id = "dp" + this.uuid;
                this._dialogInput = $("<input type='text' id='" + id + "' style='position: absolute; top: -100px; width: 0px;'/>");
                this._dialogInput.keydown(this._doKeyDown);
                $("body").append(this._dialogInput);
                inst = this._dialogInst = this._newInst(this._dialogInput, false);
                inst.settings = {};
                $.data(this._dialogInput[0], "datepicker", inst);
            }
            datepicker_extendRemove(inst.settings, settings || {});
            date = date && date.constructor === Date ? this._formatDate(inst, date) : date;
            this._dialogInput.val(date);
            this._pos = pos ? pos.length ? pos : [ pos.pageX, pos.pageY ] : null;
            if (!this._pos) {
                browserWidth = document.documentElement.clientWidth;
                browserHeight = document.documentElement.clientHeight;
                scrollX = document.documentElement.scrollLeft || document.body.scrollLeft;
                scrollY = document.documentElement.scrollTop || document.body.scrollTop;
                this._pos = [ browserWidth / 2 - 100 + scrollX, browserHeight / 2 - 150 + scrollY ];
            }
            this._dialogInput.css("left", this._pos[0] + 20 + "px").css("top", this._pos[1] + "px");
            inst.settings.onSelect = onSelect;
            this._inDialog = true;
            this.dpDiv.addClass(this._dialogClass);
            this._showDatepicker(this._dialogInput[0]);
            if ($.blockUI) {
                $.blockUI(this.dpDiv);
            }
            $.data(this._dialogInput[0], "datepicker", inst);
            return this;
        },
        _destroyDatepicker: function(target) {
            var nodeName, $target = $(target), inst = $.data(target, "datepicker");
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            $.removeData(target, "datepicker");
            if (nodeName === "input") {
                inst.append.remove();
                inst.trigger.remove();
                $target.removeClass(this.markerClassName).unbind("focus", this._showDatepicker).unbind("keydown", this._doKeyDown).unbind("keypress", this._doKeyPress).unbind("keyup", this._doKeyUp);
            } else if (nodeName === "div" || nodeName === "span") {
                $target.removeClass(this.markerClassName).empty();
            }
            if (datepicker_instActive === inst) {
                datepicker_instActive = null;
            }
        },
        _enableDatepicker: function(target) {
            var nodeName, inline, $target = $(target), inst = $.data(target, "datepicker");
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            if (nodeName === "input") {
                target.disabled = false;
                inst.trigger.filter("button").each(function() {
                    this.disabled = false;
                }).end().filter("img").css({
                    opacity: "1.0",
                    cursor: ""
                });
            } else if (nodeName === "div" || nodeName === "span") {
                inline = $target.children("." + this._inlineClass);
                inline.children().removeClass("ui-state-disabled");
                inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled", false);
            }
            this._disabledInputs = $.map(this._disabledInputs, function(value) {
                return value === target ? null : value;
            });
        },
        _disableDatepicker: function(target) {
            var nodeName, inline, $target = $(target), inst = $.data(target, "datepicker");
            if (!$target.hasClass(this.markerClassName)) {
                return;
            }
            nodeName = target.nodeName.toLowerCase();
            if (nodeName === "input") {
                target.disabled = true;
                inst.trigger.filter("button").each(function() {
                    this.disabled = true;
                }).end().filter("img").css({
                    opacity: "0.5",
                    cursor: "default"
                });
            } else if (nodeName === "div" || nodeName === "span") {
                inline = $target.children("." + this._inlineClass);
                inline.children().addClass("ui-state-disabled");
                inline.find("select.ui-datepicker-month, select.ui-datepicker-year").prop("disabled", true);
            }
            this._disabledInputs = $.map(this._disabledInputs, function(value) {
                return value === target ? null : value;
            });
            this._disabledInputs[this._disabledInputs.length] = target;
        },
        _isDisabledDatepicker: function(target) {
            if (!target) {
                return false;
            }
            for (var i = 0; i < this._disabledInputs.length; i++) {
                if (this._disabledInputs[i] === target) {
                    return true;
                }
            }
            return false;
        },
        _getInst: function(target) {
            try {
                return $.data(target, "datepicker");
            } catch (err) {
                throw "Missing instance data for this datepicker";
            }
        },
        _optionDatepicker: function(target, name, value) {
            var settings, date, minDate, maxDate, inst = this._getInst(target);
            if (arguments.length === 2 && typeof name === "string") {
                return name === "defaults" ? $.extend({}, $.datepicker._defaults) : inst ? name === "all" ? $.extend({}, inst.settings) : this._get(inst, name) : null;
            }
            settings = name || {};
            if (typeof name === "string") {
                settings = {};
                settings[name] = value;
            }
            if (inst) {
                if (this._curInst === inst) {
                    this._hideDatepicker();
                }
                date = this._getDateDatepicker(target, true);
                minDate = this._getMinMaxDate(inst, "min");
                maxDate = this._getMinMaxDate(inst, "max");
                datepicker_extendRemove(inst.settings, settings);
                if (minDate !== null && settings.dateFormat !== undefined && settings.minDate === undefined) {
                    inst.settings.minDate = this._formatDate(inst, minDate);
                }
                if (maxDate !== null && settings.dateFormat !== undefined && settings.maxDate === undefined) {
                    inst.settings.maxDate = this._formatDate(inst, maxDate);
                }
                if ("disabled" in settings) {
                    if (settings.disabled) {
                        this._disableDatepicker(target);
                    } else {
                        this._enableDatepicker(target);
                    }
                }
                this._attachments($(target), inst);
                this._autoSize(inst);
                this._setDate(inst, date);
                this._updateAlternate(inst);
                this._updateDatepicker(inst);
            }
        },
        _changeDatepicker: function(target, name, value) {
            this._optionDatepicker(target, name, value);
        },
        _refreshDatepicker: function(target) {
            var inst = this._getInst(target);
            if (inst) {
                this._updateDatepicker(inst);
            }
        },
        _setDateDatepicker: function(target, date) {
            var inst = this._getInst(target);
            if (inst) {
                this._setDate(inst, date);
                this._updateDatepicker(inst);
                this._updateAlternate(inst);
            }
        },
        _getDateDatepicker: function(target, noDefault) {
            var inst = this._getInst(target);
            if (inst && !inst.inline) {
                this._setDateFromField(inst, noDefault);
            }
            return inst ? this._getDate(inst) : null;
        },
        _doKeyDown: function(event) {
            var onSelect, dateStr, sel, inst = $.datepicker._getInst(event.target), handled = true, isRTL = inst.dpDiv.is(".ui-datepicker-rtl");
            inst._keyEvent = true;
            if ($.datepicker._datepickerShowing) {
                switch (event.keyCode) {
                  case 9:
                    $.datepicker._hideDatepicker();
                    handled = false;
                    break;

                  case 13:
                    sel = $("td." + $.datepicker._dayOverClass + ":not(." + $.datepicker._currentClass + ")", inst.dpDiv);
                    if (sel[0]) {
                        $.datepicker._selectDay(event.target, inst.selectedMonth, inst.selectedYear, sel[0]);
                    }
                    onSelect = $.datepicker._get(inst, "onSelect");
                    if (onSelect) {
                        dateStr = $.datepicker._formatDate(inst);
                        onSelect.apply(inst.input ? inst.input[0] : null, [ dateStr, inst ]);
                    } else {
                        $.datepicker._hideDatepicker();
                    }
                    return false;

                  case 27:
                    $.datepicker._hideDatepicker();
                    break;

                  case 33:
                    $.datepicker._adjustDate(event.target, event.ctrlKey ? -$.datepicker._get(inst, "stepBigMonths") : -$.datepicker._get(inst, "stepMonths"), "M");
                    break;

                  case 34:
                    $.datepicker._adjustDate(event.target, event.ctrlKey ? +$.datepicker._get(inst, "stepBigMonths") : +$.datepicker._get(inst, "stepMonths"), "M");
                    break;

                  case 35:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._clearDate(event.target);
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 36:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._gotoToday(event.target);
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 37:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, isRTL ? +1 : -1, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    if (event.originalEvent.altKey) {
                        $.datepicker._adjustDate(event.target, event.ctrlKey ? -$.datepicker._get(inst, "stepBigMonths") : -$.datepicker._get(inst, "stepMonths"), "M");
                    }
                    break;

                  case 38:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, -7, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  case 39:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, isRTL ? -1 : +1, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    if (event.originalEvent.altKey) {
                        $.datepicker._adjustDate(event.target, event.ctrlKey ? +$.datepicker._get(inst, "stepBigMonths") : +$.datepicker._get(inst, "stepMonths"), "M");
                    }
                    break;

                  case 40:
                    if (event.ctrlKey || event.metaKey) {
                        $.datepicker._adjustDate(event.target, +7, "D");
                    }
                    handled = event.ctrlKey || event.metaKey;
                    break;

                  default:
                    handled = false;
                }
            } else if (event.keyCode === 36 && event.ctrlKey) {
                $.datepicker._showDatepicker(this);
            } else {
                handled = false;
            }
            if (handled) {
                event.preventDefault();
                event.stopPropagation();
            }
        },
        _doKeyPress: function(event) {
            var chars, chr, inst = $.datepicker._getInst(event.target);
            if ($.datepicker._get(inst, "constrainInput")) {
                chars = $.datepicker._possibleChars($.datepicker._get(inst, "dateFormat"));
                chr = String.fromCharCode(event.charCode == null ? event.keyCode : event.charCode);
                return event.ctrlKey || event.metaKey || (chr < " " || !chars || chars.indexOf(chr) > -1);
            }
        },
        _doKeyUp: function(event) {
            var date, inst = $.datepicker._getInst(event.target);
            if (inst.input.val() !== inst.lastVal) {
                try {
                    date = $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"), inst.input ? inst.input.val() : null, $.datepicker._getFormatConfig(inst));
                    if (date) {
                        $.datepicker._setDateFromField(inst);
                        $.datepicker._updateAlternate(inst);
                        $.datepicker._updateDatepicker(inst);
                    }
                } catch (err) {}
            }
            return true;
        },
        _showDatepicker: function(input) {
            input = input.target || input;
            if (input.nodeName.toLowerCase() !== "input") {
                input = $("input", input.parentNode)[0];
            }
            if ($.datepicker._isDisabledDatepicker(input) || $.datepicker._lastInput === input) {
                return;
            }
            var inst, beforeShow, beforeShowSettings, isFixed, offset, showAnim, duration;
            inst = $.datepicker._getInst(input);
            if ($.datepicker._curInst && $.datepicker._curInst !== inst) {
                $.datepicker._curInst.dpDiv.stop(true, true);
                if (inst && $.datepicker._datepickerShowing) {
                    $.datepicker._hideDatepicker($.datepicker._curInst.input[0]);
                }
            }
            beforeShow = $.datepicker._get(inst, "beforeShow");
            beforeShowSettings = beforeShow ? beforeShow.apply(input, [ input, inst ]) : {};
            if (beforeShowSettings === false) {
                return;
            }
            datepicker_extendRemove(inst.settings, beforeShowSettings);
            inst.lastVal = null;
            $.datepicker._lastInput = input;
            $.datepicker._setDateFromField(inst);
            if ($.datepicker._inDialog) {
                input.value = "";
            }
            if (!$.datepicker._pos) {
                $.datepicker._pos = $.datepicker._findPos(input);
                $.datepicker._pos[1] += input.offsetHeight;
            }
            isFixed = false;
            $(input).parents().each(function() {
                isFixed |= $(this).css("position") === "fixed";
                return !isFixed;
            });
            offset = {
                left: $.datepicker._pos[0],
                top: $.datepicker._pos[1]
            };
            $.datepicker._pos = null;
            inst.dpDiv.empty();
            inst.dpDiv.css({
                position: "absolute",
                display: "block",
                top: "-1000px"
            });
            $.datepicker._updateDatepicker(inst);
            offset = $.datepicker._checkOffset(inst, offset, isFixed);
            inst.dpDiv.css({
                position: $.datepicker._inDialog && $.blockUI ? "static" : isFixed ? "fixed" : "absolute",
                display: "none",
                left: offset.left + "px",
                top: offset.top + "px"
            });
            if (!inst.inline) {
                showAnim = $.datepicker._get(inst, "showAnim");
                duration = $.datepicker._get(inst, "duration");
                inst.dpDiv.css("z-index", datepicker_getZindex($(input)) + 1);
                $.datepicker._datepickerShowing = true;
                if ($.effects && $.effects.effect[showAnim]) {
                    inst.dpDiv.show(showAnim, $.datepicker._get(inst, "showOptions"), duration);
                } else {
                    inst.dpDiv[showAnim || "show"](showAnim ? duration : null);
                }
                if ($.datepicker._shouldFocusInput(inst)) {
                    inst.input.focus();
                }
                $.datepicker._curInst = inst;
            }
        },
        _updateDatepicker: function(inst) {
            this.maxRows = 4;
            datepicker_instActive = inst;
            inst.dpDiv.empty().append(this._generateHTML(inst));
            this._attachHandlers(inst);
            var origyearshtml, numMonths = this._getNumberOfMonths(inst), cols = numMonths[1], width = 17, activeCell = inst.dpDiv.find("." + this._dayOverClass + " a");
            if (activeCell.length > 0) {
                datepicker_handleMouseover.apply(activeCell.get(0));
            }
            inst.dpDiv.removeClass("ui-datepicker-multi-2 ui-datepicker-multi-3 ui-datepicker-multi-4").width("");
            if (cols > 1) {
                inst.dpDiv.addClass("ui-datepicker-multi-" + cols).css("width", width * cols + "em");
            }
            inst.dpDiv[(numMonths[0] !== 1 || numMonths[1] !== 1 ? "add" : "remove") + "Class"]("ui-datepicker-multi");
            inst.dpDiv[(this._get(inst, "isRTL") ? "add" : "remove") + "Class"]("ui-datepicker-rtl");
            if (inst === $.datepicker._curInst && $.datepicker._datepickerShowing && $.datepicker._shouldFocusInput(inst)) {
                inst.input.focus();
            }
            if (inst.yearshtml) {
                origyearshtml = inst.yearshtml;
                setTimeout(function() {
                    if (origyearshtml === inst.yearshtml && inst.yearshtml) {
                        inst.dpDiv.find("select.ui-datepicker-year:first").replaceWith(inst.yearshtml);
                    }
                    origyearshtml = inst.yearshtml = null;
                }, 0);
            }
        },
        _shouldFocusInput: function(inst) {
            return inst.input && inst.input.is(":visible") && !inst.input.is(":disabled") && !inst.input.is(":focus");
        },
        _checkOffset: function(inst, offset, isFixed) {
            var dpWidth = inst.dpDiv.outerWidth(), dpHeight = inst.dpDiv.outerHeight(), inputWidth = inst.input ? inst.input.outerWidth() : 0, inputHeight = inst.input ? inst.input.outerHeight() : 0, viewWidth = document.documentElement.clientWidth + (isFixed ? 0 : $(document).scrollLeft()), viewHeight = document.documentElement.clientHeight + (isFixed ? 0 : $(document).scrollTop());
            offset.left -= this._get(inst, "isRTL") ? dpWidth - inputWidth : 0;
            offset.left -= isFixed && offset.left === inst.input.offset().left ? $(document).scrollLeft() : 0;
            offset.top -= isFixed && offset.top === inst.input.offset().top + inputHeight ? $(document).scrollTop() : 0;
            offset.left -= Math.min(offset.left, offset.left + dpWidth > viewWidth && viewWidth > dpWidth ? Math.abs(offset.left + dpWidth - viewWidth) : 0);
            offset.top -= Math.min(offset.top, offset.top + dpHeight > viewHeight && viewHeight > dpHeight ? Math.abs(dpHeight + inputHeight) : 0);
            return offset;
        },
        _findPos: function(obj) {
            var position, inst = this._getInst(obj), isRTL = this._get(inst, "isRTL");
            while (obj && (obj.type === "hidden" || obj.nodeType !== 1 || $.expr.filters.hidden(obj))) {
                obj = obj[isRTL ? "previousSibling" : "nextSibling"];
            }
            position = $(obj).offset();
            return [ position.left, position.top ];
        },
        _hideDatepicker: function(input) {
            var showAnim, duration, postProcess, onClose, inst = this._curInst;
            if (!inst || input && inst !== $.data(input, "datepicker")) {
                return;
            }
            if (this._datepickerShowing) {
                showAnim = this._get(inst, "showAnim");
                duration = this._get(inst, "duration");
                postProcess = function() {
                    $.datepicker._tidyDialog(inst);
                };
                if ($.effects && ($.effects.effect[showAnim] || $.effects[showAnim])) {
                    inst.dpDiv.hide(showAnim, $.datepicker._get(inst, "showOptions"), duration, postProcess);
                } else {
                    inst.dpDiv[showAnim === "slideDown" ? "slideUp" : showAnim === "fadeIn" ? "fadeOut" : "hide"](showAnim ? duration : null, postProcess);
                }
                if (!showAnim) {
                    postProcess();
                }
                this._datepickerShowing = false;
                onClose = this._get(inst, "onClose");
                if (onClose) {
                    onClose.apply(inst.input ? inst.input[0] : null, [ inst.input ? inst.input.val() : "", inst ]);
                }
                this._lastInput = null;
                if (this._inDialog) {
                    this._dialogInput.css({
                        position: "absolute",
                        left: "0",
                        top: "-100px"
                    });
                    if ($.blockUI) {
                        $.unblockUI();
                        $("body").append(this.dpDiv);
                    }
                }
                this._inDialog = false;
            }
        },
        _tidyDialog: function(inst) {
            inst.dpDiv.removeClass(this._dialogClass).unbind(".ui-datepicker-calendar");
        },
        _checkExternalClick: function(event) {
            if (!$.datepicker._curInst) {
                return;
            }
            var $target = $(event.target), inst = $.datepicker._getInst($target[0]);
            if ($target[0].id !== $.datepicker._mainDivId && $target.parents("#" + $.datepicker._mainDivId).length === 0 && !$target.hasClass($.datepicker.markerClassName) && !$target.closest("." + $.datepicker._triggerClass).length && $.datepicker._datepickerShowing && !($.datepicker._inDialog && $.blockUI) || $target.hasClass($.datepicker.markerClassName) && $.datepicker._curInst !== inst) {
                $.datepicker._hideDatepicker();
            }
        },
        _adjustDate: function(id, offset, period) {
            var target = $(id), inst = this._getInst(target[0]);
            if (this._isDisabledDatepicker(target[0])) {
                return;
            }
            this._adjustInstDate(inst, offset + (period === "M" ? this._get(inst, "showCurrentAtPos") : 0), period);
            this._updateDatepicker(inst);
        },
        _gotoToday: function(id) {
            var date, target = $(id), inst = this._getInst(target[0]);
            if (this._get(inst, "gotoCurrent") && inst.currentDay) {
                inst.selectedDay = inst.currentDay;
                inst.drawMonth = inst.selectedMonth = inst.currentMonth;
                inst.drawYear = inst.selectedYear = inst.currentYear;
            } else {
                date = new Date();
                inst.selectedDay = date.getDate();
                inst.drawMonth = inst.selectedMonth = date.getMonth();
                inst.drawYear = inst.selectedYear = date.getFullYear();
            }
            this._notifyChange(inst);
            this._adjustDate(target);
        },
        _selectMonthYear: function(id, select, period) {
            var target = $(id), inst = this._getInst(target[0]);
            inst["selected" + (period === "M" ? "Month" : "Year")] = inst["draw" + (period === "M" ? "Month" : "Year")] = parseInt(select.options[select.selectedIndex].value, 10);
            this._notifyChange(inst);
            this._adjustDate(target);
        },
        _selectDay: function(id, month, year, td) {
            var inst, target = $(id);
            if ($(td).hasClass(this._unselectableClass) || this._isDisabledDatepicker(target[0])) {
                return;
            }
            inst = this._getInst(target[0]);
            inst.selectedDay = inst.currentDay = $("a", td).html();
            inst.selectedMonth = inst.currentMonth = month;
            inst.selectedYear = inst.currentYear = year;
            this._selectDate(id, this._formatDate(inst, inst.currentDay, inst.currentMonth, inst.currentYear));
        },
        _clearDate: function(id) {
            var target = $(id);
            this._selectDate(target, "");
        },
        _selectDate: function(id, dateStr) {
            var onSelect, target = $(id), inst = this._getInst(target[0]);
            dateStr = dateStr != null ? dateStr : this._formatDate(inst);
            if (inst.input) {
                inst.input.val(dateStr);
            }
            this._updateAlternate(inst);
            onSelect = this._get(inst, "onSelect");
            if (onSelect) {
                onSelect.apply(inst.input ? inst.input[0] : null, [ dateStr, inst ]);
            } else if (inst.input) {
                inst.input.trigger("change");
            }
            if (inst.inline) {
                this._updateDatepicker(inst);
            } else {
                this._hideDatepicker();
                this._lastInput = inst.input[0];
                if (typeof inst.input[0] !== "object") {
                    inst.input.focus();
                }
                this._lastInput = null;
            }
        },
        _updateAlternate: function(inst) {
            var altFormat, date, dateStr, altField = this._get(inst, "altField");
            if (altField) {
                altFormat = this._get(inst, "altFormat") || this._get(inst, "dateFormat");
                date = this._getDate(inst);
                dateStr = this.formatDate(altFormat, date, this._getFormatConfig(inst));
                $(altField).each(function() {
                    $(this).val(dateStr);
                });
            }
        },
        noWeekends: function(date) {
            var day = date.getDay();
            return [ day > 0 && day < 6, "" ];
        },
        iso8601Week: function(date) {
            var time, checkDate = new Date(date.getTime());
            checkDate.setDate(checkDate.getDate() + 4 - (checkDate.getDay() || 7));
            time = checkDate.getTime();
            checkDate.setMonth(0);
            checkDate.setDate(1);
            return Math.floor(Math.round((time - checkDate) / 864e5) / 7) + 1;
        },
        parseDate: function(format, value, settings) {
            if (format == null || value == null) {
                throw "Invalid arguments";
            }
            value = typeof value === "object" ? value.toString() : value + "";
            if (value === "") {
                return null;
            }
            var iFormat, dim, extra, iValue = 0, shortYearCutoffTemp = (settings ? settings.shortYearCutoff : null) || this._defaults.shortYearCutoff, shortYearCutoff = typeof shortYearCutoffTemp !== "string" ? shortYearCutoffTemp : new Date().getFullYear() % 100 + parseInt(shortYearCutoffTemp, 10), dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort, dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames, monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort, monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames, year = -1, month = -1, day = -1, doy = -1, literal = false, date, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            }, getNumber = function(match) {
                var isDoubled = lookAhead(match), size = match === "@" ? 14 : match === "!" ? 20 : match === "y" && isDoubled ? 4 : match === "o" ? 3 : 2, minSize = match === "y" ? size : 1, digits = new RegExp("^\\d{" + minSize + "," + size + "}"), num = value.substring(iValue).match(digits);
                if (!num) {
                    throw "Missing number at position " + iValue;
                }
                iValue += num[0].length;
                return parseInt(num[0], 10);
            }, getName = function(match, shortNames, longNames) {
                var index = -1, names = $.map(lookAhead(match) ? longNames : shortNames, function(v, k) {
                    return [ [ k, v ] ];
                }).sort(function(a, b) {
                    return -(a[1].length - b[1].length);
                });
                $.each(names, function(i, pair) {
                    var name = pair[1];
                    if (value.substr(iValue, name.length).toLowerCase() === name.toLowerCase()) {
                        index = pair[0];
                        iValue += name.length;
                        return false;
                    }
                });
                if (index !== -1) {
                    return index + 1;
                } else {
                    throw "Unknown name at position " + iValue;
                }
            }, checkLiteral = function() {
                if (value.charAt(iValue) !== format.charAt(iFormat)) {
                    throw "Unexpected literal at position " + iValue;
                }
                iValue++;
            };
            for (iFormat = 0; iFormat < format.length; iFormat++) {
                if (literal) {
                    if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                        literal = false;
                    } else {
                        checkLiteral();
                    }
                } else {
                    switch (format.charAt(iFormat)) {
                      case "d":
                        day = getNumber("d");
                        break;

                      case "D":
                        getName("D", dayNamesShort, dayNames);
                        break;

                      case "o":
                        doy = getNumber("o");
                        break;

                      case "m":
                        month = getNumber("m");
                        break;

                      case "M":
                        month = getName("M", monthNamesShort, monthNames);
                        break;

                      case "y":
                        year = getNumber("y");
                        break;

                      case "@":
                        date = new Date(getNumber("@"));
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        day = date.getDate();
                        break;

                      case "!":
                        date = new Date((getNumber("!") - this._ticksTo1970) / 1e4);
                        year = date.getFullYear();
                        month = date.getMonth() + 1;
                        day = date.getDate();
                        break;

                      case "'":
                        if (lookAhead("'")) {
                            checkLiteral();
                        } else {
                            literal = true;
                        }
                        break;

                      default:
                        checkLiteral();
                    }
                }
            }
            if (iValue < value.length) {
                extra = value.substr(iValue);
                if (!/^\s+/.test(extra)) {
                    throw "Extra/unparsed characters found in date: " + extra;
                }
            }
            if (year === -1) {
                year = new Date().getFullYear();
            } else if (year < 100) {
                year += new Date().getFullYear() - new Date().getFullYear() % 100 + (year <= shortYearCutoff ? 0 : -100);
            }
            if (doy > -1) {
                month = 1;
                day = doy;
                do {
                    dim = this._getDaysInMonth(year, month - 1);
                    if (day <= dim) {
                        break;
                    }
                    month++;
                    day -= dim;
                } while (true);
            }
            date = this._daylightSavingAdjust(new Date(year, month - 1, day));
            if (date.getFullYear() !== year || date.getMonth() + 1 !== month || date.getDate() !== day) {
                throw "Invalid date";
            }
            return date;
        },
        ATOM: "yy-mm-dd",
        COOKIE: "D, dd M yy",
        ISO_8601: "yy-mm-dd",
        RFC_822: "D, d M y",
        RFC_850: "DD, dd-M-y",
        RFC_1036: "D, d M y",
        RFC_1123: "D, d M yy",
        RFC_2822: "D, d M yy",
        RSS: "D, d M y",
        TICKS: "!",
        TIMESTAMP: "@",
        W3C: "yy-mm-dd",
        _ticksTo1970: ((1970 - 1) * 365 + Math.floor(1970 / 4) - Math.floor(1970 / 100) + Math.floor(1970 / 400)) * 24 * 60 * 60 * 1e7,
        formatDate: function(format, date, settings) {
            if (!date) {
                return "";
            }
            var iFormat, dayNamesShort = (settings ? settings.dayNamesShort : null) || this._defaults.dayNamesShort, dayNames = (settings ? settings.dayNames : null) || this._defaults.dayNames, monthNamesShort = (settings ? settings.monthNamesShort : null) || this._defaults.monthNamesShort, monthNames = (settings ? settings.monthNames : null) || this._defaults.monthNames, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            }, formatNumber = function(match, value, len) {
                var num = "" + value;
                if (lookAhead(match)) {
                    while (num.length < len) {
                        num = "0" + num;
                    }
                }
                return num;
            }, formatName = function(match, value, shortNames, longNames) {
                return lookAhead(match) ? longNames[value] : shortNames[value];
            }, output = "", literal = false;
            if (date) {
                for (iFormat = 0; iFormat < format.length; iFormat++) {
                    if (literal) {
                        if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                            literal = false;
                        } else {
                            output += format.charAt(iFormat);
                        }
                    } else {
                        switch (format.charAt(iFormat)) {
                          case "d":
                            output += formatNumber("d", date.getDate(), 2);
                            break;

                          case "D":
                            output += formatName("D", date.getDay(), dayNamesShort, dayNames);
                            break;

                          case "o":
                            output += formatNumber("o", Math.round((new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime() - new Date(date.getFullYear(), 0, 0).getTime()) / 864e5), 3);
                            break;

                          case "m":
                            output += formatNumber("m", date.getMonth() + 1, 2);
                            break;

                          case "M":
                            output += formatName("M", date.getMonth(), monthNamesShort, monthNames);
                            break;

                          case "y":
                            output += lookAhead("y") ? date.getFullYear() : (date.getYear() % 100 < 10 ? "0" : "") + date.getYear() % 100;
                            break;

                          case "@":
                            output += date.getTime();
                            break;

                          case "!":
                            output += date.getTime() * 1e4 + this._ticksTo1970;
                            break;

                          case "'":
                            if (lookAhead("'")) {
                                output += "'";
                            } else {
                                literal = true;
                            }
                            break;

                          default:
                            output += format.charAt(iFormat);
                        }
                    }
                }
            }
            return output;
        },
        _possibleChars: function(format) {
            var iFormat, chars = "", literal = false, lookAhead = function(match) {
                var matches = iFormat + 1 < format.length && format.charAt(iFormat + 1) === match;
                if (matches) {
                    iFormat++;
                }
                return matches;
            };
            for (iFormat = 0; iFormat < format.length; iFormat++) {
                if (literal) {
                    if (format.charAt(iFormat) === "'" && !lookAhead("'")) {
                        literal = false;
                    } else {
                        chars += format.charAt(iFormat);
                    }
                } else {
                    switch (format.charAt(iFormat)) {
                      case "d":
                      case "m":
                      case "y":
                      case "@":
                        chars += "0123456789";
                        break;

                      case "D":
                      case "M":
                        return null;

                      case "'":
                        if (lookAhead("'")) {
                            chars += "'";
                        } else {
                            literal = true;
                        }
                        break;

                      default:
                        chars += format.charAt(iFormat);
                    }
                }
            }
            return chars;
        },
        _get: function(inst, name) {
            return inst.settings[name] !== undefined ? inst.settings[name] : this._defaults[name];
        },
        _setDateFromField: function(inst, noDefault) {
            if (inst.input.val() === inst.lastVal) {
                return;
            }
            var dateFormat = this._get(inst, "dateFormat"), dates = inst.lastVal = inst.input ? inst.input.val() : null, defaultDate = this._getDefaultDate(inst), date = defaultDate, settings = this._getFormatConfig(inst);
            try {
                date = this.parseDate(dateFormat, dates, settings) || defaultDate;
            } catch (event) {
                dates = noDefault ? "" : dates;
            }
            inst.selectedDay = date.getDate();
            inst.drawMonth = inst.selectedMonth = date.getMonth();
            inst.drawYear = inst.selectedYear = date.getFullYear();
            inst.currentDay = dates ? date.getDate() : 0;
            inst.currentMonth = dates ? date.getMonth() : 0;
            inst.currentYear = dates ? date.getFullYear() : 0;
            this._adjustInstDate(inst);
        },
        _getDefaultDate: function(inst) {
            return this._restrictMinMax(inst, this._determineDate(inst, this._get(inst, "defaultDate"), new Date()));
        },
        _determineDate: function(inst, date, defaultDate) {
            var offsetNumeric = function(offset) {
                var date = new Date();
                date.setDate(date.getDate() + offset);
                return date;
            }, offsetString = function(offset) {
                try {
                    return $.datepicker.parseDate($.datepicker._get(inst, "dateFormat"), offset, $.datepicker._getFormatConfig(inst));
                } catch (e) {}
                var date = (offset.toLowerCase().match(/^c/) ? $.datepicker._getDate(inst) : null) || new Date(), year = date.getFullYear(), month = date.getMonth(), day = date.getDate(), pattern = /([+\-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g, matches = pattern.exec(offset);
                while (matches) {
                    switch (matches[2] || "d") {
                      case "d":
                      case "D":
                        day += parseInt(matches[1], 10);
                        break;

                      case "w":
                      case "W":
                        day += parseInt(matches[1], 10) * 7;
                        break;

                      case "m":
                      case "M":
                        month += parseInt(matches[1], 10);
                        day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
                        break;

                      case "y":
                      case "Y":
                        year += parseInt(matches[1], 10);
                        day = Math.min(day, $.datepicker._getDaysInMonth(year, month));
                        break;
                    }
                    matches = pattern.exec(offset);
                }
                return new Date(year, month, day);
            }, newDate = date == null || date === "" ? defaultDate : typeof date === "string" ? offsetString(date) : typeof date === "number" ? isNaN(date) ? defaultDate : offsetNumeric(date) : new Date(date.getTime());
            newDate = newDate && newDate.toString() === "Invalid Date" ? defaultDate : newDate;
            if (newDate) {
                newDate.setHours(0);
                newDate.setMinutes(0);
                newDate.setSeconds(0);
                newDate.setMilliseconds(0);
            }
            return this._daylightSavingAdjust(newDate);
        },
        _daylightSavingAdjust: function(date) {
            if (!date) {
                return null;
            }
            date.setHours(date.getHours() > 12 ? date.getHours() + 2 : 0);
            return date;
        },
        _setDate: function(inst, date, noChange) {
            var clear = !date, origMonth = inst.selectedMonth, origYear = inst.selectedYear, newDate = this._restrictMinMax(inst, this._determineDate(inst, date, new Date()));
            inst.selectedDay = inst.currentDay = newDate.getDate();
            inst.drawMonth = inst.selectedMonth = inst.currentMonth = newDate.getMonth();
            inst.drawYear = inst.selectedYear = inst.currentYear = newDate.getFullYear();
            if ((origMonth !== inst.selectedMonth || origYear !== inst.selectedYear) && !noChange) {
                this._notifyChange(inst);
            }
            this._adjustInstDate(inst);
            if (inst.input) {
                inst.input.val(clear ? "" : this._formatDate(inst));
            }
        },
        _getDate: function(inst) {
            var startDate = !inst.currentYear || inst.input && inst.input.val() === "" ? null : this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay));
            return startDate;
        },
        _attachHandlers: function(inst) {
            var stepMonths = this._get(inst, "stepMonths"), id = "#" + inst.id.replace(/\\\\/g, "\\");
            inst.dpDiv.find("[data-handler]").map(function() {
                var handler = {
                    prev: function() {
                        $.datepicker._adjustDate(id, -stepMonths, "M");
                    },
                    next: function() {
                        $.datepicker._adjustDate(id, +stepMonths, "M");
                    },
                    hide: function() {
                        $.datepicker._hideDatepicker();
                    },
                    today: function() {
                        $.datepicker._gotoToday(id);
                    },
                    selectDay: function() {
                        $.datepicker._selectDay(id, +this.getAttribute("data-month"), +this.getAttribute("data-year"), this);
                        return false;
                    },
                    selectMonth: function() {
                        $.datepicker._selectMonthYear(id, this, "M");
                        return false;
                    },
                    selectYear: function() {
                        $.datepicker._selectMonthYear(id, this, "Y");
                        return false;
                    }
                };
                $(this).bind(this.getAttribute("data-event"), handler[this.getAttribute("data-handler")]);
            });
        },
        _generateHTML: function(inst) {
            var maxDraw, prevText, prev, nextText, next, currentText, gotoDate, controls, buttonPanel, firstDay, showWeek, dayNames, dayNamesMin, monthNames, monthNamesShort, beforeShowDay, showOtherMonths, selectOtherMonths, defaultDate, html, dow, row, group, col, selectedDate, cornerClass, calender, thead, day, daysInMonth, leadDays, curRows, numRows, printDate, dRow, tbody, daySettings, otherMonth, unselectable, tempDate = new Date(), today = this._daylightSavingAdjust(new Date(tempDate.getFullYear(), tempDate.getMonth(), tempDate.getDate())), isRTL = this._get(inst, "isRTL"), showButtonPanel = this._get(inst, "showButtonPanel"), hideIfNoPrevNext = this._get(inst, "hideIfNoPrevNext"), navigationAsDateFormat = this._get(inst, "navigationAsDateFormat"), numMonths = this._getNumberOfMonths(inst), showCurrentAtPos = this._get(inst, "showCurrentAtPos"), stepMonths = this._get(inst, "stepMonths"), isMultiMonth = numMonths[0] !== 1 || numMonths[1] !== 1, currentDate = this._daylightSavingAdjust(!inst.currentDay ? new Date(9999, 9, 9) : new Date(inst.currentYear, inst.currentMonth, inst.currentDay)), minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), drawMonth = inst.drawMonth - showCurrentAtPos, drawYear = inst.drawYear;
            if (drawMonth < 0) {
                drawMonth += 12;
                drawYear--;
            }
            if (maxDate) {
                maxDraw = this._daylightSavingAdjust(new Date(maxDate.getFullYear(), maxDate.getMonth() - numMonths[0] * numMonths[1] + 1, maxDate.getDate()));
                maxDraw = minDate && maxDraw < minDate ? minDate : maxDraw;
                while (this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1)) > maxDraw) {
                    drawMonth--;
                    if (drawMonth < 0) {
                        drawMonth = 11;
                        drawYear--;
                    }
                }
            }
            inst.drawMonth = drawMonth;
            inst.drawYear = drawYear;
            prevText = this._get(inst, "prevText");
            prevText = !navigationAsDateFormat ? prevText : this.formatDate(prevText, this._daylightSavingAdjust(new Date(drawYear, drawMonth - stepMonths, 1)), this._getFormatConfig(inst));
            prev = this._canAdjustMonth(inst, -1, drawYear, drawMonth) ? "<a class='ui-datepicker-prev ui-corner-all' data-handler='prev' data-event='click'" + " title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "e" : "w") + "'>" + prevText + "</span></a>" : hideIfNoPrevNext ? "" : "<a class='ui-datepicker-prev ui-corner-all ui-state-disabled' title='" + prevText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "e" : "w") + "'>" + prevText + "</span></a>";
            nextText = this._get(inst, "nextText");
            nextText = !navigationAsDateFormat ? nextText : this.formatDate(nextText, this._daylightSavingAdjust(new Date(drawYear, drawMonth + stepMonths, 1)), this._getFormatConfig(inst));
            next = this._canAdjustMonth(inst, +1, drawYear, drawMonth) ? "<a class='ui-datepicker-next ui-corner-all' data-handler='next' data-event='click'" + " title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "w" : "e") + "'>" + nextText + "</span></a>" : hideIfNoPrevNext ? "" : "<a class='ui-datepicker-next ui-corner-all ui-state-disabled' title='" + nextText + "'><span class='ui-icon ui-icon-circle-triangle-" + (isRTL ? "w" : "e") + "'>" + nextText + "</span></a>";
            currentText = this._get(inst, "currentText");
            gotoDate = this._get(inst, "gotoCurrent") && inst.currentDay ? currentDate : today;
            currentText = !navigationAsDateFormat ? currentText : this.formatDate(currentText, gotoDate, this._getFormatConfig(inst));
            controls = !inst.inline ? "<button type='button' class='ui-datepicker-close ui-state-default ui-priority-primary ui-corner-all' data-handler='hide' data-event='click'>" + this._get(inst, "closeText") + "</button>" : "";
            buttonPanel = showButtonPanel ? "<div class='ui-datepicker-buttonpane ui-widget-content'>" + (isRTL ? controls : "") + (this._isInRange(inst, gotoDate) ? "<button type='button' class='ui-datepicker-current ui-state-default ui-priority-secondary ui-corner-all' data-handler='today' data-event='click'" + ">" + currentText + "</button>" : "") + (isRTL ? "" : controls) + "</div>" : "";
            firstDay = parseInt(this._get(inst, "firstDay"), 10);
            firstDay = isNaN(firstDay) ? 0 : firstDay;
            showWeek = this._get(inst, "showWeek");
            dayNames = this._get(inst, "dayNames");
            dayNamesMin = this._get(inst, "dayNamesMin");
            monthNames = this._get(inst, "monthNames");
            monthNamesShort = this._get(inst, "monthNamesShort");
            beforeShowDay = this._get(inst, "beforeShowDay");
            showOtherMonths = this._get(inst, "showOtherMonths");
            selectOtherMonths = this._get(inst, "selectOtherMonths");
            defaultDate = this._getDefaultDate(inst);
            html = "";
            dow;
            for (row = 0; row < numMonths[0]; row++) {
                group = "";
                this.maxRows = 4;
                for (col = 0; col < numMonths[1]; col++) {
                    selectedDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, inst.selectedDay));
                    cornerClass = " ui-corner-all";
                    calender = "";
                    if (isMultiMonth) {
                        calender += "<div class='ui-datepicker-group";
                        if (numMonths[1] > 1) {
                            switch (col) {
                              case 0:
                                calender += " ui-datepicker-group-first";
                                cornerClass = " ui-corner-" + (isRTL ? "right" : "left");
                                break;

                              case numMonths[1] - 1:
                                calender += " ui-datepicker-group-last";
                                cornerClass = " ui-corner-" + (isRTL ? "left" : "right");
                                break;

                              default:
                                calender += " ui-datepicker-group-middle";
                                cornerClass = "";
                                break;
                            }
                        }
                        calender += "'>";
                    }
                    calender += "<div class='ui-datepicker-header ui-widget-header ui-helper-clearfix" + cornerClass + "'>" + (/all|left/.test(cornerClass) && row === 0 ? isRTL ? next : prev : "") + (/all|right/.test(cornerClass) && row === 0 ? isRTL ? prev : next : "") + this._generateMonthYearHeader(inst, drawMonth, drawYear, minDate, maxDate, row > 0 || col > 0, monthNames, monthNamesShort) + "</div><table class='ui-datepicker-calendar'><thead>" + "<tr>";
                    thead = showWeek ? "<th class='ui-datepicker-week-col'>" + this._get(inst, "weekHeader") + "</th>" : "";
                    for (dow = 0; dow < 7; dow++) {
                        day = (dow + firstDay) % 7;
                        thead += "<th scope='col'" + ((dow + firstDay + 6) % 7 >= 5 ? " class='ui-datepicker-week-end'" : "") + ">" + "<span title='" + dayNames[day] + "'>" + dayNamesMin[day] + "</span></th>";
                    }
                    calender += thead + "</tr></thead><tbody>";
                    daysInMonth = this._getDaysInMonth(drawYear, drawMonth);
                    if (drawYear === inst.selectedYear && drawMonth === inst.selectedMonth) {
                        inst.selectedDay = Math.min(inst.selectedDay, daysInMonth);
                    }
                    leadDays = (this._getFirstDayOfMonth(drawYear, drawMonth) - firstDay + 7) % 7;
                    curRows = Math.ceil((leadDays + daysInMonth) / 7);
                    numRows = isMultiMonth ? this.maxRows > curRows ? this.maxRows : curRows : curRows;
                    this.maxRows = numRows;
                    printDate = this._daylightSavingAdjust(new Date(drawYear, drawMonth, 1 - leadDays));
                    for (dRow = 0; dRow < numRows; dRow++) {
                        calender += "<tr>";
                        tbody = !showWeek ? "" : "<td class='ui-datepicker-week-col'>" + this._get(inst, "calculateWeek")(printDate) + "</td>";
                        for (dow = 0; dow < 7; dow++) {
                            daySettings = beforeShowDay ? beforeShowDay.apply(inst.input ? inst.input[0] : null, [ printDate ]) : [ true, "" ];
                            otherMonth = printDate.getMonth() !== drawMonth;
                            unselectable = otherMonth && !selectOtherMonths || !daySettings[0] || minDate && printDate < minDate || maxDate && printDate > maxDate;
                            tbody += "<td class='" + ((dow + firstDay + 6) % 7 >= 5 ? " ui-datepicker-week-end" : "") + (otherMonth ? " ui-datepicker-other-month" : "") + (printDate.getTime() === selectedDate.getTime() && drawMonth === inst.selectedMonth && inst._keyEvent || defaultDate.getTime() === printDate.getTime() && defaultDate.getTime() === selectedDate.getTime() ? " " + this._dayOverClass : "") + (unselectable ? " " + this._unselectableClass + " ui-state-disabled" : "") + (otherMonth && !showOtherMonths ? "" : " " + daySettings[1] + (printDate.getTime() === currentDate.getTime() ? " " + this._currentClass : "") + (printDate.getTime() === today.getTime() ? " ui-datepicker-today" : "")) + "'" + ((!otherMonth || showOtherMonths) && daySettings[2] ? " title='" + daySettings[2].replace(/'/g, "&#39;") + "'" : "") + (unselectable ? "" : " data-handler='selectDay' data-event='click' data-month='" + printDate.getMonth() + "' data-year='" + printDate.getFullYear() + "'") + ">" + (otherMonth && !showOtherMonths ? "&#xa0;" : unselectable ? "<span class='ui-state-default'>" + printDate.getDate() + "</span>" : "<a class='ui-state-default" + (printDate.getTime() === today.getTime() ? " ui-state-highlight" : "") + (printDate.getTime() === currentDate.getTime() ? " ui-state-active" : "") + (otherMonth ? " ui-priority-secondary" : "") + "' href='#'>" + printDate.getDate() + "</a>") + "</td>";
                            printDate.setDate(printDate.getDate() + 1);
                            printDate = this._daylightSavingAdjust(printDate);
                        }
                        calender += tbody + "</tr>";
                    }
                    drawMonth++;
                    if (drawMonth > 11) {
                        drawMonth = 0;
                        drawYear++;
                    }
                    calender += "</tbody></table>" + (isMultiMonth ? "</div>" + (numMonths[0] > 0 && col === numMonths[1] - 1 ? "<div class='ui-datepicker-row-break'></div>" : "") : "");
                    group += calender;
                }
                html += group;
            }
            html += buttonPanel;
            inst._keyEvent = false;
            return html;
        },
        _generateMonthYearHeader: function(inst, drawMonth, drawYear, minDate, maxDate, secondary, monthNames, monthNamesShort) {
            var inMinYear, inMaxYear, month, years, thisYear, determineYear, year, endYear, changeMonth = this._get(inst, "changeMonth"), changeYear = this._get(inst, "changeYear"), showMonthAfterYear = this._get(inst, "showMonthAfterYear"), html = "<div class='ui-datepicker-title'>", monthHtml = "";
            if (secondary || !changeMonth) {
                monthHtml += "<span class='ui-datepicker-month'>" + monthNames[drawMonth] + "</span>";
            } else {
                inMinYear = minDate && minDate.getFullYear() === drawYear;
                inMaxYear = maxDate && maxDate.getFullYear() === drawYear;
                monthHtml += "<select class='ui-datepicker-month' data-handler='selectMonth' data-event='change'>";
                for (month = 0; month < 12; month++) {
                    if ((!inMinYear || month >= minDate.getMonth()) && (!inMaxYear || month <= maxDate.getMonth())) {
                        monthHtml += "<option value='" + month + "'" + (month === drawMonth ? " selected='selected'" : "") + ">" + monthNamesShort[month] + "</option>";
                    }
                }
                monthHtml += "</select>";
            }
            if (!showMonthAfterYear) {
                html += monthHtml + (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "");
            }
            if (!inst.yearshtml) {
                inst.yearshtml = "";
                if (secondary || !changeYear) {
                    html += "<span class='ui-datepicker-year'>" + drawYear + "</span>";
                } else {
                    years = this._get(inst, "yearRange").split(":");
                    thisYear = new Date().getFullYear();
                    determineYear = function(value) {
                        var year = value.match(/c[+\-].*/) ? drawYear + parseInt(value.substring(1), 10) : value.match(/[+\-].*/) ? thisYear + parseInt(value, 10) : parseInt(value, 10);
                        return isNaN(year) ? thisYear : year;
                    };
                    year = determineYear(years[0]);
                    endYear = Math.max(year, determineYear(years[1] || ""));
                    year = minDate ? Math.max(year, minDate.getFullYear()) : year;
                    endYear = maxDate ? Math.min(endYear, maxDate.getFullYear()) : endYear;
                    inst.yearshtml += "<select class='ui-datepicker-year' data-handler='selectYear' data-event='change'>";
                    for (;year <= endYear; year++) {
                        inst.yearshtml += "<option value='" + year + "'" + (year === drawYear ? " selected='selected'" : "") + ">" + year + "</option>";
                    }
                    inst.yearshtml += "</select>";
                    html += inst.yearshtml;
                    inst.yearshtml = null;
                }
            }
            html += this._get(inst, "yearSuffix");
            if (showMonthAfterYear) {
                html += (secondary || !(changeMonth && changeYear) ? "&#xa0;" : "") + monthHtml;
            }
            html += "</div>";
            return html;
        },
        _adjustInstDate: function(inst, offset, period) {
            var year = inst.drawYear + (period === "Y" ? offset : 0), month = inst.drawMonth + (period === "M" ? offset : 0), day = Math.min(inst.selectedDay, this._getDaysInMonth(year, month)) + (period === "D" ? offset : 0), date = this._restrictMinMax(inst, this._daylightSavingAdjust(new Date(year, month, day)));
            inst.selectedDay = date.getDate();
            inst.drawMonth = inst.selectedMonth = date.getMonth();
            inst.drawYear = inst.selectedYear = date.getFullYear();
            if (period === "M" || period === "Y") {
                this._notifyChange(inst);
            }
        },
        _restrictMinMax: function(inst, date) {
            var minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), newDate = minDate && date < minDate ? minDate : date;
            return maxDate && newDate > maxDate ? maxDate : newDate;
        },
        _notifyChange: function(inst) {
            var onChange = this._get(inst, "onChangeMonthYear");
            if (onChange) {
                onChange.apply(inst.input ? inst.input[0] : null, [ inst.selectedYear, inst.selectedMonth + 1, inst ]);
            }
        },
        _getNumberOfMonths: function(inst) {
            var numMonths = this._get(inst, "numberOfMonths");
            return numMonths == null ? [ 1, 1 ] : typeof numMonths === "number" ? [ 1, numMonths ] : numMonths;
        },
        _getMinMaxDate: function(inst, minMax) {
            return this._determineDate(inst, this._get(inst, minMax + "Date"), null);
        },
        _getDaysInMonth: function(year, month) {
            return 32 - this._daylightSavingAdjust(new Date(year, month, 32)).getDate();
        },
        _getFirstDayOfMonth: function(year, month) {
            return new Date(year, month, 1).getDay();
        },
        _canAdjustMonth: function(inst, offset, curYear, curMonth) {
            var numMonths = this._getNumberOfMonths(inst), date = this._daylightSavingAdjust(new Date(curYear, curMonth + (offset < 0 ? offset : numMonths[0] * numMonths[1]), 1));
            if (offset < 0) {
                date.setDate(this._getDaysInMonth(date.getFullYear(), date.getMonth()));
            }
            return this._isInRange(inst, date);
        },
        _isInRange: function(inst, date) {
            var yearSplit, currentYear, minDate = this._getMinMaxDate(inst, "min"), maxDate = this._getMinMaxDate(inst, "max"), minYear = null, maxYear = null, years = this._get(inst, "yearRange");
            if (years) {
                yearSplit = years.split(":");
                currentYear = new Date().getFullYear();
                minYear = parseInt(yearSplit[0], 10);
                maxYear = parseInt(yearSplit[1], 10);
                if (yearSplit[0].match(/[+\-].*/)) {
                    minYear += currentYear;
                }
                if (yearSplit[1].match(/[+\-].*/)) {
                    maxYear += currentYear;
                }
            }
            return (!minDate || date.getTime() >= minDate.getTime()) && (!maxDate || date.getTime() <= maxDate.getTime()) && (!minYear || date.getFullYear() >= minYear) && (!maxYear || date.getFullYear() <= maxYear);
        },
        _getFormatConfig: function(inst) {
            var shortYearCutoff = this._get(inst, "shortYearCutoff");
            shortYearCutoff = typeof shortYearCutoff !== "string" ? shortYearCutoff : new Date().getFullYear() % 100 + parseInt(shortYearCutoff, 10);
            return {
                shortYearCutoff: shortYearCutoff,
                dayNamesShort: this._get(inst, "dayNamesShort"),
                dayNames: this._get(inst, "dayNames"),
                monthNamesShort: this._get(inst, "monthNamesShort"),
                monthNames: this._get(inst, "monthNames")
            };
        },
        _formatDate: function(inst, day, month, year) {
            if (!day) {
                inst.currentDay = inst.selectedDay;
                inst.currentMonth = inst.selectedMonth;
                inst.currentYear = inst.selectedYear;
            }
            var date = day ? typeof day === "object" ? day : this._daylightSavingAdjust(new Date(year, month, day)) : this._daylightSavingAdjust(new Date(inst.currentYear, inst.currentMonth, inst.currentDay));
            return this.formatDate(this._get(inst, "dateFormat"), date, this._getFormatConfig(inst));
        }
    });
    function datepicker_bindHover(dpDiv) {
        var selector = "button, .ui-datepicker-prev, .ui-datepicker-next, .ui-datepicker-calendar td a";
        return dpDiv.delegate(selector, "mouseout", function() {
            $(this).removeClass("ui-state-hover");
            if (this.className.indexOf("ui-datepicker-prev") !== -1) {
                $(this).removeClass("ui-datepicker-prev-hover");
            }
            if (this.className.indexOf("ui-datepicker-next") !== -1) {
                $(this).removeClass("ui-datepicker-next-hover");
            }
        }).delegate(selector, "mouseover", datepicker_handleMouseover);
    }
    function datepicker_handleMouseover() {
        if (!$.datepicker._isDisabledDatepicker(datepicker_instActive.inline ? datepicker_instActive.dpDiv.parent()[0] : datepicker_instActive.input[0])) {
            $(this).parents(".ui-datepicker-calendar").find("a").removeClass("ui-state-hover");
            $(this).addClass("ui-state-hover");
            if (this.className.indexOf("ui-datepicker-prev") !== -1) {
                $(this).addClass("ui-datepicker-prev-hover");
            }
            if (this.className.indexOf("ui-datepicker-next") !== -1) {
                $(this).addClass("ui-datepicker-next-hover");
            }
        }
    }
    function datepicker_extendRemove(target, props) {
        $.extend(target, props);
        for (var name in props) {
            if (props[name] == null) {
                target[name] = props[name];
            }
        }
        return target;
    }
    $.fn.datepicker = function(options) {
        if (!this.length) {
            return this;
        }
        if (!$.datepicker.initialized) {
            $(document).mousedown($.datepicker._checkExternalClick);
            $.datepicker.initialized = true;
        }
        if ($("#" + $.datepicker._mainDivId).length === 0) {
            $("body").append($.datepicker.dpDiv);
        }
        var otherArgs = Array.prototype.slice.call(arguments, 1);
        if (typeof options === "string" && (options === "isDisabled" || options === "getDate" || options === "widget")) {
            return $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this[0] ].concat(otherArgs));
        }
        if (options === "option" && arguments.length === 2 && typeof arguments[1] === "string") {
            return $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this[0] ].concat(otherArgs));
        }
        return this.each(function() {
            typeof options === "string" ? $.datepicker["_" + options + "Datepicker"].apply($.datepicker, [ this ].concat(otherArgs)) : $.datepicker._attachDatepicker(this, options);
        });
    };
    $.datepicker = new Datepicker();
    $.datepicker.initialized = false;
    $.datepicker.uuid = new Date().getTime();
    $.datepicker.version = "1.11.4";
    var datepicker = $.datepicker;
});

var Hogan = {};

(function(Hogan) {
    Hogan.Template = function(codeObj, text, compiler, options) {
        codeObj = codeObj || {};
        this.r = codeObj.code || this.r;
        this.c = compiler;
        this.options = options || {};
        this.text = text || "";
        this.partials = codeObj.partials || {};
        this.subs = codeObj.subs || {};
        this.buf = "";
    };
    Hogan.Template.prototype = {
        r: function(context, partials, indent) {
            return "";
        },
        v: hoganEscape,
        t: coerceToString,
        render: function render(context, partials, indent) {
            return this.ri([ context ], partials || {}, indent);
        },
        ri: function(context, partials, indent) {
            return this.r(context, partials, indent);
        },
        ep: function(symbol, partials) {
            var partial = this.partials[symbol];
            var template = partials[partial.name];
            if (partial.instance && partial.base == template) {
                return partial.instance;
            }
            if (typeof template == "string") {
                if (!this.c) {
                    throw new Error("No compiler available.");
                }
                template = this.c.compile(template, this.options);
            }
            if (!template) {
                return null;
            }
            this.partials[symbol].base = template;
            if (partial.subs) {
                if (!partials.stackText) partials.stackText = {};
                for (key in partial.subs) {
                    if (!partials.stackText[key]) {
                        partials.stackText[key] = this.activeSub !== undefined && partials.stackText[this.activeSub] ? partials.stackText[this.activeSub] : this.text;
                    }
                }
                template = createSpecializedPartial(template, partial.subs, partial.partials, this.stackSubs, this.stackPartials, partials.stackText);
            }
            this.partials[symbol].instance = template;
            return template;
        },
        rp: function(symbol, context, partials, indent) {
            var partial = this.ep(symbol, partials);
            if (!partial) {
                return "";
            }
            return partial.ri(context, partials, indent);
        },
        rs: function(context, partials, section) {
            var tail = context[context.length - 1];
            if (!isArray(tail)) {
                section(context, partials, this);
                return;
            }
            for (var i = 0; i < tail.length; i++) {
                context.push(tail[i]);
                section(context, partials, this);
                context.pop();
            }
        },
        s: function(val, ctx, partials, inverted, start, end, tags) {
            var pass;
            if (isArray(val) && val.length === 0) {
                return false;
            }
            if (typeof val == "function") {
                val = this.ms(val, ctx, partials, inverted, start, end, tags);
            }
            pass = !!val;
            if (!inverted && pass && ctx) {
                ctx.push(typeof val == "object" ? val : ctx[ctx.length - 1]);
            }
            return pass;
        },
        d: function(key, ctx, partials, returnFound) {
            var found, names = key.split("."), val = this.f(names[0], ctx, partials, returnFound), doModelGet = this.options.modelGet, cx = null;
            if (key === "." && isArray(ctx[ctx.length - 2])) {
                val = ctx[ctx.length - 1];
            } else {
                for (var i = 1; i < names.length; i++) {
                    found = findInScope(names[i], val, doModelGet);
                    if (found != null) {
                        cx = val;
                        val = found;
                    } else {
                        val = "";
                    }
                }
            }
            if (returnFound && !val) {
                return false;
            }
            if (!returnFound && typeof val == "function") {
                ctx.push(cx);
                val = this.mv(val, ctx, partials);
                ctx.pop();
            }
            return val;
        },
        f: function(key, ctx, partials, returnFound) {
            var val = false, v = null, found = false, doModelGet = this.options.modelGet;
            for (var i = ctx.length - 1; i >= 0; i--) {
                v = ctx[i];
                val = findInScope(key, v, doModelGet);
                if (val != null) {
                    found = true;
                    break;
                }
            }
            if (!found) {
                return returnFound ? false : "";
            }
            if (!returnFound && typeof val == "function") {
                val = this.mv(val, ctx, partials);
            }
            return val;
        },
        ls: function(func, cx, partials, text, tags) {
            var oldTags = this.options.delimiters;
            this.options.delimiters = tags;
            this.b(this.ct(coerceToString(func.call(cx, text)), cx, partials));
            this.options.delimiters = oldTags;
            return false;
        },
        ct: function(text, cx, partials) {
            if (this.options.disableLambda) {
                throw new Error("Lambda features disabled.");
            }
            return this.c.compile(text, this.options).render(cx, partials);
        },
        b: function(s) {
            this.buf += s;
        },
        fl: function() {
            var r = this.buf;
            this.buf = "";
            return r;
        },
        ms: function(func, ctx, partials, inverted, start, end, tags) {
            var textSource, cx = ctx[ctx.length - 1], result = func.call(cx);
            if (typeof result == "function") {
                if (inverted) {
                    return true;
                } else {
                    textSource = this.activeSub && this.subsText && this.subsText[this.activeSub] ? this.subsText[this.activeSub] : this.text;
                    return this.ls(result, cx, partials, textSource.substring(start, end), tags);
                }
            }
            return result;
        },
        mv: function(func, ctx, partials) {
            var cx = ctx[ctx.length - 1];
            var result = func.call(cx);
            if (typeof result == "function") {
                return this.ct(coerceToString(result.call(cx)), cx, partials);
            }
            return result;
        },
        sub: function(name, context, partials, indent) {
            var f = this.subs[name];
            if (f) {
                this.activeSub = name;
                f(context, partials, this, indent);
                this.activeSub = false;
            }
        }
    };
    function findInScope(key, scope, doModelGet) {
        var val, checkVal;
        if (scope && typeof scope == "object") {
            if (scope[key] != null) {
                val = scope[key];
            } else if (doModelGet && scope.get && typeof scope.get == "function") {
                val = scope.get(key);
            }
        }
        return val;
    }
    function createSpecializedPartial(instance, subs, partials, stackSubs, stackPartials, stackText) {
        function PartialTemplate() {}
        PartialTemplate.prototype = instance;
        function Substitutions() {}
        Substitutions.prototype = instance.subs;
        var key;
        var partial = new PartialTemplate();
        partial.subs = new Substitutions();
        partial.subsText = {};
        partial.buf = "";
        stackSubs = stackSubs || {};
        partial.stackSubs = stackSubs;
        partial.subsText = stackText;
        for (key in subs) {
            if (!stackSubs[key]) stackSubs[key] = subs[key];
        }
        for (key in stackSubs) {
            partial.subs[key] = stackSubs[key];
        }
        stackPartials = stackPartials || {};
        partial.stackPartials = stackPartials;
        for (key in partials) {
            if (!stackPartials[key]) stackPartials[key] = partials[key];
        }
        for (key in stackPartials) {
            partial.partials[key] = stackPartials[key];
        }
        return partial;
    }
    var rAmp = /&/g, rLt = /</g, rGt = />/g, rApos = /\'/g, rQuot = /\"/g, hChars = /[&<>\"\']/;
    function coerceToString(val) {
        return String(val === null || val === undefined ? "" : val);
    }
    function hoganEscape(str) {
        str = coerceToString(str);
        return hChars.test(str) ? str.replace(rAmp, "&amp;").replace(rLt, "&lt;").replace(rGt, "&gt;").replace(rApos, "&#39;").replace(rQuot, "&quot;") : str;
    }
    var isArray = Array.isArray || function(a) {
        return Object.prototype.toString.call(a) === "[object Array]";
    };
})(typeof exports !== "undefined" ? exports : Hogan);

(function(Hogan) {
    var rIsWhitespace = /\S/, rQuot = /\"/g, rNewline = /\n/g, rCr = /\r/g, rSlash = /\\/g;
    Hogan.tags = {
        "#": 1,
        "^": 2,
        "<": 3,
        $: 4,
        "/": 5,
        "!": 6,
        ">": 7,
        "=": 8,
        _v: 9,
        "{": 10,
        "&": 11,
        _t: 12
    };
    Hogan.scan = function scan(text, delimiters) {
        var len = text.length, IN_TEXT = 0, IN_TAG_TYPE = 1, IN_TAG = 2, state = IN_TEXT, tagType = null, tag = null, buf = "", tokens = [], seenTag = false, i = 0, lineStart = 0, otag = "{{", ctag = "}}";
        function addBuf() {
            if (buf.length > 0) {
                tokens.push({
                    tag: "_t",
                    text: new String(buf)
                });
                buf = "";
            }
        }
        function lineIsWhitespace() {
            var isAllWhitespace = true;
            for (var j = lineStart; j < tokens.length; j++) {
                isAllWhitespace = Hogan.tags[tokens[j].tag] < Hogan.tags["_v"] || tokens[j].tag == "_t" && tokens[j].text.match(rIsWhitespace) === null;
                if (!isAllWhitespace) {
                    return false;
                }
            }
            return isAllWhitespace;
        }
        function filterLine(haveSeenTag, noNewLine) {
            addBuf();
            if (haveSeenTag && lineIsWhitespace()) {
                for (var j = lineStart, next; j < tokens.length; j++) {
                    if (tokens[j].text) {
                        if ((next = tokens[j + 1]) && next.tag == ">") {
                            next.indent = tokens[j].text.toString();
                        }
                        tokens.splice(j, 1);
                    }
                }
            } else if (!noNewLine) {
                tokens.push({
                    tag: "\n"
                });
            }
            seenTag = false;
            lineStart = tokens.length;
        }
        function changeDelimiters(text, index) {
            var close = "=" + ctag, closeIndex = text.indexOf(close, index), delimiters = trim(text.substring(text.indexOf("=", index) + 1, closeIndex)).split(" ");
            otag = delimiters[0];
            ctag = delimiters[delimiters.length - 1];
            return closeIndex + close.length - 1;
        }
        if (delimiters) {
            delimiters = delimiters.split(" ");
            otag = delimiters[0];
            ctag = delimiters[1];
        }
        for (i = 0; i < len; i++) {
            if (state == IN_TEXT) {
                if (tagChange(otag, text, i)) {
                    --i;
                    addBuf();
                    state = IN_TAG_TYPE;
                } else {
                    if (text.charAt(i) == "\n") {
                        filterLine(seenTag);
                    } else {
                        buf += text.charAt(i);
                    }
                }
            } else if (state == IN_TAG_TYPE) {
                i += otag.length - 1;
                tag = Hogan.tags[text.charAt(i + 1)];
                tagType = tag ? text.charAt(i + 1) : "_v";
                if (tagType == "=") {
                    i = changeDelimiters(text, i);
                    state = IN_TEXT;
                } else {
                    if (tag) {
                        i++;
                    }
                    state = IN_TAG;
                }
                seenTag = i;
            } else {
                if (tagChange(ctag, text, i)) {
                    tokens.push({
                        tag: tagType,
                        n: trim(buf),
                        otag: otag,
                        ctag: ctag,
                        i: tagType == "/" ? seenTag - otag.length : i + ctag.length
                    });
                    buf = "";
                    i += ctag.length - 1;
                    state = IN_TEXT;
                    if (tagType == "{") {
                        if (ctag == "}}") {
                            i++;
                        } else {
                            cleanTripleStache(tokens[tokens.length - 1]);
                        }
                    }
                } else {
                    buf += text.charAt(i);
                }
            }
        }
        filterLine(seenTag, true);
        return tokens;
    };
    function cleanTripleStache(token) {
        if (token.n.substr(token.n.length - 1) === "}") {
            token.n = token.n.substring(0, token.n.length - 1);
        }
    }
    function trim(s) {
        if (s.trim) {
            return s.trim();
        }
        return s.replace(/^\s*|\s*$/g, "");
    }
    function tagChange(tag, text, index) {
        if (text.charAt(index) != tag.charAt(0)) {
            return false;
        }
        for (var i = 1, l = tag.length; i < l; i++) {
            if (text.charAt(index + i) != tag.charAt(i)) {
                return false;
            }
        }
        return true;
    }
    var allowedInSuper = {
        _t: true,
        "\n": true,
        $: true,
        "/": true
    };
    function buildTree(tokens, kind, stack, customTags) {
        var instructions = [], opener = null, tail = null, token = null;
        tail = stack[stack.length - 1];
        while (tokens.length > 0) {
            token = tokens.shift();
            if (tail && tail.tag == "<" && !(token.tag in allowedInSuper)) {
                throw new Error("Illegal content in < super tag.");
            }
            if (Hogan.tags[token.tag] <= Hogan.tags["$"] || isOpener(token, customTags)) {
                stack.push(token);
                token.nodes = buildTree(tokens, token.tag, stack, customTags);
            } else if (token.tag == "/") {
                if (stack.length === 0) {
                    throw new Error("Closing tag without opener: /" + token.n);
                }
                opener = stack.pop();
                if (token.n != opener.n && !isCloser(token.n, opener.n, customTags)) {
                    throw new Error("Nesting error: " + opener.n + " vs. " + token.n);
                }
                opener.end = token.i;
                return instructions;
            } else if (token.tag == "\n") {
                token.last = tokens.length == 0 || tokens[0].tag == "\n";
            }
            instructions.push(token);
        }
        if (stack.length > 0) {
            throw new Error("missing closing tag: " + stack.pop().n);
        }
        return instructions;
    }
    function isOpener(token, tags) {
        for (var i = 0, l = tags.length; i < l; i++) {
            if (tags[i].o == token.n) {
                token.tag = "#";
                return true;
            }
        }
    }
    function isCloser(close, open, tags) {
        for (var i = 0, l = tags.length; i < l; i++) {
            if (tags[i].c == close && tags[i].o == open) {
                return true;
            }
        }
    }
    function stringifySubstitutions(obj) {
        var items = [];
        for (var key in obj) {
            items.push('"' + esc(key) + '": function(c,p,t,i) {' + obj[key] + "}");
        }
        return "{ " + items.join(",") + " }";
    }
    function stringifyPartials(codeObj) {
        var partials = [];
        for (var key in codeObj.partials) {
            partials.push('"' + esc(key) + '":{name:"' + esc(codeObj.partials[key].name) + '", ' + stringifyPartials(codeObj.partials[key]) + "}");
        }
        return "partials: {" + partials.join(",") + "}, subs: " + stringifySubstitutions(codeObj.subs);
    }
    Hogan.stringify = function(codeObj, text, options) {
        return "{code: function (c,p,i) { " + Hogan.wrapMain(codeObj.code) + " }," + stringifyPartials(codeObj) + "}";
    };
    var serialNo = 0;
    Hogan.generate = function(tree, text, options) {
        serialNo = 0;
        var context = {
            code: "",
            subs: {},
            partials: {}
        };
        Hogan.walk(tree, context);
        if (options.asString) {
            return this.stringify(context, text, options);
        }
        return this.makeTemplate(context, text, options);
    };
    Hogan.wrapMain = function(code) {
        return 'var t=this;t.b(i=i||"");' + code + "return t.fl();";
    };
    Hogan.template = Hogan.Template;
    Hogan.makeTemplate = function(codeObj, text, options) {
        var template = this.makePartials(codeObj);
        template.code = new Function("c", "p", "i", this.wrapMain(codeObj.code));
        return new this.template(template, text, this, options);
    };
    Hogan.makePartials = function(codeObj) {
        var key, template = {
            subs: {},
            partials: codeObj.partials,
            name: codeObj.name
        };
        for (key in template.partials) {
            template.partials[key] = this.makePartials(template.partials[key]);
        }
        for (key in codeObj.subs) {
            template.subs[key] = new Function("c", "p", "t", "i", codeObj.subs[key]);
        }
        return template;
    };
    function esc(s) {
        return s.replace(rSlash, "\\\\").replace(rQuot, '\\"').replace(rNewline, "\\n").replace(rCr, "\\r");
    }
    function chooseMethod(s) {
        return ~s.indexOf(".") ? "d" : "f";
    }
    function createPartial(node, context) {
        var prefix = "<" + (context.prefix || "");
        var sym = prefix + node.n + serialNo++;
        context.partials[sym] = {
            name: node.n,
            partials: {}
        };
        context.code += 't.b(t.rp("' + esc(sym) + '",c,p,"' + (node.indent || "") + '"));';
        return sym;
    }
    Hogan.codegen = {
        "#": function(node, context) {
            context.code += "if(t.s(t." + chooseMethod(node.n) + '("' + esc(node.n) + '",c,p,1),' + "c,p,0," + node.i + "," + node.end + ',"' + node.otag + " " + node.ctag + '")){' + "t.rs(c,p," + "function(c,p,t){";
            Hogan.walk(node.nodes, context);
            context.code += "});c.pop();}";
        },
        "^": function(node, context) {
            context.code += "if(!t.s(t." + chooseMethod(node.n) + '("' + esc(node.n) + '",c,p,1),c,p,1,0,0,"")){';
            Hogan.walk(node.nodes, context);
            context.code += "};";
        },
        ">": createPartial,
        "<": function(node, context) {
            var ctx = {
                partials: {},
                code: "",
                subs: {},
                inPartial: true
            };
            Hogan.walk(node.nodes, ctx);
            var template = context.partials[createPartial(node, context)];
            template.subs = ctx.subs;
            template.partials = ctx.partials;
        },
        $: function(node, context) {
            var ctx = {
                subs: {},
                code: "",
                partials: context.partials,
                prefix: node.n
            };
            Hogan.walk(node.nodes, ctx);
            context.subs[node.n] = ctx.code;
            if (!context.inPartial) {
                context.code += 't.sub("' + esc(node.n) + '",c,p,i);';
            }
        },
        "\n": function(node, context) {
            context.code += write('"\\n"' + (node.last ? "" : " + i"));
        },
        _v: function(node, context) {
            context.code += "t.b(t.v(t." + chooseMethod(node.n) + '("' + esc(node.n) + '",c,p,0)));';
        },
        _t: function(node, context) {
            context.code += write('"' + esc(node.text) + '"');
        },
        "{": tripleStache,
        "&": tripleStache
    };
    function tripleStache(node, context) {
        context.code += "t.b(t.t(t." + chooseMethod(node.n) + '("' + esc(node.n) + '",c,p,0)));';
    }
    function write(s) {
        return "t.b(" + s + ");";
    }
    Hogan.walk = function(nodelist, context) {
        var func;
        for (var i = 0, l = nodelist.length; i < l; i++) {
            func = Hogan.codegen[nodelist[i].tag];
            func && func(nodelist[i], context);
        }
        return context;
    };
    Hogan.parse = function(tokens, text, options) {
        options = options || {};
        return buildTree(tokens, "", [], options.sectionTags || []);
    };
    Hogan.cache = {};
    Hogan.cacheKey = function(text, options) {
        return [ text, !!options.asString, !!options.disableLambda, options.delimiters, !!options.modelGet ].join("||");
    };
    Hogan.compile = function(text, options) {
        options = options || {};
        var key = Hogan.cacheKey(text, options);
        var template = this.cache[key];
        if (template) {
            var partials = template.partials;
            for (var name in partials) {
                delete partials[name].instance;
            }
            return template;
        }
        template = this.generate(this.parse(this.scan(text, options.delimiters), text, options), text, options);
        return this.cache[key] = template;
    };
})(typeof exports !== "undefined" ? exports : Hogan);

(function($) {
    var _ = {
        isMsie: function() {
            return /(msie|trident)/i.test(navigator.userAgent) ? navigator.userAgent.match(/(msie |rv:)(\d+(.\d+)?)/i)[2] : false;
        },
        isBlankString: function(str) {
            return !str || /^\s*$/.test(str);
        },
        escapeRegExChars: function(str) {
            return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
        },
        isString: function(obj) {
            return typeof obj === "string";
        },
        isNumber: function(obj) {
            return typeof obj === "number";
        },
        isArray: $.isArray,
        isFunction: $.isFunction,
        isObject: $.isPlainObject,
        isUndefined: function(obj) {
            return typeof obj === "undefined";
        },
        bind: $.proxy,
        each: function(collection, cb) {
            $.each(collection, reverseArgs);
            function reverseArgs(index, value) {
                return cb(value, index);
            }
        },
        map: $.map,
        filter: $.grep,
        every: function(obj, test) {
            var result = true;
            if (!obj) {
                return result;
            }
            $.each(obj, function(key, val) {
                if (!(result = test.call(null, val, key, obj))) {
                    return false;
                }
            });
            return !!result;
        },
        some: function(obj, test) {
            var result = false;
            if (!obj) {
                return result;
            }
            $.each(obj, function(key, val) {
                if (result = test.call(null, val, key, obj)) {
                    return false;
                }
            });
            return !!result;
        },
        mixin: $.extend,
        getUniqueId: function() {
            var counter = 0;
            return function() {
                return counter++;
            };
        }(),
        templatify: function templatify(obj) {
            return $.isFunction(obj) ? obj : template;
            function template() {
                return String(obj);
            }
        },
        defer: function(fn) {
            setTimeout(fn, 0);
        },
        debounce: function(func, wait, immediate) {
            var timeout, result;
            return function() {
                var context = this, args = arguments, later, callNow;
                later = function() {
                    timeout = null;
                    if (!immediate) {
                        result = func.apply(context, args);
                    }
                };
                callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) {
                    result = func.apply(context, args);
                }
                return result;
            };
        },
        throttle: function(func, wait) {
            var context, args, timeout, result, previous, later;
            previous = 0;
            later = function() {
                previous = new Date();
                timeout = null;
                result = func.apply(context, args);
            };
            return function() {
                var now = new Date(), remaining = wait - (now - previous);
                context = this;
                args = arguments;
                if (remaining <= 0) {
                    clearTimeout(timeout);
                    timeout = null;
                    previous = now;
                    result = func.apply(context, args);
                } else if (!timeout) {
                    timeout = setTimeout(later, remaining);
                }
                return result;
            };
        },
        noop: function() {}
    };
    var VERSION = "0.10.1.1";
    var LruCache = function(root, undefined) {
        function LruCache(maxSize) {
            this.maxSize = maxSize || 100;
            this.size = 0;
            this.hash = {};
            this.list = new List();
        }
        _.mixin(LruCache.prototype, {
            set: function set(key, val) {
                var tailItem = this.list.tail, node;
                if (this.size >= this.maxSize) {
                    this.list.remove(tailItem);
                    delete this.hash[tailItem.key];
                }
                if (node = this.hash[key]) {
                    node.val = val;
                    this.list.moveToFront(node);
                } else {
                    node = new Node(key, val);
                    this.list.add(node);
                    this.hash[key] = node;
                    this.size++;
                }
            },
            get: function get(key) {
                var node = this.hash[key];
                if (node) {
                    this.list.moveToFront(node);
                    return node.val;
                }
            }
        });
        function List() {
            this.head = this.tail = null;
        }
        _.mixin(List.prototype, {
            add: function add(node) {
                if (this.head) {
                    node.next = this.head;
                    this.head.prev = node;
                }
                this.head = node;
                this.tail = this.tail || node;
            },
            remove: function remove(node) {
                node.prev ? node.prev.next = node.next : this.head = node.next;
                node.next ? node.next.prev = node.prev : this.tail = node.prev;
            },
            moveToFront: function(node) {
                this.remove(node);
                this.add(node);
            }
        });
        function Node(key, val) {
            this.key = key;
            this.val = val;
            this.prev = this.next = null;
        }
        return LruCache;
    }(this);
    var PersistentStorage = function() {
        var ls, methods;
        try {
            ls = window.localStorage;
            ls.setItem("~~~", "!");
            ls.removeItem("~~~");
        } catch (err) {
            ls = null;
        }
        function PersistentStorage(namespace) {
            this.prefix = [ "__", namespace, "__" ].join("");
            this.ttlKey = "__ttl__";
            this.keyMatcher = new RegExp("^" + this.prefix);
        }
        if (ls && window.JSON) {
            methods = {
                _prefix: function(key) {
                    return this.prefix + key;
                },
                _ttlKey: function(key) {
                    return this._prefix(key) + this.ttlKey;
                },
                get: function(key) {
                    if (this.isExpired(key)) {
                        this.remove(key);
                    }
                    return decode(ls.getItem(this._prefix(key)));
                },
                set: function(key, val, ttl) {
                    if (_.isNumber(ttl)) {
                        ls.setItem(this._ttlKey(key), encode(now() + ttl));
                    } else {
                        ls.removeItem(this._ttlKey(key));
                    }
                    return ls.setItem(this._prefix(key), encode(val));
                },
                remove: function(key) {
                    ls.removeItem(this._ttlKey(key));
                    ls.removeItem(this._prefix(key));
                    return this;
                },
                clear: function() {
                    var i, key, keys = [], len = ls.length;
                    for (i = 0; i < len; i++) {
                        if ((key = ls.key(i)).match(this.keyMatcher)) {
                            keys.push(key.replace(this.keyMatcher, ""));
                        }
                    }
                    for (i = keys.length; i--; ) {
                        this.remove(keys[i]);
                    }
                    return this;
                },
                isExpired: function(key) {
                    var ttl = decode(ls.getItem(this._ttlKey(key)));
                    return _.isNumber(ttl) && now() > ttl ? true : false;
                }
            };
        } else {
            methods = {
                get: _.noop,
                set: _.noop,
                remove: _.noop,
                clear: _.noop,
                isExpired: _.noop
            };
        }
        _.mixin(PersistentStorage.prototype, methods);
        return PersistentStorage;
        function now() {
            return new Date().getTime();
        }
        function encode(val) {
            return JSON.stringify(_.isUndefined(val) ? null : val);
        }
        function decode(val) {
            return JSON.parse(val);
        }
    }();
    var Transport = function() {
        var pendingRequestsCount = 0, pendingRequests = {}, maxPendingRequests = 6, requestCache = new LruCache(10);
        function Transport(o) {
            o = o || {};
            this._send = o.transport ? callbackToDeferred(o.transport) : $.ajax;
            this._get = o.rateLimiter ? o.rateLimiter(this._get) : this._get;
        }
        Transport.setMaxPendingRequests = function setMaxPendingRequests(num) {
            maxPendingRequests = num;
        };
        Transport.resetCache = function clearCache() {
            requestCache = new LruCache(10);
        };
        _.mixin(Transport.prototype, {
            _get: function(url, o, cb) {
                var that = this, jqXhr;
                if (jqXhr = pendingRequests[url]) {
                    jqXhr.done(done);
                } else if (pendingRequestsCount < maxPendingRequests) {
                    pendingRequestsCount++;
                    pendingRequests[url] = this._send(url, o).done(done).always(always);
                } else {
                    this.onDeckRequestArgs = [].slice.call(arguments, 0);
                }
                function done(resp) {
                    cb && cb(resp);
                    requestCache.set(url, resp);
                }
                function always() {
                    pendingRequestsCount--;
                    delete pendingRequests[url];
                    if (that.onDeckRequestArgs) {
                        that._get.apply(that, that.onDeckRequestArgs);
                        that.onDeckRequestArgs = null;
                    }
                }
            },
            get: function(url, o, cb) {
                var that = this, resp;
                if (_.isFunction(o)) {
                    cb = o;
                    o = {};
                }
                if (resp = requestCache.get(url)) {
                    _.defer(function() {
                        cb && cb(resp);
                    });
                } else {
                    this._get(url, o, cb);
                }
                return !!resp;
            }
        });
        return Transport;
        function callbackToDeferred(fn) {
            return function customSendWrapper(url, o) {
                var deferred = $.Deferred();
                fn(url, o, onSuccess, onError);
                return deferred;
                function onSuccess(resp) {
                    _.defer(function() {
                        deferred.resolve(resp);
                    });
                }
                function onError(err) {
                    _.defer(function() {
                        deferred.reject(err);
                    });
                }
            };
        }
    }();
    var SearchIndex = function() {
        function SearchIndex(o) {
            o = o || {};
            if (!o.datumTokenizer || !o.queryTokenizer) {
                $.error("datumTokenizer and queryTokenizer are both required");
            }
            this.datumTokenizer = o.datumTokenizer;
            this.queryTokenizer = o.queryTokenizer;
            this.datums = [];
            this.trie = newNode();
        }
        _.mixin(SearchIndex.prototype, {
            bootstrap: function bootstrap(o) {
                this.datums = o.datums;
                this.trie = o.trie;
            },
            add: function(data) {
                var that = this;
                data = _.isArray(data) ? data : [ data ];
                _.each(data, function(datum) {
                    var id, tokens;
                    id = that.datums.push(datum) - 1;
                    tokens = normalizeTokens(that.datumTokenizer(datum));
                    if (typeof tokens !== "undefined") {
                        _.each(tokens, function(token) {
                            var node, chars, ch, ids;
                            node = that.trie;
                            chars = token.split("");
                            while (ch = chars.shift()) {
                                node = node.children[ch] || (node.children[ch] = newNode());
                                node.ids.push(id);
                            }
                        });
                    }
                });
            },
            get: function get(query) {
                var that = this, tokens, matches;
                tokens = normalizeTokens(this.queryTokenizer(query));
                _.each(tokens, function(token) {
                    var node, chars, ch, ids;
                    if (matches && matches.length === 0) {
                        return false;
                    }
                    node = that.trie;
                    chars = token.split("");
                    while (node && (ch = chars.shift())) {
                        node = node.children[ch];
                    }
                    if (node && chars.length === 0) {
                        ids = node.ids.slice(0);
                        matches = matches ? getIntersection(matches, ids) : ids;
                    } else {
                        matches = [];
                        return false;
                    }
                });
                return matches ? _.map(unique(matches), function(id) {
                    return that.datums[id];
                }) : [];
            },
            all: function all() {
                return this.datums.slice(0);
            },
            serialize: function serialize() {
                return {
                    datums: this.datums,
                    trie: this.trie
                };
            }
        });
        return SearchIndex;
        function normalizeTokens(tokens) {
            if (typeof tokens === "undefined") {
                return;
            }
            tokens = _.filter(tokens, function(token) {
                return !!token;
            });
            tokens = _.map(tokens, function(token) {
                return token.toLowerCase();
            });
            return tokens;
        }
        function newNode() {
            return {
                ids: [],
                children: {}
            };
        }
        function unique(array) {
            var seen = {}, uniques = [];
            for (var i = 0; i < array.length; i++) {
                if (!seen[array[i]]) {
                    seen[array[i]] = true;
                    uniques.push(array[i]);
                }
            }
            return uniques;
        }
        function getIntersection(arrayA, arrayB) {
            var ai = 0, bi = 0, intersection = [];
            arrayA = arrayA.sort(compare);
            arrayB = arrayB.sort(compare);
            while (ai < arrayA.length && bi < arrayB.length) {
                if (arrayA[ai] < arrayB[bi]) {
                    ai++;
                } else if (arrayA[ai] > arrayB[bi]) {
                    bi++;
                } else {
                    intersection.push(arrayA[ai]);
                    ai++;
                    bi++;
                }
            }
            return intersection;
            function compare(a, b) {
                return a - b;
            }
        }
    }();
    var oParser = function() {
        return {
            local: getLocal,
            prefetch: getPrefetch,
            remote: getRemote
        };
        function getLocal(o) {
            var local = o.local || null;
            if (_.isFunction(local)) {
                local = local.call(null);
            }
            return local;
        }
        function getPrefetch(o) {
            var prefetch, defaults;
            defaults = {
                url: null,
                thumbprint: "",
                ttl: 24 * 60 * 60 * 1e3,
                filter: null,
                ajax: {}
            };
            if (prefetch = o.prefetch || null) {
                prefetch = _.isString(prefetch) ? {
                    url: prefetch
                } : prefetch;
                prefetch = _.mixin(defaults, prefetch);
                prefetch.thumbprint = VERSION + prefetch.thumbprint;
                prefetch.ajax.type = prefetch.ajax.type || "GET";
                prefetch.ajax.dataType = prefetch.ajax.dataType || "json";
                !prefetch.url && $.error("prefetch requires url to be set");
            }
            return prefetch;
        }
        function getRemote(o) {
            var remote, defaults;
            defaults = {
                url: null,
                wildcard: "%QUERY",
                replace: null,
                rateLimitBy: "debounce",
                rateLimitWait: 300,
                send: null,
                filter: null,
                ajax: {}
            };
            if (remote = o.remote || null) {
                remote = _.isString(remote) ? {
                    url: remote
                } : remote;
                remote = _.mixin(defaults, remote);
                remote.rateLimiter = /^throttle$/i.test(remote.rateLimitBy) ? byThrottle(remote.rateLimitWait) : byDebounce(remote.rateLimitWait);
                remote.ajax.type = remote.ajax.type || "GET";
                remote.ajax.dataType = remote.ajax.dataType || "json";
                delete remote.rateLimitBy;
                delete remote.rateLimitWait;
                !remote.url && $.error("remote requires url to be set");
            }
            return remote;
            function byDebounce(wait) {
                return function(fn) {
                    return _.debounce(fn, wait);
                };
            }
            function byThrottle(wait) {
                return function(fn) {
                    return _.throttle(fn, wait);
                };
            }
        }
    }();
    var Bloodhound = window.Bloodhound = function() {
        var keys;
        keys = {
            data: "data",
            protocol: "protocol",
            thumbprint: "thumbprint"
        };
        function Bloodhound(o) {
            if (!o || !o.local && !o.prefetch && !o.remote) {
                $.error("one of local, prefetch, or remote is required");
            }
            this.limit = o.limit || 5;
            this.sorter = getSorter(o.sorter);
            this.dupDetector = o.dupDetector || ignoreDuplicates;
            this.local = oParser.local(o);
            this.minLength = _.isNumber(o.minLength) ? o.minLength : 1;
            this.prefetch = oParser.prefetch(o);
            this.remote = oParser.remote(o);
            this.cacheKey = this.prefetch ? this.prefetch.cacheKey || this.prefetch.url : null;
            this.index = new SearchIndex({
                datumTokenizer: o.datumTokenizer,
                queryTokenizer: o.queryTokenizer
            });
            this.storage = this.cacheKey ? new PersistentStorage(this.cacheKey) : null;
        }
        Bloodhound.tokenizers = {
            whitespace: function whitespaceTokenizer(s) {
                var cleansed = s.replace(/[^\w\s]/g, "");
                return cleansed.split(/\s+/);
            },
            nonword: function nonwordTokenizer(s) {
                return s.split(/\W+/);
            }
        };
        _.mixin(Bloodhound.prototype, {
            _loadPrefetch: function loadPrefetch(o) {
                var that = this, serialized, deferred;
                if (serialized = this._readFromStorage(o.thumbprint)) {
                    this.index.bootstrap(serialized);
                    deferred = $.Deferred().resolve();
                } else {
                    deferred = $.ajax(o.url, o.ajax).done(handlePrefetchResponse);
                }
                return deferred;
                function handlePrefetchResponse(resp) {
                    var filtered;
                    if (resp && typeof resp !== "undefined") {
                        filtered = o.filter ? o.filter(resp) : resp;
                        that.add(filtered);
                        that._saveToStorage(that.index.serialize(), o.thumbprint, o.ttl);
                    }
                }
            },
            _getFromRemote: function getFromRemote(query, cb) {
                var that = this, url, uriEncodedQuery;
                query = query || "";
                uriEncodedQuery = encodeURIComponent(query);
                url = this.remote.replace ? this.remote.replace(this.remote.url, query) : this.remote.url.replace(this.remote.wildcard, uriEncodedQuery);
                return this.transport.get(url, this.remote.ajax, handleRemoteResponse);
                function handleRemoteResponse(resp) {
                    var filtered = that.remote.filter ? that.remote.filter(resp) : resp;
                    cb(filtered);
                }
            },
            _saveToStorage: function saveToStorage(data, thumbprint, ttl) {
                if (this.storage) {
                    this.storage.set(keys.data, data, ttl);
                    this.storage.set(keys.protocol, location.protocol, ttl);
                    this.storage.set(keys.thumbprint, thumbprint, ttl);
                }
            },
            _readFromStorage: function readFromStorage(thumbprint) {
                var stored = {}, isExpired;
                if (this.storage) {
                    stored.data = this.storage.get(keys.data);
                    stored.protocol = this.storage.get(keys.protocol);
                    stored.thumbprint = this.storage.get(keys.thumbprint);
                }
                isExpired = stored.thumbprint !== thumbprint || stored.protocol !== location.protocol;
                return stored.data && !isExpired ? stored.data : null;
            },
            initialize: function initialize() {
                var that = this, deferred;
                deferred = this.prefetch ? this._loadPrefetch(this.prefetch) : $.Deferred().resolve();
                this.local && deferred.done(addLocalToIndex);
                this.transport = this.remote ? new Transport(this.remote) : null;
                this.initialize = function initialize() {
                    return deferred.promise();
                };
                return deferred.promise();
                function addLocalToIndex() {
                    that.add(that.local);
                }
            },
            add: function add(data) {
                this.index.add(data);
            },
            get: function get(query, cb) {
                var that = this, matches, cacheHit = false;
                if (query === "" && this.minLength === 0) {
                    matches = this.index.all();
                } else if (query !== "" && query.length >= this.minLength) {
                    matches = this.index.get(query);
                    if (matches.length < this.limit && this.transport) {
                        cacheHit = this._getFromRemote(query, returnRemoteMatches);
                    }
                } else {
                    return;
                }
                matches = this.sorter(matches).slice(0, this.limit);
                !cacheHit && cb && cb(matches);
                function returnRemoteMatches(remoteMatches) {
                    var matchesWithBackfill = matches.slice(0);
                    _.each(remoteMatches, function(remoteMatch) {
                        var isDuplicate;
                        isDuplicate = _.some(matchesWithBackfill, function(match) {
                            return that.dupDetector(remoteMatch, match);
                        });
                        !isDuplicate && matchesWithBackfill.push(remoteMatch);
                        return matchesWithBackfill.length < that.limit;
                    });
                    cb && cb(that.sorter(matchesWithBackfill));
                }
            },
            ttAdapter: function ttAdapter() {
                return _.bind(this.get, this);
            }
        });
        return Bloodhound;
        function getSorter(sortFn) {
            return _.isFunction(sortFn) ? sort : noSort;
            function sort(array) {
                return array.sort(sortFn);
            }
            function noSort(array) {
                return array;
            }
        }
        function ignoreDuplicates() {
            return false;
        }
    }();
    var html = {
        wrapper: '<span class="twitter-typeahead"></span>',
        dropdown: '<span class="tt-dropdown-menu notranslate" tabindex="-1" role="listbox"></span>',
        dataset: '<div class="tt-dataset-%CLASS%"></div>',
        suggestions: '<span class="tt-suggestions" tabindex="-1" role="presentation"></span>',
        suggestion: '<div class="tt-suggestion" role="presentation">%BODY%</div>'
    };
    var css = {
        wrapper: {
            position: "relative",
            display: "inline-block"
        },
        hint: {
            position: "absolute",
            top: "0",
            left: "0",
            borderColor: "transparent",
            boxShadow: "none"
        },
        input: {
            position: "relative",
            verticalAlign: "top",
            backgroundColor: "transparent"
        },
        inputWithNoHint: {
            position: "relative",
            verticalAlign: "top"
        },
        dropdown: {
            position: "absolute",
            top: "100%",
            left: "0",
            zIndex: "100",
            display: "none"
        },
        suggestions: {
            display: "block"
        },
        suggestion: {
            whiteSpace: "nowrap",
            cursor: "pointer"
        },
        suggestionChild: {
            whiteSpace: "normal"
        },
        ltr: {
            left: "0",
            right: "auto"
        },
        rtl: {
            left: "auto",
            right: " 0"
        },
        fav: {
            dropdown: {
                position: "relative",
                top: "100%",
                left: "0",
                zIndex: "100",
                display: "none"
            }
        }
    };
    if (_.isMsie()) {
        _.mixin(css.input, {
            backgroundImage: "url(data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7)"
        });
    }
    if (_.isMsie() && _.isMsie() <= 7) {
        _.mixin(css.input, {
            marginTop: "-1px"
        });
    }
    var EventBus = function() {
        var namespace = "typeahead:";
        function EventBus(o) {
            if (!o || !o.el) {
                $.error("EventBus initialized without el");
            }
            this.$el = $(o.el);
        }
        _.mixin(EventBus.prototype, {
            trigger: function(type) {
                var args = [].slice.call(arguments, 1);
                this.$el.trigger(namespace + type, args);
            }
        });
        return EventBus;
    }();
    var EventEmitter = function() {
        var splitter = /\s+/, nextTick = getNextTick();
        return {
            onSync: onSync,
            onAsync: onAsync,
            off: off,
            trigger: trigger
        };
        function on(method, types, cb, context) {
            var type;
            if (!cb) {
                return this;
            }
            types = types.split(splitter);
            cb = context ? bindContext(cb, context) : cb;
            this._callbacks = this._callbacks || {};
            while (type = types.shift()) {
                this._callbacks[type] = this._callbacks[type] || {
                    sync: [],
                    async: []
                };
                this._callbacks[type][method].push(cb);
            }
            return this;
        }
        function onAsync(types, cb, context) {
            return on.call(this, "async", types, cb, context);
        }
        function onSync(types, cb, context) {
            return on.call(this, "sync", types, cb, context);
        }
        function off(types) {
            var type;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            while (type = types.shift()) {
                delete this._callbacks[type];
            }
            return this;
        }
        function trigger(types) {
            var that = this, type, callbacks, args, syncFlush, asyncFlush;
            if (!this._callbacks) {
                return this;
            }
            types = types.split(splitter);
            args = [].slice.call(arguments, 1);
            while ((type = types.shift()) && (callbacks = this._callbacks[type])) {
                syncFlush = getFlush(callbacks.sync, this, [ type ].concat(args));
                asyncFlush = getFlush(callbacks.async, this, [ type ].concat(args));
                syncFlush() && nextTick(asyncFlush);
            }
            return this;
        }
        function getFlush(callbacks, context, args) {
            return flush;
            function flush() {
                var cancelled;
                for (var i = 0; !cancelled && i < callbacks.length; i += 1) {
                    cancelled = callbacks[i].apply(context, args) === false;
                }
                return !cancelled;
            }
        }
        function getNextTick() {
            var nextTickFn, messageChannel;
            if (window.setImmediate) {
                nextTickFn = function nextTickSetImmediate(fn) {
                    setImmediate(function() {
                        fn();
                    });
                };
            } else {
                nextTickFn = function nextTickSetTimeout(fn) {
                    setTimeout(function() {
                        fn();
                    }, 0);
                };
            }
            return nextTickFn;
        }
        function bindContext(fn, context) {
            return fn.bind ? fn.bind(context) : function() {
                fn.apply(context, [].slice.call(arguments, 0));
            };
        }
    }();
    var highlight = function(doc) {
        var defaults = {
            node: null,
            pattern: null,
            tagName: "strong",
            className: null,
            wordsOnly: false,
            caseSensitive: false
        };
        return function hightlight(o) {
            var regex;
            o = _.mixin({}, defaults, o);
            if (!o.node || !o.pattern) {
                return;
            }
            o.pattern = _.isArray(o.pattern) ? o.pattern : [ o.pattern ];
            regex = getRegex(o.pattern, o.caseSensitive, o.wordsOnly);
            traverse(o.node, hightlightTextNode);
            function hightlightTextNode(textNode) {
                var match, patternNode;
                if (match = regex.exec(textNode.data)) {
                    wrapperNode = doc.createElement(o.tagName);
                    o.className && (wrapperNode.className = o.className);
                    patternNode = textNode.splitText(match.index);
                    patternNode.splitText(match[0].length);
                    wrapperNode.appendChild(patternNode.cloneNode(true));
                    textNode.parentNode.replaceChild(wrapperNode, patternNode);
                }
                return !!match;
            }
            function traverse(el, hightlightTextNode) {
                var childNode, TEXT_NODE_TYPE = 3;
                for (var i = 0; i < el.childNodes.length; i++) {
                    childNode = el.childNodes[i];
                    if (childNode.nodeType === TEXT_NODE_TYPE) {
                        i += hightlightTextNode(childNode) ? 1 : 0;
                    } else {
                        traverse(childNode, hightlightTextNode);
                    }
                }
            }
        };
        function getRegex(patterns, caseSensitive, wordsOnly) {
            var escapedPatterns = [], regexStr;
            for (var i = 0; i < patterns.length; i++) {
                escapedPatterns.push(_.escapeRegExChars(patterns[i]));
            }
            regexStr = wordsOnly ? "\\b(" + escapedPatterns.join("|") + ")\\b" : "(" + escapedPatterns.join("|") + ")";
            return caseSensitive ? new RegExp(regexStr) : new RegExp(regexStr, "i");
        }
    }(window.document);
    var Input = function() {
        var specialKeyCodeMap;
        specialKeyCodeMap = {
            9: "tab",
            27: "esc",
            37: "left",
            39: "right",
            13: "enter",
            38: "up",
            40: "down"
        };
        function Input(o) {
            var that = this, onBlur, onFocus, onKeydown, onInput;
            o = o || {};
            if (!o.input) {
                $.error("input is missing");
            }
            onBlur = _.bind(this._onBlur, this);
            onFocus = _.bind(this._onFocus, this);
            onKeydown = _.bind(this._onKeydown, this);
            onInput = _.bind(this._onInput, this);
            this.$hint = $(o.hint);
            this.$input = $(o.input).on("blur.tt", onBlur).on("focus.tt", onFocus).on("keydown.tt", onKeydown);
            if (this.$hint.length === 0) {
                this.setHintValue = this.getHintValue = this.clearHint = _.noop;
            }
            if (!_.isMsie()) {
                this.$input.on("input.tt", onInput);
            } else {
                this.$input.on("keydown.tt keypress.tt cut.tt paste.tt", function($e) {
                    if (specialKeyCodeMap[$e.which || $e.keyCode]) {
                        return;
                    }
                    _.defer(_.bind(that._onInput, that, $e));
                });
            }
            this.query = this.$input.val();
            this.$overflowHelper = buildOverflowHelper(this.$input);
        }
        Input.normalizeQuery = function(str) {
            return (str || "").replace(/^\s*/g, "").replace(/\s{2,}/g, " ");
        };
        _.mixin(Input.prototype, EventEmitter, {
            _onBlur: function onBlur($e) {
                this.resetInputValue();
                this.trigger("blurred");
            },
            _onFocus: function onFocus($e) {
                this.trigger("focused");
            },
            _onKeydown: function onKeydown($e) {
                var keyName = specialKeyCodeMap[$e.which || $e.keyCode];
                this._managePreventDefault(keyName, $e);
                if (keyName && this._shouldTrigger(keyName, $e)) {
                    this.trigger(keyName + "Keyed", $e);
                }
            },
            _onInput: function onInput($e) {
                this._checkInputValue();
            },
            _managePreventDefault: function managePreventDefault(keyName, $e) {
                var preventDefault, hintValue, inputValue;
                switch (keyName) {
                  case "tab":
                    hintValue = this.getHintValue();
                    inputValue = this.getInputValue();
                    preventDefault = hintValue && hintValue !== inputValue && !withModifier($e);
                    break;

                  case "up":
                  case "down":
                    preventDefault = !withModifier($e);
                    break;

                  default:
                    preventDefault = false;
                }
                preventDefault && $e.preventDefault();
            },
            _shouldTrigger: function shouldTrigger(keyName, $e) {
                var trigger;
                switch (keyName) {
                  case "tab":
                    trigger = !withModifier($e);
                    break;

                  default:
                    trigger = true;
                }
                return trigger;
            },
            _checkInputValue: function checkInputValue() {
                var inputValue, areEquivalent, hasDifferentWhitespace;
                inputValue = this.getInputValue();
                areEquivalent = areQueriesEquivalent(inputValue, this.query);
                hasDifferentWhitespace = areEquivalent ? this.query.length !== inputValue.length : false;
                if (!areEquivalent) {
                    this.trigger("queryChanged", this.query = inputValue);
                } else if (hasDifferentWhitespace) {
                    this.trigger("whitespaceChanged", this.query);
                }
            },
            focus: function focus() {
                this.$input.focus();
            },
            blur: function blur() {
                this.$input.blur();
            },
            getQuery: function getQuery() {
                return this.query;
            },
            setQuery: function setQuery(query) {
                this.query = query;
            },
            getInputValue: function getInputValue() {
                return this.$input.val();
            },
            setInputValue: function setInputValue(value, silent) {
                this.$input.val(value);
                !silent && this._checkInputValue();
            },
            getHintValue: function getHintValue() {
                return this.$hint.val();
            },
            setHintValue: function setHintValue(value) {
                this.$hint.val(value);
            },
            resetInputValue: function resetInputValue() {
                this.$input.val(this.query);
            },
            clearHint: function clearHint() {
                this.$hint.val("");
            },
            getLanguageDirection: function getLanguageDirection() {
                return (this.$input.css("direction") || "ltr").toLowerCase();
            },
            hasOverflow: function hasOverflow() {
                var constraint = this.$input.width() - 2;
                this.$overflowHelper.text(this.getInputValue());
                return this.$overflowHelper.width() >= constraint;
            },
            isCursorAtEnd: function() {
                var valueLength, selectionStart, range;
                valueLength = this.$input.val().length;
                selectionStart = this.$input[0].selectionStart;
                if (_.isNumber(selectionStart)) {
                    return selectionStart === valueLength;
                } else if (document.selection) {
                    range = document.selection.createRange();
                    range.moveStart("character", -valueLength);
                    return valueLength === range.text.length;
                }
                return true;
            },
            destroy: function destroy() {
                this.$hint.off(".tt");
                this.$input.off(".tt");
                this.$hint = this.$input = this.$overflowHelper = null;
            },
            closeDisambiguation: function closeDisambiguation() {
                this.$input.closest("[class*='search-filter']").next(".disambiguation-in-page").remove();
            }
        });
        return Input;
        function buildOverflowHelper($input) {
            return $('<pre aria-hidden="true"></pre>').css({
                position: "absolute",
                visibility: "hidden",
                whiteSpace: "nowrap",
                fontFamily: $input.css("font-family"),
                fontSize: $input.css("font-size"),
                fontStyle: $input.css("font-style"),
                fontVariant: $input.css("font-variant"),
                fontWeight: $input.css("font-weight"),
                wordSpacing: $input.css("word-spacing"),
                letterSpacing: $input.css("letter-spacing"),
                textIndent: $input.css("text-indent"),
                textRendering: $input.css("text-rendering"),
                textTransform: $input.css("text-transform")
            }).insertAfter($input);
        }
        function areQueriesEquivalent(a, b) {
            return Input.normalizeQuery(a) === Input.normalizeQuery(b);
        }
        function withModifier($e) {
            return $e.altKey || $e.ctrlKey || $e.metaKey || $e.shiftKey;
        }
    }();
    var Dataset = function() {
        var datasetKey = "ttDataset", valueKey = "ttValue", datumKey = "ttDatum";
        function Dataset(o) {
            o = o || {};
            o.templates = o.templates || {};
            if (!o.source) {
                $.error("missing source");
            }
            if (o.name && !isValidName(o.name)) {
                $.error("invalid dataset name: " + o.name);
            }
            this.query = null;
            this.highlight = !!o.highlight;
            this.name = o.name || _.getUniqueId();
            this.source = o.source;
            this.displayFn = getDisplayFn(o.display || o.displayKey);
            this.templates = getTemplates(o.templates, this.displayFn);
            this.$el = $(html.dataset.replace("%CLASS%", this.name));
        }
        Dataset.extractDatasetName = function extractDatasetName(el) {
            return $(el).data(datasetKey);
        };
        Dataset.extractValue = function extractDatum(el) {
            return $(el).data(valueKey);
        };
        Dataset.extractDatum = function extractDatum(el) {
            return $(el).data(datumKey);
        };
        _.mixin(Dataset.prototype, EventEmitter, {
            _render: function render(query, suggestions) {
                if (!this.$el) {
                    return;
                }
                var that = this, hasSuggestions;
                this.$el.empty();
                hasSuggestions = suggestions && suggestions.length;
                if (!hasSuggestions && this.templates.empty) {
                    this.$el.html(getEmptyHtml()).prepend(that.templates.header ? getHeaderHtml() : null).append(that.templates.footer ? getFooterHtml() : null);
                } else if (hasSuggestions) {
                    this.$el.html(getSuggestionsHtml()).prepend(that.templates.header ? getHeaderHtml() : null).append(that.templates.footer ? getFooterHtml() : null);
                }
                this.trigger("rendered");
                function getEmptyHtml() {
                    return that.templates.empty({
                        query: query,
                        isEmpty: true
                    });
                }
                function getSuggestionsHtml() {
                    var $suggestions, nodes;
                    $suggestions = $(html.suggestions).css(css.suggestions);
                    nodes = _.map(suggestions, getSuggestionNode);
                    $suggestions.append.apply($suggestions, nodes);
                    that.highlight && highlight({
                        node: $suggestions[0],
                        pattern: query
                    });
                    return $suggestions;
                    function getSuggestionNode(suggestion) {
                        var $el, innerHtml, outerHtml;
                        innerHtml = that.templates.suggestion(suggestion);
                        outerHtml = html.suggestion.replace("%BODY%", innerHtml);
                        $el = $(outerHtml).data(datasetKey, that.name).data(valueKey, that.displayFn(suggestion)).data(datumKey, suggestion);
                        $el.children().each(function() {
                            $(this).css(css.suggestionChild);
                        });
                        return $el;
                    }
                }
                function getHeaderHtml() {
                    return that.templates.header({
                        query: query,
                        isEmpty: !hasSuggestions
                    });
                }
                function getFooterHtml() {
                    return that.templates.footer({
                        query: query,
                        isEmpty: !hasSuggestions
                    });
                }
            },
            getRoot: function getRoot() {
                return this.$el;
            },
            update: function update(query) {
                var that = this;
                this.query = query;
                this.source(query, renderIfQueryIsSame);
                function renderIfQueryIsSame(suggestions) {
                    query === that.query && that._render(query, suggestions);
                }
            },
            clear: function clear() {
                this._render(this.query || "");
            },
            isEmpty: function isEmpty() {
                return this.$el.is(":empty");
            },
            destroy: function destroy() {
                this.$el = null;
            }
        });
        return Dataset;
        function getDisplayFn(display) {
            display = display || "value";
            return _.isFunction(display) ? display : displayFn;
            function displayFn(obj) {
                return obj[display];
            }
        }
        function getTemplates(templates, displayFn) {
            return {
                empty: templates.empty && _.templatify(templates.empty),
                header: templates.header && _.templatify(templates.header),
                footer: templates.footer && _.templatify(templates.footer),
                suggestion: templates.suggestion || suggestionTemplate
            };
            function suggestionTemplate(context) {
                return "<p>" + displayFn(context) + "</p>";
            }
        }
        function isValidName(str) {
            return /^[_a-zA-Z0-9-]+$/.test(str);
        }
    }();
    var Dropdown = function() {
        function Dropdown(o) {
            var that = this, onSuggestionClick, onSuggestionMouseEnter, onSuggestionMouseLeave;
            o = o || {};
            if (!o.menu) {
                $.error("menu is required");
            }
            this.isOpen = false;
            this.isEmpty = true;
            this.datasets = _.map(o.datasets, initializeDataset);
            onSuggestionClick = _.bind(this._onSuggestionClick, this);
            onSuggestionMouseEnter = _.bind(this._onSuggestionMouseEnter, this);
            onSuggestionMouseLeave = _.bind(this._onSuggestionMouseLeave, this);
            this.$menu = $(o.menu).on("click.tt", ".tt-suggestion", onSuggestionClick).on("mouseenter.tt", ".tt-suggestion", onSuggestionMouseEnter).on("mouseleave.tt", ".tt-suggestion", onSuggestionMouseLeave);
            _.each(this.datasets, function(dataset) {
                that.$menu.append(dataset.getRoot());
                dataset.onSync("rendered", that._onRendered, that);
            });
        }
        _.mixin(Dropdown.prototype, EventEmitter, {
            _onSuggestionClick: function onSuggestionClick($e) {
                this.trigger("suggestionClicked", $($e.currentTarget));
            },
            _onSuggestionMouseEnter: function onSuggestionMouseEnter($e) {
                this._removeCursor();
                this._setCursor($($e.currentTarget), true);
            },
            _onSuggestionMouseLeave: function onSuggestionMouseLeave($e) {
                this._removeCursor();
            },
            _onRendered: function onRendered() {
                this.isEmpty = _.every(this.datasets, isDatasetEmpty);
                this.isEmpty ? this._hide() : this.isOpen && this._show();
                this.trigger("datasetRendered");
                function isDatasetEmpty(dataset) {
                    return dataset.isEmpty();
                }
            },
            _hide: function() {
                this.$menu.hide();
            },
            _show: function() {
                this.$menu.show();
            },
            _getSuggestions: function getSuggestions() {
                return this.$menu.find(".tt-suggestion");
            },
            _getCursor: function getCursor() {
                return this.$menu.find(".tt-cursor").first();
            },
            _setCursor: function setCursor($el, silent) {
                $el.first().addClass("tt-cursor");
                !silent && this.trigger("cursorMoved");
            },
            _removeCursor: function removeCursor() {
                this._getCursor().removeClass("tt-cursor");
            },
            _moveCursor: function moveCursor(increment) {
                var $suggestions, $oldCursor, newCursorIndex, $newCursor;
                if (!this.isOpen) {
                    return;
                }
                $oldCursor = this._getCursor();
                $suggestions = this._getSuggestions();
                this._removeCursor();
                newCursorIndex = $suggestions.index($oldCursor) + increment;
                newCursorIndex = (newCursorIndex + 1) % ($suggestions.length + 1) - 1;
                if (newCursorIndex === -1) {
                    this.trigger("cursorRemoved");
                    return;
                } else if (newCursorIndex < -1) {
                    newCursorIndex = $suggestions.length - 1;
                }
                this._setCursor($newCursor = $suggestions.eq(newCursorIndex));
                this._ensureVisible($newCursor);
            },
            _ensureVisible: function ensureVisible($el) {
                var elTop, elBottom, menuScrollTop, menuHeight;
                elTop = $el.position().top;
                elBottom = elTop + $el.outerHeight(true);
                menuScrollTop = this.$menu.scrollTop();
                menuHeight = this.$menu.height() + parseInt(this.$menu.css("paddingTop"), 10) + parseInt(this.$menu.css("paddingBottom"), 10);
                if (elTop < 0) {
                    this.$menu.scrollTop(menuScrollTop + elTop);
                } else if (menuHeight < elBottom) {
                    this.$menu.scrollTop(menuScrollTop + (elBottom - menuHeight));
                }
            },
            close: function close() {
                if (this.isOpen) {
                    this.isOpen = false;
                    this._removeCursor();
                    this._hide();
                    this.trigger("closed");
                }
            },
            open: function open() {
                if (!this.isOpen) {
                    this.isOpen = true;
                    !this.isEmpty && this._show();
                    this.trigger("opened");
                }
            },
            setLanguageDirection: function setLanguageDirection(dir) {
                this.$menu.css(dir === "ltr" ? css.ltr : css.rtl);
            },
            moveCursorUp: function moveCursorUp() {
                this._moveCursor(-1);
            },
            moveCursorDown: function moveCursorDown() {
                this._moveCursor(+1);
            },
            getDatumForSuggestion: function getDatumForSuggestion($el) {
                var datum = null;
                if ($el.length) {
                    datum = {
                        raw: Dataset.extractDatum($el),
                        value: Dataset.extractValue($el),
                        datasetName: Dataset.extractDatasetName($el)
                    };
                }
                return datum;
            },
            getDatumForCursor: function getDatumForCursor() {
                return this.getDatumForSuggestion(this._getCursor().first());
            },
            getDatumForTopSuggestion: function getDatumForTopSuggestion() {
                return this.getDatumForSuggestion(this._getSuggestions().first());
            },
            update: function update(query) {
                _.each(this.datasets, updateDataset);
                function updateDataset(dataset) {
                    dataset.update(query);
                }
            },
            empty: function empty() {
                _.each(this.datasets, clearDataset);
                this.isEmpty = true;
                function clearDataset(dataset) {
                    dataset.clear();
                }
            },
            isVisible: function isVisible() {
                return this.isOpen && !this.isEmpty;
            },
            destroy: function destroy() {
                this.$menu.off(".tt");
                _.each(this.datasets, destroyDataset);
                function destroyDataset(dataset) {
                    dataset.destroy();
                }
            }
        });
        return Dropdown;
        function initializeDataset(oDataset) {
            return new Dataset(oDataset);
        }
    }();
    var Typeahead = function() {
        var attrsKey = "ttAttrs";
        function Typeahead(o) {
            var $menu, $input, $hint, datasets;
            o = o || {};
            if (!o.input) {
                $.error("missing input");
            }
            this.autoselect = !!o.autoselect;
            this.minLength = _.isNumber(o.minLength) ? o.minLength : 1;
            this.$node = buildDomStructure(o.input, o.withHint, o.menu);
            $menu = (o.menu ? $("." + o.menu) : false) || this.$node.find(".tt-dropdown-menu");
            $input = this.$node.find(".tt-input");
            $hint = this.$node.find(".tt-hint");
            this.eventBus = o.eventBus || new EventBus({
                el: $input
            });
            this.dropdown = new Dropdown({
                menu: $menu,
                datasets: o.datasets
            }).onSync("suggestionClicked", this._onSuggestionClicked, this).onSync("cursorMoved", this._onCursorMoved, this).onSync("cursorRemoved", this._onCursorRemoved, this).onSync("opened", this._onOpened, this).onSync("closed", this._onClosed, this).onAsync("datasetRendered", this._onDatasetRendered, this);
            this.input = new Input({
                input: $input,
                hint: $hint
            }).onSync("focused", this._onFocused, this).onSync("blurred", this._onBlurred, this).onSync("enterKeyed", this._onEnterKeyed, this).onSync("tabKeyed", this._onTabKeyed, this).onSync("escKeyed", this._onEscKeyed, this).onSync("upKeyed", this._onUpKeyed, this).onSync("downKeyed", this._onDownKeyed, this).onSync("leftKeyed", this._onLeftKeyed, this).onSync("rightKeyed", this._onRightKeyed, this).onSync("queryChanged", this._onQueryChanged, this).onSync("whitespaceChanged", this._onWhitespaceChanged, this);
            $menu.on("mousedown.tt", function($e) {
                if (_.isMsie() && _.isMsie() < 9) {
                    $input[0].onbeforedeactivate = function() {
                        window.event.returnValue = false;
                        $input[0].onbeforedeactivate = null;
                    };
                }
                $e.preventDefault();
            });
        }
        _.mixin(Typeahead.prototype, {
            _onSuggestionClicked: function onSuggestionClicked(type, $el) {
                var datum;
                if (datum = this.dropdown.getDatumForSuggestion($el)) {
                    this._select(datum);
                }
            },
            _onCursorMoved: function onCursorMoved() {
                var datum = this.dropdown.getDatumForCursor();
                this.input.clearHint();
                if (datum.datasetName == "routes-search") {
                    this.input.setInputValue(datum.raw.j, true);
                } else {
                    this.input.setInputValue(datum.value, true);
                }
                this.eventBus.trigger("cursorchanged", datum.raw, datum.datasetName);
            },
            _onCursorRemoved: function onCursorRemoved() {
                this.input.resetInputValue();
                this._updateHint();
            },
            _onDatasetRendered: function onDatasetRendered() {
                this._updateHint();
            },
            _onOpened: function onOpened() {
                if (this.minLength === 0 && this.input.getQuery() === "") {
                    this.dropdown.update("");
                }
                this._updateHint();
                this.eventBus.trigger("opened");
            },
            _onClosed: function onClosed() {
                this.input.clearHint();
                this.eventBus.trigger("closed");
            },
            _onFocused: function onFocused() {
                this.dropdown.empty();
                this.input.closeDisambiguation();
                this.dropdown.open();
            },
            _onBlurred: function onBlurred() {
                this.dropdown.close();
                this.input.closeDisambiguation();
            },
            _onEnterKeyed: function onEnterKeyed(type, $e) {
                var cursorDatum, topSuggestionDatum;
                cursorDatum = this.dropdown.getDatumForCursor();
                topSuggestionDatum = this.dropdown.getDatumForTopSuggestion();
                if (cursorDatum) {
                    this._select(cursorDatum);
                    $e.preventDefault();
                } else if (this.autoselect && topSuggestionDatum) {
                    this._select(topSuggestionDatum);
                    $e.preventDefault();
                }
            },
            _onTabKeyed: function onTabKeyed(type, $e) {
                var datum;
                if (datum = this.dropdown.getDatumForCursor()) {
                    this._select($.extend({}, datum, {
                        event: $e
                    }));
                    $e.preventDefault();
                } else {
                    this._autocomplete();
                }
            },
            _onEscKeyed: function onEscKeyed() {
                this.dropdown.close();
                this.input.resetInputValue();
            },
            _onUpKeyed: function onUpKeyed() {
                var query = this.input.getQuery();
                if (!this.dropdown.isOpen && query.length >= this.minLength) {
                    this.dropdown.update(query);
                }
                this.dropdown.open();
                this.dropdown.moveCursorUp();
            },
            _onDownKeyed: function onDownKeyed() {
                var query = this.input.getQuery();
                if (!this.dropdown.isOpen && query.length >= this.minLength) {
                    this.dropdown.update(query);
                }
                this.dropdown.open();
                this.dropdown.moveCursorDown();
            },
            _onLeftKeyed: function onLeftKeyed() {
                this.dir === "rtl" && this._autocomplete();
            },
            _onRightKeyed: function onRightKeyed() {
                this.dir === "ltr" && this._autocomplete();
            },
            _onQueryChanged: function onQueryChanged(e, query) {
                this.input.clearHint();
                this.dropdown.empty();
                query.length >= this.minLength && this.dropdown.update(query);
                this.dropdown.open();
                this._setLanguageDirection();
            },
            _onWhitespaceChanged: function onWhitespaceChanged() {
                this._updateHint();
                this.dropdown.open();
            },
            _setLanguageDirection: function setLanguageDirection() {
                var dir;
                if (this.dir !== (dir = this.input.getLanguageDirection())) {
                    this.dir = dir;
                    this.$node.css("direction", dir);
                    this.dropdown.setLanguageDirection(dir);
                }
            },
            _updateHint: function updateHint() {
                var datum, inputValue, query, escapedQuery, frontMatchRegEx, match;
                datum = this.dropdown.getDatumForTopSuggestion();
                if (datum && this.dropdown.isVisible() && !this.input.hasOverflow()) {
                    inputValue = this.input.getInputValue();
                    query = Input.normalizeQuery(inputValue);
                    escapedQuery = _.escapeRegExChars(query);
                    frontMatchRegEx = new RegExp("^(?:" + escapedQuery + ")(.*$)", "i");
                    match = frontMatchRegEx.exec(datum.value);
                    this.input.setHintValue(inputValue + (match ? match[1] : ""));
                }
            },
            _autocomplete: function autocomplete() {
                var hint, query, datum;
                hint = this.input.getHintValue();
                query = this.input.getQuery();
                if (hint && query !== hint && this.input.isCursorAtEnd()) {
                    datum = this.dropdown.getDatumForTopSuggestion();
                    datum && this.input.setInputValue(datum.value);
                    this.eventBus.trigger("autocompleted", datum.raw, datum.datasetName);
                }
            },
            _select: function select(datum) {
                this.input.clearHint();
                this.input.setQuery(datum.value);
                this.input.setInputValue(datum.value, true);
                this._setLanguageDirection();
                this.eventBus.trigger("selected", datum.raw, datum.datasetName, datum.event);
                this.dropdown.close();
                _.defer(_.bind(this.dropdown.empty, this.dropdown));
            },
            open: function open() {
                this.dropdown.open();
            },
            close: function close() {
                this.dropdown.close();
            },
            getQuery: function getQuery() {
                return this.input.getQuery();
            },
            setQuery: function setQuery(val) {
                this.input.setInputValue(val);
            },
            destroy: function destroy() {
                this.input.destroy();
                this.dropdown.destroy();
                destroyDomStructure(this.$node);
                this.$node = null;
            }
        });
        return Typeahead;
        function buildDomStructure(input, withHint, menu) {
            var $input, $wrapper, $dropdown, $hint, dropdownCss, $menu, $parent;
            $input = $(input);
            if (menu) {
                $parent = $(input).closest(".search-filter").parent();
                $menu = $parent.append("<div class='" + menu + "'></div>").find("." + menu);
            }
            dropdownCss = $menu ? css.fav.dropdown : css.dropdown;
            $wrapper = $(html.wrapper).css(css.wrapper);
            $dropdown = $(html.dropdown).css(dropdownCss);
            $hint = $input.clone().css(css.hint).css(getBackgroundStyles($input));
            $hint.val("").removeData().addClass("tt-hint").removeAttr("id name placeholder").prop("disabled", true).attr({
                autocomplete: "off",
                spellcheck: "false"
            });
            $input.data(attrsKey, {
                dir: $input.attr("dir"),
                autocomplete: $input.attr("autocomplete"),
                spellcheck: $input.attr("spellcheck"),
                style: $input.attr("style")
            });
            $input.addClass("tt-input").attr({
                autocomplete: "off",
                spellcheck: false
            }).css(withHint ? css.input : css.inputWithNoHint);
            try {
                !$input.attr("dir") && $input.attr("dir", "auto");
            } catch (e) {}
            if ($menu) {
                $menu.append($dropdown);
                return $input.wrap($wrapper).parent().prepend(withHint ? $hint : null);
            }
            return $input.wrap($wrapper).parent().prepend(withHint ? $hint : null).append($dropdown);
        }
        function getBackgroundStyles($el) {
            return {
                backgroundAttachment: $el.css("background-attachment"),
                backgroundClip: $el.css("background-clip"),
                backgroundColor: $el.css("background-color"),
                backgroundImage: $el.css("background-image"),
                backgroundOrigin: $el.css("background-origin"),
                backgroundPosition: $el.css("background-position"),
                backgroundRepeat: $el.css("background-repeat"),
                backgroundSize: $el.css("background-size")
            };
        }
        function destroyDomStructure($node) {
            var $input = $node.find(".tt-input");
            _.each($input.data(attrsKey), function(val, key) {
                _.isUndefined(val) ? $input.removeAttr(key) : $input.attr(key, val);
            });
            $input.detach().removeData(attrsKey).removeClass("tt-input").insertAfter($node);
            $node.remove();
        }
    }();
    (function() {
        var old, typeaheadKey, methods;
        old = $.fn.typeahead;
        typeaheadKey = "ttTypeahead";
        methods = {
            initialize: function initialize(o, datasets) {
                datasets = _.isArray(datasets) ? datasets : [].slice.call(arguments, 1);
                o = o || {};
                return this.each(attach);
                function attach() {
                    var $input = $(this), eventBus, typeahead;
                    _.each(datasets, function(d) {
                        d.highlight = !!o.highlight;
                    });
                    typeahead = new Typeahead({
                        input: $input,
                        eventBus: eventBus = new EventBus({
                            el: $input
                        }),
                        withHint: _.isUndefined(o.hint) ? true : !!o.hint,
                        minLength: o.minLength,
                        autoselect: o.autoselect,
                        datasets: datasets,
                        menu: o.menu
                    });
                    $input.data(typeaheadKey, typeahead);
                }
            },
            open: function open() {
                return this.each(openTypeahead);
                function openTypeahead() {
                    var $input = $(this), typeahead;
                    if (typeahead = $input.data(typeaheadKey)) {
                        typeahead.open();
                    }
                }
            },
            close: function close() {
                return this.each(closeTypeahead);
                function closeTypeahead() {
                    var $input = $(this), typeahead;
                    if (typeahead = $input.data(typeaheadKey)) {
                        typeahead.close();
                    }
                }
            },
            val: function val(newVal) {
                return !arguments.length ? getQuery(this.first()) : this.each(setQuery);
                function setQuery() {
                    var $input = $(this), typeahead;
                    if (typeahead = $input.data(typeaheadKey)) {
                        typeahead.setQuery(newVal);
                    }
                }
                function getQuery($input) {
                    var typeahead, query;
                    if (typeahead = $input.data(typeaheadKey)) {
                        query = typeahead.getQuery();
                    }
                    return query;
                }
            },
            destroy: function destroy() {
                return this.each(unattach);
                function unattach() {
                    var $input = $(this), typeahead;
                    if (typeahead = $input.data(typeaheadKey)) {
                        typeahead.destroy();
                        $input.removeData(typeaheadKey);
                    }
                }
            }
        };
        $.fn.typeahead = function(method) {
            if (methods[method]) {
                return methods[method].apply(this, [].slice.call(arguments, 1));
            } else {
                return methods.initialize.apply(this, arguments);
            }
        };
        $.fn.typeahead.noConflict = function noConflict() {
            $.fn.typeahead = old;
            return this;
        };
    })();
})(window.jQuery);

(function(o, undefined) {
    "use strict";
    tfl.logs.create("tfl.storage: loaded");
    var storage = tfl.isLocalStorageSupported ? window.localStorage : undefined;
    o.storageKeys = {
        cookiePolicyHidden: "cookiePolicyGdprNoticeHidden",
        favourites: "favourites",
        favouritesAuth: "favouritesAuth",
        hasPersonalisationUsed: "has-personalisation-used",
        recentJourneys: "recentJourneys",
        recentMagicSearches: "recentMagicSearches",
        recentSearches: "recentSearches",
        tempJPLocalStorage: "tempJPLocalStorage"
    };
    o.set = function(key, value, store) {
        if (tfl.isLocalStorageSupported && (storage || store) && key !== undefined) {
            try {
                var s = storage;
                if (store) {
                    s = store;
                }
                var parseValue = JSON.stringify(value);
                s.setItem(key, parseValue);
                tfl.logs.create("tfl.storage.set: " + key + ":" + parseValue);
            } catch (e) {
                tfl.logs.create("tfl.storage.set:" + e.message, "error");
            }
        }
    };
    o.setSessionStorage = function(key, value) {
        o.set(key, value, window.sessionStorage);
    };
    o.get = function(key, defaultValue, store) {
        if (tfl.isLocalStorageSupported && (storage || store)) {
            try {
                var s = storage;
                if (store) {
                    s = store;
                }
                var value = s.getItem(key);
                if (value !== null) {
                    return JSON.parse(value);
                }
            } catch (e) {
                tfl.logs.create("tfl.storage.get:" + e.message, "error");
            }
        }
        if (defaultValue !== "") {
            tfl.logs.create("tfl.storage.get: " + key + ":" + defaultValue);
            return defaultValue;
        }
        tfl.logs.create("tfl.storage.get: " + key + ": []");
        return [];
    };
    o.getSessionStorage = function(key, defaultValue) {
        return o.get(key, defaultValue, window.sessionStorage);
    };
    o.showIfNotDisabled = function(key, callbackShowOnEnabledOrFailure) {
        if (tfl.isLocalStorageSupported && storage) {
            try {
                var isHidden = JSON.parse(o.get(key, false));
                if (!isHidden) {
                    callbackShowOnEnabledOrFailure();
                }
            } catch (e) {
                callbackShowOnEnabledOrFailure();
            }
        } else {
            callbackShowOnEnabledOrFailure();
        }
    };
    o.getRecentMagicSearchesByModes = function(modes, defaultValue, store) {
        if (!tfl.isLocalStorageSupported) {
            return undefined;
        }
        var value = [];
        var valueByModes = {};
        var results = [];
        var modesArray = modes.split(",");
        value = o.get(o.storageKeys.recentMagicSearches, defaultValue, store);
        if (value.stops) {
            for (var key in value.stops) {
                if (value.stops.hasOwnProperty(key)) {
                    var stop = value.stops[key];
                    for (var index = 0; index < stop.modes.length; index++) {
                        var element = stop.modes[index];
                        if (modesArray.indexOf(element) > -1) {
                            results.push(stop);
                            break;
                        }
                    }
                }
            }
        }
        tfl.logs.create("tfl.storage.getRecentMagicSearchesByModes: For " + modes + ": found " + results.length + " stops.");
        return results;
    };
})(window.tfl.storage = window.tfl.storage || {});

(function(utils) {
    "use strict";
    tfl.logs.create("tfl.utils: loaded");
    var returnTrue = function() {
        return true;
    };
    var returnFalse = function() {
        return false;
    };
    utils.supportsSVG = function() {
        if (!!document.createElementNS && !!document.createElementNS("http://www.w3.org/2000/svg", "svg").createSVGRect) {
            utils.supportsSVG = returnTrue;
        } else {
            $(document.body).addClass("nosvg");
            utils.supportsSVG = returnFalse;
        }
    };
    utils.supportsFlexbox = function() {
        var types = [ "flexWrap", "webkitFlexWrap", "mozFlexWrap", "msFlexWrap" ];
        for (var type in types) {
            if (document.body.style[type] !== undefined) {
                $(document.body).addClass("flexbox");
                utils.supportsFlexbox = returnTrue;
                return true;
            }
        }
        $(document.body).addClass("no-flexbox");
        utils.supportsFlexbox = returnFalse;
        return false;
    };
    utils.browserDetection = function() {
        var useragent = navigator.userAgent.toLowerCase();
        var isSafari = /safari/.test(useragent) && !/crios/.test(useragent) && /Apple Computer/.test(navigator.vendor);
        if (isSafari) {
            $("html").addClass(tfl.dictionary.browserClasses.isSafari);
        }
    };
    utils.isTouchDevice = function() {
        return !!("ontouchstart" in window) || !!("onmsgesturechange" in window);
    };
    function polyfillAnimFrame() {
        if (window.requestAnimationFrame) {
            utils.requestAnimFrame = function(callback) {
                window.requestAnimationFrame(callback);
            };
        } else if (window.webkitRequestAnimationFrame) {
            utils.requestAnimFrame = function(callback) {
                window.webkitRequestAnimationFrame(callback);
            };
        } else if (window.mozRequestAnimationFrame) {
            utils.requestAnimFrame = function(callback) {
                window.mozRequestAnimationFrame(callback);
            };
        } else {
            utils.requestAnimFrame = function(callback) {
                window.setTimeout(callback, 1e3 / 60);
            };
        }
    }
    function polyfillIndexOf() {
        Array.prototype.indexOf = function(searchElement) {
            var n, k, t = Object(this), len = t.length >>> 0;
            if (len === 0) {
                return -1;
            }
            n = 0;
            if (arguments.length > 1) {
                n = Number(arguments[1]);
                if (n !== n) {
                    n = 0;
                } else if (n !== 0 && n !== Infinity && n !== -Infinity) {
                    n = (n > 0 || -1) * Math.floor(Math.abs(n));
                }
            }
            if (n >= len) {
                return -1;
            }
            for (k = n >= 0 ? n : Math.max(len - Math.abs(n), 0); k < len; k++) {
                if (k in t && t[k] === searchElement) {
                    return k;
                }
            }
            return -1;
        };
    }
    function polyfillBind() {
        Function.prototype.bind = function(oThis) {
            if (typeof this !== "function") {
                throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");
            }
            var aArgs = Array.prototype.slice.call(arguments, 1), fToBind = this, FNop = function() {}, fBound = function() {
                return fToBind.apply(this instanceof FNop && oThis ? this : oThis, aArgs.concat(Array.prototype.slice.call(arguments)));
            };
            FNop.prototype = this.prototype;
            fBound.prototype = new FNop();
            return fBound;
        };
    }
    function polyfillTrim() {
        String.prototype.trim = function() {
            return this.replace(/^\s+|\s+$/g, "");
        };
    }
    utils.runOnImgComplete = function(img, callback) {
        if (img.nodeType === 1 && img.tagName.toLowerCase() === "img" && img.src !== "") {
            if (img.complete || img.readyState === 4) {
                callback();
            } else if (img.readyState === "uninitialized" && img.src.indexOf("data:") === 0) {
                tfl.logs.create("tfl.utils.runOnImgComplete: failed to load " + img.src);
            } else {
                $(img).one("load", callback);
            }
        }
    };
    utils.convertStringToBool = function(stringValue) {
        return stringValue && utils.isString(stringValue) && stringValue.toLowerCase() === "true";
    };
    utils.show = function($element) {
        $element.removeClass(tfl.dictionary.hiddenElemClass);
    };
    utils.hide = function($elements) {
        $elements.addClass(tfl.dictionary.hiddenElemClass);
    };
    utils.getChargeDatepickerOpts = function(inputVal) {
        var dpOpts = {};
        if (inputVal.toLowerCase() === tfl.dictionary.chargingZones.CC) {
            dpOpts.beforeShowDay = $.datepicker.noWeekends;
        }
        return dpOpts;
    };
    utils.intersectionExists = function(arrayToSearch, sourceArray) {
        return sourceArray.some(function(v) {
            return arrayToSearch.indexOf(v.toLowerCase()) >= 0;
        });
    };
    utils.filterInvalidModes = function(value, index, array) {
        return tfl.modesToExclude.indexOf(value) < 0;
    };
    utils.addLoadEvent = function(func) {
        var oldonload = window.onload;
        if (typeof window.onload != "function") {
            window.onload = func;
        } else {
            window.onload = function() {
                if (oldonload) {
                    oldonload();
                }
                func();
            };
        }
    };
    utils.stringFormat = function(format) {
        var args = Array.prototype.slice.call(arguments, 1);
        return format.replace(/{(\d+)}/g, function(match, number) {
            return typeof args[number] != "undefined" ? args[number] : match;
        });
    };
    utils.mapViwedOnSmallDevice = function() {
        return $("body").hasClass("breakpoint-Small") && !$("body").hasClass("breakpoint-Large") && !$("body").hasClass("breakpoint-Medium");
    };
    utils.isString = function(object) {
        return Object.prototype.toString.call(object) === "[object String]";
    };
    function polyfillArrayFind() {
        if (!Array.prototype.find) {
            Array.prototype.find = function(predicate) {
                if (this === null) {
                    throw new TypeError("Array.prototype.find called on null or undefined");
                }
                if (typeof predicate !== "function") {
                    throw new TypeError("predicate must be a function");
                }
                var list = Object(this);
                var length = list.length >>> 0;
                var thisArg = arguments[1];
                var value;
                for (var i = 0; i < length; i++) {
                    value = list[i];
                    if (predicate.call(thisArg, value, i, list)) {
                        return value;
                    }
                }
                return undefined;
            };
        }
    }
    function arraySortByPropertyName() {
        if (Array.prototype.sortBy) {
            return true;
        }
        Array.prototype.sortBy = function(p) {
            return this.slice(0).sort(function(a, b) {
                return a[p] > b[p] ? 1 : a[p] < b[p] ? -1 : 0;
            });
        };
    }
    function init() {
        tfl.logs.create("tfl.utils: started");
        utils.supportsSVG();
        utils.supportsFlexbox();
        utils.browserDetection();
        if (!Array.prototype.indexOf) {
            polyfillIndexOf();
        }
        if (!Function.prototype.bind) {
            polyfillBind();
        }
        if (!String.prototype.trim) {
            polyfillTrim();
        }
        polyfillAnimFrame();
        polyfillArrayFind();
        arraySortByPropertyName();
    }
    utils.viewPorts = {
        small: 1,
        medium: 2,
        large: 3
    };
    utils.getViewPort = function getViewPort() {
        var body = $("body");
        if (body.hasClass("breakpoint-Large")) return utils.viewPorts.large;
        if (body.hasClass("breakpoint-Medium")) return utils.viewPorts.medium;
        if (body.hasClass("breakpoint-Small")) return utils.viewPorts.small;
    };
    utils.getParameterByName = function(name, url) {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    };
    utils.tabKeyEvent = function(event) {
        var handled = false;
        if (!event) return handled;
        if (event.defaultPrevented) return handled;
        if (hasTabEventKey(event) || hasTabEventKeyCode(event)) handled = true;
        if (handled) event.preventDefault();
        return handled;
        function hasTabEventKey(event) {
            return event.key && event.key.toLowerCase() === "tab";
        }
        function hasTabEventKeyCode(event) {
            return event.keyCode && event.keyCode === 9;
        }
    };
    init();
})(window.tfl.utils = window.tfl.utils || {});

(function(o) {
    "use strict";
    function isDefined(prop) {
        if (prop === undefined) {
            tfl.logs.create("error instantiating object - mandatory field not populated");
            return false;
        }
        return true;
    }
    o.modes = [ tfl.modeNameTube, tfl.modeNameBus, tfl.modeNameTram, tfl.modeNameRiver, tfl.modeNameCableCar, tfl.modeNameOverground, tfl.modeNameTflRail, tfl.modeNameDlr, tfl.modeNameMultiModal, tfl.modeJourney, tfl.modePlace ];
    o.SSPObject = function(naptanId, mode, props) {
        props = props || {};
        if (!isDefined(naptanId) || !isDefined(mode)) return {
            error: "naptanId and mode are mandatory"
        };
        if (o.modes.indexOf(mode) < 0) return {
            error: "invalid mode supplied"
        };
        this.naptanId = naptanId;
        this.mode = mode;
        this.props = $.extend({
            lines: [],
            name: "",
            towards: ""
        }, props);
    };
    tfl.logs.create("tfl.objects: loaded");
})(window.tfl.objects = window.tfl.objects || {});

(function(window) {
    "use strict";
    function removeIOSRubberEffect(e) {
        var self = e.currentTarget ? e.currentTarget : e.srcElement;
        var top = self.scrollTop, totalScroll = self.scrollHeight, currentScroll = top + self.offsetHeight;
        if (top === 0) {
            self.scrollTop = 1;
        } else if (currentScroll === totalScroll) {
            self.scrollTop = top - 1;
        }
    }
    function preventScrollingWhereNotNecessary(e) {
        var self = e.currentTarget ? e.currentTarget : e.srcElement;
        if (self.className && self.className.indexOf("scrollable") > -1 && self.scrollHeight <= self.clientHeight) {
            e.preventDefault();
        }
    }
    function fixScrollableElements(elements) {
        for (i = 0; i < elements.length; i++) {
            var element = elements[i];
            element.addEventListener("touchstart", removeIOSRubberEffect);
            element.addEventListener("touchmove", preventScrollingWhereNotNecessary);
        }
    }
    function disableTouchScrolling(e) {
        e.preventDefault();
    }
    function disableTouchScrollingOfBackground(elements) {
        for (i = 0; i < elements.length; i++) {
            var element = elements[i];
            element.addEventListener("touchmove", disableTouchScrolling);
        }
    }
    var toDisable = document.querySelectorAll(".disable-touch-scrolling");
    disableTouchScrollingOfBackground(toDisable);
    var scrollables = document.querySelectorAll(".scrollable");
    fixScrollableElements(scrollables);
    function Menu(options) {
        this.options = jQuery.extend({}, this.options);
        jQuery.extend(this.options, options);
        this._init();
    }
    Menu.prototype.options = {
        wrapper: "#o-wrapper",
        type: "slide-left",
        maskId: "#c-mask",
        isActive: false
    };
    Menu.prototype._init = function() {
        this.body = document.body;
        this.wrapper = document.querySelector(this.options.wrapper);
        this.mask = document.querySelector(this.options.maskId);
        this.menu = document.querySelector(this.options.type);
        this.isActive = this.options.isActive;
        this.defaultPanelWidth = this.menu.offsetWidth;
    };
    Menu.prototype.open = function() {
        this.body.className += " has-active-menu";
        this.wrapper.className += " has-" + this.options.type;
        this.menu.className += " is-active";
        this.mask.className += " is-active";
    };
    Menu.prototype.close = function() {
        tfl.logs.create("tfl.panel.close");
        this.body.className = this.body.className.replace(" has-active-menu", "");
        this.wrapper.className = this.wrapper.className.replace(" has-" + this.options.type, "");
        this.menu.className = this.menu.className.replace(" is-active", "");
        this.mask.className = this.mask.className.replace(" is-active", "");
    };
    window.Menu = Menu;
})(window);

var tfl = tfl || {};

(function(tfl) {
    "use strict";
    tfl.logs.create("tfl.core: loaded");
    tfl.checkForIE = function() {
        if (!!window.MSInputMethodContext && !!document.documentMode) {
            $('a[href="#mainnav"]').click(function(e) {
                e.preventDefault();
                document.querySelector("#mainnav a").focus();
            });
            $('a[href="#full-width-content"]').click(function(e) {
                e.preventDefault();
                var isContentPage = document.querySelector(".home");
                return isContentPage ? document.querySelector(".home a").focus() : document.querySelector("#jp-new-tab-home a").focus();
            });
            $('a[href="#footer"]').click(function(e) {
                e.preventDefault();
                document.querySelector("#footer a").focus();
            });
        }
    };
    tfl.init = function() {
        tfl.logs.create("tfl.core: started");
        tfl.checkForIE();
        tfl.setFocusOnSwitchDirectionBtn();
        tfl.checkIfDatePicker();
        tfl.captureDate();
        tfl.responsive.init();
        tfl.interactions.init();
    };
    tfl.getQueryParam = function(name, url) {
        if (!url) {
            url = window.location.search;
        }
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]").toLowerCase();
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(url.toLowerCase());
        if (results === null) return ""; else return decodeURIComponent(results[1].replace(/\+/g, " "));
    };
    tfl.interactions = {
        init: function() {
            tfl.logs.create("tfl.interactions: started");
            tfl.interactions.externalLinks();
            $(".top-row .more").click(tfl.interactions.toggleNavigation);
            $(".top-row .fav-icon-container").click(tfl.interactions.openStatusFavouritesPanel);
            $(".show-mobile-search").click(tfl.interactions.toggleMobileSearch);
            $("#footer h2.heading").wrap('<a href="#info-for" class="info-for-link" />');
            $("#footer a.info-for-link").click(tfl.interactions.toggleFooter);
            tfl.interactions.initBottomAdvert();
            $(document).keydown(function(e) {
                var el = [], $active = $(document.activeElement);
                if (e.shiftKey && e.keyCode === 9) {
                    var back = $active.attr("data-jumpback") || $active.data("jumpback");
                    if (back !== undefined) {
                        el = typeof back === "string" ? $(back) : el = back;
                    }
                } else if (e.which === 9) {
                    var forward = $active.attr("data-jumpto") || $active.data("jumpto");
                    if (forward !== undefined) {
                        el = typeof forward === "string" ? $(forward) : el = forward;
                    }
                }
                if (el.length > 0) {
                    el = el.length > 1 ? el.first() : el;
                    el.focus();
                    $(".ui-menu-item").hide();
                    return false;
                }
            });
            $("input[type='text']:not([autocomplete])").attr("autocomplete", "off");
        },
        toggleNavigation: function() {
            var $extraNav = $(".extra-nav");
            var $moreLink = $(".top-row .more").children("a");
            if ($(".top-row.show-search").is(":visible")) {
                tfl.interactions.toggleMobileSearch();
            }
            $moreLink.toggleClass("expanded");
            if ($moreLink.attr("aria-selected") === "false") {
                $moreLink.attr("aria-selected", "true");
            } else {
                $moreLink.attr("aria-selected", "false");
            }
            if ($moreLink.attr("aria-expanded") === "false") {
                $moreLink.attr("aria-expanded", "true");
            } else {
                $moreLink.attr("aria-expanded", "false");
            }
            $extraNav.toggleClass("expanded");
            if ($extraNav.attr("aria-hidden") === "true") {
                $extraNav.attr("aria-hidden", "false");
            } else {
                $extraNav.attr("aria-hidden", "true");
            }
            $("#container").toggleClass("menu-visible");
            $extraNav.find(".menu-sub-section:last").find("ul").find("li:last").find("a").blur(function() {
                $("input#q").focus();
            });
            return false;
        },
        openStatusFavouritesPanel: function() {
            tfl.logs.create("tfl.core.openStatusFavouritesPanel");
            tfl.favouritesPanel.openStatusFavouritesPanel();
        },
        initBottomAdvert: function() {
            var showCloseButton = tfl && tfl.showBottomAdvertCloseButton;
            if (!showCloseButton || /^false/i.test(showCloseButton) || !/^true/i.test(showCloseButton)) {
                return true;
            }
            $(".close-ad-button").removeClass("visually-hidden");
            var bottomAd = tfl.storage.getSessionStorage("bottomAd");
            if (bottomAd) {
                $(".bottom-advert").addClass("visually-hidden");
            }
            $(".close-ad-button").on("click", function() {
                tfl.storage.setSessionStorage("bottomAd", true);
                $(".bottom-advert").addClass("visually-hidden");
            });
        },
        externalLinks: function() {
            tfl.logs.create("external link classes: initialised");
            $("a").filter(function() {
                return this.hostname && this.hostname !== location.hostname && $(this).attr("target") !== "_blank";
            }).addClass("external-link");
            $("a.external-link,a.document-download-wrap").attr("target", "_parent");
            tfl.logs.create("external link classes: added");
        },
        toggleMobileSearch: function() {
            if ($(".extra-nav.expanded").is(":visible")) {
                tfl.interactions.toggleNavigation();
            }
            var el = $(".show-mobile-search");
            var journeyPlannerButton = ".journey-form #plan-a-journey tabbable:first,#main-hero :tabbable:first";
            var searchBox = "#query";
            if (el.attr("data-jumpto") === journeyPlannerButton) {
                el.attr("data-jumpto", searchBox);
            } else if (el.attr("data-jumpto") === searchBox) {
                el.attr("data-jumpto", journeyPlannerButton);
            }
            $(".search-tools").find("a").css("top", "5px");
            $(".top-row").toggleClass("show-search");
            var searchLink = document.querySelector(".show-mobile-search");
            if (searchLink.getAttribute("aria-expanded") === "false") {
                searchLink.setAttribute("aria-expanded", "true");
            } else {
                searchLink.setAttribute("aria-expanded", "false");
            }
            return false;
        },
        toggleFooter: function() {
            $(".primary-footer").toggleClass("expanded");
            return false;
        }
    };
    tfl.responsive = {
        init: function() {
            tfl.logs.create("tfl.responsive: started");
            tfl.responsive.setupBreakpoints();
            $(".top-row .logo").after("<div role='navigation' aria-label='Main menu'><ul class='collapsible-menu clearfix'>&nbsp;</ul></div>");
            var menu = $(".collapsible-menu");
            menu.append($(".plan-journey").clone());
            menu.append($(".status-update").clone());
            menu.append($(".maps").clone());
            menu.append($(".fares-and-payments").clone());
            menu.append($(".help-and-contact").clone());
            $(".collapsible-menu a").removeAttr("data-jumpback");
            menu.append("<li class='more'><a href='javascript:void(0)' data-jumpto='.extra-nav a:visible:first' id='more-tab' role='tab' aria-controls='more-panel' aria-selected='false' aria-expanded='false'><span class='text'>More<span class='visually-hidden'> menu options</span></span><span class='arrow'>&nbsp;</span></a></li></li>");
            $(".texts").append('<div class="search"><a href="javascript:void(0);" class="show-mobile-search" aria-expanded="false" data-jumpto=".journey-form #plan-a-journey tabbable:first,#main-hero :tabbable:first"><span class="search-icon hide-text">Search</span><span class="collapse"></span><span class="expand"></span></a></div>');
            $(".top-row-extras").prepend("<div class='more'><a href='javascript:void(0)' data-jumpto='.extra-nav a:first:visible'><span class='text'>Menu</span><span class='arrow'>&nbsp;</span></a></li></div>");
            if (tfl.isLocalStorageSupported) {
                $("body").removeClass("personalisation-inactive").addClass("personalisation-active");
                $(".top-row").children(".r").append("<div id='o-wrapper' class='o-wrapper'>" + "<div class='o-content'>" + "<div class='o-container'><div id='favourite-menu' class='c-buttons fav-menu'>" + "<button id='c-button-slide-right'" + "data-jumpto='.extra-nav a:first:visible' " + "class='fav-icon-container outline-dotted-thin open-onboard-modal onboard-modal-below onboard-modal-left' " + "aria-haspopup='true' " + "aria-expanded='false' " + "aria-controls='favourites-panel' " + "data-modal-adjt='45' " + "data-modal-adjl='25' " + "data-tracking-event='pers_open_panel' " + "data-tracking='pers_open_panel_details' " + "data-tracking-value='Global|star' " + "data-newReturnUser='true' " + "data-control-favourites='true' " + "tabindex='0'>" + "<span class='fav-icon large-icon c-button hide-text'>Open Favourites</span>" + "</button></div></div></div></div>");
            } else {
                {
                    $("body").removeClass("personalisation-active").addClass("personalisation-inactive");
                }
            }
            if (!tfl.featureToggle.isSavePlaceWithLabelsEnabled()) {
                $("body").addClass("save-place-inactive");
            }
            $(".moving-source-order").appendAround();
            tfl.responsive.initLazyLoadedImages();
        },
        setupBreakpoints: function() {
            $(window).setBreakpoints({
                distinct: false,
                breakpoints: tfl.settings.devices
            });
        },
        initLazyLoadedImages: function() {
            $("[data-img]").each(function() {
                var that = $(this);
                var showImg = function() {
                    $(that).children("img").remove();
                    var img = $("<img>").attr({
                        src: that.attr("data-img"),
                        alt: that.attr("data-img-alt")
                    }).load(function() {
                        if (that.data("img-background")) {
                            that.css("background-image", "url(" + that.attr("data-img") + ")");
                        } else {
                            that.prepend(img);
                            img.attr({
                                width: img.width(),
                                height: img.height()
                            });
                        }
                    });
                    if (img[0].width) img.load();
                };
                if ($(this).attr("data-img-breakpoint") === "medium") {
                    $(window).one("enterBreakpointMedium", showImg);
                    if ($("body.breakpoint-Medium").length > 0) {
                        $(window).trigger("enterBreakpointMedium");
                    }
                } else {
                    $(window).one("enterBreakpointLarge", showImg);
                    if ($("body.breakpoint-Large").length > 0) {
                        $(window).trigger("enterBreakpointLarge");
                    }
                }
            });
        }
    };
    tfl.featureToggle = {
        isSavePlaceWithLabelsEnabled: function() {
            return tfl.showGetMeHome && tfl.showGetMeHome.savePlace;
        }
    };
    $.fn.tflPopup = function(options) {
        var obj = $(this);
        var settings = $.extend({
            title: "This is the default title",
            content: "",
            showingPercentage: 100,
            displayNoThanksLink: true,
            displayNotAgainLink: true,
            noThanksLinkText: "No thanks",
            notAgainLinkText: "No thanks, and don't ask me again",
            link: {},
            campaignId: "DefaultPopup",
            displayMode: "toaster",
            lightboxContentUrl: "",
            storageKey: "Popups.Never."
        }, options);
        function getNeverForCampaign() {
            return tfl.storage.get(settings.storageKey + settings.campaignId);
        }
        function setNeverForCampaign(value) {
            tfl.storage.set(settings.storageKey + settings.campaignId, value);
        }
        function stopShowingIfUserClicksThrough() {
            setNeverForCampaign(true);
            return true;
        }
        if (settings.showingPercentage === 0 || getNeverForCampaign()) {
            return;
        }
        if (settings.showingPercentage < 100) {
            var rdn = Math.floor(Math.random() * 100);
            if (rdn > settings.showingPercentage) return;
        }
        if (settings.displayMode === "lightbox") {
            var root = $('<span class="light-box"></span>');
            var lightboxLink = $(window.hoganTemplates.surveyLightboxLink.render({
                link: settings.lightboxContentUrl
            }));
            root.append(lightboxLink);
            obj.append(root);
            lightboxLink.LightBox();
            $(function() {
                lightboxLink.click();
            });
            var closeLightBox = function() {
                $(".close-light-box").click();
            };
            var closeAndNeverShowAgain = function() {
                setNeverForCampaign(true);
                closeLightBox();
            };
            var closeAndShowNextTime = function() {
                closeLightBox();
            };
            $(document).on("click", ".survey-role-yes", stopShowingIfUserClicksThrough);
            $(document).on("click", ".survey-role-later", closeAndShowNextTime);
            $(document).on("click", ".survey-role-never", closeAndNeverShowAgain);
        }
        if (settings.displayMode === "toaster") {
            var popup = $(window.hoganTemplates.surveyToasterWrapper.render(settings));
            var content = $(window.hoganTemplates.surveyToasterContent.render($.extend(settings, {
                showContent: settings.content.length > 0
            })));
            $(document).on("click", "#survey-toaster-yes-link", stopShowingIfUserClicksThrough);
            var hidePopup = function(e) {
                e.stopPropagation();
                e.preventDefault();
                popup.css({
                    bottom: -1 * popupHeight + "px"
                });
                window.setTimeout(function() {
                    popup.addClass("hidden");
                }, 1e3);
            };
            var neverShowAgain = function() {
                setNeverForCampaign(true);
            };
            if (settings.displayNoThanksLink) {
                var noThanksLink = $(window.hoganTemplates.surveyToasterNegativeLink.render({
                    title: settings.noThanksLinkText,
                    text: settings.noThanksLinkText
                }));
                content.append(noThanksLink);
                noThanksLink.on("click", hidePopup);
            }
            if (settings.displayNotAgainLink) {
                var notAgainLink = $(window.hoganTemplates.surveyToasterNegativeLink.render({
                    title: settings.notAgainLinkText,
                    text: settings.notAgainLinkText
                }));
                content.append(notAgainLink);
                notAgainLink.on("click", hidePopup).on("click", neverShowAgain);
            }
            popup.append(content);
            popup.css({
                bottom: "-1000px"
            });
            obj.append(popup);
            var height = content.outerHeight(true);
            var cssDown = {
                bottom: height * -1 + "px"
            };
            var cssUp = {
                bottom: 0
            };
            popup.on("click", function() {
                var el = $(this), icon = el.find("#survey-toaster-icon");
                if (el.css("bottom") === "0px") {
                    el.css(cssDown);
                    icon.attr("class", "popup-title-icon white-up-arrow");
                } else {
                    el.css(cssUp);
                    icon.attr("class", "popup-title-icon white-down-arrow");
                }
            });
            var popupHeight = popup.outerHeight(true);
            popup.css(-1 * popupHeight + "px");
            window.setTimeout(function() {
                popup.css(cssDown);
            }, 2e3);
        }
    };
    $.fn.tflBanner = function(options) {
        var obj = $(this);
        var settings = $.extend({
            title: "This is the default title",
            showingPercentage: 100,
            links: [],
            campaignId: "DefaultBanner"
        }, options);
        if (settings.showingPercentage === 0 || tfl.storage.get("Banners." + settings.campaignId) || tfl.storage.getSessionStorage("Banners." + settings.campaignId)) {
            return;
        }
        if (settings.showingPercentage < 100) {
            var rdn = Math.floor(Math.random() * 100);
            if (rdn > settings.showingPercentage) return;
        }
        var hideBanner = function(e) {
            e.stopPropagation();
            e.preventDefault();
            popup.css({
                bottom: -1 * popupHeight + "px"
            });
            tfl.storage.setSessionStorage("Banners." + settings.campaignId, true);
            window.setTimeout(function() {
                popup.addClass("hidden");
            }, 1e3);
        };
        var cancelBanner = function(e) {
            tfl.storage.set("Banners." + settings.campaignId, true);
            e.preventDefault();
        };
        var popup = $("<div></div>").addClass("popup-banner");
        var title = $("<span></span>").addClass("popup-title").text(settings.title);
        var icon = $('<a href="#" class="popup-title-icon close-icon-white hide-text"><span>Close this banner</span></a>');
        icon.click(hideBanner).click(cancelBanner);
        for (var i = 0; i < settings.links.length; i++) {
            var l = settings.links[i];
            var link = $("<a></a>").attr({
                href: l.url,
                title: l.title,
                class: "popup-link"
            }).text(l.title);
            title.append(link);
        }
        popup.append(title).append(icon);
        obj.append(popup);
        var popupHeight = popup.outerHeight(true);
    };
    tfl.setFocusOnSwitchDirectionBtn = function() {
        var detectRefresh = tfl.getParameterByName("redirect");
        if (detectRefresh === "true") {
            window.history.replaceState({}, document.title, window.location.href.split("&redirect=true")[0]);
            document.getElementById("route-direction-btn").focus();
        }
    };
    tfl.getParameterByName = function(name) {
        var url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"), results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    };
    tfl.modeRanks = [ {
        name: "tube",
        rank: 1
    }, {
        name: "overground",
        rank: 2
    }, {
        name: "tflrail",
        rank: 3
    }, {
        name: "dlr",
        rank: 4
    }, {
        name: "bus",
        rank: 5
    }, {
        name: "national-rail",
        rank: 6
    }, {
        name: "tram",
        rank: 7
    }, {
        name: "river-bus",
        rank: 8
    }, {
        name: "cable-car",
        rank: 9
    } ];
    tfl.checkIfDatePicker = function() {
        var selectDatePicker = function(event) {
            var expectedId = "TravelContact_DateOfTravel";
            var capturedId = event.target.id;
            if (event.key === "Tab") {
                if (capturedId === expectedId) {
                    document.querySelector("#TravelContact_DateOfTravel").focus();
                    tfl.captureDate();
                }
            }
        };
        var body = document.querySelector("body");
        body.addEventListener("keyup", selectDatePicker);
    };
    tfl.captureDate = function() {
        var dateRegex = new RegExp(/^(0[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/);
        var capture = function(event) {
            if (event.target.id === "TravelContact_DateOfTravel") {
                var value = document.getElementById("TravelContact_DateOfTravel").value;
                if (dateRegex.exec(value)) {
                    tfl.validateDate(value);
                }
            }
        };
        var body = document.querySelector("body");
        body.addEventListener("keyup", capture);
    };
    tfl.validateDate = function(capturedDate) {
        var currentDate = new Date();
        var utcCurrent = Date.UTC(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate(), 0, 0, 0, 0);
        var dateParts = capturedDate.split(capturedDate[2]);
        var month = parseInt(dateParts[1]) - 1;
        var day = dateParts[2];
        var year = dateParts[0];
        var parsedDate = Date.UTC(day, month, year, 0, 0, 0, 0);
        var invalidDate = "Date cannot be in the future.";
        if (parsedDate > utcCurrent) {
            document.getElementById("TravelContact_DateOfTravel").value = "";
            document.getElementById("TravelContact_DateOfTravel").placeholder = invalidDate;
        }
    };
    tfl.init();
})(tfl);

(function(o) {
    var UrlCollection = function(url) {
        url = url || window.location.search;
        var urlParts = url.split("?"), queryString = urlParts.length === 1 ? "" : urlParts[1], vars = queryString.split("&"), pair, i;
        for (i = 0; i < vars.length; i += 1) {
            pair = vars[i].split("=");
            if (pair[0].length > 0) {
                this[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
            }
        }
        this.update = function() {
            var args = [].slice.call(arguments);
            if (args.length === 1 && $.isArray(args[0])) {
                args = args[0];
            }
            for (var i = 0; i < args.length; i += 2) {
                if (typeof args[i] === "string" && args.length > i + 1 && args[i].length > 0) {
                    this[args[i]] = args[i + 1];
                }
            }
            return this;
        };
        this.remove = function() {
            var args = [].slice.call(arguments);
            if (args.length === 1 && $.isArray(args[0])) {
                args = args[0];
            }
            for (var i = 0; i < args.length; i++) {
                if (typeof args[i] === "string") {
                    delete this[args[i]];
                }
            }
            return this;
        };
        this.pushState = function(title, state) {
            title = title || "";
            state = state || {};
            if (window.history.pushState) {
                window.history.pushState(state, title, this.toString());
            } else {
                if (urlParts[0] === "") {
                    urlParts[0] = window.location.pathname;
                }
                window.location = this.toString();
            }
        };
        this.toString = function() {
            var pairs = [];
            for (var v in this) {
                if (typeof this[v] !== "function") {
                    pairs.push(encodeURIComponent(v) + "=" + encodeURIComponent(this[v]));
                }
            }
            return urlParts[0] + "?" + pairs.join("&");
        };
    };
    o.getUrlCollection = function(url) {
        return new UrlCollection(url);
    };
    o.getQueryString = function(param) {
        var value, queryStringCollection = new UrlCollection();
        if (param && typeof param === "string") {
            value = queryStringCollection[param];
            if (typeof value === "undefined") {
                value = null;
            }
            return value;
        }
        return queryStringCollection;
    };
    o.getQueryStringParameter = function(param, url) {
        url = url || window.location.search;
        var urlParts = url.split("?"), queryString = urlParts.length === 1 ? "" : urlParts[1], vars = queryString.split("&"), i;
        for (i = 0; i < vars.length; i += 1) {
            var pair = vars[i].split("=");
            if (decodeURIComponent(pair[0]).toLowerCase() === param.toLowerCase()) {
                return decodeURIComponent(pair[1]);
            }
        }
        return null;
    };
    o.setQueryStringParameter = function(param, value) {
        if (window.history.pushState !== undefined) {
            var queryString = window.location.search.substring(1), vars = queryString.split("&"), i, found = false;
            for (i = 0; i < vars.length; i += 1) {
                var pair = vars[i].split("=");
                if (decodeURIComponent(pair[0]).toLowerCase() === param.toLowerCase()) {
                    pair[1] = encodeURIComponent(value);
                    vars[i] = pair.join("=");
                    window.history.pushState({}, "", "?" + vars.join("&"));
                    found = true;
                    break;
                }
            }
            if (!found) {
                if (queryString.length === 0) {
                    queryString += "?" + encodeURIComponent(param) + "=" + encodeURIComponent(value);
                    window.history.pushState({}, "", queryString);
                } else {
                    queryString += "&" + encodeURIComponent(param) + "=" + encodeURIComponent(value);
                    window.history.pushState({}, "", "?" + queryString);
                }
            }
        }
    };
    o.removeQueryStringParameter = function(param) {
        if (window.history.pushState !== undefined) {
            var queryString = window.location.search.substring(1), vars = queryString.split("&"), i, found = false;
            for (i = 0; i < vars.length; i += 1) {
                var pair = vars[i].split("=");
                if (decodeURIComponent(pair[0]) === param) {
                    vars.splice(i, 1);
                    window.history.pushState({}, "", "?" + vars.join("&"));
                    found = true;
                    break;
                }
            }
        }
    };
    o.measureElementHeight = function($element, displayType) {
        var originalStyle = $element.attr("style");
        $element.removeAttr("style").css({
            position: "fixed",
            left: "-10000px",
            display: displayType || "block"
        });
        var h = $element.height();
        return h;
    };
    o.measureElementWidth = function($element, displayType) {
        var originalStyle = $element.attr("style");
        $element.removeAttr("style").css({
            position: "fixed",
            left: "-10000px",
            display: displayType || "block"
        });
        var h = $element.width();
        $element.removeAttr("style").attr("style", originalStyle);
        return h;
    };
    o.makeMVCDate = function(date) {
        function addLeadingZero(prop) {
            var s = "";
            if (prop < 10) {
                s += "0";
            }
            s += prop;
            return s;
        }
        var s = "";
        s += date.getFullYear() + "-";
        s += addLeadingZero(date.getMonth() + 1) + "-";
        s += addLeadingZero(date.getDate()) + "T";
        s += addLeadingZero(date.getHours()) + ":";
        s += addLeadingZero(date.getMinutes()) + ":";
        s += addLeadingZero(date.getSeconds());
        return s;
    };
    o.makeDateFromQueryStringDate = function(dateStr) {
        var date = new Date();
        date.setDate(dateStr.substring(8, 10));
        date.setMonth(dateStr.substring(5, 7) - 1);
        date.setYear(dateStr.substring(0, 4));
        date.setHours(dateStr.substring(11, 13));
        date.setMinutes(dateStr.substring(14, 16));
        date.setSeconds(dateStr.substring(17, 19));
        return date;
    };
    o.getTime = function(dateTime) {
        return (dateTime.getHours() < 10 ? "0" : "") + dateTime.getHours() + ":" + (dateTime.getMinutes() < 10 ? "0" : "") + dateTime.getMinutes();
    };
    o.getTimeWithSeconds = function(dateTime) {
        return o.getTime(dateTime) + ":" + (dateTime.getSeconds() < 10 ? "0" : "") + dateTime.getSeconds();
    };
    o.getYearDiffBetweenDates = function(startDate, endDate) {
        if (startDate && startDate !== "" && endDate && endDate !== "") {
            var diff = endDate.getFullYear() - startDate.getFullYear();
            var m = endDate.getMonth() - startDate.getMonth();
            if (diff > 0) {
                if (m < 0 || m === 0 && endDate.getDate() < startDate.getDate()) {
                    diff--;
                }
            } else if (diff < 0) {
                if (m > 0 || m === 0 && endDate.getDate() > startDate.getDate()) {
                    diff++;
                }
            }
            return diff;
        } else {
            return 0;
        }
    };
    o.isInDateRangeOrNull = function(dateTime, lowerValue, higherValue) {
        if (dateTime === null) return true;
        var today = new Date();
        if (dateTime && dateTime !== "") {
            var selectedDate = new Date(dateTime);
            if (o.getYearDiffBetweenDates(selectedDate, today) > -lowerValue || o.getYearDiffBetweenDates(today, selectedDate) < higherValue) return true;
        }
        return false;
    };
    o.AreDatesValidForAPI = function(startDate, endDate) {
        var lowerRangeValue = 2;
        var higherRangeValue = 5;
        if (startDate && startDate !== "" && endDate && endDate !== "" && (o.isInDateRangeOrNull(startDate, lowerRangeValue, higherRangeValue) && o.isInDateRangeOrNull(endDate, lowerRangeValue, higherRangeValue)) & startDate <= endDate) {
            return true;
        }
        return false;
    };
    if (!String.prototype.format) {
        String.prototype.format = function() {
            var str = this.toString();
            if (!arguments.length) {
                return str;
            }
            var argType = typeof arguments[0];
            var args = "string" === argType || "number" === argType ? arguments : arguments[0];
            for (var arg in args) {
                str = str.replace(RegExp("\\{" + arg + "\\}", "gi"), args[arg]);
            }
            return str;
        };
    }
    if (!String.prototype.toTitleCase) {
        String.prototype.toTitleCase = function() {
            var str = this.toString();
            return str.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        };
    }
    if (!String.prototype.startsWith) {
        String.prototype.startsWith = function(searchString, position) {
            position = position || 0;
            return this.substr(position, searchString.length) === searchString;
        };
    }
    if (!String.prototype.paddingLeft) {
        String.prototype.paddingLeft = function(paddingValue) {
            return String(paddingValue + this).slice(-paddingValue.length);
        };
    }
    o.simpleThrottle = function(func, rate) {
        var counter = 0;
        return function() {
            var context = this;
            var args = arguments;
            counter++;
            if (counter === rate) {
                func.apply(context, args);
                counter = 0;
            }
        };
    };
    o.jumpBack = function(e, howFar) {
        e.preventDefault();
        if (!howFar || howFar > -1) {
            howFar = -1;
        }
        window.history.go(howFar);
    };
    (function() {
        if (typeof window.CustomEvent === "function") return false;
        function CustomEvent(event, params) {
            params = params || {
                bubbles: false,
                cancelable: false,
                detail: null
            };
            var evt = document.createEvent("CustomEvent");
            evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
            return evt;
        }
        CustomEvent.prototype = window.Event.prototype;
        window.CustomEvent = CustomEvent;
    })();
    if (!Array.prototype.fill) {
        Object.defineProperty(Array.prototype, "fill", {
            value: function(value) {
                if (this === null) {
                    throw new TypeError("this is null or not defined");
                }
                var O = Object(this);
                var len = O.length >>> 0;
                var start = arguments[1];
                var relativeStart = start >> 0;
                var k = relativeStart < 0 ? Math.max(len + relativeStart, 0) : Math.min(relativeStart, len);
                var end = arguments[2];
                var relativeEnd = end === undefined ? len : end >> 0;
                var final = relativeEnd < 0 ? Math.max(len + relativeEnd, 0) : Math.min(relativeEnd, len);
                while (k < final) {
                    O[k] = value;
                    k++;
                }
                return O;
            }
        });
    }
    if (typeof Object.assign != "function") {
        Object.defineProperty(Object, "assign", {
            value: function assign(target, varArgs) {
                "use strict";
                if (target === null) {
                    throw new TypeError("Cannot convert undefined or null to object");
                }
                var to = Object(target);
                for (var index = 1; index < arguments.length; index++) {
                    var nextSource = arguments[index];
                    if (nextSource !== null) {
                        for (var nextKey in nextSource) {
                            if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
                                to[nextKey] = nextSource[nextKey];
                            }
                        }
                    }
                }
                return to;
            },
            writable: true,
            configurable: true
        });
    }
})(window.tfl.tools = window.tfl.tools || {});

(function(o) {
    tfl.logs.create("Loading cookiebot client");
    function init() {
        var events = [ "CookiebotOnLoad", "CookiebotOnAccept", "CookiebotOnDecline", "CookiebotOnDialogInit", "CookiebotOnDialogDisplay", "CookiebotOnTagsExecuted" ];
        events.forEach(function(value, index, arr) {
            o.addEventListener(value, function() {
                tfl.logs.create(value, "event fired.");
            });
        });
    }
    o.hasCookieBot = function() {
        return typeof CookieConsent !== "undefined";
    };
    o.CookiebotCallback_OnLoad = function() {
        tfl.logs.create("CookiebotCallback_OnLoad", Cookiebot.consent);
    };
    o.CookiebotCallback_OnAccept = function() {
        tfl.logs.create("CookiebotCallback_OnAccept", Cookiebot.consent);
    };
    o.CookiebotCallback_OnDecline = function() {
        tfl.logs.create("CookiebotCallback_OnDecline", Cookiebot.consent);
        loadPostConsentScripts();
    };
    o.CookiebotCallback_OnDialogInit = function() {
        tfl.logs.create("CookiebotCallback_OnDialogInit", Cookiebot.consent);
    };
    o.CookiebotCallback_OnDialogDisplay = function() {
        tfl.logs.create("CookiebotCallback_OnDialogDisplay", Cookiebot.consent);
    };
    o.CookiebotCallback_OnTagsExecuted = function() {
        tfl.logs.create("CookiebotCallback_OnTagsExecuted", Cookiebot.consent);
        loadPostConsentScripts();
    };
    function loadPostConsentScripts() {
        if (!CookieConsent.consent.marketing) setTimeout(o.dispatchEvent(tfl.events.onLoadAds), 50);
        if (!CookieConsent.consent.statistics) setTimeout(o.dispatchEvent(tfl.events.onLoadAnalytics), 50);
        if (!Cookiebot.consent.preferences) localStorage.clear();
        setTimeout(o.dispatchEvent(tfl.favouritesPanel.onLoadFavourites), 50);
        setTimeout(o.dispatchEvent(tfl.favouritesPanel.onLoadFavouritesPanelLinks), 50);
    }
    init();
})(window);

(function(o, t) {
    tfl.logs.create("Initialise ad scripts");
    if (!window.hasCookieBot()) {
        tfl.logs.create("CookieConsent is undefined, looks like cookiebot script failed to load");
        return;
    }
    o.googletag = o.googletag || {};
    o.googletag.cmd = o.googletag.cmd || [];
    t.ads = t.ads || {
        gpt: {}
    };
    t.events = t.events || {};
    t.events.onLoadAds = new CustomEvent("OnLoadAds", {
        detail: {
            consent: CookieConsent.consent
        }
    });
    o.addEventListener("OnLoadAds", function(e) {
        setTimeout(t.ads.gpt.loadAds, 50, e.detail);
    });
    t.ads.gpt = function() {
        return {
            loadAds: function(e) {
                setTimeout(showAdvert, 50, e);
            }
        };
        function showAdvert(e) {
            if (googleTagServicesAlreadyInitialised()) return false;
            tfl.logs.create("Initialise GPT");
            var ads = document.querySelectorAll("[data-advert]");
            if (ads !== null && ads.length > 0) {
                (function() {
                    var gads = document.createElement("script");
                    gads.async = true;
                    gads.type = "text/javascript";
                    var useSSL = "https:" == document.location.protocol;
                    gads.src = (useSSL ? "https:" : "http:") + "//www.googletagservices.com/tag/js/gpt.js";
                    var node = document.getElementsByTagName("script")[0];
                    node.parentNode.insertBefore(gads, node);
                })();
                googletag.cmd.push(function() {
                    var toDisplay = [];
                    var fromJP = $("#From");
                    var toJP = $("#To");
                    for (var i = 0; i < ads.length; i++) {
                        var ad = ads[i];
                        if (ad.offsetParent === null) {
                            continue;
                        }
                        var id = "adv-" + i;
                        var path = ad.getAttribute("data-advert");
                        var sizesArr = ad.getAttribute("data-advert-sizes").split("|");
                        var sizes = [];
                        var viewPort = tfl.utils.getViewPort();
                        var isSmall = viewPort === tfl.utils.viewPorts.small;
                        for (var s = 0; s < sizesArr.length; s++) {
                            var size = sizesArr[s].split(",").map(Number);
                            if (isSmall) {
                                if (!(size[0] === 300 && size[1] === 600)) {
                                    sizes.push(size);
                                }
                            } else {
                                sizes.push(size);
                            }
                        }
                        toDisplay.push(id);
                        ad.setAttribute("id", id);
                        googletag.defineSlot(path, sizes, id).addService(googletag.pubads());
                    }
                    if (fromJP.val() !== "" && toJP.val() !== "") {
                        googletag.pubads().setTargeting("from", fromJP);
                        googletag.pubads().setTargeting("to", toJP);
                    }
                    googletag.pubads().setTargeting("inskin_yes", screen.width >= 1400 ? "true" : "false");
                    googletag.pubads().setTargeting("inskinmobile_yes", screen.width >= 375 ? "true" : "false");
                    if (tfl.amazonPublisherId && tfl.amazonPublisherId.length > 0) {
                        googletag.pubads().disableInitialLoad();
                    }
                    googletag.pubads().enableSingleRequest();
                    googletag.pubads().setCentering(true);
                    if (!$(".top-banner-advert .large").is(":visible")) {
                        googletag.pubads().collapseEmptyDivs(true);
                    }
                    googletag.pubads().addEventListener("slotRenderEnded", function(event) {
                        var id = $("#" + event.slot.getSlotElementId());
                        if (!event.isEmpty) {
                            var adHeight = event.size[1];
                            var lblStyle = screen.width < 580 ? 'style="color:#FFFFFF"' : "";
                            var adLabel = '<a class="advertisement-label"' + lblStyle + ' href="/advertisement">Advertisement</a>';
                            id.css("background-color", "#1F2025");
                            if (id.hasClass("large")) {
                                id.animate({
                                    height: adHeight
                                }, 100);
                            }
                            if (id.parent().hasClass("advert-content")) {
                                id.append(adLabel).closest(".advert-link").css("background", "#f7f7f7");
                            } else {
                                id.prepend(adLabel);
                            }
                        }
                    });
                    googletag.enableServices();
                    try {
                        for (var ii = 0; ii < toDisplay.length; ii++) {
                            googletag.display(toDisplay[ii]);
                        }
                    } catch (e) {
                        tfl.logs.create(e);
                    }
                    if (tfl.amazonPublisherId && tfl.amazonPublisherId.length > 0) {
                        tfl.logs.create("Initialise Amazon TAM");
                        (function(a9, a, p, s, t, A, g) {
                            if (a[a9]) return;
                            function q(c, r) {
                                a[a9]._Q.push([ c, r ]);
                            }
                            a[a9] = {
                                init: function() {
                                    q("i", arguments);
                                },
                                fetchBids: function() {
                                    q("f", arguments);
                                },
                                setDisplayBids: function() {},
                                targetingKeys: function() {
                                    return [];
                                },
                                _Q: []
                            };
                            A = p.createElement(s);
                            A.async = !0;
                            A.src = t;
                            g = p.getElementsByTagName(s)[0];
                            g.parentNode.insertBefore(A, g);
                        })("apstag", window, document, "script", "//c.amazon-adsystem.com/aax2/apstag.js");
                        window.apstag.init({
                            pubID: tfl.amazonPublisherId,
                            adServer: "googletag"
                        });
                        googletag.cmd.push(function() {
                            var apsSlots = googletag.pubads().getSlots().map(function(slot) {
                                var acceptedSlotSizes = [ [ 970, 250 ], [ 728, 90 ], [ 320, 50 ], [ 300, 250 ], [ 160, 600 ], [ 300, 600 ] ];
                                var gSlotSize = [];
                                for (var i = 0; i < acceptedSlotSizes.length; i++) {
                                    for (var j = 0; j < slot.getSizes().length; j++) {
                                        if (typeof slot.getSizes()[j] !== "string" && JSON.stringify(acceptedSlotSizes[i]) === JSON.stringify([ slot.getSizes()[j].getWidth(), slot.getSizes()[j].getHeight() ])) {
                                            gSlotSize.push(acceptedSlotSizes[i]);
                                            break;
                                        }
                                    }
                                }
                                if (gSlotSize.length > 0) {
                                    return {
                                        slotID: slot.getSlotElementId(),
                                        slotName: slot.getAdUnitPath(),
                                        sizes: gSlotSize
                                    };
                                }
                            }).filter(function(slot) {
                                return typeof slot !== "undefined";
                            });
                            window.apstag.fetchBids({
                                slots: apsSlots
                            }, function(bids) {
                                googletag.cmd.push(function() {
                                    apstag.setDisplayBids();
                                    googletag.pubads().refresh();
                                });
                            });
                        });
                    } else {
                        tfl.logs.create("Amazon TAM not in use");
                    }
                });
            }
        }
    }();
    function googleTagServicesAlreadyInitialised() {
        return googletag.apiReady;
    }
})(window, tfl = tfl || {});

(function(w, t) {
    tfl.logs.create("Initialise analytics");
    if (!window.hasCookieBot()) {
        tfl.logs.create("CookieConsent is undefined, looks like cookiebot script failed to load");
        return;
    }
    t.events = t.events || {};
    t.events.onLoadAnalytics = new CustomEvent("OnLoadAnalytics", {
        detail: {
            consent: CookieConsent.consent
        }
    });
    w.addEventListener("OnLoadAnalytics", function(e) {
        setTimeout(t.analytics.tealium.load, 1e3, e.detail);
    });
    t.analytics.tealium = function() {
        return {
            load: load
        };
        function load(a, b, c, d) {
            if (t.analytics.tealium.load) {
                tfl.logs.create("Already inititalise Tealium");
                return;
            }
            tfl.logs.create("Inititalise Tealium");
            a = t.analytics.tealiumUtagUrl;
            b = document;
            c = "script";
            d = b.createElement(c);
            d.src = a;
            d.type = "text/java" + c;
            d.async = true;
            a = b.getElementsByTagName(c)[0];
            a.parentNode.insertBefore(d, a);
        }
    }();
})(window, tfl = tfl || {});

(function(tfl) {
    "use strict";
    var autoRefreshTimers = [];
    tfl.api = {
        BikePoint: tfl.apiUrl + "BikePoint",
        BikePointId: tfl.apiUrl + "BikePoint/{0}",
        BikePointBbox: tfl.apiUrl + "BikePoint?swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}",
        BikePointsByStopPoint: "/Stops/BikePointByStopPoint?stopPointId={0}",
        BikePointSearch: tfl.apiUrl + "BikePoint/Search?query=%QUERY",
        BikePointsByRadius: "/Stops/BikepointsByRadius?latitude={0}&longitude={1}&radius={2}",
        CarParksById: "/Stops/CarPark?naptanId={0}",
        JourneyPlannerStreetView: "/JourneyPlanner/Streetview",
        JourneyTaxiTrip: tfl.apiUrl + "Journey/JourneyResults/{0}/to/{1}/?taxiOnlyTrip={2}",
        LineStatus: tfl.apiUrl + "Line/Mode/{0}/Status?detail=true",
        LineStatusNoDetail: tfl.apiUrl + "Line/{lineId}/Status",
        LinePlannedWorks: tfl.apiUrl + "Line/Mode/{0}/Status?startdate={1}&enddate={2}&detail=true",
        LineRouteSequence: tfl.apiUrl + "Line/{lineId}/Route/sequence/{direction}",
        LinesSearch: tfl.apiUrl + "Line/Search/%QUERY?modes={0}",
        LinesSequence: tfl.apiUrl + "Line/{lineId}/Route/Sequence/{direction}",
        PlaceBbox: tfl.apiUrl + "Place?swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}&type={type}&categories={categories}&includeChildren={includeChildren}",
        PlaceActiveOnlyBbox: tfl.apiUrl + "Place?swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}&type={type}&categories={categories}&includeChildren={includeChildren}&activeOnly=true",
        PlaceByType: tfl.apiUrl + "Place/Type/%7Btypes%7D?types={types}",
        PlaceByTypeActiveOnly: tfl.apiUrl + "Place/Type/%7Btypes%7D?types={types}&activeOnly=true",
        PlacesExtraSearch: tfl.apiUrl + "Place/Extra/search?query=%QUERY",
        PlacesPolygon: tfl.apiUrl + "Place/Polygon/Boroughs?commonName=",
        PlacesSearchByCommonName: tfl.apiUrl + "Place/Search?name=%QUERY&types={0}",
        RoadStatus: tfl.apiUrl + "Road/all/Status/",
        RoadDisruption: tfl.apiUrl + "Road/all/Disruption/{ids}",
        RoadDisruptionBbox: tfl.apiUrl + "Road/all/Disruption?swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}&stripContent=true&closures=true&severities={severities}",
        RoadDisruptionWithDatesBbox: tfl.apiUrl + "Road/all/Disruption?startdate={from}&enddate={to}&swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}&stripContent=true&closures=true&severities={severities}",
        Routes: tfl.apiUrl + "Routes",
        StopPointsBbox: tfl.apiUrl + "StopPoint?swLat={swLat}&swLon={swLon}&neLat={neLat}&neLon={neLon}&stopTypes={stopTypes}&modes={modes}&includeChildren=false&returnLines={returnLines}&categories=Direction&useStopPointHierarchy=false",
        StopPointsRoute: tfl.apiUrl + "StopPoint/{stopId}/Route",
        StopPointsDisruptions: tfl.apiUrl + "StopPoint/{0}/Disruption?getFamily={1}&includeRouteBlockedStops={2}",
        StopPointsSearch: tfl.apiUrl + "StopPoint/search/%QUERY?modes={0}&maxResults=25&faresOnly={1}&includeHubs={2}&tflOperatedNationalRailStationsOnly={3}",
        StopPointsSearchQuery: tfl.apiUrl + "StopPoint/Search/%7Bquery%7D/?query=%QUERY&modes={0}&maxResults=25&faresOnly={1}&includeHubs={2}",
        StopPointsDisruptionsTimePeriod: tfl.apiUrl + "StopPoint/{0}/Disruption/{1}/to/{2}",
        StopPointsDisruptionsByModeAndTimePeriod: tfl.apiUrl + "StopPoint/Mode/{0}/Disruption?startdate={1}&enddate={2}",
        StopPointsDisruptionsByMode: tfl.apiUrl + "StopPoint/Mode/{0}/Disruption",
        StopPointsCrowding: tfl.apiUrl + "StopPoint/{0}?includeCrowdingData={1}",
        addressSearch: tfl.apiUrl + "Place/Address/Search/{query}",
        selectAddress: tfl.apiUrl + "Place/Address/{id}",
        streetLookup: tfl.apiUrl + "Place/Address/Streets/{postcode}",
        GeoConvertBNG: tfl.apiUrl + "Geo/To/WGS84/From/{0}/{1}/{2}",
        GeoConvertWSG84: tfl.apiUrl + "Geo/From/WGS84/To/{0}/{1}/{2}",
        ReverseGeocode: tfl.apiUrl + "Geo/GetAddress/{0}/{1}",
        ResolveWebCATLocation: tfl.apiUrl + "LocationInformation/{0}/{1}",
        GetPTAL: tfl.apiUrl + "ptal/{0}/{1}?scenarioTitle={2}",
        WebCATScenario: tfl.apiUrl + "/WebCATScenario",
        CycleSuperHighway: tfl.apiUrl + "CycleSuperhighway?status={0}&formatter=geojson&{1}",
        BikePointsByGeoPoint: "/Stops/BikePoints",
        TaxiRanks: "/Stops/TaxiRanks?naptanId={0}",
        GetStations: "/FormBuilder/GetStations",
        NearestBikePoints: "/Stops/NearestBikePoints",
        NearestCarParks: "/Stops/NearestCarParks"
    };
    tfl.web = {
        VerifyCode: "/TravelAlerts/SendVerifyCode/",
        AlertSummary: "/TravelAlerts/EditAlert/",
        SendCode: "/TravelAlerts/SendCode/",
        Customer: "/TravelAlerts/GetCustomerDetails/",
        ValidateCode: "/TravelAlerts/ValidateCode/",
        SaveAndSendSmsVerification: "/TravelAlerts/SaveAndSendSmsVerification/",
        SubmitTravelAlert: "/TravelAlerts/SubmitTravelAlert/",
        TravelAlertJPSearch: "/TravelAlerts/ResultsAsync?IsAsync=true&JpType=publictransport&Mode=bus&Mode=tube&Mode=national-rail&Mode=dlr&Mode=overground&Mode=tflrail&Mode=river-bus&Mode=tram&Mode=cable-car&Mode=coach&Date={0}&Time=1200&From={1}&FromId={2}&To={3}&ToId={4}",
        TravelAlertById: "/TravelAlerts/Edit?editId={0}",
        GetFavourites: "/TravelAlerts/GetCustomerFavourites/",
        SaveFavourites: "/TravelAlerts/SaveCustomerFavourites/",
        AISearch: "/AISearch/Search?query={0}",
        ElasticSearch: "/AISearch/ElasticSearch?query={0}",
        ElasticSearchUrl: "/search/?q={0}",
        LogOut: "/SSO/LogOut",
        FavouriteBanner: "/cdn/static/cms/feeds/panel-promo-banner.json",
        addressSearch: "/AddressSearch/GetAddressByPostcode?postcode={postcode}",
        selectAddress: "/AddressSearch/GetAddressById?id={id}",
        streetLookup: "/AddressSearch/GetStreetByPostcode?postcode="
    };
    tfl.googleapis = {
        mapsBaseUrl: "https://maps.googleapis.com/maps/api/js?v=3"
    };
    tfl.autoRefresh = {
        BikePoint: 305e3,
        Predictions: 1e4,
        ServiceBoard: 65e3
    };
    var defaultData = {
        app_id: tfl.appId,
        app_key: tfl.appKey
    };
    tfl.addAppIdAndKey = function(url) {
        if (url.indexOf("?") !== -1) {
            return url + "&app_id=" + tfl.appId + "&app_key=" + tfl.appKey;
        } else {
            return url + "?app_id=" + tfl.appId + "&app_key=" + tfl.appKey;
        }
    };
    tfl.ajax = function(opts) {
        var allowRequest = false;
        if (typeof opts !== "object") {
            tfl.logs.create("tfl.ajax: Invalid parameters", "warn");
            tfl.logs.create(opts, "warn");
        } else if (!opts.url) {
            tfl.logs.create("tfl.ajax: No request URL specified", "warn");
        } else if (!opts.success) {
            tfl.logs.create("tfl.ajax: No success callback specified", "warn");
        } else {
            if (opts.url.indexOf("{") > -1 || opts.url.indexOf("}") > -1) {
                tfl.logs.create("tfl.ajax: Invalid request URL (contains curly braces)", "warn");
                tfl.logs.create(opts.url, "warn");
            }
            allowRequest = true;
        }
        if (!allowRequest) {
            if (typeof opts.error === "function") {
                opts.error();
            }
            return false;
        }
        var defaults = {
            data: defaultData,
            dataType: "json",
            success: null,
            error: function(jqXhr, textStatus, errorThrown) {
                tfl.logs.create("tfl.ajax: Error with ajax call", "warn,  status: " + textStatus);
                tfl.logs.create(textStatus);
                tfl.logs.create(errorThrown);
                tfl.logs.create(jqXhr);
            },
            autoRefreshInterval: null
        };
        var settings = $.extend(true, {}, defaults, opts);
        if (settings.autoRefreshInterval !== null) {
            settings.complete = function() {
                autoRefreshTimers[settings.autoRefreshId] = setTimeout(function() {
                    tfl.ajax(opts);
                }, parseInt(settings.autoRefreshInterval));
            };
        }
        var callback = function() {
            tfl.logs.create("tfl.ajax: " + settings.url);
            $.ajax(settings);
        };
        tfl.utils.requestAnimFrame(callback);
    };
    tfl.stopAjaxAutoRefresh = function(autoRefreshId) {
        clearTimeout(autoRefreshTimers[autoRefreshId]);
    };
    tfl.logs.create("tfl.ajax: loaded");
})(window.tfl = window.tfl || {});

(function(o) {
    "use strict";
    function pad(number) {
        if (number < 10) {
            return "0" + number;
        }
        return number;
    }
    if (!Date.prototype.toISOString) {
        (function() {
            Date.prototype.toISOString = function() {
                return this.getUTCFullYear() + "-" + pad(this.getUTCMonth() + 1) + "-" + pad(this.getUTCDate()) + "T" + pad(this.getUTCHours()) + ":" + pad(this.getUTCMinutes()) + ":" + pad(this.getUTCSeconds()) + "." + (this.getUTCMilliseconds() / 1e3).toFixed(3).slice(2, 5) + "Z";
            };
        })();
    }
    o.skipSectionCheckbox = function($checkbox, $sectionToSkip, isValidlyChecked, useContinue, $continueButton) {
        if ($checkbox.length > 0 && $sectionToSkip.length > 0) {
            if (isValidlyChecked($checkbox[0], $sectionToSkip)) {
                $sectionToSkip.hide();
                if (useContinue) {
                    $continueButton.removeAttr("disabled");
                }
            }
            $checkbox.on("change", function() {
                if (this.checked) {
                    $sectionToSkip.hide();
                    if (useContinue) {
                        $continueButton.removeAttr("disabled");
                    }
                } else {
                    $sectionToSkip.show();
                    if (useContinue) {
                        $continueButton.attr("disabled", "disabled");
                    }
                }
            });
        }
    };
    o.selectOther = function($select, $sectionToToggle, key, startHidden, dontClearOnHide) {
        $sectionToToggle = $sectionToToggle.parents("." + tfl.dictionary.formClasses.formControlWrapClass).slice(0, 1);
        $select.on("change", function() {
            var selected = this.value;
            if (selected === key) {
                tfl.utils.show($sectionToToggle);
            } else {
                tfl.utils.hide($sectionToToggle);
                if (!dontClearOnHide) {
                    $sectionToToggle.find("input").val("");
                }
            }
        });
        if (startHidden && $select.val() !== key) {
            tfl.utils.hide($sectionToToggle);
        }
    };
    o.addValidationClass = function($formElements, errorWrapper) {
        if (!errorWrapper) {
            errorWrapper = "." + window.tfl.dictionary.formClasses.formControlWrapClass;
        }
        $formElements.closest(errorWrapper).addClass(window.tfl.dictionary.formClasses.validationWrap);
    };
    o.removeValidationClass = function(errorWrappers) {
        errorWrappers.removeClass(window.tfl.dictionary.formClasses.validationWrap);
    };
    o.addErrorsToLabels = function(errorList) {
        for (var i = 0; i < errorList.length; i++) {
            var nextError = errorList[i];
            var $wrapper = $(nextError.element).parents("." + window.tfl.dictionary.formClasses.formControlWrapClass);
            var $label = $wrapper.find("label");
            var $assistiveTextWrap = $label.find(tfl.dictionary.formClasses.assistiveTextErrorClass);
            var message = nextError.message;
            if ($assistiveTextWrap.length) {
                $assistiveTextWrap.text(message);
            } else {
                $label.append(hoganTemplates.assistiveText.render({
                    message: message
                }));
            }
        }
    };
    o.removeValidationAssistiveText = function($errorWrappers) {
        $errorWrappers.find(tfl.dictionary.formClasses.assistiveTextErrorClass).remove();
    };
    o.scrollToTopError = function(errorWrappers) {
        var firstVisibleError = errorWrappers.filter(function() {
            return $(this).is(":visible");
        }).slice(0, 1);
        if (firstVisibleError.length) {
            var scrollPos = parseInt(firstVisibleError.offset().top - 20, 10);
            $("html, body").animate({
                scrollTop: scrollPos + "px"
            }, 250, "swing");
        }
    };
    o.getErrorWrappers = function(objectToValidate) {
        var errorWrappers;
        if (objectToValidate.is("form")) {
            errorWrappers = objectToValidate.find("." + window.tfl.dictionary.formClasses.validationWrap);
        } else {
            errorWrappers = objectToValidate.closest("." + window.tfl.dictionary.formClasses.validationWrap);
        }
        return errorWrappers;
    };
    o.valid = function(objectToValidate) {
        var isValid = objectToValidate.valid();
        o.scrollToTopError(o.getErrorWrappers(objectToValidate));
        return isValid;
    };
    o.makeNotRequired = function($input, additionalRules) {
        if (!additionalRules) {
            $input.rules("remove", "required");
        } else {
            additionalRules.push("required");
            $input.rules("remove", additionalRules.join(" "));
        }
        $("label[for='" + $input.attr("id") + "']").removeClass(tfl.dictionary.formClasses.mandatoryFieldLabel);
    };
    o.makeRequired = function($input, additionalRules) {
        if (!additionalRules) {
            $input.data("val", true).rules("add", "required");
        } else {
            additionalRules.push("required");
            $input.rules("add", additionalRules.join(" "));
        }
        $("label[for='" + $input.attr("id") + "']").addClass(tfl.dictionary.formClasses.mandatoryFieldLabel);
    };
    o.dateUtils = {
        dayNames: [ "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday" ],
        monthNames: [ "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
        MILLISECONDSPERDAY: 864e5,
        MILLISECONDSPERHOUR: 36e5,
        MILLISECONDSPERMINUTE: 6e4,
        makeDate: function(dateString, separator) {
            if (!separator) {
                separator = "/";
            }
            var dateParts = dateString.split(separator);
            return new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
        },
        formatLongDate: function(D) {
            var date = o.dateUtils.makeDate(D), dateParts = [];
            dateParts[0] = o.dateUtils.dayNames[date.getDay()];
            dateParts[1] = o.dateUtils.monthNames[date.getMonth()];
            dateParts[2] = o.dateUtils.getNumberWithOrdinal(date.getDate());
            dateParts[3] = date.getFullYear();
            return [ dateParts[0], dateParts[2], dateParts[1] + ",", dateParts[3] ].join(" ");
        },
        validDate: function(D) {
            var re = /^\d{1,2}\/{1}\d{1,2}\/{1}\d{4}$/;
            return re.test(D);
        },
        zonelessIsoDate: function(dateString, make) {
            var date = !!make ? o.dateUtils.makeDate(dateString) : new Date(dateString);
            var datePart = [ date.getFullYear(), date.getMonth() + 1, date.getDate() ].join("-");
            var timePart = [ pad(date.getHours()), pad(date.getMinutes()), pad(date.getSeconds()) ].join(":");
            return datePart + "T" + timePart;
        },
        datepickerDefaults: {
            dateFormat: "dd/mm/yy",
            firstDay: 1,
            constrainInput: true
        },
        getFormattedDate: function(date) {
            if (!date) {
                date = new Date();
            }
            var dd = date.getDate();
            var mm = date.getMonth() + 1;
            var yyyy = date.getFullYear();
            if (dd < 10) {
                dd = "0" + dd;
            }
            if (mm < 10) {
                mm = "0" + mm;
            }
            return dd + "/" + mm + "/" + yyyy;
        },
        updateSummaryDate: function(dateStr, $dateElement) {
            var date = o.dateUtils.makeDate(dateStr);
            var datestr = date.toDateString().replace("Mon ", o.dateUtils.dayNames[1] + " ").replace("Tue ", o.dateUtils.dayNames[2] + " ").replace("Wed ", o.dateUtils.dayNames[3] + " ").replace("Thu ", o.dateUtils.dayNames[4] + " ").replace("Fri ", o.dateUtils.dayNames[5] + " ").replace("Sat ", o.dateUtils.dayNames[6] + " ").replace("Sun ", o.dateUtils.dayNames[0] + " ");
            $dateElement.text(datestr);
        },
        getNumberWithOrdinal: function(num) {
            var ordinalSwitch = num < 20 ? num : Number("" + num.toString().slice(-1)), output = num.toString();
            switch (ordinalSwitch) {
              case 1:
                output += "st";
                break;

              case 2:
                output += "nd";
                break;

              case 3:
                output += "rd";
                break;

              default:
                output += "th";
                break;
            }
            return output;
        }
    };
    o.settings = function() {
        $.validator.addMethod("date", function(value, element) {
            if (this.optional(element)) {
                return true;
            }
            var ok = true;
            try {
                $.datepicker.parseDate("dd/mm/yy", value);
            } catch (err) {
                ok = false;
            }
            return ok;
        });
        $.validator.addMethod("daterange", function(value, element) {
            var sDate = tfl.forms.dateUtils.makeDate($(element).data("fromDate")), eDate = tfl.forms.dateUtils.makeDate(value);
            return eDate.getTime() - sDate.getTime() > 0;
        }, "The end date of your request must be after the start date");
        $.validator.addMethod("findaddresses", function(value, element) {
            return !$(element).data().notActivated;
        }, "Please look up your postcode or enter your address manually");
        $.validator.addMethod("filltime", function(value, element) {
            return $(element).val() !== "";
        }, "Please select a start time for your dispensation");
        $.validator.addMethod("requirechecked", function(value, element) {
            return element.checked;
        });
        $.validator.unobtrusive.adapters.addBool("requirechecked");
        $.validator.addMethod("sortcode", function(value, element, options) {
            var RE = new RegExp(/^\d{2}$/), $ids = $(options.properties), val0 = $ids[0].value, val1 = $ids[1].value, val2 = $ids[2].value;
            return val0.match(RE) && val1.match(RE) && val2.match(RE);
        });
        $.validator.unobtrusive.adapters.add("sortcode", [ "properties" ], function(options) {
            options.rules.sortcode = options.params;
            options.messages.sortcode = options.message;
        });
        $.validator.addMethod("nocardnumber", function(value, element, options) {
            var hasCardNumber = /\d{15,16}/g.test(value.replace(/(?:\r\n|\r|\n| |-)/g, ""));
            var $parDiv = $(element).closest(".full-width-form-module");
            if (hasCardNumber) {
                $parDiv.removeClass("form-field-tooltip");
            } else {
                $parDiv.addClass("form-field-tooltip");
            }
            return !hasCardNumber;
        });
        $.validator.unobtrusive.adapters.add("nocardnumber", [ "properties" ], function(options) {
            options.rules.nocardnumber = options.params;
            options.messages.nocardnumber = options.message;
        });
        $.validator.addMethod("requirefromgroup", function(value, element, options) {
            var props = options.properties.split(","), relatedIds = props[1].split(" "), selectors = [], $fields, $fieldsFirst, validator;
            relatedIds.push($(element).attr("id"));
            $(relatedIds).each(function(n) {
                selectors.push("#" + relatedIds[n]);
            });
            $fields = $(selectors.join(","), element.form);
            $fieldsFirst = $fields.eq(0);
            validator = $fieldsFirst.data("valid_req_grp") ? $fieldsFirst.data("valid_req_grp") : $.extend({}, this);
            var isValid = $fields.filter(function() {
                return $(this).val().length > 0;
            }).length >= props[0];
            $fieldsFirst.data("valid_req_grp", validator);
            if (!$(element).data("being_validated")) {
                $fields.data("being_validated", true);
                $fields.each(function() {
                    validator.element(this);
                });
                $fields.data("being_validated", false);
            }
            return isValid;
        }, $.validator.format("Please fill out at least {0}."));
        $.validator.unobtrusive.adapters.add("requirefromgroup", [ "properties" ], function(options) {
            options.rules.requirefromgroup = options.params;
            options.messages.requirefromgroup = options.message;
        });
        $.validator.addMethod("mindate", function(val, elem, params) {
            var dateParts = $(elem).data().minDate.split("/"), enteredDate = tfl.forms.dateUtils.makeDate($(elem).val()), minValDate = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]);
            return enteredDate >= minValDate;
        }, "Please enter a date later than this one");
        $.validator.unobtrusive.adapters.add("mindate", [ "props" ], function(options) {
            options.rules.mindate = options.params;
            options.messages.mindate = options.message;
        });
        $.validator.addMethod("dynamicrange", function(val, elem, params) {
            var min = parseFloat($(elem).data().minamount), max = parseFloat($(elem).data().maxamount);
            return val >= min && val <= max;
        });
        $.validator.unobtrusive.adapters.add("dynamicrange", [ "props" ], function(options) {
            options.rules.dynamicrange = options.params;
            options.messages.dynamicrange = options.message;
        });
        $.validator.addMethod("dropdowndate", function(val, elems, options) {
            var props = options.properties.split(","), validDate = tfl.forms.dateUtils.makeDate(props[0]), dateValidationType = $.trim(props[1]), validationIds = $.map(props[2].split(" "), function(n) {
                if ($.trim(n).length > 0) {
                    return "#" + n;
                }
            }), dd = parseInt($(validationIds[0]).val(), 10), mm = parseInt($(validationIds[1]).val(), 10) - 1, yyyy = parseInt($(validationIds[2]).val(), 10), enteredDate = new Date(yyyy, mm, dd), isLeap = new Date(yyyy, 1, 29).getMonth() == 1, result = true, months31 = [ 0, 2, 4, 6, 7, 9, 11 ];
            if (isNaN(dd) || isNaN(mm) || isNaN(yyyy)) {
                result = false;
            } else {
                if (mm === 1) {
                    if (!isLeap && dd > 28) {
                        result = false;
                    } else if (isLeap && dd > 29) {
                        result = false;
                    }
                }
                if (dd === 31 && $.inArray(mm, months31) === -1) {
                    result = false;
                }
                if (result) {
                    if (dateValidationType === "min") {
                        result = enteredDate >= validDate;
                    }
                    if (dateValidationType === "max") {
                        result = enteredDate <= validDate;
                    }
                }
            }
            return result;
        });
        $.validator.unobtrusive.adapters.add("dropdowndate", [ "properties" ], function(options) {
            options.rules.dropdowndate = options.params;
            options.messages.dropdowndate = options.message;
        });
        $.validator.addMethod("requireiftrue", function(value, element, options) {
            var prop = options.property.split("|")[0];
            var propValue = options.property.split("|")[1].toLowerCase();
            if ($(element).attr("reevaluate") && $(element).attr("reevaluate") === "true") {
                var propValueOnElement = $(element).data("val-requireiftrue-property");
                if (propValueOnElement && $.trim(propValueOnElement).length > 0) {
                    propValueOnElement = String(propValueOnElement).split("|")[1].toLowerCase();
                    if (propValue !== propValueOnElement) propValue = propValueOnElement;
                }
            }
            if (propValue == "true") {
                if ($(element).attr("type") === "radio") {
                    if ($(element).parent().closest(".input-group").find('input[type="radio"]:checked').length > 0) {
                        var validValue = $(element).parent().closest(".input-group").find('input[type="radio"]:checked').attr("validvalue");
                        if (validValue) {
                            return $(element).parent().closest(".input-group").find('input[type="radio"]:checked').val() === validValue;
                        }
                        return true;
                    } else {
                        return false;
                    }
                } else return $(element).val() && $(element).val().length > 0;
            }
            return true;
        });
        $.validator.unobtrusive.adapters.add("requireiftrue", [ "property" ], function(options) {
            options.rules.requireiftrue = options.params;
            options.messages.requireiftrue = options.message;
        });
        $.validator.addMethod("checkboxgroup", function(value, element, params) {
            var properties = params.propertynames.split(",");
            var isValid = false;
            for (var i = 0; i < properties.length; i++) {
                var property = properties[i];
                if ($("#" + property).is(":checked")) {
                    isValid = true;
                    break;
                }
            }
            return isValid;
        }, "");
        $.validator.unobtrusive.adapters.add("checkboxgroup", [ "propertynames" ], function(options) {
            options.rules.checkboxgroup = options.params;
            options.messages.checkboxgroup = options.message;
        });
        var $forms = $("#full-width-content").find("form");
        $forms.each(function(n, form) {
            $(form).removeData("validator");
            $(form).removeData("unobtrusiveValidation");
            $.validator.unobtrusive.parse($(form));
        });
    };
    o.setSelectBoxSpan = function(selectbox) {
        var text = $(selectbox).children("option:selected").text();
        $(selectbox).attr("title", text).siblings("span").text(text);
    };
    o.updateSelectBox = function() {
        o.setSelectBoxSpan(this);
    };
    o.setupSelectBoxes = function($selectBoxes) {
        if ($selectBoxes === undefined) {
            $selectBoxes = $(".selector select");
        }
        $selectBoxes.each(function() {
            var $this = $(this);
            $this.prev("span").remove();
            $this.before("<span />");
            o.setSelectBoxSpan(this);
            var $thisPar = $this.parent();
            $this.on("focus blur", function() {
                $thisPar.toggleClass("focus");
            });
        });
        $selectBoxes.change(o.updateSelectBox);
    };
    o.setupSelectBox = function(selector, text) {
        var select = $(selector + " select");
        var $selector = $(selector);
        var selectPar = $selector.parent();
        select.before("<span />");
        select.attr("title", text).siblings("span").text(text);
        $selector.on("focus blur", function() {
            selectPar.toggleClass("focus");
        });
        select.change(o.updateSelectBox);
    };
    o.modeSelectAll = function(el) {
        $(el).click(function() {
            var inputGroup = $(this).parent().parent(".input-group");
            if (inputGroup.length > 0) {
                var inputs = inputGroup.find('input[type="checkbox"]');
                var selectedInputs = inputs.filter(function(index, el) {
                    return el.checked;
                });
                var allSelected = selectedInputs.length == inputs.length;
                if (allSelected) {
                    inputs.attr("checked", false);
                    inputs.change();
                    $(this).addClass("select-all").text("Select all");
                } else {
                    inputs.attr("checked", true);
                    inputs.change();
                    $(this).removeClass("select-all").text("Deselect all");
                }
            } else {
                tfl.logs.create("Could not find container", "error");
            }
        });
    };
    o.setupCheckboxLists = function() {
        tfl.logs.create("tfl.forms: setup checkbox lists");
        $(".to-checkbox-list").each(function(index, el) {
            var $el = $(el), group = $el.parent(".input-group"), i = 1, toCheckboxList = $(this), formField = toCheckboxList.data("fallout-field");
            toCheckboxList.children().each(function() {
                var value = $(this).attr("value"), caption = $(this).text(), input = $("<input type='checkbox' />").attr("id", value).addClass("hidden-inline-input");
                if ($(this).attr("selected") !== undefined) {
                    input.attr("checked", "checked");
                }
                if (formField) {
                    input.attr("data-fallout-field", formField);
                }
                input.on("change", function() {
                    var checkbox = this;
                    var $checkbox = $(checkbox);
                    if (checkbox.checked) {
                        toCheckboxList.find("option[value='" + $checkbox.attr("id") + "']").prop("selected", "selected");
                        toCheckboxList.find("option[value='" + $checkbox.attr("id") + "']").selected = true;
                    } else {
                        toCheckboxList.find("option[value='" + $checkbox.attr("id") + "']").removeProp("selected");
                    }
                });
                var classString = value + " " + "boxed-label-for-input";
                var label = $("<label></label>").addClass(classString + " " + "notranslate").attr("for", value);
                if (i % 2 !== 0) {
                    label.addClass("odd");
                }
                label.append(caption);
                var $wrapper = $("<div></div>").addClass("input-helper");
                if (i % 2 !== 0) {
                    $wrapper.addClass("odd-helper");
                }
                $wrapper.append(input);
                $wrapper.append(label);
                group.append($wrapper);
                i++;
            });
            $(this).toggleClass("hidden", true);
        });
    };
    o.setupHorizontalToggles = function() {
        tfl.logs.create("tfl.forms: setup horizontal toggles");
        $(".horizontal-toggle-buttons").each(function() {
            var inputs = $(this).find("input");
            inputs.filter(":checked").parent().addClass("selected");
            inputs.focus(function() {
                $(this).parent().addClass("focus");
            });
            inputs.blur(function() {
                $(this).parent().removeClass("focus");
            });
            var parents = inputs.parent();
            inputs.change(function() {
                parents.removeClass("selected");
                $(this).parent().addClass("selected");
            });
        });
    };
    o.getInputStatusWrap = function(input) {
        var container = "", containerForSingleCheckbox = input.parents(".styled-checkbox").first();
        if (containerForSingleCheckbox.length > 0) {
            container = containerForSingleCheckbox;
        } else {
            container = input.parent();
        }
        return container;
    };
    o.toggleMoreInfo = function(e) {
        e.preventDefault();
        $(this).closest(".more-info-header").toggleClass("expanded");
    };
    o.inputKeydownCallbackSetup = function(el, callback) {
        $(el).each(function() {
            $(this).on("keydown", function(e) {
                if (e.which !== 9 && e.which !== 13 && (e.which < 33 || e.which > 40) && (e.which < 16 || e.which > 20) && e.which !== 45 && e.which !== 91) {
                    callback($(this));
                }
            });
            $(this).on("paste", function() {
                callback($(this));
            });
        });
    };
    o.preventPasteInToField = function($elems) {
        $elems.on("paste", function(e) {
            e.preventDefault();
        });
    };
    o.copyUploadConfirmationLists = function(idArray) {
        for (var i = 0; i < idArray.length; i++) {
            var fileUploadList = $("#" + idArray[i] + "-container").find(".file-list-output"), reviewConfirmedFilesList = $("#" + idArray[i] + "-read-only-container");
            if (fileUploadList.children().length > 0) {
                reviewConfirmedFilesList.empty();
                reviewConfirmedFilesList.append(fileUploadList.clone());
                reviewConfirmedFilesList.find("ul").addClass("documentation-list");
                reviewConfirmedFilesList.find("li").removeClass("form-success-middle-icon");
                reviewConfirmedFilesList.find("input").remove();
                reviewConfirmedFilesList.find(".trigger-remove-file").remove();
            }
        }
    };
    o.selectedText = {
        init: function(element, valueAccessor) {
            var value = valueAccessor();
            value($("option:selected", element).text());
            $(element).change(function() {
                value($("option:selected", this).text());
            });
        },
        update: function(element, valueAccessor) {
            var value = ko.utils.unwrapObservable(valueAccessor());
            $("option", element).filter(function(i, el) {
                return $(el).text() === value;
            }).prop("selected", "selected");
        }
    };
    o.getLabelForInput = function($input) {
        return $("label[for='" + $input.attr("id") + "']");
    };
    o.checkInputWithLabelText = function(element, labelToCheck) {
        $("#full-width-content").find("input").filter(function(i, el) {
            return el.name === element.name;
        }).filter(function(i, el) {
            var $el = $(el), labelText = o.getLabelForInput($el).text().replace(/\s/g, "");
            return labelText == labelToCheck.replace(/\s/g, "");
        }).prop("checked", "checked");
    };
    o.checkedText = {
        init: function(element, valueAccessor) {
            var value = valueAccessor();
            o.checkInputWithLabelText(element, value());
            $(element).on("click", function() {
                var $el = $(this);
                if ($el.prop("checked")) {
                    value(o.getLabelForInput($el).text());
                }
            });
        },
        update: function(element, valueAccessor) {
            var value = valueAccessor();
            o.checkInputWithLabelText(element, value());
        }
    };
    o.setupTimeRange = function() {
        var rangeInputs = $('#full-width-content input[type="time"]').filter(function(index, element) {
            var $element = $(element);
            return $element.data("part-of-range") === "from";
        });
        rangeInputs.on("blur", function() {
            var $el = $(this), idOfPartner = $el.data("range-partner-id"), $partner = $("#" + idOfPartner);
            if (!$partner.val()) {
                $partner.val($el.val());
            }
        });
    };
    o.datepickerMaxMinInit = function($datepicker) {
        var minDate = $datepicker.data().minDate;
        var maxDate = $datepicker.data().maxDate;
        if (minDate) {
            $datepicker.datepicker("option", "minDate", new Date(minDate));
        }
        if (maxDate) {
            $datepicker.datepicker("option", "maxDate", new Date(maxDate));
        }
    };
    o.attachUnload = function(message) {
        var $contentArea = $("#full-width-content").find(".main"), youMayLeave = false, $permittedEscapes = $contentArea.find('input[type="submit"], a'), msg = message || "";
        $permittedEscapes.addClass("allow-exit");
        $contentArea.on("click", ".allow-exit", function() {
            youMayLeave = true;
            window.setTimeout(function() {
                youMayLeave = false;
            }, 100);
        });
        $(window).on("beforeunload", function(e) {
            if (!youMayLeave) {
                return msg;
            }
        });
    };
    o.init = function(selector) {
        o.settings();
        var noPasteElements = $("#full-width-content").find(".no-paste");
        $.datepicker.setDefaults(o.dateUtils.datepickerDefaults);
        o.preventPasteInToField(noPasteElements);
        o.setupSelectBoxes($(".selector select"));
        o.setupCheckboxLists();
        o.setupHorizontalToggles();
        $(".more-info-header .show-more-info").on("click", o.toggleMoreInfo);
        o.setupTimeRange();
        var isltIe9 = $(".lt-ie9").length > 0;
        if (isltIe9) {
            $.each($('input[type="time"].shaded-input'), function(index, el) {
                var $el = $(el), placeholder = $el.attr("placeholder");
                if (placeholder.length > 0) {
                    var $label = o.getLabelForInput($el), labelText = $label.text();
                    labelText += ' ("' + placeholder + '")';
                    $label.text(labelText);
                }
            });
        }
    };
    o.init();
})(window.tfl.forms = window.tfl.forms || {});

(function(o) {
    var $container = $(".broadcast-comms-wrapper");
    var className = "hidden";
    o.toggle = function() {
        return $container.hasClass(className) ? $container.removeClass(className) : $container.addClass(className);
    };
    function init() {
        tfl.logs.create("tfl.broadcast: initialize");
        if (tfl && tfl.showBroadcastMessage && $container.length) {
            $container.removeClass(className);
        }
    }
    init();
})(window.tfl.broadcast = window.tfl.broadcast || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.geolocation: loaded");
    var ERROR_NOTSUPPORTED = 91;
    var ERROR_INACCURATE = 92;
    var ERROR_ERROREXPERIENCED = 99;
    o.minAccuracy = 1e3;
    o.geocoder = null;
    o.geolocationTimeout = 1e4;
    var baseUrl = window.location.href;
    var getErrorMessage = function(error) {
        var errorMessage = "";
        switch (error.code) {
          case error.PERMISSION_DENIED:
            errorMessage = "Permission from browser needed before finding your location";
            break;

          case error.POSITION_UNAVAILABLE:
            errorMessage = "Your location is currently not available. Please try again";
            break;

          case error.TIMEOUT:
            errorMessage = "We cannot find your current location. Please try again";
            break;

          case error.UNKNOWN_ERROR:
            errorMessage = "An unknown error occurred trying to find your current location. Please try again";
            break;

          case ERROR_NOTSUPPORTED:
            errorMessage = "Sorry, but your bowser does not support location finding";
            break;

          case ERROR_INACCURATE:
            errorMessage = "We cannot find your exact location. Please try again";
            break;

          default:
            errorMessage = "Sorry, your browser experienced an error trying to find you location. Please try again";
            break;
        }
        tfl.logs.create("tfl.geolocation: " + errorMessage + (error.accuracy ? ". accuracy of " + error.accuracy + "m" : ""));
        return errorMessage;
    };
    o.isGeolocationSupported = function() {
        if ("geolocation" in navigator && navigator.geolocation !== null) {
            tfl.logs.create("tfl.geolocation: isGeolocationSupported true");
            return true;
        } else {
            tfl.logs.create("tfl.geolocation: isGeolocationSupported false");
            return false;
        }
    };
    o.locate = function(foundLocation, failedToFindLocation) {
        tfl.logs.create("tfl.geolocation: locate");
        var options = {
            enableHighAccuracy: false,
            timeout: o.geolocationTimeout,
            maximumAge: 0
        };
        var successCallback = function(position) {
            var coords = {
                latitude: parseFloat(position.coords.latitude.toFixed(6)),
                longitude: parseFloat(position.coords.longitude.toFixed(6))
            };
            if (position.coords.accuracy > tfl.geolocation.minAccuracy) {
                var accuracyError = {
                    code: ERROR_INACCURATE,
                    accuracy: position.coords.accuracy
                };
                accuracyError.message = getErrorMessage(accuracyError);
                if (failedToFindLocation) {
                    failedToFindLocation.call(this, accuracyError);
                }
                return;
            }
            if (foundLocation) {
                foundLocation.call(this, coords);
            }
        };
        var errorCallback = function(error) {
            try {
                error.message = getErrorMessage(error);
            } catch (e) {}
            if (failedToFindLocation) {
                failedToFindLocation.call(this, error);
            }
        };
        try {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(successCallback, errorCallback, options);
            } else {
                errorCallback({
                    code: ERROR_NOTSUPPORTED
                });
            }
        } catch (e) {
            errorCallback({
                code: ERROR_ERROREXPERIENCED
            });
        }
    };
    o.geolocateMe = function(inputEl, foundLocation, failedToFindLocation) {
        tfl.logs.create("tfl.geolocation: geolocate me");
        if (!inputEl) {
            return o.locate(foundLocation, failedToFindLocation);
        }
        var el = $(inputEl);
        o.clearGeolocationError(el);
        el.typeahead("val", "");
        el.originalPlaceholder = el.attr("placeholder");
        el.attr("placeholder", "Finding your location...");
        var successCallback = function(coords) {
            var coordinates = coords.latitude + "," + coords.longitude;
            if (el.prop("id") !== "InputFrom" && el.prop("id") !== "InputTo" && el.prop("id") !== "InputVia") {
                $(inputEl + "Geolocation").val(coordinates);
            } else {
                if (inputEl.indexOf("form-0") !== -1) {
                    $("input#FromId").val(coordinates);
                } else if (inputEl.indexOf("form-1") !== -1) {
                    $("input#ToId").val(coordinates);
                } else {
                    $("input#ViaId").val(coordinates);
                }
            }
            o.setupInputBoxForGeolocation(el);
            if (baseUrl.indexOf("plan-a-journey") === -1 || tfl.favouritesPanel.statusFavouritesPanel.isActive) {
                if (foundLocation) {
                    foundLocation.call(this, coords, $(el.closest("form")));
                }
            }
        };
        var errorCallback = function(error) {
            el.parent().siblings(tfl.removableContent.RemoveContentClass).hide();
            el.closest("[data-current-location]").removeAttr("data-current-location");
            o.geolocationError(error.message, el);
            el.focus();
            if (failedToFindLocation) {
                failedToFindLocation.call(this, error);
            }
        };
        o.locate(successCallback, errorCallback);
    };
    o.geolocationError = function(msg, el) {
        var parent = $(el.closest("div .text-input"));
        parent.find(".geolocation-error").text(msg).removeClass("hidden");
        el.attr("placeholder", el.originalPlaceholder);
        parent.find("[data-current-location]").removeAttr("data-current-location");
    };
    o.clearGeolocationError = function(el) {
        var parent = $(el.closest("div .text-input"));
        parent.find(".geolocation-error").addClass("hidden");
    };
    o.removeGeolocationFromInput = function(el) {
        var parent = el.parent();
        if (parent.attr("data-current-location")) {
            parent.removeAttr("data-current-location");
            parent.removeClass("geocoded");
            el.typeahead("val", "");
            el.closest("remove-content-container").addClass("empty");
            $(el.selector + "Geolocation").val("");
        }
    };
    o.setupInputBoxForGeolocation = function(el) {
        var ignoreKeys = [ 9, 16, 17, 18, 19, 20, 33, 34, 35, 36, 37, 38, 39, 40, 45, 46, 91, 92, 93, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, 122, 123, 144, 145 ];
        var parent = el.parent();
        parent.attr("data-current-location", "true");
        parent.addClass("geocoded");
        el.attr("placeholder", el.originalPlaceholder);
        el.typeahead("val", tfl.dictionary.CurrentLocationText).typeahead("close");
        el.on("keydown", function(e) {
            if (ignoreKeys.indexOf(e.keyCode) > -1) {
                return;
            }
            o.removeGeolocationFromInput($(this));
        });
    };
})(window.tfl.geolocation = window.tfl.geolocation || {});

this["hoganTemplates"] = this["hoganTemplates"] || {};

this["hoganTemplates"]["assistiveButtons"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        if (t.s(t.f("buttons", c, p, 1), c, p, 0, 12, 202, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <button class="');
                t.b(t.v(t.f("classNames", c, p, 0)));
                t.b('" title="');
                t.b(t.v(t.f("buttonTitle", c, p, 0)));
                t.b('">\r');
                t.b("\n" + i);
                t.b("        ");
                if (t.s(t.f("hideText", c, p, 1), c, p, 0, 96, 125, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('<span class="assistive-text">');
                    });
                    c.pop();
                }
                t.b(t.v(t.f("buttonText", c, p, 0)));
                if (t.s(t.f("hideText", c, p, 1), c, p, 0, 165, 172, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b("</span>");
                    });
                    c.pop();
                }
                t.b("\r");
                t.b("\n" + i);
                t.b("    </button>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["assistiveText"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<span class="assistive-text-error assistive-text">');
        t.b(t.v(t.f("message", c, p, 0)));
        t.b("</span>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["basicImage"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<img src="');
        t.b(t.v(t.f("src", c, p, 0)));
        t.b('" alt="');
        t.b(t.v(t.f("alt", c, p, 0)));
        t.b('">');
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["calendarioLink"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("<a href='");
        t.b(t.v(t.f("href", c, p, 0)));
        t.b("Input=");
        t.b(t.v(t.f("input", c, p, 0)));
        t.b("&lineIds=");
        t.b(t.v(t.f("lineIds", c, p, 0)));
        t.b("&dateTypeSelect=Future date&direction=");
        t.b(t.v(t.f("direction", c, p, 0)));
        t.b("&startDate=");
        t.b(t.v(t.f("date", c, p, 0)));
        t.b("T00%3a00%3a00&endDate=");
        t.b(t.v(t.f("date", c, p, 0)));
        t.b("T23%3a59%3a59'  />");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["carouselMedia"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('    <img src="');
        t.b(t.v(t.f("thumbnail", c, p, 0)));
        t.b('" />\r');
        t.b("\n" + i);
        t.b("    <span>");
        t.b(t.v(t.f("caption", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["cc-autopay-delete-confirm"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="hanging-message list-item-remove-dialog">\r');
        t.b("\n" + i);
        t.b('    <div role="alert" class="global-warning-top-icon vehicle-confirm-cancel">\r');
        t.b("\n" + i);
        t.b("        <p><strong>");
        t.b(t.t(t.f("intro", c, p, 0)));
        t.b(" </strong> ");
        t.b(t.t(t.f("message", c, p, 0)));
        t.b("</p>\r");
        t.b("\n" + i);
        t.b('        <div class="button-set no-separator global-warning">\r');
        t.b("\n" + i);
        t.b('            <a data-value="');
        t.b(t.v(t.f("itemId", c, p, 0)));
        t.b('" href="#"\r');
        t.b("\n" + i);
        t.b('                    class="secondary-button confirm has-icon responsive-single-button"\r');
        t.b("\n" + i);
        t.b('                    id="delete-vehicle">\r');
        t.b("\n" + i);
        t.b('                <span class="cta-content">Confirm</span>\r');
        t.b("\n" + i);
        t.b("            </a>\r");
        t.b("\n" + i);
        t.b('            <a id="cancel-delete" href="#"\r');
        t.b("\n" + i);
        t.b('                class="secondary-button cancel has-icon responsive-single-button">\r');
        t.b("\n" + i);
        t.b('                <span class="cta-content">Cancel</span>\r');
        t.b("\n" + i);
        t.b("            </a>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["ccBasketRow"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        if (t.s(t.f("basketItems", c, p, 1), c, p, 0, 16, 590, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<div class="basket-total-row in-cart">\r');
                t.b("\n" + i);
                t.b('    <div class="basket-total-id">\r');
                t.b("\n" + i);
                t.b("        <label>\r");
                t.b("\n" + i);
                t.b("            ");
                t.b(t.v(t.f("productDescription", c, p, 0)));
                t.b("\r");
                t.b("\n" + i);
                t.b("        </label>\r");
                t.b("\n" + i);
                t.b("    </div>\r");
                t.b("\n" + i);
                t.b('        <span class="basket-total-id basket-total-description">\r');
                t.b("\n" + i);
                t.b("\t\t\t");
                t.b(t.v(t.f("dateRange", c, p, 0)));
                t.b("\r");
                t.b("\n" + i);
                t.b("        </span>\r");
                t.b("\n" + i);
                t.b('    <input type="submit" value="Delete"\r');
                t.b("\n" + i);
                t.b('           name="DeleteFromBasket|');
                t.b(t.v(t.f("vrm", c, p, 0)));
                t.b("|");
                t.b(t.v(t.f("startDate", c, p, 0)));
                t.b("|");
                t.b(t.v(t.f("endDate", c, p, 0)));
                t.b("|");
                t.b(t.v(t.f("product", c, p, 0)));
                t.b("|");
                t.b(t.v(t.f("zone", c, p, 0)));
                t.b('"\r');
                t.b("\n" + i);
                t.b('           id="delete-basket-item-');
                t.b(t.v(t.f("vrm", c, p, 0)));
                t.b("-");
                t.b(t.v(t.f("@index", c, p, 0)));
                t.b('"\r');
                t.b("\n" + i);
                t.b('           class="secondary-button basket-total-remove-item">\r');
                t.b("\n" + i);
                t.b('    <span class="basket-total-cost">£');
                t.b(t.v(t.f("amount", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("</div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["ccBasketRowWrapper"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<li class="item-row" id="');
        t.b(t.v(t.f("rowId", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <span class="rucbasket-totals-vrm">');
        t.b(t.v(t.f("vrm", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b('    <div class="vrm-group"></div>\r');
        t.b("\n" + i);
        t.b("</li>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["confirmedFileUpload"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<li role="alert" class="uploaded-file file-message uploadSucceeded form-success-middle-icon" id="confirmed_');
        t.b(t.v(t.f("fileid", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <span class="uploaded-file-name" id="confirmed_file_');
        t.b(t.v(t.f("fileid", c, p, 0)));
        t.b('"><span class="visually-hidden">Uploaded file: </span>');
        t.b(t.v(t.f("originalfilename", c, p, 0)));
        t.b('</span><button class="remove-file trigger-remove-file hello" aria-describedby="confirmed_file_');
        t.b(t.v(t.f("fileid", c, p, 0)));
        t.b('">Remove ');
        t.b(t.v(t.f("originalfilename", c, p, 0)));
        t.b(" file</button>\r");
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_id" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.Id" value="');
        t.b(t.v(t.f("fileid", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_name" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.Name" value="');
        t.b(t.v(t.f("filename", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_originalname" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.OriginalFileName" value="');
        t.b(t.v(t.f("originalfilename", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_uploaded" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.Uploaded" value="');
        t.b(t.v(t.f("timestamp", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_url" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.Url" value="');
        t.b(t.v(t.f("fileurl", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <input type="hidden" id="');
        t.b(t.v(t.f("inputid", c, p, 0)));
        t.b('_fileSizeInBytes" name="');
        t.b(t.v(t.f("inputname", c, p, 0)));
        t.b('.FileSizeInBytes" value="');
        t.b(t.v(t.f("filesize", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b("</li>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["crowding"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('\x3c!--<div class="clearfix busy-station-lines">--\x3e\r');
        t.b("\n" + i);
        t.b('<div class="header">At this time, these lines are busy:</div>\r');
        t.b("\n" + i);
        t.b('<div class="busy-lines">\r');
        t.b("\n" + i);
        t.b('    <ul class="clearfix">\r');
        t.b("\n" + i);
        if (t.s(t.f("lines", c, p, 1), c, p, 0, 184, 352, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("        <li>\r");
                t.b("\n" + i);
                t.b('            <div class="busy-line ');
                t.b(t.v(t.f("className", c, p, 0)));
                t.b('">\r');
                t.b("\n" + i);
                t.b("                <span>");
                t.b(t.v(t.f("name", c, p, 0)));
                t.b(" line ");
                t.b(t.v(t.f("direction", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("            </div>\r");
                t.b("\n" + i);
                t.b("        </li>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </ul>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["cycleElevation"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<h2 class="');
        t.b(t.v(t.f("routeTypeClass", c, p, 0)));
        t.b('">Steep uphill</h2>\r');
        t.b("\n" + i);
        t.b('<div class="cycle-parking-elevation-panel-container">\r');
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container">\r');
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("distance", c, p, 0)));
        t.b('</span><span class="elevation-metres">m</span><div class="sub-text">distance</div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container center">\r');
        t.b("\n" + i);
        t.b("        ");
        t.b(t.v(t.f("gradient", c, p, 0)));
        t.b("%\r");
        t.b("\n" + i);
        t.b('        <div class="sub-text">average gradient</div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container">\r');
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("metresClimbed", c, p, 0)));
        t.b('</span><span class="elevation-metres">m</span><div class="sub-text">elevation gain</div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["cycleParking"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<h2 class="cycle-parking-panel">');
        t.b(t.v(t.f("commonName", c, p, 0)));
        t.b(" cycle parking</h2>\r");
        t.b("\n" + i);
        t.b('<div class="cycle-parking-elevation-panel-container">\r');
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container">\r');
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("numberOfSpaces", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b('        <div class="sub-text">spaces provided</div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container center cycle-parking-type-header">\r');
        t.b("\n" + i);
        t.b("        parking type\r");
        t.b("\n" + i);
        t.b('        <div class="sub-text cycle-parking-type">');
        t.b(t.v(t.f("cycleStandType", c, p, 0)));
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="elevation-info-container covered-text"><span>');
        t.b(t.v(t.f("coveredText", c, p, 0)));
        t.b("</span></div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["cycleRouteLabel"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div aria-hidden="true" class="');
        t.b(t.v(t.f("classes", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <div class="');
        t.b(t.v(t.f("labelClass", c, p, 0)));
        t.b('">');
        t.b(t.v(t.f("name", c, p, 0)));
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["cycleWayMapPanel"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="road-disruption access-point" >\r');
        t.b("\n" + i);
        t.b('    <div class="location">\r');
        t.b("\n" + i);
        t.b("        <h3>\r");
        t.b("\n" + i);
        t.b('            <span class="');
        t.b(t.v(t.f("icon", c, p, 0)));
        t.b('"></span>\r');
        t.b("\n" + i);
        t.b('            <span class="name">');
        t.b(t.v(t.f("name", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("        </h3>\r");
        t.b("\n" + i);
        t.b("        <h4>");
        t.b(t.v(t.f("description", c, p, 0)));
        t.b("</h4>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["dispensationTableRow"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b(" <tr>\r");
        t.b("\n" + i);
        t.b("     <td>");
        t.b(t.v(t.f("date", c, p, 0)));
        t.b("</td><td>");
        t.b(t.v(t.f("startTime", c, p, 0)));
        t.b("</td><td>");
        t.b(t.v(t.f("duration", c, p, 0)));
        t.b("</td>\r");
        t.b("\n" + i);
        t.b(" </tr>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["dispensationVehicle"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("\r");
        t.b("\n" + i);
        t.b('<div class="dispensation-vehicle-tile');
        if (t.s(t.f("canRemove", c, p, 1), c, p, 0, 53, 64, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(" can-remove");
            });
            c.pop();
        }
        t.b('" id="disp-vehicle');
        t.b(t.v(t.f("vehicleCount", c, p, 0)));
        t.b('" tabindex="-1">\r');
        t.b("\n" + i);
        if (t.s(t.f("canRemove", c, p, 1), c, p, 0, 148, 351, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <a class="remove-vehicle" title="Remove this vehicle from your dispensation request">\r');
                t.b("\n" + i);
                t.b('        <span class="visually-hidden">Remove this vehicle from the dispensation request</span>\r');
                t.b("\n" + i);
                t.b("    </a>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b('    <a class="edit-vehicle" title="Edit the details of this vehicle">Edit</a>\r');
        t.b("\n" + i);
        t.b("    <dl>\r");
        t.b("\n" + i);
        if (t.s(t.f("output", c, p, 1), c, p, 0, 471, 551, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('       <dt class="');
                t.b(t.v(t.f("className", c, p, 0)));
                t.b('">');
                t.b(t.v(t.f("key", c, p, 0)));
                t.b("</dt>\r");
                t.b("\n" + i);
                t.b("       <dd>");
                t.b(t.v(t.f("value", c, p, 0)));
                t.b("</dd>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </dl>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["dynamicList"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<ul id="');
        t.b(t.v(t.f("id", c, p, 0)));
        t.b('" class="');
        t.b(t.v(t.f("cssClass", c, p, 0)));
        t.b('" tabindex="0">\r');
        t.b("\n" + i);
        t.b("    \r");
        t.b("\n" + i);
        t.b("</ul>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["editJourney"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="edit-journey">\r');
        t.b("\n" + i);
        t.b('<ul class="fav-rainbow-list">\r');
        t.b("\n" + i);
        if (t.s(t.f("items", c, p, 1), c, p, 0, 70, 609, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <li class="fav-rainbow-list-item" data-from="');
                t.b(t.v(t.f("from", c, p, 0)));
                t.b('" data-to="');
                t.b(t.v(t.f("to", c, p, 0)));
                t.b('" data-via="');
                t.b(t.v(t.f("via", c, p, 0)));
                t.b('" data-from-id="');
                t.b(t.v(t.f("fromId", c, p, 0)));
                t.b('" data-to-id="');
                t.b(t.v(t.f("toId", c, p, 0)));
                t.b('" data-via-id="');
                t.b(t.v(t.f("viaId", c, p, 0)));
                t.b('" data-mode="journey">\r');
                t.b("\n" + i);
                t.b('        <div class="fav-rainbow-list-link fav-star-on" tabindex="1">\r');
                t.b("\n" + i);
                t.b('            <span class="fav-toggle"></span>\r');
                t.b("\n" + i);
                t.b('            <span class="fav-place-text">\r');
                t.b("\n" + i);
                t.b('                <span class="fav-from-to">');
                t.b(t.v(t.f("from", c, p, 0)));
                t.b(" to ");
                t.b(t.v(t.f("to", c, p, 0)));
                if (t.s(t.f("via", c, p, 1), c, p, 0, 488, 500, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b(" via ");
                        t.b(t.v(t.f("via", c, p, 0)));
                    });
                    c.pop();
                }
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("            </span>                                        \r");
                t.b("\n" + i);
                t.b("        </div>\r");
                t.b("\n" + i);
                t.b("    </li>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("</ul>\r");
        t.b("\n" + i);
        if (t.s(t.f("showAddJourneysLink", c, p, 1), c, p, 0, 652, 1168, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<div class="clearfix"></div>\r');
                t.b("\n" + i);
                t.b('<div class="fav-edit-sub-heading panel-section-separator">\r');
                t.b("\n" + i);
                t.b('    <h2 id="sub-heading-add-journeys">Add journeys</h2>\r');
                t.b("\n" + i);
                t.b("</div>\r");
                t.b("\n" + i);
                t.b('<div class="fav-forward-to-all" id="add-journey">\r');
                t.b("\n" + i);
                t.b('    <a class="first-time-panel-description" href="/plan-a-journey/" data-mode="Journey">\r');
                t.b("\n" + i);
                t.b('        <span class="fav-add-link add-journey">Journeys\r');
                t.b("\n" + i);
                t.b("        <br/>\r");
                t.b("\n" + i);
                t.b('        <span class="title-description">Plan a journey and favourite it for quick access in the future</span>\r');
                t.b("\n" + i);
                t.b("        </span>\r");
                t.b("\n" + i);
                t.b("    </a>\r");
                t.b("\n" + i);
                t.b("</div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["failedFileUpload"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<li role="alert" class="global-error-middle-icon file-message uploadFailed" id="failed_');
        t.b(t.v(t.f("fileid", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b("    <strong>");
        if (t.s(t.f("message", c, p, 1), c, p, 0, 126, 139, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(" ");
                t.b(t.v(t.f("message", c, p, 0)));
                t.b(" ");
            });
            c.pop();
        }
        t.b(" ");
        if (!t.s(t.f("message", c, p, 1), c, p, 1, 0, 0, "")) {
            t.b(" Failed to upload ");
        }
        t.b(" ");
        if (t.s(t.f("filename", c, p, 1), c, p, 0, 209, 223, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('"');
                t.b(t.v(t.f("filename", c, p, 0)));
                t.b('"');
            });
            c.pop();
        }
        t.b("</strong>\r");
        t.b("\n" + i);
        t.b("</li>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["favourites-tabs"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="');
        t.b(t.v(t.f("name", c, p, 0)));
        t.b(" ");
        t.b(t.v(t.f("hidden", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <p class="visually-hidden">');
        t.b(t.v(t.f("itemsHeading", c, p, 0)));
        t.b("</p>\r");
        t.b("\n" + i);
        t.b('    <div class="favourites-box">\r');
        t.b("\n" + i);
        if (t.s(t.f("items", c, p, 1), c, p, 0, 140, 3074, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('            <div class="favourites-mode expandable-box');
                if (t.s(t.d("props.disrupted", c, p, 1), c, p, 0, 216, 226, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b(" disrupted");
                    });
                    c.pop();
                }
                if (!t.s(t.d("props.disrupted", c, p, 1), c, p, 1, 0, 0, "")) {
                    t.b(" details-only");
                }
                t.b('">\r');
                t.b("\n" + i);
                t.b('                <div class="content">\r');
                t.b("\n" + i);
                if (t.s(t.d("props.disrupted", c, p, 1), c, p, 0, 382, 457, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                    <div class="always-visible">\r');
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b('                        <a class="link-button" href="');
                t.b(t.v(t.d("props.sspurl", c, p, 0)));
                t.b('">\r');
                t.b("\n" + i);
                t.b('                            <div class="side-bar">\r');
                t.b("\n" + i);
                t.b('                                <span class="visually-hidden">Stop letter:</span>\r');
                t.b("\n" + i);
                if (t.s(t.d("props.stopLetter", c, p, 1), c, p, 0, 740, 879, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                                <span class="mode-icon blank-bus-stop-icon">');
                        t.b(t.v(t.d("props.stopLetter", c, p, 0)));
                        t.b("</span>\r");
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                if (!t.s(t.d("props.stopLetter", c, p, 1), c, p, 1, 0, 0, "")) {
                    t.b('                                <span class="mode-icon ');
                    t.b(t.v(t.f("mode", c, p, 0)));
                    t.b('-icon hide-text">no letter</span>\r');
                    t.b("\n" + i);
                }
                t.b("                            </div>\r");
                t.b("\n" + i);
                t.b('                            <div class="title-row">\r');
                t.b("\n" + i);
                t.b('                                <span class="visually-hidden">Stop name:</span>\r');
                t.b("\n" + i);
                t.b('                                <span class="stop-name">');
                t.b(t.v(t.d("props.name", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("                            </div>\r");
                t.b("\n" + i);
                if (t.s(t.d("props.isBus", c, p, 1), c, p, 0, 1439, 1595, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                            <div class="stop-headline"><span class="destination-name">Towards ');
                        t.b(t.v(t.d("props.towards", c, p, 0)));
                        t.b("</span></div>\r");
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                if (t.s(t.d("props.isBusHub", c, p, 1), c, p, 0, 1660, 1804, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                            <div class="stop-headline"><span class="destination-name">All bus stops</span></div>\r');
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                if (t.s(t.d("props.isLastBusStopOnLine", c, p, 1), c, p, 0, 1883, 2032, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                            <div class="stop-headline"><span class="destination-name">Last stop on route</span></div>\r');
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b("                        </a>\r");
                t.b("\n" + i);
                if (t.s(t.d("props.disrupted", c, p, 1), c, p, 0, 2138, 2188, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b("                    </div>\r");
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b('                    <div class="start-hidden">\r');
                t.b("\n" + i);
                t.b('                        <div class="');
                if (t.s(t.d("props.disrupted", c, p, 1), c, p, 0, 2314, 2325, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b("disruptions");
                    });
                    c.pop();
                }
                t.b(' clearfix">\r');
                t.b("\n" + i);
                if (!t.s(t.d("props.disrupted", c, p, 1), c, p, 1, 0, 0, "")) {
                    t.b("                            <p>No reported disruptions</p>\r");
                    t.b("\n" + i);
                }
                t.b('                            <div class="vertical-button-container">\r');
                t.b("\n" + i);
                t.b('                                <a href="');
                t.b(t.v(t.d("props.sspurl", c, p, 0)));
                t.b('" class="plain-button">View stop information</a>\r');
                t.b("\n" + i);
                if (t.s(t.d("props.disrupted", c, p, 1), c, p, 0, 2765, 2904, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                                <a href="/plan-a-journey/" class="plain-button">Replan your journey</a>\r');
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b("                            </div>\r");
                t.b("\n" + i);
                t.b("                        </div>\r");
                t.b("\n" + i);
                t.b("                    </div>\r");
                t.b("\n" + i);
                t.b("                </div>\r");
                t.b("\n" + i);
                t.b("            </div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </div> \r");
        t.b("\n" + i);
        if (!t.s(t.f("items", c, p, 1), c, p, 1, 0, 0, "")) {
            t.b('        <div class="no-favourites-message">\r');
            t.b("\n" + i);
            t.b("            <h4>No ");
            t.b(t.v(t.f("itemsHeading", c, p, 0)));
            t.b("</h4>\r");
            t.b("\n" + i);
            t.b("            <p>");
            t.b(t.v(t.f("noItemsMessage", c, p, 0)));
            t.b("</p>\r");
            t.b("\n" + i);
            t.b("        </div>\r");
            t.b("\n" + i);
        }
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["favouritesJourney"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="fav-edit-journey" class="fav-panel-item fav-journey" style="display: none;">\r');
        t.b("\n" + i);
        t.b('    <div class="fav-edit-sub-heading">\r');
        t.b("\n" + i);
        t.b('        <h2 id="sub-heading-journey" data-text-edit="Edit" data-text-add="Add" data-track-option="">Favourite journey</h2>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b('    <ul class="fav-rainbow-list">\r');
        t.b("\n" + i);
        t.b('        <li class="fav-rainbow-list-item"\r');
        t.b("\n" + i);
        t.b('            data-mode="');
        t.b(t.v(t.f("mode", c, p, 0)));
        t.b('"\r');
        t.b("\n" + i);
        t.b('            data-from="');
        t.b(t.v(t.f("from", c, p, 0)));
        t.b('" \r');
        t.b("\n" + i);
        t.b('            data-to="');
        t.b(t.v(t.f("to", c, p, 0)));
        t.b('" \r');
        t.b("\n" + i);
        t.b('            data-via="');
        t.b(t.v(t.f("via", c, p, 0)));
        t.b('" \r');
        t.b("\n" + i);
        t.b('            data-from-id="');
        t.b(t.v(t.f("fromId", c, p, 0)));
        t.b('" \r');
        t.b("\n" + i);
        t.b('            data-to-id="');
        t.b(t.v(t.f("toId", c, p, 0)));
        t.b('" \r');
        t.b("\n" + i);
        t.b('            data-via-id="');
        t.b(t.v(t.f("viaId", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('            <div class="fav-rainbow-list-link fav-star-on" tabindex="1">\r');
        t.b("\n" + i);
        t.b('                <span class="fav-toggle"></span>\r');
        t.b("\n" + i);
        t.b('                <span class="fav-place-text">\r');
        t.b("\n" + i);
        t.b('                        <span class="fav-from-to">');
        t.b(t.v(t.f("from", c, p, 0)));
        t.b(" to ");
        t.b(t.v(t.f("to", c, p, 0)));
        if (t.s(t.f("via", c, p, 1), c, p, 0, 869, 881, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(" via ");
                t.b(t.v(t.f("via", c, p, 0)));
            });
            c.pop();
        }
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("                </span>\r");
        t.b("\n" + i);
        t.b("            </div>\r");
        t.b("\n" + i);
        t.b("        </li>\r");
        t.b("\n" + i);
        t.b("    </ul>\r");
        t.b("\n" + i);
        t.b('    <div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["favouritesPlace"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        if (t.s(t.f("fav", c, p, 1), c, p, 0, 8, 629, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<li class="fav-rainbow-list-item" data-id="');
                t.b(t.v(t.f("id", c, p, 0)));
                t.b('" data-place-id="');
                t.b(t.v(t.f("placeId", c, p, 0)));
                t.b('" data-place="');
                t.b(t.v(t.f("name", c, p, 0)));
                t.b('" data-lat="');
                t.b(t.v(t.f("lat", c, p, 0)));
                t.b('" data-lon="');
                t.b(t.v(t.f("lon", c, p, 0)));
                t.b('" data-modes="');
                t.b(t.v(t.f("modes", c, p, 0)));
                t.b('" data-label="');
                t.b(t.v(t.f("label", c, p, 0)));
                t.b('" data-mode="place">\r');
                t.b("\n" + i);
                t.b('    <a class="fav-rainbow-list-link fav-place-journey-link" href="javascript:void(0)">\r');
                t.b("\n" + i);
                t.b('        <div class="mode-icons">\r');
                t.b("\n" + i);
                if (t.s(t.f("modeIcons", c, p, 1), c, p, 0, 363, 434, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('            <span class="mode-icon ');
                        t.b(t.v(t.d(".", c, p, 0)));
                        t.b('">&nbsp;</span>\r');
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b("        </div>\r");
                t.b("\n" + i);
                t.b('        <span class="fav-place-text" data-place-id="');
                t.b(t.v(t.f("placeId", c, p, 0)));
                t.b('">');
                if (t.s(t.d("props.showLabel", c, p, 1), c, p, 0, 551, 575, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b("<span>");
                        t.b(t.v(t.f("label", c, p, 0)));
                        t.b("</span>, ");
                    });
                    c.pop();
                }
                t.b(t.v(t.f("name", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("    </a>\r");
                t.b("\n" + i);
                t.b("</li>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["favouritesPlaceJourney"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="fav-edit-journey" class="fav-panel-item fav-journey fav-journey-place" data-mode="journey">\r');
        t.b("\n" + i);
        t.b('    <div class="fav-edit-sub-heading">\r');
        t.b("\n" + i);
        t.b('        <h2 id="sub-heading-journey" data-text-edit="Edit" data-text-add="Add" data-text-add-recents="Add recents" data-track-option="">Favourite journeys</h2>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="fav-panel-close" data-bind="{ click: closePanel }">\r');
        t.b("\n" + i);
        t.b('        <button class="fav-panel__close fav-panel-done">Done<span class="visually-hidden"> updating my favourites</span></button>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b('    <div id="edit-journey">\r');
        t.b("\n" + i);
        t.b('        <ul class="fav-rainbow-list" data-bind="foreach: journeys">\r');
        t.b("\n" + i);
        t.b("            <li class=\"fav-rainbow-list-item\" data-bind=\"attr: { 'data-from': from, 'data-to': to, 'data-via': via, 'data-from-id': fromId, 'data-to-id': toId, 'data-via-id': viaId, 'data-mode': mode }\">                \r");
        t.b("\n" + i);
        t.b('                <div class="fav-rainbow-list-link" data-bind="{ css: activeState(), click: $parent.toggleJourney }" tabindex="0">\r');
        t.b("\n" + i);
        t.b('                    <span class="fav-toggle"></span>\r');
        t.b("\n" + i);
        t.b('                    <span class="fav-place-text">\r');
        t.b("\n" + i);
        t.b('                        <span class="fav-from-to" data-bind="text: journeyDisplayText"></span>\r');
        t.b("\n" + i);
        t.b("                    </span>\r");
        t.b("\n" + i);
        t.b("                </div>\r");
        t.b("\n" + i);
        t.b("            </li>\r");
        t.b("\n" + i);
        t.b("        </ul>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("\r");
        t.b("\n" + i);
        t.b('<div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b("\r");
        t.b("\n" + i);
        t.b('<div id="fav-rainbow-list-place">\r');
        t.b("\n" + i);
        t.b('    <div class="fav-edit-sub-heading">\r');
        t.b("\n" + i);
        t.b('        <h2 id="sub-heading-place" data-text-edit="Edit" data-text-add="Add" data-track-option="" data-track-mode="my places">My places</h2>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b('    <div id="edit-place">\r');
        t.b("\n" + i);
        t.b('        <ul class="fav-rainbow-list" data-bind="foreach: places">\r');
        t.b("\n" + i);
        t.b('            <li class="fav-rainbow-list-item" data-bind="attr: { \'data-place\': placeName }">\r');
        t.b("\n" + i);
        t.b('                <div class="fav-rainbow-list-link" data-bind="css: activeState()" tabindex="0">\r');
        t.b("\n" + i);
        t.b('                    <span class="fav-place-label" data-bind="{ text: labelValue(), visible: !labelEdit(), css: labelIsNotSet(), click: toggleLabelForEdit }"></span>                    \r');
        t.b("\n" + i);
        t.b('                    <form data-bind="submit: changeLabel">\r');
        t.b("\n" + i);
        t.b('                        <input type="text" placeholder="Add label name" class="custom-label-edit custom-label" data-bind="{ value: label, visible: labelEdit, hasFocus: labelEdit }" />\r');
        t.b("\n" + i);
        t.b("                    </form>\r");
        t.b("\n" + i);
        t.b('                    <div class="clearfix"></div>\r');
        t.b("\n" + i);
        t.b('                    <div data-bind="click: $parent.togglePlace">\r');
        t.b("\n" + i);
        t.b('                        <span class="fav-toggle place"></span>\r');
        t.b("\n" + i);
        t.b('                        <div class="mode-icons" data-bind="foreach: allModeIcons()">\r');
        t.b("\n" + i);
        t.b('                            <span class="mode-icon" data-bind="css: $data">&nbsp;</span>\r');
        t.b("\n" + i);
        t.b("                        </div>\r");
        t.b("\n" + i);
        t.b('                        <span class="fav-place-text" data-bind="text: placeName"></span>\r');
        t.b("\n" + i);
        t.b("                    </div>\r");
        t.b("\n" + i);
        t.b("                </div>\r");
        t.b("\n" + i);
        t.b("            </li>\r");
        t.b("\n" + i);
        t.b("        </ul>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["favouritesPlaceModes"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="edit-place">\r');
        t.b("\n" + i);
        t.b('    <ul class="fav-rainbow-list">\r');
        t.b("\n" + i);
        if (t.s(t.f("fav", c, p, 1), c, p, 0, 74, 769, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <li class="fav-rainbow-list-item" data-id="');
                t.b(t.v(t.f("id", c, p, 0)));
                t.b('" data-place-id="');
                t.b(t.v(t.f("placeId", c, p, 0)));
                t.b('" data-place="');
                t.b(t.v(t.f("name", c, p, 0)));
                t.b('" data-lat="');
                t.b(t.v(t.f("lat", c, p, 0)));
                t.b('" data-lon="');
                t.b(t.v(t.f("lon", c, p, 0)));
                t.b('" data-modes="');
                t.b(t.v(t.f("modes", c, p, 0)));
                t.b('" data-mode="place">\r');
                t.b("\n" + i);
                t.b('            <div class="fav-rainbow-list-link fav-star-on" tabindex="1">\r');
                t.b("\n" + i);
                t.b('                <span class="fav-toggle"></span>\r');
                t.b("\n" + i);
                t.b('                <div class="mode-icons">\r');
                t.b("\n" + i);
                if (t.s(t.f("modeIcons", c, p, 1), c, p, 0, 466, 532, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b('                    <span class="mode-icon ');
                        t.b(t.v(t.d(".", c, p, 0)));
                        t.b('">&nbsp;</span> ');
                    });
                    c.pop();
                }
                t.b("\r");
                t.b("\n" + i);
                t.b("                </div>\r");
                t.b("\n" + i);
                t.b('                <span class="fav-place-label">');
                t.b(t.v(t.f("label", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b('                <span class="fav-place-text" data-place-id="');
                t.b(t.v(t.f("placeId", c, p, 0)));
                t.b('">');
                t.b(t.v(t.f("name", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("            </div>\r");
                t.b("\n" + i);
                t.b("        </li>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </ul>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["galleryCounter"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<span class="gallery-counter">\r');
        t.b("\n" + i);
        t.b("    ");
        t.b(t.v(t.f("index", c, p, 0)));
        t.b(" of ");
        t.b(t.v(t.f("total", c, p, 0)));
        t.b("\r");
        t.b("\n" + i);
        t.b("</span>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["galleryNavigation"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="fs-gallery-navigation" class="');
        t.b(t.v(t.f("className", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <button href="#" id="btn-back" class="gallery-nav gallery-nav-back">\r');
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("prevText", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </button>\r");
        t.b("\n" + i);
        t.b('    <button id="btn-forward" class="gallery-nav gallery-nav-fwd">\r');
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("nextText", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </button>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["galleryOverlay"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="');
        t.b(t.v(t.f("overlayClass", c, p, 0)));
        t.b(' hidden" tabindex="0">\r');
        t.b("\n" + i);
        t.b('    <div class="overlay-header">\r');
        t.b("\n" + i);
        t.b('        <a class="');
        t.b(t.v(t.f("overlayCloseClass", c, p, 0)));
        t.b('" href="#">close</a>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("    ");
        if (t.s(t.f("innerWrap", c, p, 1), c, p, 0, 177, 210, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<div class="gallery-inner"></div>');
            });
            c.pop();
        }
        t.b("\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["genericWarning"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<p class="');
        t.b(t.v(t.f("warningCssClass", c, p, 0)));
        t.b('" ');
        if (t.s(t.f("warningId", c, p, 1), c, p, 0, 45, 65, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(' id="');
                t.b(t.v(t.f("warningId", c, p, 0)));
                t.b('" ');
            });
            c.pop();
        }
        t.b(">");
        if (t.s(t.f("intro", c, p, 1), c, p, 0, 90, 117, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("<strong>");
                t.b(t.v(t.f("intro", c, p, 0)));
                t.b(" </strong>");
            });
            c.pop();
        }
        t.b(t.v(t.f("message", c, p, 0)));
        t.b("</p>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["globalError"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<p class="global-error-middle-icon" ');
        if (t.s(t.f("htmlId", c, p, 1), c, p, 0, 47, 63, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(' id="');
                t.b(t.v(t.f("htmlId", c, p, 0)));
                t.b('"');
            });
            c.pop();
        }
        t.b("><strong>");
        t.b(t.t(t.f("errorMessage", c, p, 0)));
        t.b("</strong></p>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["hiddenInput"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<input class="');
        t.b(t.v(t.f("cssClass", c, p, 0)));
        t.b('" type="hidden" id="');
        t.b(t.v(t.f("id", c, p, 0)));
        t.b('" value="');
        t.b(t.v(t.f("value", c, p, 0)));
        t.b('">');
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["imageGallery"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="');
        t.b(t.v(t.f("galleryImagesCssClass", c, p, 0)));
        t.b('"></div>\r');
        t.b("\n" + i);
        t.b('<div class="');
        t.b(t.v(t.f("captionCssClass", c, p, 0)));
        t.b(' clearfix">\r');
        t.b("\n" + i);
        t.b('    <div class="first-line"><span class="title">TITLE</span>\r');
        t.b("\n" + i);
        t.b('    <span class="counter">COUNTER</span></div>\r');
        t.b("\n" + i);
        t.b('    <span class="content">CONTENT</span>\r');
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["input"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<input type="');
        t.b(t.v(t.f("type", c, p, 0)));
        t.b('" value="');
        t.b(t.v(t.f("value", c, p, 0)));
        t.b('" id="');
        t.b(t.v(t.f("id", c, p, 0)));
        t.b('" name="');
        t.b(t.v(t.f("name", c, p, 0)));
        t.b('" />\r');
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["jamCam"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="map-panel-info">\r');
        t.b("\n" + i);
        t.b("    <div>\r");
        t.b("\n" + i);
        t.b('        <span class="map-panel-heading jam-cam">Jam Cam</span>\r');
        t.b("\n" + i);
        if (t.s(t.f("name", c, p, 1), c, p, 0, 122, 188, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <h4 class="map-panel-subheading">');
                t.b(t.v(t.f("name", c, p, 0)));
                t.b("</h4>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b('        <div class="jam-cam-wrapper">\r');
        t.b("\n" + i);
        t.b('            <video controls autoplay loop poster="');
        t.b(t.v(t.f("posterUrl", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('                <source src="');
        t.b(t.v(t.f("videoUrl", c, p, 0)));
        t.b('" type="video/mp4">\r');
        t.b("\n" + i);
        t.b("            </video>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["journey"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="jp-');
        if (t.s(t.f("isFavourites", c, p, 1), c, p, 0, 29, 32, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("fav");
            });
            c.pop();
        }
        if (t.s(t.f("isRecents", c, p, 1), c, p, 0, 63, 69, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("recent");
            });
            c.pop();
        }
        if (t.s(t.f("isStatusFav", c, p, 1), c, p, 0, 99, 105, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("status");
            });
            c.pop();
        }
        t.b("-content-");
        t.b(t.v(t.f("pagename", c, p, 0)));
        t.b("-");
        t.b(t.v(t.f("small", c, p, 0)));
        t.b('" class="tabs-content" role="tabpanel">\r');
        t.b("\n" + i);
        if (t.s(t.f("recentsEnabled", c, p, 1), c, p, 0, 216, 2796, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                if (t.s(t.f("hasItems", c, p, 1), c, p, 0, 239, 1863, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        if (t.s(t.f("items", c, p, 1), c, p, 0, 263, 1017, "{{ }}")) {
                            t.rs(c, p, function(c, p, t) {
                                t.b('            <a href="/plan-a-journey/results?&InputFrom=');
                                t.b(t.v(t.f("encodedfrom", c, p, 0)));
                                t.b("&FromId=");
                                t.b(t.v(t.f("fromId", c, p, 0)));
                                t.b("&InputTo=");
                                t.b(t.v(t.f("encodedTo", c, p, 0)));
                                t.b("&ToId=");
                                t.b(t.v(t.f("toId", c, p, 0)));
                                if (t.s(t.f("via", c, p, 1), c, p, 0, 398, 434, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b("}&Via=");
                                        t.b(t.v(t.f("encodedVia", c, p, 0)));
                                        t.b("&ViaId=");
                                        t.b(t.v(t.f("viaId", c, p, 0)));
                                    });
                                    c.pop();
                                }
                                t.b('" \r');
                                t.b("\n" + i);
                                t.b('                class="plain-button journey-item"\r');
                                t.b("\n" + i);
                                t.b('                data-journey-type="');
                                if (t.s(t.f("isRecents", c, p, 1), c, p, 0, 546, 552, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b("recent");
                                    });
                                    c.pop();
                                }
                                if (t.s(t.f("isFavourites", c, p, 1), c, p, 0, 583, 592, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b("favourite");
                                    });
                                    c.pop();
                                }
                                t.b('"\r');
                                t.b("\n" + i);
                                t.b('                data-from="');
                                t.b(t.v(t.f("from", c, p, 0)));
                                t.b('" data-from-id="');
                                t.b(t.v(t.f("fromId", c, p, 0)));
                                t.b('" data-from-modes="');
                                t.b(t.v(t.f("fromModes", c, p, 0)));
                                t.b('"\r');
                                t.b("\n" + i);
                                t.b('                data-to="');
                                t.b(t.v(t.f("to", c, p, 0)));
                                t.b('" data-to-id="');
                                t.b(t.v(t.f("toId", c, p, 0)));
                                t.b('" data-to-modes="');
                                t.b(t.v(t.f("toModes", c, p, 0)));
                                t.b('"\r');
                                t.b("\n" + i);
                                t.b('                data-via="');
                                t.b(t.v(t.f("via", c, p, 0)));
                                t.b('" data-via-id="');
                                t.b(t.v(t.f("viaId", c, p, 0)));
                                t.b('" data-via-modes="');
                                t.b(t.v(t.f("viaModes", c, p, 0)));
                                t.b('"\r');
                                t.b("\n" + i);
                                t.b('                data-jumpback="#SavePreferences:visible">');
                                t.b(t.v(t.f("from", c, p, 0)));
                                t.b(" to ");
                                t.b(t.v(t.f("to", c, p, 0)));
                                if (t.s(t.f("via", c, p, 1), c, p, 0, 965, 977, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b(" via ");
                                        t.b(t.v(t.f("via", c, p, 0)));
                                    });
                                    c.pop();
                                }
                                t.b("\r");
                                t.b("\n" + i);
                                t.b("            </a>\r");
                                t.b("\n" + i);
                            });
                            c.pop();
                        }
                        t.b("\r");
                        t.b("\n" + i);
                        if (t.s(t.f("isRecents", c, p, 1), c, p, 0, 1057, 1445, "{{ }}")) {
                            t.rs(c, p, function(c, p, t) {
                                t.b('            <div class="recents-footer">\r');
                                t.b("\n" + i);
                                t.b('                <div class="add-recents"><a href="javascript:void(0)" class="add-recents-to-favourites">Add favourites</a></div>\r');
                                t.b("\n" + i);
                                t.b('                <div class="turn-off-recents"><a href="javascript:void(0)" class="turn-off-recent-journeys">Turn off / clear</a></div>\r');
                                t.b("\n" + i);
                                t.b('                <div class="clearfix"></div>\r');
                                t.b("\n" + i);
                                t.b("            </div>\r");
                                t.b("\n" + i);
                            });
                            c.pop();
                        }
                        if (t.s(t.f("isFavourites", c, p, 1), c, p, 0, 1490, 1834, "{{ }}")) {
                            t.rs(c, p, function(c, p, t) {
                                if (t.s(t.f("hasFiveOrLess", c, p, 1), c, p, 0, 1522, 1631, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b('                <button type="button" class="plain-button edit-my-journeys">Edit</button>\r');
                                        t.b("\n" + i);
                                    });
                                    c.pop();
                                }
                                if (t.s(t.f("hasMoreThanFive", c, p, 1), c, p, 0, 1687, 1800, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b('                <button type="button" class="plain-button view-my-journeys">View all</button>\r');
                                        t.b("\n" + i);
                                    });
                                    c.pop();
                                }
                            });
                            c.pop();
                        }
                        t.b("\r");
                        t.b("\n" + i);
                    });
                    c.pop();
                }
                t.b("\r");
                t.b("\n" + i);
                if (t.s(t.f("hasNoItems", c, p, 1), c, p, 0, 1903, 2775, "{{ }}")) {
                    t.rs(c, p, function(c, p, t) {
                        t.b("\r");
                        t.b("\n" + i);
                        if (t.s(t.f("isRecents", c, p, 1), c, p, 0, 1933, 2536, "{{ }}")) {
                            t.rs(c, p, function(c, p, t) {
                                if (t.s(t.f("recentsOff", c, p, 1), c, p, 0, 1966, 2224, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b("                    <p>Turn on recent journeys so you can access them easily again</p>\r");
                                        t.b("\n" + i);
                                        t.b('                    <p><a href="javascript:void(0)" class="turn-on-recent-journeys" role="button" aria-pressed="false">Turn on recent journeys</a></p>\r');
                                        t.b("\n" + i);
                                    });
                                    c.pop();
                                }
                                if (t.s(t.f("recentsOn", c, p, 1), c, p, 0, 2271, 2508, "{{ }}")) {
                                    t.rs(c, p, function(c, p, t) {
                                        t.b("                    <p>You currently have no recent journeys</p>\r");
                                        t.b("\n" + i);
                                        t.b('                    <p><a href="javascript:void(0)" class="turn-off-recent-journeys" role="button" aria-pressed="true">Turn off recent journeys</a></p>\r');
                                        t.b("\n" + i);
                                    });
                                    c.pop();
                                }
                            });
                            c.pop();
                        }
                        if (t.s(t.f("isFavourites", c, p, 1), c, p, 0, 2581, 2746, "{{ }}")) {
                            t.rs(c, p, function(c, p, t) {
                                t.b('                <p><a href="javascript:void(0)" class="plan-my-journeys">Plan a journey</a> and add to favourites for quick access in the future.</p>\r');
                                t.b("\n" + i);
                            });
                            c.pop();
                        }
                        t.b("\r");
                        t.b("\n" + i);
                    });
                    c.pop();
                }
            });
            c.pop();
        }
        if (!t.s(t.f("recentsEnabled", c, p, 1), c, p, 1, 0, 0, "")) {
            t.b("    <div>\r");
            t.b("\n" + i);
            t.b('        <div class="js-cookie-warning cookie-warning-message">\r');
            t.b("\n" + i);
            t.b("            <p>");
            t.b(t.v(t.f("recentsMessage", c, p, 0)));
            t.b("</p>\r");
            t.b("\n" + i);
            t.b("        </div>\r");
            t.b("\n" + i);
            t.b('        <div class="js-cookie-renew cookie-warning-link">\r');
            t.b("\n" + i);
            t.b('            <a class="link2">');
            t.b(t.v(t.f("recentsLink", c, p, 0)));
            t.b("</a>\r");
            t.b("\n" + i);
            t.b("        </div>\r");
            t.b("\n" + i);
            t.b("    </div>\r");
            t.b("\n" + i);
        }
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["jpTaxiTrip"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<span class="journey-box taxi" data-tracking="taxi-prop" data-tracking-value="taxi-prop-value">\r');
        t.b("\n" + i);
        t.b('    <div class="method taxi">\r');
        t.b("\n" + i);
        t.b("        <h4>Black taxi</h4>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="two-col">\r');
        t.b("\n" + i);
        t.b('        <div class="col1">\r');
        t.b("\n" + i);
        t.b('            <div class="route-data moderate taxi">\r');
        t.b("\n" + i);
        t.b('                <p class="visually-hidden">Distance: <strong>');
        t.b(t.v(t.f("distance", c, p, 0)));
        t.b("km</strong></p>\r");
        t.b("\n" + i);
        t.b("                <p>Expected time without traffic</p>\r");
        t.b("\n" + i);
        t.b("            </div>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b('        <div class="col2 journey-info">\r');
        t.b("\n" + i);
        t.b("            <strong>");
        t.b(t.v(t.f("duration", c, p, 0)));
        t.b("</strong>mins\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</span>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["lightBox"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div id="light-box" tabindex="-1" role="dialog" aria-labelledby="dialog-title" aria-live="assertive">\r');
        t.b("\n" + i);
        t.b('    <div class="content-wrap">\r');
        t.b("\n" + i);
        t.b('        <a href="javascript:void(0);" class="close-light-box" data-jumpback=".alert-box-last-tab-target">Close</a>     \r');
        t.b("\n" + i);
        t.b('        <div class="content" tabindex="1"></div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="ie-polyfill"></div>\r');
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["listVehicles"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<ul class="input-list radiobutton-list with-warnings">\r');
        t.b("\n" + i);
        if (t.s(t.f("items", c, p, 1), c, p, 0, 70, 1297, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <li class="input-list-item car-msg">\r');
                t.b("\n" + i);
                t.b('        <input value="');
                t.b(t.v(t.f("vrm", c, p, 0)));
                t.b('" name="radios_with_warning" id="radios_with_warning_1" type="radio">\r');
                t.b("\n" + i);
                t.b('        <label class="boxed-label-for-input all-grey" for="radios_with_warning_1">\r');
                t.b("\n" + i);
                t.b('            <span class="vehicle-details">\r');
                t.b("\n" + i);
                t.b('                <span class="title">');
                t.b(t.v(t.f("vrm", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("                <span>");
                t.b(t.v(t.f("colour", c, p, 0)));
                t.b(" ");
                t.b(t.v(t.f("make", c, p, 0)));
                t.b(" ");
                t.b(t.v(t.f("model", c, p, 0)));
                t.b("</span>\r");
                t.b("\n" + i);
                t.b("            </span>\r");
                t.b("\n" + i);
                t.b("        </label>\r");
                t.b("\n" + i);
                t.b("\r");
                t.b("\n" + i);
                if (!t.s(t.f("isLezCompliant", c, p, 1), c, p, 1, 0, 0, "")) {
                    t.b('    <div class="global-warning">\r');
                    t.b("\n" + i);
                    t.b('        <h2 class="message-title">No charge payable for ');
                    t.b(t.v(t.f("vrm", c, p, 0)));
                    t.b("</h2>\r");
                    t.b("\n" + i);
                    t.b('        <p class="no-bold">');
                    t.b(t.v(t.f("today", c, p, 0)));
                    t.b("</p>\r");
                    t.b("\n" + i);
                    t.b('        <p class="no-bold">Based on the vehicle registration (VRM) details that you have entered and the classification information held by Transport for London (TFL) on this day, you are not required to pay the congestion charge</p>\r');
                    t.b("\n" + i);
                    t.b('        <p class="no-bold">If you believe that this information is incorrect and you still want to pay the Congestion Charge, then you can continue.</p>\r');
                    t.b("\n" + i);
                    t.b("        <p>Please be aware that classification may change without notification, so you should always check to see if payment is required for journeys into the zone.</p>\r");
                    t.b("\n" + i);
                    t.b("\r");
                    t.b("\n" + i);
                    t.b("    </div>\r");
                    t.b("\n" + i);
                }
                t.b("        \r");
                t.b("\n" + i);
                t.b("    </li>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("</ul>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["majorEventComments"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b(t.t(t.f("comment", c, p, 0)));
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["modalSimpleComponent"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("<div class='modal-simple-component'>\r");
        t.b("\n" + i);
        t.b("    <div class='modal-overlay' id='modal-overlay' tabindex='-1'></div>\r");
        t.b("\n" + i);
        t.b("    <div class='m088-modal-window' role='dialog' aria-labelledby='modal-title' aria-describedby='modal-text-body'>\r");
        t.b("\n" + i);
        t.b('        <section id="modal-header" class="modal-header">\r');
        t.b("\n" + i);
        t.b("            <p id='modal-title' class='modal-title'>");
        t.b(t.v(t.f("title", c, p, 0)));
        t.b("</p>\r");
        t.b("\n" + i);
        t.b("            <a class='close' id=\"modal-close\" href=\"#\" role='button' tabindex='0' aria-labelledby='close'>Close</a>\r");
        t.b("\n" + i);
        t.b("        </section>\r");
        t.b("\n" + i);
        t.b("        <section id='modal-body' class='modal-body'>\r");
        t.b("\n" + i);
        t.b("            ");
        t.b(t.t(t.f("body", c, p, 0)));
        t.b("\r");
        t.b("\n" + i);
        t.b("        </section>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["nearby-list-show-more"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<a href="#" class="show-more">\r');
        t.b("\n" + i);
        t.b('    <div class="nearby-mode-information"></div>\r');
        t.b("\n" + i);
        t.b('    <div class="nearby-mode-details">\r');
        t.b("\n" + i);
        t.b("        Show more like this\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</a>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["personalisationStarOnboard"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<span class="onboard-modal-popup ');
        t.b(t.v(t.f("class", c, p, 0)));
        t.b('" data-onboard-feature="');
        t.b(t.v(t.f("dataOnboardFeature", c, p, 0)));
        t.b('" data-tracking-event="');
        t.b(t.v(t.f("dataTrackingEvent", c, p, 0)));
        t.b('" data-tracking="');
        t.b(t.v(t.f("dataTracking", c, p, 0)));
        t.b('" data-tracking-value="');
        t.b(t.v(t.f("dataTrackingValue", c, p, 0)));
        t.b('" data-newreturnuser="true">\r');
        t.b("\n" + i);
        t.b('    <a class="onboard-open-fav-panel" href="javascript:void(0);">\r');
        t.b("\n" + i);
        t.b('        <span class="onboard-modal-close" data-tracking-event="" data-tracking="" data-tracking-value="">\r');
        t.b("\n" + i);
        t.b('            <span class="icon close-icon-white"></span>\r');
        t.b("\n" + i);
        t.b("        </span>\r");
        t.b("\n" + i);
        t.b('        <span class="onboard-modal-text">');
        t.b(t.t(t.f("content", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b('        <span class="onboard-modal-text link">');
        t.b(t.t(t.f("linkContent", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </a>\r");
        t.b("\n" + i);
        t.b("</span>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["rangeList"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        if (t.s(t.f("content", c, p, 1), c, p, 0, 12, 257, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<div class="range ');
                t.b(t.v(t.f("classNames", c, p, 0)));
                t.b(" group-");
                t.b(t.v(t.f("range", c, p, 0)));
                t.b('" data-load-target="');
                t.b(t.v(t.f("range", c, p, 0)));
                t.b('">\r');
                t.b("\n" + i);
                t.b('    <a href="javascript:;" role="button" aria-label="View the list for ');
                t.b(t.v(t.f("range", c, p, 0)));
                t.b('">');
                t.b(t.v(t.f("range", c, p, 0)));
                t.b("</a>\r");
                t.b("\n" + i);
                t.b("    <ul class='bus-data sorted busList-");
                t.b(t.v(t.f("range", c, p, 0)));
                t.b("'></ul>\r");
                t.b("\n" + i);
                t.b("</div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["review-step-button"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<button class="');
        t.b(t.v(t.f("reviewStepButtonClass", c, p, 0)));
        t.b(' secondary-button">Edit</button>');
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["roadDisruptionButtons"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="padded-button-container">\r');
        t.b("\n" + i);
        t.b('    <div class="vertical-button-container">\r');
        t.b("\n" + i);
        t.b('        <button class="plain-button view-on-map">View on map</button>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        if (t.s(t.f("includeJamCam", c, p, 1), c, p, 0, 189, 336, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <div class="vertical-button-container jamcams">\r');
                t.b("\n" + i);
                t.b('        <button class="plain-button jamcams">View nearby Jam Cams</button>\r');
                t.b("\n" + i);
                t.b("    </div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["roadMessageSign"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("<div>\r");
        t.b("\n" + i);
        t.b('    <span class="map-panel-heading variable-message">Variable Message Sign</span>\r');
        t.b("\n" + i);
        if (t.s(t.f("header", c, p, 1), c, p, 0, 105, 169, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <h4 class="map-panel-subheading">');
                t.b(t.v(t.f("header", c, p, 0)));
                t.b("</h4>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b('    <div class="variable-message-sign">\r');
        t.b("\n" + i);
        if (t.s(t.f("messages", c, p, 1), c, p, 0, 244, 292, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <p class="message">');
                t.b(t.v(t.d(".", c, p, 0)));
                t.b("</p>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b('        <div class="corners"></div>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["rowWithMain"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="r">\r');
        t.b("\n" + i);
        t.b('    <div class="main">\r');
        t.b("\n" + i);
        t.b("        \r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["schematic-map-options-panel"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="map-options-panel">\r');
        t.b("\n" + i);
        t.b('    <div class="map-options-panel-heading">\r');
        t.b("\n" + i);
        t.b('        <span class="menu-icon-alt icon"></span>\r');
        t.b("\n" + i);
        t.b('        <span class="">Map options</span>\r');
        t.b("\n" + i);
        t.b('        <span class="close3-icon icon close-map-panel-button"></span>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="map-options-panel-body">\r');
        t.b("\n" + i);
        t.b('        <div class="clearfix radiobutton-list">\r');
        t.b("\n" + i);
        t.b('            <input class="map-panel-radio" id="coloured-disruptions" type="radio" name="disruption-colour" checked />\r');
        t.b("\n" + i);
        t.b('            <label for="coloured-disruptions" class="map-panel-radio-with-image radiobutton-list-item">\r');
        t.b("\n" + i);
        t.b('                <span class="map-panel-radio-image"/>\r');
        t.b("\n" + i);
        t.b("                <span>Colour disruptions</span>\r");
        t.b("\n" + i);
        t.b("                \r");
        t.b("\n" + i);
        t.b("            </label>\r");
        t.b("\n" + i);
        t.b('            <input class="map-panel-radio"  id="grey-disruptions" type="radio" name="disruption-colour" />\r');
        t.b("\n" + i);
        t.b('            <label for="grey-disruptions" class="map-panel-radio-with-image radiobutton-list-item">\r');
        t.b("\n" + i);
        t.b('                <span class="map-panel-radio-image" />\r');
        t.b("\n" + i);
        t.b("                <span>Grey disruptions</span>\r");
        t.b("\n" + i);
        t.b("                \r");
        t.b("\n" + i);
        t.b("            </label>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["schematicMapOptionsPanel"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="map-options-panel">\r');
        t.b("\n" + i);
        t.b('    <div class="map-options-panel-heading">\r');
        t.b("\n" + i);
        t.b('        <span class="menu-icon-alt icon"></span>\r');
        t.b("\n" + i);
        t.b('        <span class="">Map options</span>\r');
        t.b("\n" + i);
        t.b('        <span class="close3-icon icon close-map-panel-button"></span>\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b('    <div class="map-options-panel-body">\r');
        t.b("\n" + i);
        t.b('        <div class="clearfix radiobutton-list">\r');
        t.b("\n" + i);
        t.b('            <input class="map-panel-radio" id="coloured-disruptions" type="radio" name="disruption-colour" ');
        if (!t.s(t.f("greyDisruptions", c, p, 1), c, p, 1, 0, 0, "")) {
            t.b(" checked ");
        }
        t.b("  />\r");
        t.b("\n" + i);
        t.b('            <label for="coloured-disruptions" class="map-panel-radio-with-image radiobutton-list-item">\r');
        t.b("\n" + i);
        t.b('                <span class="map-panel-radio-image"/>\r');
        t.b("\n" + i);
        t.b("                <span>Colour disruptions</span>\r");
        t.b("\n" + i);
        t.b("                \r");
        t.b("\n" + i);
        t.b("            </label>\r");
        t.b("\n" + i);
        t.b('            <input class="map-panel-radio"  id="grey-disruptions" type="radio" name="disruption-colour" ');
        if (t.s(t.f("greyDisruptions", c, p, 1), c, p, 0, 880, 889, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b(" checked ");
            });
            c.pop();
        }
        t.b("/>\r");
        t.b("\n" + i);
        t.b('            <label for="grey-disruptions" class="map-panel-radio-with-image radiobutton-list-item">\r');
        t.b("\n" + i);
        t.b('                <span class="map-panel-radio-image" />\r');
        t.b("\n" + i);
        t.b("                <span>Grey disruptions</span>\r");
        t.b("\n" + i);
        t.b("                \r");
        t.b("\n" + i);
        t.b("            </label>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["selectOptions"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        if (t.s(t.f("output", c, p, 1), c, p, 0, 11, 61, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('    <option value="');
                t.b(t.v(t.f("key", c, p, 0)));
                t.b('">');
                t.b(t.v(t.f("value", c, p, 0)));
                t.b("</option>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["simpleButton"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<button class="');
        t.b(t.v(t.f("cssClasses", c, p, 0)));
        t.b('">');
        t.b(t.v(t.f("text", c, p, 0)));
        t.b("</button>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["stackedListWarning"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<li class="stacked-list-item remove-success">\r');
        t.b("\n" + i);
        t.b("    ");
        t.b(t.t(t.f("content", c, p, 0)));
        t.b("\r");
        t.b("\n" + i);
        t.b("</li>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["statusBoardUnavailable"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("<div class='r'>\r");
        t.b("\n" + i);
        t.b("    <span class='field-validation-error'>\r");
        t.b("\n" + i);
        t.b("        <strong>Service Board</strong><br>API response: Service Unavailable\r");
        t.b("\n" + i);
        t.b("    </span>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["surveyLightboxLink"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<a id="leave-feedback-lightbox" target="_blank" data-responsive="false" data-pull-content="#lightbox-content" data-light-box-type="text" href="');
        t.b(t.v(t.f("link", c, p, 0)));
        t.b('"></a>');
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["surveyToasterContent"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('    <div class="popup-content" data-pull-content="">\r');
        t.b("\n" + i);
        t.b("        ");
        if (t.s(t.f("showContent", c, p, 1), c, p, 0, 78, 96, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("<p>");
                t.b(t.v(t.f("content", c, p, 0)));
                t.b("</p>");
            });
            c.pop();
        }
        t.b("\r");
        t.b("\n" + i);
        t.b('        <a id="survey-toaster-yes-link" class="plain-button" href="');
        t.b(t.v(t.d("link.url", c, p, 0)));
        t.b('" title="');
        t.b(t.v(t.d("link.title", c, p, 0)));
        t.b('">');
        t.b(t.v(t.d("link.title", c, p, 0)));
        t.b("</a>\r");
        t.b("\n" + i);
        t.b("    </div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["surveyToasterNegativeLink"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<a class="plain-button" href="#" title="');
        t.b(t.v(t.f("title", c, p, 0)));
        t.b('">');
        t.b(t.v(t.f("text", c, p, 0)));
        t.b("</a>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["surveyToasterWrapper"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="popup">\r');
        t.b("\n" + i);
        t.b('    <div class="popup-title">');
        t.b(t.v(t.f("title", c, p, 0)));
        t.b('<span id="survey-toaster-icon" class="popup-title-icon white-up-arrow"></span></div>\r');
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["taxiRankMapPanel"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b("<div class='nearby-mode-information'>\r");
        t.b("\n" + i);
        t.b("    <span class='mode-icon taxi-icon'><span class='visually-hidden'>Taxi Rank</span></span>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("<div class='nearby-mode-details'>\r");
        t.b("\n" + i);
        t.b("    <span class='nearby-list-heading'><h2>");
        t.b(t.v(t.f("commonName", c, p, 0)));
        t.b("</h2></span>\r");
        t.b("\n" + i);
        t.b("    <div>\r");
        t.b("\n" + i);
        if (t.s(t.f("operationInfo", c, p, 1), c, p, 0, 282, 427, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b("        <div>Capacity: ");
                t.b(t.v(t.f("NumberOfSpaces", c, p, 0)));
                t.b("</div>\r");
                t.b("\n" + i);
                t.b("        <div>Open: ");
                t.b(t.v(t.f("OperationDays", c, p, 0)));
                t.b(", ");
                t.b(t.v(t.f("OperationTimes", c, p, 0)));
                t.b("</div>\r");
                t.b("\n" + i);
                t.b("        <br>        \r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["tbd-item-full"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="tbd-item-full" id="gallery-item-');
        t.b(t.v(t.f("index", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <div class="_container">\r');
        t.b("\n" + i);
        t.b('        <div class="_photo-full" style="background-image: url(\'');
        t.b(t.v(t.f("image", c, p, 0)));
        t.b("')\"></div>\r");
        t.b("\n" + i);
        t.b('        <div class="_details">\r');
        t.b("\n" + i);
        t.b('            <div class="content-padder">\r');
        t.b("\n" + i);
        t.b("                <h3>");
        t.b(t.v(t.f("caption", c, p, 0)));
        t.b("</h3>\r");
        t.b("\n" + i);
        t.b("                <div>");
        t.b(t.t(t.f("content", c, p, 0)));
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("            </div>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["tbd-item"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<a class="tbd-gallery-icon _gallery-item" href="#" data-item-index="');
        t.b(t.v(t.f("index", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b('    <div class="_picture"><img\r');
        t.b("\n" + i);
        t.b('            src="');
        t.b(t.v(t.f("thumb", c, p, 0)));
        t.b('"\r');
        t.b("\n" + i);
        t.b("            data-tfl-gallery-url='");
        t.b(t.v(t.f("image", c, p, 0)));
        t.b("'\r");
        t.b("\n" + i);
        t.b('            alt="');
        t.b(t.v(t.f("title", c, p, 0)));
        t.b('"></div>\r');
        t.b("\n" + i);
        t.b('    <div class="_caption">\r');
        t.b("\n" + i);
        t.b('        <h2 class="gallery-index">');
        t.b(t.v(t.f("id", c, p, 0)));
        t.b("</h2>\r");
        t.b("\n" + i);
        t.b('        <h2 class="gallery-item-title">');
        t.b(t.v(t.f("title", c, p, 0)));
        t.b("</h2>\r");
        t.b("\n" + i);
        t.b('        <div class="_caption-text">');
        t.b(t.t(t.f("content", c, p, 0)));
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</a>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["tbdMapInfo"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="map-panel-info tdb-map-info">\r');
        t.b("\n" + i);
        t.b('    <div class="design-icon-image">\r');
        t.b("\n" + i);
        t.b('        <img alt="');
        t.b(t.v(t.f("caption", c, p, 0)));
        t.b('" src="');
        t.b(t.v(t.f("thumb", c, p, 0)));
        t.b('">\r');
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("    <h3>");
        t.b(t.v(t.f("caption", c, p, 0)));
        t.b("</h3>\r");
        t.b("\n" + i);
        t.b("    <div>");
        t.b(t.t(t.f("content", c, p, 0)));
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["textAreaCounter"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<span class="text-area-counter">\r');
        t.b("\n" + i);
        t.b('    <span class="char-count">');
        t.b(t.v(t.f("charCount", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    /\r");
        t.b("\n" + i);
        t.b('    <span class="char-limit">');
        t.b(t.v(t.f("charLimit", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("</span>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleAffectedByLezWarning"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<p class="global-warning">\r');
        t.b("\n" + i);
        t.b("    <strong>");
        t.b(t.v(t.f("vrm", c, p, 0)));
        t.b(" is affected by the Low Emission Zone </strong>\r");
        t.b("\n" + i);
        t.b("</p>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleDeleteConfirm"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="hanging-message">\r');
        t.b("\n" + i);
        t.b('    <div class="with-indicator yellow">\r');
        t.b("\n" + i);
        t.b('        <div class="yellow global-warning-top-icon">\r');
        t.b("\n" + i);
        t.b('            <p role="alert" class="">\r');
        t.b("\n" + i);
        t.b("                ");
        t.b(t.t(t.f("message", c, p, 0)));
        t.b("\r");
        t.b("\n" + i);
        t.b("            </p>\r");
        t.b("\n" + i);
        t.b('            <div class="button-set no-separator global-warning">\r');
        t.b("\n" + i);
        t.b('                <button name="');
        t.b(t.v(t.f("deleteAction", c, p, 0)));
        t.b('" value="');
        t.b(t.v(t.f("vrm", c, p, 0)));
        t.b('"\r');
        t.b("\n" + i);
        t.b('                        class="secondary-button confirm has-icon responsive-single-button"\r');
        t.b("\n" + i);
        t.b('                        id="delete-vehicle">\r');
        t.b("\n" + i);
        t.b('                    <span class="cta-content">Confirm</span>\r');
        t.b("\n" + i);
        t.b("                </button>\r");
        t.b("\n" + i);
        t.b('                <button name="CancelRemoveVehicle" id="cancel-delete"\r');
        t.b("\n" + i);
        t.b('                        class="secondary-button cancel has-icon responsive-single-button">\r');
        t.b("\n" + i);
        t.b('                    <span class="cta-content">Cancel</span>\r');
        t.b("\n" + i);
        t.b("                </button>\r");
        t.b("\n" + i);
        t.b("            </div>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleDetails"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="car-msg message-container">\r');
        t.b("\n" + i);
        t.b('    <span class="vehicle-details">\r');
        t.b("\n" + i);
        t.b('        <span class="title">');
        t.b(t.v(t.f("vrm", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("colour", c, p, 0)));
        t.b(" ");
        t.b(t.v(t.f("make", c, p, 0)));
        t.b(" ");
        t.b(t.v(t.f("model", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </span>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleLookupConfirmation"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<li id="');
        t.b(t.v(t.f("id", c, p, 0)));
        t.b('" class="car-msg message-container">\r');
        t.b("\n" + i);
        t.b('    <span class="vehicle-details">\r');
        t.b("\n" + i);
        t.b('        <span class="visually-hidden result-assist">Confirmed vehicle with registration mark</span>\r');
        t.b("\n" + i);
        t.b('        <span class="title entered-vrm">');
        t.b(t.v(t.f("VRM", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b('        <span class="vehicle-make-model">');
        t.b(t.v(t.f("details", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        if (t.s(t.f("friendlyName", c, p, 1), c, p, 0, 331, 406, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <strong class="friendly-name">');
                t.b(t.v(t.f("friendlyName", c, p, 0)));
                t.b("</strong>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        if (t.s(t.f("servicesString", c, p, 1), c, p, 0, 452, 595, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('        <span class="extra-info">\r');
                t.b("\n" + i);
                t.b("            <strong>");
                t.b(t.v(t.f("servicesPrefix", c, p, 0)));
                t.b("</strong>\r");
                t.b("\n" + i);
                t.b("            ");
                t.b(t.v(t.f("servicesString", c, p, 0)));
                t.b("\r");
                t.b("\n" + i);
                t.b("        </span>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("    </span>\r");
        t.b("\n" + i);
        t.b('    <button class="remove-item-from-list">\r');
        t.b("\n" + i);
        t.b('        <span class="visually-hidden">Remove vehicle with registration ');
        t.b(t.v(t.f("VRM", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </button>\r");
        t.b("\n" + i);
        t.b("</li>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleNotFound"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<p class="global-error">\r');
        t.b("\n" + i);
        t.b("    <strong>");
        t.b(t.v(t.f("errorMessage", c, p, 0)));
        t.b("</strong>\r");
        t.b("\n" + i);
        t.b("</p>\r");
        t.b("\n" + i);
        t.b("\r");
        t.b("\n" + i);
        t.b('<div class="form-control-wrapper">\r');
        t.b("\n" + i);
        t.b('    <div class="form-control">\r');
        t.b("\n" + i);
        t.b('        <div class="styled-checkbox">\r');
        t.b("\n" + i);
        t.b('            <input checked="checked" id="confirm-vrm" name="confirm-vrm" type="checkbox" value="1">\r');
        t.b("\n" + i);
        t.b('            <input name="confirm-vrm" type="hidden" value="1">\r');
        t.b("\n" + i);
        t.b('            <label class="styled-checkbox-label " for="confirm-vrm">I confirm that this is the correct Vehicle Registration Mark</label>\r');
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["vehicleSearchResult"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="car-msg message-container">\r');
        t.b("\n" + i);
        t.b('    <span class="vehicle-details">\r');
        t.b("\n" + i);
        t.b('        <span class="title">');
        t.b(t.v(t.f("vrm", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("        <span>");
        t.b(t.v(t.f("colour", c, p, 0)));
        t.b(" ");
        t.b(t.v(t.f("make", c, p, 0)));
        t.b(" ");
        t.b(t.v(t.f("model", c, p, 0)));
        t.b("</span>\r");
        t.b("\n" + i);
        t.b("    </span>\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n" + i);
        t.b("\r");
        t.b("\n" + i);
        if (t.s(t.f("isCczCompliant", c, p, 1), c, p, 0, 215, 908, "{{ }}")) {
            t.rs(c, p, function(c, p, t) {
                t.b('<div class="global-warning">\r');
                t.b("\n" + i);
                t.b('    <h2 class="message-title">No charge payable for ');
                t.b(t.v(t.f("vrm", c, p, 0)));
                t.b("</h2>\r");
                t.b("\n" + i);
                t.b('    <p class="no-bold">');
                t.b(t.v(t.f("today", c, p, 0)));
                t.b("</p>\r");
                t.b("\n" + i);
                t.b('    <p class="no-bold">Based on the vehicle registration (VRM) details that you have entered and the classification information held by Transport for London (TFL) on this day, you are not required to pay the congestion charge</p>\r');
                t.b("\n" + i);
                t.b('    <p class="no-bold">If you believe that this information is incorrect and you still want to pay the Congestion Charge, then you can continue.</p>\r');
                t.b("\n" + i);
                t.b("    <p>Please be aware that classification may change without notification, so you should always check to see if payment is required for journeys into the zone.</p>\r");
                t.b("\n" + i);
                t.b("\r");
                t.b("\n" + i);
                t.b("</div>\r");
                t.b("\n" + i);
            });
            c.pop();
        }
        t.b("\r");
        t.b("\n" + i);
        t.b('<div class="expandable-box prominent-inline-help">\r');
        t.b("\n" + i);
        t.b('    <div class="content">\r');
        t.b("\n" + i);
        t.b('        <div class="always-visible" aria-expanded="false">\r');
        t.b("\n" + i);
        t.b('            <a href="javascript:void(0);" class="controls">&nbsp;</a>\r');
        t.b("\n" + i);
        t.b('            <div class="accordion-heading">This is not my vehicle</div>\r');
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b('        <div class="start-hidden grouped-info-container with-indicator blue">\r');
        t.b("\n" + i);
        t.b("            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec sed fringilla enim. Sed nec ante orci, id ultrices ipsum. Donec justo augue, sagittis nec rutrum sed, viverra ac lorem. Etiam justo magna, molestie quis semper eu, faucibus eget dui. Pellentesque eleifend, libero sit amet suscipit euismod, nunc dui volutpat risus, sit amet volutpat ante magna nec tellus. Sed dapibus, mi id congue venenatis, quam enim vehicula libero, id vestibulum est lacus sit amet mauris. Fusce nec dapibus mauris. Nunc semper porta mi, convallis gravida odio luctus at. Pellentesque habitant morbi tristique senectus et netus et malesuada fames ac turpis egestas. Mauris vel erat libero. Aliquam erat volutpat. Quisque lectus nunc, vestibulum scelerisque imperdiet at, molestie sit amet lacus. Cras a nisl justo, id venenatis magna. Donec vitae turpis et orci vulputate mattis.</p>\r");
        t.b("\n" + i);
        t.b("        </div>\r");
        t.b("\n" + i);
        t.b("    </div>\r");
        t.b("\n" + i);
        t.b("</div>");
        return t.fl();
    },
    partials: {},
    subs: {}
});

this["hoganTemplates"]["zone-checker-result"] = new Hogan.Template({
    code: function(c, p, i) {
        var t = this;
        t.b(i = i || "");
        t.b('<div class="zone-search-result">\r');
        t.b("\n" + i);
        t.b("    <p>The address you specified is: <strong>");
        t.b(t.v(t.f("AddressLine1", c, p, 0)));
        t.b(", ");
        t.b(t.v(t.f("Postcode", c, p, 0)));
        t.b("</strong>\r");
        t.b("\n" + i);
        t.b('        <a href="#" id="zone-search-again">Find another address</a>\r');
        t.b("\n" + i);
        t.b("    </p>\r");
        t.b("\n" + i);
        t.b("    ");
        t.b(t.t(t.f("ServerResponse", c, p, 0)));
        t.b("\r");
        t.b("\n" + i);
        t.b("</div>\r");
        t.b("\n");
        return t.fl();
    },
    partials: {},
    subs: {}
});

window.tfl.autocomplete = window.tfl.autocomplete || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.autocomplete.sources: loaded");
    o.autocompleteDisplayNumberLimit = 5;
    var stationList = [];
    o.stationsStopsSelectionCallback = function(inputEl, datum) {
        var el = $(inputEl);
        var a = datum.a || datum.placeId;
        el.attr("data-" + el.attr("id").toLowerCase() + "-id", a);
        var c = JSON.stringify(datum.c ? datum.c : datum.placeModes);
        el.attr("data-" + el.attr("id").toLowerCase() + "-modes", c);
    };
    o.stationsStopsRemoveContent = function(inputEl) {
        var el = $(inputEl);
        el.removeAttr("data-" + el.attr("id").toLowerCase() + "-id");
        el.removeAttr("data-" + el.attr("id").toLowerCase() + "-modes");
    };
    function compareStringLengths(a, b) {
        if (a.a.length < b.a.length) return -1;
        if (a.a.length > b.a.length) return 1;
        return 0;
    }
    o.getGeolocation = function(geoCallback) {
        var callback = function(inputEl) {
            $(inputEl).removeAttr("data-dataset-name");
            o.stationsStopsRemoveContent(inputEl);
            if (tfl.stats.tealiumTracking) {
                var trackingItem = {};
                trackingItem[tfl.dictionary.TrackingEvent.Name] = tfl.dictionary.TrackingEvent.JourneyPlannerResultsInteraction_prop35;
                trackingItem[tfl.dictionary.TrackingProp.JourneyPlannerResultsInteractionDetail_35.Name] = tfl.dictionary.TrackingProp.JourneyPlannerResultsInteractionDetail_35.MyLocation;
                tfl.stats.tealiumTracking(trackingItem);
            }
            tfl.geolocation.geolocateMe(inputEl, geoCallback);
        };
        var compiledTemplate = Hogan.compile("<a id='{{id}}' role='option' class='geolocation-link' tabindex='-1' href='javascript:void(0)'><span class='geolocation-icon'>&nbsp</span>{{value}}</a>");
        return {
            typeaheadSource: {
                callback: callback,
                displayKey: "value",
                name: "geolocation",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate)
                }
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function() {
                    return [ "" ];
                },
                queryTokenizer: function() {
                    return [ "" ];
                },
                limit: 1,
                minLength: 0,
                local: [ {
                    value: "Use my location"
                } ]
            })
        };
    };
    o.getFavouritePlaces = function(name, local, callback, template, displayKey, limit) {
        if (!limit) limit = 99;
        var compiledTemplate = Hogan.compile(template);
        return {
            typeaheadSource: {
                callback: callback,
                displayKey: displayKey,
                name: name,
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: "<span class='source-header'>My Places</span>"
                }
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function(d) {
                    var phraseToCheck = d.label ? d.name + d.label : d.name;
                    return matchAnyPartOfWord(phraseToCheck);
                },
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                limit: limit,
                minLength: 0,
                local: local
            })
        };
    };
    o.getRecentSearches = function(name, local, callback, template, displayKey, limit, hasRecents) {
        if (limit === null || limit === undefined) limit = 5;
        var compiledTemplate = Hogan.compile(template);
        return {
            typeaheadSource: {
                callback: callback,
                displayKey: displayKey,
                name: name,
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: hasRecents ? undefined : "<span class='source-header'>Recent searches</span>"
                }
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function(d) {
                    return matchAnyPartOfWord(d.name);
                },
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                limit: limit,
                minLength: 0,
                local: local
            })
        };
    };
    o.getTurnOnOffRecentSearches = function(turnOnNotTurnOff, local, isJpPlacesExtra) {
        var displayStyle = "";
        if (isJpPlacesExtra) {
            displayStyle = 'style = "display:none;"';
        }
        var hoganMarkup = "<span id='{{id}}' " + displayStyle + " class='recent-searches-on-off-footer'><a href='javascript:void(0)'>{{linkText}}</a></span>";
        var compiledTemplate = Hogan.compile(hoganMarkup);
        local[0].dataset = turnOnNotTurnOff ? "recent-searches-footer-on" : "recent-searches-footer-off";
        return {
            typeaheadSource: {
                displayKey: "linkText",
                name: turnOnNotTurnOff ? "recent-searches-footer-on" : "recent-searches-footer-off",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate)
                }
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function() {
                    return [ "" ];
                },
                queryTokenizer: function() {
                    return [ "" ];
                },
                limit: 1,
                minLength: 0,
                local: local
            })
        };
    };
    o.getJourneyPlannerSuggestions = function() {
        var compiledTemplate = Hogan.compile("<div class='mode-icons'>{{#c}}<span class='mode-icon {{.}}-icon'>&nbsp;</span>{{/c}}</div><span id='{{id}}' class='stop-name' role='option'>{{b}}</span>");
        return {
            typeaheadSource: {
                displayKey: "b",
                name: "journey-planner-suggestions",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: "<span class='source-header'>Journey Planner suggestions</span>"
                },
                callback: o.stationsStopsSelectionCallback,
                removeContent: o.stationsStopsRemoveContent
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function(d) {
                    var datum = tfl.autocomplete.tokenize(d, "b");
                    return datum.tokens !== null ? datum.tokens : Bloodhound.tokenizers.whitespace(d.b);
                },
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                limit: o.autocompleteDisplayNumberLimit,
                minLength: 1,
                prefetch: {
                    url: "/cdn/static/feed/stations-list_typeahead.json",
                    ttl: 262974e4
                }
            })
        };
    };
    o.routesSearchFactory = function(modes, callback, regexCharacterString, showRecents, fromFavPanel) {
        var compiledTemplate = Hogan.compile("<span class='mode-icon {{i}}'>&nbsp;<span class='{{f}}'>&nbsp;</span></span><span id='{{id}}' class='stop-name' data-id='{{b}}' role='option'>{{a}}{{#h.length}}<span class='towards-text'>towards {{h}}</span>{{/h.length}}</span>");
        return {
            typeaheadSource: {
                displayKey: "a",
                minLength: 1,
                name: "routes-search",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: "<span class='source-header'>Routes and lines</span>"
                },
                callback: callback
            },
            dataEngine: new Bloodhound({
                datumTokenizer: function(d) {
                    return Bloodhound.tokenizers.whitespace(d.a);
                },
                queryTokenizer: Bloodhound.tokenizers.whitespace,
                limit: o.autocompleteDisplayNumberLimit,
                minLength: 1,
                remote: {
                    url: tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.LinesSearch, modes)),
                    cache: true,
                    replace: function(url, uriEncodedQuery) {
                        var returnUrl = "";
                        if (uriEncodedQuery === tfl.dictionary.CurrentLocationText) {
                            return returnUrl;
                        }
                        if (uriEncodedQuery !== null && uriEncodedQuery.length > 0) {
                            var rgx = new RegExp(regexCharacterString, "g");
                            returnUrl = url.replace("%QUERY", decodeURIComponent(uriEncodedQuery).replace(rgx, ""));
                        }
                        return returnUrl;
                    },
                    filter: function(response) {
                        var results = [];
                        function excludeRecent(searchMatch, showRecents, direction) {
                            return showRecents && tfl.autocomplete.recentMagicSearches.isRecentLine(searchMatch.mode, searchMatch.lineName, direction);
                        }
                        var searchMatches = response.searchMatches;
                        if (searchMatches !== null) {
                            for (var i = 0; i < searchMatches.length; i++) {
                                var searchMatch = searchMatches[i];
                                if (searchMatch.mode === tfl.modeNameTube) {
                                    searchMatch.cssClass = searchMatch.lineName.indexOf(" ") !== -1 ? searchMatch.lineName.substring(0, searchMatch.lineName.indexOf(" ")).toLowerCase() : searchMatch.lineName.toLowerCase();
                                } else {
                                    searchMatch.cssClass = "";
                                }
                                if (searchMatch.mode === tfl.modeNameBus) {
                                    for (var j = 0; j < searchMatch.lineRouteSection.length; j++) {
                                        var addSearchToResults = true;
                                        var lineRouteSection = searchMatch.lineRouteSection[j];
                                        for (var k = 0; k < results.length; k++) {
                                            var result = results[k];
                                            if (result.b === searchMatch.lineId && result.g === lineRouteSection.direction) {
                                                addSearchToResults = false;
                                                break;
                                            }
                                        }
                                        if (searchMatch.lineName.toLowerCase() !== response.input.toLowerCase()) {
                                            addSearchToResults = false;
                                        }
                                        if (addSearchToResults && !excludeRecent(searchMatch, showRecents, lineRouteSection.direction)) {
                                            results.push({
                                                a: searchMatch.lineName,
                                                b: searchMatch.lineId,
                                                c: searchMatch.mode,
                                                f: searchMatch.cssClass,
                                                g: lineRouteSection.direction,
                                                h: [ lineRouteSection.vehicleDestinationText ],
                                                i: tfl.autocomplete.setDisplayIcons(searchMatch.mode, false, null, fromFavPanel),
                                                j: searchMatch.lineName + " towards " + lineRouteSection.vehicleDestinationText,
                                                k: searchMatch.lineId
                                            });
                                        }
                                    }
                                } else {
                                    if (!excludeRecent(searchMatch, showRecents)) {
                                        results.push({
                                            a: searchMatch.lineName + (searchMatch.mode === tfl.modeNameTube ? " line" : ""),
                                            b: searchMatch.lineId,
                                            c: searchMatch.mode,
                                            f: searchMatch.cssClass,
                                            i: tfl.autocomplete.setDisplayIcons(searchMatch.mode, false, null, fromFavPanel)
                                        });
                                    }
                                }
                                results.sort(compareStringLengths);
                                if (results.length >= o.autocompleteDisplayNumberLimit) {
                                    break;
                                }
                            }
                        }
                        return results;
                    }
                }
            })
        };
    };
    o.stopPointsSearchFactory = function(modes, callback, removeContentCallback, includeHubs, oysterOnly, name, busStopsOnly, displaySelectedModesOnly, showFavourites, excludeFavourites, showRecents, fromFavPanel, isSspHome) {
        if (!includeHubs || typeof includeHubs === "string" && includeHubs.toLowerCase() === "false") includeHubs = false;
        if (!isSspHome || typeof isSspHome === "string" && isSspHome.toLowerCase() === "false") isSspHome = false;
        if (!busStopsOnly || typeof busStopsOnly === "string" && busStopsOnly.toLowerCase() === "false") busStopsOnly = false;
        if (!oysterOnly || typeof oysterOnly === "string" && oysterOnly.toLowerCase() === "false") oysterOnly = false;
        if (!displaySelectedModesOnly || typeof displaySelectedModesOnly === "string" && displaySelectedModesOnly.toLowerCase() === "false") displaySelectedModesOnly = false;
        if (!name) name = "stop-points-search";
        if (!includeHubs) {
            displaySelectedModesOnly = true;
        }
        var limitTo = busStopsOnly || modes === "bus" ? 10 : o.autocompleteDisplayNumberLimit;
        var compiledTemplate = Hogan.compile("<div class='mode-icons'>{{#displayIcons}}<span class='mode-icon {{.}}'>&nbsp;</span>{{/displayIcons}}</div><span id='{{id}}' class='stop-name' data-id='{{b}}' role='option'>{{a}}</span>{{#h.length}}<div class='towards-text'>towards {{h}}</div>{{/h.length}}");
        var bloodHound = new Bloodhound({
            datumTokenizer: function(d) {
                return Bloodhound.tokenizers.whitespace(d.value);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: limitTo,
            minLength: 1,
            remote: {
                url: tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.StopPointsSearch, modes, oysterOnly, includeHubs, isSspHome)),
                cache: true,
                replace: function(url, uriEncodedQuery) {
                    var returnUrl = "";
                    if (uriEncodedQuery === tfl.dictionary.CurrentLocationText) {
                        return returnUrl;
                    }
                    if (uriEncodedQuery !== null && uriEncodedQuery.length > 0) {
                        var rgx = new RegExp("[^a-zA-Z0-9 &-/().']", "g");
                        return url.replace("%QUERY", decodeURIComponent(uriEncodedQuery).replace(rgx, ""));
                    }
                    return returnUrl;
                },
                filter: function(response) {
                    function mostModesComparator(a, b) {
                        var modesDiff = b.c.length - a.c.length;
                        if (modesDiff === 0) {
                            return a.a > b.a ? 1 : -1;
                        } else {
                            return modesDiff;
                        }
                    }
                    function isSearchMatchTopLevel(matchedStop, matchedStops) {
                        for (var j = 0; j < matchedStops.length; j++) {
                            if (matchedStops[j].id === matchedStop.parentId) {
                                return false;
                            }
                        }
                        return true;
                    }
                    function checkUnique(current, list) {
                        for (var k = 0; k < list.length; k++) {
                            if (list[k].a.toLowerCase() === current.name.toLowerCase()) {
                                return false;
                            }
                        }
                        return true;
                    }
                    function excludeFavouriteAndRecent(searchMatch, showFavourites, excludeFavourites, showRecents) {
                        return showFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || excludeFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || showRecents && tfl.autocomplete.recentMagicSearches.isRecentPlace(searchMatch.name);
                    }
                    function isHub(naptanId) {
                        return naptanId && naptanId.length && /^HUB/gi.test(naptanId);
                    }
                    var searchMatches = response.matches;
                    if (!searchMatches.length) {
                        tfl.stopPointsSearchPrevent = true;
                    }
                    var results = [];
                    var selectedModes = modes.split(",");
                    if (searchMatches !== null) {
                        for (var i = 0; i < searchMatches.length; i++) {
                            var searchMatch = searchMatches[i];
                            searchMatch.modes = searchMatch.modes.filter(tfl.utils.filterInvalidModes);
                            stationList.push(searchMatch.name);
                            if (!excludeFavouriteAndRecent(searchMatch, showFavourites, excludeFavourites, showRecents)) {
                                var newResult = {
                                    a: searchMatch.name,
                                    b: searchMatch.id,
                                    c: searchMatch.modes,
                                    d: searchMatch.lat,
                                    e: searchMatch.lon,
                                    f: searchMatch.icsId,
                                    g: {
                                        isHubStationStop: isHub(searchMatch.id)
                                    },
                                    h: searchMatch.towards ? [ searchMatch.towards ] : "",
                                    k: searchMatch.id,
                                    displayIcons: tfl.autocomplete.setDisplayIcons(searchMatch.modes, displaySelectedModesOnly, modes, fromFavPanel)
                                };
                                if (busStopsOnly) {
                                    if (searchMatch.modes.length === 1 && searchMatch.modes[0] === tfl.modeNameBus) {
                                        results.push(newResult);
                                    }
                                } else {
                                    results.push(newResult);
                                }
                            }
                            if (results.length >= limitTo) {
                                break;
                            }
                        }
                    }
                    return results;
                }
            }
        });
        return {
            typeaheadSource: {
                displayKey: "a",
                minLength: 1,
                name: name,
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: "<span class='source-header'>Stations, stops and piers</span>"
                },
                callback: callback,
                removeContent: removeContentCallback
            },
            dataEngine: bloodHound
        };
    };
    o.placesExtraSearchFactory = function(callback, searchFilter, showFavourites, excludeFavourites, showRecents, fromFavPanel) {
        var compiledTemplate = Hogan.compile("<div class='mode-icons'><span class='mode-icon {{c}}'>&nbsp;</span></div><span  id='{{id}}' class='stop-name' data-id='{{b}}' role='option'>{{a}}</span>");
        var string = searchFilter.attr("data-datasets");
        var data = $.parseJSON(string);
        var checkString = "placesExtra";
        var poiHeading = "";
        var showPoiHeading = false;
        var bloodHound = new Bloodhound({
            datumTokenizer: function(d) {
                return Bloodhound.tokenizers.whitespace(d.value);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: o.autocompleteDisplayNumberLimit,
            minLength: 5,
            remote: {
                url: tfl.addAppIdAndKey(tfl.api.PlacesExtraSearch),
                cache: true,
                replace: function(url, uriEncodedQuery) {
                    var returnUrl = "";
                    if (uriEncodedQuery === tfl.dictionary.CurrentLocationText) {
                        return returnUrl;
                    }
                    if (uriEncodedQuery !== null && uriEncodedQuery.length > 0) {
                        var rgx = new RegExp("[^a-zA-Z0-9 &-/().']", "g");
                        return url.replace("%QUERY", decodeURIComponent(uriEncodedQuery).replace(rgx, ""));
                    }
                    return returnUrl;
                },
                filter: function(response) {
                    function excludeFavouriteAndRecent(searchMatch, showFavourites, excludeFavourites, showRecents) {
                        return showFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || excludeFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || showRecents && tfl.autocomplete.recentMagicSearches.isRecentPlace(searchMatch.name);
                    }
                    var searchMatches = response.matches;
                    if (!searchMatches.length) {
                        tfl.placesExtraSearchPrevent = true;
                    }
                    var results = [];
                    if (searchMatches !== null) {
                        for (var i = 0; i < searchMatches.length; i++) {
                            var searchMatch = searchMatches[i];
                            if (excludeFavouriteAndRecent(searchMatch, showFavourites, excludeFavourites, showRecents)) {} else if ($.inArray(searchMatch.name, stationList) === -1) {
                                results.push({
                                    a: searchMatch.name,
                                    b: searchMatch.id,
                                    c: tfl.autocomplete.setDisplayIcons(searchMatch.icon, false, null, fromFavPanel),
                                    d: searchMatch.lat,
                                    e: searchMatch.lon,
                                    f: searchMatch.types,
                                    g: searchMatch.boundingBox,
                                    displayIcons: []
                                });
                            }
                            if (results.length >= o.autocompleteDisplayNumberLimit) {
                                break;
                            }
                        }
                    }
                    return results;
                }
            }
        });
        if (data && data.length) {
            for (var i = 0; i < data.length; i++) {
                if (data[i][0] !== checkString) {
                    showPoiHeading = true;
                }
            }
        }
        if (showPoiHeading) {
            poiHeading = "<span class='source-header'>Other points of interest</span>";
        } else {
            poiHeading = "";
        }
        return {
            typeaheadSource: {
                displayKey: "a",
                minLength: 1,
                name: "places-extra-search",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: poiHeading
                },
                callback: callback
            },
            dataEngine: bloodHound
        };
    };
    o.bikePointsSearchFactory = function(callback) {
        var compiledTemplate = Hogan.compile("<div class='mode-icons'><span class='mode-icon bch-docking-station-icon'>&nbsp;</span></div><span id='{{id}}' class='stop-name' data-id='{{b}}' role='option'>{{a}}</span>{{#h.length}}<div class='towards-text'>towards {{h}}</div>{{/h.length}}");
        var bloodHound = new Bloodhound({
            datumTokenizer: function(d) {
                return Bloodhound.tokenizers.whitespace(d.value);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: o.autocompleteDisplayNumberLimit,
            minLength: 2,
            remote: {
                url: tfl.addAppIdAndKey(tfl.api.BikePointSearch),
                cache: true,
                replace: function(url, uriEncodedQuery) {
                    var returnUrl = "";
                    if (uriEncodedQuery === tfl.dictionary.CurrentLocationText) {
                        return returnUrl;
                    }
                    if (uriEncodedQuery !== null && uriEncodedQuery.length > 0) {
                        var rgx = new RegExp("[^a-zA-Z0-9 &-/().']", "g");
                        return url.replace("%QUERY", decodeURIComponent(uriEncodedQuery).replace(rgx, ""));
                    }
                    return returnUrl;
                },
                filter: function(response) {
                    function excludeFavouriteAndRecent(searchMatch) {
                        return tfl.favourites.isFavouritePlace(searchMatch.commonName) || tfl.autocomplete.recentMagicSearches.isRecentPlace(searchMatch.commonName);
                    }
                    if (!response.length) {
                        tfl.bikePointsSearchPrevent = true;
                    }
                    var results = [];
                    if (response !== null) {
                        for (var i = 0; i < response.length; i++) {
                            var searchMatch = response[i];
                            if (excludeFavouriteAndRecent(searchMatch)) {} else {
                                results.push({
                                    a: searchMatch.commonName,
                                    b: searchMatch.id,
                                    d: searchMatch.lat,
                                    e: searchMatch.lon,
                                    f: searchMatch.types
                                });
                            }
                            if (results.length >= o.autocompleteDisplayNumberLimit) {
                                break;
                            }
                        }
                    }
                    return results;
                }
            }
        });
        return {
            typeaheadSource: {
                displayKey: "a",
                minLength: 1,
                name: "bikePoints-search",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: "<span class='source-header'>Santander Cycles docking stations</span>"
                },
                callback: callback
            },
            dataEngine: bloodHound
        };
    };
    o.placesSearchFactory = function(callback) {
        var compiledTemplate = Hogan.compile("<div class='mode-icons'><span class='mode-icon {{c}}'>&nbsp;</span></div><span class='stop-name' data-id='{{b}}'>{{a}}</span>"), taxiRankHeading = "<span class='source-header'>Taxi ranks</span>";
        var bloodHound = new Bloodhound({
            datumTokenizer: function(d) {
                return Bloodhound.tokenizers.whitespace(d.value);
            },
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            limit: o.autocompleteDisplayNumberLimit,
            minLength: 5,
            remote: {
                url: tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.PlacesSearchByCommonName, "TaxiRank")),
                cache: true,
                replace: function(url, uriEncodedQuery) {
                    var returnUrl = "";
                    if (uriEncodedQuery === tfl.dictionary.CurrentLocationText) {
                        return returnUrl;
                    }
                    if (uriEncodedQuery !== null && uriEncodedQuery.length > 0) {
                        var rgx = new RegExp("[^a-zA-Z0-9 &-/().']", "g");
                        return url.replace("%QUERY", decodeURIComponent(uriEncodedQuery).replace(rgx, ""));
                    }
                    return returnUrl;
                },
                filter: function(response) {
                    var searchMatch = null, results = [], searchMatches = response;
                    function excludeFavouriteAndRecent(searchMatch, showFavourites, excludeFavourites, showRecents) {
                        return showFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || excludeFavourites && tfl.favourites.isFavouritePlace(searchMatch.name) || showRecents && tfl.autocomplete.recentMagicSearches.isRecentPlace(searchMatch.name);
                    }
                    if (searchMatches && !searchMatches.length) {
                        tfl.placesSearchPrevent = true;
                    }
                    if (searchMatches !== null) {
                        for (var i = 0; i < searchMatches.length; i++) {
                            searchMatch = searchMatches[i];
                            if ($.inArray(searchMatch.commonName, stationList) === -1) {
                                results.push({
                                    a: searchMatch.commonName,
                                    b: searchMatch.id,
                                    c: "taxi-icon-heading",
                                    d: searchMatch.lat,
                                    e: searchMatch.lon,
                                    f: searchMatch.placeType,
                                    g: null,
                                    displayIcons: []
                                });
                            }
                            if (results.length >= o.autocompleteDisplayNumberLimit) {
                                break;
                            }
                        }
                    }
                    return results;
                }
            }
        });
        return {
            typeaheadSource: {
                displayKey: "a",
                minLength: 1,
                name: "places-search",
                templates: {
                    suggestion: compiledTemplate.render.bind(compiledTemplate),
                    header: taxiRankHeading
                },
                callback: callback
            },
            dataEngine: bloodHound
        };
    };
    function matchAnyPartOfWord(phraseToCheck) {
        var tokens = Bloodhound.tokenizers.whitespace(phraseToCheck);
        $.each(tokens, function(k, v) {
            i = 1;
            while (i < v.length) {
                tokens.push(v.substr(i, v.length));
                i++;
            }
        });
        return tokens;
    }
})(window.tfl.autocomplete.sources = window.tfl.autocomplete.sources || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.autocomplete: loaded");
    o.ClearSearchBox = "clear-search-box";
    o.autocompleteDisplayNumberLimit = 5;
    o.suggestionsCounter = {};
    o.suggestionsDebounceTimeMs = 500;
    var defaultTypeaheadSettings = {
        highlight: true,
        hint: false,
        minLength: 0
    };
    o.setup = function(inputEl, dataSources, typeaheadSettings, binding) {
        if ($("html").hasClass("lt-ie8")) {
            return;
        }
        tfl.logs.create("tfl.autocomplete.setup: started");
        var $el = $(inputEl);
        typeaheadSettings = $.extend({}, defaultTypeaheadSettings, typeaheadSettings);
        var setupSources = [];
        $(dataSources).each(function() {
            if (typeof this === "function") {
                return;
            }
            var typeaheadSource = this.typeaheadSource;
            var dataEngine = this.dataEngine;
            if (dataEngine.remote && dataEngine.remote.filter && dataEngine.remote.replace) {
                var originalReplace = dataEngine.remote.replace;
                var replace = function(url, uriEncodedQuery) {
                    $el.parent(".twitter-typeahead").addClass("downloading");
                    return originalReplace(url, uriEncodedQuery);
                };
                dataEngine.remote.replace = replace;
                var originalFilter = dataEngine.remote.filter;
                var filter = function(response) {
                    var origResponse = originalFilter(response);
                    $el.parent(".twitter-typeahead").removeClass("downloading");
                    return origResponse;
                };
                dataEngine.remote.filter = filter;
            }
            dataEngine.initialize();
            typeaheadSource.source = function(query, cb) {
                return dataEngine.get(query, function(suggestions) {
                    cacheSuggestionCountForQuery(query, suggestions, typeaheadSource.name);
                    o.setSuggestionsText($el);
                    cb(suggestions);
                });
            };
            setupSources.push(typeaheadSource);
        });
        function cacheSuggestionCountForQuery(query, suggestions, dataSetName) {
            var index = o.suggestionsCounter[query] || 0;
            for (var i = 0; i < suggestions.length; i++) {
                suggestions[i].id = dataSetName + "-suggestion-" + index++;
            }
            o.suggestionsCounter[query] = index;
        }
        var feedbackId = $el.attr("id") + "-feedback";
        $el.parent().append("<div role='status' aria-live='polite' class='visually-hidden' id='" + feedbackId + "'></div>");
        var dropdownId = $el.attr("id") + "-dropdown";
        $el.on("typeahead:opened", function() {
            $el.attr("aria-activedescendant", "");
            $el.parent().find(".tt-dropdown-menu").first().attr("id", dropdownId);
            $el.parent().find(".tt-dropdown-menu").first().attr("aria-roledescription", " ");
            $el.attr("aria-expanded", true);
        });
        $el.on("typeahead:closed", function() {
            $el.attr("aria-expanded", false);
            $el.attr("aria-activedescendant", "");
            o.suggestionsCounter = [];
        });
        $el.on("typeahead:cursorchanged", function(q, suggestion) {
            var suggestionId = suggestion.id || $(".tt-cursor").first().find("[role='option']").first().attr("id");
            if (suggestionId) {
                $el.attr("aria-activedescendant", suggestion.id);
            }
        });
        $el.typeahead(typeaheadSettings, setupSources);
        $el.on("keydown.autocomplete", function(e) {
            var dataset = $el.attr("data-dataset-name");
            if (dataset) {
                for (var i = 0; i < setupSources.length; i++) {
                    var dataSource = setupSources[i];
                    if (dataset === dataSource.name) {
                        if (dataSource.keydown) {
                            dataSource.keydown(e, inputEl);
                        }
                        break;
                    }
                }
            }
        });
        $el.on("typeahead:selected typeahead:autocompleted", function(e, datum, dataset, event) {
            $el.trigger("focus");
            if (dataset) {
                ajaxGetPlaceDetail(datum, dataset, function() {
                    for (var i = 0; i < setupSources.length; i++) {
                        var dataSource = setupSources[i];
                        if (dataset === dataSource.name) {
                            $el.attr("stop-category", dataset);
                            if (dataSource.callback) {
                                dataSource.callback(inputEl, datum, dataset, event);
                            }
                            if (dataSource.contextCallback) {
                                dataSource.contextCallback(inputEl, datum, dataset, event);
                            }
                            break;
                        }
                    }
                    $el.attr("data-dataset-name", dataset);
                });
            }
        });
        $el.parent().siblings(tfl.dictionary.RemoveContentClass).bind(o.ClearSearchBox, function() {
            $(this).click();
        });
        if (binding) {
            $el.parent().siblings(tfl.dictionary.RemoveContentClass).click(function() {
                var dataset = $el.attr("data-dataset-name");
                if (dataset) {
                    for (var i = 0; i < setupSources.length; i++) {
                        var dataSource = setupSources[i];
                        if (dataset === dataSource.name) {
                            if (dataSource.removeContent) {
                                dataSource.removeContent($el);
                            }
                            break;
                        }
                    }
                    $el.removeAttr("data-dataset-name");
                }
                $el.typeahead("val", "");
                $el.closest("[class*='search-filter']").next(".disambiguation-in-page").remove();
            });
        }
    };
    function debounce(func, wait, immediate) {
        var timeout;
        return function() {
            var context = this, args = arguments;
            var later = function() {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }
    o.setSuggestionsText = debounce(function(inputEl) {
        var $inputEl = $(inputEl);
        var val = $inputEl.typeahead("val");
        var countForQuery = o.suggestionsCounter[val];
        var feedbackId = "#" + $inputEl.attr("id") + "-feedback";
        var suggestionsText = "";
        if (countForQuery > 1) {
            suggestionsText = "There are " + countForQuery + " suggestions.";
        } else if (countForQuery === 1) {
            suggestionsText = "There is one suggestion.";
        } else {
            suggestionsText = "There are no suggestions.";
        }
        $inputEl.attr("size", countForQuery);
        $(feedbackId).html(suggestionsText);
        for (var otherQuery in o.suggestionsCounter) {
            if (otherQuery != val) {
                o.suggestionsCounter[otherQuery] = 0;
            }
        }
    }, o.suggestionsDebounceTimeMs);
    function ajaxGetPlaceDetail(datum, dataset, callback) {
        if (!(dataset === "stop-points-search" || dataset === "places-extra-search")) {
            callback();
            return;
        }
        var b = datum.b || datum.id, d = datum.d || datum.lat, e = datum.e || datum.lon;
        if (!d && !e) {
            tfl.ajax({
                url: tfl.addAppIdAndKey(tfl.utils.stringFormat("{0}Place/Extra/Details/{1}", tfl.apiUrl, b)),
                dataType: "",
                success: function(result) {
                    datum.lat = result.lat;
                    datum.lon = result.lon;
                    callback();
                }
            });
        } else {
            callback();
        }
    }
    o.tokenize = function(datum, name) {
        var charsThatNeedTokens = [ "'", "(", "&", "-", ")" ];
        var datumNameSplit = name !== null ? datum[name].trim().split(" ") : datum.trim().split(" ");
        var datumTokens = name !== null ? datum[name].trim().split(" ") : datum.trim().split(" ");
        var needsTokens = false;
        for (var b = 0; b < datumNameSplit.length; b++) {
            var datumNamePiece = datumNameSplit[b];
            switch (datumNamePiece.toLowerCase()) {
              case "st":
                datumTokens.push("st.");
                needsTokens = true;
                break;

              case "st.":
                datumTokens.push("st");
                needsTokens = true;
                break;

              case "&":
                datumTokens.push("and");
                needsTokens = true;
                break;

              case "and":
                datumTokens.push("&");
                needsTokens = true;
                break;
            }
            for (var c = 0; c < charsThatNeedTokens.length; c++) {
                var tokenChar = charsThatNeedTokens[c];
                if (datumNamePiece.indexOf(tokenChar) !== -1) {
                    datumTokens.push.apply(datumTokens, datumNamePiece.trim().split(tokenChar));
                    needsTokens = true;
                }
            }
        }
        if (needsTokens && datumTokens.length > 0) {
            var cleanTokens = [];
            for (var d = 0; d < datumTokens.length; d++) {
                var addToken = true;
                var datumToken = datumTokens[d];
                if (datumTokens.length >= d + 1 && datumTokens[d + 1] === "s") {
                    datumToken += "s";
                }
                for (var e = 0; e < cleanTokens.length; e++) {
                    if (datumToken === cleanTokens[e]) {
                        addToken = false;
                        break;
                    }
                }
                if (datumToken !== "s" && datumToken !== "" && addToken) {
                    cleanTokens.push(datumToken);
                }
            }
            if (cleanTokens.length > 0) {
                datum.tokens = cleanTokens;
            }
        } else {
            datum.tokens = datumNameSplit;
        }
        return datum;
    };
    o.shouldInclude = function(searchFilter, searchFor) {
        return searchFilter.data("datasets").join("").toLowerCase().indexOf(searchFor.toLowerCase()) > -1;
    };
    o.addModeIcons = function(place) {
        place.modes = [];
        for (var i = 0, len = place.modeIcons.length; i < len; i++) {
            var mode = place.modeIcons[i].replace("-icon-white", "").replace("-icon", "");
            if (place.modes.indexOf(mode) === -1) {
                place.modes.push(mode);
            }
        }
        return place.modes;
    };
    o.setDisplayIcons = function(modes, displaySelectedModesOnly, displayModes, darkBackground) {
        if (!modes || Array.isArray(modes) && modes.length === 0) return;
        function includeIcon(mode) {
            return !displaySelectedModesOnly || displayModes.indexOf(mode) >= 0;
        }
        function convertToIcon(mode) {
            switch (mode) {
              case "generic":
                return mode + (darkBackground ? "-icon-white" : "-icon");

              case "bikepoint":
                return mode + (darkBackground ? "-station-icon" : "-icon");

              default:
                return mode + (darkBackground ? "-station-icon" : "-icon");
            }
        }
        function convertModeToIcon(mode) {
            if (includeIcon(mode)) {
                return convertToIcon(mode);
            }
        }
        if (!Array.isArray(modes)) {
            return convertModeToIcon(modes);
        }
        var displayIcons = [];
        for (var i = 0, len = modes.length; i < len; i++) {
            var mode = modes[i];
            if (includeIcon(mode)) {
                displayIcons.push(convertToIcon(mode));
            }
        }
        return displayIcons.sort();
    };
})(window.tfl.autocomplete = window.tfl.autocomplete || {});

window.tfl.autocomplete = window.tfl.autocomplete || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.autocomplete.favouritePlaces: loaded");
    var isLoaded = false;
    var favouritePlacesNumberLimit = 99;
    var favourites;
    var places;
    o.getPlaces = function(getItems, modes, searchFilter, busStopsOnly, displaySelectedModesOnly, fromFavPanel) {
        if (!getItems || !modes || !searchFilter) {
            return [];
        }
        var stops = [];
        getFavourites();
        busStopsOnly = busStopsOnly && busStopsOnly === true || false;
        var includeBikepoints = tfl.autocomplete.shouldInclude(searchFilter, "bikepoints");
        var includePointsOfInterest = tfl.autocomplete.shouldInclude(searchFilter, "placesextra");
        if (places) {
            for (var i = 0, len = places.length; i < len; i++) {
                var copiedPlace = jQuery.extend({}, places[i]);
                var addPlace = false;
                if (tfl.utils.intersectionExists(modes, copiedPlace.modes)) {
                    addPlace = true;
                } else if (includeBikepoints && tfl.utils.intersectionExists([ "bch-docking-station", "bikepoint" ], copiedPlace.modes)) {
                    copiedPlace.modes = [ "bch-docking-station" ];
                    addPlace = true;
                } else if (includePointsOfInterest && tfl.utils.intersectionExists(tfl.dictionary.googlePlaceTypes, copiedPlace.modes)) {
                    addPlace = true;
                } else if (includePointsOfInterest && tfl.utils.intersectionExists(tfl.dictionary.googlePlaceTypesExtra, copiedPlace.modes)) {
                    if (copiedPlace.modeIcons) {
                        copiedPlace.modes = tfl.autocomplete.addModeIcons(copiedPlace);
                    } else {
                        copiedPlace.modes = [ "generic" ];
                    }
                    addPlace = true;
                }
                if (addPlace) {
                    copiedPlace.displayIcons = tfl.autocomplete.setDisplayIcons(copiedPlace.modes, displaySelectedModesOnly, modes, fromFavPanel);
                    stops.push(copiedPlace);
                }
            }
        }
        return stops;
    };
    o.reloadPlaces = function() {
        isLoaded = false;
        getFavourites();
    };
    function getFavourites() {
        if (!isLoaded) {
            favourites = tfl.favourites.getFavourites("place");
            places = getPlacesFromStorage();
            isLoaded = true;
        }
        function getPlacesFromStorage() {
            var places = [];
            if (favourites && favourites.length > 0) {
                for (var i = 0, len = favourites.length; i < len; i++) {
                    places.push(mapFavouriteToPlace(favourites[i]));
                }
            }
            return places;
        }
        function mapFavouriteToPlace(favourite) {
            var place = {
                name: favourite.placeName,
                modes: [],
                label: favourite.label ? favourite.label : ""
            };
            if (favourite.hasOwnProperty("props")) {
                if (favourite.props.hasOwnProperty("modes")) {
                    place.modes = favourite.props.modes.split(",");
                    place.modeIcons = place.modes.map(function(mode) {
                        return mode + "-station-icon";
                    });
                }
                if (favourite.props.hasOwnProperty("id")) {
                    place.id = favourite.props.id;
                }
                if (favourite.props.hasOwnProperty("placeId")) {
                    place.icsId = favourite.props.placeId;
                }
                if (favourite.props.hasOwnProperty("lat")) {
                    place.lat = favourite.props.lat;
                }
                if (favourite.props.hasOwnProperty("lon")) {
                    place.lon = favourite.props.lon;
                }
            }
            return place;
        }
    }
})(window.tfl.autocomplete.favouritePlaces = window.tfl.autocomplete.favouritePlaces || {});

window.tfl.autocomplete = window.tfl.autocomplete || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.autocomplete.recentMagicSearches: loaded");
    var isLoaded = false;
    var recentSearchNumberLimit = 5;
    var recentSearchTimeLimit = 262974e4;
    var recents;
    o.usingRecentSearches = tfl.storage.get("usingRecentMagicSearches", true);
    o.useRecentSearches = function(on) {
        o.usingRecentSearches = on;
        tfl.storage.set("usingRecentMagicSearches", o.usingRecentSearches);
        recents = {};
        tfl.storage.set("recentMagicSearches", recents);
        return false;
    };
    o.getPlaces = function(getItems, modes, searchFilter, busStopsOnly, displaySelectedModesOnly, fromFavPanel) {
        if (!o.usingRecentSearches || !getItems || !modes || !searchFilter) {
            tfl.autocomplete.recentPlacesCount = 0;
            return [];
        }
        var stops = [];
        getRecents();
        busStopsOnly = busStopsOnly && busStopsOnly === true || false;
        var includeBikepoints = tfl.autocomplete.shouldInclude(searchFilter, "bikepoints");
        var includePointsOfInterest = tfl.autocomplete.shouldInclude(searchFilter, "placesextra");
        if (recents.stops) {
            for (var i = 0, len = recents.stops.length; i < len; i++) {
                var copiedPlace = jQuery.extend({}, recents.stops[i]);
                var addPlace = false;
                if (tfl.utils.intersectionExists(modes, copiedPlace.modes)) {
                    addPlace = true;
                } else if (includeBikepoints && tfl.utils.intersectionExists([ "bch-docking-station", "bikepoint" ], copiedPlace.modes)) {
                    addPlace = true;
                } else if (includePointsOfInterest && tfl.utils.intersectionExists(tfl.dictionary.googlePlaceTypes, copiedPlace.modes)) {
                    addPlace = true;
                } else if (includePointsOfInterest && tfl.utils.intersectionExists(tfl.dictionary.googlePlaceTypesExtra, copiedPlace.modes)) {
                    if (copiedPlace.modeIcons) {
                        copiedPlace.modes = tfl.autocomplete.addModeIcons(copiedPlace);
                    } else {
                        copiedPlace.modes = [ "generic" ];
                    }
                    addPlace = true;
                }
                if (addPlace) {
                    copiedPlace.displayIcons = tfl.autocomplete.setDisplayIcons(copiedPlace.modes, displaySelectedModesOnly, modes, fromFavPanel);
                    stops.push(copiedPlace);
                }
            }
        }
        return stops;
    };
    o.getLines = function(getItems, modes) {
        if (!o.usingRecentSearches || !getItems) {
            return [];
        }
        var lines = [];
        getRecents();
        if (recents.lines) {
            for (var lineProperty in recents.lines) {
                if (recents.lines.hasOwnProperty(lineProperty) && modes.indexOf(lineProperty) >= 0) {
                    for (var i = 0, ilen = recents.lines[lineProperty].length; i < ilen; i++) {
                        lines.push(recents.lines[lineProperty][i]);
                    }
                }
            }
        }
        return lines;
    };
    o.saveSearch = function(newName, newId, newModes, newType, lat, lon, cssClass, direction, destination, lowestLevel, icsId, g, stopOrLineId) {
        if (!o.usingRecentSearches || !newName) {
            return true;
        }
        tfl.logs.create("tfl.autocomplete.recentMagicSearches.saveSearch: initialised");
        getRecents();
        var search = createSearch(newName, newId, newModes, newType, lat, lon, cssClass, direction, destination, lowestLevel, icsId, g, stopOrLineId);
        if (search.type === "lines") {
            setDefaultLines(search.mode);
            removeExistingRecent(recents[search.type][search.mode], search);
            if (!excludeFavouriteLine(search)) {
                recents[search.type][search.mode].splice(0, 0, search);
                if (recents[search.type][search.mode].length > o.recentSearchNumberLimit) {
                    recents[search.type][search.mode].length = o.recentSearchNumberLimit;
                }
            }
        } else if (search.type === "stops") {
            setDefaultStops();
            removeExistingRecent(recents[search.type], search);
            if (!excludeFavouriteStop(search)) {
                recents[search.type].splice(0, 0, search);
                if (recents[search.type].length > o.recentSearchNumberLimit) {
                    recents[search.type].length = o.recentSearchNumberLimit;
                }
            }
        }
        if (window.hasCookieBot() && Cookiebot.consent.preferences) {
            tfl.storage.set("recentMagicSearches", recents);
        }
        return true;
        function createSearch(name, id, modes, type, lat, lon, cssClass, direction, destination, lowestLevel, icsId, g, stopOrLineId) {
            if (typeof modes === "string" && modes) {
                modes = jQuery.parseJSON(modes);
            }
            if (!modes) modes = [];
            var search = {
                lastSearchDate: new Date().getTime(),
                name: name,
                id: id ? id : "",
                type: type,
                destination: destination ? destination : ""
            };
            if (type === "lines") {
                search.mode = modes[0].toString();
                search.cssClass = cssClass ? cssClass : "";
                search.direction = direction ? direction : "";
                search.lineId = stopOrLineId ? stopOrLineId : "";
            } else if (type === "stops") {
                search.modes = modes;
                search.lat = lat;
                search.lon = lon;
                search.lowestLevel = lowestLevel ? lowestLevel : false;
                search.icsId = icsId ? icsId : "";
                search.g = {
                    isHubStationStop: g && g.isHubStationStop
                };
                search.stopId = stopOrLineId ? stopOrLineId : "";
            }
            return search;
        }
        function setDefaultLines(mode) {
            if (!recents.hasOwnProperty("lines")) {
                recents.lines = {};
            }
            if (!recents.lines.hasOwnProperty(mode)) {
                recents.lines[mode] = [];
            }
        }
        function setDefaultStops() {
            if (!recents.hasOwnProperty("stops")) {
                recents.stops = [];
            }
        }
        function excludeFavouriteLine(search) {
            return false;
        }
        function excludeFavouriteStop(search) {
            return tfl.favourites.isFavouritePlace(search.name);
        }
    };
    o.geolocateMe = function(inputEl, callback) {
        var geolocationError = function(msg) {
            $(".geolocation-error").text(msg).removeClass("hidden");
        };
        tfl.logs.create("tfl.autocomplete.recentMagicSearches.geolocateMe: initialised");
        var el = $(inputEl);
        el.typeahead("val", "");
        el.attr("placeholder", "Finding address...");
        var success = function(position) {
            if (position.coords && position.coords.accuracy && position.coords.accuracy > 1e6) {
                tfl.logs.create("tfl.journeyPlanner.searchForm.geolocate me: ERROR: inaccuracy too high: " + position.coords.accuracy + "m");
                geolocationError("We cannot find your current location. Please try again");
                return;
            }
            el.val(position.coords.longitude + "," + position.coords.latitude);
            $(inputEl).append("<input type='hidden' id='lat' name='lat' value='" + position.coords.latitude + "' />");
            $(inputEl).append("<input type='hidden' id='lon' name='lon' value='" + position.coords.longitude + "' />");
            if (callback) {
                callback();
            }
        };
        var failure = function(err) {
            if (err.code) {
                if (err.code === 1) {
                    tfl.logs.create("tfl.journeyPlanner.searchForm.geolocateMe: ERROR: permission denied");
                    geolocationError("Permission from browser needed before finding your location");
                } else if (err.code === 2) {
                    tfl.logs.create("tfl.journeyPlanner.searchForm.geolocateMe: ERROR: position unavailable");
                    geolocationError("We cannot find your current location. Please try again");
                } else if (err.code === 3) {
                    tfl.logs.create("tfl.journeyPlanner.searchForm.geolocateMe: ERROR: timeout");
                    geolocationError("We cannot find your current location. Please try again");
                }
            } else {
                geolocationError("We cannot find your current location. Please try again");
            }
        };
        try {
            navigator.geolocation.getCurrentPosition(success, failure);
        } catch (e) {
            geolocationError("Your device does not support the location feature");
        }
    };
    o.removePlaceByKey = function(placeKey) {
        if (!o.usingRecentSearches || !placeKey) {
            return true;
        }
        tfl.logs.create("tfl.autocomplete.recentMagicSearches: removePlaceByKey");
        getRecents();
        var place = {
            id: "",
            name: placeKey
        };
        removeExistingRecent(recents.stops, place);
        tfl.storage.set("recentMagicSearches", recents);
    };
    o.isRecentPlace = function(placeName) {
        if (!placeName) {
            return false;
        }
        getRecents();
        var places = recents.hasOwnProperty("stops") ? recents.stops : [];
        return places.length > 0 && places.filter(filterByNameMatch(placeName)).length > 0;
        function filterByNameMatch(name) {
            return function(obj) {
                return obj.name === name;
            };
        }
    };
    o.isRecentLine = function(mode, lineName, direction) {
        if (!mode || !lineName) {
            return false;
        }
        getRecents();
        var lines = recents.hasOwnProperty("lines") ? recents.lines : [];
        var modeLines = lines.hasOwnProperty(mode) ? lines[mode] : [];
        if (direction) {
            return modeLines.length > 0 && modeLines.filter(filterByNameDirectionMatch(lineName, direction)).length > 0;
        } else {
            return modeLines.length > 0 && modeLines.filter(filterByNameMatch(lineName)).length > 0;
        }
        function filterByNameMatch(name) {
            return function(obj) {
                return obj.name === name;
            };
        }
        function filterByNameDirectionMatch(name, direction) {
            return function(obj) {
                return obj.name === name && obj.direction === direction;
            };
        }
    };
    function setPreferences() {
        if (window.hasCookieBot() && Cookiebot.hasResponse) {
            if (Cookiebot.consent.preferences) {
                recents = tfl.storage.get("recentMagicSearches", {});
                tfl.storage.set("usingRecentJourneys", true);
                return;
            }
        }
        tfl.storage.set("usingRecentJourneys", false);
        recents = tfl.storage.get("", {});
    }
    function getRecents() {
        if (!isLoaded) {
            setPreferences();
            removeOldRecents();
            isLoaded = true;
        }
        function removeOldRecents() {
            var timeNow = new Date().getTime();
            var itemRemoved;
            for (var type in recents) {
                if (recents.hasOwnProperty(type)) {
                    for (var mode in recents[type]) {
                        if (recents[type].hasOwnProperty(mode)) {
                            for (var i = 0; i < recents[type][mode].length; i++) {
                                if (recents[type][mode][i] !== undefined) {
                                    var item = recents[type][mode][i];
                                    if (!item.hasOwnProperty("lastSearchDate") || item.lastSearchDate < timeNow - o.recentSearchTimeLimit) {
                                        tfl.logs.create("tfl.autocomplete.recentMagicSearches: removing old searches");
                                        recents[type][mode].splice(i, 1);
                                        itemRemoved = true;
                                    }
                                }
                            }
                        }
                    }
                }
            }
            if (itemRemoved) tfl.storage.set("recentMagicSearches", recents);
        }
    }
    function removeExistingRecent(existing, search) {
        if (existing && search) {
            for (var b = 0, len = existing.length; b < len; b++) {
                var recent = existing[b];
                if (recent.name.toLowerCase() === search.name.toLowerCase() || recent.id.toLowerCase() === search.id.toLowerCase()) {
                    if (!recent.direction || recent.direction.toLowerCase() === search.direction.toLowerCase()) {
                        existing.splice(b, 1);
                        break;
                    }
                }
            }
        }
    }
})(window.tfl.autocomplete.recentMagicSearches = window.tfl.autocomplete.recentMagicSearches || {});

(function($, window, document, undefined) {
    var pluginName = "LightBox", defaults = {
        contentClass: "content",
        closeButtonClass: "close-light-box",
        lightBoxId: "light-box",
        responsiveClass: "responsive",
        dataAttr: "data-pull-content"
    };
    function LightBox(element, options) {
        this.element = element;
        this.settings = $.extend({}, defaults, options);
        this._defaults = defaults;
        this._name = pluginName;
        this.init();
    }
    $.extend(LightBox.prototype, {
        init: function() {
            var lightboxPrototype = this;
            this.$el = $(lightboxPrototype.element);
            this.$lightbox = $("#" + lightboxPrototype.settings.lightBoxId);
            if (this.$lightbox.length === 0) {
                this.$lightbox = $(window.hoganTemplates.lightBox.render());
                $(document.body).append(this.$lightbox);
            }
            this.$closeLink = lightboxPrototype.$lightbox.find("." + lightboxPrototype.settings.closeButtonClass);
            this.$contentWrap = lightboxPrototype.$lightbox.find("." + lightboxPrototype.settings.contentClass);
            lightboxPrototype.$el.on("click", function(e) {
                lightboxPrototype.pullContentHandler(e);
            });
            lightboxPrototype.$closeLink.on("click.lightBox", function() {
                lightboxPrototype.hideLightbox();
            });
            tfl.logs.create("LightBox: initialised");
            if (document.addEventListener) {
                document.addEventListener("focus", function(event) {
                    if (lightboxPrototype.$lightbox.hasClass("active") && !lightboxPrototype.$lightbox[0].contains(event.target)) {
                        event.stopPropagation();
                        lightboxPrototype.$lightbox.focus();
                    }
                }, true);
            }
        },
        pullContentHandler: function(event) {
            event.preventDefault();
            var lightboxPrototype = this;
            $(this.element).attr("disabled", true);
            this.contentSelector = lightboxPrototype.$el.attr(lightboxPrototype.settings.dataAttr);
            this.url = lightboxPrototype.$el.attr("href");
            var lightBoxType = lightboxPrototype.$el.attr("data-light-box-type");
            var lightBoxMinWidth = parseInt(lightboxPrototype.$el.attr("data-light-box-min-width"), 10);
            var responsive = lightboxPrototype.$el.data("responsive");
            tfl.logs.create("tfl.navigation.pullContent: Clicked a pull link for " + lightboxPrototype.url);
            if (!isNaN(lightBoxMinWidth) && lightBoxMinWidth > $(window).width()) {
                window.open(lightboxPrototype.url, "_blank");
                return false;
            }
            lightBoxType = lightBoxType === undefined ? "alert" : lightBoxType;
            lightboxPrototype.$lightbox.attr("data-type", lightBoxType);
            if (lightboxPrototype.url.length > 0) {
                if (lightBoxType === "image") {
                    var img = new Image();
                    img.src = lightboxPrototype.url;
                    img.alt = lightboxPrototype.$el.text();
                    lightboxPrototype.$contentWrap.append(img);
                    lightboxPrototype.$lightbox.addClass("active");
                } else {
                    tfl.ajax({
                        url: this.url,
                        success: function(data) {
                            lightboxPrototype.loadPopupContentSuccess(data);
                        },
                        dataType: "text"
                    });
                }
                if (responsive) {
                    var windowHeight = $(window).height(), idealHeight = windowHeight * .9, lightBoxContentWrap = lightboxPrototype.$lightbox.find(".content-wrap");
                    lightBoxContentWrap.addClass(lightboxPrototype.settings.responsiveClass);
                    lightboxPrototype.$contentWrap.height(idealHeight);
                }
            }
        },
        loadPopupContentSuccess: function(response) {
            var lightboxPrototype = this;
            var html = $(response);
            var tabbables;
            if (lightboxPrototype.contentSelector.length === 0) {
                document.location.href = lightboxPrototype.url;
                return true;
            }
            $.each(html.find($.trim(lightboxPrototype.contentSelector)), function(index, element) {
                lightboxPrototype.$contentWrap.append($(element));
            });
            tabbables = lightboxPrototype.$contentWrap.find(":tabbable");
            $(tabbables[tabbables.length - 1]).addClass("light-box-last-tab-target").attr("data-jumpto", ".close-light-box");
            lightboxPrototype.showLightbox();
        },
        destroy: function() {
            $(this.element).attr("disabled", false);
            $("#" + this.settings.lightBoxId).remove();
            delete this.$el.data()["plugin_" + this._name];
            return this;
        },
        showLightbox: function() {
            var lightboxPrototype = this;
            lightboxPrototype.$lightbox.addClass("active");
            lightboxPrototype.$closeLink.focus();
            $("#mainnav,#full-width-content,#footer").attr("aria-hidden", true);
            $(document).on("keyup.lightBox", function(e) {
                if (e.keyCode === 27) {
                    lightboxPrototype.$closeLink.click();
                }
            });
        },
        hideLightbox: function() {
            this.$contentWrap.empty();
            this.$lightbox.removeClass("active");
            this.$el.focus();
            $(this.element).attr("disabled", false);
            $(document).off("keyup.lightBox");
            $("#mainnav,#full-width-content,#footer").attr("aria-hidden", false);
        }
    });
    $.fn[pluginName] = function(options) {
        this.each(function() {
            if (!$.data(this, "plugin_" + pluginName)) {
                $.data(this, "plugin_" + pluginName, new LightBox(this, options));
            }
        });
        return this;
    };
})(jQuery, window, document);

$("[data-pull-content]").LightBox();

(function($) {
    "use strict";
    var version = "2.1.6";
    $.fn.cycle = function(options) {
        var o;
        if (this.length === 0 && !$.isReady) {
            o = {
                s: this.selector,
                c: this.context
            };
            $.fn.cycle.log("requeuing slideshow (dom not ready)");
            $(function() {
                $(o.s, o.c).cycle(options);
            });
            return this;
        }
        return this.each(function() {
            var data, opts, shortName, val;
            var container = $(this);
            var log = $.fn.cycle.log;
            if (container.data("cycle.opts")) return;
            if (container.data("cycle-log") === false || options && options.log === false || opts && opts.log === false) {
                log = $.noop;
            }
            log("--c2 init--");
            data = container.data();
            for (var p in data) {
                if (data.hasOwnProperty(p) && /^cycle[A-Z]+/.test(p)) {
                    val = data[p];
                    shortName = p.match(/^cycle(.*)/)[1].replace(/^[A-Z]/, lowerCase);
                    log(shortName + ":", val, "(" + typeof val + ")");
                    data[shortName] = val;
                }
            }
            opts = $.extend({}, $.fn.cycle.defaults, data, options || {});
            opts.timeoutId = 0;
            opts.paused = opts.paused || false;
            opts.container = container;
            opts._maxZ = opts.maxZ;
            opts.API = $.extend({
                _container: container
            }, $.fn.cycle.API);
            opts.API.log = log;
            opts.API.trigger = function(eventName, args) {
                opts.container.trigger(eventName, args);
                return opts.API;
            };
            container.data("cycle.opts", opts);
            container.data("cycle.API", opts.API);
            opts.API.trigger("cycle-bootstrap", [ opts, opts.API ]);
            opts.API.addInitialSlides();
            opts.API.preInitSlideshow();
            if (opts.slides.length) opts.API.initSlideshow();
        });
    };
    $.fn.cycle.API = {
        opts: function() {
            return this._container.data("cycle.opts");
        },
        addInitialSlides: function() {
            var opts = this.opts();
            var slides = opts.slides;
            opts.slideCount = 0;
            opts.slides = $();
            slides = slides.jquery ? slides : opts.container.find(slides);
            if (opts.random) {
                slides.sort(function() {
                    return Math.random() - .5;
                });
            }
            opts.API.add(slides);
        },
        preInitSlideshow: function() {
            var opts = this.opts();
            opts.API.trigger("cycle-pre-initialize", [ opts ]);
            var tx = $.fn.cycle.transitions[opts.fx];
            if (tx && $.isFunction(tx.preInit)) tx.preInit(opts);
            opts._preInitialized = true;
        },
        postInitSlideshow: function() {
            var opts = this.opts();
            opts.API.trigger("cycle-post-initialize", [ opts ]);
            var tx = $.fn.cycle.transitions[opts.fx];
            if (tx && $.isFunction(tx.postInit)) tx.postInit(opts);
        },
        initSlideshow: function() {
            var opts = this.opts();
            var pauseObj = opts.container;
            var slideOpts;
            opts.API.calcFirstSlide();
            if (opts.container.css("position") == "static") opts.container.css("position", "relative");
            $(opts.slides[opts.currSlide]).css({
                opacity: 1,
                display: "block",
                visibility: "visible"
            });
            opts.API.stackSlides(opts.slides[opts.currSlide], opts.slides[opts.nextSlide], !opts.reverse);
            if (opts.pauseOnHover) {
                if (opts.pauseOnHover !== true) pauseObj = $(opts.pauseOnHover);
                pauseObj.hover(function() {
                    opts.API.pause(true);
                }, function() {
                    opts.API.resume(true);
                });
            }
            if (opts.timeout) {
                slideOpts = opts.API.getSlideOpts(opts.currSlide);
                opts.API.queueTransition(slideOpts, slideOpts.timeout + opts.delay);
            }
            opts._initialized = true;
            opts.API.updateView(true);
            opts.API.trigger("cycle-initialized", [ opts ]);
            opts.API.postInitSlideshow();
        },
        pause: function(hover) {
            var opts = this.opts(), slideOpts = opts.API.getSlideOpts(), alreadyPaused = opts.hoverPaused || opts.paused;
            if (hover) opts.hoverPaused = true; else opts.paused = true;
            if (!alreadyPaused) {
                opts.container.addClass("cycle-paused");
                opts.API.trigger("cycle-paused", [ opts ]).log("cycle-paused");
                if (slideOpts.timeout) {
                    clearTimeout(opts.timeoutId);
                    opts.timeoutId = 0;
                    opts._remainingTimeout -= $.now() - opts._lastQueue;
                    if (opts._remainingTimeout < 0 || isNaN(opts._remainingTimeout)) opts._remainingTimeout = undefined;
                }
            }
        },
        resume: function(hover) {
            var opts = this.opts(), alreadyResumed = !opts.hoverPaused && !opts.paused, remaining;
            if (hover) opts.hoverPaused = false; else opts.paused = false;
            if (!alreadyResumed) {
                opts.container.removeClass("cycle-paused");
                if (opts.slides.filter(":animated").length === 0) opts.API.queueTransition(opts.API.getSlideOpts(), opts._remainingTimeout);
                opts.API.trigger("cycle-resumed", [ opts, opts._remainingTimeout ]).log("cycle-resumed");
            }
        },
        add: function(slides, prepend) {
            var opts = this.opts();
            var oldSlideCount = opts.slideCount;
            var startSlideshow = false;
            var len;
            if ($.type(slides) == "string") slides = $.trim(slides);
            $(slides).each(function(i) {
                var slideOpts;
                var slide = $(this);
                if (prepend) opts.container.prepend(slide); else opts.container.append(slide);
                opts.slideCount++;
                slideOpts = opts.API.buildSlideOpts(slide);
                if (prepend) opts.slides = $(slide).add(opts.slides); else opts.slides = opts.slides.add(slide);
                opts.API.initSlide(slideOpts, slide, --opts._maxZ);
                slide.data("cycle.opts", slideOpts);
                opts.API.trigger("cycle-slide-added", [ opts, slideOpts, slide ]);
            });
            opts.API.updateView(true);
            startSlideshow = opts._preInitialized && (oldSlideCount < 2 && opts.slideCount >= 1);
            if (startSlideshow) {
                if (!opts._initialized) opts.API.initSlideshow(); else if (opts.timeout) {
                    len = opts.slides.length;
                    opts.nextSlide = opts.reverse ? len - 1 : 1;
                    if (!opts.timeoutId) {
                        opts.API.queueTransition(opts);
                    }
                }
            }
        },
        calcFirstSlide: function() {
            var opts = this.opts();
            var firstSlideIndex;
            firstSlideIndex = parseInt(opts.startingSlide || 0, 10);
            if (firstSlideIndex >= opts.slides.length || firstSlideIndex < 0) firstSlideIndex = 0;
            opts.currSlide = firstSlideIndex;
            if (opts.reverse) {
                opts.nextSlide = firstSlideIndex - 1;
                if (opts.nextSlide < 0) opts.nextSlide = opts.slides.length - 1;
            } else {
                opts.nextSlide = firstSlideIndex + 1;
                if (opts.nextSlide == opts.slides.length) opts.nextSlide = 0;
            }
        },
        calcNextSlide: function() {
            var opts = this.opts();
            var roll;
            if (opts.reverse) {
                roll = opts.nextSlide - 1 < 0;
                opts.nextSlide = roll ? opts.slideCount - 1 : opts.nextSlide - 1;
                opts.currSlide = roll ? 0 : opts.nextSlide + 1;
            } else {
                roll = opts.nextSlide + 1 == opts.slides.length;
                opts.nextSlide = roll ? 0 : opts.nextSlide + 1;
                opts.currSlide = roll ? opts.slides.length - 1 : opts.nextSlide - 1;
            }
        },
        calcTx: function(slideOpts, manual) {
            var opts = slideOpts;
            var tx;
            if (opts._tempFx) tx = $.fn.cycle.transitions[opts._tempFx]; else if (manual && opts.manualFx) tx = $.fn.cycle.transitions[opts.manualFx];
            if (!tx) tx = $.fn.cycle.transitions[opts.fx];
            opts._tempFx = null;
            this.opts()._tempFx = null;
            if (!tx) {
                tx = $.fn.cycle.transitions.fade;
                opts.API.log('Transition "' + opts.fx + '" not found.  Using fade.');
            }
            return tx;
        },
        prepareTx: function(manual, fwd) {
            var opts = this.opts();
            var after, curr, next, slideOpts, tx;
            if (opts.slideCount < 2) {
                opts.timeoutId = 0;
                return;
            }
            if (manual && (!opts.busy || opts.manualTrump)) {
                opts.API.stopTransition();
                opts.busy = false;
                clearTimeout(opts.timeoutId);
                opts.timeoutId = 0;
            }
            if (opts.busy) return;
            if (opts.timeoutId === 0 && !manual) return;
            curr = opts.slides[opts.currSlide];
            next = opts.slides[opts.nextSlide];
            slideOpts = opts.API.getSlideOpts(opts.nextSlide);
            tx = opts.API.calcTx(slideOpts, manual);
            opts._tx = tx;
            if (manual && slideOpts.manualSpeed !== undefined) slideOpts.speed = slideOpts.manualSpeed;
            if (opts.nextSlide != opts.currSlide && (manual || !opts.paused && !opts.hoverPaused && opts.timeout)) {
                opts.API.trigger("cycle-before", [ slideOpts, curr, next, fwd ]);
                if (tx.before) tx.before(slideOpts, curr, next, fwd);
                after = function() {
                    opts.busy = false;
                    if (!opts.container.data("cycle.opts")) return;
                    if (tx.after) tx.after(slideOpts, curr, next, fwd);
                    opts.API.trigger("cycle-after", [ slideOpts, curr, next, fwd ]);
                    opts.API.queueTransition(slideOpts);
                    opts.API.updateView(true);
                };
                opts.busy = true;
                if (tx.transition) tx.transition(slideOpts, curr, next, fwd, after); else opts.API.doTransition(slideOpts, curr, next, fwd, after);
                opts.API.calcNextSlide();
                opts.API.updateView();
            } else {
                opts.API.queueTransition(slideOpts);
            }
        },
        doTransition: function(slideOpts, currEl, nextEl, fwd, callback) {
            var opts = slideOpts;
            var curr = $(currEl), next = $(nextEl);
            var fn = function() {
                next.animate(opts.animIn || {
                    opacity: 1
                }, opts.speed, opts.easeIn || opts.easing, callback);
            };
            next.css(opts.cssBefore || {});
            curr.animate(opts.animOut || {}, opts.speed, opts.easeOut || opts.easing, function() {
                curr.css(opts.cssAfter || {});
                if (!opts.sync) {
                    fn();
                }
            });
            if (opts.sync) {
                fn();
            }
        },
        queueTransition: function(slideOpts, specificTimeout) {
            var opts = this.opts();
            var timeout = specificTimeout !== undefined ? specificTimeout : slideOpts.timeout;
            if (opts.nextSlide === 0 && --opts.loop === 0) {
                opts.API.log("terminating; loop=0");
                opts.timeout = 0;
                if (timeout) {
                    setTimeout(function() {
                        opts.API.trigger("cycle-finished", [ opts ]);
                    }, timeout);
                } else {
                    opts.API.trigger("cycle-finished", [ opts ]);
                }
                opts.nextSlide = opts.currSlide;
                return;
            }
            if (opts.continueAuto !== undefined) {
                if (opts.continueAuto === false || $.isFunction(opts.continueAuto) && opts.continueAuto() === false) {
                    opts.API.log("terminating automatic transitions");
                    opts.timeout = 0;
                    if (opts.timeoutId) clearTimeout(opts.timeoutId);
                    return;
                }
            }
            if (timeout) {
                opts._lastQueue = $.now();
                if (specificTimeout === undefined) opts._remainingTimeout = slideOpts.timeout;
                if (!opts.paused && !opts.hoverPaused) {
                    opts.timeoutId = setTimeout(function() {
                        opts.API.prepareTx(false, !opts.reverse);
                    }, timeout);
                }
            }
        },
        stopTransition: function() {
            var opts = this.opts();
            if (opts.slides.filter(":animated").length) {
                opts.slides.stop(false, true);
                opts.API.trigger("cycle-transition-stopped", [ opts ]);
            }
            if (opts._tx && opts._tx.stopTransition) opts._tx.stopTransition(opts);
        },
        advanceSlide: function(val) {
            var opts = this.opts();
            clearTimeout(opts.timeoutId);
            opts.timeoutId = 0;
            opts.nextSlide = opts.currSlide + val;
            if (opts.nextSlide < 0) opts.nextSlide = opts.slides.length - 1; else if (opts.nextSlide >= opts.slides.length) opts.nextSlide = 0;
            opts.API.prepareTx(true, val >= 0);
            return false;
        },
        buildSlideOpts: function(slide) {
            var opts = this.opts();
            var val, shortName;
            var slideOpts = slide.data() || {};
            for (var p in slideOpts) {
                if (slideOpts.hasOwnProperty(p) && /^cycle[A-Z]+/.test(p)) {
                    val = slideOpts[p];
                    shortName = p.match(/^cycle(.*)/)[1].replace(/^[A-Z]/, lowerCase);
                    opts.API.log("[" + (opts.slideCount - 1) + "]", shortName + ":", val, "(" + typeof val + ")");
                    slideOpts[shortName] = val;
                }
            }
            slideOpts = $.extend({}, $.fn.cycle.defaults, opts, slideOpts);
            slideOpts.slideNum = opts.slideCount;
            try {
                delete slideOpts.API;
                delete slideOpts.slideCount;
                delete slideOpts.currSlide;
                delete slideOpts.nextSlide;
                delete slideOpts.slides;
            } catch (e) {}
            return slideOpts;
        },
        getSlideOpts: function(index) {
            var opts = this.opts();
            if (index === undefined) index = opts.currSlide;
            var slide = opts.slides[index];
            var slideOpts = $(slide).data("cycle.opts");
            return $.extend({}, opts, slideOpts);
        },
        initSlide: function(slideOpts, slide, suggestedZindex) {
            var opts = this.opts();
            slide.css(slideOpts.slideCss || {});
            if (suggestedZindex > 0) slide.css("zIndex", suggestedZindex);
            if (isNaN(slideOpts.speed)) slideOpts.speed = $.fx.speeds[slideOpts.speed] || $.fx.speeds._default;
            if (!slideOpts.sync) slideOpts.speed = slideOpts.speed / 2;
            slide.addClass(opts.slideClass);
        },
        updateView: function(isAfter, isDuring, forceEvent) {
            var opts = this.opts();
            if (!opts._initialized) return;
            var slideOpts = opts.API.getSlideOpts();
            var currSlide = opts.slides[opts.currSlide];
            if (!isAfter && isDuring !== true) {
                opts.API.trigger("cycle-update-view-before", [ opts, slideOpts, currSlide ]);
                if (opts.updateView < 0) return;
            }
            if (opts.slideActiveClass) {
                opts.slides.removeClass(opts.slideActiveClass).eq(opts.currSlide).addClass(opts.slideActiveClass);
            }
            if (isAfter && opts.hideNonActive) opts.slides.filter(":not(." + opts.slideActiveClass + ")").css("visibility", "hidden");
            if (opts.updateView === 0) {
                setTimeout(function() {
                    opts.API.trigger("cycle-update-view", [ opts, slideOpts, currSlide, isAfter ]);
                }, slideOpts.speed / (opts.sync ? 2 : 1));
            }
            if (opts.updateView !== 0) opts.API.trigger("cycle-update-view", [ opts, slideOpts, currSlide, isAfter ]);
            if (isAfter) opts.API.trigger("cycle-update-view-after", [ opts, slideOpts, currSlide ]);
        },
        getComponent: function(name) {
            var opts = this.opts();
            var selector = opts[name];
            if (typeof selector === "string") {
                return /^\s*[\>|\+|~]/.test(selector) ? opts.container.find(selector) : $(selector);
            }
            if (selector.jquery) return selector;
            return $(selector);
        },
        stackSlides: function(curr, next, fwd) {
            var opts = this.opts();
            if (!curr) {
                curr = opts.slides[opts.currSlide];
                next = opts.slides[opts.nextSlide];
                fwd = !opts.reverse;
            }
            $(curr).css("zIndex", opts.maxZ);
            var i;
            var z = opts.maxZ - 2;
            var len = opts.slideCount;
            if (fwd) {
                for (i = opts.currSlide + 1; i < len; i++) $(opts.slides[i]).css("zIndex", z--);
                for (i = 0; i < opts.currSlide; i++) $(opts.slides[i]).css("zIndex", z--);
            } else {
                for (i = opts.currSlide - 1; i >= 0; i--) $(opts.slides[i]).css("zIndex", z--);
                for (i = len - 1; i > opts.currSlide; i--) $(opts.slides[i]).css("zIndex", z--);
            }
            $(next).css("zIndex", opts.maxZ - 1);
        },
        getSlideIndex: function(el) {
            return this.opts().slides.index(el);
        }
    };
    $.fn.cycle.log = function log() {
        if (window.console && console.log) console.log("[cycle2] " + Array.prototype.join.call(arguments, " "));
    };
    $.fn.cycle.version = function() {
        return "Cycle2: " + version;
    };
    function lowerCase(s) {
        return (s || "").toLowerCase();
    }
    $.fn.cycle.transitions = {
        custom: {},
        none: {
            before: function(opts, curr, next, fwd) {
                opts.API.stackSlides(next, curr, fwd);
                opts.cssBefore = {
                    opacity: 1,
                    visibility: "visible",
                    display: "block"
                };
            }
        },
        fade: {
            before: function(opts, curr, next, fwd) {
                var css = opts.API.getSlideOpts(opts.nextSlide).slideCss || {};
                opts.API.stackSlides(curr, next, fwd);
                opts.cssBefore = $.extend(css, {
                    opacity: 0,
                    visibility: "visible",
                    display: "block"
                });
                opts.animIn = {
                    opacity: 1
                };
                opts.animOut = {
                    opacity: 0
                };
            }
        },
        fadeout: {
            before: function(opts, curr, next, fwd) {
                var css = opts.API.getSlideOpts(opts.nextSlide).slideCss || {};
                opts.API.stackSlides(curr, next, fwd);
                opts.cssBefore = $.extend(css, {
                    opacity: 1,
                    visibility: "visible",
                    display: "block"
                });
                opts.animOut = {
                    opacity: 0
                };
            }
        },
        scrollHorz: {
            before: function(opts, curr, next, fwd) {
                opts.API.stackSlides(curr, next, fwd);
                var w = opts.container.css("overflow", "hidden").width();
                opts.cssBefore = {
                    left: fwd ? w : -w,
                    top: 0,
                    opacity: 1,
                    visibility: "visible",
                    display: "block"
                };
                opts.cssAfter = {
                    zIndex: opts._maxZ - 2,
                    left: 0
                };
                opts.animIn = {
                    left: 0
                };
                opts.animOut = {
                    left: fwd ? -w : w
                };
            }
        }
    };
    $.fn.cycle.defaults = {
        allowWrap: true,
        autoSelector: ".cycle-slideshow[data-cycle-auto-init!=false]",
        delay: 0,
        easing: null,
        fx: "fade",
        hideNonActive: true,
        loop: 0,
        manualFx: undefined,
        manualSpeed: undefined,
        manualTrump: true,
        maxZ: 100,
        pauseOnHover: false,
        reverse: false,
        slideActiveClass: "cycle-slide-active",
        slideClass: "cycle-slide",
        slideCss: {
            position: "absolute",
            top: 0,
            left: 0
        },
        slides: "> img",
        speed: 500,
        startingSlide: 0,
        sync: true,
        timeout: 4e3,
        updateView: 0
    };
    $(document).ready(function() {
        $($.fn.cycle.defaults.autoSelector).cycle();
    });
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        autoHeight: 0,
        autoHeightSpeed: 250,
        autoHeightEasing: null
    });
    $(document).on("cycle-initialized", function(e, opts) {
        var autoHeight = opts.autoHeight;
        var t = $.type(autoHeight);
        var resizeThrottle = null;
        var ratio;
        if (t !== "string" && t !== "number") return;
        opts.container.on("cycle-slide-added cycle-slide-removed", initAutoHeight);
        opts.container.on("cycle-destroyed", onDestroy);
        if (autoHeight == "container") {
            opts.container.on("cycle-before", onBefore);
        } else if (t === "string" && /\d+\:\d+/.test(autoHeight)) {
            ratio = autoHeight.match(/(\d+)\:(\d+)/);
            ratio = ratio[1] / ratio[2];
            opts._autoHeightRatio = ratio;
        }
        if (t !== "number") {
            opts._autoHeightOnResize = function() {
                clearTimeout(resizeThrottle);
                resizeThrottle = setTimeout(onResize, 50);
            };
            $(window).on("resize orientationchange", opts._autoHeightOnResize);
        }
        setTimeout(onResize, 30);
        function onResize() {}
    });
    function initAutoHeight(e, opts) {
        var clone, height, sentinelIndex;
        var autoHeight = opts.autoHeight;
        if (autoHeight == "container") {
            height = $(opts.slides[opts.currSlide]).outerHeight();
            opts.container.height(height);
        } else if (opts._autoHeightRatio) {
            opts.container.height(opts.container.width() / opts._autoHeightRatio);
        } else if (autoHeight === "calc" || $.type(autoHeight) == "number" && autoHeight >= 0) {
            if (autoHeight === "calc") sentinelIndex = calcSentinelIndex(e, opts); else if (autoHeight >= opts.slides.length) sentinelIndex = 0; else sentinelIndex = autoHeight;
            if (sentinelIndex == opts._sentinelIndex) return;
            opts._sentinelIndex = sentinelIndex;
            if (opts._sentinel) opts._sentinel.remove();
            clone = $(opts.slides[sentinelIndex].cloneNode(true));
            clone.removeAttr("id name rel").find("[id],[name],[rel]").removeAttr("id name rel");
            clone.css({
                position: "static",
                visibility: "hidden",
                display: "block"
            }).prependTo(opts.container).addClass("cycle-sentinel cycle-slide").removeClass("cycle-slide-active");
            clone.find("*").css("visibility", "hidden");
            opts._sentinel = clone;
        }
    }
    function calcSentinelIndex(e, opts) {
        var index = 0, max = -1;
        opts.slides.each(function(i) {
            var h = $(this).height();
            if (h > max) {
                max = h;
                index = i;
            }
        });
        return index;
    }
    function onBefore(e, opts, outgoing, incoming, forward) {
        var h = $(incoming).outerHeight();
        opts.container.animate({
            height: h
        }, opts.autoHeightSpeed, opts.autoHeightEasing);
    }
    function onDestroy(e, opts) {
        if (opts._autoHeightOnResize) {
            $(window).off("resize orientationchange", opts._autoHeightOnResize);
            opts._autoHeightOnResize = null;
        }
        opts.container.off("cycle-slide-added cycle-slide-removed", initAutoHeight);
        opts.container.off("cycle-destroyed", onDestroy);
        opts.container.off("cycle-before", onBefore);
        if (opts._sentinel) {
            opts._sentinel.remove();
            opts._sentinel = null;
        }
    }
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        caption: "> .cycle-caption",
        captionTemplate: "{{slideNum}} / {{slideCount}}",
        overlay: "> .cycle-overlay",
        overlayTemplate: "<div>{{title}}</div><div>{{desc}}</div>",
        captionModule: "caption"
    });
    $(document).on("cycle-update-view", function(e, opts, slideOpts, currSlide) {
        if (opts.captionModule !== "caption") return;
        var el;
        $.each([ "caption", "overlay" ], function() {
            var name = this;
            var template = slideOpts[name + "Template"];
            var el = opts.API.getComponent(name);
            if (el.length && template) {
                el.html(opts.API.tmpl(template, slideOpts, opts, currSlide));
                el.show();
            } else {
                el.hide();
            }
        });
    });
    $(document).on("cycle-destroyed", function(e, opts) {
        var el;
        $.each([ "caption", "overlay" ], function() {
            var name = this, template = opts[name + "Template"];
            if (opts[name] && template) {
                el = opts.API.getComponent("caption");
                el.empty();
            }
        });
    });
})(jQuery);

(function($) {
    "use strict";
    var c2 = $.fn.cycle;
    $.fn.cycle = function(options) {
        var cmd, cmdFn, opts;
        var args = $.makeArray(arguments);
        if ($.type(options) == "number") {
            return this.cycle("goto", options);
        }
        if ($.type(options) == "string") {
            return this.each(function() {
                var cmdArgs;
                cmd = options;
                opts = $(this).data("cycle.opts");
                if (opts === undefined) {
                    c2.log('slideshow must be initialized before sending commands; "' + cmd + '" ignored');
                    return;
                } else {
                    cmd = cmd == "goto" ? "jump" : cmd;
                    cmdFn = opts.API[cmd];
                    if ($.isFunction(cmdFn)) {
                        cmdArgs = $.makeArray(args);
                        cmdArgs.shift();
                        return cmdFn.apply(opts.API, cmdArgs);
                    } else {
                        c2.log("unknown command: ", cmd);
                    }
                }
            });
        } else {
            return c2.apply(this, arguments);
        }
    };
    $.extend($.fn.cycle, c2);
    $.extend(c2.API, {
        next: function() {
            var opts = this.opts();
            if (opts.busy && !opts.manualTrump) return;
            var count = opts.reverse ? -1 : 1;
            if (opts.allowWrap === false && opts.currSlide + count >= opts.slideCount) return;
            opts.API.advanceSlide(count);
            opts.API.trigger("cycle-next", [ opts ]).log("cycle-next");
        },
        prev: function() {
            var opts = this.opts();
            if (opts.busy && !opts.manualTrump) return;
            var count = opts.reverse ? 1 : -1;
            if (opts.allowWrap === false && opts.currSlide + count < 0) return;
            opts.API.advanceSlide(count);
            opts.API.trigger("cycle-prev", [ opts ]).log("cycle-prev");
        },
        destroy: function() {
            this.stop();
            var opts = this.opts();
            var clean = $.isFunction($._data) ? $._data : $.noop;
            clearTimeout(opts.timeoutId);
            opts.timeoutId = 0;
            opts.API.stop();
            opts.API.trigger("cycle-destroyed", [ opts ]).log("cycle-destroyed");
            opts.container.removeData();
            clean(opts.container[0], "parsedAttrs", false);
            if (!opts.retainStylesOnDestroy) {
                opts.container.removeAttr("style");
                opts.slides.removeAttr("style");
                opts.slides.removeClass(opts.slideActiveClass);
            }
            opts.slides.each(function() {
                var slide = $(this);
                slide.removeData();
                slide.removeClass(opts.slideClass);
                clean(this, "parsedAttrs", false);
            });
        },
        jump: function(index, fx) {
            var fwd;
            var opts = this.opts();
            if (opts.busy && !opts.manualTrump) return;
            var num = parseInt(index, 10);
            if (isNaN(num) || num < 0 || num >= opts.slides.length) {
                opts.API.log("goto: invalid slide index: " + num);
                return;
            }
            if (num == opts.currSlide) {
                opts.API.log("goto: skipping, already on slide", num);
                return;
            }
            opts.nextSlide = num;
            clearTimeout(opts.timeoutId);
            opts.timeoutId = 0;
            opts.API.log("goto: ", num, " (zero-index)");
            fwd = opts.currSlide < opts.nextSlide;
            opts._tempFx = fx;
            opts.API.prepareTx(true, fwd);
        },
        stop: function() {
            var opts = this.opts();
            var pauseObj = opts.container;
            clearTimeout(opts.timeoutId);
            opts.timeoutId = 0;
            opts.API.stopTransition();
            if (opts.pauseOnHover) {
                if (opts.pauseOnHover !== true) pauseObj = $(opts.pauseOnHover);
                pauseObj.off("mouseenter mouseleave");
            }
            opts.API.trigger("cycle-stopped", [ opts ]).log("cycle-stopped");
        },
        reinit: function() {
            var opts = this.opts();
            opts.API.destroy();
            opts.container.cycle();
        },
        remove: function(index) {
            var opts = this.opts();
            var slide, slideToRemove, slides = [], slideNum = 1;
            for (var i = 0; i < opts.slides.length; i++) {
                slide = opts.slides[i];
                if (i == index) {
                    slideToRemove = slide;
                } else {
                    slides.push(slide);
                    $(slide).data("cycle.opts").slideNum = slideNum;
                    slideNum++;
                }
            }
            if (slideToRemove) {
                opts.slides = $(slides);
                opts.slideCount--;
                $(slideToRemove).remove();
                if (index == opts.currSlide) opts.API.advanceSlide(1); else if (index < opts.currSlide) opts.currSlide--; else opts.currSlide++;
                opts.API.trigger("cycle-slide-removed", [ opts, index, slideToRemove ]).log("cycle-slide-removed");
                opts.API.updateView();
            }
        }
    });
    $(document).on("click.cycle", "[data-cycle-cmd]", function(e) {
        e.preventDefault();
        var el = $(this);
        var command = el.data("cycle-cmd");
        var context = el.data("cycle-context") || ".cycle-slideshow";
        $(context).cycle(command, el.data("cycle-arg"));
    });
})(jQuery);

(function($) {
    "use strict";
    $(document).on("cycle-pre-initialize", function(e, opts) {
        onHashChange(opts, true);
        opts._onHashChange = function() {
            onHashChange(opts, false);
        };
        $(window).on("hashchange", opts._onHashChange);
    });
    $(document).on("cycle-update-view", function(e, opts, slideOpts) {
        if (slideOpts.hash && "#" + slideOpts.hash != window.location.hash) {
            opts._hashFence = true;
            window.location.hash = slideOpts.hash;
        }
    });
    $(document).on("cycle-destroyed", function(e, opts) {
        if (opts._onHashChange) {
            $(window).off("hashchange", opts._onHashChange);
        }
    });
    function onHashChange(opts, setStartingSlide) {
        var hash;
        if (opts._hashFence) {
            opts._hashFence = false;
            return;
        }
        hash = window.location.hash.substring(1);
        opts.slides.each(function(i) {
            if ($(this).data("cycle-hash") == hash) {
                if (setStartingSlide === true) {
                    opts.startingSlide = i;
                } else {
                    var fwd = opts.currSlide < i;
                    opts.nextSlide = i;
                    opts.API.prepareTx(true, fwd);
                }
                return false;
            }
        });
    }
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        loader: false
    });
    $(document).on("cycle-bootstrap", function(e, opts) {
        var addFn;
        if (!opts.loader) return;
        addFn = opts.API.add;
        opts.API.add = add;
        function add(slides, prepend) {
            var slideArr = [];
            if ($.type(slides) == "string") slides = $.trim(slides); else if ($.type(slides) === "array") {
                for (var i = 0; i < slides.length; i++) slides[i] = $(slides[i])[0];
            }
            slides = $(slides);
            var slideCount = slides.length;
            if (!slideCount) return;
            slides.css("visibility", "hidden").appendTo("body").each(function(i) {
                var count = 0;
                var slide = $(this);
                var images = slide.is("img") ? slide : slide.find("img");
                slide.data("index", i);
                images = images.filter(":not(.cycle-loader-ignore)").filter(':not([src=""])');
                if (!images.length) {
                    --slideCount;
                    slideArr.push(slide);
                    return;
                }
                count = images.length;
                images.each(function() {
                    if (this.complete) {
                        imageLoaded();
                    } else {
                        $(this).load(function() {
                            imageLoaded();
                        }).on("error", function() {
                            if (--count === 0) {
                                opts.API.log("slide skipped; img not loaded:", this.src);
                                if (--slideCount === 0 && opts.loader == "wait") {
                                    addFn.apply(opts.API, [ slideArr, prepend ]);
                                }
                            }
                        });
                    }
                });
                function imageLoaded() {
                    if (--count === 0) {
                        --slideCount;
                        addSlide(slide);
                    }
                }
            });
            if (slideCount) opts.container.addClass("cycle-loading");
            function addSlide(slide) {
                var curr;
                if (opts.loader == "wait") {
                    slideArr.push(slide);
                    if (slideCount === 0) {
                        slideArr.sort(sorter);
                        addFn.apply(opts.API, [ slideArr, prepend ]);
                        opts.container.removeClass("cycle-loading");
                    }
                } else {
                    curr = $(opts.slides[opts.currSlide]);
                    addFn.apply(opts.API, [ slide, prepend ]);
                    curr.show();
                    opts.container.removeClass("cycle-loading");
                }
            }
            function sorter(a, b) {
                return a.data("index") - b.data("index");
            }
        }
    });
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        pager: "> .cycle-pager",
        pagerActiveClass: "cycle-pager-active",
        pagerEvent: "click.cycle",
        pagerEventBubble: undefined,
        pagerTemplate: "<span>&bull;</span>"
    });
    $(document).on("cycle-bootstrap", function(e, opts, API) {
        API.buildPagerLink = buildPagerLink;
    });
    $(document).on("cycle-slide-added", function(e, opts, slideOpts, slideAdded) {
        if (opts.pager) {
            opts.API.buildPagerLink(opts, slideOpts, slideAdded);
            opts.API.page = page;
        }
    });
    $(document).on("cycle-slide-removed", function(e, opts, index, slideRemoved) {
        if (opts.pager) {
            var pagers = opts.API.getComponent("pager");
            pagers.each(function() {
                var pager = $(this);
                $(pager.children()[index]).remove();
            });
        }
    });
    $(document).on("cycle-update-view", function(e, opts, slideOpts) {
        var pagers;
        if (opts.pager) {
            pagers = opts.API.getComponent("pager");
            pagers.each(function() {
                $(this).children().removeClass(opts.pagerActiveClass).eq(opts.currSlide).addClass(opts.pagerActiveClass);
            });
        }
    });
    $(document).on("cycle-destroyed", function(e, opts) {
        var pager = opts.API.getComponent("pager");
        if (pager) {
            pager.children().off(opts.pagerEvent);
            if (opts.pagerTemplate) pager.empty();
        }
    });
    function buildPagerLink(opts, slideOpts, slide) {
        var pagerLink;
        var pagers = opts.API.getComponent("pager");
        pagers.each(function() {
            var pager = $(this);
            if (slideOpts.pagerTemplate) {
                var markup = opts.API.tmpl(slideOpts.pagerTemplate, slideOpts, opts, slide[0]);
                pagerLink = $(markup).appendTo(pager);
            } else {
                pagerLink = pager.children().eq(opts.slideCount - 1);
            }
            pagerLink.on(opts.pagerEvent, function(e) {
                if (!opts.pagerEventBubble) e.preventDefault();
                opts.API.page(pager, e.currentTarget);
            });
        });
    }
    function page(pager, target) {
        var opts = this.opts();
        if (opts.busy && !opts.manualTrump) return;
        var index = pager.children().index(target);
        var nextSlide = index;
        var fwd = opts.currSlide < nextSlide;
        if (opts.currSlide == nextSlide) {
            return;
        }
        opts.nextSlide = nextSlide;
        opts._tempFx = opts.pagerFx;
        opts.API.prepareTx(true, fwd);
        opts.API.trigger("cycle-pager-activated", [ opts, pager, target ]);
    }
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        next: "> .cycle-next",
        nextEvent: "click.cycle",
        disabledClass: "disabled",
        prev: "> .cycle-prev",
        prevEvent: "click.cycle",
        swipe: false
    });
    $(document).on("cycle-initialized", function(e, opts) {
        opts.API.getComponent("next").on(opts.nextEvent, function(e) {
            e.preventDefault();
            opts.API.next();
        });
        opts.API.getComponent("prev").on(opts.prevEvent, function(e) {
            e.preventDefault();
            opts.API.prev();
        });
        if (opts.swipe) {
            var nextEvent = opts.swipeVert ? "swipeUp.cycle" : "swipeLeft.cycle swipeleft.cycle";
            var prevEvent = opts.swipeVert ? "swipeDown.cycle" : "swipeRight.cycle swiperight.cycle";
            opts.container.on(nextEvent, function(e) {
                opts._tempFx = opts.swipeFx;
                opts.API.next();
            });
            opts.container.on(prevEvent, function() {
                opts._tempFx = opts.swipeFx;
                opts.API.prev();
            });
        }
    });
    $(document).on("cycle-update-view", function(e, opts, slideOpts, currSlide) {
        if (opts.allowWrap) return;
        var cls = opts.disabledClass;
        var next = opts.API.getComponent("next");
        var prev = opts.API.getComponent("prev");
        var prevBoundry = opts._prevBoundry || 0;
        var nextBoundry = opts._nextBoundry !== undefined ? opts._nextBoundry : opts.slideCount - 1;
        if (opts.currSlide == nextBoundry) next.addClass(cls).prop("disabled", true); else next.removeClass(cls).prop("disabled", false);
        if (opts.currSlide === prevBoundry) prev.addClass(cls).prop("disabled", true); else prev.removeClass(cls).prop("disabled", false);
    });
    $(document).on("cycle-destroyed", function(e, opts) {
        opts.API.getComponent("prev").off(opts.nextEvent);
        opts.API.getComponent("next").off(opts.prevEvent);
        opts.container.off("swipeleft.cycle swiperight.cycle swipeLeft.cycle swipeRight.cycle swipeUp.cycle swipeDown.cycle");
    });
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        progressive: false
    });
    $(document).on("cycle-pre-initialize", function(e, opts) {
        if (!opts.progressive) return;
        var API = opts.API;
        var nextFn = API.next;
        var prevFn = API.prev;
        var prepareTxFn = API.prepareTx;
        var type = $.type(opts.progressive);
        var slides, scriptEl;
        if (type == "array") {
            slides = opts.progressive;
        } else if ($.isFunction(opts.progressive)) {
            slides = opts.progressive(opts);
        } else if (type == "string") {
            scriptEl = $(opts.progressive);
            slides = $.trim(scriptEl.html());
            if (!slides) return;
            if (/^(\[)/.test(slides)) {
                try {
                    slides = $.parseJSON(slides);
                } catch (err) {
                    API.log("error parsing progressive slides", err);
                    return;
                }
            } else {
                slides = slides.split(new RegExp(scriptEl.data("cycle-split") || "\n"));
                if (!slides[slides.length - 1]) slides.pop();
            }
        }
        if (prepareTxFn) {
            API.prepareTx = function(manual, fwd) {
                var index, slide;
                if (manual || slides.length === 0) {
                    prepareTxFn.apply(opts.API, [ manual, fwd ]);
                    return;
                }
                if (fwd && opts.currSlide == opts.slideCount - 1) {
                    slide = slides[0];
                    slides = slides.slice(1);
                    opts.container.one("cycle-slide-added", function(e, opts) {
                        setTimeout(function() {
                            opts.API.advanceSlide(1);
                        }, 50);
                    });
                    opts.API.add(slide);
                } else if (!fwd && opts.currSlide === 0) {
                    index = slides.length - 1;
                    slide = slides[index];
                    slides = slides.slice(0, index);
                    opts.container.one("cycle-slide-added", function(e, opts) {
                        setTimeout(function() {
                            opts.currSlide = 1;
                            opts.API.advanceSlide(-1);
                        }, 50);
                    });
                    opts.API.add(slide, true);
                } else {
                    prepareTxFn.apply(opts.API, [ manual, fwd ]);
                }
            };
        }
        if (nextFn) {
            API.next = function() {
                var opts = this.opts();
                if (slides.length && opts.currSlide == opts.slideCount - 1) {
                    var slide = slides[0];
                    slides = slides.slice(1);
                    opts.container.one("cycle-slide-added", function(e, opts) {
                        nextFn.apply(opts.API);
                        opts.container.removeClass("cycle-loading");
                    });
                    opts.container.addClass("cycle-loading");
                    opts.API.add(slide);
                } else {
                    nextFn.apply(opts.API);
                }
            };
        }
        if (prevFn) {
            API.prev = function() {
                var opts = this.opts();
                if (slides.length && opts.currSlide === 0) {
                    var index = slides.length - 1;
                    var slide = slides[index];
                    slides = slides.slice(0, index);
                    opts.container.one("cycle-slide-added", function(e, opts) {
                        opts.currSlide = 1;
                        opts.API.advanceSlide(-1);
                        opts.container.removeClass("cycle-loading");
                    });
                    opts.container.addClass("cycle-loading");
                    opts.API.add(slide, true);
                } else {
                    prevFn.apply(opts.API);
                }
            };
        }
    });
})(jQuery);

(function($) {
    "use strict";
    $.extend($.fn.cycle.defaults, {
        tmplRegex: "{{((.)?.*?)}}"
    });
    $.extend($.fn.cycle.API, {
        tmpl: function(str, opts) {
            var regex = new RegExp(opts.tmplRegex || $.fn.cycle.defaults.tmplRegex, "g");
            var args = $.makeArray(arguments);
            args.shift();
            return str.replace(regex, function(_, str) {
                var i, j, obj, prop, names = str.split(".");
                for (i = 0; i < args.length; i++) {
                    obj = args[i];
                    if (!obj) continue;
                    if (names.length > 1) {
                        prop = obj;
                        for (j = 0; j < names.length; j++) {
                            obj = prop;
                            prop = prop[names[j]] || str;
                        }
                    } else {
                        prop = obj[str];
                    }
                    if ($.isFunction(prop)) return prop.apply(obj, args);
                    if (prop !== undefined && prop !== null && prop != str) return prop;
                }
                return str;
            });
        }
    });
})(jQuery);

(function(onboarding) {
    "use strict";
    tfl.logs.create("tfl.onboardingModal: loaded");
    onboarding.showOnboardModal = function(anchorName, onboardFeature, markAsSeen) {
        if (!tfl.isLocalStorageSupported || hasSeenOnboardMessage(onboardFeature)) {
            return;
        }
        if (markAsSeen) {
            markOnboardMessageAsSeen(onboardFeature);
        }
        var $anchor = $(anchorName);
        var popup = $(".onboard-modal-popup").remove();
        var parentClasses = getParentClasses($anchor.attr("class"), "onboard-modal");
        setTimeout(function() {
            $anchor.append($(hoganTemplates.personalisationStarOnboard.render({
                content: "Now you can save your favourites",
                linkContent: "Take a look",
                class: parentClasses,
                dataOnboardFeature: onboardFeature,
                dataTrackingEvent: tfl.dictionary.TrackingEvent.PersonalisationOpenPanel_prop41,
                dataTracking: tfl.dictionary.TrackingProp.OpenPanel_41.Name,
                dataTrackingValue: tfl.dictionary.TrackingProp.OpenPanel_41.OnboardingFtu
            })));
            tfl.onboardingTrack.trackPersonalisationStarDisplayed();
            $(".onboard-modal-close").on("click", function(e) {
                hideAndMarkAsSeen();
                e.stopPropagation();
            });
        }, 2e3);
        $("body").on("click", hideAndMarkAsSeen);
    };
    function getParentClasses(classList, startsWithText) {
        classList = classList.toLowerCase();
        var classArray = classList.split(" ");
        var result = [];
        var startsWithTextLength = startsWithText.length;
        for (var index = 0; index < classArray.length; index++) {
            if (classArray[index].substring(0, startsWithTextLength) === startsWithText) {
                result.push(classArray[index]);
            }
        }
        return result.join(" ");
    }
    function hideAndMarkAsSeen() {
        var onboardFeature = $(".onboard-modal-popup").data("onboard-feature");
        $(".onboard-modal-popup").remove();
        $(".onboard-modal-close").off("click");
        $("body").off("click", hideAndMarkAsSeen);
        markOnboardMessageAsSeen(onboardFeature);
    }
    function markOnboardMessageAsSeen(onboardFeature) {
        var seenStatus = tfl.storage.get("seenOnboarding");
        if (!seenStatus) {
            seenStatus = {};
        }
        seenStatus[onboardFeature] = true;
        tfl.storage.set("seenOnboarding", seenStatus);
    }
    function hasSeenOnboardMessage(onboardFeature) {
        var seenStatus = tfl.storage.get("seenOnboarding");
        return seenStatus && seenStatus.hasOwnProperty(onboardFeature) && seenStatus[onboardFeature] === true;
    }
    function showOnboarding(onboardFeature) {
        return tfl.showOnboarding && tfl.showOnboarding.hasOwnProperty(onboardFeature) && tfl.showOnboarding[onboardFeature] === true;
    }
    if (showOnboarding("personalisationStar") && !hasSeenOnboardMessage("personalisationStar")) {
        $(".onboard-open-fav-panel").on("click", function() {
            hideAndMarkAsSeen();
            tfl.favouritesPanel.openStatusFavouritesPanel();
        });
        var showPersonalisationOnboard = function() {
            onboarding.showOnboardModal("#c-button-slide-right", "personalisationStar", true);
        };
        tfl.utils.addLoadEvent(showPersonalisationOnboard);
    }
})(window.tfl.onboarding = window.tfl.onboarding || {});

(function(onboardingTrack, $, undefined) {
    "use strict";
    tfl.logs.create("tfl.onboardingTracking: loaded");
    var event = tfl.dictionary.TrackingEvent;
    onboardingTrack.trackPersonalisationStarDisplayed = function() {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.onboardingTracking: trackPersonalisationStarDisplayed");
        var trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationOnboardDisplayed_26;
        tfl.stats.tealiumTracking(trackingItem);
    };
})(window.tfl.onboardingTrack = window.tfl.onboardingTrack || {}, jQuery);

(function(o) {
    var imageAttr = "data-highlight-image";
    var fileAttr = "data-highlight-file";
    o.init = function() {
        var noBackgroundImageClass = "no-background-image";
        var heroObjs = $("[" + imageAttr + "]");
        heroObjs.push($("[" + fileAttr + "]"));
        var containers = [];
        $(window).one("enterBreakpointMedium", function() {
            $.each(heroObjs, function(k, v) {
                var obj = $(v), imgFor = $(obj.attr("data-highlight-for"));
                containers.push(imgFor);
                if (obj.attr(imageAttr)) {
                    imgFor.attr("style", "background-image: url(" + obj.attr(imageAttr) + ")");
                } else if (obj.attr(fileAttr)) {
                    tfl.ajax({
                        url: obj.attr(fileAttr),
                        success: setImageFromSource
                    });
                }
                function setImageFromSource(objs) {
                    var activeObjs = $.grep(objs, function(o) {
                        return o.active;
                    });
                    var selectedObj = activeObjs[Math.floor(Math.random() * activeObjs.length)];
                    imgFor.attr("style", "background-image: url(" + selectedObj.backgroundImage + ")");
                    var advLinkBox = imgFor.find(".advert-link-box").attr("href", selectedObj.link).show();
                    advLinkBox.find("h2").text(selectedObj.headline);
                    advLinkBox.find("p").text(selectedObj.text);
                    advLinkBox.find("img").attr("src", selectedObj.imageURL);
                }
                var newObj = obj.clone();
                newObj.find("img").each(function() {
                    $(this).remove();
                });
                imgFor.find(".content-area").append(newObj);
                obj.addClass(obj.attr("data-highlight-size"));
                var caption = obj.find(".caption");
                if (caption) {
                    var contentArea = imgFor.find(".content-area.medium-large");
                    var hasDisclaimer = $.contains(caption, $(".disclaimer"));
                    if (caption.parent().hasClass("small")) {
                        contentArea.addClass("no-caption");
                        var heroHeight = Math.max(415, imgFor.find(".hero-row").height());
                        contentArea.find(".advert-tile").css({
                            height: heroHeight + "px"
                        });
                    }
                }
            });
        });
        $(window).bind("exitBreakpointMedium", function() {
            $.each(containers, function(k, v) {
                $(v).addClass(noBackgroundImageClass);
            });
        });
        $(window).bind("enterBreakpointMedium", function() {
            $.each(containers, function(k, v) {
                $(v).removeClass(noBackgroundImageClass);
            });
        });
        if ($("body.breakpoint-Medium").length > 0) {
            $(window).trigger("enterBreakpointMedium");
        }
        if ($("body.breakpoint-Large").length > 0) {
            $(window).trigger("enterBreakpointLarge");
        }
    };
    o.init();
})(window.tfl.heroTakeover = window.tfl.heroTakeover || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.recent: loaded");
    var recentCap = 5;
    function toCamelCase(myString) {
        if (!myString) return myString;
        return myString.replace(/-([a-z])/g, function(g) {
            return g[1] !== undefined ? g[1].toUpperCase() : g[1];
        });
    }
    function initRecent() {
        var k;
        o.values = {};
        for (k = 0; k < tfl.objects.modes.length; k += 1) {
            o.values[toCamelCase(tfl.objects.modes[k])] = [];
        }
    }
    function retrieveRecent() {
        var rec = tfl.storage.get("recent");
        if (rec !== null) {
            for (var prop in rec) {
                if (rec.hasOwnProperty(prop)) {
                    if (!o.values.hasOwnProperty(prop)) {
                        delete rec[prop];
                    }
                }
            }
            o.values = $.extend(o.values, rec);
        }
    }
    o.saveRecent = function() {
        tfl.storage.set("recent", o.values);
    };
    o.removeRecentFound = function(obj, from, to) {
        var rest = obj.slice((to || from) + 1 || obj.length);
        obj.length = from < 0 ? obj.length + from : from;
        return obj.push.apply(obj, rest);
    };
    o.addRecent = function(obj) {
        if (typeof obj !== "object" || !obj.hasOwnProperty("mode") || obj.mode === "" || !obj.hasOwnProperty("naptanId") || obj.naptanId === "") {
            tfl.logs.create("Add recent expects object defined in tfl.objects");
            return false;
        } else {
            var alreadyRecent = false;
            for (var i = 0; i < o.values[toCamelCase(obj.mode)].length; i += 1) {
                if (o.values[toCamelCase(obj.mode)][i].naptanId === obj.naptanId) {
                    alreadyRecent = true;
                    o.removeRecentFound(o.values[toCamelCase(obj.mode)], i);
                    o.values[toCamelCase(obj.mode)].unshift(obj);
                    break;
                }
            }
            if (!alreadyRecent) {
                o.values[toCamelCase(obj.mode)].unshift(obj);
                if (o.values[toCamelCase(obj.mode)].length > recentCap) {
                    o.removeRecentFound(o.values[toCamelCase(obj.mode)], recentCap);
                }
            }
            o.saveRecent();
            return true;
        }
    };
    o.getRecent = function(naptanId) {
        if (typeof naptanId === "string") {
            for (var mode in o.values) {
                if (o.values.hasOwnProperty(mode)) {
                    for (var i = 0; i < o.values[mode].length; i += 1) {
                        if (o.values[mode][i].naptanId === naptanId) return o.values[mode][i];
                    }
                }
            }
        } else {
            tfl.logs.create("Error in tfl.favourites.getRecent - Expected naptanId");
            return false;
        }
        return false;
    };
    o.getRecentArray = function(modes) {
        var returnArray = [];
        for (var i = 0; i < modes.length; i++) {
            var modeArray = [];
            var mode = modes[i];
            if (o.values.hasOwnProperty(mode)) {
                modeArray = o.values[mode];
            }
            returnArray = returnArray.concat(modeArray);
        }
        return returnArray;
    };
    o.removeRecent = function(naptanId) {
        if (typeof naptanId === "string" || typeof naptanId === "number") {
            for (var mode in o.values) {
                if (o.values.hasOwnProperty(mode)) {
                    for (var i = 0; i < o.values[mode].length; i += 1) {
                        if (o.values[mode][i].naptanId === naptanId) delete o.values[mode][i];
                    }
                }
            }
        } else {
            tfl.logs.create("Error in tfl.recent.removeRecent - Expected naptanId");
            return false;
        }
        o.saveRecent();
        return true;
    };
    o.clearRecent = function() {
        initRecent();
        o.saveRecent();
    };
    function init() {
        if (tfl.isLocalStorageSupported) {
            initRecent();
            retrieveRecent();
        }
        tfl.logs.create("tfl.recent: setup");
    }
    init();
})(window.tfl.recent = window.tfl.recent || {});

(function() {
    var lastTime = 0;
    var vendors = [ "ms", "moz", "webkit", "o" ];
    for (var x = 0; x < vendors.length && !window.requestAnimationFrame; ++x) {
        window.requestAnimationFrame = window[vendors[x] + "RequestAnimationFrame"];
        window.cancelAnimationFrame = window[vendors[x] + "CancelAnimationFrame"] || window[vendors[x] + "CancelRequestAnimationFrame"];
    }
    if (!window.requestAnimationFrame) window.requestAnimationFrame = function(callback, element) {
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0, 16 - (currTime - lastTime));
        var id = window.setTimeout(function() {
            callback(currTime + timeToCall);
        }, timeToCall);
        lastTime = currTime + timeToCall;
        return id;
    };
    if (!window.cancelAnimationFrame) window.cancelAnimationFrame = function(id) {
        clearTimeout(id);
    };
})();

var tfl = tfl || {};

(function(tfl) {
    "use strict";
    tfl.logs.create("tfl.serviceStatus: loaded");
    tfl.serviceStatus = {
        validHashes: [],
        initServiceBoardPage: function() {
            tfl.logs.create("tfl.serviceStatus: initialised");
            tfl.serviceStatus.serviceUpdatesBoard();
        },
        pageSetup: function() {
            var $stationsTab = $(".stations-tab");
            $(".lines-stations-tab li").click(function() {
                clickTab($(this));
            });
            $(".lines-stations-tab .lines-tab").click(function() {
                tfl.serviceStatus.appendHashToDatePickerAnchors("");
            });
            $(".lines-stations-tab .stations-tab").click(function() {
                tfl.serviceStatus.appendHashToDatePickerAnchors("#stations-status");
            });
            var clickTab = function($tab) {
                tfl.logs.create("tfl.serviceStatus: click on tab");
                if ($tab.hasClass("favourite-tab")) {
                    return false;
                }
                var $rainbowBoard = $(".rainbow-list-wrapper.visible");
                var $listItem = $rainbowBoard.find(".rainbow-list-item.expanded");
                if ($tab.hasClass("selected")) {
                    return;
                } else {
                    $listItem.removeClass("expanded");
                    $rainbowBoard.removeClass("fade-to-black");
                    if (tfl.hasOwnProperty("tubeMap")) {
                        tfl.tubeMap.resetToInitialView();
                    }
                }
                var $linesStatus = $(".lines-status"), $stationsStatus = $(".stations-status"), $linesTab = $(".lines-tab");
                if ($linesStatus.hasClass("visible")) {
                    $linesStatus.removeClass("visible");
                    $stationsStatus.addClass("visible");
                    $linesTab.removeClass("selected");
                    $linesTab.children("a").attr("aria-selected", "false");
                    $stationsTab.addClass("selected");
                    $stationsTab.children("a").attr("aria-selected", "true");
                    if (tfl.hasOwnProperty("tubeMap")) {
                        tfl.tubeMap.closeNoDisruptionPanel();
                    }
                } else {
                    $stationsStatus.removeClass("visible");
                    $linesStatus.addClass("visible");
                    $stationsTab.removeClass("selected");
                    $stationsTab.children("a").attr("aria-selected", "false");
                    $linesTab.addClass("selected");
                    $linesTab.children("a").attr("aria-selected", "true");
                }
            };
            if (window.location.hash !== "") {
                var lineHash = window.location.hash.substr(1), $statusLinks = $("#rainbow-list-tube-dlr-overground-tflrail-tram").find("a.rainbow-list-link");
                $statusLinks.each(function() {
                    if ($(this).prop("href").indexOf("#")) {
                        tfl.serviceStatus.validHashes.push($(this).prop("href").split("#")[1].replace("line-", ""));
                    }
                });
                tfl.logs.create("tfl.serviceStatus: page hash is " + lineHash);
                if (lineHash === "stations-status") {
                    $(".lines-stations-tab .stations-tab").click();
                } else {
                    if ($.inArray(lineHash.replace("line-", "").toLowerCase(), tfl.serviceStatus.validHashes) > -1) {
                        var lineVar = lineHash.substr(5).replace(/[^a-z0-9\-+]+/g, "");
                        var $clickThroughLine = $("[data-line-class=" + lineVar + "]");
                        if ($clickThroughLine.length > 0) {
                            tfl.serviceStatus.clickLine($clickThroughLine);
                        } else {
                            var $clickThroughStation = $("[data-station-class=" + lineVar.toLowerCase() + "]");
                            if ($clickThroughStation.length > 0) {
                                clickTab($stationsTab);
                                tfl.serviceStatus.clickLine($clickThroughStation);
                            }
                        }
                    }
                }
            }
        },
        serviceUpdatesBoard: function() {
            var rainbowBoard = $(".rainbow-list-wrapper, .rainbow-board.traffic");
            $(".close-disruption-info").click(function() {
                $(this).closest(".info-dropdown").prev().removeClass("selected");
                $(".rainbow-board").removeClass("fade-to-black");
            });
            $(".rainbow-list-content .close-message", rainbowBoard).on("click", function(e) {
                e.preventDefault();
                $(this).closest(".rainbow-list-item").removeClass("expanded");
                rainbowBoard.removeClass("fade-to-black");
            });
            $("[data-line-class], [data-station-class]", rainbowBoard).click(function(e) {
                var $parent = $(this).parent(".rainbow-list-item");
                if ($parent.hasClass("expandable")) {
                    if (!$parent.hasClass("expanded")) {
                        var StationOrLineName = "";
                        var prefix = "";
                        if ($parent.data("line-id") && $parent.data("line-id").length) {
                            prefix = "line:";
                        } else {
                            prefix = "station:";
                        }
                        StationOrLineName = prefix + $parent.find(".rainbow-list-link .service-name span").text().trim() + "|";
                        var statuses = "";
                        var temp = $(this).find(".disruption-summary span").html().split("<br>");
                        for (var i = 0; i < temp.length; i++) {
                            temp[i] = temp[i].trim();
                            if (temp[i].length) {
                                statuses += "status:" + temp[i] + "|";
                            }
                        }
                        statuses = statuses.substr(0, statuses.length - 1);
                        var eVar19_Val = StationOrLineName + statuses;
                        tfl.stats.tealiumTracking({
                            event_name: "su_interaction",
                            su_line_status_interrogation: eVar19_Val
                        });
                    }
                }
                tfl.serviceStatus.clickLine($(this));
                e.preventDefault();
                e.stopPropagation();
            });
        },
        updateServiceBoard: function(boardId, modes, response) {
            var hash = window.location.hash;
            var expandedLineClass;
            var expandedStationId;
            if (boardId.indexOf("#") !== 0) {
                boardId = "#" + boardId;
            }
            var $expandedLineStatus = $(boardId + ".lines-status .expanded");
            if ($expandedLineStatus.length) {
                expandedLineClass = $expandedLineStatus.find(".rainbow-list-link").data("line-class");
            }
            var $expandedStation = $(boardId + ".stations-status .expanded");
            if ($expandedStation.length) {
                expandedStationId = $expandedStation.find(".rainbow-list-link").data("naptan-id");
            }
            if (modes === tfl.modeNameTraffic) {
                $(boardId).html(response);
            } else {
                $(boardId).parent().html(response);
            }
            if (tfl.isLocalStorageSupported) {
                tfl.homeFavourites.hideStatusUpdateErrorMsg(modes);
                tfl.homeFavourites.updateMode(modes);
                tfl.favourites.setStatusBoardFavourites(boardId, modes);
            }
            var $datePicker = $(".datepicker-dropdown.dropdown-button");
            if ($datePicker.length) {
                tfl.serviceStatus.initServiceBoardPage();
                var nowText = "Now " + tfl.tools.getTime(new Date());
                var $nowTab = $(".links-list.datepicker-dropdown li:first");
                var nowSpan = $("<span />").addClass("dropdown-name").html(nowText);
                $nowTab.html(nowSpan);
                var $nowMobile = $(".heading-dropdown.date-dropdown-placeholder").find(".for-dropdown").find("h2");
                $nowMobile.html(nowText);
            }
            if (hash !== undefined && hash !== null) {
                hash = hash.substr(1);
            }
            if (hash === "stations-status") {
                $(".lines-stations-tab .stations-tab").removeClass("selected");
                $(".lines-stations-tab .stations-tab").children("a").attr("aria-selected", "false");
                $(".lines-stations-tab .stations-tab").click();
            }
            if (expandedLineClass !== undefined && expandedLineClass !== null) {
                tfl.serviceStatus.clickLine($(boardId + ".lines-status").find("[data-line-class='" + expandedLineClass + "']"));
            }
            if (expandedStationId !== undefined && expandedStationId !== null) {
                tfl.serviceStatus.clickLine($(boardId + ".stations-status").find("[data-naptan-id='" + expandedStationId + "']"));
            }
            window.tfl.favourites.init();
        },
        updateBusServiceBoard: function(boardId, modes, response) {
            if (modes === "bus") {
                $(boardId).parent().replaceWith(response);
                window.tfl.favourites.init();
            }
        },
        ajaxServiceBoard: function(ajaxUrl, boardId, modes) {
            var timeOutId = null;
            var isBusMode = modes === "bus";
            var isFavBoard = tfl.favouritesUtils.helper && tfl.favouritesUtils.helper.isFavBoard(boardId);
            tfl.ajax({
                url: ajaxUrl,
                beforeSend: function(jqXHR, settings) {
                    if (isFavBoard) {
                        ajaxBeforeSend(jqXHR, settings, boardId, modes);
                    }
                },
                success: function(data, textStatus, jqXHR) {
                    ajaxSuccess(data, textStatus, jqXHR, boardId, modes);
                },
                error: function(jqXhr, textStatus, errorThrown) {
                    tfl.serviceStatus.displayStatusUpdateError(jqXhr, boardId, modes);
                },
                complete: function(jqXHR, textStatus) {
                    if (isFavBoard) {
                        ajaxComplete(jqXHR, textStatus, boardId, modes);
                    }
                },
                autoRefreshInterval: !isBusMode ? tfl.autoRefresh.ServiceBoard : null,
                autoRefreshId: !isBusMode ? boardId : null,
                dataType: "text"
            });
        },
        displayStatusUpdateError: function(jqXhr, boardId, modes) {
            boardId = boardId.indexOf("#") !== 0 ? boardId = "#" + boardId : boardId;
            var isFavBoard = tfl.favouritesUtils.helper.isFavBoard(boardId);
            var defaultErrorMessage = hoganTemplates.statusBoardUnavailable.render();
            tfl.logs.create("tfl.serviceStatus.displayStatusUpdateError: Error with ajax call, status: " + jqXhr.status);
            if (isFavBoard) {
                $(boardId).removeClass("fav-loading-data");
            }
            if (modes != "bus" && $("body").hasClass("personalisation-active")) {
                tfl.homeFavourites.displayHomeStatusUpdateError(jqXhr, boardId, modes);
            }
            $(boardId).html(jqXhr.responseText.length ? jqXhr.responseText : defaultErrorMessage);
        },
        initServiceBoardAutoRefresh: function(ajaxUrl, boardId, modes, isWidget) {
            if (isWidget === "true") {
                return false;
            }
            tfl.favourites.setStatusBoardFavourites(boardId, modes);
            var $expandableBox = $("#" + boardId).parents(".expandable-box");
            if ($expandableBox.length) {
                var $expandableBoxLink = $expandableBox.find(".always-visible");
                $expandableBoxLink.on("expandable-box.expanded", function() {
                    tfl.serviceStatus.ajaxServiceBoard(ajaxUrl, boardId, modes);
                });
                $expandableBoxLink.on("expandable-box.collapsed", function() {
                    tfl.stopAjaxAutoRefresh(boardId);
                });
                var $expandedBox = $expandableBox.find(".content.expanded");
                if ($expandedBox.length) {
                    tfl.serviceStatus.ajaxServiceBoard(ajaxUrl, boardId, modes);
                }
            } else {
                window.setTimeout(function() {
                    tfl.serviceStatus.ajaxServiceBoard(ajaxUrl, boardId, modes);
                }, tfl.autoRefresh.ServiceBoard);
            }
        },
        appendHashToDatePickerAnchors: function(hashValue) {
            if (window.location.hash !== "" || hashValue !== null && $.inArray(window.location.hash, tfl.serviceStatus.validHashes) > -1) {
                $(".datepicker-dropdown a").each(function() {
                    var href = $(this).attr("href");
                    href = href.indexOf("#") !== -1 ? href.substr(0, href.indexOf("#")) : href;
                    hashValue = hashValue !== null ? hashValue : window.location.hash;
                    $(this).attr("href", href + hashValue);
                });
            }
        },
        clickLine: function($row) {
            var $rainbowBoard = $row.closest(".rainbow-list-wrapper, .rainbow-board.traffic, .fav-rainbow-list-wrapper");
            var $parent = $row.parent(".rainbow-list-item");
            if ($parent.hasClass("expandable")) {
                var lineId = $parent.data("line-id");
                if (!$parent.hasClass("expanded")) {
                    $(".rainbow-list-item.expanded", $rainbowBoard).removeClass("expanded");
                    $(".rainbow-list-link").attr("aria-expanded", "false");
                    $parent.addClass("expanded");
                    $row.attr("aria-expanded", "true");
                    $rainbowBoard.addClass("fade-to-black");
                    var isFavouritePanel = $rainbowBoard.parents(".fav-panel-details").length > 0;
                    if (tfl.hasOwnProperty("tubeMap") && !isFavouritePanel) {
                        var sevCodes = "" + $parent.data("severity-codes");
                        if (sevCodes !== "undefined" && (sevCodes === "0" || sevCodes.indexOf(",") >= 0 && sevCodes.split(",").indexOf("0") >= 0)) {
                            return;
                        }
                        tfl.tubeMap.zoomToLineId(lineId);
                    }
                    $parent.trigger("rainbow-list.expanded");
                    if (lineId !== undefined && lineId !== null & !isFavouritePanel) {
                        window.location.hash = "line-" + lineId;
                    }
                } else {
                    $parent.removeClass("expanded");
                    $row.attr("aria-expanded", "false");
                    $rainbowBoard.removeClass("fade-to-black");
                    if (tfl.hasOwnProperty("tubeMap")) {
                        tfl.tubeMap.resetToInitialView();
                    }
                    $parent.trigger("rainbow-list.collapsed");
                    if (lineId !== undefined && lineId !== null) {
                        var top = window.scrollY;
                        window.location.hash = "";
                        window.scrollTo(0, top);
                    }
                }
            }
        }
    };
    tfl.serviceStatus.pageSetup();
    function ajaxBeforeSend(jqXHR, settings, boardId, modes) {
        tfl.logs.create("tfl.ajax.beforeSend :: " + "boardId: " + boardId + ", modes: " + modes);
        var boardIdFirstChild = $(boardId + " >");
        if (!boardIdFirstChild.length) {
            jqXHR.timeOutId = setTimeout(function() {
                tfl.logs.create("Deferred | tfl.ajax.beforeSend :: " + "boardId: " + boardId + " : boardIdFirstChild.length = " + boardIdFirstChild.length + " : modes = " + modes);
                $(boardId).addClass("fav-loading-data");
            }, 300);
        }
    }
    function ajaxSuccess(data, textStatus, jqXHR, boardId, modes) {
        var timeOutId = null;
        if (tfl.favouritesUtils && tfl.favouritesUtils.helper && tfl.favouritesUtils.helper.isFavBoard(boardId)) {
            timeOutId = jqXHR.timeOutId;
            setTimeout(function() {
                if (timeOutId) {
                    window.clearTimeout(timeOutId);
                }
                $(boardId).removeClass("fav-loading-data");
                tfl.serviceStatus.updateBusServiceBoard(boardId, modes, data);
            }, 2e3);
        } else {
            tfl.serviceStatus.updateServiceBoard(boardId, modes, data);
        }
    }
    function ajaxComplete(jqXHR, textStatus, boardId, modes) {
        tfl.logs.create("ajaxStatusBoard | tfl.ajax.ajaxComplete : " + textStatus);
        if (textStatus != "success") {
            $(boardId).removeClass("fav-loading-data");
        }
    }
})(tfl);

window.tfl.journeyPlanner = window.tfl.journeyPlanner || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner.recentJourneys: loaded");
    o.journeys = [];
    o.usingRecentJourneys = tfl.storage.get("usingRecentJourneys", true);
    o.isLoaded = false;
    o.recentJourneyNumberLimit = 5;
    o.loadJourneys = function() {
        if (!o.isLoaded) {
            if (o.usingRecentJourneys) {
                o.journeys = tfl.storage.get("recentJourneys", []);
            }
            o.isLoaded = true;
        }
    };
    o.useJourneys = function(on) {
        tfl.journeyPlanner.recentJourneys.usingRecentJourneys = on;
        tfl.storage.set("usingRecentJourneys", o.usingRecentJourneys);
        o.journeys = [];
        tfl.storage.set("recentJourneys", o.journeys);
        tfl.journeyPlanner.recentSearches.searches = [];
        tfl.storage.set("recentSearches", tfl.journeyPlanner.recentSearches.searches);
        return false;
    };
    o.saveJourney = function(fromId, fromModes, toId, toModes, viaId, viaModes) {
        if ($("#From").val() === tfl.dictionary.CurrentLocationText || $("#To").val() === tfl.dictionary.CurrentLocationText || $("#Via").val() === tfl.dictionary.CurrentLocationText) {
            return true;
        }
        o.loadJourneys();
        var newItem = {
            from: $("#From").val().replace(/^\s+|\s+$/g, ""),
            fromId: $("#FromId").val(),
            fromModes: fromModes ? jQuery.parseJSON(fromModes) : "",
            to: $("#To").val().replace(/^\s+|\s+$/g, ""),
            toId: $("#ToId").val(),
            toModes: toModes ? jQuery.parseJSON(toModes) : "",
            via: $("#Via").val().replace(/^\s+|\s+$/g, ""),
            viaId: $("#ViaId").val(),
            viaModes: viaModes ? jQuery.parseJSON(viaModes) : ""
        };
        if (newItem.from === "" || newItem.to === "") {
            return true;
        }
        if (tfl.favourites.isFavouriteJourney(newItem)) {
            return true;
        }
        o.removeJourney(newItem);
        tfl.journeyPlanner.recentJourneys.journeys.splice(0, 0, newItem);
        if (tfl.journeyPlanner.recentJourneys.journeys.length > o.recentJourneyNumberLimit) {
            tfl.journeyPlanner.recentJourneys.journeys.length = o.recentJourneyNumberLimit;
        }
        tfl.storage.set("recentJourneys", tfl.journeyPlanner.recentJourneys.journeys);
        return true;
    };
    o.removeJourneyByKey = function(journeyKey) {
        var journeyItems = journeyKey.split("|");
        var journey = {
            from: journeyItems[0],
            fromId: "",
            fromModes: "",
            to: journeyItems[1],
            toId: "",
            toModes: "",
            via: journeyItems[2],
            viaId: "",
            viaModes: ""
        };
        o.removeJourney(journey);
        tfl.storage.set("recentJourneys", tfl.journeyPlanner.recentJourneys.journeys);
    };
    o.removeJourney = function(journey) {
        if (!o.isLoaded) {
            o.loadJourneys();
        }
        for (var i = 0; i < tfl.journeyPlanner.recentJourneys.journeys.length; i++) {
            var j = tfl.journeyPlanner.recentJourneys.journeys[i];
            if (j.from.toLowerCase().replace(/ /g, "") === journey.from.toLowerCase().replace(/ /g, "") && j.to.toLowerCase().replace(/ /g, "") === journey.to.toLowerCase().replace(/ /g, "") && j.via.toLowerCase().replace(/ /g, "") === journey.via.toLowerCase().replace(/ /g, "")) {
                if (journey.fromId === "" && j.fromId !== "") {
                    journey.fromId = j.fromId;
                }
                if (journey.fromModes === "" && j.fromModes !== "") {
                    journey.fromModes = j.fromModes;
                }
                if (journey.toId === "" && j.toId !== "") {
                    journey.toId = j.toId;
                }
                if (journey.toModes === "" && j.toModes !== "") {
                    journey.toModes = j.toModes;
                }
                if (journey.viaId === "" && j.viaId !== "") {
                    journey.viaId = j.viaId;
                }
                if (journey.viaModes === "" && j.viaModes !== "") {
                    journey.viaModes = j.viaModes;
                }
                tfl.journeyPlanner.recentJourneys.journeys.splice(i, 1);
                break;
            }
        }
    };
})(window.tfl.journeyPlanner.recentJourneys = window.tfl.journeyPlanner.recentJourneys || {});

window.tfl.journeyPlanner = window.tfl.journeyPlanner || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner.recentSearches: loaded");
    o.searches = [];
    o.isLoaded = false;
    o.recentSearchNumberLimit = 5;
    o.recentSearchTimeLimit = 262974e4;
    o.loadSearches = function() {
        if (!o.isLoaded) {
            if (tfl.journeyPlanner.recentJourneys.usingRecentJourneys) {
                o.searches = tfl.storage.get("recentSearches", []);
                if (o.searches.length > 0) {
                    var timeNow = new Date().getTime();
                    for (var i = 0; i < o.searches.length; i++) {
                        var j = o.searches[i];
                        if (j.lastSearchDate < timeNow - o.recentSearchTimeLimit) {
                            o.searches.splice(i, 1);
                        }
                    }
                }
            }
            o.isLoaded = true;
        }
    };
    o.saveSearch = function(newPlaceName, newPlaceId, newPlaceModes) {
        if (newPlaceName === "" || newPlaceName === tfl.dictionary.CurrentLocationText) return true;
        newPlaceName = newPlaceName.replace(/^\s+|\s+$/g, "");
        if (newPlaceId === null) newPlaceId = "";
        if (typeof newPlaceModes === "string" && newPlaceModes !== "") {
            newPlaceModes = jQuery.parseJSON(newPlaceModes);
        }
        var timeNow = new Date().getTime();
        for (var i = 0; i < tfl.journeyPlanner.recentSearches.searches.length; i++) {
            var j = tfl.journeyPlanner.recentSearches.searches[i];
            if (j.placeName.toLowerCase() === newPlaceName.toLowerCase()) {
                if (newPlaceId === "" && j.placeId !== "") {
                    newPlaceId = j.placeId;
                }
                if (newPlaceModes === "" && j.placeModes !== "") {
                    newPlaceModes = j.placeModes;
                }
                tfl.journeyPlanner.recentSearches.searches.splice(i, 1);
                break;
            }
        }
        var newSearch = {
            placeName: newPlaceName,
            placeId: newPlaceId,
            placeModes: newPlaceModes,
            lastSearchDate: timeNow
        };
        tfl.journeyPlanner.recentSearches.searches.splice(0, 0, newSearch);
        if (tfl.journeyPlanner.recentSearches.searches.length > o.recentSearchNumberLimit) {
            tfl.journeyPlanner.recentSearches.searches.length = o.recentSearchNumberLimit;
        }
        tfl.storage.set("recentSearches", tfl.journeyPlanner.recentSearches.searches);
        return true;
    };
})(window.tfl.journeyPlanner.recentSearches = window.tfl.journeyPlanner.recentSearches || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner: loaded");
    tfl.cachingSettings = {
        daily: getCachingKey()
    };
    function getCachingKey() {
        var d = new Date();
        var n = String(d.getFullYear()) + String(d.getMonth()) + String(d.getDay()) + String(d.getHours());
        return n;
    }
    o.settings = {
        disambiguationItemsPerPage: 9
    };
    o.init = function(pageName) {
        tfl.logs.create("tfl.journeyPlanner.init: started");
        o.createJourneys(pageName);
        $("#InputFrom, #InputTo").focus(function() {
            $(this).attr("placeholder", $(this).attr("data-placeholder-focus"));
        });
        $("#InputFrom, #InputTo").blur(function() {
            $(this).attr("placeholder", $(this).attr("data-placeholder-blur"));
        });
    };
    o.createJourneys = function(pageName, tabToSelect, focusArea) {
        if (!tfl.isLocalStorageSupported) {
            tfl.logs.create("tfl.journeyplanner: not creating fav-recent journeys - local storage not present.");
            return;
        }
        var page = getPageConfiguration(pageName);
        o.settings.pageName = page.name;
        tfl.logs.create("tfl.journeyplanner: creating fav-recent journeys on " + page.name);
        $("#recent-journeys").empty();
        $("#recent-journeys-small").empty();
        if ($("#jpw-medlarge").length === 0) {
            $(page.pinSmall).after(page.elementSmall);
            $(page.pinMediumLarge).after(page.elementMediumLarge);
        }
        var journeysContainer = $("#recent-journeys");
        journeysContainer.append(page.tabs);
        var journeysContainerSmall;
        if (page.name === "home") {
            journeysContainerSmall = $("#recent-journeys-small");
            journeysContainerSmall.append(page.tabsSmall);
            journeysContainer.addClass("hp-recent-journeys");
            journeysContainerSmall.addClass("hp-recent-journeys");
        }
        var recentJourneys = loadRecentJourneys(page);
        var favouriteJourneys = loadFavouriteJourneys(page);
        linkEvents(recentJourneys);
        performTabAction(page.name, tabToSelect, favouriteJourneys, recentJourneys, focusArea);
        $("#jp-tabs li").click(function() {
            clickTab(this, true);
        });
        $("#jp-tabs-small li").click(function() {
            clickTab(this, true);
        });
        $("div.medium-large[data-set=recent-journeys]").append(journeysContainer);
        $(".moving-source-order").appendAround();
        var $hpJourneyPlanner = $("#hp-journey-planner");
        if ($hpJourneyPlanner.length) {
            var $hpJourneyPlannerLink = $hpJourneyPlanner.find(".always-visible");
            $hpJourneyPlannerLink.on("expandable-box.expanded", function() {
                performTabAction("home", "new", undefined, undefined, "large");
            });
        }
        var $hpJourneysRecents = $("#hp-journeys-recents");
        if ($hpJourneysRecents.length) {
            var $hpJourneysRecentsLink = $hpJourneysRecents.find(".always-visible");
            $hpJourneysRecentsLink.on("expandable-box.expanded", function() {
                if (!smallTabSelected()) {
                    performTabAction("home", "fav", undefined, undefined, "small");
                }
            });
        }
        function smallTabSelected() {
            var jpTabList = document.getElementById("jp-tabs-small").getElementsByTagName("li");
            for (var i = 0, len = jpTabList.length; i < len; i++) {
                if ($(jpTabList[i]).hasClass("selected")) {
                    return true;
                }
            }
            return false;
        }
    };
    o.refreshJourneys = function(pageName) {
        var page = getPageConfiguration(pageName);
        var recentJourneys = loadRecentJourneys(page);
        var favouriteJourneys = loadFavouriteJourneys(page);
        linkEvents(recentJourneys);
    };
    o.redoJourney = function(idx) {
        var journey = tfl.journeyPlanner.recentJourneys.journeys[idx];
        if (!journey) {
            journey = getJourneyFromAttributes(idx);
        }
        var async = false;
        var doJourney = function() {
            $("#jp-search-form").submit();
        };
        if (journey.from === tfl.dictionary.CurrentLocationText) {
            async = true;
            tfl.journeyPlanner.searchForm.geolocateMe("#From", doJourney);
        } else {
            $("#From").val(journey.from);
            $("#InputFrom").val(journey.from);
            $("#FromId").val(journey.fromId);
            $("#From").attr("data-from-id", journey.fromId);
            $("#From").attr("data-from-modes", JSON.stringify(journey.fromModes));
        }
        if (journey.to === tfl.dictionary.CurrentLocationText) {
            async = true;
            tfl.journeyPlanner.searchForm.geolocateMe("#To", doJourney);
        } else {
            $("#To").val(journey.to);
            $("#InputTo").val(journey.to);
            $("#ToId").val(journey.toId);
            $("#To").attr("data-to-id", journey.toId);
            $("#To").attr("data-to-modes", JSON.stringify(journey.toModes));
        }
        if (journey.via !== null) {
            if (journey.via === tfl.dictionary.CurrentLocationText) {
                async = true;
                tfl.journeyPlanner.searchForm.geolocateMe("#Via", doJourney);
            } else {
                $("#Via").val(journey.via);
                $("#ViaId").val(journey.viaId);
                $("#Via").attr("data-via-id", journey.viaId);
                $("#Via").attr("data-via-modes", JSON.stringify(journey.viaModes));
            }
        } else {
            $("#Via").val("");
        }
        if (!async) {
            doJourney();
        }
    };
    o.getFavouriteJourneys = function(journeys, maxFavourites) {
        var favJourneys = {
            journeys: []
        };
        var favLength;
        if (!maxFavourites) {
            maxFavourites = 99;
        }
        if (journeys) {
            favJourneys.actualLength = journeys.length;
            favLength = journeys.length < maxFavourites ? journeys.length : maxFavourites;
            for (var i = 0; i < favLength; i++) {
                favJourneys.journeys.push(journeys[i].props);
            }
        }
        return favJourneys;
    };
    function getPageConfiguration(pageName) {
        var page = {};
        if (!pageName || pageName === "jp") {
            page.name = "jp";
            page.maxFavourites = 5;
            page.tabs = "<ul id='jp-tabs' class='tabs-style-2'><li id='jp-fav-tab-jp'><a href='#jp-fav'>My Journeys</a></li><li id='jp-recent-tab-jp'><a href='#jp-recent'>Recents</a></li></ul>";
            page.pinMediumLarge = "#plan-a-journey";
            page.pinSmall = "#more-journey-options";
            page.elementMediumLarge = "<div id='jpw-medlarge' class='medium-large' data-set='recent-journeys'><div id='recent-journeys' class='moving-source-order' /></div>";
            page.elementSmall = "<div class='small' data-set='recent-journeys' />";
        } else {
            page.name = "home";
            page.maxFavourites = 5;
            page.tabs = "<ul id='jp-tabs' class='tabs-style-2' role='tablist'><li id='jp-new-tab-home' role='presentation'><a href='#jp-new' role='tab' aria-controls='jp-new-content-home-' aria-selected='false'>New <span class='visually-hidden'>Journey</span></a></li><li id='jp-fav-tab-home' role='presentation'><a href='#jp-fav' role='tab' aria-controls='jp-fav-content-home-' aria-selected='false'>My Journeys</a></li><li id='jp-recent-tab-home' role='presentation'><a href='#jp-recent' role='tab' aria-controls='jp-recent-content-home-' aria-selected='false'>Recents</a></li></ul>";
            page.tabsSmall = "<ul id='jp-tabs-small' class='tabs-style-2' role='tablist'><li id='jp-fav-tab-home-small' role='presentation'><a href='#jp-fav' role='tab' aria-controls='jp-fav-content-home-' aria-selected='false'>My Journeys</a></li><li id='jp-recent-tab-home-small' role='presentation'><a href='#jp-recent' aria-controls='jp-recent-content-home-' role='tab' aria-selected='false'>Recents</a></li></ul>";
            page.pinMediumLarge = "#hp-plan-a-journey";
            page.pinSmall = "#hp-more-journey-options";
            page.elementMediumLarge = "<div id='jpw-medlarge' class='medium-large'><div id='recent-journeys' /></div>";
            page.elementSmall = "<div class='small'><div id='recent-journeys-small' /></div>";
        }
        return page;
    }
    function clickTab($tab, propagate) {
        if ($($tab).hasClass("selected")) {
            return false;
        }
        var $parent = $($tab).closest("ul")[0];
        tfl.logs.create("tfl.journeyPlanner: click on tab " + $parent.id + " - " + $tab.id);
        var $tabList = $parent.getElementsByTagName("li");
        for (var i = 0, len = $tabList.length; i < len; i++) {
            var contentKeys = getContentKeys($tabList[i].id);
            var contentId = getContentId(contentKeys);
            if ($tabList[i].id === $tab.id) {
                $($tabList[i]).addClass("selected");
                $($tabList[i]).children("a").attr("aria-selected", "true");
                $(contentId).show();
                o.settings.tab = contentKeys.tab;
            } else {
                $($tabList[i]).removeClass("selected");
                $($tabList[i]).children("a").attr("aria-selected", "false");
                $(contentId).hide();
            }
        }
        if (propagate) {
            closeExpandableContent($tab.id);
        }
    }
    function performTabAction(pageName, tabToSelect, favouriteJourneys, recentJourneys, area) {
        var tabName;
        if (pageName === "home") {
            if (!area || area === "small") {
                tabName = tabToSelect && tabToSelect !== "new" ? "jp-" + tabToSelect + "-tab-home-small" : "jp-fav-tab-home-small";
                clickTab(document.getElementById(tabName), false);
            }
            if (!area || area === "large") {
                tabName = tabToSelect ? "jp-" + tabToSelect + "-tab-home" : "jp-new-tab-home";
                clickTab(document.getElementById(tabName), false);
            }
        } else {
            if (tabToSelect) {
                clickTab(document.getElementById("jp-" + tabToSelect + "-tab-jp"), false);
            } else if (favouriteJourneys && favouriteJourneys.journeys && favouriteJourneys.journeys.length > 0 || recentJourneys && recentJourneys.length === 0) {
                clickTab(document.getElementById("jp-fav-tab-jp"), false);
            } else {
                clickTab(document.getElementById("jp-recent-tab-jp"), false);
            }
        }
    }
    function getJourneyFromAttributes(journeyElement) {
        var journey = {
            from: journeyElement.data("from"),
            fromId: journeyElement.data("fromId"),
            fromModes: journeyElement.data("fromModes"),
            to: journeyElement.data("to"),
            toId: journeyElement.data("toId"),
            toModes: journeyElement.data("toModes"),
            via: journeyElement.data("via"),
            viaId: journeyElement.data("viaId"),
            viaModes: journeyElement.data("viaModes")
        };
        return journey;
    }
    function loadRecentJourneys(page) {
        var journeysContainer = $("#recent-journeys");
        var journeysContainerSmall = $("#recent-journeys-small");
        var recentsOn = tfl.journeyPlanner.recentJourneys.usingRecentJourneys;
        tfl.journeyPlanner.recentJourneys.loadJourneys();
        var recentJourneys = recentsOn ? tfl.journeyPlanner.recentJourneys.journeys : [];
        var recentJourneysContent = {
            hasItems: recentJourneys.length !== 0,
            hasNoItems: recentJourneys.length === 0,
            items: recentJourneys,
            isRecents: true,
            recentsOn: recentsOn,
            recentsOff: !recentsOn,
            pagename: page.name,
            recentsEnabled: window.hasCookieBot() && Cookiebot.consent.preferences,
            recentsMessage: tfl.dictionary.cookiebotRecentsMessage,
            recentsLink: tfl.dictionary.cookiebotRecentsLink
        };
        appendJourneys("recent", journeysContainer, recentJourneysContent, page.name, "");
        if (page.name === "home") {
            recentJourneysContent.small = "small";
            appendJourneys("recent", journeysContainerSmall, recentJourneysContent, page.name, "small");
        }
        return recentJourneys;
    }
    function loadFavouriteJourneys(page) {
        if ($("body").hasClass("personalisation-active") === false) {
            return null;
        }
        var journeysContainer = $("#recent-journeys");
        var journeysContainerSmall = $("#recent-journeys-small");
        var favouriteJourneys = o.getFavouriteJourneys(tfl.favourites.getFavourites("journey"), page.maxFavourites);
        var favouriteJourneysContent = {
            hasItems: favouriteJourneys.journeys.length !== 0,
            hasNoItems: favouriteJourneys.journeys.length === 0,
            items: favouriteJourneys.journeys,
            isFavourites: true,
            hasFiveOrLess: favouriteJourneys.actualLength <= 5,
            hasMoreThanFive: favouriteJourneys.actualLength > 5,
            pagename: page.name,
            recentsEnabled: window.hasCookieBot() && Cookiebot.consent.preferences,
            recentsMessage: tfl.dictionary.cookiebotJourneysMessage,
            recentsLink: tfl.dictionary.cookiebotRecentsLink
        };
        appendJourneys("fav", journeysContainer, favouriteJourneysContent, page.name, "");
        if (page.name === "home") {
            favouriteJourneysContent.small = "small";
            appendJourneys("fav", journeysContainerSmall, favouriteJourneysContent, page.name, "small");
        }
        return favouriteJourneys;
    }
    function appendJourneys(type, container, content, page, area) {
        var elementName = "#jp-" + type + "-content-" + page + "-" + area;
        var isSelected = false;
        var existingElement = $(elementName);
        if (existingElement.length > 0) {
            isSelected = existingElement.is(":visible");
            container.find(elementName).remove();
        }
        container.append($(window.hoganTemplates.journey.render(content)));
        if (isSelected) {
            $(elementName).show();
        } else {
            $(elementName).hide();
        }
    }
    function getContentKeys(elem) {
        var contentId = "";
        var contentKeys = {};
        if (typeof elem !== "string") {
            var $content = $(elem).closest(".tabs-content")[0];
            if ($content && $content.id) {
                contentId = $content.id;
            }
        } else {
            contentId = elem;
        }
        var keys = contentId.split("-");
        contentKeys.area = keys && keys.length >= 5 ? keys[4] : undefined;
        contentKeys.pageName = keys && keys.length >= 4 ? keys[3] : undefined;
        contentKeys.tab = keys && keys.length >= 2 ? keys[1] : undefined;
        return contentKeys;
    }
    function getContentId(contentKeys) {
        return "#jp-" + contentKeys.tab + "-content-" + contentKeys.pageName + "-" + (contentKeys.area ? contentKeys.area : "");
    }
    function setRecentJourneysAndSearchForm(elem, useRecents) {
        tfl.journeyPlanner.recentJourneys.useJourneys(useRecents);
        tfl.journeyPlanner.searchForm.destroyAutocomplete();
        tfl.journeyPlanner.searchForm.setupAutocomplete(false);
        refreshSelection(elem);
    }
    function refreshSelection(elem) {
        var contentKeys = getContentKeys(elem);
        o.createJourneys(contentKeys.pageName, contentKeys.tab, contentKeys.area);
    }
    function closeExpandableContent(tabId) {
        var contentKeys = getContentKeys(tabId);
        if (contentKeys.pageName === "home" && !contentKeys.area) {
            if (document.querySelector("#hp-journey-planner .content.expanded")) {
                $("#hp-journey-planner .content").removeClass("expanded");
                $("#hp-journey-planner .content .always-visible").attr("aria-expanded", false).trigger("expandable-box.collapsed");
            }
            if (document.querySelector("#hp-journeys-recents .content.expanded")) {
                $("#hp-journeys-recents .content").removeClass("expanded");
                $("#hp-journeys-recents .content .always-visible").attr("aria-expanded", false).trigger("expandable-box.collapsed");
            }
        }
    }
    function linkEvents(recentJourneys) {
        $(".turn-on-recent-journeys").click(function(event) {
            event.preventDefault();
            setRecentJourneysAndSearchForm(this, true);
        });
        $(".turn-off-recent-journeys").click(function(event) {
            event.preventDefault();
            setRecentJourneysAndSearchForm(this, false);
        });
        $(".journey-item").on("click keydown", function(e) {
            if (e.type != "click" && e.which != 13 && e.which != 32) return;
            e.preventDefault();
            tfl.jpTrack.trackSavedJourneySelected(e);
            o.redoJourney($(this));
            return false;
        });
        $(".plan-my-journeys").click(function(e) {
            e.preventDefault();
            var contentKeys = getContentKeys(this);
            tfl.jpTrack.trackPlanMyJourneysSelected(contentKeys.pageName);
            if (contentKeys.pageName === "home") {
                if (contentKeys.area === "small" && document.querySelector("#hp-journey-planner .content") && !document.querySelector("#hp-journey-planner .content.expanded")) {
                    $("#hp-journey-planner .content").addClass("content expanded");
                    $("#hp-journey-planner .content .always-visible").attr("aria-expanded", true).trigger("expandable-box.expanded");
                }
                performTabAction(contentKeys.pageName, "new", undefined, undefined, contentKeys.area);
            }
            if (!(contentKeys.pageName === "home" && contentKeys.area === "")) {
                location.href = "#";
                location.href = "#hp-journey-planner";
            }
        });
        $(".edit-my-journeys").click(function(e) {
            e.preventDefault();
            tfl.jpTrack.trackOpenPanelFromPlanJourney(e);
            tfl.favouritesPanel.editFavouritesPanel.openEditFavouritesPanel("journey", null, false);
        });
        $(".view-my-journeys").click(function(e) {
            e.preventDefault();
            tfl.jpTrack.trackOpenPanelFromPlanJourney(e);
            tfl.favouritesPanel.openStatusFavouritesPanel("journey");
        });
        $(".add-recents-to-favourites").click(function(e) {
            e.preventDefault();
            tfl.jpTrack.trackOpenPanelFromPlanJourney(e);
            recentJourneys.journeyType = "recents";
            tfl.favouritesPanel.editFavouritesPanel.openEditFavouritesPanel("journey", null, false, recentJourneys);
        });
    }
})(window.tfl.journeyPlanner = window.tfl.journeyPlanner || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner.results: loaded");
    var firstPageLoad = true, streetviewUrl = tfl.api.JourneyPlannerStreetView, jpTypeSelected = $("#JpType"), evar = tfl.dictionary.TrackingEvar, event = tfl.dictionary.TrackingEvent, prop = tfl.dictionary.TrackingProp, overviewMap = null, $fullScreenPanoramaContainer = null;
    function handleJpResultsLoading() {
        var editPrefs = $("#plan-a-journey").find(".edit-preferences");
        if (editPrefs.hasClass("extra-options")) {
            editPrefs.removeClass("extra-options");
        }
    }
    o.isLargeView = function() {
        return $("body").hasClass("breakpoint-Large");
    };
    var ajaxSuccess = function(response, classToReplace) {
        var data = $(response).find(".ajax-response");
        var $cyclingWalkingOnlyInformation = $(response).find(".cycling-walking-only-information");
        var $busyStationsInformation = $(response).find(".journey-busy-stations-information");
        var $extraJourneyOptions = $(response).find(".extra-journey-options");
        var isMapRequired = $(response).find("#IsMapRequired").val() === "True";
        var $journeyBannerAdvice = $("#journey-banner-advice");
        var $busyStationsAdvice = $("#journey-busy-stations-advice");
        var $extraJourneyPlaceholder = $(".extra-journey-placeholder");
        var $extraJourneyPlaceholderUnderDefault = $("#extra-journey-placeholder-under-default");
        var jpType = $("#JpType").val();
        var scrollToElement = document.getElementById("loader-window");
        o.scrollIntoView(scrollToElement);
        $("#loader-window-wrapper").empty();
        if ($cyclingWalkingOnlyInformation) {
            $journeyBannerAdvice.empty().append($cyclingWalkingOnlyInformation);
            data.find("#cycling-walking-only-information-wrapper").remove();
        }
        if ($busyStationsInformation) {
            $busyStationsAdvice.empty().append($busyStationsInformation);
            data.find("#journey-busy-stations-advice-wrapper").remove();
        }
        var walkUnderDefault = $(response).find("#WalkingJourneyUnderDefault");
        var walkingJourneyUnderDefault = walkUnderDefault && walkUnderDefault.val() === "True";
        $(classToReplace).replaceWith($(data));
        if (!$extraJourneyPlaceholder.length) {
            $extraJourneyPlaceholder = $(".extra-journey-options");
        }
        if (walkingJourneyUnderDefault) {
            $extraJourneyPlaceholderUnderDefault.replaceWith($extraJourneyOptions);
        } else {
            $extraJourneyPlaceholder.replaceWith($extraJourneyOptions);
        }
        jpTypeSelected.val(jpType);
        $("#InputVia").val($("#Via").val());
        $("#IsMapRequired").remove();
        $(".journey-result-summary").append('<input type="hidden" id="IsMapRequired" name="IsMapRequired" value="' + isMapRequired + '"/>');
        var journeyTimeWalking = $(".walking-box .journey-time");
        if (journeyTimeWalking.length === 1 && $('[data-jp-tabs="true"] .walking.selected').length < 1) {
            journeyTimeWalking.find(".visually-hidden").remove();
            journeyTimeWalking = $("<span></span>").addClass("tabs-time").text("Walk this in " + journeyTimeWalking.text());
            $('[data-jp-tabs="true"] [data-jptype="walking"]').addClass("has-time").append(journeyTimeWalking);
        }
        var journeyTimeCycle = $(".cycling-box .journey-time"), btnSuspendedList = $(".suspended-docking-station-list-button");
        if (journeyTimeCycle.length === 1 && $('[data-jp-tabs="true"] .cycling.selected').length < 1) {
            journeyTimeCycle.find(".visually-hidden").remove();
            journeyTimeCycle = $("<span></span>").addClass("tabs-time").text("Cycle in " + journeyTimeCycle.text());
            $('[data-jp-tabs="true"] [data-jptype="cycling"]').addClass("has-time").append(journeyTimeCycle);
        }
        btnSuspendedList.click(function() {
            if (btnSuspendedList.hasClass("hide-details")) {
                $(".suspended-docking-station-list").addClass("start-hidden");
            }
        });
        $(".suspended-docking-station-container").click(function(e) {
            e.stopImmediatePropagation();
        });
        if ($("#isMultiModal").val() == "False") {
            firstPageLoad = false;
        }
        o.processResults(isMapRequired);
        firstPageLoad = false;
        $("[data-pull-content]").LightBox();
        o.initGlobal();
        if ($(".disambiguation-form").length > 0) {
            $(".journey-result-summary").find(".favourite-tab").hide();
            tfl.journeyPlanner.disambiguation.init();
        } else {
            $(".journey-result-summary").find(".favourite-tab").show();
            $(".summary-results").find(".expandable-box").css({
                opacity: 0
            }).each(function(i) {
                $(this).delay(150 * i).animate({
                    opacity: 1
                }, 100, function() {
                    $(this).removeAttr("style");
                });
            });
        }
        o.initSteal(isMapRequired);
        $("#alternatives").find("[data-pull-content]").LightBox();
        bindEventHandlers();
        initCyclingWalkingSpecific();
    };
    o.init = function(loadedViaAjax) {
        tfl.logs.create("tfl.journeyPlanner.results.init: started (isAjax: " + loadedViaAjax + ")");
        if (!loadedViaAjax) {
            o.resultsFormInit();
            o.processResults();
            o.initSteal();
        } else {
            o.initAjaxPage();
        }
        if ($("html").hasClass("lt-ie8")) {
            o.initIE7();
        }
    };
    o.initGlobal = function() {
        tfl.logs.create("tfl.journeyPlanner.initGlobal: started");
        tfl.expandableBox.init();
    };
    o.initAjaxPage = function() {
        tfl.logs.create("tfl.journeyPlanner.results.initAjaxPage: started");
        var loaderType = jpTypeSelected.val() === "" ? "publictransport" : jpTypeSelected.val();
        o.setupLoader(loaderType);
        o.resultsFormInit();
        var url = window.location.href, resultsUrl = tfl.jPResultsPageUrl;
        url = url.substring(url.indexOf("?"), url.length);
        tfl.ajax({
            url: resultsUrl + url,
            success: function(response) {
                ajaxSuccess(response, ".journey-details-ajax");
            },
            dataType: "html"
        });
    };
    o.initSteal = function(isMapRequired) {
        steal(tfl.mapScriptPath).then(function() {
            tfl.logs.create("tfl.journeyPlanner.results.initSteal: started");
            var mapLoaded = false, legMapElement = null, legMap = null, btnViewOnMap = $(".view-on-a-map"), mapInitialized = false, initStreetViewFullScreenMap = function() {
                $fullScreenPanoramaContainer = $(".streetview-panorama-container");
                $fullScreenPanoramaContainer.prependTo("body");
            }, fullScreenLegMap = function(lmap) {
                tfl.fullscreen.display(lmap, false, true);
                lmap.controller().divResized();
            };
            if (isMapRequired) {
                o.initResultsOverviewMap();
                initStreetViewFullScreenMap();
                mapInitialized = true;
            }
            function handleShowMapButtonclick(event, data, $this) {
                var mapLinks;
                btnViewOnMap.not(this).removeClass("show-all");
                $this.toggleClass("show-all");
                if (data && data.isHideAll) {
                    mapLinks = $(".view-on-a-map.hide-map");
                } else {
                    mapLinks = $(".view-on-a-map.hide-map").not(this);
                }
                mapLinks.text("Map view").removeClass("hide-map");
                if ($this.hasClass("map-loaded")) {
                    if ($this.hasClass("map-showing")) {
                        $this.text("Map view");
                        $this.removeClass("map-showing").parent().next(".multimap").hide();
                    } else {
                        $this.text("Hide map").addClass("map-showing");
                        var lmap = $this.parent().next(".multimap");
                        lmap.show();
                        if (!o.isLargeView()) {
                            fullScreenLegMap(lmap);
                        }
                    }
                } else {
                    $this.text("Hide map").addClass("map-loaded map-showing");
                    $this.parent().after("<div class='multimap leg-map'></div>");
                    $.fixture.on = false;
                    legMapElement = $this.parent().next(".multimap").tfl_maps_journey_planner_leg_map({
                        url: $(".journey-results").data("api-uri"),
                        isNationalBounds: tfl.getQueryParam("NationalSearch") === "true",
                        mapDeactivated: function() {
                            tfl.fullscreen.hide();
                            overviewMap.deactivateMap();
                            $this.text("Map view");
                            $this.trigger("click");
                        }
                    });
                    legMap = legMapElement.controller();
                    legMap.mapLoading.done(function() {
                        $(window).on("enterBreakpointSmall exitBreakpointMedium", function() {
                            if (legMapElement.is(":visible")) {
                                fullScreenLegMap(legMapElement);
                            }
                        }).on("enterBreakpointMedium", function() {
                            tfl.fullscreen.hide();
                        });
                        if (!o.isLargeView()) {
                            fullScreenLegMap(legMapElement);
                        }
                    });
                    mapLoaded = true;
                    legMap.chooseJourney($this.data("journeyindex"));
                }
            }
            btnViewOnMap.click(function(event, data) {
                var $this = $(this);
                if (mapInitialized === false) {
                    o.initResultsOverviewMap(function() {
                        handleShowMapButtonclick(data, event, $this);
                    });
                    initStreetViewFullScreenMap();
                    mapInitialized = true;
                } else {
                    handleShowMapButtonclick(data, event, $this);
                }
                return false;
            });
        });
    };
    o.initResultsOverviewMap = function(callback) {
        var originalDesktopMapHeight = "520", journeyType = jpTypeSelected.val() === "" ? "publictransport" : jpTypeSelected.val(), overviewMapElement = null, mapContainer = $(".full-map-container"), mapWrapper = mapContainer.find(".map-wrapper"), carouselWrap = $(".carousel-wrap"), speedOption = $(".speed-option");
        initMap();
        function onMapLoaded() {
            setupResizeEvents();
            resetMap();
            if (callback !== undefined) {
                callback();
            }
        }
        function initMap() {
            tfl.logs.create("tfl.journeyPlanner.results.initResultsOverviewMap: started");
            overviewMapElement = createJourneyOverviewMap();
            overviewMap = overviewMapElement.controller();
            if (overviewMap) {
                overviewMap.mapLoading.done(onMapLoaded);
                o.initResultsOverviewMapMobileControls();
            }
            if (!tfl.utils.isTouchDevice()) {
                setupDesktopEvents();
            }
            tfl.logs.create("tfl.journeyPlanner.results.initResultsOverviewMap: complete");
        }
        function resetMap() {
            var isLargeView = o.isLargeView();
            if (isLargeView) {
                closeFullScreenOverviewMap();
                tfl.fullscreen.setScrollTop();
                overviewMapElement.height(originalDesktopMapHeight);
                overviewMap.activateMap();
            } else {
                overviewMap.deactivateMap();
            }
            mapContainer.find(".summary-results").find(".cycling-box").not(".suspended-box").hover(function() {
                mapWrapper.addClass("hover");
                $(this).addClass("hover").siblings().removeClass("hover");
            });
        }
        function openFullScreenOverviewMap() {
            var $summaryBox = carouselWrap.find(".journey-option.always-visible"), $mainContainer = $(".full-map-container");
            $summaryBox.filter(function() {
                return this.getAttribute("aria-expanded") === "true";
            }).trigger("toggleExpandableBox");
            carouselWrap.cycle({
                slides: "> div.click-through",
                timeout: 0,
                fx: "none",
                allowWrap: false
            });
            tfl.fullscreen.display($mainContainer, false, true);
            var carouselItemHeight = $summaryBox.height(), desiredMapHeight = $(window).height() - carouselItemHeight, selectedIndex = overviewMap.selectedJourney ? overviewMap.selectedJourney : 0;
            overviewMapElement.height(desiredMapHeight);
            overviewMapElement.controller().divResized();
            overviewMap.chooseJourney(selectedIndex);
            carouselWrap.cycle("goto", selectedIndex);
            if (speedOption && speedOption.length) {
                speedOption.removeClass("visually-hidden");
            }
        }
        function closeFullScreenOverviewMap() {
            carouselWrap.cycle("destroy");
            tfl.fullscreen.removeElementsFromStage();
            if (!o.isLargeView()) {
                $(".journey-summary").unbind("click.routeDetails");
            }
            overviewMapElement.controller().divResized();
            if (speedOption && speedOption.length) {
                speedOption.addClass("visually-hidden");
            }
        }
        function setupDesktopEvents() {
            $("." + journeyType + "-box").hover(function(event, data) {
                var $this = $(this);
                overviewMap.selectedJourney = $this.data("journeyindex") ? $this.data("journeyindex") : 0;
                if (journeyType === "cycling") {
                    overviewMap.highlightJourney($this.data("journeyindex"));
                }
                event.preventDefault();
            });
        }
        function setupResizeEvents() {
            $(window).on("exitBreakpointLarge", function() {
                resetMap();
            }).on("enterBreakpointLarge", function() {
                resetMap();
            });
        }
        function createJourneyOverviewMap() {
            $.fixture.on = false;
            return $(".overview-map").tfl_maps_journey_planner_leg_map({
                url: $(".journey-results").data("api-uri"),
                isNationalBounds: tfl.getQueryParam("NationalSearch") === "true",
                mapDeactivated: function() {
                    if (!o.isLargeView()) {
                        closeFullScreenOverviewMap();
                    }
                },
                mapActivated: function() {
                    if (!o.isLargeView()) {
                        openFullScreenOverviewMap();
                    }
                },
                initiallyDeactivated: !o.isLargeView(),
                mapmode: journeyType,
                maxResults: 4
            });
        }
    };
    o.initResultsOverviewMapMobileControls = function() {
        var mapOptions = $("#mobile_overview_map_options"), nextBtn = $("button.next", mapOptions), prevBtn = $("button.last", mapOptions), journeyOptions = $("> div", mapOptions).not(".button-row"), journeyOptionsLength = $("div.summary-results > div[data-journeyindex]:visible").length, selectedIndex = 0;
        if (journeyOptionsLength === 1) {
            $(".button-row", mapOptions).hide();
            nextBtn.attr("disabled", true);
        }
        $(".summary-results").on("cycle-next", function(event, opts) {
            selectedIndex = overviewMap.selectedJourney;
            journeyOptions.hide();
            selectedIndex++;
            if (selectedIndex + 1 == overviewMap.legLayer.journeys.length) {
                nextBtn.attr("disabled", true);
            }
            journeyOptions.eq(selectedIndex).show();
            overviewMap.chooseJourney(selectedIndex);
        });
        $(".summary-results").on("cycle-prev", function(event, opts) {
            selectedIndex = overviewMap.selectedJourney;
            journeyOptions.hide();
            selectedIndex--;
            if (selectedIndex < 1) {
                prevBtn.attr("disabled", true);
            }
            journeyOptions.eq(selectedIndex).show();
            overviewMap.chooseJourney(selectedIndex);
        });
        nextBtn.click(function() {
            prevBtn.attr("disabled", false);
            journeyOptions.hide();
            selectedIndex++;
            if (selectedIndex + 1 == journeyOptionsLength) {
                nextBtn.attr("disabled", true);
            }
            journeyOptions.eq(selectedIndex).show();
            overviewMap.chooseJourney(selectedIndex);
        });
        prevBtn.click(function() {
            nextBtn.attr("disabled", false);
            journeyOptions.hide();
            selectedIndex--;
            if (selectedIndex < 1) {
                prevBtn.attr("disabled", true);
            }
            journeyOptions.eq(selectedIndex).show();
            overviewMap.chooseJourney(selectedIndex);
        });
    };
    o.initIE7 = function() {
        $(".cancel-button, .toggle-options, .edit-button").on("click", function() {
            var row = $(".journey-form").parents(".r").next();
            row.attr("class", row.attr("class"));
        });
    };
    o.triggerMapLink = function(el) {
        tfl.logs.create("tfl.journeyPlanner.results: trigger click on map link");
        el.trigger("click", {
            isHideAll: true
        });
    };
    o.setupLoader = function(loaderClass) {
        var bg = $('<div id="loader-background"></div>'), bird = $('<div id="loader-birds"></div>'), trees = $('<div id="loader-trees"></div>'), tSegment = $('<div class="tree-segment"></div>'), i;
        for (i = 0; i < 8; i++) {
            trees.append(tSegment.clone());
        }
        var transport = $('<div id="loader-transport-method"></div>'), grass = $('<div id="loader-grass"></div>'), gSegment = $('<div class="grass-segment"></div>');
        for (i = 0; i < 18; i++) {
            grass.append(gSegment.clone());
        }
        var message = $('<div id="loader-message">Fetching results</div>');
        $("#loader-window").addClass(loaderClass).append(bg).append(trees).append(bird).append(transport).append(grass).append(message);
    };
    o.scrollIntoView = function(eleID) {
        if (!!eleID && eleID.scrollIntoView) {
            eleID.scrollIntoView();
        }
    };
    o.processResults = function(isMapRequired) {
        var mapContainer = $(".full-map-container"), $overviewMap = $(".overview-map"), $overviewMapContainer = $overviewMap.parent();
        if ($(".summary-results").hasClass("cycling") || $(".summary-results").hasClass("walking")) {
            $(".stop-list.all-stops.text-instructions-list").removeClass("hidden");
            $(".show-all-hide-all-streetview").removeClass("hidden");
            if ($(".summary-results").hasClass("walking")) {
                $("a.text-instructions-link").text(tfl.dictionary.HideTextInstructions).addClass("hide");
            }
        }
        $(".full-screen-streetview").on("click", o.fullScreenStreetViewClick);
        $(".close-streetview").click(o.closeStreetView);
        $(".show-streetview-link").click(o.streetViewLinkClick);
        $("a.all-streetview-toggle").click(o.toggleAllStreetView);
        $(".accessibility-station-info").on("click", function() {
            var accessibilityInfo = $(this).parent().next("div"), $this = $(this);
            if (accessibilityInfo.hasClass("hidden")) {
                $this.parents(".content").removeClass("expanded");
                accessibilityInfo.removeClass("hidden");
            } else {
                $this.parents(".content").addClass("expanded");
                accessibilityInfo.addClass("hidden");
            }
        });
        var supportsPushState = !!(window.history && window.history.pushState);
        $(".jp-ajax-button").click(function(e) {
            e.preventDefault();
            if (e.originalEvent) {
                var eVar18_val = $(this).text().split(" ")[0];
                tfl.stats.tealiumTracking({
                    event_name: "jp_earlier_later",
                    jp_ealier_later: eVar18_val
                });
            }
            if ($(this).hasClass("block-ajax-call")) {
                return false;
            }
            mapContainer.addClass("hidden");
            $(".jp-result-transport, .cycling-walking-only-information").remove();
            $(".jp-result-transport, .journey-busy-stations-information").remove();
            $(".field-validation-errors").addClass("hidden");
            $("#loader-window-wrapper").append('<div class="r"><div id="loader-window"></div><div>');
            o.setupLoader("publictransport");
            var url = $(this).attr("href");
            var ajaxCallUrl = url.indexOf("isEarlierLaterAjaxCall=false") !== -1 ? url.replace("isEarlierLaterAjaxCall=false", "isEarlierLaterAjaxCall=true") : url + "&isEarlierLaterAjaxCall=true";
            var timeIndex = ajaxCallUrl.indexOf("Time=");
            var time = ajaxCallUrl.substring(timeIndex + 5, timeIndex + 9);
            time = time.substring(0, 2) + ":" + time.substring(2, 4);
            var dateIndex = ajaxCallUrl.indexOf("Date=");
            var date = ajaxCallUrl.substring(dateIndex + 5, dateIndex + 13);
            date = new Date(date.substring(0, 4), date.substring(4, 6) - 1, date.substring(6, 8));
            date = date.toDateString();
            if (supportsPushState) {
                history.pushState({
                    selectedJourney: url
                }, "", url);
            }
            $.ajax({
                cache: false,
                async: true,
                type: "POST",
                url: ajaxCallUrl,
                success: function(response) {
                    ajaxSuccess(response, ".ajax-response");
                    var $dateTime = $(".summary-row.clearfix strong").last();
                    $dateTime.text(date + ", " + time);
                }
            });
        });
        if (supportsPushState) {
            $(window).on("popstate", function() {
                if (history.state) {
                    window.location.replace(history.state.selectedJourney);
                } else {
                    window.location.replace(window.location.href);
                }
            });
        }
        var summaryResults = $(".summary-results"), jpSearchForm = $("#jp-search-form");
        $(".back-to-link").click(o.unshowAllDetailedResults);
        var extraOptions = $(".journey-planner-results .extra-options").detach();
        extraOptions.appendTo($("#plan-a-journey").find(".travel-preferences"));
        $("#plan-a-journey").find(".travel-preferences .extra-options").removeClass("extra-options");
        var accessLink = '<a href=javascript:appendJPParams(this,"' + tfl.jPLandingPageUrl + '#more-options"); class="toggle-options more-options" role="tab" aria-controls="more-journey-options" aria-expanded="false">Edit preferences</a>';
        $(".edit-preferences").prepend(accessLink);
        $(".toggle-options").click(tfl.journeyPlanner.searchForm.toggleMoreOptions);
        jpSearchForm.addClass("jp-more-travel-options-results-page");
        var i = 1;
        if ($(".past-warning").length) {
            tfl.stats.tealiumTracking({
                event_name: "jp_info",
                jp_message: "Warning"
            });
        }
        if ($(".cycling-walking-only-information").length) {
            tfl.stats.tealiumTracking({
                event_name: "jp_info",
                jp_message: "Info"
            });
        }
        $(".past-warning").on("click", function() {
            $("#IsPastWarning").val("True");
            var currentTime = tfl.journeyPlanner.searchForm.getCurrentTime();
            $("#Time").val(currentTime);
            jpSearchForm.submit();
        });
        var jpMoreOptionsResultsPage = $(".jp-more-travel-options-results-page"), travelPreferences = $(".travel-preferences"), moreJourneyOptions = $("#more-journey-options");
        if (jpMoreOptionsResultsPage.hasClass("walking")) {
            jpMoreOptionsResultsPage.removeClass("walking");
            travelPreferences.addClass("walking");
        }
        if (jpMoreOptionsResultsPage.hasClass("cycling")) {
            jpMoreOptionsResultsPage.removeClass("cycling");
            travelPreferences.addClass("cycling");
        }
        if (jpTypeSelected.val() == "walking") {
            $(".walking", moreJourneyOptions).click();
        } else if (jpTypeSelected.val() == "cycling") {
            $(".cycling", moreJourneyOptions).click();
        } else {
            $(".publictransport", moreJourneyOptions).click();
        }
        if ($(".journey-details").length > 0) {
            $(".journey-time").addClass("no-map");
            if (tfl.journeyPlanner.recentJourneys.usingRecentJourneys) {
                var from = $("#From"), to = $("#To"), via = $("#Via");
                tfl.journeyPlanner.recentJourneys.saveJourney(from.attr("data-from-id"), from.attr("data-from-modes"), to.attr("data-to-id"), to.attr("data-to-modes"));
                tfl.journeyPlanner.recentSearches.saveSearch(from.val(), from.attr("data-from-id"), from.attr("data-from-modes"));
                tfl.journeyPlanner.recentSearches.saveSearch(to.val(), to.attr("data-to-id"), to.attr("data-to-modes"));
                if ($("#Via").val() !== "") {
                    tfl.journeyPlanner.recentSearches.saveSearch(via.val(), via.attr("data-via-id"), via.attr("data-via-modes"));
                }
            }
            tfl.stats.tealiumTracking({
                event_name: "jp_result_success"
            });
        } else {
            tfl.stats.tealiumTracking({
                event_name: "jp_info",
                jp_message: "Error"
            });
        }
        $(".disruption-summary-container .message-toggle, .journey-steps .message-toggle").on("click", function() {
            var $this = $(this), statusId = $this.data("link"), statusLinkToOpen = $.map($(".journey-detail-step .line-status .message-toggle"), function(x, i) {
                if ($(x).data("link") == statusId) {
                    return $(x);
                }
            })[0];
            $(statusLinkToOpen).click();
            if ($(this).parent().parent().parent().parent().hasClass("journey-steps")) {
                $(this).parents(".summary").find(".show-detailed-results.view-hide-details").click();
            }
            $("html, body").animate({
                scrollTop: $(statusLinkToOpen.closest(".journey-detail-step")).offset().top
            }, 200);
        });
        $(".show-detailed-results.view-hide-details, .jp-additional-info-text").click(o.viewDetailsClick);
        o.expandableBoxes = $(".summary-results").find(".expandable-box");
        $(".json-all-stops").click(o.showAllStops);
        $(".text-instructions-link").click(o.showTextInstructions);
        $(".disruption-heading").append('<span class="link-style show-details">Show details...</span><span class="link-style hide-details">Hide details...</span>');
        $(".accessibility-details").append('<div class="show-hide-links"><a href="javascript:void(0)" class="show-link">Show details...</a><a href="javascript:void(0)" class="hide-link">Hide details...</a></div>');
        $(".show-hide-links a").on("click", function(e) {
            $(".accessibility-details").toggleClass("expanded");
            e.preventDefault();
        });
        $(".show-hide-fare-caveats").click(function(e) {
            $(this).siblings(".conditional-caveats").toggleClass("visually-hidden");
            if (this.innerText.toLowerCase() === this.getAttribute("data-default-text").toLowerCase()) this.innerText = this.getAttribute("data-expanded-text"); else {
                this.innerText = this.getAttribute("data-default-text");
            }
            e.preventDefault();
        });
        $(".show-detailed-results.view-hide-details").hover(function() {
            $(this).closest(".always-visible").toggleClass("hover");
        });
        if (isMapRequired === false) {
            o.journeyViewControl();
            $(".journey-planner-results .journey-results .expandable-box .content").addClass("no-map");
            $(".journey-planner-results .journey-results").addClass("no-map");
        }
    };
    o.loadGoogleAPI = function() {
        if (typeof google === "undefined") {
            $.getScript("https://maps.googleapis.com/maps/api/js?v=3&client=gme-transportforlondon&channel=jpstreetviewclickfirst");
        }
    };
    o.toggleAllStreetView = function() {
        var $thisTextInstructionsList = $(this).parent().closest(".journey-details"), $showStreetViewLinks = $thisTextInstructionsList.find(".show-streetview-link > a"), $streetViewImages = $thisTextInstructionsList.find(".streetview-image"), $cyclingWalkingHeadingContainer = $(".cycling-walking-instruction-heading", $thisTextInstructionsList), hideText = $showStreetViewLinks.first().data("hideText"), showText = $showStreetViewLinks.first().data("showText"), showAll = function() {
            o.loadGoogleAPI();
            $cyclingWalkingHeadingContainer.addClass("streetview-showing");
            $showStreetViewLinks.text(hideText);
            if ($(".is-cycle-hire").length) {
                $streetViewImages.addClass("full-width").show();
            } else {
                $streetViewImages.css("width", "100%").show();
            }
            $.each($(".streetview-image"), function(i, x) {
                o.getSingleStreetView($(x));
            });
        }, hideAll = function() {
            $cyclingWalkingHeadingContainer.removeClass("streetview-showing");
            $showStreetViewLinks.text(showText);
            $streetViewImages.removeClass("full-width").hide();
        };
        toggleLinkTextAndCallback($(this), showAll, hideAll);
        return false;
    };
    o.streetViewLinkClick = function() {
        var expand = function() {
            var $imgContainer = $this.parent().find(".streetview-image");
            o.getSingleStreetView($imgContainer);
            var image = $(".streetview-image", $($this.parents(".stop-link")));
            image.show();
            $("img", image).addClass("full-width");
            $this.parent().siblings(".cycling-walking-instruction-heading").addClass("streetview-showing");
        }, collapse = function() {
            $(".streetview-image", $($this.parents(".stop-link"))).hide();
            $this.parent().siblings(".cycling-walking-instruction-heading").removeClass("streetview-showing");
        };
        window.tfl.stats.tealiumTracking({
            event_name: "jp_street_view_interaction"
        });
        o.loadGoogleAPI();
        var $this = $(this);
        toggleLinkTextAndCallback($this.find("a"), expand, collapse);
        return false;
    };
    o.getSingleStreetView = function($imgContainer) {
        if (!$("img", $imgContainer).length) {
            tfl.ajax({
                url: streetviewUrl,
                data: {
                    lat: $imgContainer.find(".streetviewLat").val(),
                    lng: $imgContainer.find(".streetviewLon").val(),
                    heading: $imgContainer.find(".skyDirection").val()
                },
                success: function(response) {
                    $imgContainer.find(".streetviewLat").before('<img src="' + response.streetviewUrl + '"/>');
                }
            });
        }
    };
    o.closeStreetView = function() {
        $fullScreenPanoramaContainer.hide();
        return false;
    };
    o.fullScreenStreetViewClick = function() {
        var $fullScreenPanorama = $("#streetview-panorama");
        $fullScreenPanoramaContainer.show();
        var $this = $(this), streetviewId = $this.parent().next("div").prop("id"), lat = parseFloat($(".streetviewLat", $this.parent()).val()), lon = parseFloat($(".streetviewLon", $this.parent()).val()), direction = parseInt($(".skyDirection", $this.parent()).val()), streetviewPanorama = new google.maps.StreetViewPanorama($fullScreenPanorama[0], {
            position: {
                lat: lat,
                lng: lon
            },
            pov: {
                heading: direction,
                pitch: 0,
                zoom: 0
            }
        });
        return false;
    };
    o.journeyViewControl = function() {
        var summaryResults = $(".summary-results"), nonBusJourneys = summaryResults.find(".not-bus.publictransport-box");
        if (!nonBusJourneys.length) {
            nonBusJourneys = summaryResults.find(".not-bus.public-transport-cycling");
        }
        var $busJourney = summaryResults.find(".bus.publictransport-box");
        if (!$busJourney.length) {
            $busJourney = summaryResults.find(".bus.public-transport-cycling");
        }
        var otherOptions = $(".extra-journey-options"), firstJourney = $(nonBusJourneys[0]), lastJourney = $(nonBusJourneys).last(), otherJourneys = $(nonBusJourneys).filter(function(index) {
            if (this !== firstJourney[0] && this !== lastJourney[0]) {
                return this;
            }
        });
        firstJourney.addClass("show-me");
        for (var i = 0; i < firstJourney.siblings(".not-bus.publictransport-box").length - 1; i++) {
            $(firstJourney.siblings(".not-bus.publictransport-box")[i]).find(".travel-info-box").addClass("hide-buttons").siblings(".earlier-later").remove();
        }
        var $journeyButtons = firstJourney.find(".earlier-later"), firstJourneyLater = $journeyButtons.children(".later"), $otherJourneyButtons = otherJourneys.find(".earlier-later");
        firstJourneyLater.addClass("block-ajax-call");
        firstJourney.find(".show-detailed-results.view-hide-details").one("click", function(e) {
            var $this = $(this);
            $this.removeClass("block-ajax-call");
            processJourneyClick();
        });
        lastJourney.find(".earlier-later").children(".later").on("click", function(e) {
            $("body").removeClass("showing-full-details");
        });
        lastJourney.find(".earlier-later").children(".earlier").on("click", function(e) {
            $("body").removeClass("showing-full-details");
        });
        if (firstPageLoad) {
            $busJourney.find(".show-detailed-results.view-hide-details").one("click", function(e) {
                var journeyWrap = summaryResults.parents(".journey-results");
                for (var i = 0, len = nonBusJourneys.length; i < len; i += 1) {
                    $(nonBusJourneys).eq(i).removeClass("show-me").css("display", "none");
                }
                journeyWrap.children("h2").remove();
                otherOptions.find(".fastest-by-public-transport").css("display", "block");
                if ($(".no-dynamic-options").hasClass("left-journey-options")) {
                    $(".no-dynamic-options").removeClass("left-journey-options").addClass("right-journey-options");
                }
                $("h2.inner-heading").prependTo(journeyWrap);
            });
            $busJourney.find(".earlier-later").children(".later").one("click", function(e) {
                $("body").removeClass("showing-full-details");
            });
            $busJourney.find(".earlier-later").children(".earlier").one("click", function(e) {
                $("body").removeClass("showing-full-details");
            });
        }
        firstJourneyLater.on("click", function(e) {
            e.preventDefault();
            var $this = $(this);
            $this.removeClass("block-ajax-call");
            processJourneyClick();
        });
        function processJourneyClick() {
            var noDynamicOptions = $(".no-dynamic-options");
            if ($(".publictransport-box").length > 1) {
                $journeyButtons.siblings(".travel-info-box").addClass("hide-buttons").end().remove();
                $otherJourneyButtons.siblings(".travel-info-box").addClass("hide-buttons").end().remove();
            }
            nonBusJourneys.not(firstJourney).addClass("show-me");
            $busJourney.hide().prev("h2").hide();
            otherOptions.find(".journey-box.bus-only").css("display", "block");
            if (noDynamicOptions.hasClass("left-journey-options")) {
                noDynamicOptions.removeClass("left-journey-options").addClass("right-journey-options");
            }
        }
        if (!firstPageLoad || $("#NoJourneyHiding").val() === "True") {
            firstJourneyLater.click();
        }
    };
    o.viewDetailsClick = function(e) {
        var $viewDetails = $(this), journeyType = getJourneyType($(e.target)), $journeyDetails = $viewDetails.parents(".start-hidden.summary").find(".journey-details"), $stopsLocationTime = $journeyDetails.find(".stop-location-and-time"), $stopLocationDescription = $journeyDetails.find(".stop-location-description"), $stepDescription = $journeyDetails.find(".description"), $refrence = $viewDetails.parentsUntil(".expandable-box").parent(), $accessibilityDetails = $viewDetails.parents(".journey-details").siblings(".accordion").find(".accessibility-detail").first(), $fareDetails = $viewDetails.parents(".journey-details").siblings(".accordion").find(".fare-detail").first(), $fareCaveats = $fareDetails.find(".fare-caveats"), $accessibilityInfos = $viewDetails.parents(".journey-details").find(".journey-detail-step .access-information"), $lastJourneyStep = $viewDetails.parents(".journey-details").find(".journey-detail-step").last(), expand = function() {
            $stopLocationDescription.toggleClass("visually-hidden", true);
            $stopsLocationTime.toggleClass("visually-hidden", false);
            $stepDescription.toggleClass("visually-hidden", false);
            $accessibilityDetails.toggleClass("visually-hidden", false);
            $accessibilityInfos.toggleClass("visually-hidden", false);
            $fareDetails.toggleClass("visually-hidden", false);
            $lastJourneyStep.toggleClass("visually-hidden", false);
        }, collapse = function() {
            $stopLocationDescription.toggleClass("visually-hidden", false);
            $stopsLocationTime.toggleClass("visually-hidden", true);
            $stepDescription.toggleClass("visually-hidden", true);
            $accessibilityDetails.toggleClass("visually-hidden", true);
            $accessibilityInfos.toggleClass("visually-hidden", true);
            $fareDetails.toggleClass("visually-hidden", true);
            $lastJourneyStep.toggleClass("visually-hidden", true);
        };
        var $parentExpandableBoxes = $viewDetails.parents(".expandable-box");
        var idx = $.inArray($parentExpandableBoxes.get(0), o.expandableBoxes);
        if (idx === -1) {
            idx = 0;
        }
        if ($parentExpandableBoxes.length) {
            toggleLinkTextAndCallback($viewDetails, expand, collapse);
            o.scrollIntoView($parentExpandableBoxes.get(0));
            if (isDetailsSectionToggled(e.target)) {
                tfl.stats.tealiumTracking({
                    event_name: "jp_view_detail",
                    jp_view_details_type: journeyType
                });
            }
            return false;
        }
        if (idx !== o.currentlyShowing) {
            o.showDetailedResults(idx);
        } else {
            o.currentlyShowing = null;
        }
        $("#cycling-info-panel .close3-icon").click();
        if (e.target.textContent.toLowerCase().indexOf("view") >= 0) {
            if ($refrence.hasClass("bus")) {
                eVar17_Val = $refrence.prev(".jp-result-transport").text();
            } else {
                eVar17_Val = $refrence.parentsUntil(".full-map-container").parent().prev(".jp-result-transport").text();
            }
            tfl.stats.tealiumTracking({
                event_name: "jp_view_detail",
                jp_view_details_type: eVar17_Val
            });
        }
        e.stopPropagation();
        return false;
    };
    o.showDetailedResults = function(idx) {
        var mapParent = $(".overview-map"), desiredHeight = "auto", fullResultsContainer = $(".full-results-container");
        if (o.isLargeView()) {
            mapParent = mapParent.parent();
            desiredHeight = $(".full-map-container").find(".summary-results").height() - 2;
        }
        mapParent.css("display", "none");
        tfl.logs.create("tfl.journeyPlanner.results: Show detailed results. Index: " + idx);
        var expandableBoxes = o.expandableBoxes;
        o.currentlyShowing = idx;
        expandableBoxes.removeClass("selected").addClass("not-selected");
        var parentBox = $(expandableBoxes[idx]), nextParentBox = $(expandableBoxes[idx + 1]), lastParentBox = $(expandableBoxes[expandableBoxes.length - 1]), link = parentBox.find(".show-detailed-results.view-hide-details:visible"), showDetailedResults = ".show-detailed-results.view-hide-details";
        $(lastParentBox).find(showDetailedResults).attr("data-jumpto", ".earlier:tabbable:first").addClass("last-show-details");
        parentBox.removeClass("not-selected").addClass("selected");
        $(showDetailedResults).text($(showDetailedResults).data("showText"));
        $(parentBox).find(showDetailedResults).text($(showDetailedResults).data("hideext")).addClass("hide-details");
        $(nextParentBox).find(showDetailedResults).addClass("next-show-details");
        $(parentBox).find(showDetailedResults).attr("data-jumpto", ".journey-details :tabbable:first:visible").removeClass("last-show-details");
        $(expandableBoxes[o.currentlyShowing]).children(".content").children(".start-hidden").appendTo(".full-results-container").end().show();
        var streetviewLinks = $(".show-streetview-link", fullResultsContainer), streetviewLat = $(".streetviewLat", fullResultsContainer).val(), streetviewLon = $(".streetviewLon", fullResultsContainer).val(), streetviewSky = $(".skyDirection", fullResultsContainer).val();
        if (streetviewLinks.length && streetviewLat && streetviewLon && streetviewSky) {
            $(streetviewLinks[0]).click();
        }
        fullResultsContainer.removeClass("hidden").addClass($("#JpType").val());
        $("> .suspended-docking-station-list", fullResultsContainer).css("minHeight", desiredHeight);
        $(document.body).addClass("showing-full-details");
        var detailsTop = fullResultsContainer.offset().top;
        $(".journey-details :tabbable:first").focus();
        var steps = fullResultsContainer.find(".journey-detail-step");
        if ($("#IsMapRequired").val() == "False") {
            $(".summary .journey-steps").hide();
            $(".showing-full-details .journey-planner-results .auto-expand .always-visible").addClass("no-map");
            $("html, body").animate({
                scrollTop: $(".summary-results").offset().top
            }, 100);
        } else {
            $("html, body").animate({
                scrollTop: detailsTop - 10
            });
        }
        return false;
    };
    o.unshowAllDetailedResults = function() {
        var mapParent = $(".overview-map"), showDetailedResults = $(".show-detailed-results.view-hide-details"), jsonAllStops = $(".json-all-stops"), expandableBoxes = o.expandableBoxes, fullResultsContainer = $(".full-results-container");
        if (o.isLargeView()) {
            mapParent = $("#overview_map").parent();
        }
        mapParent.css("display", "block");
        tfl.logs.create("tfl.journeyPlanner.results: Unshow all detailed results.");
        fullResultsContainer.addClass("hidden");
        $("> .start-hidden", fullResultsContainer).insertAfter($(expandableBoxes[o.currentlyShowing]).find(".content .always-visible"));
        showDetailedResults.text(showDetailedResults.data("showText"));
        showDetailedResults.removeClass("hide-details");
        showDetailedResults.removeClass("next-show-details");
        showDetailedResults.attr("data-jumpto", "");
        expandableBoxes.removeClass("not-selected selected");
        $(document.body).removeClass("showing-full-details");
        jsonAllStops.text(jsonAllStops.data("showText")).parent().siblings(".all-stops").hide();
        if ($("#IsMapRequired").val() == "False") {
            $(".journey-planner-results .auto-expand .always-visible").addClass("no-map");
            $(".line-information .always-visible").css("width", "100%");
            $(".summary-results .expandable-box table.journey-steps").css("display", "block");
            $(".journey-planner-results .journey-results .expandable-box .content").addClass("no-map");
            $(".overview-map").remove();
        }
        if (!o.isLargeView()) {
            o.currentlyShowing = null;
            $(".show-detailed-results.view-hide-details").click(o.viewDetailsClick);
        }
        return false;
    };
    o.showAllStops = function() {
        var $linkClicked = $(this), $stopList = $linkClicked.parents(".instructions").first().find(".all-stops"), $stepHeading = $linkClicked.parents(".journey-detail-step").first(), $stopLocationTime = $stepHeading.find(".journey-detail-step"), $stepDescription = $stepHeading.find(".description"), trackingItem = {}, expand = function() {
            $linkClicked.attr("aria-expanded", "true");
            $stopList.toggleClass("hidden", false);
        }, collapse = function() {
            $linkClicked.attr("aria-expanded", "false");
            $stopList.toggleClass("hidden", true);
        };
        if (tfl.stats.tealiumTracking && !/^hide/gi.test($linkClicked.text())) {
            trackingItem[tfl.dictionary.TrackingEvent.Name] = tfl.dictionary.TrackingEvent.JourneyPlannerResultsInteraction_prop35;
            trackingItem[tfl.dictionary.TrackingProp.JourneyPlannerResultsInteractionDetail_35.Name] = $linkClicked.text();
            tfl.stats.tealiumTracking(trackingItem);
        }
        toggleLinkTextAndCallback($linkClicked, expand, collapse);
        return false;
    };
    o.showTextInstructions = function() {
        var linkClicked = $(this), els = linkClicked.parents(".instructions").first().find(".text-instructions-list"), expand = function() {
            els.show();
            linkClicked.parents(".instructions").first().find(".show-all-hide-all-streetview").removeClass("hidden");
        }, collapse = function() {
            els.hide();
            linkClicked.parents(".instructions").first().find(".show-all-hide-all-streetview").addClass("hidden");
        };
        toggleLinkTextAndCallback(linkClicked, expand, collapse);
        linkClicked.parents(".instructions").first().find(".text-instructions-list").toggleClass("hidden");
        return false;
    };
    o.resultsFormInit = function() {
        tfl.logs.create("tfl.journeyPlanner.results: resultsFormInit started");
        var btnJP = $(".plan-journey-button"), fromSearchField = $("#search-filter-form-0"), toSearchField = $("#search-filter-form-1"), typeaheadJP = $(".journey-form .twitter-typeahead");
        btnJP.wrap("<div class='update-buttons-container clearfix'><div class='clearfix update-buttons' />").before("<input type='button' class='secondary-button cancel-button' value='Cancel' />");
        btnJP.val("Update journey").submit(function() {
            $(".cancel-button").remove();
        });
        $(".plan-journey-button-second").val("Update journey");
        tfl.journeyPlanner.searchForm.buildSwitchButton();
        $(".switch-button").click(tfl.journeyPlanner.searchForm.switchFromTo);
        if (fromSearchField) {
            typeaheadJP.add(fromSearchField).add(toSearchField).hide();
        }
        var isTouch = tfl.utils.isTouchDevice();
        if ($("#From").val() !== "" && $("#To").val() !== "") {
            var touchClass = "";
            if (isTouch) {
                touchClass = " touch";
            }
            var journeyResultSummary = $("<div class='journey-result-summary" + touchClass + "' ><div class='from-to-wrapper'></div></div>");
            journeyResultSummary.children(".from-to-wrapper").append("<div class='summary-row clearfix'><span class='label'>From:</span><span class='notranslate'><strong>" + $("#From").val() + "</strong></span></div>");
            journeyResultSummary.children(".from-to-wrapper").append("<div class='summary-row clearfix'><span class='label'>To:</span><span class='notranslate'><strong>" + $("#To").val() + "</strong></span></div>");
            var leavingOrArriving = $(".leaving-or-arriving li.selected").text().replace(/^\s+|\s+$/g, "");
            var timeText = $("#DateTimePlaceHolder").val();
            var travelPrefsText = "";
            var via = $("#Via").val();
            if (via !== "") {
                travelPrefsText += "<strong class='via-destination'>Via " + via + "</strong> ";
            }
            travelPrefsText += '<strong class="travelpreferences-cycling">' + $("#CycleTypePlaceHolder").val() + "</strong>";
            travelPrefsText += '<strong class="travelpreferences-walking">' + $("#WalkingSpeedPlaceHolder").val() + " walking speed</strong>";
            travelPrefsText += '<strong class="travelpreferences-publictransport">Showing ' + $("#JourneyPreferencePlaceHolder").val() + "</strong> ";
            var using = $(".modes-of-transport option:selected");
            travelPrefsText += '<strong class="travelpreferences-publictransport">Using ' + $("#ModeChoicePlaceHolder").val() + "</strong> ";
            var accessibilityPref = $("#AccessibilityPreferencePlaceHolder").val();
            if (accessibilityPref && accessibilityPref !== "" && accessibilityPref.toLowerCase() !== "norequirements") {
                travelPrefsText += '<strong class="travelpreferences-publictransport">Step free access required</strong> ';
            }
            travelPrefsText += '<strong class="travelpreferences-publictransport">Max walk time ' + $("#MaxWalkingMinutes").val() + " mins</strong>";
            journeyResultSummary.append("<div class='summary-row clearfix'><span class='label'>" + leavingOrArriving + ":</span><strong>" + timeText + "</strong></div>");
            addEditJourneyLink(journeyResultSummary);
            if (tfl.isLocalStorageSupported) {
                addFavouritesLink(journeyResultSummary);
            }
            $("#plan-a-journey").append(journeyResultSummary);
            $("#plan-a-journey").append("<div id='journey-summary-data' data-from='" + $("#From").val() + "' data-to='" + $("#To").val() + "' data-via='" + $("#Via").val() + "' />");
            $("#plan-a-journey").append("<div class='travel-preferences clearfix'><div class='left-shadow' /><div class='scroller'><div><div>Travel preferences & accessibility: </div>" + travelPrefsText + "</div></div><div class='right-shadow' /></div>");
        }
        if (isTouch) {
            tfl.journeyPlanner.travelPrefsInnerWidth = $(".scroller > div").get(0).scrollWidth;
            tfl.journeyPlanner.travelPrefsScrollMax = tfl.journeyPlanner.travelPrefsInnerWidth - $(".scroller").width();
            tfl.journeyPlanner.travelPrefsLeftShadow = $(".left-shadow");
            tfl.journeyPlanner.travelPrefsRightShadow = $(".right-shadow");
            $(".scroller").scroll(function() {
                var scrollLeft = $(this).scrollLeft();
                tfl.journeyPlanner.travelPrefsLeftShadow.css({
                    left: Math.min(0, -40 + scrollLeft)
                });
                tfl.journeyPlanner.travelPrefsRightShadow.css({
                    right: Math.min(0, tfl.journeyPlanner.travelPrefsScrollMax - scrollLeft - 40)
                });
            }).scroll();
            $(window).resize(function() {
                tfl.journeyPlanner.travelPrefsScrollMax = tfl.journeyPlanner.travelPrefsInnerWidth - $(".scroller").width();
                $(".scroller").scroll();
            });
        }
        $(".cancel-button").on("click", function() {
            $(".toggle-options.less-options").click();
            $("#plan-a-journey").removeClass("editing").parents(".r").removeClass("expanded");
            $(".journey-result-summary .secondary-button").focus();
            if (fromSearchField) {
                typeaheadJP.add(fromSearchField).add(toSearchField).hide();
            }
            undoSettingsForPersonalisation(true);
            return false;
        });
    };
    function addFavouritesLink(journeyResultSummary) {
        var favourites = tfl.storage.get(tfl.storage.storageKeys.favourites, {});
        var journeyFavourites = favourites.journey;
        var placeFavourites = favourites.place;
        var hasFromPlace;
        var hasToPlace;
        var hasJourney;
        var journeyStorageKey;
        var startLocation;
        var endLocation;
        var jpResult;
        var fromId;
        var toId;
        var journeyData = {
            from: $("#InputFrom").val(),
            fromId: $("#FromId").val(),
            to: $("#InputTo").val(),
            toId: $("#ToId").val(),
            via: $("#Via").val(),
            viaId: $("#ViaId").val(),
            mode: "journey",
            props: {
                from: null,
                fromId: null,
                fromNaptanId: null,
                to: null,
                toId: null,
                toNaptanId: null
            }
        };
        journeyStorageKey = journeyData.from + "|" + journeyData.to + "|" + journeyData.via;
        hasFromPlace = placeFavourites && placeFavourites.hasOwnProperty(journeyData.from);
        hasToPlace = placeFavourites && placeFavourites.hasOwnProperty(journeyData.to);
        hasJourney = journeyFavourites && journeyFavourites.hasOwnProperty(journeyStorageKey);
        if (journeyResultSummary.find(".favourite-tab").length) return;
        if (journeyData.from.toLowerCase().indexOf("current location") !== 0 && journeyData.to.toLowerCase().indexOf("current location") !== 0 && journeyData.via.toLowerCase().indexOf("current location") !== 0) {
            var journeyPlaceModes = "journey-place";
            var addFavourites = "<button type='button' id='fav-panel-save' class='favourite-tab fav-panel-save-button'><span class='align-text'>Add favourites</span></button>";
            var editFavourites = "<button type='button' id='fav-panel-save' class='favourite-tab fav-panel-save-button'><span class='align-text'>Edit favourites</span></button>";
            journeyResultSummary.find(".edit-journey").parent().append(hasFromPlace || hasToPlace || hasJourney ? editFavourites : addFavourites);
            $(".jp-results-headline, .last-breadcrumb").html(hasJourney ? "My journey" : "Journey results");
            if (!journeyData.fromId || !journeyData.toId) {
                journeyResultSummary.find(".favourite-tab").hide();
            }
            journeyResultSummary.find(".favourite-tab").on("click", function(e) {
                jpResult = $(".full-map-container .journey-details").first();
                if (!journeyData.fromId) {
                    startLocation = jpResult.find(".start-location").first();
                    fromId = startLocation.attr("data-icsid");
                    journeyData.fromId = fromId;
                    journeyData.props.fromId = fromId;
                } else {
                    startLocation = jpResult.find(".start-location[data-icsid='" + journeyData.fromId + "']");
                    journeyData.props.fromId = journeyData.fromId;
                }
                if (!journeyData.toId) {
                    endLocation = jpResult.find(".end-location").first();
                    toId = endLocation.attr("data-icsid");
                    journeyData.toId = toId;
                    journeyData.props.toId = toId;
                } else {
                    endLocation = jpResult.find(".end-location[data-icsid='" + journeyData.toId + "']");
                    journeyData.props.toId = journeyData.toId;
                }
                journeyData.props.from = startLocation.find("span").text();
                journeyData.props.to = endLocation.find("span").text();
                journeyData.props.fromNaptanId = startLocation.attr("data-naptanid");
                journeyData.props.toNaptanId = endLocation.attr("data-naptanid");
                if (tfl.stats.tealiumTracking) {
                    var propValue;
                    var pathName = window.location.pathname;
                    var whichPage;
                    if (pathName.indexOf("plan-a-journey") > 0) {
                        whichPage = "Plan a journey results";
                        var addOrEdit;
                        if ($(this).find("span").text().toLowerCase().indexOf("edit") >= 0) {
                            addOrEdit = "edit";
                        } else {
                            addOrEdit = "add";
                        }
                        propValue = whichPage + "|" + "my journeys - my places" + "|" + addOrEdit;
                        var trackingItem = {};
                        trackingItem[event.Name] = event.PersonalisationOpenPanel_prop41;
                        trackingItem[prop.OpenPanel_41.Name] = propValue;
                        trackingItem.newReturnUser = true;
                        tfl.stats.tealiumTracking(trackingItem);
                        trackingItem = {};
                        trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
                        trackingItem[evar.OpenEditPanel_25.Name] = propValue;
                        tfl.stats.tealiumTracking(trackingItem);
                    }
                }
                tfl.favourites.stateChangeEvaluator.setOldState([ tfl.modeJourney, tfl.modePlace ], true);
                tfl.favouritesPanel.editFavouritesPanel.openEditFavouritesPanel(journeyPlaceModes, null, false, journeyData);
            });
        }
    }
    function addEditJourneyLink(journeyResultSummary) {
        if (journeyResultSummary.find(".edit-journey").length) return;
        var editButton = $('<a href="javascript:void(0);" class="edit-journey"></a>').click(function(e) {
            handleJpResultsLoading();
            if ($("#search-filter-form-0")) {
                $("#search-filter-form-0").show();
                $("#search-filter-form-1").show();
                $(".journey-form .twitter-typeahead").show();
                $(".summary-row.clearfix strong").each(function(x) {
                    var locationText = $(this).text();
                    if (locationText.toLowerCase().indexOf("current location") !== -1) {
                        $(".journey-form .twitter-typeahead").removeAttr("data-current-location");
                    }
                    if (x === 0) {
                        $("#InputFrom").val(locationText);
                    }
                    if (x === 1) {
                        $("#InputTo").val(locationText);
                    }
                });
            }
            var viaDestination = $(".via-destination").text();
            if (viaDestination) {
                $("#InputVia").val(viaDestination.replace("Via ", ""));
            }
            $(".jp-search-form #JourneyType").val($("#JourneyTypePlaceHolder").val());
            e.preventDefault();
            $("#plan-a-journey").addClass("editing");
            doSettingsForPersonalisation(true);
            $("#From, #To, #Via").trigger("change");
            $("#InputFrom").focus();
        });
        $(editButton).append("<span>Edit journey</span>");
        journeyResultSummary.append($('<div class="summary-row clearfix"></div>').append(editButton));
    }
    function doSettingsForPersonalisation() {
        var editPrefs = $(".edit-preferences").detach();
        $(".travel-preferences").hide();
        var isMoreOptionsVisible = $("#more-journey-options").is(":visible");
        if (isMoreOptionsVisible) {
            editPrefs.insertAfter($(".basic-journey-options"));
        } else {
            editPrefs.insertAfter($("#plan-a-journey").find("fieldset .time-options"));
        }
        o.manageVisibilityOfUpdateButtons();
    }
    o.manageVisibilityOfUpdateButtons = function() {
        var isMoreOptionsVisible = $("#more-journey-options").is(":visible");
        var isEditingVisible = $(".editing").length === 1;
        if (isMoreOptionsVisible === false && isEditingVisible === false) {
            $("#plan-a-journey").find(".update-buttons").hide();
        } else if (isMoreOptionsVisible === true && isEditingVisible === false) {
            $("#plan-a-journey").find(".update-buttons").hide();
        } else if (isMoreOptionsVisible === false && isEditingVisible === true) {
            $("#plan-a-journey").find(".update-buttons").show();
        } else if (isMoreOptionsVisible === true && isEditingVisible === true) {
            $("#plan-a-journey").find(".update-buttons").hide();
        } else {
            $("#plan-a-journey").find(".update-buttons").show();
        }
    };
    function undoSettingsForPersonalisation() {
        var editPrefs = $(".edit-preferences").detach();
        editPrefs.appendTo($(".travel-preferences"));
        $(".travel-preferences").show();
        o.manageVisibilityOfUpdateButtons();
    }
    function toggleLinkTextAndCallback($elOrEvent, expandCallback, collapseCallback) {
        var $el = $elOrEvent, isEventCallback = $elOrEvent instanceof jQuery.Event;
        if (isEventCallback) {
            $el = $(this);
        }
        var showText = $el.data("showText"), hideText = $el.data("hideText");
        if ($el.text() === showText) {
            $el.text($el.data("hideText"));
            if (typeof expandCallback === "function") expandCallback.call($el);
        } else {
            $el.text($el.data("showText"));
            if (typeof collapseCallback === "function") collapseCallback.call($el);
        }
    }
    function bindEventHandlers() {
        $(".replan-journey").on("click", function() {
            $(".edit-journey").trigger("click");
            $(".journey-planner-results .headline-container").scrollintoview({
                duration: 1500,
                direction: "both",
                complete: function() {
                    return true;
                }
            });
            return true;
        });
        $(".jp-disruption-info-link").on("click", function() {
            var $disruptionLink = $(this), hidden = "hidden", $disruptionInfo = $disruptionLink.parents(".content").first().find(".jp-disruption-info");
            if ($disruptionInfo.hasClass(hidden)) {
                $disruptionInfo.toggleClass(hidden, false);
            } else {
                $disruptionInfo.toggleClass(hidden, true);
            }
        });
    }
    function toggleAccordion(e) {
        $(this).closest(".content").children(".always-visible").trigger("toggleExpandableBox");
        return true;
    }
    function sendDetailsSectionStats(e) {
        if (!e || !e.target || !isDetailsSectionToggled(e.target)) return false;
        var journeyType = $(".journey-planner-results .jp-result-transport").text(), trackingDetails = {
            event_name: "jp_view_detail",
            jp_view_details_type: journeyType
        };
        tfl.stats.tealiumTracking(trackingDetails);
        return true;
    }
    function isDetailsSectionToggled(targetElement) {
        var target = targetElement, text;
        if (typeof target === "string") {
            text = targetElement;
        } else {
            text = $(target).text();
        }
        return /^hide/gi.test(text);
    }
    function getJourneyType($targetElement) {
        if (!$targetElement && !$targetElement.length) return;
        var journeyType, $journeyContainer = $targetElement.parents(".expandable-box").first(), journeyContainerClasses = $journeyContainer.attr("class");
        if (/\sbus\s/gi.test(journeyContainerClasses) && /\spublictransport-box\s/gi.test(journeyContainerClasses)) {
            journeyType = $journeyContainer.prev(".jp-result-transport.inner-heading").text();
            return journeyType;
        }
        journeyType = $journeyContainer.parents(".journey-planner-results").find(".jp-result-transport").first().text();
        return journeyType;
    }
    function initCyclingWalkingSpecific() {
        var $header = $("h2.jp-result-transport"), isCycling = $header.hasClass("cycling"), isWalking = $header.hasClass("walking");
        if (!isCycling && !isWalking) return;
        var largeLinksClass = ".walking-cycling-large-instructions", smallLinksClass = ".walking-cycling-small-instructions", showClass = ".instructions-show", hideClass = ".instructions-hide", $showLinks = $(smallLinksClass + showClass), $hideLinks = $(smallLinksClass + hideClass), showText, hideText, $largeLinks = $(largeLinksClass), $topLevelAccordions = $(".carousel-wrap > .expandable-box > .content > .always-visible"), $map = $("#overview_map"), extraCycleInfoClass = ".extra-cycle-info";
        setSmallLinksText();
        bindCyclingWalkingSpecificEventHandlers();
        setView();
        function setSmallLinksText() {
            var $firstSmallLink = $showLinks.first(), showText = $firstSmallLink.data("showText"), hideText = $firstSmallLink.data("hideText");
            $showLinks.text(showText);
            $hideLinks.text(hideText);
        }
        function setView() {
            var isLargeView = o.isLargeView();
            if (isLargeView && isWalking) {
                $topLevelAccordions.trigger("click.expandableBox");
            }
            if (!isLargeView && isCycling) {
                showMap(false);
            }
        }
        function setHideInstructionText(e) {
            var $target = $(e.target), currentText = $target.text();
            if (/^hide/gi.test(currentText)) {
                $target.text($target.data("showText"));
            } else {
                $target.text($target.data("hideText"));
            }
            return true;
        }
        function bindCyclingWalkingSpecificEventHandlers() {
            var accordionClass = ".always-visible", expandEvent = "expandable-box.expanded", collapseEvent = "expandable-box.collapsed", toggleEvents = expandEvent + " " + collapseEvent, carouselWrap = $(".carousel-wrap");
            $topLevelAccordions.off("click.expandableBox");
            $(".journey-details").off("click.journeydetails.toggleAccordion").on("click.journeydetails.toggleAccordion", toggleAccordion);
            $(showClass).off("click.instructions.toggleAccordion").on("click.instructions.toggleAccordion", toggleAccordion);
            $(hideClass).off("click.instructions.hide").on("click.instructions.hide", setHideInstructionText);
            $(showClass).off("click.instructions.sendStats").on("click.instructions.sendStats", sendDetailsSectionStats);
            $(smallLinksClass + showClass).closest(accordionClass).on(expandEvent, scrollToDirectionsOnFullScreenMap).on(toggleEvents, function() {
                toggleLinkTextAndCallback($(this).find(smallLinksClass + showClass));
            });
            $(largeLinksClass + showClass).closest(accordionClass).on(toggleEvents, function() {
                toggleLinkTextAndCallback($(this).find(largeLinksClass + showClass));
            });
            $showLinks.on("click.small-links.update-text", function(e) {
                var $target = $(e.target), showLinkText = $target.text(), hideLink = $target.closest(".expandable-box").find(".journey-details " + smallLinksClass + hideClass);
                hideLink.text(showLinkText);
            });
            $(".suspended-docking-station-list-button").on("click", toggleAccordion).closest(accordionClass).on(toggleEvents, function() {
                toggleLinkTextAndCallback($(this).find(".suspended-docking-station-list-button"));
            });
            $("#cycling-info-panel .close3-icon").on("click", function() {
                $("#cycling-info-panel").hide();
            });
            $(window).on("exitBreakpointLarge", setView).on("enterBreakpointLarge", setView);
            if (isCycling) {
                $(".cycling-map-view").on("click", showMobileFullScreenMap);
            }
            $topLevelAccordions.on(collapseEvent, scrollToTopOnResultCollapse);
            $(".option-button").on("click", selectSpeedOption);
            function selectSpeedOption(event) {
                var $this = $(this), buttons = $this.parent().children(), $currentToggleDirectionsBtn = $(".cycle-slide-active .walking-cycling-small-instructions.instructions-show");
                if ($currentToggleDirectionsBtn.text() === $currentToggleDirectionsBtn.data("hideText")) {
                    $currentToggleDirectionsBtn.click();
                }
                var selectedClassName = "btn-pressed", selectedIndex = $this.index();
                $(buttons).removeClass(selectedClassName);
                $this.addClass(selectedClassName);
                overviewMap.chooseJourney(selectedIndex);
                carouselWrap.cycle("goto", selectedIndex);
                return false;
            }
            function scrollToDirectionsOnFullScreenMap() {
                if (!o.isLargeView()) {
                    $(this).closest(".content")[0].scrollIntoView();
                }
            }
            function showMobileFullScreenMap() {
                var speedOptionIndex = $(this).data("journeyindex"), $speedOptionToClick = $($(".option-button")[speedOptionIndex]);
                showMap(true);
                overviewMap.activateMap();
                $speedOptionToClick.click();
                return false;
            }
            function scrollToTopOnResultCollapse() {
                if (o.isLargeView()) {
                    $("h1")[0].scrollIntoView();
                } else {
                    $(this)[0].scrollIntoView();
                }
            }
        }
        function showMap(isShowMap) {
            $map.toggleClass("hide-map", !isShowMap);
        }
    }
})(window.tfl.journeyPlanner.results = window.tfl.journeyPlanner.results || {});

window.tfl.journeyPlanner = window.tfl.journeyPlanner || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner.disambiguation: loaded");
    o.init = function() {
        tfl.logs.create("tfl.journeyPlanner.disambiguation: initialised");
        var disambiguations = $(".disambiguation-wrapper");
        var numDisambiguations = disambiguations.length;
        var i = 0;
        if (numDisambiguations > 0) {
            $(".disambiguation-extras").prepend("<div class='pagination' />");
            $(".disambiguation-box").each(function() {
                var eVar5_Val = $(this).find(".info-message").find("span strong").text();
                tfl.stats.tealiumTracking({
                    event_name: "jp_disambiguation",
                    jp_disambiguation_input: eVar5_Val
                });
                var numItems = $(this).find(".disambiguation-option").length;
                if (numItems > tfl.journeyPlanner.settings.disambiguationItemsPerPage) {
                    tfl.navigation.pagination.setup($(this), ".disambiguation-items", tfl.journeyPlanner.settings.disambiguationItemsPerPage, numItems, true);
                }
                var wrapper = $(this).parents(".disambiguation-wrapper");
                var isFrom = wrapper.hasClass("from-results");
                if (isFrom) {
                    $(".summary-row").eq(0).addClass("disambiguating");
                } else {
                    var isTo = wrapper.hasClass("to-results");
                    if (isTo) {
                        $(".summary-row").eq(1).addClass("disambiguating");
                    } else {
                        $(".via-destination").addClass("disambiguating");
                    }
                }
            });
        }
        $(".disambiguation-link").click(function() {
            var row = $(this).parents(".disambiguation-wrapper");
            if (row.hasClass("from-results")) {
                $("#InputFrom").val($(this).find(".place-name").text()).change();
                $("#From").val($(this).find(".place-name").text()).change();
                $("#FromId").val($(this).attr("data-param")).change();
                $("#disambiguation-map-from").html("");
            } else if (row.hasClass("to-results")) {
                $("#InputTo").val($(this).find(".place-name").text()).change();
                $("#To").val($(this).find(".place-name").text()).change();
                $("#ToId").val($(this).attr("data-param")).change();
                $("#disambiguation-map-to").html("");
            } else if (row.hasClass("via-results")) {
                $("#InputVia").val($(this).find(".place-name").text()).change();
                $("#Via").val($(this).find(".place-name").text()).change();
                $("#ViaId").val($(this).attr("data-param").change());
                $("#disambiguation-map-via").html("");
            }
            var next = row.next(".disambiguation-wrapper");
            if (next.length >= 1) {
                row.hide();
                next.show();
                next.find(".disambiguation-map").controller().divResized();
            } else {
                $("#jp-search-form").submit();
            }
            return false;
        });
        disambiguations.each(function() {
            if (i > 0) {
                $(this).hide();
            }
            i++;
        });
        tfl.mapInteractions.init();
        function setupMapInteractions(id, $options) {
            var mapObject = tfl.maps[id].googleMap;
            mapObject.on("optionChosen", function(option) {
                $options.find(".disambiguation-option[data-id='" + option.id + "'] .disambiguation-link")[0].click();
            });
            var $pagination = $options.parent().find(".pagination");
            if ($pagination.length) {
                tfl.navigation.pagination.addMapControls($pagination, mapObject.controller);
            }
        }
        $("#disambiguation-options-from, #disambiguation-options-to, #disambiguation-options-via").each(function() {
            var $this = $(this);
            if ($this.find(".disambiguation-option").length > 0) {
                var id = $(this).attr("id").replace("-options-", "-map-").replace("-", "");
                if (tfl.maps[id] !== undefined) {
                    setupMapInteractions(id, $this);
                } else {
                    $(window).on("map-object-created-" + id, function() {
                        setupMapInteractions(id, $this);
                    });
                }
            }
        });
    };
})(window.tfl.journeyPlanner.disambiguation = window.tfl.disambiguation || {});

window.tfl.journeyPlanner = window.tfl.journeyPlanner || {};

(function(o) {
    "use strict";
    tfl.logs.create("tfl.journeyPlanner.searchForm: loaded");
    o.widgetInit = function() {
        tfl.logs.create("tfl.journeyPlanner.searchForm: started widgetInit");
        $(".toggle-options, .change-departure-time").click(function(e) {
            var button = $(this);
            var href = button.attr("href");
            var uri = href.substr(0, href.indexOf("#"));
            var hash = href.substr(href.indexOf("#"));
            $.each([ "From", "To", "FromId", "ToId", "FromGeolocation", "ToGeolocation" ], function(k, v) {
                var val = $("#" + v).val();
                if (val !== undefined && val !== "") {
                    if (k === 0) uri += "?";
                    if (k > 0) uri += "&";
                    uri += v + "=" + val;
                }
            });
            button.attr("href", uri + hash);
        });
    };
    o.setupDateOptions = function() {
        var d = new Date();
        var mins = (15 - d.getMinutes() % 15) * 6e4;
        var secs = (60 - d.getSeconds() % 60) * 1e3;
        setTimeout(o.incrementCurrentTime, mins - secs);
    };
    o.processTempLocalStorage = function() {
        var tempJpLocalStorage = tfl.storage.get("tempJPLocalStorage", [ [] ]);
        if (tempJpLocalStorage.length > 0) {
            for (var i = 0; i < tempJpLocalStorage.length; i++) {
                var attribute = tempJpLocalStorage[i][0];
                var storageObject = tempJpLocalStorage[i][1];
                if (attribute === "ToId") {
                    $("#ToId").val(storageObject);
                } else if (attribute === "FromId") {
                    $("#FromId").val(storageObject);
                } else if (attribute === "ViaId") {
                    $("#ViaId").val(storageObject);
                } else if (attribute === "To") {
                    if (storageObject === tfl.dictionary.CurrentLocationText) {
                        tfl.geolocation.setupInputBoxForGeolocation($("#InputTo"));
                    } else {
                        $("#InputTo").val(storageObject);
                    }
                } else if (attribute === "From") {
                    if (storageObject === tfl.dictionary.CurrentLocationText) {
                        tfl.geolocation.setupInputBoxForGeolocation($("#InputFrom"));
                    } else {
                        $("#InputFrom").val(storageObject);
                    }
                } else if (attribute === "Via") {
                    if (storageObject === tfl.dictionary.CurrentLocationText) {
                        tfl.geolocation.setupInputBoxForGeolocation($("#InputVia"));
                    } else {
                        $("#InputVia").val(storageObject);
                    }
                } else {
                    $(attribute).attr(storageObject, tempJpLocalStorage[i][2]);
                }
            }
        }
    };
    o.submitSearchForm = function() {
        var fromEl = $("#From"), toEl = $("#To"), viaEl = $("#Via"), thisForm = $(this);
        if (fromEl.attr("data-from-id")) {
            if ($("#FromId").length === 0) {
                $(this).append("<input type='hidden' id='FromId' name='FromId' value='" + fromEl.attr("data-from-id") + "' />");
            } else {
                $("#FromId").val(fromEl.attr("data-from-id"));
            }
        }
        if (toEl.attr("data-to-id")) {
            if ($("#ToId").length === 0) {
                $(this).append("<input type='hidden' id='ToId' name='ToId' value='" + toEl.attr("data-to-id") + "' />");
            } else {
                $("#ToId").val(toEl.attr("data-to-id"));
            }
        }
        if (viaEl.attr("data-via-id")) {
            $(this).append("<input type='hidden' id='ViaId' name='ViaId' value='" + viaEl.attr("data-via-id") + "' />");
        }
        var tempJpLocalStorage = [ [] ];
        if (fromEl.attr("data-from-modes")) {
            tempJpLocalStorage.push([ "#From", "data-from-modes", fromEl.attr("data-from-modes") ]);
        }
        if (fromEl.attr("data-dataset-name")) {
            tempJpLocalStorage.push([ "#From", "data-dataset-name", fromEl.attr("data-dataset-name") ]);
        }
        if (toEl.attr("data-to-modes")) {
            tempJpLocalStorage.push([ "#To", "data-to-modes", toEl.attr("data-to-modes") ]);
        }
        if (toEl.attr("data-dataset-name")) {
            tempJpLocalStorage.push([ "#To", "data-dataset-name", toEl.attr("data-dataset-name") ]);
        }
        if (viaEl.attr("data-via-modes")) {
            tempJpLocalStorage.push([ "#Via", "data-via-modes", viaEl.attr("data-via-modes") ]);
        }
        if (viaEl.attr("data-dataset-name")) {
            tempJpLocalStorage.push([ "#Via", "data-dataset-name", viaEl.attr("data-dataset-name") ]);
        }
        if (tempJpLocalStorage.length > 0) {
            tfl.storage.set("tempJPLocalStorage", tempJpLocalStorage);
        }
        if (fromEl.val() !== tfl.dictionary.CurrentLocationText) {
            $("#FromGeolocation").val("");
        }
        if (toEl.val() !== tfl.dictionary.CurrentLocationText) {
            $("#ToGeolocation").val("");
        }
        if (viaEl.val() !== tfl.dictionary.CurrentLocationText) {
            $("#ViaGeolocation").val("");
        }
        if (thisForm.valid()) {
            thisForm.find("input, select").not("[data-send='true']").each(function() {
                $(this).attr("disabled", "disabled");
            });
        }
        return true;
    };
    o.incrementCurrentTime = function() {
        var today = new Date();
        var diffMs = today - o.getSelectedDate();
        var diffMins = Math.floor(diffMs / 6e4);
        if ($(".time-options.change-time").length === 0 && diffMins > 0) {
            o.setCurrentTime();
        }
        setTimeout(o.incrementCurrentTime, 9e5);
    };
    o.getSelectedDate = function() {
        var sDate = $("#Date option:selected").val();
        var sTime = $("#Time option:selected").val();
        return new Date(sDate.substring(0, 4), sDate.substring(4, 6) - 1, sDate.substring(6, 8), sTime.substring(0, 2), sTime.substring(2, 4));
    };
    o.getCurrentDate = function() {
        var d = new Date();
        var yyyy = d.getFullYear().toString();
        var mm = (d.getMonth() + 1).toString();
        var dd = d.getDate().toString();
        return yyyy + (mm[1] ? mm : "0" + mm[0]) + (dd[1] ? dd : "0" + dd[0]);
    };
    o.getCurrentTime = function() {
        var d = new Date();
        var mins = d.getMinutes();
        mins = mins = 0 ? mins : mins + (15 - mins % 15);
        var hrs = d.getHours();
        if (mins === 60) {
            mins = 0;
            hrs++;
            if (hrs === 24) {
                hrs = 0;
            }
        }
        var minStr = "" + mins;
        if (minStr.length === 1) {
            minStr = "0" + minStr;
        }
        var hrStr = "" + hrs;
        if (hrStr.length === 1) {
            hrStr = "0" + hrStr;
        }
        return hrStr + minStr;
    };
    o.setCurrentTime = function() {
        var d = new Date();
        var mins = d.getMinutes();
        mins = mins + (15 - mins % 15);
        var hrs = d.getHours();
        if (mins === 60) {
            mins = 0;
            hrs++;
            if (hrs === 24) {
                hrs = 0;
                $("#Date option").removeAttr("selected");
                $("#Date option[value=" + $("#Date option:selected").next().val() + "]").attr("selected", "selected");
                $(".date-of-departure > span").text("Tomorrow");
            }
        }
        var minStr = "" + mins;
        if (minStr.length === 1) {
            minStr = "0" + minStr;
        }
        var hrStr = "" + hrs;
        if (hrStr.length === 1) {
            hrStr = "0" + hrStr;
        }
        $("#Time option").removeAttr("selected");
        $("#Time option[value=" + hrStr + minStr + "]").attr("selected", "selected");
        $(".hours span").text(hrStr + ":" + minStr);
    };
    o.changeDepartureTime = function() {
        $(".time-options").toggleClass("change-time");
        return false;
    };
    o.toggleMoreOptions = function() {
        $(this).parents(".r").toggleClass("expanded");
        $("#more-journey-options").slideToggle(900, function() {
            var isEditingMode = $("#plan-a-journey").hasClass("editing");
            var isMoreOptionsVisible = $("#more-journey-options").is(":visible");
            if (isEditingMode && !isMoreOptionsVisible) {
                $("#plan-a-journey").find(".update-buttons").show();
            }
            $("#more-journey-options").css("overflow", "visible");
        });
        var link = $(".toggle-options");
        var editPreferences = null;
        if (link.hasClass("more-options")) {
            link.removeClass("more-options").addClass("less-options").attr("aria-expanded", "true").text(tfl.dictionary.LessOptions);
            if ($(".journey-planner-results").length > 0 || $(".jp-multiple-journey-container").length > 0) {
                editPreferences = link.parent().detach();
                editPreferences.insertAfter(".basic-journey-options ");
                tfl.journeyPlanner.results.manageVisibilityOfUpdateButtons();
                var nationalSearch = $(".national-search").detach();
                nationalSearch.appendTo("#walking-cycling-fieldset");
                $("#search-filter-form-2").show();
                $(".twitter-typeahead").show();
            }
        } else {
            var customisedOptions = $.cookie("jp-pref") !== null ? " (customised)" : "";
            link.removeClass("less-options").addClass("more-options").attr("aria-expanded", "false").text(tfl.dictionary.MoreOptions + customisedOptions);
            if (window.location.pathname === "/plan-a-journey/results" || window.location.pathname === "/JourneyPlanner/MultipleJourneyResult") {
                var $editingElementFound = link.parent().closest(".journey-form").find(".editing");
                editPreferences = link.parent().detach();
                if ($editingElementFound && $editingElementFound.length) {
                    editPreferences.insertAfter($editingElementFound.find(".time-options"));
                    window.setTimeout(function() {
                        tfl.journeyPlanner.results.manageVisibilityOfUpdateButtons();
                    }, 980);
                } else {
                    editPreferences.appendTo(".travel-preferences");
                }
            }
            if ($(".journey-results").length && $(".basic-journey-options fieldset .update-buttons").length === 0) {
                $(".basic-journey-options fieldset").append('<div class="update-buttons-container clearfix"><div class="clearfix update-buttons"><input type="button" class="secondary-button cancel-button" value="Cancel"><input type="submit" class="primary-button plan-journey-button" value="Update journey"></div></div>');
            }
            $(".cancel-button").on("click", function() {
                $(".toggle-options.less-options").click();
                $("#plan-a-journey").removeClass("editing").parents(".r").removeClass("expanded");
                $(".journey-result-summary .secondary-button").focus();
                if ($("#search-filter-form-0")) {
                    $("#search-filter-form-0").hide();
                    $("#search-filter-form-1").hide();
                    $(".journey-form .twitter-typeahead").hide();
                }
                return false;
            });
        }
        return false;
    };
    o.toggleMoreOptionsIsWidget = function() {
        var button = $(this);
        var href = button.attr("href");
        var hrefStart = href;
        if (href.indexOf("?") !== -1) {
            hrefStart = href.substr(0, href.indexOf("?"));
        } else {
            hrefStart = href.substr(0, href.indexOf("#"));
        }
        var uri = "";
        var hash = href.substr(href.indexOf("#"));
        $.each([ "From", "To", "FromGeolocation", "ToGelocation" ], function(k, v) {
            var val = $("#" + v).val();
            if (val !== undefined && val !== "") {
                if (k === 0) uri += "?";
                if (k > 0) uri += "&";
                uri += v + "=" + val;
            }
        });
        var data = [];
        var fromEl = $("#From");
        var toEl = $("#To");
        if (fromEl.attr("data-from-id")) data.push([ "fromId", fromEl.attr("data-from-id") ]);
        if (toEl.attr("data-to-id")) data.push([ "toId", toEl.attr("data-to-id") ]);
        data.push([ "date", $("#Date").find("option:selected").val() ]);
        data.push([ "timeIs", $(".leaving-or-arriving .selected input").val() ]);
        data.push([ "time", $("#Time").find("option:selected").val() ]);
        if (uri.indexOf("?") === -1) {
            uri += "?";
        }
        for (var i = 0; i < data.length; i++) {
            uri += "&" + data[i][0] + "=" + data[i][1];
        }
        button.attr("href", hrefStart + uri + hash);
        var tempJpLocalStorage = [ [] ];
        if (fromEl.attr("data-from-modes")) {
            tempJpLocalStorage.push([ "#From", "data-from-modes", fromEl.attr("data-from-modes") ]);
        }
        if (fromEl.attr("data-dataset-name")) {
            tempJpLocalStorage.push([ "#From", "data-dataset-name", fromEl.attr("data-dataset-name") ]);
        }
        if (toEl.attr("data-to-modes")) {
            tempJpLocalStorage.push([ "#To", "data-to-modes", toEl.attr("data-to-modes") ]);
        }
        if (toEl.attr("data-dataset-name")) {
            tempJpLocalStorage.push([ "#To", "data-dataset-name", toEl.attr("data-dataset-name") ]);
        }
        if (tempJpLocalStorage.length > 0) {
            if ($("#InputFrom").val() === tfl.dictionary.CurrentLocationText) {
                tempJpLocalStorage.push([ "From", tfl.dictionary.CurrentLocationText ]);
            } else {
                tempJpLocalStorage.push([ "From", $("#From").val() ]);
            }
            if ($("#InputTo").val() === tfl.dictionary.CurrentLocationText) {
                tempJpLocalStorage.push([ "To", tfl.dictionary.CurrentLocationText ]);
            } else {
                tempJpLocalStorage.push([ "To", $("#To").val() ]);
            }
            tempJpLocalStorage.push([ "ToId", $("#ToId").val() ]);
            tempJpLocalStorage.push([ "FromId", $("#FromId").val() ]);
            tempJpLocalStorage.push([ "ViaId", $("#ViaId").val() ]);
            tempJpLocalStorage.push([ "Via", $("#Via").val() ]);
        }
        if (tempJpLocalStorage.length > 0) {
            tfl.storage.set("tempJPLocalStorage", tempJpLocalStorage);
        }
    };
    o.buildSwitchButton = function() {
        $(".geolocation-box").parent().after("<a href='javascript:void(0)' class='switch-button hide-text'>Switch from and to<a>");
    };
    o.switchFromTo = function() {
        var inputFrom = $("#InputFrom").val();
        var inputTo = $("#InputTo").val();
        if (inputFrom.toLowerCase().indexOf("current location") !== -1 || inputTo.toLowerCase().indexOf("current location") !== -1) {
            $(".twitter-typeahead").removeAttr("data-current-location");
        }
        var from = $("input#From").val();
        var to = $("input#To").val();
        var fromId = $("#FromId").val();
        var toId = $("#ToId").val();
        $("#InputFrom").val(inputTo);
        $("#InputTo").val(inputFrom);
        $("input#From").val(to);
        $("input#To").val(from);
        $("#FromId").val(toId);
        $("#ToId").val(fromId);
    };
    var favouritePlaces = tfl.autocomplete.favouritePlaces.getPlaces(true);
    var sourceFavouritePlaces = tfl.autocomplete.sources.getFavouritePlaces("journey-planner-favourite-places", favouritePlaces, tfl.autocomplete.sources.stationsStopsSelectionCallback, "<div class='mode-icons'>{{#placeModes}}<span class='mode-icon {{.}}-icon'>&nbsp;</span>{{/placeModes}}</div><span class='stop-name' role='option'>{{placeName}}</span>", "placeName", 99);
    var recentPlaces = tfl.autocomplete.recentMagicSearches.getPlaces(true);
    var sourceRecentSearches = tfl.autocomplete.sources.getRecentSearches("journey-planner-recent-searches", recentPlaces, tfl.autocomplete.sources.stationsStopsSelectionCallback, "<div class='mode-icons'>{{#placeModes}}<span class='mode-icon {{.}}-icon'>&nbsp;</span>{{/placeModes}}</div><span class='stop-name' role='option'>{{placeName}}</span>", "placeName", tfl.autocomplete.recentMagicSearches.recentSearchNumberLimit);
    sourceRecentSearches.typeaheadSource.removeContent = tfl.autocomplete.sources.stationsStopsRemoveContent;
    var autocompleteSources = [ tfl.autocomplete.sources.getJourneyPlannerSuggestions() ];
    var sourcesTurnRecentSearchesOn, sourcesTurnRecentSearchesOff;
    var sourceTurnOffRecentSearches = tfl.autocomplete.sources.getTurnOnOffRecentSearches(false, [ {
        linkText: "Turn off recent journeys"
    } ]);
    var sourceTurnOnRecentSearches = tfl.autocomplete.sources.getTurnOnOffRecentSearches(true, [ {
        linkText: "Turn on recent journeys"
    } ]);
    o.setupAutocomplete = function(freshPageLoad) {
        sourcesTurnRecentSearchesOn = autocompleteSources.slice(0);
        sourcesTurnRecentSearchesOff = autocompleteSources.slice(0);
        o.autocompleteAddRecentSearches(!freshPageLoad);
        o.autocompleteAddFavouritePlaces(!freshPageLoad);
        o.autocompleteAddGeolocation();
        sourceTurnOffRecentSearches.typeaheadSource.callback = function(inputEl) {
            tfl.journeyPlanner.recentJourneys.useJourneys(false);
            if ($("#recent-journeys").length !== 0) {
                tfl.journeyPlanner.createJourneys();
            }
            $(inputEl).parent().siblings(tfl.dictionary.RemoveContentClass).trigger("clear-search-box");
            o.destroyAutocomplete();
            $("#From, #To, #Via").each(function() {
                tfl.autocomplete.setup("#" + $(this).attr("id"), sourcesTurnRecentSearchesOn, null, true);
                $("#" + $(this).attr("id")).attr("placeholder", $(this).attr("id"));
            });
        };
        sourceTurnOnRecentSearches.typeaheadSource.callback = function(inputEl) {
            tfl.journeyPlanner.recentJourneys.useJourneys(true);
            if ($("#recent-journeys").length !== 0) {
                tfl.journeyPlanner.createJourneys();
            }
            $(inputEl).parent().siblings(tfl.dictionary.RemoveContentClass).trigger("clear-search-box");
            o.destroyAutocomplete();
            $("#From, #To, #Via").each(function() {
                tfl.autocomplete.setup("#" + $(this).attr("id"), sourcesTurnRecentSearchesOff, null, true);
                $("#" + $(this).attr("id")).attr("placeholder", $(this).attr("id"));
            });
        };
        if (tfl.journeyPlanner.recentJourneys.usingRecentJourneys) {
            tfl.autocomplete.setup("#From", sourcesTurnRecentSearchesOff, null, freshPageLoad);
            tfl.autocomplete.setup("#To", sourcesTurnRecentSearchesOff, null, freshPageLoad);
            tfl.autocomplete.setup("#Via", sourcesTurnRecentSearchesOff, null, freshPageLoad);
        } else {
            tfl.autocomplete.setup("#From", sourcesTurnRecentSearchesOn, null, freshPageLoad);
            tfl.autocomplete.setup("#To", sourcesTurnRecentSearchesOn, null, freshPageLoad);
            tfl.autocomplete.setup("#Via", sourcesTurnRecentSearchesOn, null, freshPageLoad);
        }
        $('.twitter-typeahead:has("#From")').hide();
        $('.twitter-typeahead:has("#To")').hide();
    };
    o.destroyAutocomplete = function() {
        $("#From, #To, #Via").each(function() {
            $(this).parent().siblings(tfl.dictionary.RemoveContentClass).unbind("clear-search-box");
            $(this).typeahead("destroy");
            $(this).off("typeahead:selected typeahead:autocompleted keydown.autocomplete");
        });
        sourcesTurnRecentSearchesOff = autocompleteSources.slice(0);
        sourcesTurnRecentSearchesOn = autocompleteSources.slice(0);
        o.autocompleteAddRecentSearches(true);
        o.autocompleteAddFavouritePlaces(true);
        o.autocompleteAddGeolocation();
    };
    o.autocompleteAddFavouritePlaces = function(excludefavouritePlaces) {
        sourcesTurnRecentSearchesOff.splice(0, 0, sourceFavouritePlaces);
        sourcesTurnRecentSearchesOn.splice(0, 0, sourceFavouritePlaces);
    };
    o.autocompleteAddRecentSearches = function(excludeRecentSearches) {
        if (tfl.isLocalStorageSupported) {
            sourcesTurnRecentSearchesOff.splice(0, 0, sourceTurnOffRecentSearches);
            if (tfl.journeyPlanner.recentJourneys.usingRecentJourneys && !excludeRecentSearches) {
                sourcesTurnRecentSearchesOff.splice(0, 0, sourceRecentSearches);
            }
            sourcesTurnRecentSearchesOn.splice(0, 0, sourceTurnOnRecentSearches);
        }
    };
    o.autocompleteAddGeolocation = function() {
        var sourceGeolocation = tfl.autocomplete.sources.getGeolocation(null);
        if (tfl.geolocation.isGeolocationSupported()) {
            sourcesTurnRecentSearchesOff.splice(0, 0, sourceGeolocation);
            sourcesTurnRecentSearchesOn.splice(0, 0, sourceGeolocation);
        }
    };
    function removeAttributes($el) {
        $el.removeAttr("data-" + $el.attr("id").toLowerCase() + "-id");
        $el.removeAttr("data-" + $el.attr("id").toLowerCase() + "-modes");
        $el.removeAttr("data-dataset-name");
    }
    window.appendJPParams = function(link, url) {
        var fromInput = $("#InputFrom");
        var toInput = $("#InputTo");
        var fromParam = tfl.tools.getQueryStringParameter("From", url);
        var toParam = tfl.tools.getQueryStringParameter("To", url);
        var urlArr = url.split("?");
        var baseUrl = urlArr[0];
        var params = "";
        if (urlArr.length > 1) params = urlArr[1];
        var hasParams = params !== null && params !== undefined && params !== "";
        var hasFromInput = fromInput.val() !== null && fromInput.val() !== undefined && fromInput.val() !== "";
        var hasToInput = toInput.val() !== null && toInput.val() !== undefined && toInput.val() !== "";
        var hasFromParam = !(fromParam === null || fromParam === undefined);
        var hasToParam = !(toParam === null || toParam === undefined);
        if (hasToInput && !hasToParam) {
            if (hasParams && params.indexOf("&") > 0) {
                params = "&" + params;
            }
            params = "&To=" + toInput.val() + params;
        }
        if (hasFromInput && !hasFromParam) {
            params = "?From=" + fromInput.val() + params;
        }
        if (params.indexOf("?") === -1) {
            params = "?" + params;
        }
        window.location.href = baseUrl + params;
    };
    o.init = function(isWidget) {
        tfl.logs.create("tfl.journeyPlanner.searchForm.init: started (widget = " + isWidget + ")");
        o.isWidget = isWidget || false;
        o.processTempLocalStorage();
        var arrivingOrLeaving = $(".leaving-or-arriving .selected label").text();
        $(".time-options").prepend("<div class='time-defaults'><p><strong>" + arrivingOrLeaving + ":</strong> <span>now</span></p><a href='javascript:void(0)' class='change-departure-time'>change time</a></div>");
        if (!String.prototype.indexOf || window.location.href.indexOf("&time=") > 0) {
            $(".change-time-options").show();
            $(".time-defaults").hide();
        }
        $("#jp-search-form").submit(o.submitSearchForm);
        $(".change-departure-time").click(o.changeDepartureTime);
        o.setupDateOptions();
        if (!o.isWidget) {
            $(".toggle-options").click(o.toggleMoreOptions);
        } else {
            $(".toggle-options").click(o.toggleMoreOptionsIsWidget);
        }
        if (window.location.hash === "#more-options") {
            $(".toggle-options").click();
        } else if (window.location.hash === "#change-time") {
            o.changeDepartureTime();
        }
        $("#IsAsync").val(true);
        o.setupAutocomplete(true);
        tfl.forms.inputKeydownCallbackSetup("#From, #To, #Via", removeAttributes);
        var fromEl = $("#From"), toEl = $("#To"), viaEl = $("#Via");
        $([ fromEl, toEl, viaEl ]).each(function() {
            if (this.val() === tfl.dictionary.CurrentLocationText) {
                tfl.geolocation.setupInputBoxForGeolocation(this);
            }
        });
        if ($("#From").val()) {
            $("#InputFrom").val($("#From").val());
        }
        if ($("#To").val()) {
            $("#InputTo").val($("#To").val());
        }
        $("#more-journey-options .publictransport").click(function() {
            $(".search-public-options").show();
            $(".input-group.modes-of-transport.jp-mode-publictransport").show();
            $(".search-cycling-options").hide();
            $(".search-walking-options").hide();
            $("#JpType").val("publictransport").change();
            $(this).addClass("selected").children("a").attr("aria-selected", "true");
            $("#more-journey-options .walking").removeClass("selected").children("a").attr("aria-selected", "false");
            $("#more-journey-options .cycling").removeClass("selected").children("a").attr("aria-selected", "false");
            return false;
        });
        $("#more-journey-options .cycling").click(function() {
            $(".search-public-options").hide();
            $(".input-group.modes-of-transport.jp-mode-publictransport").hide();
            $(".search-walking-options").hide();
            $(".search-cycling-options").show();
            $("#JpType").val("cycling").change();
            $(this).addClass("selected").children("a").attr("aria-selected", "true");
            $("#more-journey-options .walking").removeClass("selected").children("a").attr("aria-selected", "false");
            $("#more-journey-options .publictransport").removeClass("selected").children("a").attr("aria-selected", "false");
            return false;
        });
        $("#more-journey-options .walking").click(function() {
            $(".search-public-options").hide();
            $(".input-group.modes-of-transport.jp-mode-publictransport").hide();
            $(".search-cycling-options").hide();
            $(".search-walking-options").show();
            $("#JpType").val("walking").change();
            $(this).parent().addClass("selected").children("a").attr("aria-selected", "true");
            $("#more-journey-options .publictransport").removeClass("selected").children("a").attr("aria-selected", "false");
            $("#more-journey-options .cycling").removeClass("selected").children("a").attr("aria-selected", "false");
            return false;
        });
        $("#more-journey-options .publictransport").addClass("selected").children("a").attr("aria-selected", "true");
        $(".modes-of-transport input").change(function() {
            $("#Mode").attr("data-send", "true");
            $("#Mode option").attr("data-send", "true");
        });
        $("#jp-search-form select").change(function() {
            $(this).attr("data-send", "true");
            $(this).find("option").each(function() {
                $(this).attr("data-send", "true");
            });
        });
        $("#jp-search-form input").change(function() {
            $(this).attr("data-send", "true");
        });
        $(".plan-journey-button").click(function() {
            var $checkedModes = $(".modes-of-transport input:checked");
            if (!$checkedModes.length && $("#more-journey-options .publictransport").hasClass("selected")) {
                $("#more-journey-options").find("fieldset").find(".jp-mode-publictransport").find("select option:selected").removeAttr("selected");
                $("#more-journey-options").find("fieldset").find(".jp-mode-publictransport [value=tube]").attr("selected", "selected");
                $checkedModes = $(".modes-of-transport #tube").attr("checked", "checked");
            }
            $("#Mode").val($.map($checkedModes, function(val, i) {
                return $(val).prop("id");
            }));
            $("#IsPastWarning").val("False");
            $("input#From").val($(".jpFrom").val());
            $("input#To").val($(".jpTo").val());
            $("input#Via").val($(".jpVia").val());
            if (!$("#InputVia").val()) {
                $("#Via").val(null);
                $("#ViaId").val(null);
            }
            if ($("#more-journey-options .cycling").hasClass("selected")) {
                if (!$("#more-journey-options .search-cycling-options input:checked").length) {
                    $("#AllTheWay").attr("checked", "checked");
                }
            }
            $("#JourneyType").val(null);
            var jpQueryStringKvpArr = window.location.search.substr(1, window.location.search.length).split("&");
            var paramValues = [];
            $.map(jpQueryStringKvpArr, function(item) {
                paramValues.push({
                    key: item.split("=")[0],
                    value: item.split("=")[1]
                });
            });
            var eVar8Val = "From:" + $("input#From").val() + "|" + "To:" + $("input#To").val();
            var eVar9Val = "Tab:" + $("#more-journey-options").find("fieldset").find(".tabs-style-2").find(".selected").text().trim();
            var eVar10Val_direction = $("#plan-a-journey").find(".change-time-options").find(".clearfix").find(".leaving-or-arriving").find(".selected").find("input").val();
            var eVar10Val_date = $("#plan-a-journey").find(".change-time-options").find(".hours-mins").find(".date-of-departure").find("span").text();
            var eVar10Val_time = $("#plan-a-journey").find(".change-time-options").find(".hours-mins").find(".hours").find("span").text();
            var eVar10Val = eVar10Val_direction + "|" + eVar10Val_date + "|" + eVar10Val_time;
            var eVar11Val = "";
            var eVar12Val = "";
            var eVar13Val = "";
            var eVar14Val = "";
            var eVar15Val = "";
            var eVar16Val = "";
            if (eVar9Val.indexOf("Public transport") >= 0) {
                $("#more-journey-options").find("fieldset").find(".jp-mode-publictransport").find("select option:selected").each(function() {
                    eVar11Val += $(this).text() + "|";
                });
                eVar11Val = eVar11Val.substr(0, eVar11Val.length - 1);
                var journeyPrefId = $(".stacked-fields.level-one").find(".show-me-list").find(".form-control").find("input:checked").attr("id");
                eVar12Val = $(".stacked-fields.level-one").find(".show-me-list").find(".form-control").find("label[for=" + journeyPrefId + "]").text();
                var idTemp = $(".stacked-fields.level-one").find("li").not(".show-me-list").find(".form-control").find("input:checked").attr("id");
                eVar13Val = $(".stacked-fields.level-one").find("li").not(".show-me-list").find(".form-control").find("label[for=" + idTemp + "]").text();
                var preferences = "";
                $(".stacked-fields:last").find("li").each(function() {
                    if ($(this).find("#MaxWalkingMinutes").length) {
                        preferences += "WalkMax:" + $(this).find("#MaxWalkingMinutes").find("option:selected").val() + "|";
                    } else if ($(this).find("#WalkingSpeed").length) {
                        preferences += "WalkSpeed:" + $(this).find("#WalkingSpeed").find("option:selected").val() + "|";
                    } else if ($(this).find("#NationalSearch").length) {
                        preferences += "Outside London:" + ($(this).is(":checked") ? "Yes" : "No") + "|";
                    }
                });
                var via = $(".go-via").find("input[type='hidden'].tt-input").val();
                preferences += via.length ? "Via:" + via + "|" : "";
                preferences = preferences.substr(0, preferences.length - 1);
                eVar14Val = preferences;
            } else if (eVar9Val.indexOf("Cycling") >= 0) {
                var cyclePrefId = $(".search-cycling-options").find(".form-control").find("input:checked").attr("id");
                eVar15Val = $(".search-cycling-options").find(".form-control").find("label[for=" + cyclePrefId + "]").text();
            } else if (eVar9Val.indexOf("Walking") >= 0) {
                var walkingPrefId = $(".search-walking-options").find(".form-control").find("input:checked").attr("id");
                eVar16Val = $(".search-walking-options").find(".form-control").find("label[for=" + walkingPrefId + "]").text();
            }
            if ($(".basic-journey-options .plan-journey-button").length && $(".basic-journey-options .plan-journey-button").val() === "Update journey" || $("#more-journey-options .plan-journey-button").length && $("#more-journey-options .plan-journey-button").val() === "Update journey") {
                tfl.stats.tealiumTracking({
                    event_name: "jp_update_journey",
                    jp_access_options: eVar13Val,
                    jp_cycling_preferences: eVar15Val,
                    jp_from_to: eVar8Val,
                    jp_mode: eVar11Val,
                    jp_preferences: eVar14Val,
                    jp_show_me: eVar12Val,
                    jp_tab_open: eVar9Val,
                    jp_time: eVar10Val,
                    jp_walking_preferences: eVar16Val
                });
            } else {
                tfl.stats.tealiumTracking({
                    event_name: "jp_plan_journey",
                    jp_access_options: eVar13Val,
                    jp_cycling_preferences: eVar15Val,
                    jp_from_to: eVar8Val,
                    jp_mode: eVar11Val,
                    jp_preferences: eVar14Val,
                    jp_show_me: eVar12Val,
                    jp_tab_open: eVar9Val,
                    jp_time: eVar10Val,
                    jp_walking_preferences: eVar16Val
                });
            }
            if ($("#SavePreferences").is(":checked") && $("#InputFrom").val() && $("#InputTo").val()) {
                window.tfl.stats.tealiumTracking({
                    event_name: "jp_save_preferences"
                });
            }
            tfl.jpTrack.trackTypeOfPlacesUsed();
        });
        $('.twitter-typeahead:has("#From")').hide();
        $('.twitter-typeahead:has("#To")').hide();
        $(".jp-select-all").on("click", function() {
            $(".modes-of-transport.input-group").find("input").prop("checked", true);
        });
        $(".jp-deselect-all").on("click", function() {
            $(".modes-of-transport.input-group").find("input").prop("checked", false);
        });
        $("#InputFrom").mousedown(function() {
            $("#FromId").val(null);
        });
        $("#InputTo").mousedown(function() {
            $("#ToId").val(null);
        });
        $("#InputVia").mousedown(function() {
            $("#ViaId").val(null);
        });
    };
})(window.tfl.journeyPlanner.searchForm = window.tfl.journeyPlanner.searchForm || {});

(function(jpTrack, $, undefined) {
    "use strict";
    tfl.logs.create("tfl.jpTracking: loaded");
    var evar = tfl.dictionary.TrackingEvar;
    var event = tfl.dictionary.TrackingEvent;
    var prop = tfl.dictionary.TrackingProp;
    jpTrack.trackOpenPanelFromPlanJourney = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        var actionTypes = {
            Ignored: 0,
            ViewMyJourneys: 1,
            EditMyJourneys: 2,
            AddRecents: 3
        };
        function getActionType($target) {
            if ($target.hasClass("view-my-journeys")) {
                return actionTypes.ViewMyJourneys;
            } else if ($target.hasClass("edit-my-journeys")) {
                return actionTypes.EditMyJourneys;
            } else if ($target.hasClass("add-recents-to-favourites")) {
                return actionTypes.AddRecents;
            }
            return actionTypes.Ignored;
        }
        tfl.logs.create("tfl.jpTrack: trackPlanMyJourneysSelected");
        var actionType = getActionType($(e.target));
        var currentPage = getJourneyPlannerPage();
        var trackingItem = {};
        switch (actionType) {
          case actionTypes.EditMyJourneys:
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(evar.OpenEditPanel_25.JpFavJourneysEdit, currentPage);
            break;

          case actionTypes.AddRecents:
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(evar.OpenEditPanel_25.JpRecentJourneysAdd, currentPage);
            break;
        }
        if (trackingItem[evar.OpenEditPanel_25.Name]) {
            trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
            tfl.stats.tealiumTracking(trackingItem);
        }
        trackingItem = {};
        switch (actionType) {
          case actionTypes.ViewMyJourneys:
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(prop.OpenPanel_41.JpFavJourneysView, currentPage);
            break;

          case actionTypes.EditMyJourneys:
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(prop.OpenPanel_41.JpFavJourneysEdit, currentPage);
            break;

          case actionTypes.AddRecents:
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(prop.OpenPanel_41.JpRecentJourneysAdd, currentPage);
            break;
        }
        if (trackingItem[prop.OpenPanel_41.Name]) {
            trackingItem[event.Name] = event.PersonalisationOpenPanel_prop41;
            trackingItem.newReturnUser = true;
            tfl.stats.tealiumTracking(trackingItem);
        }
    };
    jpTrack.trackPlanMyJourneysSelected = function(pageName) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.jpTrack: trackPlanMyJourneysSelected");
        var currentPage = getJourneyPlannerPage(pageName);
        var trackingItem = {};
        trackingItem[event.JourneyPlannerType_23.Name] = event.JourneyPlannerType_23;
        trackingItem[evar.JourneyPlannerSelection_27.Name] = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.PlanJourney, currentPage);
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    jpTrack.trackSavedJourneySelected = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.jpTrack: trackSavedJourneySelected");
        var currentPage = getJourneyPlannerPage();
        var journeyType = $(e.target).data("journey-type");
        var isFavouriteJourney = journeyType === "favourite";
        var isRecentJourney = journeyType === "recent";
        var journeyTypeSelected = "";
        var trackingItem = {};
        if (isFavouriteJourney) {
            journeyTypeSelected = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.FavJourney, currentPage);
        } else if (isRecentJourney) {
            journeyTypeSelected = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.RecentJourney, currentPage);
        }
        if (journeyTypeSelected.length) {
            trackingItem[event.Name] = event.JourneyPlannerType_23;
            trackingItem[evar.JourneyPlannerSelection_27.Name] = journeyTypeSelected;
            if (isFavouriteJourney) {
                trackingItem.newReturnUser = true;
            }
            tfl.stats.tealiumTracking(trackingItem);
        }
        if (isRecentJourney) {
            trackingItem = {};
            trackingItem[event.Name] = event.RecentJourneySelected_3;
            tfl.stats.tealiumTracking(trackingItem);
        }
    };
    jpTrack.trackTypeOfPlacesUsed = function() {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.jpTrack: trackTypeOfPlacesUsed");
        var currentPage = getJourneyPlannerPage();
        var fromCategory = $("input[stop-category]:first").attr("stop-category");
        var toCategory = $("input[stop-category]:last").attr("stop-category");
        var recentsKey = "stops-recent-magic-searches";
        var favouritePlacesKey = "stops-favourite-places";
        var isRecentSelected = fromCategory === recentsKey || toCategory === recentsKey;
        var isFavPlaceSelected = fromCategory === favouritePlacesKey || toCategory === favouritePlacesKey;
        var placeTypesSelected = "";
        if (isRecentSelected && isFavPlaceSelected) {
            placeTypesSelected = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.FavRecentPlaces, currentPage);
        } else if (isRecentSelected && !isFavPlaceSelected) {
            placeTypesSelected = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.RecentPlacesOnly, currentPage);
        } else if (!isRecentSelected && isFavPlaceSelected) {
            placeTypesSelected = tfl.utils.stringFormat(evar.JourneyPlannerSelection_27.FavPlacesOnly, currentPage);
        }
        if (placeTypesSelected.length) {
            var trackingItem = {};
            trackingItem[event.Name] = event.JourneyPlannerType_23;
            trackingItem[evar.JourneyPlannerSelection_27.Name] = placeTypesSelected;
            if (isFavPlaceSelected) {
                trackingItem.newReturnUser = true;
            }
            tfl.stats.tealiumTracking(trackingItem);
        }
    };
    function getJourneyPlannerPage(pageName) {
        var isHomePage = false;
        if (pageName) {
            isHomePage = pageName === "home";
        } else {
            var pathName = window.location.pathname;
            isHomePage = pathName.indexOf("plan-a-journey") <= 0;
        }
        return isHomePage ? "Homepage" : "Plan a journey";
    }
})(window.tfl.jpTrack = window.tfl.jpTrack || {}, jQuery);

(function(o) {
    "use strict";
    if (!$("body").hasClass("personalisation-active")) {
        return;
    }
    tfl.logs.create("tfl.favouritesUtils: loaded");
    o.helper = {
        modes: [ [ tfl.modeNameTube, tfl.modeNameDlr, tfl.modeNameOverground, tfl.modeNameTflRail, tfl.modeNameTram ], tfl.modeNameBus, tfl.modeNameTraffic, tfl.modeNameRiver, tfl.modeNameCableCar, "journey", "place", "journey-place" ],
        modesSuffix: function(modes) {
            if (modes) {
                if (modes.constructor === Array) {
                    return modes.join("-");
                } else if (typeof modes === "string" && modes !== "") {
                    return modes;
                }
            }
            return "";
        },
        ajaxUrlStatusBoardUpdate: function(modes, params) {
            if (modes === "bus") {
                return tfl.utils.stringFormat("/Stops/BusStopPointsStatus?naptanLineIds={0}&origin={1}&limitOnHomePage=8&showBusStatusOnHomePage={2}", convertFavItemsToNaptanLineIds(params.favItems), getOrigin(params), tfl.showBusStatusOnHomePage);
            } else {
                return tfl.utils.stringFormat("/StatusUpdates/StatusBoard?modes={0}&startDate=null&endDate=null&collapsed={1}&isHomeOrModePageStatusBoard={2}&isStatusUpdatesPage={3}&isFavouritesPanel={4}&isHomePageFavouritesWidget={5}", modes, params.collapsed, params.isHomeOrModePageStatusBoard, params.isStatusUpdatesPage, params.isFavouritesPanel, params.isHomePageFavouritesWidget);
            }
        },
        ajaxUrlBusStopPoints: function(naptanIds) {
            return tfl.utils.stringFormat("/Stops/BusStopPoints?naptanids={0}", naptanIds);
        },
        ajaxUrlStopPoint: function(stop) {
            var encodedQuery = encodeURIComponent(stop);
            return tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.StopPointsSearchQuery.replace("%QUERY", encodedQuery), "", false, true));
        },
        ajaxUrlBikePoint: function(bikepoint) {
            var encodedQuery = encodeURIComponent(bikepoint);
            return tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.BikePointSearch.replace("%QUERY", encodedQuery), "", false));
        },
        ajaxUrlPlacesExtraSearch: function(googlePlace) {
            var encodedQuery = encodeURIComponent(googlePlace);
            return tfl.addAppIdAndKey(tfl.utils.stringFormat(tfl.api.PlacesExtraSearch.replace("%QUERY", encodedQuery), "", false));
        },
        personalisationFlag: $("body").hasClass("personalisation-active"),
        getDateInYYYYMMDD: function() {
            var date = new Date();
            var yyyy = date.getFullYear().toString();
            var mm = (date.getMonth() + 1).toString();
            var dd = date.getDate().toString();
            return yyyy + (mm[1] ? mm : "0" + mm[0]) + (dd[1] ? dd : "0" + dd[0]);
        },
        getTimeInHHMM: function() {
            var d = new Date();
            var timeSplits = d.toTimeString().split(":");
            return timeSplits[0] + timeSplits[1];
        },
        isValidPlaceId: function(placeId) {
            var isValid = false;
            if (!isNaN(placeId) && placeId != tfl.dictionary.JpInvalidIcsId) {
                isValid = true;
            }
            return isValid;
        },
        getGeoLocation: function(placeId) {
            var matches;
            if (placeId) {
                matches = placeId.match(/^(-*\d+\.\d+),{1}(-*\d+\.\d+)\|?([a-z]*)$/);
            }
            var geoLocation = {};
            if (matches) {
                geoLocation.isValid = true;
                geoLocation.lat = matches[1];
                geoLocation.lon = matches[2];
                geoLocation.source = matches[3];
                switch (matches[3]) {
                  case "stops":
                  case "bikepoints":
                    geoLocation.poiModes = [ "bch-docking-station" ];
                    break;

                  default:
                    geoLocation.poiModes = [ "point_of_interest" ];
                    break;
                }
            } else {
                geoLocation.isValid = false;
            }
            return geoLocation;
        },
        isFavBoard: function(boardId) {
            return boardId && boardId.toLowerCase().indexOf("fav-", 0) > -1;
        },
        includesMode: function(modes, modeToCheck) {
            if (!modes) {
                return false;
            }
            if (Array.isArray(modes)) {
                var matchedModes = modes.find(function(mode) {
                    return mode === modeToCheck;
                });
                return matchedModes && matchedModes.length > 0;
            }
            return modes === modeToCheck;
        }
    };
    function convertFavItemsToNaptanLineIds(favItems) {
        var favArray = [];
        if (favItems && favItems.length > 0) {
            for (var i = 0; i < favItems.length; i += 1) {
                if (favItems[i].props && favItems[i].props.lines && favItems[i].props.lines.length > 0) {
                    favArray.push(favItems[i].naptanId + "|" + favItems[i].props.lines.join(","));
                }
            }
        }
        return favArray.join(";");
    }
    function getOrigin(params) {
        if (params.hasOwnProperty("isHomeOrModePageStatusBoard") && params.isHomeOrModePageStatusBoard === true || params.hasOwnProperty("isHomePageFavouritesWidget") && params.isHomePageFavouritesWidget === true) {
            return "HomePage";
        } else if (params.hasOwnProperty("isModePage") && params.isModePage === true) {
            return "ModePage";
        } else if (params.hasOwnProperty("isStatusUpdatesPage") && params.isStatusUpdatesPage === true) {
            return "FavStatusPanel";
        } else if (params.hasOwnProperty("isFavouritesPanel") && params.isFavouritesPanel === true) {
            return "FavEditPanel";
        }
        return "UnknownPage";
    }
    String.prototype.replaceAll = function(search, replacement) {
        var target = this;
        return target.replace(new RegExp(search, "g"), replacement);
    };
})(window.tfl.favouritesUtils = window.tfl.favouritesUtils || {});

(function(favourites, $, undefined) {
    "use strict";
    tfl.logs.create("tfl.favourites: loaded");
    var buttons = {};
    var $FavsUtils = tfl.favouritesUtils;
    var evar = tfl.dictionary.TrackingEvar;
    var event = tfl.dictionary.TrackingEvent;
    var prop = tfl.dictionary.TrackingProp;
    favourites.state = function() {
        var stateHasChanged = false;
        return {
            reset: function() {
                stateHasChanged = false;
            },
            changed: function() {
                stateHasChanged = true;
            },
            hasChanged: function() {
                return stateHasChanged;
            }
        };
    }();
    favourites.loadWithPanelOpen = null;
    favourites.refreshWhenLoaded = function(callback) {
        var isLoading = false;
        return {
            getIsLoading: function() {
                return isLoading;
            },
            setIsLoading: function(p) {
                isLoading = p;
                callback(isLoading);
            }
        };
    };
    favourites.personalisation = function() {
        var personalisationHasBeenUsed = tfl.storage.get("has-personalisation-used");
        if (!personalisationHasBeenUsed) {
            personalisationHasBeenUsed = false;
        }
        return {
            reset: function() {
                personalisationHasBeenUsed = false;
            },
            used: function() {
                personalisationHasBeenUsed = true;
                tfl.storage.set("has-personalisation-used", true);
            },
            hasBeenUsed: function() {
                return personalisationHasBeenUsed;
            }
        };
    }();
    favourites.getUsername = function() {
        return isUserLoggedIn() ? $.cookie("username") : null;
    };
    function getBannerCampaignId() {
        return tfl.storage.get("bannerCampaignId");
    }
    function hideBanner() {
        $(".fav-banner").addClass("visually-hidden");
    }
    function renderBanner(bannerData) {
        if (bannerData.title || bannerData.description) {
            $(".fav-banner").removeClass("visually-hidden");
            $(".fav-banner").data("campaignId", bannerData.campaignId);
            $(".fav-banner-title").html(bannerData.title || "");
            $(".fav-banner-description").html(bannerData.description || "");
            if (bannerData.backgroundImage) {
                $(".fav-banner").css("background-image", "url(" + bannerData.backgroundImage + ")");
            }
            $(".fav-banner-link").attr("href", bannerData.link || "#");
            $(".fav-dismiss-icon").off("click").on("click", dismissBanner);
        } else {
            hideBanner();
        }
    }
    function dismissBanner() {
        var campaignId = $(".fav-banner").data("campaignId");
        if (campaignId) {
            tfl.storage.set("bannerCampaignId", campaignId);
            hideBanner();
        }
    }
    favourites.loadBanner = function() {
        var cachedBannerCampaignId = getBannerCampaignId();
        tfl.ajax({
            url: tfl.web.FavouriteBanner,
            dataType: "text",
            beforeSend: function() {
                hideBanner();
            },
            success: function(data) {
                var response = null;
                try {
                    response = JSON.parse(data);
                } catch (e) {
                    return;
                }
                if (!response) {
                    hideBanner();
                    return;
                }
                var ajaxCampaignId = response.campaignId || Date.now();
                if (cachedBannerCampaignId) {
                    if (cachedBannerCampaignId !== ajaxCampaignId) {
                        tfl.storage.set("bannerCampaignId", null);
                        renderBanner(response);
                    } else {
                        hideBanner();
                    }
                } else {
                    renderBanner(response);
                }
            }
        });
    };
    function isUserLoggedIn() {
        var authorizeCookie = $.cookie("isAuthorize");
        return authorizeCookie && authorizeCookie.length > 0 ? /true/gi.test(authorizeCookie) : false;
    }
    favourites.loadFavourites = function(forceReload) {
        tfl.logs.create("tfl.favourites.loadFavourites");
        var currentDateTime = new Date();
        var refreshDateTime = currentDateTime.setMinutes(currentDateTime.getMinutes() - 1);
        if (forceReload === true || isUserLoggedIn() && ($.cookie("refreshFavourites") === null || new Date($.cookie("refreshFavourites")) < new Date(refreshDateTime))) {
            if (favourites.loadWithPanelOpen !== null) {
                favourites.loadWithPanelOpen.setIsLoading(true);
            }
            initFavourites();
            retrieveFavouritesFromDb();
        } else if (isEmpty()) {
            initFavourites();
            retrieveFavouritesFromLocalStorage();
        }
    };
    favourites.addFavourite = function(obj, isEdit) {
        tfl.logs.create("tfl.favourites.addFavourite");
        if (typeof obj !== "object" || !obj.hasOwnProperty("mode") || obj.mode === "") {
            tfl.logs.create("Add Favourite expects object defined in tfl.objects");
            return false;
        }
        favourites.loadFavourites();
        var storageKey = "";
        var lineKey = "";
        if (obj.hasOwnProperty("naptanLineId") && obj.naptanLineId !== "") {
            var storageKeys = obj.naptanLineId.toUpperCase().split("|");
            storageKey = storageKeys[0];
            lineKey = storageKeys[1];
        } else if (obj.hasOwnProperty("naptanId") && obj.naptanId !== "") {
            storageKey = obj.naptanId;
        } else if (obj.hasOwnProperty("dataLineId") && obj.dataLineId !== "") {
            storageKey = obj.dataLineId;
        } else if (obj.hasOwnProperty("dataCorridorName") && obj.dataCorridorName !== "") {
            storageKey = obj.dataCorridorName;
        } else if (obj.hasOwnProperty("placeName") && obj.placeName !== "") {
            storageKey = obj.placeName;
        } else if (obj.hasOwnProperty("journeyFromTo") && obj.journeyFromTo !== "") {
            storageKey = obj.journeyFromTo;
        }
        if (storageKey === "") {
            tfl.logs.create("Add Favourite expects a storage key defined in tfl.objects");
            return false;
        }
        if (obj.mode === "traffic" && !favourites.values.traffic) {
            favourites.values.traffic = {};
        }
        if (obj.mode === tfl.modeJourney) {
            tfl.journeyPlanner.recentJourneys.removeJourneyByKey(storageKey);
        }
        if (obj.mode === tfl.modePlace) {
            if (!obj.props.modes) {
                tfl.logs.create("Cannot add favourite place as not all information available yet");
                return false;
            }
            tfl.autocomplete.recentMagicSearches.removePlaceByKey(storageKey);
            tfl.favouritesTrack.trackPlaceLabelUse(!isEdit ? "Add" : "Edit", obj.label);
        }
        var stopAdded = false;
        if (obj.mode === "bus" && lineKey !== "") {
            if (!favourites.values[obj.mode].hasOwnProperty(storageKey)) {
                var busObj = {
                    naptanId: storageKey,
                    mode: obj.mode,
                    props: {
                        lines: []
                    }
                };
                favourites.values[obj.mode][storageKey] = busObj;
                stopAdded = true;
            }
            var oldLineKey = favourites.values[obj.mode][storageKey].props.lines.indexOf(lineKey.toLowerCase());
            if (oldLineKey > -1) {
                favourites.values[obj.mode][storageKey].props.lines.splice(oldLineKey, 1);
            }
            if (favourites.values[obj.mode][storageKey].props.lines.indexOf(lineKey) === -1) {
                favourites.values[obj.mode][storageKey].props.lines.push(lineKey);
            }
        } else {
            favourites.values[obj.mode][storageKey] = obj;
            stopAdded = true;
        }
        saveFavourites();
        return true;
    };
    favourites.getFavourites = function(modes, naptanId) {
        tfl.logs.create("tfl.favourites.getFavourites");
        var returnArray = [];
        if (!tfl.isLocalStorageSupported) {
            return returnArray;
        }
        var mode, val;
        if (!favourites.values) favourites.init();
        if (modes) {
            if (modes.indexOf(",") > -1) {
                modes = modes.split(",");
            }
            if (modes.constructor === Array) {
                for (var i = 0; i < modes.length; i++) {
                    mode = modes[i];
                    if (favourites.values.hasOwnProperty(mode)) {
                        for (val in favourites.values[mode]) {
                            if (favourites.values[mode].hasOwnProperty(val)) {
                                returnArray.push(favourites.values[mode][val]);
                            }
                        }
                    }
                }
            } else if (typeof modes === "string" && modes !== "" && favourites.values.hasOwnProperty(modes)) {
                mode = modes;
                if (typeof naptanId === "string" && naptanId !== "" && naptanId.indexOf("|") === -1) {
                    returnArray = getFavouritesArrayByNaptanId(mode, naptanId);
                } else {
                    if (favourites.values.hasOwnProperty(mode)) {
                        for (val in favourites.values[mode]) {
                            if (favourites.values[mode].hasOwnProperty(val)) {
                                returnArray.push(favourites.values[mode][val]);
                            }
                        }
                    }
                }
            }
        } else {
            for (mode in favourites.values) {
                for (val in favourites.values[mode]) {
                    if (favourites.values[mode].hasOwnProperty(val)) {
                        returnArray.push(favourites.values[mode][val]);
                    }
                }
            }
        }
        return returnArray;
    };
    favourites.removeFavourite = function(mode, storageKey, forceSave) {
        tfl.logs.create("tfl.favourites.removeFavourite");
        if (typeof mode !== "string" || mode === "" || typeof storageKey !== "string" || typeof storageKey === "number") {
            tfl.logs.create("Error in tfl.favourites.removeFavourite - Expected mode and key");
            return false;
        }
        var elementsRemoved = false;
        var stopRemoved = false;
        if (favourites.values.hasOwnProperty(mode)) {
            if (mode === "bus") {
                var storageKeys = storageKey.toUpperCase().split("|");
                storageKey = storageKeys[0];
                if (favourites.values[mode][storageKey]) {
                    if (storageKeys.length === 2) {
                        var lineKey = storageKeys[1];
                        var indexOfLineKey = favourites.values[mode][storageKey].props.lines.indexOf(lineKey);
                        if (indexOfLineKey > -1) {
                            favourites.values[mode][storageKey].props.lines.splice(indexOfLineKey, 1);
                            elementsRemoved = true;
                        }
                        var oldLineKey = favourites.values[mode][storageKey].props.lines.indexOf(lineKey.toLowerCase());
                        if (oldLineKey > -1) {
                            favourites.values[mode][storageKey].props.lines.splice(oldLineKey, 1);
                            elementsRemoved = true;
                        }
                    }
                    if (favourites.values[mode][storageKey].props && favourites.values[mode][storageKey].props.lines.length === 0) {
                        delete favourites.values[mode][storageKey];
                        stopRemoved = true;
                    }
                }
            } else {
                delete favourites.values[mode][storageKey];
                stopRemoved = true;
            }
        }
        if (elementsRemoved || stopRemoved) {
            if (forceSave) {
                saveFavourites();
            }
        }
        return elementsRemoved;
    };
    favourites.eraseFavourites = function() {
        favourites.values = {};
        favourites.backup = {};
        favourites.state.reset();
        favourites.personalisation.reset();
        localStorage.removeItem("favourites");
        localStorage.removeItem("has-personalisation-used");
    };
    favourites.setupStopLinks = function() {
        $(".map-panel-info").find(".live-arrivals-fav .favourite-ssp").hide();
        if (!$("body").hasClass("personalisation-active")) {
            return;
        }
        tfl.logs.create("tfl.favourites.setupStopLinks");
        var $stopLinks = $(".favourite-ssp");
        $stopLinks.each(function() {
            var mode = $(this).attr("data-mode");
            var naptanId = $(this).attr("data-naptan-id");
            var favouriteItems = favourites.getFavourites(mode, naptanId);
            if ($("body").hasClass("personalisation-active")) {
                var sspLink = $('.favourite-ssp-inner span[data-naptan-id="' + naptanId + '"]');
                if (sspLink.length > 0) {
                    if ($(this).parent().hasClass("map-panel-info")) {
                        if (favouriteItems.length === 0) {
                            $(this).find(sspLink).addClass("star-map-panel-info-icon-empty").removeClass("star-map-panel-info-icon-filled");
                            $(this).find(".fav-link-title").text("Add favourites");
                        } else {
                            $(this).find(sspLink).removeClass("star-map-panel-info-icon-empty").addClass("star-map-panel-info-icon-filled");
                            $(this).find(".fav-link-title").text("Edit favourites");
                        }
                    } else {
                        if (favouriteItems.length === 0) {
                            $(this).find(sspLink).addClass("star-icon-empty").removeClass("star-icon-filled");
                            $(this).find(".fav-link-title").text("Add favourites");
                            $(this).attr("title", "Add favourites");
                        } else {
                            $(this).find(sspLink).removeClass("star-icon-empty").addClass("star-icon-filled");
                            $(this).find(".fav-link-title").text("Edit favourites");
                            $(this).attr("title", "Edit favourites");
                        }
                    }
                }
            }
        });
        $stopLinks.off("click").on("click", function(e) {
            e.preventDefault();
            e.stopPropagation();
            var $this = $(this);
            tfl.favouritesTrack.trackBusFavouritesLinkClicked(e, $this);
            tfl.favouritesPanel.editFavouritesPanel.openEditFavouritesPanel($this.attr("data-mode"), $this.attr("data-naptan-id"), false);
        });
    };
    favourites.setupFavouritesAndRecent = function(opts) {
        if (!tfl.isLocalStorageSupported) {
            return;
        }
        var $target = $(opts.selector);
        if ($target.length) {
            tfl.ajax({
                url: "/static/" + tfl.settings.version + "/templates/" + opts.markup + ".html",
                success: function(response) {
                    injectFavouriteAndRecent($target, response, opts.modes, opts.limitClass);
                },
                dataType: "html"
            });
        }
    };
    favourites.setStatusBoardFavourites = function(statusBoardId, modes) {
        tfl.logs.create("tfl.favourites.setStatusBoardFavourites: " + statusBoardId + "; " + modes);
        var validPage = document.getElementById("service-status-page-board") !== null;
        if (!validPage) return;
        if (statusBoardId.indexOf("#") !== 0) {
            statusBoardId = "#" + statusBoardId;
        }
        var favouritedItems = tfl.favourites.getFavourites(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            var $allLines = $(statusBoardId);
            switch (modes) {
              case "traffic":
                {
                    $(statusBoardId).find("th .road-corridor").removeClass("is-favourite");
                    $(favouritedItems).each(function() {
                        var $road = $allLines.find("[data-corridor-name='" + this.dataCorridorName + "']");
                        $road.find("th .road-corridor").addClass("is-favourite");
                    });
                    break;
                }

              default:
                {
                    $(statusBoardId).find("span.service-name").removeClass("is-favourite");
                    $(favouritedItems).each(function() {
                        var $line = $allLines.find("[data-line-id='" + this.dataLineId + "']");
                        $line.find("span.service-name").addClass("is-favourite");
                    });
                    break;
                }
            }
        }
    };
    favourites.isFavouriteJourney = function(journey) {
        var journeyKey = journey.from + "|" + journey.to + "|" + journey.via;
        var journeys = favourites.getFavourites("journey");
        if (journeys && journeys.length > 0) {
            for (var i = 0, len = journeys.length; i < len; i++) {
                if (journeys[i].journeyFromTo === journeyKey) {
                    return true;
                }
            }
        }
        return false;
    };
    favourites.isFavouritePlace = function(placeName) {
        var places = favourites.getFavourites("place");
        return places.length > 0 && places.filter(filterByNameMatch(placeName)).length > 0;
        function filterByNameMatch(name) {
            return function(obj) {
                return obj.placeName === name;
            };
        }
    };
    favourites.init = function(setupStopLinks) {
        if (!tfl.isLocalStorageSupported) {
            return;
        }
        favourites.loadFavourites();
        if (setupStopLinks) {
            favourites.setupStopLinks();
        }
        var modeSelectors = [ {
            selector: ".tube-dlr-overground-tram-favourites-and-recent",
            modes: [ tfl.modeNameTube, tfl.modeNameDlr, tfl.modeNameOverground, tfl.modeNameTflRail, tfl.modeNameTram ],
            limitClass: ".favourites-box"
        }, {
            selector: ".river-favourites-and-recent",
            modes: [ tfl.modeNameRiver ],
            limitClass: ".favourites-box"
        }, {
            selector: ".favourite-and-recent",
            modes: [ tfl.modeNameBus ],
            limitClass: ".favourites-box"
        }, {
            selector: ".eal-favourites-and-recent",
            modes: [ tfl.modeNameCableCar ],
            limitClass: ".favourites-box"
        } ];
        for (var i = 0; i < modeSelectors.length; i++) {
            favourites.setupFavouritesAndRecent({
                selector: $(modeSelectors[i].selector),
                markup: "favourites-tabs",
                modes: modeSelectors[i].modes,
                limitClass: modeSelectors[i].limitClass
            });
        }
        tfl.logs.create("tfl.favourites.init: complete");
    };
    favourites.getFavourite = function(storageKey, modes) {
        tfl.logs.create("tfl.favourites.getFavourite");
        if (typeof storageKey !== "string" || storageKey === "") {
            tfl.logs.create("Error in tfl.favourites.getFavourite - Expected key");
            return false;
        }
        var mode;
        if (modes) {
            if (modes.constructor === Array) {
                for (var i = 0; i < modes.length; i++) {
                    mode = modes[i];
                    if (favourites.values.hasOwnProperty(mode)) {
                        if (favourites.values[mode][storageKey] !== undefined) return favourites.values[mode][storageKey];
                    }
                }
            } else if (typeof modes === "string" && modes !== "" && favourites.values.hasOwnProperty(modes)) {
                mode = modes;
                if (favourites.values[mode][storageKey] !== undefined) return favourites.values[mode][storageKey];
            }
        }
        for (var modeType in favourites.values) {
            if (favourites.values.hasOwnProperty(modeType)) {
                if (favourites.values[modeType][storageKey] !== undefined) return favourites.values[modeType][storageKey];
            }
        }
        return false;
    };
    favourites.updatePlaceLabel = function(placeName, label) {
        var place = favourites.getFavourite(placeName, tfl.modePlace);
        if (place) {
            favourites.removeFavourite(tfl.modePlace, placeName, true);
            place.label = label;
            place.props.label = label;
            favourites.addFavourite(place, true);
        }
    };
    function getFavouritesArrayByNaptanId(mode, naptanId) {
        tfl.logs.create("tfl.favourites.getFavouritesArrayByNaptanId");
        if (tfl.isLocalStorageSupported && favourites.values.hasOwnProperty(mode) && favourites.values[mode].hasOwnProperty(naptanId)) {
            return favourites.values[mode][naptanId].props.lines;
        }
        return [];
    }
    function hasClass(elem, cls) {
        return (" " + elem.className + " ").indexOf(" " + cls + " ") > -1;
    }
    function initFavourites() {
        tfl.logs.create("tfl.favourites.initFavourites");
        var k;
        favourites.values = {};
        for (k = 0; k < tfl.objects.modes.length; k += 1) {
            favourites.values[tfl.objects.modes[k]] = {};
        }
        favourites.values.traffic = {};
        favourites.backup = favourites.values;
    }
    function injectFavouriteAndRecent($favs, markup, modes, limitClass) {
        tfl.logs.create("tfl.favourites.injectFavouriteAndRecent");
        $favs.empty();
        var template = Hogan.compile(markup);
        var joinedModes = modes.join();
        switch (joinedModes) {
          case "cable-car":
            modes = [ tfl.modeNameCableCar ];
            break;

          case "river-bus":
            modes = [ tfl.modeNameRiver ];
            break;
        }
        switch (joinedModes) {
          case "cable-car":
            joinedModes = "Cable-Car";
            break;

          case "river-bus":
            joinedModes = "River-Bus";
            break;

          case "bus":
            joinedModes = "Bus";
            break;

          case "tube,dlr,overground,tram":
            joinedModes = "Tube, DLR, Overground, Tram";
            break;
        }
        var modeFavsData = favourites.getFavourites(modes);
        var modeRecentData = tfl.recent.getRecentArray(modes);
        var noItemsMessage = "";
        switch (joinedModes) {
          case "Bus":
            noItemsMessage = "You have not added any favourites. When you add a stop as a favourite, it will appear here.";
            break;

          case "River-Bus":
            noItemsMessage = "You have not added any favourites. When you add a River Bus pier as a favourite, it will appear here.";
            break;

          case "Tube, DLR, Overground, Tram":
            noItemsMessage = "You have not added any favourites. When you add a Tube, DLR, Overground and Tram station as a favourite, it will appear here.";
            break;

          case "Cable-Car":
            noItemsMessage = "You have not added any favourites. When you add an Emirates Air Line terminal as a favourite, it will appear here.";
            break;
        }
        function renderFavouriteAndRecent() {
            var favresult = template.render({
                items: modeFavsData,
                name: "favourite",
                hidden: "",
                itemsHeading: "favourites",
                noItemsMessage: noItemsMessage
            });
            var recentresult = template.render({
                items: modeRecentData,
                name: "recent",
                hidden: "hidden",
                itemsHeading: "recently searched " + joinedModes + " stops",
                noItemsMessage: "No " + joinedModes + " stops in your recent search history."
            });
            var $tabs = $('<div class="tab-wrapper"><ul class="tabs-style-2"><li class="selected" data-target="favourite"><a href="#">Favourites</a></li><li data-target="recent"><a href="#">Recent</a></li></ul></div>');
            $tabs.append(favresult);
            $tabs.append(recentresult);
            $favs.append($tabs);
            if (modeFavsData.length > 5) {
                tfl.navigation.pagination.setup($favs.find(".favourite " + limitClass).parent(), limitClass, 5, modeFavsData.length);
            }
            if (modeRecentData.length > 5) {
                tfl.navigation.pagination.setup($favs.find(".recent " + limitClass).parent(), limitClass, 5, modeRecentData.length);
            }
            $tabs = $favs.find(".tabs-style-2 > li:not(.not-for-beta)");
            $tabs.on("click", function(e) {
                e.preventDefault();
                e.stopPropagation();
                var $this = $(this);
                if (!$this.hasClass("selected")) {
                    var $sibs = $this.parent().siblings();
                    $sibs.addClass("hidden");
                    $sibs.filter("." + $this.data("target")).removeClass("hidden");
                    $this.addClass("selected").siblings(".selected").removeClass("selected");
                }
            });
            if (!$(markup).find(".links-only").length) {
                tfl.expandableBox.init();
            }
        }
        var modeData = modeFavsData.concat(modeRecentData);
        if (modeData.length) {
            var max = modeData.length;
            var ajaxData = {};
            var ajaxStopPoints = [];
            for (var i = 0; i < max; i += 1) {
                if (ajaxStopPoints.indexOf(modeData[i].naptanId) < 0) {
                    ajaxStopPoints.push(modeData[i].naptanId);
                }
            }
            var startDate = tfl.tools.getQueryStringParameter("startDate");
            if (startDate !== null) {
                ajaxData.url = tfl.utils.stringFormat(tfl.api.StopPointsDisruptionsTimePeriod, ajaxStopPoints.join(","), startDate, tfl.tools.getQueryStringParameter("endDate"));
            } else {
                ajaxData.url = tfl.utils.stringFormat(tfl.api.StopPointsDisruptions, ajaxStopPoints.join(","), "false", "true");
            }
            ajaxData.success = function(response) {
                for (var a = 0; a < response.length; a += 1) {
                    var ajaxStop = response[a];
                    var j;
                    favs: for (j = 0; j < modeFavsData.length; j += 1) {
                        if (modeFavsData[j].naptanId === ajaxStop.stationAtcoCode) {
                            modeFavsData[j].props.disrupted = "disrupted";
                            if (!modeFavsData[j].props.hasOwnProperty("disruptionInfo")) {
                                modeFavsData[j].props.disruptionInfo = "";
                            }
                            modeFavsData[j].props.disruptionInfo += "<p>" + response[a].description + "</p>";
                            break favs;
                        }
                    }
                    rec: for (j = 0; j < modeRecentData.length; j++) {
                        if (modeRecentData[j].naptanId === ajaxStop.stationAtcoCode) {
                            modeRecentData[j].props.disrupted = "disrupted";
                            if (!modeRecentData[j].props.hasOwnProperty("disruptionInfo")) {
                                modeRecentData[j].props.disruptionInfo = "";
                            }
                            modeRecentData[j].props.disruptionInfo += "<p>" + response[a].description + "</p>";
                            break rec;
                        }
                    }
                }
                if (joinedModes == "Bus") {
                    for (i = 0; i < modeFavsData.length; i += 1) {
                        modeFavsData[i].props.isBus = "true";
                    }
                }
                renderFavouriteAndRecent();
            };
            tfl.ajax(ajaxData);
        }
    }
    function isEmpty() {
        if (favourites.values === undefined) {
            return true;
        }
        for (var prop in favourites.values) {
            if (favourites.values.hasOwnProperty(prop)) {
                return false;
            }
        }
        return true && JSON.stringify(favourites.values) === JSON.stringify({});
    }
    function restoreFavourites() {
        if (favourites.backup && JSON.stringify(favourites.backup) !== JSON.stringify(favourites.values)) {
            favourites.values = {};
            favourites.values = $.extend(true, {}, favourites.backup);
            saveFavourites();
        }
    }
    function retrieveFavouritesFromDb() {
        if (!isUserLoggedIn()) {
            tfl.logs.create("fail to retrieve favourites as user is not logged in.");
            retrieveFavouritesFromLocalStorage();
            return;
        }
        tfl.ajax({
            url: tfl.web.GetFavourites,
            success: updateFavourites,
            error: function(response) {
                if (favourites.loadWithPanelOpen !== null) {
                    favourites.loadWithPanelOpen.setIsLoading(false);
                }
                $.removeCookie("username");
                $.removeCookie("isAuthorize");
                tfl.logs.create(response);
                tfl.logs.create("tfl.favourites.retrieveFavouritesFromDb error");
                retrieveFavouritesFromLocalStorage();
            },
            dataType: "json"
        });
    }
    function updateFavourites(response) {
        if (response && response.customerGuid && response.favourites) {
            tfl.logs.create("tfl.favourites.retrieveFavouritesFromDb successful");
            $.cookie("refreshFavourites", new Date(), {
                path: "/"
            });
            var dbFavourites = JSON.parse(response.favourites);
            retrieveFavouritesFromLocalStorage();
            for (var prop in dbFavourites) {
                if (dbFavourites.hasOwnProperty(prop)) {
                    if (!favourites.values.hasOwnProperty(prop) && prop !== "timestamp") {
                        delete dbFavourites[prop];
                    }
                }
            }
            if (response.customerGuid != tfl.storage.get(tfl.storage.storageKeys.favouritesAuth) || response.customerGuid == tfl.storage.get(tfl.storage.storageKeys.favouritesAuth) && (dbFavourites.timestamp >= favourites.values.timestamp || !("timestamp" in favourites.values))) {
                favourites.values = dbFavourites;
                if (!("timestamp" in favourites.values)) {
                    $.extend(favourites.values, {
                        timestamp: Date.now()
                    });
                }
            } else {
                saveFavouritesDb();
                return;
            }
        }
        if (response && response.customerGuid && response.favourites === null) {
            if (tfl.storage.get("favouritesAuth", null) && tfl.storage.get("favouritesAuth", null) == response.customerGuid || tfl.storage.get("favouritesAuth", null) === null) {
                retrieveFavouritesFromLocalStorage();
                favourites.state.changed();
            } else {
                favourites.values = {};
                favourites.backup = {};
                localStorage.removeItem("favourites");
                initFavourites();
            }
        }
        saveFavourites(response.customerGuid);
        if (favourites.loadWithPanelOpen !== null) {
            favourites.loadWithPanelOpen.setIsLoading(false);
        }
    }
    function retrieveFavouritesFromLocalStorage() {
        var fav = tfl.storage.get("favourites");
        if (fav && fav !== null) {
            for (var prop in fav) {
                if (fav.hasOwnProperty(prop)) {
                    if (!favourites.values.hasOwnProperty(prop) && prop !== "timestamp") {
                        delete fav[prop];
                    }
                }
            }
            favourites.values = $.extend(favourites.values, fav);
        }
        favourites.backup = $.extend(true, {}, favourites.values);
        if (favourites.loadWithPanelOpen !== null) {
            favourites.loadWithPanelOpen.setIsLoading(false);
        }
    }
    function saveFavourites(customerGuid) {
        tfl.logs.create("tfl.favourites.saveFavourites");
        if (customerGuid) {
            tfl.storage.set(tfl.storage.storageKeys.favouritesAuth, customerGuid);
        }
        if (tfl.favourites.state.hasChanged() || JSON.stringify(favourites.backup) !== JSON.stringify(favourites.values)) {
            favourites.state.changed();
            $.extend(favourites.values, {
                timestamp: Date.now()
            });
            tfl.storage.set("favourites", favourites.values);
            saveFavouritesDb();
            if (hasClass(document.body, "personalisation-active")) {
                if (!favourites.personalisation.hasBeenUsed()) {
                    favourites.personalisation.used();
                }
            }
        }
    }
    function saveFavouritesDb() {
        tfl.logs.create("tfl.favourites.saveFavouritesDb");
        if (!isUserLoggedIn()) {
            tfl.logs.create("can't save favourites as user is not logged in.");
            return;
        }
        tfl.ajax({
            url: tfl.web.SaveFavourites,
            headers: {
                Accept: "application/json"
            },
            data: {
                favourites: JSON.stringify(favourites.values)
            },
            dataType: "json",
            type: "POST",
            success: function() {
                tfl.logs.create("Favourites saved to account");
            },
            error: function() {
                tfl.logs.create("There was an error - favourites could not be saved to account");
            }
        });
    }
    if (document.URL.indexOf("stop") != -1 || document.URL.indexOf("map") != -1 || document.URL.indexOf("bus/status") != -1) {
        favourites.init(true);
    }
    favourites.stateChangeEvaluator = {
        oldKeys: [],
        multiModeCollection: [],
        isOldStateSet: false,
        init: function() {
            this.oldKeys = [];
            this.multiModeCollection = [];
            this.isOldStateSet = false;
        },
        setOldState: function(oldStateModes, isMultiMode) {
            var oldStateMode;
            if (isMultiMode) {
                var tempArray;
                for (var m = 0; m < oldStateModes.length; ++m) {
                    tempArray = [];
                    oldStateMode = tfl.favourites.values[oldStateModes[m]];
                    for (var n in oldStateMode) {
                        tempArray.push(n);
                    }
                    tempArray.sort();
                    this.multiModeCollection.push({
                        mode: oldStateModes[m],
                        values: tempArray
                    });
                }
            } else {
                for (var i = 0; i < oldStateModes.length; ++i) {
                    oldStateMode = tfl.favourites.values[oldStateModes[i]];
                    for (var j in oldStateMode) {
                        if (oldStateModes.indexOf(tfl.modeNameBus) >= 0) {
                            this.oldKeys = this.oldKeys.concat(oldStateMode[j].props.lines);
                        } else {
                            this.oldKeys.push(j);
                        }
                    }
                }
                this.oldKeys.sort();
            }
            this.isOldStateSet = true;
        },
        clearOldState: function() {
            this.init();
        },
        hasModeStateChanged: function(modesArray) {
            if (modesArray instanceof Array && this.isOldStateSet) {
                var modeKeys = [];
                for (var i = 0; i < modesArray.length; ++i) {
                    var modeFavourites = tfl.favourites.values[modesArray[i]];
                    for (var modeItem in modeFavourites) {
                        if (modesArray.indexOf(tfl.modeNameBus) >= 0) {
                            modeKeys = modeKeys.concat(modeFavourites[modeItem].props.lines);
                        } else {
                            modeKeys.push(modeItem);
                        }
                    }
                }
                if (modeKeys.length !== this.oldKeys.length) return true;
                modeKeys.sort();
                for (var k = 0; k < modeKeys.length; ++k) {
                    if (modeKeys[k] !== this.oldKeys[k]) {
                        return true;
                    }
                }
            }
            return false;
        },
        getModesStateChanged: function(modes) {
            var modesChanged = [];
            if (modes instanceof Array && this.isOldStateSet) {
                for (var i = 0; i < modes.length; ++i) {
                    if (modes[i] === this.multiModeCollection[i].mode) {
                        var mode = modes[i];
                        var newState = tfl.favourites.values[modes[i]];
                        var oldState = this.multiModeCollection[i];
                        if (newState === undefined || oldState === undefined) {
                            continue;
                        }
                        if (Object.getOwnPropertyNames(newState).length !== oldState.values.length) {
                            modesChanged.push(mode);
                            continue;
                        }
                        var modeKeys = [];
                        for (var modeItem in newState) {
                            modeKeys.push(modeItem);
                        }
                        modeKeys.sort();
                        for (var k = 0; k < modeKeys.length; ++k) {
                            if (modeKeys[k] !== this.multiModeCollection[i].values[k]) {
                                if (modesChanged.indexOf(mode) < 0) {
                                    modesChanged.push(mode);
                                }
                                if (modesChanged.length === modes.length) {
                                    break;
                                }
                            }
                        }
                    }
                }
            }
            return modesChanged;
        }
    };
    favourites.initBusLandingPage = function(searchFormId) {
        var hasBusFavourites = favourites.getFavourites(tfl.modeNameBus).length;
        var searchFilterContainer = $("#search-filter-form").parent("[class^='search-filter']");
        var busArrivalsWidget = $(".bus-arrivals-widget");
        if (hasBusFavourites) {
            searchFilterContainer.addClass("hidden");
            busArrivalsWidget.removeClass("hidden");
            var busArrivalsWidgetBtn = busArrivalsWidget.find("#editBtnTube");
            if (busArrivalsWidgetBtn) {
                busArrivalsWidgetBtn.attr("data-tracking-event", event.PersonalisationOpenPanel_prop41);
                busArrivalsWidgetBtn.attr("data-tracking", prop.OpenPanel_41.Name);
                busArrivalsWidgetBtn.attr("data-tracking-value", prop.OpenPanel_41.BusLandingPageEdit);
            }
            displayBusStatusOnBusLandingPage();
        } else {
            searchFilterContainer.removeClass("hidden");
            busArrivalsWidget.addClass("hidden");
        }
    };
    favourites.checkBusLandingPage = function() {
        var busArrivalsWidget = $("#bus-landing-status-updates");
        if (busArrivalsWidget) {
            var viewBusStatus = busArrivalsWidget.find(".view-bus-status");
            if (viewBusStatus) {
                viewBusStatus.attr("data-tracking-event", event.PersonalisationOpenPanel_prop41);
                viewBusStatus.attr("data-tracking", prop.OpenPanel_41.Name);
                viewBusStatus.attr("data-tracking-value", prop.OpenPanel_41.BusLandingPageView);
            }
        }
    };
    function displayBusStatusOnBusLandingPage() {
        var mode = tfl.modeNameBus;
        tfl.homeFavourites.setAutoRefreshByMode(tfl.modeNameBus);
        tfl.homeFavourites.showStatusFavourite(tfl.homeFavourites.favs.statusPanelId(mode), mode);
    }
})(window.tfl.favourites = window.tfl.favourites || {}, jQuery);

(function(o) {
    "use strict";
    if (!$("body").hasClass("personalisation-active")) return;
    var panels = {
        editPanel: {
            wrapper: "#o-wrapper",
            type: "#fav-panel-edit",
            menuOpenerClass: ".c-button",
            maskId: "#c-mask",
            isActive: false
        },
        statusPanel: {
            wrapper: "#o-wrapper",
            type: "#fav-panel-status",
            menuOpenerClass: ".c-button",
            maskId: "#c-mask",
            isActive: false
        },
        cookieMessageContainer: ".js-panelwrapper .js-cookiemessagecontainer"
    };
    if (!document.querySelector(panels.statusPanel.type)) {
        tfl.logs.create("tfl.favourites-panel: Not loaded as status panel not found on the page.", "warn");
        return;
    }
    tfl.logs.create("tfl.favourites-panel: loaded");
    var cookieConsentEventData = {
        consent: !window.hasCookieBot() ? {} : CookieConsent.consent
    };
    if (!window.hasCookieBot()) {
        tfl.logs.create("CookieConsent is undefined, looks like cookiebot script failed to load");
    }
    o.onLoadFavourites = new CustomEvent("OnLoadFavourites", {
        detail: cookieConsentEventData
    });
    window.addEventListener("OnLoadFavourites", function(e) {
        if (e.detail.consent.preferences) {
            setTimeout(enableFavourites, 50, e.detail);
        } else {
            setTimeout(disableFavourites, 50, e.detail);
        }
        refreshJourneyPlanner();
    });
    function enableFavourites() {
        var $wrapper = $(panels.cookieMessageContainer);
        if ($wrapper.length) {
            var $cookieWarningContainer = $wrapper.find(".js-cookie-warning");
            var $cookieWarningMessageContainer = $cookieWarningContainer.find("> p");
            $cookieWarningMessageContainer.empty();
            $cookieWarningContainer = $wrapper.find(".js-cookie-renew");
            var $cookieWarningLinkContainer = $cookieWarningContainer.find("> a");
            $cookieWarningLinkContainer.empty();
        }
    }
    function disableFavourites() {
        var $wrapper = $(panels.cookieMessageContainer);
        if ($wrapper.length) {
            var $cookieWarningContainer = $wrapper.find(".js-cookie-warning");
            var $cookieWarningMessageContainer = $cookieWarningContainer.find("> p");
            $cookieWarningMessageContainer.text($cookieWarningContainer.data("warning-message"));
            $cookieWarningContainer = $wrapper.find(".js-cookie-renew");
            var $cookieWarningLinkContainer = $cookieWarningContainer.find("> a");
            $cookieWarningLinkContainer.text($cookieWarningContainer.data("cookie-message"));
        }
    }
    var favUtils = tfl.favouritesUtils.helper;
    var favs = {
        ftuElementsCount: tfl.favouritesUtils.helper.modes.length,
        getModes: function(modeTab) {
            if (modeTab === undefined) return null;
            switch (modeTab.toLowerCase()) {
              case "tube, overground, tfl rail, dlr & tram":
              case "lines":
                return [ tfl.modeNameTube, tfl.modeNameDlr, tfl.modeNameOverground, tfl.modeNameTflRail, tfl.modeNameTram ];

              case "bus":
              case "buses":
                return tfl.modeNameBus;

              case "traffic":
                return tfl.modeNameTraffic;

              case "river bus":
              case "riverbus":
                return tfl.modeNameRiver;

              case "emirates air line":
              case "cablecar":
                return tfl.modeNameCableCar;

              case "journey":
                return tfl.modeJourney;

              case "place":
                return tfl.modePlace;

              case "journey, place":
              case "journey-place":
                return [ tfl.modeJourney, tfl.modePlace ];

              default:
                return null;
            }
        },
        editPanelId: function(modes) {
            return "#fav-edit-".concat(favUtils.modesSuffix(modes));
        },
        statusPanelId: function(modes) {
            return "#fav-status-".concat(favUtils.modesSuffix(modes));
        },
        errorId: function(modes) {
            return "#fav-error-".concat(favUtils.modesSuffix(modes));
        },
        statusBoardId: function(modes) {
            if (modes === "traffic") {
                return "#fav-panel-rainbow-list-roads";
            }
            return "#fav-panel-rainbow-list-".concat(favUtils.modesSuffix(modes));
        },
        addFavouriteId: function(modes) {
            return "#add-".concat(favUtils.modesSuffix(modes));
        },
        placeTypes: [ "stop", "bikepoint", "placesExtra" ],
        getFavouritedModeText: function(modeText) {
            var favModeText = "";
            var textMapper = {
                "Tube, Overground, TfL Rail, DLR & Tram": "My Lines",
                Buses: "My Buses",
                Traffic: "My Roads",
                "River Bus": "My River Buses",
                "Emirates Air Line": "My Emirates Air Line"
            };
            favModeText = textMapper[modeText];
            return favModeText;
        }
    };
    function hideEditFavourites() {
        for (var mode = 0; mode < favUtils.modes.length; mode++) {
            $(favs.editPanelId(favUtils.modes[mode])).hide();
        }
    }
    function toggleViewStatusFavourites(show) {
        var mode;
        if (show) {
            for (mode = 0; mode < favUtils.modes.length; mode++) {
                showStatusFavourite(favs.statusPanelId(favUtils.modes[mode]), favUtils.modes[mode]);
            }
            displayFavouritesHeading();
        } else {
            for (mode = 0; mode < favUtils.modes.length; mode++) {
                $(favs.statusPanelId(favUtils.modes[mode])).hide();
            }
        }
    }
    function foundModeInArray(favItems, item) {
        var found = false;
        favItems.some(function(el) {
            if (el.mode === item) {
                found = true;
            }
        });
        return found;
    }
    function isEveryGroupedModeFavourited() {
        var favItems = tfl.favourites.getFavourites();
        var numOfGroupedModes = favUtils.modes.length, i, j;
        for (i = 0; i < numOfGroupedModes; i++) {
            if (Array.isArray(favUtils.modes[i])) {
                var foundatleastone;
                for (j = 0; j < favUtils.modes[i].length; j++) {
                    foundatleastone = foundModeInArray(favItems, favUtils.modes[i][j]);
                    if (foundatleastone) break;
                }
                if (!foundatleastone) return false;
            } else {
                var found = foundModeInArray(favItems, favUtils.modes[i]);
                if (!found) {
                    return false;
                }
            }
        }
        return true;
    }
    function displayFavouritesHeading() {
        if (isEveryGroupedModeFavourited()) {
            $("#fav-add-favourites").hide();
        } else {
            $("#fav-add-favourites").show();
        }
    }
    function showStatusFavourites() {
        tfl.favourites.loadFavourites(false);
        toggleViewStatusFavourites(false);
        document.getElementById("fav-panel-status").scrollTop = 0;
        toggleViewStatusFavourites(true);
        updateFavouritesHeading();
    }
    function updateFavouritesHeading() {
        var favouritedItems = tfl.favourites.getFavourites();
        var favouritesHeading = $("#addFavouritesHeading");
        if (favouritedItems && favouritedItems.length > 0) {
            favouritesHeading.html(favouritesHeading.data("text-add"));
        } else {
            favouritesHeading.html(favouritesHeading.data("text-first-time"));
        }
    }
    function showStatusFavourite(modePanel, modes) {
        var favouritedItems = tfl.favourites.getFavourites(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            var params = {
                collapsed: typeof modes === "string" && modes === tfl.modeNameTraffic,
                isHomeOrModePageStatusBoard: false,
                isStatusUpdatesPage: false,
                isFavouritesPanel: true,
                isHomePageFavouritesWidget: false,
                favItems: favouritedItems
            };
            if (modes !== tfl.modeJourney && modes !== tfl.modePlace) {
                ajaxStatusBoard(favUtils.ajaxUrlStatusBoardUpdate(modes, params), favs.statusBoardId(modes), modes);
            }
            if (modes === tfl.modePlace) {
                buildRenderPlaceLineItems(modePanel, favouritedItems);
            }
            if (modes == tfl.modeJourney) {
                buildRenderStatusJourneys();
            }
            $(modePanel).show();
            $(favs.addFavouriteId(modes)).hide();
        } else {
            $(favs.addFavouriteId(modes)).show();
        }
    }
    function showPromoBanner() {
        tfl.favourites.loadBanner();
    }
    function showLoginPanel() {
        var $loginPanel = $(".fav-signout"), $userNamePanel = $(".fav-username"), username = tfl.favourites.getUsername(), $loginNewAccountPanel = $(".login-new-account-link");
        if (username) {
            $loginPanel.show();
            $userNamePanel.html("Hi, " + username);
            $loginNewAccountPanel.hide();
        } else {
            $loginPanel.hide();
            var openPanelParam = window.location.href.indexOf("?") > -1 ? "&FavPanel=true" : "?FavPanel=true";
            $("#login-link").attr("href", "/Login?ReturnUrl=" + encodeURIComponent(window.location.pathname + window.location.search + openPanelParam));
            $("#fav-create-account-link").attr("href", tfl.createAccountLink);
            $loginNewAccountPanel.show();
        }
    }
    function signOut() {
        tfl.ajax({
            dataType: "html",
            url: tfl.web.LogOut,
            type: "GET",
            data: {},
            success: function(response) {
                location.reload();
            }
        });
    }
    $("#btn-logout").off("click").on("click", function() {
        var noLongerOpenFavPanelUrl = window.location.href.replace("&FavPanel=true", "").replace("FavPanel=true&", "").replace("?FavPanel=true", "");
        window.history.replaceState({}, document.title, noLongerOpenFavPanelUrl);
        signOut();
    });
    function showEditFavourites(modes, naptanIds, includeReturn, data) {
        o.editFavouritesPanel.modes = modes;
        if (typeof naptanIds === "string" && naptanIds !== "" && naptanIds.indexOf(",") > -1) {
            var naptanIdItems = naptanIds.split(",");
            for (var nid = 0; nid < naptanIdItems.length; nid++) {
                showEditFavourite(favs.editPanelId(modes), modes, naptanIdItems[nid], includeReturn, null);
            }
        } else {
            showEditFavourite(favs.editPanelId(modes), modes, naptanIds, includeReturn, data);
        }
        setFocusOnEditPanel();
        if (modes === tfl.modePlace) {
            $(favs.editPanelId(modes)).find("#InputFavPlace").on("keydown", function(e) {
                if (!isTabKeyDown(e)) return;
                refocusToPanelHeader(e, o.editFavouritesPanel.options.type);
            });
        } else if (modes === tfl.modeNameBus) {
            $(favs.editPanelId(modes)).find("#InputFavBus").on("keydown", function(e) {
                if (!isTabKeyDown(e)) return;
                refocusToPanelHeader(e, o.editFavouritesPanel.options.type);
            });
        } else {
            $(favs.editPanelId(modes)).find("li:last").on("keydown", function(e) {
                if (!isTabKeyDown(e)) return;
                refocusToPanelHeader(e, o.editFavouritesPanel.options.type);
            });
        }
        $(favs.editPanelId(modes)).show();
    }
    var showEditFavourite = function(selectedList, modes, naptanId, includeReturn, data) {
        var journeyData = data;
        var placeStorageKey;
        var journeyStorageKey;
        var favouritedItems = tfl.favourites.getFavourites(modes, naptanId);
        var currentMode;
        var isRecents = journeyData && journeyData.journeyType && journeyData.journeyType === "recents";
        if (!favouritedItems) {
            tfl.logs.create("tfl.favourites-panel.showEditFavourite: getFavourites error - it should always return an array, even an empty array");
            return;
        }
        var select;
        if (selectedList === "#fav-edit-journey-place") {
            buildRenderEditMyJourney(journeyData, selectedList, favouritedItems);
            journeyStorageKey = journeyData.from + "|" + journeyData.to + "|" + journeyData.via;
            select = document.querySelectorAll("#fav-panel-edit .fav-panel-details .fav-journey-place .fav-rainbow-list-link");
        } else {
            if (selectedList === "#fav-edit-place") {
                buildRenderPlaceLineItems(selectedList, favouritedItems);
            } else if (selectedList === "#fav-edit-journey") {
                buildRenderEditJourneys(journeyData);
            }
            select = selectedList + " li .fav-rainbow-list-link";
        }
        if (naptanId && naptanId !== "") {
            select = select + ".naptan-" + naptanId;
        }
        $(select).each(function() {
            var selected = $(this);
            var closestListItem = selected.closest("li");
            var mode = closestListItem.attr("data-mode");
            if (modes.indexOf(mode) > -1) {
                var storageKey;
                var favouriteItem;
                var favourite = false;
                switch (mode) {
                  case "traffic":
                    storageKey = closestListItem.attr("data-corridor-name");
                    favouriteItem = favouritedItems.filter(function(obj) {
                        return obj.dataCorridorName === storageKey;
                    });
                    favourite = favouriteItem.length > 0;
                    break;

                  case "bus":
                    var storageKeys = closestListItem.attr("data-naptan-line").split("|");
                    storageKey = storageKeys[0];
                    var lineKey = storageKeys[1];
                    favourite = favouritedItems.indexOf(lineKey) > -1;
                    break;

                  case tfl.modeJourney:
                    var journeyFrom = closestListItem.attr("data-from");
                    var journeyTo = closestListItem.attr("data-to");
                    var journeyVia = closestListItem.attr("data-via");
                    storageKey = journeyFrom + "|" + journeyTo + "|" + journeyVia;
                    favouriteItem = favouritedItems.filter(function(obj) {
                        return obj.journeyFromTo === storageKey;
                    });
                    favourite = favouriteItem.length > 0;
                    break;

                  case "place":
                    var placeFrom = closestListItem.attr("data-from");
                    var placeTo = closestListItem.attr("data-to");
                    var placeVia = closestListItem.attr("data-via");
                    storageKey = selected.find(".fav-place-text").text();
                    favouriteItem = favouritedItems.filter(function(obj) {
                        return obj.placeName === storageKey;
                    });
                    favourite = favouriteItem.length > 0;
                    break;

                  default:
                    storageKey = closestListItem.attr("data-line-id");
                    favouriteItem = favouritedItems.filter(function(obj) {
                        return obj.dataLineId === storageKey;
                    });
                    favourite = favouriteItem.length > 0;
                    break;
                }
                if (storageKey) {
                    if (favourite) {
                        $(this).removeClass("fav-star-off").addClass("fav-star-on");
                        $(this).attr("aria-checked", "true");
                        if (mode === tfl.modeJourney && isRecents) {
                            closestListItem.remove();
                        }
                    } else {
                        $(this).removeClass("fav-star-on").addClass("fav-star-off");
                        $(this).attr("aria-checked", "false");
                    }
                }
            }
        });
        $("#fav-edit-place .fav-panel-close").show();
        if (selectedList === "#fav-edit-journey-place") {
            var journeyIsFavourite = favouritedItems.some(function(element) {
                return element.mode == tfl.modeJourney && element.journeyFromTo == journeyStorageKey;
            });
            var placeIsFavourite = favouritedItems.some(function(element) {
                return element.mode == tfl.modePlace && (element.placeName == journeyData.from || element.placeName == journeyData.to);
            });
            var $journeySubheading = $("#sub-heading-journey");
            var $placeSubheading = $("#sub-heading-place");
            if (journeyIsFavourite || placeIsFavourite) {
                $journeySubheading.data("track-option", $journeySubheading.data("text-edit"));
                $placeSubheading.data("track-option", $placeSubheading.data("text-edit"));
            } else {
                $journeySubheading.data("track-option", $journeySubheading.data("text-add"));
                $placeSubheading.data("track-option", $placeSubheading.data("text-add"));
            }
        } else if (selectedList === "#fav-edit-journey") {
            var $foundFavJourneys = $("#sub-heading-journey");
            if (isRecents) {
                $foundFavJourneys.data("track-option", $foundFavJourneys.data("text-add-recents"));
            } else {
                $foundFavJourneys.data("track-option", $foundFavJourneys.data("text-edit"));
            }
            $(selectedList + " > div").show();
        } else {
            var $subHeading = $(selectedList).find("h2[id^=sub-heading]");
            if (tfl.favourites.getFavourites(modes, naptanId).length) {
                $subHeading.data("track-option", $subHeading.data("text-edit"));
            } else {
                $subHeading.data("track-option", $subHeading.data("text-add"));
            }
        }
    };
    function toggleFavourite(selected) {
        var mode = selected.closest("li").attr("data-mode");
        if (!mode || typeof mode !== "string") {
            return false;
        }
        var modeIcons = [];
        if (mode === tfl.modePlace) {
            selected.find("span.mode-icon").each(function(index, element) {
                modeIcons.push($(element).attr("class").replace("mode-icon ", ""));
            });
        }
        var storageKey;
        var favourite;
        var closestItem;
        switch (mode) {
          case "bus":
            storageKey = selected.closest("li").attr("data-naptan-line");
            favourite = {
                mode: mode,
                naptanLineId: storageKey
            };
            break;

          case "traffic":
            storageKey = selected.closest("li").attr("data-corridor-name");
            favourite = {
                mode: mode,
                dataCorridorName: storageKey
            };
            break;

          case tfl.modeJourney:
            closestItem = selected.closest("li");
            storageKey = closestItem.attr("data-from") + "|" + closestItem.attr("data-to") + "|" + closestItem.attr("data-via");
            favourite = {
                mode: mode,
                journeyFromTo: storageKey,
                props: {
                    from: closestItem.attr("data-from"),
                    fromId: closestItem.attr("data-from-id"),
                    to: closestItem.attr("data-to"),
                    toId: closestItem.attr("data-to-id"),
                    via: closestItem.attr("data-via"),
                    viaId: closestItem.attr("data-via-id")
                }
            };
            break;

          case tfl.modePlace:
            closestItem = selected.closest("li");
            var placeFrom = closestItem.attr("data-from");
            var placeTo = closestItem.attr("data-to");
            var placeVia = closestItem.attr("data-via");
            storageKey = selected.find(".fav-place-text").text();
            favourite = {
                mode: mode,
                placeName: storageKey,
                props: {
                    modeIcons: modeIcons,
                    modes: closestItem.attr("data-modes"),
                    id: closestItem.attr("data-id"),
                    placeId: closestItem.attr("data-place-id"),
                    lat: closestItem.attr("data-lat"),
                    lon: closestItem.attr("data-lon"),
                    placeFrom: placeFrom,
                    placeTo: placeTo,
                    placeVia: placeVia
                }
            };
            break;

          default:
            storageKey = selected.closest("li").attr("data-line-id");
            favourite = {
                mode: mode,
                dataLineId: storageKey,
                modeIcons: modeIcons
            };
            break;
        }
        if (!storageKey) {
            return false;
        }
        var favouritedItems = tfl.favourites.getFavourites();
        if (selected.hasClass("fav-star-off")) {
            selected.removeClass("fav-star-off").addClass("fav-star-on");
            selected.attr("aria-checked", "true");
            tfl.favourites.addFavourite(favourite);
        } else {
            selected.removeClass("fav-star-on").addClass("fav-star-off");
            selected.attr("aria-checked", "false");
            tfl.favourites.removeFavourite(mode, storageKey, true);
        }
    }
    o.favouriteTab = document.querySelector(".favourite-tab");
    o.favouriteTabClickHandler = function() {
        if (o.favouriteTab) {
            return o.favouriteTab.addEventListener("click", function(e) {
                e.preventDefault();
                tfl.favouritesTrack.trackEditPanelOpenedFromStatusUpdate(e);
                o.editFavouritesPanel.openEditFavouritesPanel($(".modes-dropdown-placeholder .modes-list").attr("data-selected-item-id"), null, false);
            });
        }
    }();
    o.editFavouritesPanel = new Menu(panels.editPanel);
    o.editFavouritesPanel.openEditFavouritesPanel = function(modeTab, naptanId, includeReturn, data) {
        o.openStatusFavouritesPanel();
        stopAllAjaxAutoRefresh();
        stopBusStatusSignalr();
        hideEditFavourites();
        hideFTUPanel();
        var modes = getModes(modeTab);
        displayExtraContent(modes, naptanId, includeReturn);
        showEditFavourites(modes, naptanId, includeReturn, data);
        document.getElementById("fav-panel-edit").scrollTop = 0;
        o.editFavouritesPanel.open();
        $("#fav-panel-edit").attr("aria-hidden", "false");
        $("#fav-panel-edit").attr("aria-label", "Edit " + modeTab + " favourites");
        $("#fav-panel-status").attr("aria-hidden", "true");
        var editPanelModes = o.editFavouritesPanel.modes instanceof Array ? o.editFavouritesPanel.modes : [ o.editFavouritesPanel.modes ];
        tfl.favourites.stateChangeEvaluator.setOldState(editPanelModes);
        if (modes === "bus" && /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
            $("#search-filter-form-fav > > > > .tt-dropdown-menu").on("show", function() {
                tfl.logs.create(".tt-dropdown-menu show");
                var $ttDropdown = $("#fav-bus-search-filter .tt-dropdown-menu");
                if ($ttDropdown && $ttDropdown[0]) {
                    var ttDropdownHeight = $ttDropdown[0].clientHeight;
                    if (ttDropdownHeight > 0) {
                        tfl.logs.create("bus search height show " + ttDropdownHeight);
                        var additionalAdjustment = 250;
                        var $statusBoard = $("#fav-edit-bus .fav-service-status-rainbow-board");
                        if ($statusBoard && $statusBoard[0] && $statusBoard[0].clientHeight > 0) {
                            additionalAdjustment = additionalAdjustment + $statusBoard[0].clientHeight;
                        }
                        o.editFavouritesPanel.resizePanelHeight($(document).height() + ttDropdownHeight - additionalAdjustment);
                    } else {
                        o.editFavouritesPanel.resizePanelHeight(40);
                    }
                }
            });
            $("#search-filter-form-fav > > > > .tt-dropdown-menu").on("hide", function() {
                o.editFavouritesPanel.resizePanelHeight(40);
            });
        }
        o.editFavouritesPanel.isActive = true;
    };
    o.editFavouritesPanel.resizePanelHeight = function(height) {
        var searchFilter = document.getElementById("fav-bus-search-filter");
        if (searchFilter && searchFilter.style.height !== height + "px") {
            tfl.logs.create("bus search height resize " + height);
            searchFilter.style.height = height + "px";
        }
    };
    function getModes(modeTab) {
        if (modeTab && typeof modeTab === "string" && modeTab !== "") {
            return favs.getModes(modeTab);
        } else {
            return null;
        }
    }
    function displayExtraContent(modes, naptanId, includeReturn) {
        if (modes === "bus") {
            $("#fav-rainbow-list-bus").parent().replaceWith('<div class="fav-service-status-rainbow-board board-wrapper"><div id="fav-rainbow-list-bus"></div></div>');
            $("#search-heading-bus").hide();
            if (naptanId === null) {
                ajaxEditBuses(includeReturn);
                $("#fav-bus-search").show();
            } else {
                ajaxEditBus(naptanId, includeReturn);
                $("#fav-bus-search").hide();
            }
        }
    }
    function closeEditPanel(event) {
        tfl.logs.create("tfl.favourites-panel: closeEditPanel");
        var isAnalyticsTrackingEventFired = tfl.favouritesTrack.trackEditPanelClosed(event, o.editFavouritesPanel.modes);
        o.editFavouritesPanel.close();
        showNotification();
        refreshHomePageStatus();
        refreshBusLandingPageStatus();
        refreshJourneyPlanner();
        refreshSearchFilters(o.editFavouritesPanel.modes);
        refreshBusRouteAndTimetablePages();
        tfl.favourites.state.reset();
        o.editFavouritesPanel.isActive = false;
        $("#fav-panel-edit").attr("aria-hidden", "true");
        $("#fav-panel-status").attr("aria-hidden", "false").find("a:visible:first").focus();
        return isAnalyticsTrackingEventFired;
    }
    o.panelMask = document.getElementById("c-mask");
    o.panelMask.addEventListener("click", function(e) {
        e.preventDefault();
        closeCurrentPanel(e);
    });
    o.closeButtons = document.querySelectorAll(".fav-panel__close");
    for (var cb = 0; cb < o.closeButtons.length; cb++) {
        var closeButton = o.closeButtons[cb];
        closeButton.addEventListener("click", closeCurrentPanel, false);
    }
    function closeCurrentPanel(e) {
        if (o.editFavouritesPanel.isActive) {
            closeEditAndRefresh(e);
        } else if (o.statusFavouritesPanel.isActive) {
            closeStatusPanel(e);
        } else {
            closeEditAndRefresh(e);
            closeStatusPanel(e);
        }
    }
    o.closeCurrentPanel = closeCurrentPanel;
    o.Panel = document.getElementsByClassName("fav-panel");
    var swipePanel = new Hammer(o.Panel);
    swipePanel.on("swiperight", function(e) {
        e.gesture.preventDefault();
        closeCurrentPanel(e);
    });
    function hideFTUPanel() {
        $("#fav-add-favourites .fav-forward-to-all").hide();
    }
    function closeStatusPanel(e) {
        tfl.favouritesTrack.trackStatusPanelClosed(e);
        o.statusFavouritesPanel.close();
        o.statusFavouritesPanel.isActive = false;
        tfl.favourites.setupStopLinks();
        o.updateFavouritesText(favs.getModes(o.currentMode));
        tfl.favourites.setupStopLinks();
        removeTabbingFromAllAnchors();
        $("#fav-panel-status").attr("aria-hidden", "true");
        $("[data-control-favourites]").attr("aria-expanded", "false");
    }
    function refreshStatusPage() {
        if (o.editFavouritesPanel.modes === "traffic") {
            tfl.favourites.setStatusBoardFavourites("rainbow-list-roads", o.editFavouritesPanel.modes);
        } else {
            tfl.favourites.setStatusBoardFavourites("rainbow-list-" + favUtils.modesSuffix(o.editFavouritesPanel.modes), o.editFavouritesPanel.modes);
        }
    }
    function stopAllAjaxAutoRefresh() {
        for (var mode = 0; mode < favUtils.modes.length; mode++) {
            tfl.stopAjaxAutoRefresh(favs.statusBoardId(favUtils.modes[mode]));
        }
    }
    function stopBusStatusSignalr() {
        updateStatusBuses(favs.statusBoardId(tfl.modeNameBus));
        tfl.predictions.init("#fav-panel-rainbow-list-bus", true);
    }
    function closeEditAndRefresh(e) {
        tfl.favourites.state.reset();
        closeEditPanel(e);
        refreshStatusFavouritesPanel();
    }
    function refocusToModeEditLink(e, statusPanelModeSelector) {
        if (!isTabKeyDown(e) || !statusPanelModeSelector) return;
        statusPanelModeSelector.find(".fav-forward-to a").focus();
    }
    function refocusToPanelHeader(e, currentPanel) {
        var keyCode = e.keyCode || e.which;
        if (keyCode != 9) return;
        e.preventDefault();
        $(currentPanel + " > .fav-panel-header").find("a:first").focus();
    }
    function showNotification() {}
    function refreshHomePageStatus() {
        tfl.homeFavourites.updateAndRefresh();
    }
    function refreshBusRouteAndTimetablePages() {
        if (tfl.routes) {
            tfl.routes.syncUpFavourites();
        }
    }
    function refreshBusLandingPageStatus() {
        if ($("#bus-landing-status-updates").length) {
            tfl.logs.create("tfl.favouritesPanel: on bus landing page update");
            tfl.favourites.initBusLandingPage();
        }
    }
    function refreshJourneyPlanner() {
        if (tfl.journeyPlanner && tfl.journeyPlanner.settings && tfl.journeyPlanner.settings.pageName) {
            var isSmall = $("#hp-journeys-recents").is(":visible");
            tfl.journeyPlanner.refreshJourneys(tfl.journeyPlanner.settings.pageName);
        }
    }
    function refreshSearchFilters(modes) {
        if (!favUtils.includesMode(modes, "place")) {
            return;
        }
        tfl.searchFilter.init();
    }
    o.statusFavouritesPanel = new Menu(panels.statusPanel);
    o.openStatusFavouritesPanel = function(mode) {
        if (o.statusFavouritesPanel.isActive) {
            return;
        }
        $("[data-control-favourites").attr("aria-expanded", "true");
        showLoginPanel();
        showPromoBanner();
        if (tfl.favourites.loadWithPanelOpen.getIsLoading()) {
            $(".fav-panel-details fav-panel__items").addClass("fav-loading-data");
        } else {
            showStatusFavourites();
        }
        o.statusFavouritesPanel.open();
        o.statusFavouritesPanel.isActive = true;
        $(o.statusFavouritesPanel.options.type).attr("aria-hidden", "false").find("a:visible:first").focus();
        $(o.statusFavouritesPanel.options.type).find("a:visible:last").on("keydown", function(e) {
            refocusToPanelHeader(e, o.statusFavouritesPanel.options.type);
        });
    };
    tfl.favourites.loadWithPanelOpen = tfl.favourites.refreshWhenLoaded(function(isLoading) {
        if (!isLoading && o.statusFavouritesPanel.isActive) {
            $(".fav-panel-details fav-panel__items").removeClass("fav-loading-data");
            toggleViewStatusFavourites(false);
            document.getElementById("fav-panel-status").scrollTop = 0;
            toggleViewStatusFavourites(true);
            updateFavouritesHeading();
        }
    });
    o.viewAllStatusLink = document.querySelectorAll("[id ^= 'fav-status-'] > .fav-forward-to-all");
    for (var i = 0; i < o.viewAllStatusLink.length; ++i) {
        var viewStatusLink = o.viewAllStatusLink[i];
        viewStatusLink.addEventListener("click", viewAllStatusLinkClicked, false);
    }
    function viewAllStatusLinkClicked(e) {
        tfl.favouritesTrack.trackAllStatusLinkClicked(e);
    }
    function removeTabbingFromAllAnchors() {
        $("#c-button-slide-right").focus();
    }
    function setFocusOnEditPanel() {
        $(".fav-panel-close-favicon").focus();
    }
    function filterStatusBoard(modes) {
        switch (favUtils.modesSuffix(modes)) {
          case tfl.modeNameBus:
            break;

          case tfl.modeNameTraffic:
            showStatusFavouritedRoads(favs.statusBoardId(modes), modes);
            break;

          default:
            showStatusFavouritedLines(favs.statusBoardId(modes), modes);
            break;
        }
    }
    function updateStatusBoard(boardId, modes, response) {
        $(favs.errorId(modes)).hide();
        if (modes === "bus") {
            updateStatusBuses(boardId, response);
        } else {
            tfl.serviceStatus.updateServiceBoard(boardId, modes, response);
            filterStatusBoard(modes);
            $(boardId + " .rainbow-list-item .rainbow-list-link").click(function(e) {
                tfl.favouritesTrack.trackStatusBoardUpdate(e, $(this));
                tfl.serviceStatus.clickLine($(this));
            });
            $(".rainbow-list-content .close-message", boardId).on("click", function(e) {
                e.preventDefault();
                $(this).closest(".rainbow-list-item").removeClass("expanded");
                $(boardId).removeClass("fade-to-black");
                document.getElementById("scroll-to-" + boardId.replace("#", "")).scrollIntoView();
            });
        }
    }
    function displayPanelStatusUpdateError(jqXhr, boardId, modes) {
        tfl.logs.create("tfl.favouritesPanel.displayPanelStatusUpdateError: Error with ajax call, status: " + jqXhr.status);
        if (modes === "bus") return;
        if (jqXhr.status == "500" || jqXhr.status == "404") {
            $(favs.errorId(modes) + " span.field-validation-suggestion").show();
            $(favs.errorId(modes) + " span.field-validation-error").hide();
        } else {
            $(favs.errorId(modes) + " span.field-validation-suggestion").hide();
            $(favs.errorId(modes) + " span.field-validation-error").show();
        }
        $(favs.errorId(modes)).show();
    }
    function ajaxStatusBoard(ajaxUrl, boardId, modes) {
        var timeOutId = null;
        var isBusMode = modes === "bus";
        var isFavBoard = favUtils.isFavBoard(boardId);
        tfl.ajax({
            url: ajaxUrl,
            beforeSend: function(jqXHR, settings) {
                ajaxBeforeSend(jqXHR, settings, boardId, modes);
            },
            success: function(data, textStatus, jqXHR) {
                ajaxSuccess(data, textStatus, jqXHR, boardId, modes);
            },
            complete: function(jqXHR, textStatus) {
                ajaxComplete(jqXHR, textStatus, boardId, modes);
            },
            autoRefreshInterval: !isBusMode ? tfl.autoRefresh.ServiceBoard : null,
            autoRefreshId: !isBusMode ? boardId : null,
            dataType: "text",
            error: function(jqXhr, textStatus, errorThrown) {
                displayPanelStatusUpdateError(jqXhr, boardId, modes);
            }
        });
    }
    function ajaxBeforeSend(jqXHR, settings, boardId, modes) {
        tfl.logs.create("tfl.ajax.beforeSend :: " + "boardId: " + boardId + ", modes: " + modes);
        var isPlaceMode = isValidPlaceType(modes);
        var container = !isPlaceMode ? $(boardId + " >") : $(boardId);
        if (!container.length || isPlaceMode) {
            jqXHR.timeOutId = setTimeout(function() {
                tfl.logs.create("Deferred | tfl.ajax.beforeSend :: " + "boardId: " + boardId + " : modes = " + modes);
                $(boardId).addClass("fav-loading-data");
            }, 300);
        }
    }
    function isValidPlaceType(modes) {
        return favs.placeTypes.indexOf(modes) > -1;
    }
    function ajaxSuccess(data, textStatus, jqXHR, boardId, modes) {
        var timeOutId = jqXHR.timeOutId;
        if (timeOutId) {
            window.clearTimeout(timeOutId);
        }
        $(boardId).removeClass("fav-loading-data");
        updateStatusBoard(boardId, modes, data);
    }
    function ajaxComplete(jqXHR, textStatus, boardId, modes) {
        tfl.logs.create("ajaxStatusBoard | tfl.ajax.ajaxComplete : " + textStatus);
        if (textStatus != "success") {
            $(boardId).removeClass("fav-loading-data");
        }
    }
    function ajaxEditBus(naptanId, includeReturn) {
        tfl.ajax({
            url: favUtils.ajaxUrlBusStopPoints(naptanId),
            success: function(response) {
                updateEditBuses(naptanId, includeReturn, response);
            },
            dataType: "text"
        });
    }
    function ajaxEditBuses(includeReturn) {
        var busItems = tfl.favourites.getFavourites("bus");
        if (busItems && busItems.length > 0) {
            $("#search-heading-bus").show();
            var busArray = [];
            for (var i = 0; i < busItems.length; i += 1) {
                busArray.push(busItems[i].naptanId);
            }
            var naptanIds = busArray.join(",");
            tfl.ajax({
                url: favUtils.ajaxUrlBusStopPoints(naptanIds),
                success: function(response) {
                    updateEditBuses(naptanIds, includeReturn, response);
                },
                dataType: "text"
            });
        }
    }
    function updateEditBuses(naptanIds, includeReturn, response) {
        $("#fav-rainbow-list-bus").parent().replaceWith(response);
        showEditFavourites("bus", naptanIds, includeReturn);
        if (window.hasCookieBot() && Cookiebot.consent.preferences) {
            enableBusFavourites();
        } else {
            disableBusFavourites();
        }
    }
    function updateStatusBuses(boardId, response) {
        if (response === undefined || response === "") {
            $(boardId).parent().replaceWith('<div class="fav-panel-service-status-rainbow-board board-wrapper"><div id="fav-panel-rainbow-list-bus"></div></div>');
        } else {
            $(boardId).parent().replaceWith(response);
        }
    }
    function refreshStatusFavouritesPanel() {
        for (var mode = 0; mode < favUtils.modes.length; mode++) {
            filterStatusBoard(favUtils.modes[mode]);
        }
        showStatusFavourites();
    }
    function showStatusFavouritedLines(linesStatusBoardSelector, modes) {
        var favouritedItems = tfl.favourites.getFavourites(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            var $allLines = $(linesStatusBoardSelector);
            $allLines.find("li").hide();
            $(favouritedItems).each(function() {
                $allLines.find("[data-line-id='" + this.dataLineId + "']").show();
            });
        }
    }
    function showStatusFavouritedRoads(roadsStatusBoardSelector, modes) {
        var favouritedItems = tfl.favourites.getFavourites(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            var $allRoadCorridors = $(roadsStatusBoardSelector).find("tr");
            $allRoadCorridors.hide();
            $(favouritedItems).each(function() {
                $allRoadCorridors.find("[data-corridor-name='" + this.dataCorridorName + "']").closest("tr").show();
            });
        }
        $(roadsStatusBoardSelector).find("tr").on("click", function() {
            var corridorIdClicked = $(this).data("corridor-name");
            tfl.favouritesTrack.trackStatusBoardRoadsSelect($(this));
            tfl.tools.getQueryString().remove("corridorIds").update("corridorIds", corridorIdClicked).pushState();
            window.document.location = tfl.tools.getQueryString();
            window.document.location.pathname = "/traffic/status/";
        });
    }
    o.onLoadFavouritesPanelLinks = new CustomEvent("OnLoadFavouritesPanelLinks", {
        detail: cookieConsentEventData
    });
    window.addEventListener("OnLoadFavouritesPanelLinks", function(e) {
        if (e.detail.consent.preferences) {
            enableEditPanel();
            enableStatusPanelActions();
        } else {
            disableEditPanel();
            disableStatusPanelActions();
        }
    });
    function enableEditPanel() {
        $(".fav-open-edit").off("click").on("click", function(e) {
            e.preventDefault();
            tfl.favouritesTrack.trackEditPanelOpenedFromStatusPanel(e);
            o.editFavouritesPanel.openEditFavouritesPanel($(this).data("mode"), null, true);
            $("#fav-panel-edit").attr("aria-hidden", "false");
            $("#fav-panel-status").attr("aria-hidden", "true");
        });
    }
    function disableEditPanel() {
        $(".fav-open-edit").off("click");
    }
    function enableBusFavourites() {
        $("#fav-rainbow-list-bus div.fav-rainbow-list-link").off("click keydown").on("click keydown", function(e) {
            if (e.type != "click" && e.which != 13 && e.which != 32) return;
            e.preventDefault();
            toggleFavourite($(this));
        });
    }
    function disableBusFavourites() {
        $("#fav-rainbow-list-bus div.fav-rainbow-list-link").off("click keydown");
    }
    function enableStatusPanelActions() {
        $("div.fav-rainbow-list-link").off("click keydown").on("click keydown", function(e) {
            if (e.type != "click" && e.which != 13 && e.which != 32) return;
            e.preventDefault();
            toggleFavourite($(this));
        });
    }
    function disableStatusPanelActions() {
        $("div.fav-rainbow-list-link").off("click keydown");
    }
    $(document).on("click", ".fav-rainbow-list-item.bus .fav-rainbow-list-link.fav-rainbow-list-link-bus-stop", function(e) {
        tfl.favouritesTrack.trackBusChevronClicked(e);
    });
    $(document).on("click", "[id^=fav-panel-rainbow-list-] a[href='/plan-a-journey/']", function(e) {
        tfl.favouritesTrack.trackMyLinesReplanYourJourneyClicked(e);
    });
    o.updateFavouritesText = function(modes) {
        var hasFromPlace;
        var hasToPlace;
        var hasJourney;
        var journeyStorageKey;
        var favourites;
        var journeyFavourites;
        var placeFavourites;
        var from;
        var to;
        var via;
        var journeySelector = $("#journey-summary-data");
        var isJpPage = journeySelector.length > 0;
        if (!modes && journeySelector.length === 0) {
            return;
        }
        if (tfl.favourites.getFavourites(modes).length) {
            if (modes.length === 2 && modes[0] === "journey" && modes[1] === "place") {
                favourites = tfl.storage.get(tfl.storage.storageKeys.favourites, {});
                journeyFavourites = favourites.journey;
                placeFavourites = favourites.place;
                from = journeySelector.data("from");
                to = journeySelector.data("to");
                via = journeySelector.data("via");
                journeyStorageKey = from + "|" + to + "|" + via;
                hasFromPlace = placeFavourites && placeFavourites.hasOwnProperty(from);
                hasToPlace = placeFavourites && placeFavourites.hasOwnProperty(to);
                hasJourney = journeyFavourites.hasOwnProperty(journeyStorageKey);
                if (!hasFromPlace && !hasToPlace && !hasJourney) {
                    o.changeLabelToEdit(false, isJpPage);
                } else {
                    o.changeLabelToEdit(true, isJpPage, hasJourney);
                }
                return;
            }
            o.changeLabelToEdit(true);
            return;
        } else {
            o.changeLabelToEdit(false, isJpPage);
            return;
        }
    };
    o.changeLabelToEdit = function(useEdit, isJpResults, myJourney) {
        if (useEdit) {
            $("#fav-panel-save span").text("Edit favourites");
        } else {
            $("#fav-panel-save span").text("Add favourites");
        }
        if (isJpResults) {
            if (useEdit && myJourney) {
                $(".jp-results-headline, .last-breadcrumb").html("My journey");
            } else {
                $(".jp-results-headline, .last-breadcrumb").html("Journey results");
            }
        }
    };
    o.currentMode = $("#full-width-content").find(".service-status-links").data("mode");
    if (!o.currentMode) {
        o.currentMode = "journey, place";
    }
    o.updateFavouritesText(favs.getModes(o.currentMode));
    $("#view-favourites-updated").on("click", tfl.favouritesPanel.openStatusFavouritesPanel);
    function parsePlaceName(placeName) {
        var indexOfHyphen = placeName.indexOf("-");
        var indexStart = 0;
        var indexEnd = indexOfHyphen === -1 ? placeName.length : indexOfHyphen;
        return placeName.substring(indexStart, indexEnd);
    }
    function buildRenderEditMyJourney(journeyData, selectedList, favouritedItems) {
        var journeyStorageKey;
        var placeStorageKey;
        var favouriteStops = tfl.storage.get(tfl.storage.storageKeys.recentMagicSearches, {});
        var favourites = tfl.storage.get(tfl.storage.storageKeys.favourites, {});
        var journeyFavourites = favourites.journey;
        var placeFavourites = favourites.place;
        var hasIcsId = false;
        var hasBikePointId = false;
        var modeIcons = [];
        var currentMode;
        var stopsInfo = [];
        var fromPlace;
        var toPlace;
        var hasFromPlace;
        var hasToPlace;
        var elementScope = "fav-edit-journey-place";
        hasFromPlace = placeFavourites && placeFavourites.hasOwnProperty(journeyData.from);
        hasToPlace = placeFavourites && placeFavourites.hasOwnProperty(journeyData.to);
        if (!hasFromPlace) {
            ajaxPlace(journeyData.from, journeyData.fromId, journeyData.props.from, elementScope);
        }
        if (!hasToPlace) {
            ajaxPlace(journeyData.to, journeyData.toId, journeyData.props.to, elementScope);
        }
        fromPlace = getPlace(hasFromPlace, placeFavourites, journeyData.from, journeyData.fromId, journeyData.props.fromNaptanId);
        toPlace = getPlace(hasToPlace, placeFavourites, journeyData.to, journeyData.toId, journeyData.props.toNaptanId);
        function getPlace(hasPlace, placeFavourites, name, id, naptanId) {
            if (hasPlace) {
                return $.extend(true, {}, placeFavourites[name], {
                    props: {
                        isFavourite: hasPlace
                    }
                });
            } else {
                var geoLocation = favUtils.getGeoLocation(id);
                return {
                    label: null,
                    mode: "place",
                    placeName: name,
                    props: {
                        id: id,
                        label: null,
                        lat: geoLocation.lat,
                        lon: geoLocation.lon,
                        modeIcons: [ "generic-icon-white" ],
                        modes: "generic"
                    },
                    type: "stop"
                };
            }
        }
        var fromToPlace = {
            fav: []
        };
        fromToPlace.fav.push(fromPlace);
        fromToPlace.fav.push(toPlace);
        tfl.favouritePlaceJourney.initialize({
            places: fromToPlace.fav,
            elementScope: "fav-edit-journey-place",
            journeyData: journeyData
        });
    }
    function ajaxPlace(placeName, placeId, disambigPlaceName, elementScope) {
        var url;
        var placeType;
        var boardId;
        var modeTab = "#" + elementScope;
        if (favUtils.isValidPlaceId(placeId)) {
            placeType = "stop";
            disambigPlaceName = parsePlaceName(disambigPlaceName);
            url = favUtils.ajaxUrlStopPoint(placeName);
        } else {
            var geoLocation = favUtils.getGeoLocation(placeId);
            if (geoLocation.isValid && !geoLocation.source) {
                placeType = "placesExtra";
                url = favUtils.ajaxUrlPlacesExtraSearch(placeName, placeId);
            } else {
                placeType = "bikepoint";
                url = favUtils.ajaxUrlBikePoint(placeName);
            }
        }
        placeName = placeName.replace(/'/g, "&#39;");
        boardId = modeTab && modeTab + " #fav-rainbow-list-place .fav-rainbow-list-item[data-place='" + placeName + "']";
        placeName = placeName.replace(/&#39;/g, "'");
        tfl.ajax({
            url: url,
            beforeSend: function(jqXHR, settings) {
                ajaxBeforeSend(jqXHR, settings, boardId, placeType);
            },
            success: function(data, textStatus, jqXHR) {
                var timeOutId = jqXHR.timeOutId;
                if (timeOutId) {
                    window.clearTimeout(timeOutId);
                }
                $(boardId).removeClass("fav-loading-data");
                parsePlaceApiResponse(data, placeName, placeId, placeType, disambigPlaceName);
            },
            dataType: "json"
        });
    }
    function parsePlaceApiResponse(response, placeName, placeId, placeType, disambigPlaceName) {
        if (placeType === "bikepoint" && response.length === 0) {
            tfl.ajax({
                url: favUtils.ajaxUrlPlacesExtraSearch(placeName, placeId),
                success: function(response) {
                    parsePlaceApiResponse(response, placeName, placeId, "placesExtra");
                },
                dataType: "json"
            });
        } else if (placeType === "stop" && (response.hasOwnProperty("matches") && response.matches.length === 0)) {
            tfl.ajax({
                url: favUtils.ajaxUrlStopPoint(disambigPlaceName, placeId),
                success: function(response) {
                    parsePlaceApiResponse(response, placeName, placeId, "stopDisambig");
                },
                dataType: "json"
            });
        } else {
            if (placeType === "stopDisambig") {
                placeType = "stop";
            }
            processPlaceApiResponse(response, placeName, placeId, placeType, disambigPlaceName);
        }
    }
    function buildRenderPlaceLineItems(selectedList, favouritedItems) {
        var placeFavourites = favouritedItems;
        var places = {
            fav: [],
            showAddPlacesLink: false
        };
        var tempPlace;
        var lineItems;
        var container;
        if (selectedList === "#fav-edit-place") {
            tfl.favouritesPlaces.initialize("fav-edit-place");
            return;
        }
        placeFavourites.forEach(function(item, index, array) {
            tempPlace = {
                placeId: item.props.placeId,
                name: item.placeName,
                label: item.label,
                modeIcons: item.props.modeIcons,
                modes: item.props.modes,
                id: item.props.id,
                lat: item.props.lat,
                lon: item.props.lon,
                props: {
                    showLabel: item.label && item.label !== ""
                }
            };
            places.fav.splice(0, 0, tempPlace);
        });
        if (selectedList === "#fav-status-place") {
            lineItems = hoganTemplates.favouritesPlace.render(places);
            container = selectedList + " #fav-panel-rainbow-list-place ul";
        }
        $(container).empty().append(lineItems);
        $(".fav-place-journey-link").on("click", function() {
            $(this).find("span.fav-place-text").text("Finding current location...");
            var destLat = $(this).parent().data("lat");
            var destLon = $(this).parent().data("lon");
            var destName = $(this).parent().data("place");
            var destId = $(this).parent().data("place-id");
            var label = $(this).parent().data("label");
            tfl.favouritesTrack.trackStatusPanelPlaceClicked(label);
            tfl.geolocation.geolocateMe(null, function(coordinates) {
                var currentLat = coordinates.latitude;
                var currentLon = coordinates.longitude;
                window.location.href = "/plan-a-journey/results?IsAsync=true&JpType=publictransport&InputFrom=Current+location+&Modes=tube%2Cdlr%2Coverground%2Ctflrail%2Cbus%2Criver-bus%2Ctram%2Ccable-car%2Cnational-rail%2Ccoach&From=Current+location+&FromId=" + currentLat + "%2C" + currentLon + "&PreviousFrom=&InputTo=" + destName + "&To=" + destName + "&ToId=" + destId + "&Mode=bus&Mode=tube&Mode=national-rail&Mode=dlr&Mode=overground&Mode=tflrail&Mode=river-bus&Mode=tram&Mode=cable-car&Mode=coach&CyclePreference=AllTheWay&WalkingSpeedWalking=average&JourneyPreference=leasttime&AccessibilityPreference=norequirements&MaxWalkingMinutes=40&WalkingSpeedTransport=average&InputVia=&Via=&ViaId=&PreviousVia=&NationalSearch=false&WalkingOptimization=false&SavePreferences=false&IsMultipleJourneySelection=False&JourneyType=&IsPastWarning=False";
            }, function(parameters) {
                window.location.href = "/plan-a-journey/?InputTo=" + destName + "&ToId=" + destId + "";
            });
        });
    }
    function buildRenderStatusJourneys() {
        var favouriteJourneys = prepareJourneyPlacesInAllJourneys(tfl.journeyPlanner.getFavouriteJourneys(tfl.favourites.getFavourites("journey")));
        if (favouriteJourneys.journeys.length > 0) {
            $("#fav-panel-rainbow-list-journey").empty();
            var favouriteLinks = $(window.hoganTemplates.journey.render({
                hasItems: favouriteJourneys.journeys.length !== 0,
                hasNoItems: favouriteJourneys.journeys.length === 0,
                items: favouriteJourneys.journeys,
                isFavourites: false,
                isStatusFav: true,
                pagename: "panel"
            }));
            $("#fav-panel-rainbow-list-journey").append(favouriteLinks);
            o.favStatusJourneys = document.querySelectorAll("#fav-panel-rainbow-list-journey a");
            for (var jpLink = 0; jpLink < o.favStatusJourneys.length; jpLink++) {
                var link = o.favStatusJourneys[jpLink];
                link.addEventListener("click", favStatusJourneyClickHandler, true);
            }
        }
    }
    function favStatusJourneyClickHandler(e) {
        var href = $(e.target).attr("href");
        href = href.replace("&Date=yyyymmdd", "&Date=" + tfl.favouritesUtils.helper.getDateInYYYYMMDD());
        href = href.replace("&Time=hhmm", "&Time=" + tfl.favouritesUtils.helper.getTimeInHHMM());
        href = href.replaceAll(" ", "+");
        $(e.target).attr("href", href);
        tfl.favouritesTrack.trackStatusPanelJourneyClicked();
    }
    function prepareJourneyPlacesInAllJourneys(favouriteJourneys) {
        for (var i = favouriteJourneys.journeys.length - 1; i >= 0; --i) {
            favouriteJourneys.journeys[i].encodedfrom = encodeURIComponent(favouriteJourneys.journeys[i].from);
            favouriteJourneys.journeys[i].encodedTo = encodeURIComponent(favouriteJourneys.journeys[i].to);
            favouriteJourneys.journeys[i].encodedVia = encodeURIComponent(favouriteJourneys.journeys[i].via);
        }
        return favouriteJourneys;
    }
    function processPlaceApiResponse(response, placeName, placeId, placeType, disambigPlaceName) {
        var jpId;
        var name;
        var place;
        var match;
        var hoganPlace;
        var commonName;
        var placeLineItem;
        var newPlaceBlock;
        var newPlaceLineItem;
        var placeLineItemSelector;
        var stationIcon = "-station-icon";
        tfl.logs.create("tfl.favouritesPanel.processPlaceApiResponse");
        place = {
            name: placeName,
            placeType: placeType,
            placeId: placeId,
            modeIcons: [ "generic-icon-white" ],
            modes: [ "generic" ]
        };
        if (response.length > 0 || response.hasOwnProperty("matches") && response.matches !== undefined) {
            switch (placeType) {
              case "stop":
                match = response.matches.find(function(match, index, array) {
                    if (placeId === match.icsId || placeName === match.name) {
                        return match;
                    }
                });
                if (match) {
                    match.modes = match.modes.filter(tfl.utils.filterInvalidModes);
                    place.name = placeName ? placeName : match.name;
                    place.id = match.id;
                    place.icsId = match.icsId;
                    place.naptanId = match.id;
                    place.modeIcons = [];
                    place.modes = match.modes;
                    place.lat = match.lat;
                    place.lon = match.lon;
                }
                break;

              case "bikepoint":
                match = response.find(function(match, index, array) {
                    if (placeName === match.commonName || placeId === match.id) {
                        return match;
                    }
                });
                place.modeIcons = [ "bch-docking-station-icon" ];
                if (match) {
                    place.id = tfl.utils.stringFormat("{0},{1}|bikepoints", match.lat, match.lon);
                    place.name = match.commonName;
                    place.placeId = place.id;
                    place.modes = match.placeType;
                    place.lat = match.lat;
                    place.lon = match.lon;
                }
                break;

              case "placesExtra":
                match = response.matches.find(function(match) {
                    if (placeName === match.name) {
                        return match;
                    }
                });
                place.id = placeId;
                var placeLatLon = favUtils.getGeoLocation(placeId);
                if (placeLatLon.isValid) {
                    place.lat = placeLatLon.lat;
                    place.lon = placeLatLon.lon;
                }
                if (match) {
                    place.modeIcons = match.icon === "generic" ? [ match.icon.concat("-icon-white") ] : [ match.icon.concat("-icon") ];
                    place.types = match.types;
                }
                break;

              default:
                break;
            }
        }
        if (place.placeType === "stop" && place.modes.length > 0) {
            place.modes.forEach(function(mode, index, array) {
                place.modeIcons.push(mode.concat(stationIcon));
            });
        }
        tfl.favouritePlaceJourney.updatePlace(place);
    }
    function buildRenderEditJourneys(journeyData) {
        var hoganJourney;
        var favouriteJourneys = {};
        var favJourneyObj;
        var isRecents = false;
        if (journeyData) {
            if (journeyData.journeyType) {
                isRecents = journeyData.journeyType === "recents";
            }
            if (journeyData.constructor === Array) {
                favouriteJourneys.journeys = journeyData;
            } else {
                favouriteJourneys.journeys = [ {
                    from: journeyData.from,
                    to: journeyData.to,
                    fromId: journeyData.fromId,
                    toId: journeyData.toId,
                    via: journeyData.via,
                    viaId: journeyData.viaId
                } ];
            }
            favJourneyObj = {
                items: favouriteJourneys.journeys,
                showAddJourneysLink: false
            };
        } else {
            favouriteJourneys = tfl.journeyPlanner.getFavouriteJourneys(tfl.favourites.getFavourites("journey"));
            favJourneyObj = {
                items: favouriteJourneys.journeys,
                showAddJourneysLink: true
            };
        }
        if (favouriteJourneys.journeys.length > 0) {
            $("#fav-edit-journey").find("#edit-journey").remove();
            var favouriteLinks = $(window.hoganTemplates.editJourney.render(favJourneyObj));
            $("#fav-edit-journey h2").html(isRecents ? "Favourite recents" : favouriteJourneys.journeys.length === 1 ? "Favourite journey" : "Favourite journeys");
            $("#fav-edit-journey").append(favouriteLinks);
            o.favEditJourneys = document.querySelectorAll("#fav-edit-journey .fav-rainbow-list-item");
            for (var jpLink = 0; jpLink < o.favEditJourneys.length; jpLink++) {
                var link = o.favEditJourneys[jpLink];
                link.addEventListener("click", favEditJourneyClickHandler, true);
            }
        }
    }
    function favEditJourneyClickHandler(e) {
        toggleFavourite($(e.target).parents(".fav-rainbow-list-link"));
    }
    function isTabKeyDown(e) {
        return e.type && e.which && e.type === "keydown" && e.which === 9 && !e.shiftKey;
    }
    $(document).on("click", ".first-time-panel-description", function(e) {
        tfl.favouritesTrack.trackFtuPanelPlaceJourneyClicked(e, $(this));
    });
    $("#InputFavBus").on("focusin", function() {
        var placeHolder = $(this).data("placeholder-on-focus");
        $(this).removeClass("no-focus").attr("placeholder", placeHolder);
        $("#fav-bus-search-filter").removeClass("no-focus");
        $("#search-filter-form-fav .heading").removeClass("visually-hidden").addClass("search-label");
    });
    $("#InputFavPlace").on("focusin", function() {
        var placeHolder = $(this).data("placeholder-on-focus");
        $(this).removeClass("no-focus").attr("placeholder", placeHolder);
        $("#fav-place-search-filter").removeClass("no-focus");
        $("#search-filter-form-fav-place .heading").removeClass("visually-hidden").addClass("search-label");
    });
    $("#InputFavLabel").on("focusin", function() {
        $(this).removeClass("no-focus");
    });
    $("#InputFavBus").on("focusout", function() {
        var placeHolder = $(this).data("placeholder-no-focus");
        $(this).addClass("no-focus").attr("placeholder", placeHolder);
        $("#fav-bus-search-filter").addClass("no-focus");
        $("#search-filter-form-fav .heading").removeClass("search-label").addClass("visually-hidden");
    });
    $("#InputFavPlace").on("focusout", function() {
        var placeHolder = $(this).data("placeholder-no-focus");
        $(this).addClass("no-focus").attr("placeholder", placeHolder);
        $("#fav-place-search-filter").addClass("no-focus");
        $("#search-filter-form-fav-place .heading").removeClass("search-label").addClass("visually-hidden");
    });
    $("#InputFavLabel").on("focusout", function() {
        var placeHolder = $(this).data("placeholder-no-focus");
        $(this).addClass("no-focus").attr("placeholder", placeHolder);
    });
    $(document).on("click", ".js-cookie-renew > a", function() {
        Cookiebot.renew();
    });
    enableStatusPanelActions();
    var openFavPanelParam = tfl.utils.getParameterByName("FavPanel", window.location.href);
    var returnUrlParam = tfl.utils.getParameterByName("ReturnUrl", window.location.href);
    if (openFavPanelParam && !returnUrlParam) {
        tfl.logs.create("open fav panel after login from panel");
        o.openStatusFavouritesPanel();
    }
})(window.tfl.favouritesPanel = window.tfl.favouritesPanel || {});

(function($) {
    $.each([ "show", "hide" ], function(i, ev) {
        var el = $.fn[ev];
        $.fn[ev] = function() {
            this.trigger(ev);
            return el.apply(this, arguments);
        };
    });
})(jQuery);

(function(o) {
    "use strict";
    if (!tfl.isLocalStorageSupported) {
        return;
    }
    tfl.logs.create("tfl.homeFavourites: loaded");
    var allFavourites;
    var favouritedItems;
    var $Favs = tfl.favouritesUtils;
    var favs = {
        classMapping: [ {
            dataLineId: "lul-bakerloo",
            className: "bakerloo"
        }, {
            dataLineId: "lul-central",
            className: "central"
        }, {
            dataLineId: "lul-circle",
            className: "circle"
        }, {
            dataLineId: "lul-district",
            className: "district"
        }, {
            dataLineId: "lul-hammersmith-city",
            className: "hammersmith"
        }, {
            dataLineId: "lul-jubilee",
            className: "jubilee"
        }, {
            dataLineId: "lul-metropolitan",
            className: "metropolitan"
        }, {
            dataLineId: "lul-northern",
            className: "northern"
        }, {
            dataLineId: "lul-piccadilly",
            className: "piccadilly"
        }, {
            dataLineId: "lul-victoria",
            className: "victoria"
        }, {
            dataLineId: "lul-waterloo-city",
            className: "waterloo"
        }, {
            dataLineId: "raillo-overground",
            className: "overground"
        }, {
            dataLineId: "tfl-rail",
            className: "tflrail"
        }, {
            dataLineId: "dlr-dlr",
            className: "dlr"
        }, {
            dataLineId: "tram-tram",
            className: "tram"
        }, {
            dataLineId: "lul-rb1",
            className: "rb1"
        }, {
            dataLineId: "lul-rb2",
            className: "rb2"
        }, {
            dataLineId: "lul-rb3",
            className: "rb3"
        }, {
            dataLineId: "lul-rb4",
            className: "rb4"
        }, {
            dataLineId: "lul-rb5",
            className: "rb5"
        }, {
            dataLineId: "lul-rb6",
            className: "rb6"
        }, {
            dataLineId: "lul-woolwich-ferry",
            className: "woolwich-ferry"
        }, {
            dataLineId: "lul-tram-1",
            className: "tram1"
        }, {
            dataLineId: "lul-tram-2",
            className: "tram2"
        }, {
            dataLineId: "lul-tram-3",
            className: "tram3"
        }, {
            dataLineId: "lul-tram-4",
            className: "tram4"
        }, {
            dataLineId: "lul-emirates-air-line",
            className: "emirates"
        } ],
        statusPanelId: function(modes) {
            return "#fav-home-status-".concat($Favs.helper.modesSuffix(modes));
        },
        errorId: function(modes) {
            return "#fav-home-error-".concat($Favs.helper.modesSuffix(modes));
        },
        statusBoardId: function(modes) {
            if (modes === "traffic") return "#fav-home-panel-rainbow-list-traffic";
            return "#fav-home-panel-rainbow-list-".concat($Favs.helper.modesSuffix(modes));
        },
        defaultStatusBoardId: function(modes) {
            if (modes === "traffic") return "#rainbow-list-roads-";
            return "#rainbow-list-".concat($Favs.helper.modesSuffix(modes));
        },
        defaultStatusAccordion: function(modes) {
            return "#home-status-".concat($Favs.helper.modesSuffix(modes));
        },
        homePageModes: [ tfl.modeNameTube, tfl.modeNameDlr, tfl.modeNameOverground, tfl.modeNameTflRail, tfl.modeNameTram, tfl.modeNameBus, tfl.modeNameTraffic, tfl.modeNameRiver, tfl.modeNameCableCar ]
    };
    o.favs = favs;
    function getHomeFavouritesArray(modes) {
        return tfl.favourites.getFavourites(modes);
    }
    function showStatusFavourites() {
        var mode;
        for (mode = 0; mode < $Favs.helper.modes.length; mode++) {
            showStatusFavourite(favs.statusPanelId($Favs.helper.modes[mode]), $Favs.helper.modes[mode]);
        }
    }
    function autoRefreshMode(modes) {
        tfl.stopAjaxAutoRefresh(favs.defaultStatusBoardId(modes));
        var params = {
            collapsed: true,
            isHomeOrModePageStatusBoard: true,
            isStatusUpdatesPage: false,
            isFavouritesPanel: false,
            isHomePageFavouritesWidget: true
        };
        if (typeof modes === "string" && modes === tfl.modeNameBus) {
            params.favItems = getHomeFavouritesArray(modes);
            tfl.serviceStatus.ajaxServiceBoard($Favs.helper.ajaxUrlStatusBoardUpdate(modes, params), favs.statusBoardId(modes), modes);
        } else {
            if (modes !== tfl.modeJourney && modes !== tfl.modePlace) {
                tfl.serviceStatus.ajaxServiceBoard($Favs.helper.ajaxUrlStatusBoardUpdate(modes, params), favs.defaultStatusBoardId(modes), modes);
            }
        }
    }
    function setAutoRefresh() {
        var mode;
        for (mode = 0; mode < $Favs.helper.modes.length; mode++) {
            setAutoRefreshByMode($Favs.helper.modes[mode]);
        }
    }
    o.setAutoRefreshByMode = function(modes) {
        setAutoRefreshByMode(modes);
    };
    function setAutoRefreshByMode(modes) {
        favouritedItems = getHomeFavouritesArray(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            autoRefreshMode(modes);
        } else {
            tfl.stopAjaxAutoRefresh(favs.defaultStatusBoardId(modes));
        }
    }
    o.showStatusFavourite = function(modePanel, modes) {
        showStatusFavourite(modePanel, modes);
    };
    function showStatusFavourite(modePanel, modes) {
        favouritedItems = getHomeFavouritesArray(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            filterStatusBoard(modes);
            $(modePanel).fadeIn(500);
            $(favs.defaultStatusAccordion(modes)).slideUp();
        } else {
            $(modePanel).slideUp();
            $(favs.defaultStatusAccordion(modes)).slideDown();
        }
    }
    function filterStatusBoard(modes) {
        switch ($Favs.helper.modesSuffix(modes)) {
          case tfl.modeNameBus:
            break;

          case tfl.modeNameTraffic:
            showMyRoadsIfAny(favs.statusBoardId(modes), modes);
            break;

          default:
            showStatusFavouritedLines(favs.statusBoardId(modes), modes);
            break;
        }
    }
    function findClassName(dataLineId) {
        for (var i = 0, len = favs.classMapping.length; i < len; i++) {
            if (favs.classMapping[i].dataLineId === dataLineId) return favs.classMapping[i].className;
        }
        return null;
    }
    function showStatusFavouritedLines(linesStatusBoardSelector, modes) {
        var defaultContent = $(favs.defaultStatusBoardId(modes)).html();
        $(favs.statusBoardId(modes)).html(defaultContent);
        var $allLines = $(linesStatusBoardSelector);
        $allLines.find("li").hide();
        $allLines.find(".rainbow").find("span").hide();
        $(favouritedItems).each(function() {
            $allLines.find("[data-line-id='" + this.dataLineId + "']").show();
            var className = findClassName(this.dataLineId);
            if (className) {
                $allLines.find("." + className).show();
            }
        });
        adjustGoodServiceLineHeight(modes);
        $allLines.find("span.good-service-message").text("Good service");
        $(favs.statusBoardId(modes)).find("h2").remove();
    }
    function adjustGoodServiceLineHeight(modes) {
        var $rainbowSpans = $(favs.statusBoardId(modes)).find(".rainbow").find(":not(.auralOnly)span");
        var $goodServiceLink = $(favs.statusBoardId(modes)).find(".good-service-link");
        var goodServiceLineCount = $rainbowSpans.filter(function() {
            return $(this).css("display") == "block";
        }).length;
        var lineHeight = 10;
        if (goodServiceLineCount === 0) {
            $goodServiceLink.hide();
        } else {
            if (goodServiceLineCount * 10 < 44) {
                lineHeight = Math.ceil(44 / goodServiceLineCount);
            }
            $goodServiceLink.show();
            $rainbowSpans.css("line-height", lineHeight + "px");
        }
    }
    function moveRoadsWidgetContents(toSelector, fromSelector) {
        fromSelector.find("table").clone().appendTo(toSelector.empty());
    }
    function showMyRoadsIfAny(roadsStatusBoardSelector, modes) {
        var favouritedItems = getHomeFavouritesArray(modes);
        if (favouritedItems && favouritedItems.length > 0) {
            var $roadsWidgetSelector = $("#rainbow-list-roads");
            var $favHomeRoadsWidgetSelector = $("#fav-home-rainbow-list-roads");
            if ($roadsWidgetSelector && $favHomeRoadsWidgetSelector) {
                var noDelayCorridors = [];
                moveRoadsWidgetContents($favHomeRoadsWidgetSelector, $roadsWidgetSelector);
                var $allRoadCorridors = $(roadsStatusBoardSelector).find("tr");
                $allRoadCorridors.hide();
                $(favouritedItems).each(function() {
                    var requiredCorridorElementFound = $allRoadCorridors.find("[data-corridor-name='" + this.dataCorridorName + "']");
                    if (requiredCorridorElementFound.closest("tr").hasClass("no-disruption")) {
                        noDelayCorridors.push(requiredCorridorElementFound.closest("tr").find("div > span").text());
                    } else {
                        requiredCorridorElementFound.closest(".has-disruption").closest("tr").show();
                    }
                });
                if (noDelayCorridors.length > 0) {
                    noDelayCorridors.sort();
                    $favHomeRoadsWidgetSelector.find(".lines-wrapper").html(noDelayCorridors.join("<br/>"));
                    $favHomeRoadsWidgetSelector.find(".collapsed-lines .service-status span").html("<strong>No exceptional delays</strong>");
                    $favHomeRoadsWidgetSelector.find(".collapsed-lines").show();
                }
            }
        }
    }
    function openEditPanel(e) {
        e.preventDefault();
        tfl.favouritesTrack.trackEditPanelOpenedFromPage(e.target.mode);
        tfl.favouritesPanel.editFavouritesPanel.openEditFavouritesPanel(e.target.mode, null, false);
    }
    o.editLinks = document.querySelectorAll(".fav-to-edit");
    for (var i = 0; i < o.editLinks.length; i++) {
        var editLink = o.editLinks[i];
        editLink.mode = $(editLink).attr("data-mode-tab");
        editLink.addEventListener("click", openEditPanel);
    }
    function toggleFavouritesDisplay() {
        var $favDisplay = $("#favourites-display");
        var $homeAccordion = $("#home-status-tube-dlr-overground-tflrail-tram");
        var $homeAccordionAnchor = $homeAccordion.find("a");
        if (allFavourites.length > 0) {
            $favDisplay.show();
            $homeAccordion.removeClass("expanded");
        } else {
            $favDisplay.slideUp();
            $homeAccordion.addClass("content expanded");
        }
        $("#home-status-updates-default").css("visibility", "visible");
    }
    function displayFavouritesOnHomepage() {
        allFavourites = getHomeFavouritesArray(favs.homePageModes);
        setAutoRefresh();
        showStatusFavourites();
        toggleFavouritesDisplay();
    }
    o.hideStatusUpdateErrorMsg = function(modes) {
        if ($("#home-status-updates").length) {
            $(favs.errorId(modes)).hide();
        }
    };
    o.displayHomeStatusUpdateError = function displayHomeStatusUpdateError(jqXhr, boardId, modes) {
        if ($("#home-status-updates").length) {
            if (jqXhr.status == "500" || jqXhr.status == "404") {
                tfl.logs.create("tfl.ajax.displayHomeStatusUpdateError: Error with ajax call, status: " + jqXhr.status);
                $(favs.errorId(modes)).show();
                if ($(favs.statusBoardId(modes)).children().length) {
                    $(favs.errorId(modes) + " span.field-validation-suggestion").show();
                    $(favs.errorId(modes) + " span.field-validation-error").hide();
                } else {
                    $(favs.errorId(modes) + " span.field-validation-suggestion").hide();
                    $(favs.errorId(modes) + " span.field-validation-error").show();
                }
            }
        }
    };
    o.updateMode = function updateMode(modes) {
        tfl.logs.create("tfl.homeFavourites: updateMode");
        if ($("#home-status-updates").length) {
            tfl.logs.create("tfl.homeFavourites: on home page update single mode");
            showStatusFavourite(favs.statusPanelId(modes), modes);
        }
    };
    o.updateAndRefresh = function updateAndRefresh() {
        tfl.logs.create("tfl.homeFavourites: updateAndRefresh");
        if ($("#home-status-updates").length) {
            tfl.logs.create("tfl.homeFavourites: on home page update");
            displayFavouritesOnHomepage();
        }
    };
    o.init = function initialise() {
        if ($("#home-status-updates").length) {
            tfl.logs.create("tfl.homeFavourites: init");
            displayFavouritesOnHomepage();
        }
    };
    o.init();
})(window.tfl.homeFavourites = window.tfl.homeFavourites || {});

(function(favouritesTrack, $, undefined) {
    "use strict";
    tfl.logs.create("tfl.favouritesTracking: loaded");
    var evar = tfl.dictionary.TrackingEvar;
    var event = tfl.dictionary.TrackingEvent;
    var prop = tfl.dictionary.TrackingProp;
    var trackingItem;
    favouritesTrack.trackAllStatusLinkClicked = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackAllStatusLinkClicked");
        var mode = $(e.target).closest(".fav-panel-item").find(".fav-status-sub-heading h2").text().toLowerCase();
        var linkText = $(e.target).text().toLowerCase();
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, mode, linkText);
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackBusChevronClicked = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackBusChevronClicked");
        var mode = $(e.target).closest(".fav-panel-item").find(".fav-status-sub-heading h2").text().toLowerCase();
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.BusChevronAction, mode);
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackEditPanelClosed = function(e, editModes) {
        if (!tfl.stats.tealiumTracking) {
            return false;
        }
        function getCloseEditMode() {
            var targetElement = e.target;
            if (e.type && e.type === "swiperight") {
                return "swipe";
            } else if ($(targetElement).hasClass("fav-panel-star") || $(targetElement).find(".fav-panel-star").length > 0) {
                return "star";
            } else if ($(targetElement).hasClass("c-mask")) {
                return "click away";
            } else {
                return "done";
            }
        }
        function getChangesText(changes) {
            var texts = [];
            for (var i = 0, len = changes.length; i < len; i++) {
                texts.push("my " + changes[i].toLowerCase() + "s");
            }
            return texts.join(" - ");
        }
        tfl.logs.create("tfl.favouritesTracking: trackEditPanelClosed");
        var closeMode = getCloseEditMode();
        var isJourney = editModes.indexOf(tfl.modeJourney) >= 0;
        var isPlace = editModes.indexOf(tfl.modePlace) >= 0;
        var isJourneyAndPlace = isJourney && isPlace;
        var $header = $(".fav-panel-edit .fav-panel-item:visible h2");
        var isAddAction = $header.data("track-option").startsWith("Add");
        var isRecents = $header.data("track-option").indexOf("recent") >= 0;
        var myModes = "";
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationClosePanel_prop42;
        if (isJourneyAndPlace) {
            myModes = "my journeys - my places";
            if (isAddAction) {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.AddPanelJourneyPlace, closeMode);
            } else {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.EditPanelJourneyPlace, closeMode);
            }
        } else if (isJourney) {
            myModes = "my journeys";
            if (isAddAction) {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.AddPanelJourneyRecents, closeMode);
            } else {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.EditPanelJourney, closeMode);
            }
        } else if (isPlace) {
            myModes = "my places";
            trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.EditPanelPlace, closeMode);
        } else {
            myModes = $header.data("track-mode");
            if (isAddAction) {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.AddPanelMode, myModes, closeMode);
            } else {
                trackingItem[prop.ClosePanel_42.Name] = tfl.utils.stringFormat(prop.ClosePanel_42.EditPanelMode, myModes, closeMode);
            }
        }
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
        trackingItem = {};
        var modes;
        if (isJourneyAndPlace) {
            modes = editModes;
            var changes = tfl.favourites.stateChangeEvaluator.getModesStateChanged(modes);
            if (changes.length) {
                changes = getChangesText(changes);
                if (isAddAction) {
                    trackingItem[evar.ModesPlacesJourneySave_28.Name] = tfl.utils.stringFormat(evar.ModesPlacesJourneySave_28.JourneysPlacesAdd, changes);
                } else {
                    trackingItem[evar.ModesPlacesJourneySave_28.Name] = tfl.utils.stringFormat(evar.ModesPlacesJourneySave_28.JourneysPlacesEdit, changes);
                }
            }
        } else {
            modes = editModes instanceof Array ? editModes : [ editModes ];
            var stateChanged = tfl.favourites.stateChangeEvaluator.hasModeStateChanged(modes);
            if (stateChanged) {
                if (isRecents) {
                    trackingItem[evar.ModesPlacesJourneySave_28.Name] = evar.ModesPlacesJourneySave_28.RecentsOnly;
                } else if (isAddAction) {
                    trackingItem[evar.ModesPlacesJourneySave_28.Name] = tfl.utils.stringFormat(evar.ModesPlacesJourneySave_28.ModesAdd, myModes);
                } else {
                    trackingItem[evar.ModesPlacesJourneySave_28.Name] = tfl.utils.stringFormat(evar.ModesPlacesJourneySave_28.ModesEdit, myModes);
                }
            }
        }
        tfl.favourites.stateChangeEvaluator.clearOldState();
        if (trackingItem[evar.ModesPlacesJourneySave_28.Name]) {
            trackingItem[event.Name] = event.PersonalisationSave_24;
            tfl.stats.tealiumTracking(trackingItem);
        }
        return true;
    };
    favouritesTrack.trackEditPanelOpenedFromPage = function(mode) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackEditPanelOpenedFromPage");
        var isBusPage = location.pathname.indexOf("buses") >= 0;
        trackingItem = {};
        trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
        if (isBusPage) {
            trackingItem[evar.OpenEditPanel_25.Name] = evar.OpenEditPanel_25.BusLandingEdit;
        } else {
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(evar.OpenEditPanel_25.HomepageMode, mode.toLowerCase());
        }
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackEditPanelOpenedFromStatusUpdate = function(e, $this) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        function getAddOrEditAction() {
            var text = $(e.target).text();
            return text.split(" ")[0].toLowerCase();
        }
        tfl.logs.create("tfl.favouritesTracking: trackEditPanelOpenedFromStatusUpdate");
        var mode = getFavouritedModeText($(".service-status-links").data("mode")).toLowerCase();
        var addOrEditAction = getAddOrEditAction();
        trackingItem = {};
        trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
        if (addOrEditAction === "add") {
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(evar.OpenEditPanel_25.StatusUpdateAdd, mode);
        } else {
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(evar.OpenEditPanel_25.StatusUpdateEdit, mode);
        }
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationOpenPanel_prop41;
        if (addOrEditAction === "add") {
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(prop.OpenPanel_41.StatusUpdateAdd, mode);
        } else {
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(prop.OpenPanel_41.StatusUpdateEdit, mode);
        }
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackEditPanelOpenedFromStatusPanel = function(e) {
        if (!tfl.stats.tealiumTracking || !e.originalEvent) {
            return;
        }
        function getTrackMode(e) {
            if (!e.target.attributes["data-track-mode"] || !e.target.attributes["data-track-mode"].value) {
                return $("span", e.target).data("track-mode");
            } else {
                return e.target.attributes["data-track-mode"].value;
            }
        }
        tfl.logs.create("tfl.favouritesTracking: trackEditPanelOpenedFromStatusPanel");
        var trackMode = getTrackMode(e);
        var isFtuPanel = $("#fav-add-favourites a:visible").length === ftuElementsCount();
        var isAddMode = isFtuPanel ? false : $(e.target).closest("[id^=add-]").length > 0;
        var openEditPanelMode;
        if (isFtuPanel) {
            openEditPanelMode = tfl.utils.stringFormat(evar.OpenEditPanel_25.FtuPanelMode, trackMode);
        } else {
            if (isAddMode) {
                openEditPanelMode = tfl.utils.stringFormat(evar.OpenEditPanel_25.PublishedPanelModeAdd, trackMode);
            } else {
                openEditPanelMode = tfl.utils.stringFormat(evar.OpenEditPanel_25.PublishedPanelModeEdit, trackMode);
            }
        }
        trackingItem = {};
        trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
        trackingItem[evar.OpenEditPanel_25.Name] = openEditPanelMode;
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationOpenPanel_prop41;
        trackingItem[prop.OpenPanel_41.Name] = openEditPanelMode;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackFtuPanelPlaceJourneyClicked = function(e, $this) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        function getLinkText(mode) {
            if (mode === "journey") {
                if ($this.parents("#fav-edit-journey").length) {
                    return "edit";
                } else if ($this.parents("#fav-add-favourites").length) {
                    return "add";
                }
            }
            return "";
        }
        tfl.logs.create("tfl.favouritesTracking: trackFtuPanelPlaceJourneyClicked");
        var mode = $this.data("mode").toLowerCase();
        var linkText = getLinkText(mode);
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        if (linkText.length > 0) {
            mode = "my " + mode + "s";
            trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, mode, linkText);
        }
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackMyLinesReplanYourJourneyClicked = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackMyLinesReplanYourJourneyClicked");
        var mode = $(e.target).closest(".fav-panel-item").find(".fav-status-sub-heading h2").text().toLowerCase();
        var linkText = $(e.target).text().toLowerCase();
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, mode, linkText);
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackBusFavouritesLinkClicked = function(e, $this) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        function isEditAction() {
            if (isBusRoutePage) {
                return $(e.target).hasClass("route-star-filled") || $(e.target).hasClass("star-map-panel-info-icon-filled") ? true : false;
            } else {
                var actionText = $(e.target).text();
                if (actionText.length) {
                    return actionText.toLowerCase().indexOf("edit") >= 0;
                }
            }
            return false;
        }
        tfl.logs.create("tfl.favouritesTracking: trackBusFavouritesLinkClicked");
        var isBusRoutePage = location.pathname.indexOf("route") >= 0;
        var isMapsPage = location.pathname.indexOf("maps") >= 0;
        var isEdit = isEditAction();
        var fromAction = $this.closest(".map-panel-info").length > 0 ? " interactive map" : "";
        if (isMapsPage) {
            trackBusFavourites(isEdit ? evar.OpenEditPanel_25.BusMapsEdit : evar.OpenEditPanel_25.BusMapsAdd, isEdit ? prop.OpenPanel_41.BusMapsEdit : prop.OpenPanel_41.BusMapsAdd, fromAction);
        } else if (isBusRoutePage) {
            trackBusFavourites(isEdit ? evar.OpenEditPanel_25.BusRouteEdit : evar.OpenEditPanel_25.BusRouteAdd, isEdit ? prop.OpenPanel_41.BusRouteEdit : prop.OpenPanel_41.BusRouteAdd, fromAction);
        } else {
            trackBusFavourites(isEdit ? evar.OpenEditPanel_25.BusStopEdit : evar.OpenEditPanel_25.BusStopAdd, isEdit ? prop.OpenPanel_41.BusStopEdit : prop.OpenPanel_41.BusStopAdd, fromAction);
        }
        function trackBusFavourites(openEditPanel_25, openPanel_41, fromAction) {
            trackingItem = {};
            trackingItem[event.Name] = event.JourneyPlannerAddEdit_21;
            trackingItem[evar.OpenEditPanel_25.Name] = tfl.utils.stringFormat(openEditPanel_25, fromAction);
            trackingItem.newReturnUser = true;
            tfl.stats.tealiumTracking(trackingItem);
            trackingItem = {};
            trackingItem[event.Name] = event.PersonalisationOpenPanel_prop41;
            trackingItem[prop.OpenPanel_41.Name] = tfl.utils.stringFormat(openPanel_41, fromAction);
            tfl.stats.tealiumTracking(trackingItem);
        }
    };
    favouritesTrack.trackStatusBoardRoadsSelect = function($this) {
        if (!tfl.stats.tealiumTracking || $this.parent().hasClass("expanded")) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackStatusBoardRoadsSelect");
        var mode = favs.getFavouritedModeText("Traffic").toLowerCase();
        var action = "road status";
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, mode, action);
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackStatusBoardUpdate = function(e, $this) {
        if (!tfl.stats.tealiumTracking || $this.attr("tabindex") === undefined || !e.originalEvent) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackStatusBoardUpdate");
        var mode = $this.closest(".fav-panel-item").find(".fav-status-sub-heading h2").text().toLowerCase();
        var action = $this.parent().hasClass("disrupted") ? "disruption" : "";
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.AccordionAction, mode, action);
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackStatusPanelClosed = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        function getCloseEditMode() {
            var targetElement = e.target;
            if (e.type && e.type === "swiperight") {
                return "swipe";
            } else if ($(targetElement).hasClass("fav-panel-star")) {
                return "star";
            } else if ($(targetElement).hasClass("close3-icon")) {
                return "cross";
            } else if ($(targetElement).hasClass("c-mask")) {
                return "click away";
            }
        }
        tfl.logs.create("tfl.favouritesTracking: trackStatusPanelClosed");
        var isFtuPanel = $("#fav-add-favourites a:visible").length === ftuElementsCount();
        var closeMode = getCloseEditMode();
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationClosePanel_prop42;
        trackingItem[prop.ClosePanel_42.Name] = isFtuPanel ? tfl.utils.stringFormat(prop.ClosePanel_42.FtuPanelMode, closeMode) : tfl.utils.stringFormat(prop.ClosePanel_42.PublishedPanelMode, closeMode);
        trackingItem.newReturnUser = true;
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackStatusPanelJourneyClicked = function() {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackStatusPanelJourneyClicked");
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, "my journeys", "favourited journey");
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackStatusPanelPlaceClicked = function(placeLabel) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        var getLabel = function() {
            if (!placeLabel) return "";
            var pattern = /^(home|work)$/i;
            var result = placeLabel.match(pattern);
            return result ? placeLabel.toLowerCase() : "other";
        };
        tfl.logs.create("tfl.favouritesTracking: trackStatusPanelPlaceClicked");
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationInPanelInteraction_20;
        trackingItem[evar.PersonalisationInPanelInteractions_24.Name] = tfl.utils.stringFormat(evar.PersonalisationInPanelInteractions_24.ChevronAction, "my places", getLabel());
        tfl.stats.tealiumTracking(trackingItem);
    };
    favouritesTrack.trackPlaceLabelUse = function(action, label) {
        if (!tfl.stats.tealiumTracking || !label) {
            return;
        }
        tfl.logs.create("tfl.favouritesTracking: trackPlaceLabelUse");
        var labelUsed = label.toLowerCase();
        labelUsed = labelUsed === "home" || labelUsed === "work" ? labelUsed : "other";
        trackingItem = {};
        trackingItem[event.Name] = event.PersonalisationAddEditPlaceLabel_28;
        if (action === "Add") {
            trackingItem[evar.PersonalisationAddEditPlaceLabelDetails_29.Name] = tfl.utils.stringFormat(evar.PersonalisationAddEditPlaceLabelDetails_29.LabelAdd, labelUsed);
        } else {
            trackingItem[evar.PersonalisationAddEditPlaceLabelDetails_29.Name] = tfl.utils.stringFormat(evar.PersonalisationAddEditPlaceLabelDetails_29.LabelEdit, labelUsed);
        }
        tfl.stats.tealiumTracking(trackingItem);
    };
    function getFavouritedModeText(modeText) {
        var favModeText = "";
        var textMapper = {
            "Tube, Overground, TfL Rail, DLR & Tram": "My Lines",
            Buses: "My Buses",
            Traffic: "My Roads",
            "River Bus": "My River Buses",
            "Emirates Air Line": "My Emirates Air Line"
        };
        favModeText = textMapper[modeText];
        return favModeText;
    }
    function ftuElementsCount() {
        return tfl.favouritesUtils.helper.modes.length;
    }
})(window.tfl.favouritesTrack = window.tfl.favouritesTrack || {}, jQuery);

(function(favouritesPlaces, $) {
    "use strict";
    tfl.logs.create("tfl.favouritesPlaces: loaded");
    var initialized = false;
    var viewModel = {};
    var defaultLabels = "Home|Work";
    favouritesPlaces.initialize = function(elementScope) {
        if (initialized) {
            viewModel.refreshPlaces(getFavouritePlaces());
            viewModel.resetEditPanel();
            return;
        }
        var favouritePlaces = getFavouritePlaces();
        viewModel = new ViewModel(favouritePlaces, defaultLabels, true);
        ko.applyBindings(viewModel, document.getElementById(elementScope));
        initialized = true;
    };
    $("#search-filter-form-fav-place").on("searchResultSelected", function(e, selectedResult) {
        function checkDefault(propertyToCheck, defaultToSet) {
            return !propertyToCheck || propertyToCheck.length === 0 ? defaultToSet : propertyToCheck;
        }
        var defaultLabel = $(".label-selected").data("fav-place-label");
        var selectedLabel = defaultLabel !== undefined ? defaultLabel : viewModel.customLabel();
        selectedResult.icons = checkDefault(selectedResult.icons, [ "generic-icon-white" ]);
        selectedResult.modes = checkDefault(selectedResult.modes, [ "generic" ]);
        if (!Array.isArray(selectedResult.icons)) {
            selectedResult.icons = selectedResult.icons.split(",").map(function(icon) {
                return icon + "-station-icon";
            });
        }
        if (!Array.isArray(selectedResult.modes)) {
            selectedResult.modes = selectedResult.modes.split(",");
        }
        var favourite = {
            mode: "place",
            placeName: selectedResult.placeName !== undefined ? selectedResult.placeName : selectedResult.placesExtraFullName,
            label: selectedLabel,
            props: {
                label: selectedLabel,
                modeIcons: selectedResult.icons,
                modes: selectedResult.modes ? selectedResult.modes.join(",") : "",
                id: selectedResult.id,
                placeId: selectedResult.placeId ? selectedResult.placeId : selectedResult.id,
                naptanId: selectedResult.naptanId,
                icsId: selectedResult.icsId,
                lat: selectedResult.lat,
                lon: selectedResult.lng
            }
        };
        tfl.favourites.addFavourite(favourite);
        viewModel.addPlace(favourite);
        viewModel.resetEditPanel();
        viewModel.resetSelectLabels();
        $(".my-fav-places").show();
        $(".fav-panel-close-favicon").focus();
    });
    function getFavouritePlaces() {
        var favourites = tfl.favourites.getFavourites("place");
        var places = [];
        if (favourites.length > 0) {
            for (var i = 0; i < favourites.length; i++) {
                places.splice(0, 0, new Place(favourites[i].label, favourites[i].placeName, favourites[i].props.modes, favourites[i].props.modeIcons));
            }
        }
        return places;
    }
    var ViewModel = function(places, defaultLabels) {
        var self = this;
        self.places = ko.observableArray(places);
        self.showLabels = ko.observable(true);
        self.defaultLabels = defaultLabels.split("|");
        self.customLabel = ko.observable("");
        self.deactivated = [];
        self.resetEditPanel = function() {
            self.customLabel("");
            self.showLabels(true);
            self.resetSelectLabels();
            self.clearSearchFilter();
        };
        self.refreshPlaces = function(places) {
            self.places(places);
        };
        self.togglePlace = function(itemFromKeypress) {
            var thisPlace = this;
            if (itemFromKeypress) {
                thisPlace = itemFromKeypress;
            }
            thisPlace.active(!thisPlace.active());
            var placeName = thisPlace.placeName;
            if (thisPlace.active()) {
                var reactivateFavourite = self.deactivated.find(function(favourite) {
                    return favourite.placeName === placeName;
                });
                var deactivatedFavourites = self.deactivated.filter(function(favourite) {
                    return favourite.placeName !== placeName;
                });
                self.deactivated = deactivatedFavourites;
                tfl.favourites.addFavourite(reactivateFavourite);
            } else {
                self.deactivated.push(tfl.favourites.getFavourite(thisPlace.placeName, "place"));
                tfl.favourites.removeFavourite("place", thisPlace.placeName, true);
            }
        };
        self.togglePlaceKeyboard = function(data, event) {
            if (event.keyCode == 13) self.togglePlace(this);
            return true;
        };
        self.toggleLabelForEdit = function() {
            this.labelEdit(true);
            self.resetSelectLabels();
        };
        self.resetSelectLabels = function() {
            var $labels = $("a.fav-place-button");
            $labels.removeClass("label-selected");
        };
        self.addPlace = function(favourite) {
            self.places.splice(0, 0, new Place(favourite.label, favourite.placeName, favourite.props.modes, favourite.props.modeIcons));
        };
        self.selectDefaultLabel = function() {
            var $labelSelected = $('a.fav-place-button[data-fav-place-label="' + this + '"]');
            var currentSelection = $labelSelected.hasClass("label-selected");
            self.resetSelectLabels();
            if (!currentSelection) {
                $labelSelected.addClass("label-selected");
                $labelSelected.attr("aria-checked", "true");
                self.clearSearchFilter();
                $("#InputFavPlace").focus();
            }
        };
        self.selectOtherLabel = function() {
            self.resetSelectLabels();
            self.showLabels(false);
            self.clearSearchFilter();
            $(".custom-label").focus();
        };
        var getAllLabels = function() {
            var labels = self.defaultLabels.filter(function(label) {
                var found = self.places().filter(function(place) {
                    return place.label() && label && place.label().toUpperCase() === label.toUpperCase() && place.active();
                });
                if (found.length === 0) {
                    return label;
                }
            });
            return labels;
        };
        self.allLabels = ko.computed(function() {
            return getAllLabels();
        }, this);
        self.hasPlaces = ko.computed(function() {
            return self.places().length > 0;
        }, this);
        self.clearSearchFilter = function() {
            $("#InputFavPlace").parent().siblings(tfl.dictionary.RemoveContentClass).trigger("click");
        };
        $("#InputFavLabel").on("focusout", function() {
            if (!$("#InputFavLabel").val()) {
                self.showLabels(true);
            }
        });
    };
    var Place = function(label, placeName, modes, modeIcons) {
        var self = this;
        this.label = ko.observable(label);
        this.label.subscribe(function() {
            self.labelEdit(false);
            tfl.favourites.updatePlaceLabel(self.placeName, self.label());
        });
        this.placeName = placeName;
        this.modes = modes;
        this.modeIcons = modeIcons;
        this.active = ko.observable(true);
        this.labelEdit = ko.observable(false);
        this.allModeIcons = function() {
            return modeIcons ? modeIcons : [];
        };
        this.activeState = function() {
            return this.active() ? "fav-star-on" : "fav-star-off";
        };
        this.labelValue = function() {
            return !this.label() ? "Add label" : this.label();
        };
        this.labelIsNotSet = function() {
            return !this.label() ? "fav-label-null" : "";
        };
    };
})(window.tfl.favouritesPlaces = window.tfl.favouritesPlaces || {}, $);

(function(o) {
    "use strict";
    tfl.logs.create("tfl.favouritePlaceJourney: loaded");
    var initialized = false;
    var viewModel = {};
    var defaultAddLabel = "Add label";
    o.getViewModel = function() {
        return viewModel;
    };
    o.initialize = function(data) {
        tfl.logs.create("tfl.favouritePlaceJourney.initialize");
        var selector = "#" + data.elementScope;
        renderEditJourney(selector);
        var journeyPlaces = getJourneyPlaces(data.places);
        var journeys = getJourneys(data.journeyData);
        viewModel = new ViewModel(journeyPlaces, journeys, defaultAddLabel);
        ko.cleanNode(document.getElementById(data.elementScope));
        ko.applyBindings(viewModel, document.getElementById(data.elementScope));
        initialized = true;
    };
    var ViewModel = function(places, journeys, defaultAddLabel) {
        var self = this;
        self.places = ko.observableArray(places);
        self.journeys = ko.observableArray(journeys);
        self.defaultAddLabel = defaultAddLabel;
        self.deactivated = [];
        self.refreshPlaces = function(places) {
            self.places(places);
        };
        self.togglePlace = function() {
            if (window.hasCookieBot() && !Cookiebot.consent.preferences) return;
            this.active(!this.active());
            var placeName = this.placeName;
            if (this.active()) {
                var reactivateFavourite = self.deactivated.find(function(favourite) {
                    return favourite.placeName === placeName;
                });
                var deactivatedFavourites = self.deactivated.filter(function(favourite) {
                    return favourite.placeName !== placeName;
                });
                self.deactivated = deactivatedFavourites;
                self.addFavourite(JSON.parse(ko.toJSON(this)));
            } else {
                self.deactivated.push(tfl.favourites.getFavourite(this.placeName, "place"));
                tfl.favourites.removeFavourite("place", this.placeName, true);
            }
        };
        self.toggleJourney = function() {
            if (window.hasCookieBot() && !Cookiebot.consent.preferences) return;
            this.active(!this.active());
            var storageKey = this.storageKey;
            if (this.active()) {
                var reactivateFavourite = self.deactivated.find(function(j) {
                    return j.storageKey === storageKey;
                });
                var deactivatedFavourites = self.deactivated.filter(function(j) {
                    return j.storageKey !== storageKey;
                });
                self.deactivated = deactivatedFavourites;
                tfl.favourites.addFavourite(JSON.parse(ko.toJSON(this)));
            } else {
                self.deactivated.push(tfl.favourites.getFavourite(this.storageKey, "journey"));
                tfl.favourites.removeFavourite("journey", this.storageKey, true);
            }
        };
        self.updatePlace = function(placeToFind) {
            var match = ko.utils.arrayFirst(self.places(), function findPlace(place) {
                return place.props.id === placeToFind.id || place.placeName === placeToFind.name;
            });
            if (match) {
                match.props.id = placeToFind.id;
                match.props.placeId = placeToFind.placeId;
                match.props.naptanId = placeToFind.naptanId;
                match.props.icsId = placeToFind.icsId;
                match.props.modes = placeToFind.modes ? Array.isArray(placeToFind.modes) ? placeToFind.modes.join(",") : placeToFind.modes : "";
                match.props.modeIcons(placeToFind.modeIcons);
                match.props.lat = Number(placeToFind.lat);
                match.props.lon = Number(placeToFind.lon);
            }
        };
        self.closePanel = function(data, e) {
            tfl.favouritesPanel.closeCurrentPanel(e);
        };
        self.addFavourite = function(selected) {
            var favourite = {
                mode: "place",
                placeName: selected.placeName,
                label: selected.label,
                props: {
                    label: selected.label,
                    modeIcons: selected.props.modeIcons,
                    modes: selected.props.modes && selected.props.modes.indexOf("geocode") >= 0 ? "generic" : selected.props.modes,
                    id: selected.props.id,
                    placeId: selected.props.placeId ? selected.props.placeId : selected.props.id,
                    icsId: selected.props.icsId,
                    naptanId: selected.props.naptanId,
                    lat: Number(selected.props.lat),
                    lon: Number(selected.props.lon)
                }
            };
            tfl.favourites.addFavourite(favourite);
        };
    };
    var Place = function(place) {
        var self = this;
        var observables = {
            label: ko.observable(place.label),
            labelEdit: ko.observable(false),
            active: ko.observable(place.props.isFavourite),
            props: {
                modeIcons: ko.observable(place.props.modeIcons)
            }
        };
        $.extend(true, this, place, observables);
        this.label.subscribe(function() {
            self.labelEdit(false);
            tfl.favourites.updatePlaceLabel(self.placeName, self.label());
        });
        this.allModeIcons = function() {
            return this.props.modeIcons ? this.props.modeIcons : [];
        };
        this.activeState = function() {
            return this.active() ? "fav-star-on" : "fav-star-off";
        };
        this.labelValue = function() {
            return !this.label() ? "Add label" : this.label();
        };
        this.labelIsNotSet = function() {
            return !this.label() ? "fav-label-null" : "";
        };
        this.toggleLabelForEdit = function() {
            this.labelEdit(true);
            this.resetSelectLabels();
        };
        this.resetSelectLabels = function() {
            var $labels = $("a.fav-place-button");
            $labels.removeClass("label-selected");
        };
        this.changeLabel = function() {
            this.labelEdit(false);
            tfl.favourites.updatePlaceLabel(this.placeName, this.label());
        };
    };
    var Journey = function(journey) {
        var observables = {
            active: ko.observable(journey.active)
        };
        this.labelEdit = ko.observable(false);
        $.extend(true, this, journey, observables);
        this.activeState = function() {
            return this.active() ? "fav-star-on" : "fav-star-off";
        };
    };
    o.updatePlace = function(place) {
        viewModel.updatePlace(place);
    };
    function getJourneyPlaces(journeyPlaces) {
        var places = [];
        var favourites = tfl.favourites.getFavourites("place");
        $.each(journeyPlaces, function() {
            places.push(new Place(this));
        });
        return places;
    }
    function getJourneys(journeyData) {
        var journeys = [];
        var journeyFavs = tfl.favourites.getFavourites("journey");
        var storageKey = journeyData.from + "|" + journeyData.to + "|" + journeyData.via;
        var journeyDisplayText = journeyData.from + " to " + journeyData.to + (journeyData.via && " via " + journeyData.via);
        var isFavourite = journeyFavs.find(function(el) {
            return el.journeyFromTo === storageKey;
        });
        var additionalProps = {
            active: !!isFavourite,
            journeyDisplayText: journeyDisplayText,
            storageKey: storageKey,
            journeyFromTo: storageKey,
            props: {
                from: journeyData.from,
                to: journeyData.to,
                via: journeyData.via
            }
        };
        $.extend(true, journeyData, additionalProps);
        journeys.push(new Journey(journeyData));
        return journeys;
    }
    function renderEditJourney(selector) {
        var fromToPlaceMarkup = hoganTemplates.favouritesPlaceJourney.render();
        var container = $(selector);
        container.empty();
        container.append(fromToPlaceMarkup);
    }
})(window.tfl.favouritePlaceJourney = window.tfl.favouritePlaceJourney || {});

(function(o) {
    tfl.logs.create("tfl.socialMedia: loaded");
    o.init = function() {
        var wrapper = $(".share-widget-wrapper");
        if (wrapper.length > 0) {
            var overview = $(".section-overview");
            var url = window.location.href.replace(window.location.hash, "");
            var title = $("h1").text();
            var list = $('<ul class="share-list"></ul>');
            if (overview.length > 0 && !overview.hasClass("full-width")) {
                wrapper.css({
                    marginTop: 0,
                    display: "block",
                    cssFloat: "none"
                });
            }
            wrapper.append('<button class="share-widget clearfix" aria-haspopup="true" aria-expanded="false"><div class="twitter-icon icon"></div><div class="facebook-icon icon"></div><div class="share-icon icon"></div><span class="share-text">Share <span class="visually-hidden">on social media</span></span><span class="down-arrow icon"></span></button>');
            list.append('<li><a href="http://www.facebook.com/share.php?u=' + url + "&t=" + title + '" class="share-facebook clearfix" tabindex="0"><span class="facebook-icon icon"></span><span class="text">Facebook</span></a></li>');
            list.append('<li><a href="https://twitter.com/intent/tweet?text=' + title + " " + url + '" class="share-twitter clearfix" tabindex="0"><span class="twitter-icon icon"></span><span class="text">Twitter</span></a></li>');
            wrapper.append(list);
            var btnShare = $("button.share-widget");
            var toggleShareOptions = function() {
                $(list).toggle();
                btnShare.attr("aria-expanded", btnShare.attr("aria-expanded") === "true" ? "false" : "true");
            };
            if (tfl.utils.isTouchDevice()) {
                $(btnShare).on("touchstart", function() {
                    toggleShareOptions();
                });
            } else {
                $(wrapper).hover(function() {
                    toggleShareOptions();
                });
            }
            wrapper.removeClass("hidden");
        }
    };
    o.init();
})(window.tfl.socialMedia = window.tfl.socialMedia || {});

window.tfl.navigation = window.tfl.navigation || {};

(function(o) {
    "use strict";
    o.tabs = function(elm) {
        tfl.logs.create("tfl.navigation.tabs: loaded");
        var tabs = $(elm).children();
        tabs.click(function(event) {
            event.preventDefault();
            tabs.removeClass("selected");
            $(this).addClass("selected");
            tfl.logs.create("tfl.navigation.tabs: " + $(this).find("a").attr("href"));
        });
    };
    o.tabs("[data-tabs='true']");
    tfl.logs.create("tfl.navigation.pagination: loaded");
    o.setup = function(containerEl, itemClass, itemsPerPage, totNumItems, dontAddPaginationEl, mapController) {
        tfl.logs.create("tfl.navigation.pagination: setup");
        var numPages = totNumItems % itemsPerPage > 0 ? Math.floor(totNumItems / itemsPerPage) + 1 : Math.floor(totNumItems / itemsPerPage);
        var numPagesToDisplay = numPages > 5 ? 3 : numPages;
        if (!dontAddPaginationEl) {
            containerEl.append("<div class='pagination' />");
        }
        containerEl.pajinate({
            items_per_page: itemsPerPage,
            item_container_id: itemClass,
            nav_panel_id: ".pagination",
            num_page_links_to_display: numPagesToDisplay,
            nav_label_first: "1",
            nav_label_prev: "",
            nav_label_next: "",
            nav_label_last: numPages,
            show_first_last: true,
            show_prev_next: false,
            abort_on_small_lists: true
        });
        containerEl.find(".pagination").wrap("<div class='pagination-controls' />");
        containerEl.find(".previous_link").prependTo(containerEl.find(".pagination"));
        containerEl.find(".next_link").appendTo(containerEl.find(".pagination"));
        o.checkPageLinks(containerEl, numPages);
        containerEl.find(".pagination a").click(function() {
            o.checkPageLinks(containerEl, numPages);
            if ($(window).scrollTop() > containerEl.offset().top) {
                window.scrollTo(0, containerEl.offset().top);
            }
        });
    };
    o.addMapControls = function($pagination, mapController) {
        var page = 1;
        if (mapController) {
            $pagination.find(".page_link").click(function() {
                page = parseInt($(this).attr("data-longdesc"), 10);
                mapController.choosePage(page);
            });
            $pagination.find(".previous_link").click(function() {
                mapController.choosePage(--page);
            });
            $pagination.find(".next_link").click(function() {
                mapController.choosePage(++page);
            });
            $pagination.find(".first_link").click(function() {
                page = 1;
                mapController.choosePage(1);
            });
            $pagination.find(".last_link").click(function() {
                $pagination.find(".page_link.last").trigger("click");
            });
        }
    };
    o.checkPageLinks = function(containerEl, numPages) {
        if (numPages < 6) {
            containerEl.find(".first_link,.last_link").hide();
        } else {
            var pageLinks = containerEl.find(".page_link");
            if ($(pageLinks[0]).hasClass("active_page")) {
                $(pageLinks[0]).hide();
                $(pageLinks[3]).show();
                containerEl.find(".next_link").prepend("<span>next-page</span>");
                containerEl.find(".previous_link").prepend("<span>previous-page</span>");
                containerEl.find(".first_link").addClass("active_page");
            } else if ($(pageLinks[pageLinks.length - 1]).hasClass("active_page")) {
                $(pageLinks[pageLinks.length - 1]).hide();
                $(pageLinks[pageLinks.length - 4]).show();
                containerEl.find(".last_link").addClass("active_page");
            } else {
                for (var i = 2; i < pageLinks.length - 2; i++) {
                    if ($(pageLinks[i]).hasClass("active_page")) {
                        $(pageLinks[i + 2]).hide();
                        $(pageLinks[i + 1]).show();
                        $(pageLinks[i - 1]).show();
                        $(pageLinks[i - 2]).hide();
                        break;
                    }
                }
            }
        }
    };
})(window.tfl.navigation.pagination = window.tfl.navigation.pagination || {});

(function(o) {
    "use strict";
    o.initialize = function() {
        tfl.logs.create("tfl.searchFilters: loaded");
        o.setUpResultTags();
        o.populateSearchBoxes();
        o.resetSelectBoxes();
        o.checkQueryString();
        o.selectBoxFiltering();
        o.selectBoxChange();
    };
    o.resetSelectBoxes = function() {
        $(".reset-filters").click(function() {
            $(".selector").children(".filter-box").each(function() {
                $(this).prop("selectedIndex", 0);
                $(this).siblings("span").text($(this).children("option:first-child").text());
                o.selectBoxFiltering();
            });
        });
    };
    o.checkQueryString = function() {
        var url = $(location).attr("href");
        if (url.indexOf("?") >= 0) {
            var urlSplit = url.split("?");
            var ampSplit = urlSplit[1].split("&");
            var numFilters = ampSplit.length;
            var i = 0;
            var preFilterArray = [];
            while (i < numFilters) {
                preFilterArray.push(ampSplit[i].replace(/%20/g, " "));
                i++;
            }
            $(".filter-box").each(function() {
                var filterName = $(this).attr("name");
                for (var x = 0; x < preFilterArray.length; x++) {
                    var arrayFilterValue = preFilterArray[x].split("=");
                    if (arrayFilterValue[0] === filterName) {
                        var allOptions = $(this).children().text();
                        if (allOptions.indexOf(arrayFilterValue[1]) <= 0) {} else {
                            $(this).siblings("span").text(arrayFilterValue[1]);
                        }
                    } else {}
                    o.selectBoxFiltering();
                }
            });
        }
    };
    o.selectBoxChange = function() {
        $("select.filter-box").change(function() {
            o.selectBoxFiltering();
        });
    };
    o.setUpResultTags = function() {
        $(".results-list-all").hide();
        $(".results-list-all").children("#results-list").children("li.search-results").each(function() {
            var tagString = $(this).children(".search-tags");
            var tagStringValue = tagString.text();
            var tagStringSplit = tagStringValue.split(",");
            var numTags = tagStringSplit.length;
            for (var y = 0; y < numTags; y++) {
                tagString.append("<a class='result-tag'>" + tagStringSplit[y] + "</a>");
            }
            var $tmp = tagString.children().remove();
            tagString.text("").append($tmp);
        });
    };
    o.selectBoxFiltering = function() {
        $("#pagination-items").empty();
        $(".pagination").remove();
        $(".search-results").each(function() {
            var hide = false;
            var resultTags = [];
            $(this).find("a.result-tag").each(function() {
                var tag = $(this).text();
                resultTags[resultTags.length] = tag;
            });
            $(".selector").children(".filter-box").each(function() {
                var selectedValue = $(this).siblings("span").text();
                if (selectedValue === "All") {
                    return true;
                }
                var inArrayCheck = $.inArray(selectedValue, resultTags);
                if (inArrayCheck === -1) {
                    hide = true;
                    return false;
                }
            });
            if (!hide) {
                $(this).clone(true).appendTo("#pagination-items");
            }
        });
        var numItems = $("#pagination-items > li").length;
        if (numItems === 0) {
            if ($(".field-validation-information").length < 1) {
                $(".results-wrapper").append("<p class='field-validation-information' id='search-filters-no-results'>There is nothing matching your search.</p>");
            }
        } else {
            $("#search-filters-no-results").remove();
        }
        o.PaginateSearchFilters();
    };
    o.PaginateSearchFilters = function() {
        var itemsPerPage = 5, alItems = $("#pagination-items .search-results").length;
        $(".pagination-controls").remove();
        if ($("#pagination-items .search-results").length > itemsPerPage) {
            $(".results-wrapper ul").after("<div class='pagination' />");
            tfl.navigation.pagination.setup($(".results-wrapper"), "#pagination-items", itemsPerPage, alItems, true);
        }
    };
    o.populateSearchBoxes = function() {
        $(".search-filters-wrapper").append("<div class='search-filter filter-by-box'><a class='reset-filters'>Reset</a><p class='heading'>Filter by:</p>");
        for (var i = 0; i <= filters.length; i++) {
            for (var categoryName in filters[i]) {
                $(".filter-by-box").append("<div class='filter-box-wrap'></div");
                $(".filter-box-wrap").eq(i).append("<label for='" + categoryName + "' class='heading'>" + categoryName + ":</label><div class='selector'><select class='filter-box' name=" + categoryName + " class='valid'><option selected='selected'>All</option></select></div>");
                for (var j = 0; j < filters[i][categoryName].length; j++) {
                    $(".filter-box-wrap").eq(i).find(".filter-box").append("<option>" + filters[i][categoryName][j] + "</option>");
                }
            }
        }
        tfl.forms.setupSelectBoxes();
    };
    $(document).ready(function() {
        $("input").each(function() {
            var autocorrectValue = $(this).data("autocorrect");
            $(this).attr("autocorrect", autocorrectValue);
        });
    });
    $(document).ready(function() {
        tfl.logs.create("tfl.searchFilters: looking for search filters");
        var selector = $(".search-filters-wrapper");
        if (selector.length > 0) {
            tfl.logs.create("tfl.searchFilters: loading search filters");
            o.initialize();
        }
    });
})(window.tfl.searchFilters = window.tfl.searchFilters || {});

(function(o) {
    "use strict";
    o.RemoveContentClass = tfl.dictionary.RemoveContentClass;
    o.DisabledRemoveContentClass = tfl.dictionary.DisabledRemoveContentClass;
    tfl.logs.create("tfl.removableContent.initRemoveContents: loaded");
    o.initRemoveContents = function() {
        tfl.logs.create("tfl.removableContent.initRemoveContents: started");
        var $targets = $(":input:text").not("." + o.DisabledRemoveContentClass);
        $targets.each(function(index, input) {
            var label = $('label[for="' + $(input).attr("id") + '"]');
            var linkText = "Clear " + label.html();
            $(input).clearSearch({
                divClass: "remove-content-container",
                clearClass: "remove-content",
                linkText: linkText
            });
        });
        $targets.filter(".custom-label, #InputFavBus, #InputFavPlace").each(function() {
            $(this).next().addClass("label");
        });
        $targets.not(".tt-hint").each(function() {
            if ($(this).val() === "") {
                $(this).closest(".remove-content-container").addClass("empty");
            }
        }).on("keyup", function() {
            if ($(this).val() === "") {
                $(this).closest(".remove-content-container").addClass("empty");
            } else {
                $(this).closest(".remove-content-container").removeClass("empty");
            }
        });
        $(".remove-content").addClass("hide-text").click(function() {
            if ($(this).parent().find("input[type='text']").attr("id") === "InputFrom") {
                $("#FromId").val(null);
            } else {
                $("#ToId").val(null);
            }
            var $currentLocationBoxes = $(this).siblings("[data-current-location]");
            if ($currentLocationBoxes.length === 0) {
                $currentLocationBoxes = $(this).parent("[data-current-location]");
            }
            if ($currentLocationBoxes.length > 0) {
                $currentLocationBoxes.removeAttr("data-current-location");
                $currentLocationBoxes.find("input[type='text']").trigger("geolocation-cleared");
            }
            $(this).closest(".remove-content-container").addClass("empty");
        });
    };
    o.initRemoveContents();
})(window.tfl.removableContent = window.tfl.removableContent || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.printPage: loaded");
    o.options = {
        printPageButtonClass: "print-this-page-button",
        printPageTriggerClass: "trigger-print-this-page"
    };
    o.openDialog = function() {
        window.print();
    };
    o.destroy = function() {
        $("." + o.options.printPageTriggerClass).off("click");
    };
    o.init = function(options) {
        if (options !== null && options !== undefined) {
            jQuery.extend(o.options, options);
        }
        $("." + o.options.printPageTriggerClass).on("click", function() {
            o.openDialog();
        });
        tfl.logs.create("tfl.printPage: initialised");
    };
    o.init();
})(window.tfl.printPage = window.tfl.printPage || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.videoPlayerFallback: loaded");
    o.options = {
        videoPlayerClass: "video-player",
        videoEvidenceTypeName: "video-evidence-player",
        linkClass: "video-link",
        videoLinkWrapClass: "fallback-video-link-container",
        videoEvidenceLinkClass: "congestion-charge-evidence",
        typeAttr: "type",
        linkText: "Click here to view the video evidence"
    };
    o.browserRequiresFallBackLink = function() {
        var requiresLinkInserted = false;
        var v = document.createElement("video");
        if (v.canPlayType && !v.canPlayType("video/mp4").replace(/no/, "")) {
            requiresLinkInserted = true;
        }
        return requiresLinkInserted;
    };
    o.getVideoPlayerFallbackLink = function(url) {
        var link = $("<a></a>").prop("href", url).addClass(o.options.linkClass).text(o.options.linkText);
        return link;
    };
    o.getVideoPlayerFallbackHtml = function(url, playerType) {
        var link = $(o.getVideoPlayerFallbackLink(url));
        var wrapDiv = $("<div></div>").addClass(o.options.videoLinkWrapClass);
        if (playerType == o.options.videoEvidenceTypeName) {
            link.addClass(o.options.videoEvidenceLinkClass);
        }
        return wrapDiv.append(link);
    };
    o.destroy = function() {};
    o.init = function(options) {
        var videoPlayers = $("." + o.options.videoPlayerClass);
        if (o.browserRequiresFallBackLink()) {
            $.each(videoPlayers, function(index, ob) {
                var player = $(ob), url = player.find("source").prop("src"), playerType = player.data(o.options.typeAttr);
                o.getVideoPlayerFallbackHtml(url, playerType).insertAfter(player);
                player.hide();
            });
        }
    };
    o.init();
})(window.tfl.videoPlayerFallback = window.tfl.videoPlayerFallback || {});

(function(o) {
    var accordionClass = ".always-visible", expandedEvent = "expandable-box.expanded", collapsedEvent = "expandable-box.collapsed", toggleEvent = "toggleExpandableBox", clickEvent = "click.expandableBox";
    expandableBoxHandler = function(e) {
        var $this = $(this), $childrenLinks = $this.children("a"), $par = $this.closest(".content"), isCurrentlyExpanded = $par.hasClass("expanded"), toExpand = (!isCurrentlyExpanded).toString(), $triggerEventName;
        if (!isCurrentlyExpanded) {
            triggerEventName = expandedEvent;
        } else {
            triggerEventName = collapsedEvent;
        }
        $par.toggleClass("expanded", toExpand);
        $this.attr("aria-expanded", toExpand);
        $childrenLinks.attr("aria-expanded", toExpand);
        $this.trigger(triggerEventName);
        return true;
    };
    o.init = function() {
        $(accordionClass).off(clickEvent + " " + toggleEvent).on(clickEvent + " " + toggleEvent, expandableBoxHandler).on(expandedEvent + " " + collapsedEvent + " " + toggleEvent, false);
    };
    o.init();
})(window.tfl.expandableBox = window.tfl.expandableBox || {});

(function(o) {
    function breadcrumb($el) {
        var $breadcrumbs = $el, $parent = $breadcrumbs.parent(), $items = $breadcrumbs.find(">li"), $ellipsis = null, ellipsisWidth = 0, breakpointArrowWidth = 13, measurements = [], breakpoints = [], totalWidth = 0, width = 0, currentBreakpoint = 0, hiding = false, resizeFunc = null;
        return {
            init: function() {
                $ellipsis = $("<li class='ellipsis hidden'><a href='javascript:void(0)'>...</a></li>");
                $items.eq(0).after($ellipsis);
                ellipsisWidth = $ellipsis.width();
                $ellipsis.click(this.makeScrollable);
                $items.each(function() {
                    var w = $(this).width();
                    measurements.push(w);
                    totalWidth += w;
                });
                totalWidth += breakpointArrowWidth;
                breakpoints.push(totalWidth);
                var c = totalWidth;
                for (var i = 1; i < measurements.length; i++) {
                    c -= measurements[i];
                    breakpoints.push(c + ellipsisWidth);
                }
                resizeFunc = $.proxy(this.onResize, this);
                $(window).on("resize", resizeFunc);
                this.onResize();
            },
            onResize: function() {
                width = $breadcrumbs.width();
                if (width < totalWidth) {
                    if (width <= breakpoints[currentBreakpoint]) {
                        hiding = true;
                        $ellipsis.removeClass("hidden");
                        while (width <= breakpoints[currentBreakpoint]) {
                            this.hideItem(currentBreakpoint);
                            currentBreakpoint++;
                        }
                    } else if (width > breakpoints[currentBreakpoint]) {
                        while (width > breakpoints[currentBreakpoint]) {
                            this.showItem(currentBreakpoint);
                            currentBreakpoint--;
                        }
                    }
                } else if (hiding) {
                    $ellipsis.addClass("hidden");
                    hiding = false;
                    while (width >= breakpoints[currentBreakpoint]) {
                        this.showItem(currentBreakpoint);
                        currentBreakpoint--;
                    }
                    if (currentBreakpoint < 0) {
                        currentBreakpoint = 0;
                    }
                }
            },
            hideItem: function(idx) {
                $items.eq(idx + 1).hide();
            },
            showItem: function(idx) {
                $items.eq(idx + 1).show();
            },
            makeScrollable: function() {
                if (tfl.utils.isTouchDevice()) {
                    $parent.addClass("scrolling");
                    $breadcrumbs.css({
                        width: totalWidth + "px"
                    });
                }
                $ellipsis.addClass("hidden");
                $items.each(function() {
                    $(this).show();
                });
                $(window).off("resize", resizeFunc);
                return false;
            }
        };
    }
    o.init = function() {
        var $breadcrumbs = $("ul.breadcrumbs");
        $("ul.breadcrumbs").each(function() {
            $breadcrumbs = $(this);
            new breadcrumb($breadcrumbs).init();
        });
    };
    o.init();
})(window.tfl.breadcrumb = window.tfl.breadcrumb || {});

(function(o) {
    o.init = function(selector) {
        $(selector).each(function() {
            var $this = $(this);
            $this.wrap('<div class="fc-calendar-wrapper clearfix" />');
            var $wrap = $this.parent();
            var $cal = $this.calendario({
                weekabbrs: [ "S", "M", "T", "W", "T", "F", "S" ],
                displayWeekAbbr: true,
                month: $this.attr("data-month"),
                year: $this.attr("data-year")
            });
            $wrap.prepend("<div class='current-month'><a href='javascript:void(0);' class='calendar-previous-month hide-text'>Previous month</a><span class='calendar-month'>" + $cal.getMonthName() + "</span> <span class='calendar-year'>" + $cal.getYear() + "</span><a href='javascript:void(0);' class='calendar-next-month hide-text'>Next month</a></div>");
            $wrap.find(".calendar-next-month").on("click", function() {
                if (!$(this).hasClass("disabled")) {
                    $cal.gotoNextMonth(function() {
                        updateMonthYear();
                        $this.attr("data-month", $cal.getMonth());
                        $this.attr("data-year", $cal.getYear());
                        $(window).trigger("calendar-next-month");
                    });
                }
            });
            $wrap.find(".calendar-previous-month").on("click", function() {
                if (!$(this).hasClass("disabled")) {
                    $cal.gotoPreviousMonth(function() {
                        updateMonthYear();
                        $this.attr("data-month", $cal.getMonth());
                        $this.attr("data-year", $cal.getYear());
                        $(window).trigger("calendar-previous-month");
                    });
                }
            });
            var $month = $wrap.find(".calendar-month");
            var $year = $wrap.find(".calendar-year");
            var updateMonthYear = function() {
                $month.html($cal.getMonthName());
                $year.html($cal.getYear());
            };
        });
    };
    o.init(".fc-calendar-container");
})(window.tfl.calendar = window.tfl.calendar || {});

(function(o) {
    o.allTables = [];
    o.tableCellPadding = 5;
    o.tableShadowWidth = 15;
    o.ResponsiveTable = function(el) {
        var table = el;
        var parent = $(table).parent();
        var left = null;
        var top = null;
        var width = null;
        var height = null;
        var hiding = false;
        var leftShadow = null;
        var rightShadow = null;
        var parentWidth = null;
        var scrollMax = null;
        var firstRow = null;
        var firstRowHeight = 0;
        var firstRowTop = 0;
        var firstRowLeft = 0;
        var firstRowFixed = false;
        var firstCol = null;
        var firstColWidth = 0;
        var firstColLeft = 0;
        return {
            init: function() {
                var t = this;
                t.onResize();
                parent.scroll(t.onParentScroll);
                if ($(parent).closest(".expandable-box").length) {
                    $(parent).closest(".expandable-box").find(".always-visible").on("click", function() {
                        t.onResize();
                    });
                }
            },
            onResize: function() {
                var wasVisible = this.isVisible;
                if ($(parent).is(":visible")) {
                    this.isVisible = true;
                } else {
                    this.isVisible = false;
                }
                if (!wasVisible && this.isVisible) {
                    this.stopHiding();
                    this.startHiding();
                }
                var offset = $(parent).offset();
                left = offset.left;
                top = offset.top;
                width = $(table).width();
                height = $(table).height();
                parentWidth = $(parent).width();
                if (firstRow) {
                    firstRowHeight = firstRow.height() ? firstRow.height() : firstRowHeight;
                    var toffset = $(table).offset();
                    firstRowTop = toffset.top;
                    firstRowLeft = toffset.left;
                    if (hiding) {
                        firstRow.parent().css({
                            width: parentWidth,
                            left: left
                        });
                        this.onWindowScroll($(window).scrollTop());
                    }
                }
                if (firstCol) {
                    firstColWidth = firstCol.width() - 2 * o.tableCellPadding;
                }
                if (width > parentWidth) {
                    if (!hiding) {
                        this.startHiding();
                    } else {
                        scrollMax = width - parentWidth;
                        this.onParentScroll();
                    }
                } else if (hiding) {
                    this.stopHiding();
                }
            },
            onWindowScroll: function(scrollTop) {
                var offset = $(parent).offset();
                left = offset.left;
                top = offset.top;
                if (hiding && !firstRowFixed && (top < scrollTop && scrollTop <= top + height - firstRowHeight)) {
                    firstRowFixed = true;
                    $(firstRow).css({
                        marginLeft: -1 * $(parent).scrollLeft()
                    });
                    $(firstRow).parent().removeClass("hidden");
                } else if (firstRowFixed) {
                    if (top >= scrollTop || scrollTop > top + height - firstRowHeight) {
                        firstRowFixed = false;
                        $(firstRow).parent().addClass("hidden");
                    }
                }
            },
            onParentScroll: function() {
                var pScrollLeft = $(parent).scrollLeft();
                $(firstRow).css({
                    marginLeft: -1 * pScrollLeft
                });
                leftShadow.css({
                    left: firstColWidth + 2 * o.tableCellPadding - o.tableShadowWidth + Math.min(pScrollLeft, o.tableShadowWidth)
                });
                var r = Math.min(scrollMax - pScrollLeft, o.tableShadowWidth) - o.tableShadowWidth;
                if (r === -1 * o.tableShadowWidth) {
                    r++;
                }
                rightShadow.css({
                    right: r
                });
            },
            startHiding: function() {
                hiding = true;
                parent.addClass("hiding");
                if (parent.children(".hiding-table").length > 0) {
                    firstRow.css({
                        width: width
                    });
                    parent.children(".hiding-table").show();
                } else {
                    this.createFixedHeadings();
                }
                parent.parent().addClass("hiding");
            },
            stopHiding: function() {
                hiding = false;
                parent.removeClass("hiding");
                parent.parent().removeClass("hiding");
                parent.parent().find(".hiding-table").hide();
                firstRowFixed = false;
                $(firstRow).parent().addClass("hidden");
            },
            createFixedHeadings: function() {
                width = $(table).width();
                firstRow = $("<table class='first-row'></table>");
                var fr = $(table).find("tr:first-child");
                firstRowHeight = fr.height();
                firstRow.append(fr.clone().css({
                    height: firstRowHeight,
                    width: width
                }));
                firstRow.find("th").replaceWith(function() {
                    return $("<td />", {
                        html: $(this).html()
                    });
                });
                var frCells = fr.find("th, td");
                $(firstRow).find("th, td").each(function(i) {
                    if (i === 0) {
                        $(this).html("<span>" + $(this).html() + "</span>");
                    }
                    $(this).width($(frCells.get(i)).width());
                });
                firstCol = $("<table class='hiding-table first-col'></table>").css({
                    top: 0
                });
                firstColWidth = 0;
                firstColLeft = 0;
                $(table).find("th:first-child,td:first-child").each(function(i) {
                    if (i === 0) {
                        firstColWidth = $(this).width();
                        firstColLeft = $(this).offset().left;
                    }
                    var r = $("<tr></tr>");
                    r.append($(this).clone().css({
                        height: $(this).height()
                    }));
                    firstCol.append(r);
                });
                parent.wrap("<div class='responsive-table-wrapper'></div>");
                parent.parent().append(firstCol.css({
                    width: firstColWidth,
                    position: "absolute"
                }));
                firstRow.wrap("<div class='hidden'></div>");
                firstCol.after(firstRow.css({
                    width: width
                }).parent().css({
                    overflow: "hidden",
                    width: parentWidth,
                    position: "relative",
                    top: 0,
                    boxShadow: "0px 5px 5px -3px rgba(0, 0, 0, 0.3)"
                }));
                height = $(table).height();
                firstRowTop = $(firstRow).parent().offset().top;
                firstRowLeft = $(table).offset().left;
                leftShadow = $("<div class='responsive-table-shadow left-shadow' />");
                leftShadow.css({
                    left: firstColWidth + 2 * o.tableCellPadding - o.tableShadowWidth,
                    height: height
                });
                rightShadow = $("<div class='responsive-table-shadow right-shadow' />");
                rightShadow.css({
                    right: 0,
                    height: height
                });
                firstCol.before(leftShadow);
                firstCol.before(rightShadow);
                scrollMax = width - parentWidth;
                this.onWindowScroll($(window).scrollTop());
            }
        };
    };
    o.init = function(selector) {
        $(selector).each(function(i) {
            var t = new o.ResponsiveTable(this);
            t.init();
            o.allTables.push(t);
        });
        if (o.allTables.length > 0) {
            $(window).resize(function() {
                for (var i = 0; i < o.allTables.length; i++) {
                    o.allTables[i].onResize();
                }
            });
            $(window).scroll(function() {
                var scrollTop = $(this).scrollTop();
                for (var i = 0; i < o.allTables.length; i++) {
                    o.allTables[i].onWindowScroll(scrollTop);
                }
            });
        }
    };
    o.init(".table-container table");
})(window.tfl.responsiveTables = window.tfl.responsiveTables || {});

(function($, window, document, undefined) {
    "use strict";
    tfl.logs.create("tfl.inputAccordion: loaded");
    var defaults = {
        triggerClass: ".input-accordion-trigger",
        drawWrap: ".ia-toggle-content",
        inputGroupClass: ".input-group",
        startHiddenClass: ".start-hidden"
    };
    function InputAccordion(element, options) {
        this.el = element;
        this.settings = $.extend({}, defaults, options);
        this._defaults = defaults;
        this.init();
    }
    InputAccordion.prototype = {
        init: function() {
            var $el = $(this.el), opts = this.settings, $allInputs = $el.find(opts.triggerClass);
            function toggleExtraContent($keyContainer, $input) {
                var inputType = $input.prop("type").toLowerCase(), $startHidden = $keyContainer.find(opts.startHiddenClass);
                if (inputType === "checkbox") {
                    $keyContainer.toggleClass("expanded");
                    if ($input[0].checked) {
                        $startHidden.attr("aria-expanded", "true");
                        $el.trigger("expandable-box.expanded");
                    } else {
                        $startHidden.attr("aria-expanded", "false");
                        $el.trigger("expandable-box.collapsed");
                    }
                } else if (inputType === "radio") {
                    $keyContainer.parents(opts.inputGroupClass).find(opts.drawWrap).removeClass("expanded").find(opts.startHiddenClass).attr({
                        "aria-expanded": false,
                        tabindex: -1
                    });
                    $startHidden = $keyContainer.addClass("expanded").find(opts.startHiddenClass);
                    if (!$keyContainer.hasClass("no-content")) {
                        $startHidden.attr("aria-expanded", "true");
                        $el.trigger("expandable-box.expanded");
                    }
                }
            }
            $el.find(opts.startHiddenClass).attr("aria-expanded", "false");
            $allInputs.attr("tabindex", 0);
            $allInputs.on("change", function() {
                var $keyContainer = $(this).parents(opts.drawWrap);
                toggleExtraContent($keyContainer, $(this));
            });
            $allInputs.each(function() {
                if ($(this).prop("checked")) {
                    toggleExtraContent($(this).parents(opts.drawWrap), $(this));
                }
            });
        }
    };
    $.fn.inputAccordion = function(options) {
        this.each(function() {
            if (!$.data(this, "plugin_inputAccordion")) {
                $.data(this, "plugin_inputAccordion", new InputAccordion(this, options));
            }
        });
        return this;
    };
})(jQuery, window, document);

(function($) {
    "use strict";
    var defaults = {
        countTemplate: "textAreaCounter",
        characterCountClass: ".char-count"
    };
    function TextCounter(el, options) {
        this.el = el;
        this.opts = $.extend(true, {}, defaults, options);
        this.parentElem = $(this.el).parents(".form-control");
        this.maxInputLength = $(el).data("val-length-max");
        this.init();
    }
    TextCounter.prototype = {
        setCount: function() {
            var elemText = this.el.value, cleanText = elemText.replace(/([^\r]{0,1})\n/g, "$1\r\n").substring(0, this.maxInputLength), opts = this.opts, $parent = this.parentElem;
            this.el.value = cleanText;
            $parent.find(opts.characterCountClass).text(cleanText.length);
        },
        init: function() {
            var $el = $(this.el), opts = this.opts, $parent = this.parentElem, that = this, $counter;
            if (!this.maxInputLength) {
                tfl.logs.create("TextCounter: showCounter requires [StringLength] on model property", "warn");
                return;
            }
            $counter = $(hoganTemplates[opts.countTemplate].render({
                charCount: this.el.value.replace(/([^\r]{0,1})\n/g, "$1\r\n").substring(0, this.maxInputLength).length,
                charLimit: this.maxInputLength
            }));
            $parent.append($counter);
            $el.on("keyup blur paste", function() {
                tfl.tools.simpleThrottle(that.setCount(), 100);
            });
        }
    };
    $.fn.textCounter = function(opts) {
        return this.each(function() {
            if (!$.data(this, "textCounter")) {
                $.data(this, "textCounter", new TextCounter(this, opts));
            }
        });
    };
})($);

$(window).on("load", function() {
    var textAreas = $("#full-width-content").find(".text-area-with-counter");
    textAreas.textCounter();
});

(function($) {
    "use strict";
    var $body = $("body"), imgWidth, defaults = {
        modalComponent: ".modal-simple-component",
        modalBodyClass: "m088-modal-background",
        modalBackground: "#modal-overlay",
        modalTemplate: hoganTemplates.modalSimpleComponent,
        modalHeader: "#modal-header",
        modalTitle: "#modal-title",
        modalBody: "#modal-body",
        modalClose: "#modal-close",
        minWinWidth: 580
    };
    function Modal(element, options) {
        this.el = element;
        this.opts = $.extend({}, defaults, options);
        this.init();
    }
    Modal.prototype = {
        init: function() {
            var el = this.el, opts = this.opts, storeImageData = function storeImageData() {
                var img = new Image(), widthCalc;
                img.src = $(el).prop("href");
                img.onload = function() {
                    $(el).data("imgOriginalWidth", $(img).width());
                    $(img).remove();
                };
                $body.append($(img));
                widthCalc = window.setInterval(function() {
                    if ($(el).data().hasOwnProperty("imgOriginalWidth")) {
                        window.clearInterval(widthCalc);
                        showModal();
                    }
                }, 10);
            }, hideModal = function hideModal(e) {
                console.info("Hide modal");
                e.stopImmediatePropagation();
                $body.find(opts.modalBody).children("img").fadeOut(100, function() {
                    $body.removeClass(opts.modalBodyClass).find(opts.modalComponent).hide();
                });
                return false;
            }, showModal = function showModal() {
                var modalTitle = $(el).children("img").attr("alt") || "Transport for London", imgObj = {}, imgTag;
                if ($(el).data().hasOwnProperty("imgOriginalWidth")) {
                    imgWidth = $(el).data().imgOriginalWidth;
                    $body.find(opts.modalComponent).show(1, uiTweak);
                } else {
                    storeImageData();
                    return;
                }
                imgObj.src = $(el).prop("href");
                imgObj.alt = modalTitle;
                imgTag = hoganTemplates.basicImage.render(imgObj);
                if (!$(opts.modalHeader).length) {
                    $body.addClass(opts.modalBodyClass).append(opts.modalTemplate.render({
                        title: modalTitle,
                        body: imgTag
                    }));
                    uiTweak();
                } else {
                    $body.addClass(opts.modalBodyClass);
                    $(opts.modalBody).html(imgTag);
                    $(opts.modalTitle).html(modalTitle);
                }
            }, uiTweak = function uiTweak() {
                var winWidth = $(window).width(), winHeight = $(document).height(), $mBody = $(opts.modalBody);
                $mBody.css({
                    top: $(opts.modalHeader).outerHeight() + 20
                });
                $(opts.modalBackground).height(winHeight);
                if (imgWidth < winWidth) {
                    $mBody.css({
                        width: imgWidth + "px",
                        margin: "0 auto",
                        left: (winWidth - imgWidth) / 2 + "px"
                    });
                }
            };
            if ($(window).width() < opts.minWinWidth) {
                return;
            }
            $(el).on("click", function() {
                if ($(el).data().hasOwnProperty("imgOriginalWidth")) {
                    imgWidth = $(el).data().imgOriginalWidth;
                    uiTweak();
                    showModal();
                } else {
                    storeImageData();
                }
                return false;
            });
            $(window).on("modalImageLoaded", uiTweak);
            $body.on("click", opts.modalClose, hideModal);
            $body.on("click", ".m088-modal-window", hideModal);
            $body.on("click", opts.modalBody, function(e) {
                e.stopPropagation();
            });
        }
    };
    $.fn.tflModal = function(opts) {
        return this.each(function() {
            if (!$.data(this, "tflModal")) {
                $.data(this, "tflModal", new Modal(this, opts));
            }
        });
    };
})($);

$("#full-width-content").find(".modal-launch").tflModal();

(function(o) {
    "use strict";
    tfl.logs.create("tfl.currentLocation: loaded");
    o.init = function() {
        tfl.logs.create("tfl.currentLocation: init");
        var url = window.location.pathname;
        if (!url || url.indexOf("maps") < 0) {
            url = "/maps";
        }
        $(".maps-nearby-current-location").on("click keydown", function(e) {
            if (e.type != "click" && e.which != 13 && e.which != 32) return;
            e.preventDefault();
            tfl.geolocation.geolocateMe(null, locationFound, locationNotFound);
        });
        function locationFound(coordinates) {
            window.location.href = tfl.utils.stringFormat("{0}?Input=Current+location+&InputGeolocation={1}%2C{2}", url, coordinates.latitude, coordinates.longitude);
        }
        function locationNotFound(error) {
            tfl.logs.create(tfl.utils.stringFormat("tfl.currentLocation: not found location of user - {0}", error.message));
            window.location.href = tfl.utils.stringFormat("{0}?Input=Current+location+&Error={1}", url, error.message);
        }
    };
    o.init();
})(window.tfl.currentLocation = window.tfl.currentLocation || {});

(function(o) {
    tfl.logs.create("tfl.fullscreen stage: loaded");
    var $stage, $closeButton, elements = [], initialized = false, originalPositions = [], originalPositionsAreParents = [], withPanZoom = false, previousScrollTop = 0, options = {
        id: "fullscreen-stage",
        stageActiveClass: "stage-active"
    };
    function setupStage(noButton) {
        var $stageElement = $('<div id="' + options.id + '"></div>');
        if (!noButton) {
            $closeButton = $('<button class="fullscreen-stage-button close-fullscreen-stage"><span class="icon close-icon"></span></button>');
            $stageElement.append($closeButton);
            $closeButton.on("click", removeFromStage);
        }
        $(document.body).append($stageElement);
        initialized = true;
        return $stageElement;
    }
    function addToStage($el) {
        tfl.logs.create("tfl.fullscreen: enter fullscreen stage");
        o.addItemToStage($el);
        $(document.body).addClass(options.stageActiveClass);
        $(window).trigger("enter-fullscreen-stage");
        tfl.mapTrack.trackMapActivity(tfl.mapTrack.mapActivity.OPENFULLSCREEN);
        if (withPanZoom && elements.length === 1) {
            $(document.body).addClass("panzoom");
            tfl.zoomableContent.init($el);
        }
    }
    function removeFromStage() {
        tfl.logs.create("tfl.fullscreen: exit fullscreen stage");
        var $element;
        for (var i = elements.length - 1; i >= 0; i--) {
            $element = elements[i];
            if (originalPositionsAreParents[i]) {
                originalPositions[i].append($element);
            } else {
                originalPositions[i].before($element);
            }
        }
        elements = [];
        originalPositions = [];
        originalPositionsAreParents = [];
        if (withPanZoom) {
            $(document.body).removeClass("panzoom");
            $element.trigger("destroy-panzoom");
        }
        $(document.body).removeClass(options.stageActiveClass);
        $(window).trigger("exit-fullscreen-stage");
    }
    o.addItemToStage = function($element) {
        if (!$stage) {
            tfl.logs.create("tfl.fullscreen: Tried to add item to stage before stage was initialised");
            return;
        }
        var $next = $element.next();
        if ($next.length === 0) {
            originalPositions[originalPositions.length] = $element.parent();
            originalPositionsAreParents[originalPositionsAreParents.length] = true;
        } else {
            originalPositions[originalPositions.length] = $next;
            originalPositionsAreParents[originalPositionsAreParents.length] = false;
        }
        elements.push($element);
        $stage.append($element);
    };
    o.hide = function() {
        o.removeElementsFromStage();
        o.setScrollTop();
    };
    o.removeElementsFromStage = function() {
        if (elements.length) {
            removeFromStage();
        }
    };
    o.setScrollTop = function() {
        document.body.scrollTop = previousScrollTop;
    };
    o.display = function($el, wPZ, noButton) {
        if (!initialized) {
            $stage = setupStage(noButton || false);
        }
        withPanZoom = wPZ;
        if (elements.length) {
            removeFromStage();
        }
        previousScrollTop = document.body.scrollTop;
        addToStage($el);
    };
})(window.tfl.fullscreen = window.tfl.fullscreen || {});

(function(o) {
    "use strict";
    tfl.logs.create("tfl.listToDropdown: loaded");
    var throttle, $throttleTarget;
    o.init = function() {
        tfl.logs.create("tfl.listToDropdown: initialised");
        o.buildHtmlDropdown();
        o.dropDownMouseFunctionality();
        o.hideShowList();
        o.datePickerDropdownBuilding();
    };
    o.buildHtmlDropdown = function() {
        $(".links-list").each(function() {
            var linkList = $(this);
            var expandOnDesktop = false;
            if (linkList.hasClass("status-updates")) {
                expandOnDesktop = true;
            }
            var dropDownTarget = linkList.data("dropdown-target");
            var dropDownLabel = linkList.data("dropdown-label");
            var selectedItem = linkList.data("selected-item-id");
            var dropdownStyling = linkList.data("dropdown-option");
            var datesClass = "";
            linkList.addClass("hidden");
            if (!expandOnDesktop) {
                linkList.find('li[data-item-id="' + selectedItem + '"]').hide();
            }
            if (dropDownTarget === "date-dropdown-placeholder") {
                datesClass = "datepicker-dropdown";
                linkList.addClass(datesClass);
                if (expandOnDesktop) {
                    $(this).find(".fc-calendar-wrapper").addClass("hidden");
                    var dateLink = linkList.children("li:last-child");
                    if (dateLink.hasClass("selected")) {
                        dateLink.find(".dropdown-name").html(selectedItem);
                    }
                    selectedItem = linkList.find("li.selected").find(".dropdown-name").html();
                }
            }
            linkList.wrap('<div class="for-dropdown" />');
            if (linkList.attr("id") === "gla-list") {
                linkList.parent().prepend('<button role="button" tabindex="0" id="mol-button" aria-haspopup="true" aria-expanded="false" class="dropdown-button ' + dropdownStyling + " dropdown-closed " + datesClass + '"><img src="/static/cms/images/MoL.png" alt="Mayor of London"><span class="mol-gla">GLA</span></button>');
            } else if (expandOnDesktop) {
                linkList.parent().prepend('<div tabindex="0" role="button" ' + 'aria-label="' + dropDownLabel + '" class="dropdown-button ' + dropdownStyling + " dropdown-closed " + datesClass + '" >' + "<span>" + selectedItem + "</span></div>");
            } else {
                linkList.parent().prepend('<div tabindex="0" role="button" ' + 'aria-label="' + dropDownLabel + '" class="dropdown-button ' + dropdownStyling + " dropdown-closed " + datesClass + '" >' + "<span>" + selectedItem + "</span></div>");
            }
            $("." + dropDownTarget).append(linkList.parent());
            if (expandOnDesktop) {
                var listHeader = linkList.parents(".heading-dropdown").attr("data-list-header");
                linkList.prev(".dropdown-button").attr("data-list-header", listHeader).before("<h2>" + selectedItem + "</h2>");
            }
            if ((linkList.attr("id") !== "gla-list" || !linkList.attr("id")) && !expandOnDesktop) {
                $(linkList).find("li:visible:first").css("border-top", "solid 1px #cacaca");
            }
            linkList.siblings(".dropdown-button").click(function() {
                o.toggleAriaLabelsOnShow();
                o.hideShowList(linkList.siblings(".dropdown-button"));
            }).keypress(function(e) {
                if (e.which === 13) {
                    $(this).click();
                }
            });
            linkList.find(".date-wrap").on("click", function() {
                o.hideShowCalender($(this).parents("ul").prev(".dropdown-button"));
            });
            var currentHeight = 0, positionDropdown;
            if (linkList.hasClass("modes-list")) {
                var thisList = $(this);
                window.onresize = function() {
                    clearTimeout(positionDropdown);
                    positionDropdown = setTimeout(resizedw, 100);
                };
            }
            function resizedw() {
                var headerHeight, currentHeight;
                headerHeight = thisList.prev().height();
                if (currentHeight !== headerHeight && !expandOnDesktop) {
                    thisList.css("top", headerHeight + 14);
                    currentHeight = headerHeight;
                }
            }
        });
    };
    o.hideShowList = function(el) {
        var $el = $(el);
        if ($el.hasClass("dropdown-closed")) {
            clearTimeout(throttle);
            throttle = 0;
            $throttleTarget = undefined;
            $('ul.links-list:not(".hidden")').addClass("hidden").prev(".dropdown-button").addClass("dropdown-closed");
        }
        $el.next("ul.links-list").toggleClass("hidden");
        $("ul.links-list li:visible:first").css("border-top-width", "1px");
        $el.toggleClass("dropdown-closed");
        clearTimeout(throttle);
        throttle = 0;
        $throttleTarget = undefined;
    };
    o.hideShowCalender = function(el) {
        var $el = $(el);
        var calender = $el.next("ul").children("li:last-child").find(".fc-calendar-wrapper");
        if ($el.hasClass("dropdown-closed")) {
            clearTimeout(throttle);
            throttle = 0;
            $throttleTarget = undefined;
            calender.addClass("hidden");
            $el.addClass("dropdown-closed");
        }
        calender.toggleClass("hidden");
        $el.toggleClass("dropdown-closed");
        calender.siblings(".date-wrap").toggleClass("on");
        clearTimeout(throttle);
        throttle = 0;
        $throttleTarget = undefined;
    };
    o.dropDownMouseFunctionality = function() {
        $(".date-wrap").parent("li").on("mouseleave", function() {
            if ($("body").hasClass("breakpoint-Large")) {
                var $this = $(this);
                $throttleTarget = $this;
                throttle = setTimeout(function() {
                    if (!$this.parents("ul").prev(".dropdown-button").hasClass("dropdown-closed")) {
                        o.hideShowCalender($this.parents("ul").prev(".dropdown-button"));
                    }
                }, 500);
            }
        }).on("mouseenter", function() {
            if ($("body").hasClass("breakpoint-Large")) {
                if (throttle && $(this).is($throttleTarget)) {
                    clearTimeout(throttle);
                    throttle = 0;
                    $throttleTarget = undefined;
                }
            }
        });
        $(".for-dropdown").on("mouseleave", function() {
            var $this = $(this);
            $throttleTarget = $this;
            throttle = setTimeout(function() {
                if (!$this.children(".dropdown-button").hasClass("dropdown-closed")) {
                    o.hideShowList($this.children(".dropdown-button"));
                }
            }, 500);
        }).on("mouseenter", function() {
            if (throttle && $(this).is($throttleTarget)) {
                clearTimeout(throttle);
                throttle = 0;
                $throttleTarget = undefined;
            }
        });
    };
    o.datePickerDropdownBuilding = function() {
        $(".advance-month-container").parent().addClass("no-hover");
    };
    o.toggleAriaLabelsOnShow = function() {
        var buttonEl = document.getElementById("mol-button");
        var isExpanded = JSON.parse(buttonEl.getAttribute("aria-expanded"));
        buttonEl.setAttribute("aria-expanded", !isExpanded);
    };
    o.init();
})(window.tfl.listToDropdown = window.tfl.listToDropdown || {});

(function(o) {
    tfl.logs.create("tfl.search-icon-toggle: loaded");
    var $searchBox = $(".search-tools input:text");
    var $btSearch = $("#search-button");
    var $removeContent = $(".search-tools a.remove-content");
    o.toggleSearchIcon = function() {
        if ($searchBox.length && $searchBox.val().length) {
            $btSearch.show();
        } else {
            $btSearch.hide();
        }
    };
    o.h1Fix = function() {
        var $searchTitle = $(".search-title");
        var dots = $(".dots").length;
        if (dots === 0) {
            $searchTitle.append("<span class='hero-headline dots visually-hidden'>...</span>");
        }
        $searchTitle.css("display", "inline-block");
        var searchTitleWidth = $searchTitle.outerWidth();
        var pageWidth = $searchTitle.parent().outerWidth();
        pageWidth = pageWidth * .95;
        pageWidth = pageWidth - 20;
        if (searchTitleWidth > pageWidth) {
            $searchTitle.css("display", "block");
            $(".dots").removeClass("visually-hidden");
        } else {
            $searchTitle.css("display", "inline-block");
            $(".dots").addClass("visually-hidden");
        }
    };
    o.toggleSearchIcon();
    o.h1Fix();
    $searchBox.on("keyup", o.toggleSearchIcon);
    $removeContent.on("click", o.toggleSearchIcon);
    $(window).on("resize", o.h1Fix);
})(window.tfl.searchIcon = window.tfl.searchIcon || {});

(function($, window) {
    "use strict";
    var defaults = {
        bricks: ".pcn-tile",
        columns: 2,
        gutters: {
            left: 30,
            bottom: 30
        },
        animationDelay: 1,
        minWidth: 580
    };
    function TileLayout(el, opts) {
        this.el = el;
        this.defaults = defaults;
        this.opts = $.extend({}, defaults, opts);
        this.init();
    }
    TileLayout.prototype = {
        init: function() {
            if (!$(this.el).is(":visible")) {
                var hiddenEl = this.el, hiddenOpts = this.opts;
                $(hiddenEl).find(".pcn-tile").css({
                    visibility: "visible"
                });
                window.setTimeout(function() {
                    $(hiddenEl).removeData("tileLayout");
                }, 1e3);
                $(window).one("expandable-box.expanded", function() {
                    $(hiddenEl).tileLayout(hiddenOpts);
                });
                return;
            }
            if ($(window).width() < this.opts.minWidth) {
                return;
            }
            var el = this.el, opts = this.opts, eH, eW, cols = opts.columns, columnHeights = [], horizGutterSpace = (cols - 1) * opts.gutters.left, $bricks = $(el).find(opts.bricks), brickCount = 0, colCounter = 0, nextTopPositions = [], nextLeftPosition = 0, additionalChildren, preSetUp = function(elems) {
                var i = 0;
                eH = $(el).outerHeight(true);
                eW = $(el).width();
                $bricks.css({
                    visibility: "hidden"
                });
                brickCount = $bricks.length - 1;
                additionalChildren = $(el).children().filter(function() {
                    if (!$(this).hasClass(opts.bricks.replace(".", ""))) {
                        return $(this);
                    }
                });
                for (i; i < cols; i++) {
                    columnHeights[i] = 0;
                    nextTopPositions[i] = elems.eq(i).height() + opts.gutters.bottom;
                }
                $(el).css({
                    overflow: "visible"
                });
                return nextTopPositions;
            };
            function resetTiles() {
                $bricks.attr("style", "");
                $(el).attr("style", "");
                $(el).removeData("tileLayout");
            }
            $.when(preSetUp($bricks)).done(function() {
                var tileWidth = (eW - horizGutterSpace) / cols, tallestColumnHeight;
                $bricks.each(function(n) {
                    var tile_css = {}, height = $(this).height();
                    tile_css.width = tileWidth + "px";
                    tile_css.left = nextLeftPosition + "px";
                    tile_css.visibility = "hidden";
                    if (n < cols) {
                        tile_css.top = $(this).position().top;
                    } else {
                        tile_css.top = nextTopPositions[colCounter];
                    }
                    nextLeftPosition = $(this).width() + opts.gutters.left;
                    nextTopPositions[colCounter] = tile_css.top + height + opts.gutters.bottom;
                    columnHeights[colCounter] = columnHeights[colCounter] + height + opts.gutters.bottom;
                    colCounter += 1;
                    if (colCounter === cols) {
                        colCounter = 0;
                        nextLeftPosition = 0;
                    }
                    $(this).data("tileCss", tile_css);
                    if (n === brickCount) {
                        $bricks.css({
                            position: "absolute",
                            float: "none",
                            clear: "none"
                        });
                    }
                });
                tallestColumnHeight = Math.max.apply(Math, columnHeights);
                if (additionalChildren.length > 0) {
                    var extraChildrenHeight = 0;
                    $.each(additionalChildren, function() {
                        extraChildrenHeight += $(this).outerHeight();
                    });
                    $(el).height(extraChildrenHeight + tallestColumnHeight + "px");
                } else {
                    $(el).height(tallestColumnHeight + "px");
                }
                $bricks.each(function() {
                    $(this).animate($(this).data("tileCss"), opts.animationDelay, function() {
                        $(this).css({
                            visibility: "visible"
                        });
                    });
                });
                $(window).on("exitBreakpointMedium", function() {
                    resetTiles();
                });
                $(window).on("enterBreakpointMedium", function() {
                    var triggerTime, reinit = function() {
                        clearTimeout(triggerTime);
                        triggerTime = window.setTimeout(function() {
                            if (!$(el).data().hasOwnProperty("tileLayout")) {
                                $(el).tileLayout(opts);
                            }
                        }, 500);
                    };
                    reinit();
                });
            });
        }
    };
    $.fn.tileLayout = function(opts) {
        return this.each(function() {
            if (!$.data(this, "tileLayout")) {
                $.data(this, "tileLayout", new TileLayout(this, opts));
            }
        });
    };
})($, window);

(function() {
    var linkClass = "go-back", links = $('a[href$="#"].' + linkClass);
    links.on("click", tfl.tools.jumpBack);
})();

(function($) {
    "use strict";
    var defaults = {
        lookupURL: tfl.web.addressSearch,
        selectAddressURL: tfl.web.selectAddress,
        postCodeField: ".postcode",
        resultTarget: ".address-fields",
        multipleResultsSelect: ".address-results-list",
        triggerSelector: ".trigger-postcode-lookup",
        manualInputTrigger: ".trigger-manual-address",
        serviceError: ".address-service-error",
        fieldPrefix: "lookup-",
        lookupAddressButtonContainer: ".validate-button-click",
        btnLoadClass: tfl.dictionary.throbberClasses.button,
        searchOnce: true,
        hasKO: false
    };
    function enterManually(el, opts) {
        var $elem = $(el).find(opts.resultTarget), $fields = $elem.find(".lookup-result"), idPrefix = opts.fieldPrefix, $country = $(el).find(".country-field");
        var $mustFillFields = $(el).find(".mustfilladdress");
        if ($mustFillFields.length) {
            $mustFillFields.rules("remove");
        }
        document.getElementById(idPrefix + "AddressEnteredManually").value = "True";
        $(window).trigger("AddressManualEntry");
        $(el).find(".address-fields .form-control-wrapper").removeClass("initially-hidden");
        $fields.each(function() {
            if ($(this).data().hasOwnProperty("valRequired")) {
                $.validator.unobtrusive.parse($(this));
            }
        });
        $country.val("United Kingdom");
        $country.on("change", function() {
            if ($.trim($(this).val()).toLowerCase() === "united kingdom") {
                tfl.forms.makeRequired($(opts.postCodeField), [ "regex" ]);
            } else {
                tfl.forms.makeNotRequired($(opts.postCodeField), [ "regex" ]);
            }
            $.validator.unobtrusive.parse($(opts.postCodeField));
        });
        $(el).find(opts.manualInputTrigger).hide();
        $(el).find(opts.lookupAddressButtonContainer).hide();
        $(el).find(".returned-addresses").hide();
    }
    function selectAddress(addressData, el, opts) {
        var $field, fieldName, fieldValue, addressUrl = defaults.selectAddressURL.replace("{id}", addressData), compareValue;
        tfl.ajax({
            url: addressUrl,
            cache: false,
            success: function(data) {
                data = JSON.parse(data);
                $(el).find(opts.manualInputTrigger).hide();
                opts.fields.each(function() {
                    $field = $(this);
                    fieldName = $field.prop("id").replace(opts.fieldPrefix, "");
                    fieldName = fieldName.charAt(0).toLowerCase() + fieldName.slice(1);
                    if (data.hasOwnProperty(fieldName)) {
                        fieldValue = data[fieldName];
                        if (fieldValue && fieldValue.length > 0 && typeof fieldValue !== "undefined") {
                            $field.val(data[fieldName]);
                            if ($field.data().hasOwnProperty("valRequired")) {
                                $.validator.unobtrusive.parse($field);
                            }
                            if (opts.hasKO) {
                                $field.change();
                            }
                            if ($(this).hasClass("country-field") && this.tagName.toLowerCase() === "select") {
                                compareValue = data[fieldName].toLowerCase().replace(/\w\S*/g, function(txt) {
                                    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                                });
                                $field.val(compareValue).trigger("change");
                            }
                        }
                    }
                });
                $(window).trigger("addressSelect", [ data ]);
            },
            error: function() {
                $(el).find(opts.serviceError).show();
                enterManually(el, opts);
            }
        });
        $(el).find(".select-address-button").removeClass(opts.btnLoadClass);
    }
    function processResults(addresses, el, opts) {
        var addressesLength = addresses.length, output = [], addressArray = [], obj, key, selectOptions, options, i = 0, $select = $(el).find(opts.multipleResultsSelect);
        $(el).find(opts.serviceError).hide();
        if (!addressesLength || !addresses[0].id) {
            $(el).find(opts.serviceError).show();
            return;
        }
        for (i; i < addressesLength; i++) {
            addressArray = [];
            obj = addresses[i];
            key = addresses[i].id;
            output.push({
                key: key,
                value: obj.name
            });
        }
        selectOptions = {
            output: output
        };
        options = $(window.hoganTemplates.selectOptions.render(selectOptions));
        $select.html(options).parents(".returned-addresses").show();
        if (parseInt($select.attr("size"), 10) === 1) {
            tfl.forms.setupSelectBoxes($select);
        }
        $select.find("option").slice(0, 1)[0].selected = true;
        $select.focus();
    }
    function getAddresses(postCode, el, opts) {
        var lookupURL = opts.lookupURL.replace("{postcode}", postCode);
        tfl.ajax({
            url: lookupURL,
            cache: false,
            success: function(data) {
                data = JSON.parse(data);
                if (data && data.hasOwnProperty("matches")) {
                    var obj = data.matches;
                    $(el).data("MatchedAddresses", obj);
                    processResults(obj, el, opts);
                }
            },
            error: function() {
                $(el).find(opts.serviceError).show();
                enterManually(el, opts);
                $(el).parents("form").find(":submit").one("click", function() {
                    $(el).find(opts.serviceError).hide();
                });
            }
        });
        $(el).find(opts.triggerSelector).removeClass(opts.btnLoadClass);
    }
    function PostcodeLookup(el, opts) {
        this.el = el;
        this.defaults = defaults;
        this.opts = $.extend(true, {}, defaults, opts);
        this.opts.fields = $(el).find("input[type='text'], .country-field, .building-number-field");
        this.init();
    }
    PostcodeLookup.prototype = {
        init: function() {
            var opts = this.opts, el = this.el, inputConfig = {}, hiddenField, $triggerButton = $(el).find(opts.triggerSelector), $postCodeField = $(el).find(opts.postCodeField), filledFields = $.map($(el).find(opts.fields), function(fld) {
                if ($.trim($(fld).val()).length > 0 && !$(fld).hasClass("mustfilladdress")) {
                    return fld;
                }
            }), filledFieldLength = filledFields.length, idPrefix = opts.fieldPrefix, namePrefix = idPrefix.replace(/_/g, "."), manualField = $(el).find("[id~='AddressEnteredManually']");
            if (manualField.length) {
                manualField.val("False");
            } else {
                inputConfig.type = "hidden";
                inputConfig.value = "False";
                inputConfig.name = namePrefix + "AddressEnteredManually";
                inputConfig.id = idPrefix + "AddressEnteredManually";
                hiddenField = $(hoganTemplates.input.render(inputConfig));
                $(el).parents("form").append(hiddenField);
            }
            $triggerButton.on("click", function(e) {
                var pCode = $.trim($postCodeField.val()).toUpperCase();
                e.preventDefault();
                if (tfl.forms.valid($postCodeField)) {
                    $(this).addClass(opts.btnLoadClass);
                    getAddresses(pCode, el, opts);
                    $(el).addClass("searched");
                }
            });
            $(el).find(".select-address-button").on("click", function(e) {
                e.preventDefault();
                var $select = $(el).find(opts.multipleResultsSelect);
                $(el).find(".lookup-result").val("");
                $(el).find(".select-address-button").addClass(opts.btnLoadClass);
                selectAddress($select.val(), el, opts);
                $select.parents(".returned-addresses").hide();
                $(el).find(".mustfilladdress").data("not-activated", false).val("dev/null");
                $(el).find(".address-fields .form-control-wrapper").removeClass("initially-hidden");
                if (opts.searchOnce) {
                    $(el).find(opts.triggerSelector).parent().hide();
                }
            });
            $(el).find(opts.manualInputTrigger).on("click", function(e) {
                e.preventDefault();
                enterManually(el, opts);
            });
            opts.fields.each(function() {
                var $this = $(this);
                if ($this.val() !== "" && !$this.hasClass("country-field")) {
                    $this.parents(".form-control-wrapper").show();
                }
                if ($this.hasClass("country-field") && this.tagName.toLowerCase() === "select" && filledFieldLength > 3) {
                    $this.parents(".form-control-wrapper").show();
                    tfl.forms.updateSelectBox(this);
                }
            });
            if (filledFieldLength > 2) {
                window.setTimeout(function() {
                    $(el).find(".mustfilladdress").rules("remove");
                    $(el).find(".mustfillwrapper").hide();
                }, 500);
            }
        }
    };
    $.fn.PostcodeLookup = function(opts) {
        return this.each(function() {
            if (!$.data(this, "PostcodeLookup")) {
                $.data(this, "PostcodeLookup", new PostcodeLookup(this, opts));
            }
        });
    };
    $("#full-width-content").find(".address-lookup-control").each(function() {
        var prefix = $(this).data().inputPrefix || null, $this = $(this), lookupConfig = {};
        if (prefix) {
            lookupConfig.fieldPrefix = prefix + "_";
        }
        if ($this.parent().hasClass("zone-location-seeker")) {
            lookupConfig.searchOnce = false;
        }
        if (document.getElementById("requestDispensationFormWizard") || document.getElementById("review-representation")) {
            lookupConfig.hasKO = true;
        }
        $this.PostcodeLookup(lookupConfig);
    });
})($);

(function($) {
    "use strict";
    var defaults = {
        fieldPrefix: "look-up",
        lookupURL: tfl.web.streetLookup
    }, $container = $("#full-width-content"), showServiceError = function(el) {
        $(el).find(".address-service-error").show();
        $(".street-address-wrapper").show();
        $(el).find(".mustfilladdress").data("not-activated", false).val("dev/null");
    }, hideServiceError = function(el) {
        $(el).find(".address-service-error").hide();
    }, selectStreet = function(el, opts, street) {
        opts.streetField.removeClass("loading-field");
        $(el).find(".street-result").val(street).change();
        $(".street-address-wrapper").show();
        $(el).find(".mustfilladdress").data("not-activated", false).val("dev/null");
    }, processResults = function(el, opts, matches) {
        var streets = [], i = 0, selectOptions, options, value, $selectWrap = $(el).find(".returned-addresses"), $select = $selectWrap.find("select");
        if (matches.length === 1) {
            selectStreet(el, opts, matches[0].street);
        } else {
            streets.push({
                key: "",
                value: "Please select",
                selected: true
            });
            for (i; i < matches.length; i++) {
                value = matches[i].street;
                streets.push({
                    key: value,
                    value: value
                });
            }
            selectOptions = {
                output: streets
            };
            options = $(window.hoganTemplates.selectOptions.render(selectOptions));
            $select.children().remove();
            $select.html(options).change();
            $selectWrap.show();
            $select.one("change", function() {
                $(".street-address-wrapper").show();
                $selectWrap.hide();
            });
        }
    }, getStreets = function(el, opts, postcode) {
        var lookupUrl = opts.lookupURL + postcode;
        opts.streetField.addClass("loading-field");
        $.ajax({
            url: lookupUrl,
            cache: false,
            success: function(data) {
                data = JSON.parse(data);
                if (data && data.hasOwnProperty("matches")) {
                    processResults(el, opts, data.matches);
                }
            },
            error: function() {
                showServiceError(el);
                opts.streetField.removeClass("loading-field");
                $(el).find(".street-result").show();
                $(el).parents("form").find(":submit").one("click", function() {
                    hideServiceError(el);
                });
            }
        });
    };
    function StreetLookUp(el, opts) {
        this.el = el;
        this.opts = opts;
        this.opts = $.extend(true, {}, defaults, opts);
        this.opts.streetField = $(el).find("input").filter(":visible").slice(0, 1);
        this.init();
    }
    StreetLookUp.prototype = {
        init: function() {
            var opts = this.opts, el = this.el, $triggerButton = $(el).find(".street-lookup-button"), $select = $(el).find(".returned-addresses select"), $postcodeField = $(el).find(".postcode");
            $triggerButton.on("click", function(e) {
                e.preventDefault();
                var postCode = $postcodeField.val();
                if (tfl.forms.valid($postcodeField)) {
                    getStreets(el, opts, postCode);
                }
            });
            $postcodeField.on("blur", function() {
                $(this).val($(this).val().toUpperCase());
            });
            $select.on("change", function() {
                selectStreet(el, opts, $(this).val());
            });
        }
    };
    $.fn.StreetLookUp = function(opts) {
        return this.each(function() {
            if (!$.data(this, "StreetLookUp")) {
                $.data(this, "StreetLookup", new StreetLookUp(this, opts));
            }
        });
    };
    $container.find(".street-lookup-control").each(function() {
        var prefix = $(this).data().inputPrefix || null;
        if (prefix) {
            $(this).StreetLookUp({
                fieldPrefix: prefix + "_",
                findStreet: true
            });
        }
    });
})($);

(function(o) {
    "use strict";
    tfl.logs.create("tfl.searchFilter: loaded");
    var nearUrl = "/maps/", placesTemplate = "<div class='mode-icons'>{{#displayIcons}}<span class='mode-icon {{.}}'>&nbsp;</span>{{/displayIcons}}</div><span id='{{id}}' class='stop-name' data-id='{{id}}' role='option'>{{#label}}<span class='label-name'>{{label}}</span>, {{/label}}{{name}}</span>{{#destination.length}}<div class='towards-text'>towards {{destination}}</div>{{/destination.length}}";
    function addGeolocationHiddenInput(el, latitude, longitude) {
        var existingGeolocation = el.find("input[id='InputGeolocation']");
        if (existingGeolocation.length === 0 && latitude && longitude) {
            var appendLast = el.find("div.text-input").children().last();
            var geolocationInput = $(tfl.utils.stringFormat("<input id='InputGeolocation' name='InputGeolocation' type='hidden' value='{0},{1}' />", latitude, longitude));
            appendLast.append(geolocationInput);
        }
    }
    var searchForm = $("#search-filter-form");
    var zoomLevel = $("#zoomLevel");
    var searchType = $("#search-filter-form input#type").val();
    searchForm.submit(function(e) {
        if (searchType === "Ptal") {
            zoomLevel.val("15");
        } else {
            zoomLevel.val("14");
        }
        return true;
    });
    function removeHiddenInputs(el, except) {
        el.find("input[type='hidden']").not("[id='" + except + "']").remove();
    }
    o.resultType = {
        CurrentLocation: "currentlocation",
        Place: "place",
        PlaceExtra: "placeextra",
        Route: "route",
        StopPoint: "stoppoint",
        BikePoint: "bikepoint",
        TaxiRank: "taxiRank"
    };
    o.setNearUrl = function(url) {
        nearUrl = url;
    };
    function searchResultSelected(searchFilter, datum) {
        searchFilter.trigger("searchResultSelected", datum);
    }
    var searchRequestSuccess = function(searchFilter) {
        return function(response, textStatus, xhr) {
            var contentType = xhr.getResponseHeader("content-type") || "", $next = searchFilter.parent().next();
            if ($next.hasClass("disambiguation-in-page")) {
                $next.remove();
            }
            if (contentType.indexOf("html") > -1) {
                searchFilter.parent().after(response);
                searchFilter.parent().next().find(".disambiguation-option").click(function() {
                    var datum = $(this).data(), searchFilterInput = $(searchFilter, '[id^=Input], input[data-typeahead="true"]'), boundingBox = {
                        neLat: $("#NeLat").val(),
                        neLon: $("#NeLon").val(),
                        swLat: $("#SwLat").val(),
                        swLon: $("#SwLon").val()
                    };
                    searchFilterInput.val(datum.name);
                    ajaxGetPlaceDetail(datum, function() {
                        searchResultSelected(searchFilter, {
                            resultType: datum.placetype,
                            placeType: datum.placetype,
                            lat: datum.lat,
                            lng: datum.lng,
                            id: datum.id,
                            boundingBox: boundingBox,
                            placesExtraFullName: datum.name,
                            modes: datum.modenames,
                            icons: datum.modenames
                        });
                        searchFilter.parent().next(".disambiguation-in-page").remove();
                    });
                });
            } else if (contentType.indexOf("json") > -1) {
                var searchFilterInput = $(searchFilter, '[id^=Input], input[data-typeahead="true"]');
                ajaxGetPlaceDetail(response, function() {
                    searchFilterInput.val(response.placeName);
                    searchResultSelected(searchFilter, {
                        resultType: response.placeType,
                        placeType: response.placeType,
                        lat: response.lat,
                        lng: response.lon,
                        id: response.parameterValue,
                        boundingBox: response.boundingBox,
                        placesExtraFullName: response.placeName
                    });
                });
            }
        };
    };
    function ajaxGetPlaceDetail(datum, callback) {
        var placeType = datum.placeType || datum.placetype;
        if (placeType !== "placeextra") {
            callback();
            return;
        }
        var b = datum.b || datum.id || datum.parameterValue, d = datum.d || datum.lat, e = datum.e || datum.lng;
        if (!d && !e) {
            tfl.ajax({
                url: tfl.addAppIdAndKey(tfl.utils.stringFormat("{0}Place/Extra/Details/{1}", tfl.apiUrl, b)),
                dataType: "",
                success: function(result) {
                    datum.lat = result.lat;
                    datum.lng = result.lon;
                    datum.lon = result.lon;
                    callback();
                }
            });
        } else {
            callback();
        }
    }
    var searchRequestError = function(searchFilter) {
        return function searchRequestError(xhr) {
            var $next = searchFilter.parent().next();
            if ($next.hasClass("disambiguation-in-page")) {
                $next.remove();
            }
            searchFilter.parent().after(xhr.responseText);
        };
    };
    function ajaxSubmitForm(searchFilter) {
        tfl.ajax({
            url: tfl.disambiguationUrl,
            data: searchFilter.serialize(),
            dataType: "",
            success: searchRequestSuccess(searchFilter),
            error: searchRequestError(searchFilter)
        });
    }
    function manageDataSets(dataSets) {
        var dataSetsLast = dataSets.length - 1;
        $(dataSets).each(function(index) {
            var dataSet = this[0];
            if (dataSet === "placesExtra" && index !== dataSetsLast) {
                dataSets.push(this);
                dataSets.splice(index, 1);
            }
        });
    }
    function searchFilterOnSubmit(searchFilter) {
        searchFilter.submit(function(e) {
            var hasContent = $(this).find('[id^=Input], input[data-typeahead="true"]').val().replace(/ /g, "").length !== 0 && $(this).find('[id^=Input], input[data-typeahead="true"]').val().replace(/ /g, "").toLowerCase() !== "currentlocation";
            e.preventDefault();
            e.stopPropagation();
            if (hasContent) {
                ajaxSubmitForm($(this));
            }
            $(this).find("input:text").blur();
            $(this).find("input:submit").focus();
        });
    }
    o.init = function() {
        tfl.logs.create("tfl.searchFilter.init: started");
        var searchFilters = $('[id*="search-filter-form"]');
        for (var sfIndex = 0; sfIndex < searchFilters.length; sfIndex++) {
            var searchFilterId = $(searchFilters[sfIndex]).prop("id");
            var searchFilter = $("#" + searchFilterId);
            var fromFavPanel = searchFilterId.indexOf("form-fav") >= 0 ? true : false;
            destroyAutocomplete(searchFilter);
            var searchFilterInput = searchFilter.find('[id^=Input], input[data-typeahead="true"]'), searchFilterInputId = "#" + searchFilterInput.prop("id"), showFavourites = showFavouritePlaces(searchFilter), excludeFavourites = excludeFavouritePlaces(searchFilter), showRecents = showRecentPlaces(searchFilter), typeaheadSettings = searchFilter.data("typeaheadsettingsjson");
            var dataSets = searchFilter.data("datasets");
            if (dataSets) {
                manageDataSets(dataSets);
            }
            if (searchFilterId.indexOf("form-") !== -1 && !dataSets) {
                dataSets = [ [ "stopPoints", "journeyPlannerNoSubmit?Input={{input}}" ], [ "bikePoints", "journeyPlannerNoSubmit?Input={{input}}" ], [ "placesExtra", "journeyPlannerNoSubmit?Input={{input}}" ] ];
            }
            var modesArr = searchFilter.data("modes") ? searchFilter.data("modes").split(",") : [];
            var busStopsOnly = getDataAttributeAsBoolean("busstopsonly"), isOysterOnly = getDataAttributeAsBoolean("isoysteronly"), includeHubs = getDataAttributeAsBoolean("includehubs"), ajaxEnabled = getDataAttributeAsBoolean("ajax-enabled"), isSspHome = getDataAttributeAsBoolean("isssphome"), displaySelectedModesOnly = getDataAttributeAsBoolean("display-selected-modes-only"), allowGeoLocationSubmit = getDataAttributeAsBoolean("allow-geo-location-submit"), autocompleteSources = [], favouritePlacesSources = [], recentSearchesSources = [];
            if (ajaxEnabled) {
                searchFilterOnSubmit(searchFilter);
            }
            processDataSets(dataSets);
            autocompleteAddRecentSearchesSources();
            autocompleteAddFavouritePlaces();
            if (!$(".accstats").length) {
                autocompleteAddGeolocation(searchFilter);
            }
            tfl.autocomplete.setup("#" + searchFilterId + " " + searchFilterInputId, autocompleteSources, typeaheadSettings, true);
        }
        function getDataAttributeAsBoolean(dataAttributeName) {
            return searchFilter.data(dataAttributeName) && searchFilter.data(dataAttributeName).toLowerCase() === "true";
        }
        function processDataSets(dataSets) {
            $(dataSets).each(function() {
                var dataSet = this[0], returnUrl = this[1], submitWhenSelectGeoLocation = searchFilter && searchFilter.data("allow-geo-location-submit") && searchFilter.data("allow-geo-location-submit").toLowerCase() === "true";
                if (dataSet == tfl.disambiguationDataSets.stopPoints) {
                    var stopsCallback = function(inputEl, datum, dataset, event) {
                        var a = datum.a || datum.name, b = datum.b || datum.id, c = datum.c || datum.modes, d = datum.d || datum.lat, e = datum.e || datum.lon, g = datum.g, h = datum.h || datum.destination, f = datum.f || datum.icsId, stopId = datum.k || datum.stopId, cName = c;
                        if (typeof c === "object" && c.length) {
                            cName = g && g.isHubStationStop ? tfl.modeNameMultiModal : getModeByRank(c);
                        }
                        if (!f) {
                            f = d + "," + e;
                        }
                        tfl.autocomplete.recentMagicSearches.saveSearch(a, b, c, "stops", d, e, null, null, h, busStopsOnly, f, g, stopId);
                        var searchFilter;
                        if (returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) {
                            if (inputEl.indexOf("search-filter-form-0") !== -1) {
                                searchFilter = $("div#search-filter-form-0.clearfix");
                                $("input#FromId").val(f).change();
                                $($(inputEl) && $(inputEl).length === 0 ? "input#From" : inputEl).val(a).change();
                            } else if (inputEl.indexOf("search-filter-form-1") !== -1) {
                                searchFilter = $("div#search-filter-form-1.clearfix");
                                $("input#ToId").val(f).change();
                                $($(inputEl) && $(inputEl).length === 0 ? "input#To" : inputEl).val(a).change();
                            } else {
                                searchFilter = $("div#search-filter-form-2.clearfix");
                                $("input#ViaId").val(f);
                                $($(inputEl) && $(inputEl).length === 0 ? "input#Via" : inputEl).val(a);
                            }
                        } else {
                            searchFilter = $(inputEl).parents("form");
                        }
                        var ajaxEnabled = searchFilter.data("ajax-enabled").toLowerCase() === "true";
                        if (!ajaxEnabled) {
                            removeHiddenInputs(searchFilter);
                        }
                        if (returnUrl !== null) {
                            if (returnUrl.indexOf("?") !== -1 || returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) {
                                var urlParameters = returnUrl.substring(returnUrl.indexOf("?") + 1);
                                var paramsHash = urlParameters.split("#");
                                var keyValues = paramsHash[0].split("&");
                                for (var k = 0; k < keyValues.length; k++) {
                                    var keyValue = keyValues[k].split("=");
                                    switch (keyValue[0].toLowerCase()) {
                                      case "inputgeolocation":
                                        searchFilter.append('<input type="hidden" id ="InputGeolocation" name="InputGeolocation" value="' + encodeURI(d + "," + e) + '" />');
                                        break;

                                      case "startdate":
                                        if (location.search.toLowerCase().indexOf("startdate") !== -1) {
                                            var restOfUrlStartDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("startdate")));
                                            var startDate = restOfUrlStartDate.substring(restOfUrlStartDate.indexOf("=") + 1, restOfUrlStartDate.indexOf("&") !== -1 ? restOfUrlStartDate.indexOf("&") : null);
                                            if (startDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='startDate' name='startDate' value='" + startDate + "' />");
                                            }
                                        }
                                        break;

                                      case "enddate":
                                        if (location.search.toLowerCase().indexOf("enddate") !== -1) {
                                            var restOfUrlEndDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("enddate")));
                                            var endDate = restOfUrlEndDate.substring(restOfUrlEndDate.indexOf("=") + 1, restOfUrlEndDate.indexOf("&") !== -1 ? restOfUrlEndDate.indexOf("&") : restOfUrlEndDate.length);
                                            if (endDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='endDate' name='endDate' value='" + endDate + "' />");
                                            }
                                        }
                                        break;

                                      case "stopid":
                                        searchFilter.append("<input type='hidden' id='stopId' name='stopId' value='" + b + "' />");
                                        break;

                                      case "input":
                                        break;

                                      case "datetypeselect":
                                        if (location.search.toLowerCase().indexOf("datetypeselect") !== -1) {
                                            var restOfUrldateTypeSelect = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("datetypeselect")));
                                            var dateTypeSelect = null;
                                            if (restOfUrldateTypeSelect.indexOf("&") !== -1) {
                                                dateTypeSelect = restOfUrldateTypeSelect.substring(restOfUrldateTypeSelect.indexOf("=") + 1, restOfUrldateTypeSelect.indexOf("&"));
                                            } else {
                                                dateTypeSelect = restOfUrldateTypeSelect.substring(restOfUrldateTypeSelect.indexOf("=") + 1, restOfUrldateTypeSelect.length);
                                            }
                                            if (dateTypeSelect.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='dateTypeSelect' name='dateTypeSelect' value='" + dateTypeSelect + "' />");
                                            }
                                        }
                                        break;

                                      default:
                                        if (keyValue.length == 2) {
                                            searchFilter.append("<input type='hidden' id='" + keyValue[0] + "' name='" + decodeURIComponent(keyValue[0]) + "' value='" + decodeURIComponent(keyValue[1]) + "' />");
                                        }
                                    }
                                }
                                if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                    returnUrl = returnUrl.substring(0, returnUrl.indexOf("?"));
                                }
                            }
                            var actionUrl = returnUrl.replace("{{lat}}", encodeURI(d)).replace("{{lon}}", encodeURI(e)).replace("{{mode}}", encodeURI(cName)).replace("{{naptanId}}", encodeURI(stopId)).replace("{{stopName}}", encodeURI(a.toLowerCase().replace(/'/g, "").replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, "")));
                            if (actionUrl.toLowerCase().indexOf("bikepoint") !== -1 || actionUrl.toLowerCase().indexOf("poi") !== -1) {
                                actionUrl = "/maps?Input=" + encodeURI(a.toLowerCase().replace(/'/g, "").replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, ""));
                                $(inputEl).parents("form").append('<input type="hidden" id ="InputGeolocation" name="InputGeolocation" value="' + encodeURI(d + "," + e) + '" />');
                            }
                            if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                $(inputEl).parents("form").attr("action", actionUrl);
                            } else {
                                searchFilter.attr("action", actionUrl);
                            }
                        }
                        if (ajaxEnabled) {
                            searchResultSelected(searchFilter, {
                                resultType: o.resultType.StopPoint,
                                placeType: o.resultType.StopPoint,
                                lat: d,
                                lng: e,
                                id: b,
                                naptanId: b,
                                icsId: f,
                                placeName: a,
                                modes: c,
                                placeId: f,
                                icons: datum.displayIcons,
                                dataset: datum.datasetName
                            });
                            return;
                        }
                        if (returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) return;
                        if (tfl.utils.tabKeyEvent(event)) return;
                        $(inputEl).parents("form").submit();
                    };
                    autocompleteSources.push(tfl.autocomplete.sources.stopPointsSearchFactory(modesArr.toString(), stopsCallback, null, includeHubs, isOysterOnly, null, busStopsOnly, displaySelectedModesOnly, showFavourites, excludeFavourites, showRecents, fromFavPanel, isSspHome));
                    var favouritePlaces = tfl.autocomplete.favouritePlaces.getPlaces(showFavourites, modesArr, searchFilter, busStopsOnly, displaySelectedModesOnly, fromFavPanel);
                    if (favouritePlaces !== null && favouritePlaces.length > 0) {
                        var stopsSourceFavouritePlaces = tfl.autocomplete.sources.getFavouritePlaces("stops-favourite-places", favouritePlaces, stopsCallback, placesTemplate, "name");
                        favouritePlacesSources.push(stopsSourceFavouritePlaces);
                    }
                    var recentPlaces = tfl.autocomplete.recentMagicSearches.getPlaces(showRecents, modesArr, searchFilter, busStopsOnly, displaySelectedModesOnly, fromFavPanel);
                    if (recentPlaces && recentPlaces.length > 0) {
                        var stopsSourceRecentSearches = tfl.autocomplete.sources.getRecentSearches("stops-recent-magic-searches", recentPlaces, stopsCallback, placesTemplate, "name", null, recentSearchesSources.hasRecents);
                        recentSearchesSources.hasRecents = true;
                        recentSearchesSources.push(stopsSourceRecentSearches);
                    }
                } else if (dataSet == tfl.disambiguationDataSets.bikePoints) {
                    var bikePointsCallback = function(inputEl, datum, dataset, event) {
                        var a = datum.a || datum.name, b = datum.b || datum.id, c = [ "bch-docking-station" ], d = datum.d || datum.lat, e = datum.e || datum.lon, h = datum.h || datum.destination, f = d + "," + e + "|bikepoints", g = d + "," + e;
                        tfl.autocomplete.recentMagicSearches.saveSearch(a, b, c, "stops", d, e, null, null, h, busStopsOnly, f);
                        var searchFilter;
                        if (returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) {
                            if (inputEl.indexOf("search-filter-form-0") !== -1) {
                                searchFilter = $("div#search-filter-form-0.clearfix");
                                $("input#FromId").val(f).change();
                                $("input#From").val(a).change();
                            } else if (inputEl.indexOf("search-filter-form-1") !== -1) {
                                searchFilter = $("div#search-filter-form-1.clearfix");
                                $("input#ToId").val(f).change();
                                $("input#To").val(a).change();
                            } else {
                                searchFilter = $("div#search-filter-form-2.clearfix");
                                $("input#ViaId").val(f);
                                $("input#Via").val(a);
                            }
                        } else {
                            searchFilter = $(inputEl).parents("form");
                        }
                        var ajaxEnabled = searchFilter.data("ajax-enabled").toLowerCase() === "true";
                        if (!ajaxEnabled) {
                            removeHiddenInputs(searchFilter);
                        }
                        if (returnUrl !== null) {
                            if (returnUrl.indexOf("?") !== -1 || returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) {
                                var urlParameters = returnUrl.substring(returnUrl.indexOf("?") + 1), paramsHash = urlParameters.split("#"), keyValues = paramsHash[0].split("&");
                                for (var k = 0; k < keyValues.length; k++) {
                                    var keyValue = keyValues[k].split("=");
                                    switch (keyValue[0].toLowerCase()) {
                                      case "inputgeolocation":
                                        searchFilter.append('<input type="hidden" id ="InputGeolocation" name="InputGeolocation" value="' + encodeURI(g) + '" />');
                                        break;

                                      case "startdate":
                                        if (location.search.toLowerCase().indexOf("startdate") !== -1) {
                                            var restOfUrlStartDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("startdate")));
                                            var startDate = restOfUrlStartDate.substring(restOfUrlStartDate.indexOf("=") + 1, restOfUrlStartDate.indexOf("&") !== -1 ? restOfUrlStartDate.indexOf("&") : null);
                                            if (startDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='startDate' name='startDate' value='" + startDate + "' />");
                                            }
                                        }
                                        break;

                                      case "enddate":
                                        if (location.search.toLowerCase().indexOf("enddate") !== -1) {
                                            var restOfUrlEndDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("enddate")));
                                            var endDate = restOfUrlEndDate.substring(restOfUrlEndDate.indexOf("=") + 1, restOfUrlEndDate.indexOf("&") !== -1 ? restOfUrlEndDate.indexOf("&") : restOfUrlEndDate.length);
                                            if (endDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='endDate' name='endDate' value='" + endDate + "' />");
                                            }
                                        }
                                        break;

                                      case "stopid":
                                        searchFilter.append("<input type='hidden' id='stopId' name='stopId' value='" + b + "' />");
                                        break;

                                      case "input":
                                        break;

                                      default:
                                        if (keyValue.length == 2) {
                                            searchFilter.append("<input type='hidden' id='" + keyValue[0] + "' name='" + decodeURIComponent(keyValue[0]) + "' value='" + decodeURIComponent(keyValue[1]) + "' />");
                                        }
                                    }
                                }
                                if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                    returnUrl = returnUrl.substring(0, returnUrl.indexOf("?"));
                                }
                            }
                            var actionUrl = returnUrl.replace("{{lat}}", encodeURI(d)).replace("{{lon}}", encodeURI(e)).replace("{{naptanId}}", encodeURI(b)).replace("{{stopName}}", encodeURI(a.toLowerCase().replace(/'/g, "").replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, "")));
                            if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                $(inputEl).parents("form").attr("action", actionUrl);
                            } else {
                                searchFilter.attr("action", actionUrl);
                            }
                        }
                        if (ajaxEnabled) {
                            searchResultSelected(searchFilter, {
                                resultType: o.resultType.BikePoint,
                                placeType: o.resultType.BikePoint,
                                id: f,
                                lat: d,
                                lng: e,
                                placeName: a,
                                modes: [ "BikePoint" ],
                                icons: [ "bch-docking-station-icon" ],
                                dataset: "bikePoints-search"
                            });
                        } else if (submitWhenSelectGeoLocation && !tfl.utils.tabKeyEvent(event)) {
                            searchFilter.submit();
                        }
                    };
                    autocompleteSources.push(tfl.autocomplete.sources.bikePointsSearchFactory(bikePointsCallback));
                } else if (dataSet == tfl.disambiguationDataSets.routes) {
                    var routesCallback = function(inputEl, datum, dataset, event) {
                        var a = datum.a || datum.name, b = datum.b || datum.id, c = datum.c || datum.mode, f = datum.f || datum.cssClass, g = datum.g || datum.direction, h = datum.h || datum.destination, lineId = datum.k || datum.lineId, cName = c, inputText = a + " towards " + h;
                        $(inputEl).typeahead("val", inputText);
                        if (typeof c === "object" && c.length) {
                            cName = g && g.isHubStationStop ? tfl.modeNameMultiModal : getModeByRank(c);
                        }
                        tfl.autocomplete.recentMagicSearches.saveSearch(a, b, [ c ], "lines", null, null, f, g, h, null, null, null, lineId);
                        var searchFilter = $(inputEl).parents("form"), ajaxEnabled = searchFilter.data("ajax-enabled").toLowerCase() === "true";
                        if (!ajaxEnabled) {
                            removeHiddenInputs(searchFilter);
                        }
                        if (returnUrl !== null) {
                            if (returnUrl.indexOf("?") !== -1) {
                                var urlParameters = returnUrl.substring(returnUrl.indexOf("?") + 1), paramsHash = urlParameters.split("#"), keyValues = paramsHash[0].split("&");
                                for (var k = 0; k < keyValues.length; k++) {
                                    var keyValue = keyValues[k].split("=");
                                    switch (keyValue[0].toLowerCase()) {
                                      case "lineids":
                                        searchFilter.append("<input type='hidden' id='lineIds' name='lineIds' value='" + b + "' />");
                                        break;

                                      case "startdate":
                                        if (location.search.toLowerCase().indexOf("startdate") !== -1) {
                                            var restOfUrlStartDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("startdate")));
                                            var startDate = restOfUrlStartDate.substring(restOfUrlStartDate.indexOf("=") + 1, restOfUrlStartDate.indexOf("&") !== -1 ? restOfUrlStartDate.indexOf("&") : null);
                                            if (startDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='startDate' name='startDate' value='" + startDate + "' />");
                                            }
                                        }
                                        break;

                                      case "enddate":
                                        if (location.search.toLowerCase().indexOf("enddate") !== -1) {
                                            var restOfUrlEndDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("enddate")));
                                            var endDate = restOfUrlEndDate.substring(restOfUrlEndDate.indexOf("=") + 1, restOfUrlEndDate.indexOf("&") !== -1 ? restOfUrlEndDate.indexOf("&") : restOfUrlEndDate.length);
                                            if (endDate.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='endDate' name='endDate' value='" + endDate + "' />");
                                            }
                                        }
                                        break;

                                      case "input":
                                        break;

                                      case "datetypeselect":
                                        if (location.search.toLowerCase().indexOf("datetypeselect") !== -1) {
                                            var restOfUrldateTypeSelect = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("datetypeselect")));
                                            var dateTypeSelect = null;
                                            if (restOfUrldateTypeSelect.indexOf("&") !== -1) {
                                                dateTypeSelect = restOfUrldateTypeSelect.substring(restOfUrldateTypeSelect.indexOf("=") + 1, restOfUrldateTypeSelect.indexOf("&"));
                                            } else {
                                                dateTypeSelect = restOfUrldateTypeSelect.substring(restOfUrldateTypeSelect.indexOf("=") + 1, restOfUrldateTypeSelect.length);
                                            }
                                            if (dateTypeSelect.indexOf("{{") === -1) {
                                                searchFilter.append("<input type='hidden' id='dateTypeSelect' name='dateTypeSelect' value='" + dateTypeSelect + "' />");
                                            }
                                        }
                                        break;

                                      default:
                                        if (keyValue.length == 2) {
                                            searchFilter.append("<input type='hidden' id='" + keyValue[0] + "' name='" + decodeURIComponent(keyValue[0]) + "' value='" + decodeURIComponent(keyValue[1]) + "' />");
                                        }
                                    }
                                }
                                returnUrl = returnUrl.substring(0, returnUrl.indexOf("?"));
                            }
                            var actionUrl = returnUrl.replace("{{stopName}}", encodeURI(a.toLowerCase().replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, ""))).replace("{{lineIds}}", encodeURI(lineId)).replace("{{mode}}", encodeURI(cName));
                            if (cName === tfl.modeNameBus && g !== null) {
                                searchFilter.append("<input type='hidden' name='direction' value='" + g + "'/>");
                            }
                            if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                $(inputEl).parents("form").attr("action", actionUrl);
                            } else {
                                searchFilter.attr("action", actionUrl);
                            }
                        }
                        if (ajaxEnabled) {
                            searchResultSelected(searchFilter, {
                                resultType: o.resultType.Route,
                                id: b,
                                mode: c
                            });
                        } else if (submitWhenSelectGeoLocation && !tfl.utils.tabKeyEvent(event)) {
                            searchFilter.submit();
                        }
                    };
                    var regexCharacterString = modesArr.length === 1 && modesArr[0].toString() === tfl.modeNameBus ? "[^a-zA-Z0-9]" : "[^a-zA-Z0-9 &-/().']";
                    if (isSspHome) {
                        var index = modesArr.indexOf("national-rail");
                        modesArr.splice(index, 1);
                    }
                    autocompleteSources.push(tfl.autocomplete.sources.routesSearchFactory(modesArr.toString(), routesCallback, regexCharacterString, showRecents, fromFavPanel, isSspHome));
                    var recentLines = tfl.autocomplete.recentMagicSearches.getLines(showRecents, modesArr);
                    if (recentLines && recentLines.length > 0) {
                        var routesSourceRecentSearches = tfl.autocomplete.sources.getRecentSearches("lines-recent-magic-searches", recentLines, routesCallback, "<span class='mode-icon {{mode}}-icon'>&nbsp;<span class='{{cssClass}}'>&nbsp;</span></span><span id='{{id}}' class='stop-name' data-id='{{id}}' role='option'>{{name}}{{#destination.length}}<span class='towards-text'> towards {{destination}}</span>{{/destination.length}}</span>", "name", null, recentSearchesSources.hasRecents);
                        recentSearchesSources.hasRecents = true;
                        recentSearchesSources.push(routesSourceRecentSearches);
                    }
                } else if (dataSet == tfl.disambiguationDataSets.placesExtra) {
                    searchFilter.addClass("powered-by-google");
                    var placesExtraCallback = function(inputEl, datum, dataset, event) {
                        var a = datum.a || datum.name, b = datum.b || datum.id, c = datum.c || datum.icon, d = datum.d || datum.lat, e = datum.e || datum.lon, h = datum.h || datum.destination, g = datum.g || datum.boundingBox;
                        b = tfl.utils.stringFormat("{0},{1}", d, e);
                        if (tfl.autocomplete.recentMagicSearches.usingRecentSearches) {
                            tfl.autocomplete.recentMagicSearches.saveSearch(a, b, [ "generic" ], "stops", d, e, null, null, h, busStopsOnly);
                        }
                        var searchFilter;
                        if (returnUrl.indexOf("journeyPlannerNoSubmit") !== -1) {
                            if (inputEl.indexOf("search-filter-form-0") !== -1) {
                                searchFilter = $("div#search-filter-form-0.clearfix");
                                $("input#FromId").val(d + "," + e).change();
                                $("input#From").val(a).change();
                            } else if (inputEl.indexOf("search-filter-form-1") !== -1) {
                                searchFilter = $("div#search-filter-form-1.clearfix");
                                $("input#ToId").val(d + "," + e).change();
                                $("input#To").val(a).change();
                            } else {
                                searchFilter = $("div#search-filter-form-2.clearfix");
                                $("input#ViaId").val(d + "," + e);
                                $("input#Via").val(a);
                            }
                        } else {
                            searchFilter = $(inputEl).parents("form");
                        }
                        var ajaxEnabled = searchFilter.data("ajax-enabled").toLowerCase() === "true";
                        if (!ajaxEnabled) {
                            removeHiddenInputs(searchFilter);
                        }
                        if (returnUrl !== null) {
                            if (returnUrl.indexOf("?") !== -1 || returnUrl.indexOf("journeyPlannerNoSubmit") !== -1 || returnUrl.indexOf("acc-stats") !== -1) {
                                var urlParameters = returnUrl.substring(returnUrl.indexOf("?"));
                                if (urlParameters.toLowerCase().indexOf("inputgeolocation") !== -1) {
                                    searchFilter.append('<input type="hidden" id ="InputGeolocation" name="InputGeolocation" value="' + encodeURI(d + "," + e) + '" />');
                                }
                                if (urlParameters.toLowerCase().indexOf("startdate") !== -1 && location.search.toLowerCase().indexOf("startdate") !== -1) {
                                    var restOfUrlStartDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("startdate")));
                                    var startDate = restOfUrlStartDate.substring(restOfUrlStartDate.indexOf("=") + 1, restOfUrlStartDate.indexOf("&") !== -1 ? restOfUrlStartDate.indexOf("&") : null);
                                    searchFilter.append("<input type='hidden' id='startDate' name='startDate' value='" + startDate + "' />");
                                }
                                if (urlParameters.toLowerCase().indexOf("enddate") !== -1 && location.search.toLowerCase().indexOf("enddate") !== -1) {
                                    var restOfUrlEndDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("enddate")));
                                    var endDate = restOfUrlEndDate.substring(restOfUrlEndDate.indexOf("=") + 1, restOfUrlEndDate.indexOf("&") !== -1 ? restOfUrlEndDate.indexOf("&") : restOfUrlEndDate.length);
                                    searchFilter.append("<input type='hidden' id='endDate' name='endDate' value='" + endDate + "' />");
                                }
                                if (urlParameters.toLowerCase().indexOf("stopid") !== -1) {
                                    searchFilter.append("<input type='hidden' id='stopId' name='stopId' value='" + b + "' />");
                                }
                                if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1 && returnUrl.indexOf("acc-stats") === -1) {
                                    returnUrl = returnUrl.substring(0, returnUrl.indexOf("?"));
                                }
                            }
                            var actionUrl = returnUrl.replace("{{lat}}", encodeURI(d)).replace("{{lon}}", encodeURI(e)).replace("{{stopName}}", encodeURI(a.toLowerCase().replace(/'/g, "").replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, "")));
                            if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1) {
                                $(inputEl).parents("form").attr("action", actionUrl);
                            } else {
                                searchFilter.attr("action", actionUrl);
                            }
                        }
                        if (ajaxEnabled) {
                            searchResultSelected(searchFilter, {
                                resultType: o.resultType.PlaceExtra,
                                lat: d,
                                lng: e,
                                boundingBox: g,
                                placesExtraFullName: a,
                                id: tfl.utils.stringFormat("{0},{1}", d, e),
                                placeName: a,
                                modes: [ "generic" ],
                                icons: [ c ],
                                dataset: tfl.disambiguationDataSets.placesExtra
                            });
                        } else if (submitWhenSelectGeoLocation && !tfl.utils.tabKeyEvent(event)) {
                            searchFilter.submit();
                        }
                    };
                    autocompleteSources.push(tfl.autocomplete.sources.placesExtraSearchFactory(placesExtraCallback, searchFilter, showFavourites, excludeFavourites, showRecents, fromFavPanel));
                } else if (dataSet === tfl.disambiguationDataSets.taxiRanks) {
                    var placesSearchCallback = getPlacesSearchCallback(returnUrl);
                    autocompleteSources.push(tfl.autocomplete.sources.placesSearchFactory(placesSearchCallback));
                    return true;
                }
            });
            function getModeByRank(modes) {
                var orderedModes = [];
                modes.forEach(function(curr) {
                    var val = tfl.modeRanks.find(function(el) {
                        return el.name === curr;
                    });
                    if (val) {
                        orderedModes.push(val);
                    }
                });
                orderedModes.sort(function(a, b) {
                    return a.rank - b.rank;
                });
                if (orderedModes.length) {
                    return orderedModes[0].name;
                }
                return modes[0];
            }
        }
        function destroyAutocomplete(searchFilter) {
            var searchFilterInput = searchFilter.find('[id^=Input], input[data-typeahead="true"]');
            searchFilterInput.parent().siblings(tfl.dictionary.RemoveContentClass).unbind("clear-search-box");
            searchFilterInput.typeahead("destroy");
            searchFilterInput.off("typeahead:selected typeahead:autocompleted keydown.autocomplete");
        }
        function autocompleteAddFavouritePlaces() {
            if (tfl.isLocalStorageSupported) {
                if (favouritePlacesSources.length) {
                    Array.prototype.splice.apply(autocompleteSources, [ 0, 0 ].concat(favouritePlacesSources));
                }
            }
        }
        function autocompleteAddRecentSearchesSources() {
            if (tfl.isLocalStorageSupported) {
                if (recentSearchesSources.length) {
                    Array.prototype.splice.apply(autocompleteSources, [ 0, 0 ].concat(limitNumberRecentSearches(recentSearchesSources)));
                }
            }
        }
        function limitNumberRecentSearches(sources) {
            var topRecentSearches = [];
            $(sources).each(function() {
                if (typeof this === "function") return;
                var source = this;
                for (var j = 0; j < source.dataEngine.local.length; j++) {
                    var item = source.dataEngine.local[j];
                    topRecentSearches.push([ item.type + "_" + item.id, item.lastSearchDate ]);
                }
            });
            if (topRecentSearches.length > tfl.autocomplete.recentMagicSearches.recentSearchNumberLimit) {
                topRecentSearches.sort(function(a, b) {
                    if (a[1] < b[1]) return 1;
                    if (a[1] > b[1]) return -1;
                    return 0;
                });
                topRecentSearches.length = tfl.autocomplete.recentMagicSearches.recentSearchNumberLimit;
                for (var k = 0; k < sources.length; k++) {
                    var recentSearchSource = sources[k], originalLength = recentSearchSource.dataEngine.local.length, deleteCounter = 0;
                    for (var l = 0; l < originalLength; l++) {
                        var removeItem = true, recentSearchItem = recentSearchSource.dataEngine.local[l - deleteCounter];
                        for (var m = 0; m < topRecentSearches.length; m++) {
                            if (recentSearchItem.type + "_" + recentSearchItem.id === topRecentSearches[m][0]) {
                                removeItem = false;
                                break;
                            }
                        }
                        if (removeItem) {
                            var index = recentSearchSource.dataEngine.local.indexOf(recentSearchItem);
                            if (index > -1) {
                                deleteCounter++;
                                recentSearchSource.dataEngine.local.splice(index, 1);
                            }
                        }
                    }
                }
            }
            return sources;
        }
        function autocompleteAddGeolocation(searchFilter) {
            if (searchFilter.data("include-geolocation") && searchFilter.data("include-geolocation").toLowerCase() === "true" && tfl.geolocation.isGeolocationSupported()) {
                var geoCallback = function(data, thisSearchFilter) {
                    var ajaxEnabled = thisSearchFilter.data("ajax-enabled").toLowerCase() === "true";
                    var currentLocationSubmitUrl = thisSearchFilter.data("current-location-submit-url");
                    if (ajaxEnabled) {
                        searchResultSelected(thisSearchFilter, {
                            resultType: o.resultType.CurrentLocation,
                            lat: data.latitude,
                            lng: data.longitude
                        });
                    } else {
                        removeHiddenInputs(thisSearchFilter, "InputGeolocation");
                        addGeolocationHiddenInput(thisSearchFilter, data.latitude, data.longitude);
                        thisSearchFilter.attr("action", currentLocationSubmitUrl || nearUrl);
                        thisSearchFilter.submit();
                    }
                };
                if (!allowGeoLocationSubmit) {
                    geoCallback = null;
                }
                var sourceGeolocation = tfl.autocomplete.sources.getGeolocation(geoCallback);
                autocompleteSources.splice(0, 0, sourceGeolocation);
            }
        }
        function showRecentPlaces($searchFilter) {
            return tfl.autocomplete.recentMagicSearches.usingRecentSearches && includeLocalSources($searchFilter, false);
        }
        function showFavouritePlaces($searchFilter) {
            return tfl.isLocalStorageSupported && includeLocalSources($searchFilter, true);
        }
        function excludeFavouritePlaces($searchFilter) {
            return tfl.isLocalStorageSupported && excludeLocalSources($searchFilter, true);
        }
        function includeLocalSources($searchFilter, isFavourite) {
            if ($($searchFilter).parent().find("#IsSspHome").length > 0) {
                return false;
            } else if (isFavourite && $($searchFilter).parent().find("#search-filter-form-fav-place").length > 0) {
                return false;
            }
            return true;
        }
        function excludeLocalSources($searchFilter, isFavourite) {
            if (isFavourite && $($searchFilter).parent().find("#search-filter-form-fav-place").length > 0) {
                return true;
            }
            return false;
        }
        function getPlacesSearchCallback(url) {
            var returnUrl = url;
            return function(inputEl, datum) {
                var callback, a = datum.a || datum.name, b = datum.b || datum.id, c = datum.c || datum.icon, d = datum.d || datum.lat, e = datum.e || datum.lon, h = datum.h || datum.destination, g = datum.g || datum.boundingBox, actionUrl = null, searchFilter = $(inputEl).parents("form"), ajaxEnabled = searchFilter.data("ajax-enabled").toLowerCase() === "true";
                b = tfl.utils.stringFormat("{0},{1}", d, e);
                if (!ajaxEnabled) {
                    removeHiddenInputs(searchFilter);
                }
                if (returnUrl !== null) {
                    if (returnUrl.indexOf("?") !== -1 || returnUrl.indexOf("journeyPlannerNoSubmit") !== -1 || returnUrl.indexOf("acc-stats") !== -1) {
                        var urlParameters = returnUrl.substring(returnUrl.indexOf("?"));
                        if (urlParameters.toLowerCase().indexOf("inputgeolocation") !== -1) {
                            searchFilter.append('<input type="hidden" id ="InputGeolocation" name="InputGeolocation" value="' + encodeURI(d + "," + e) + '" />');
                        }
                        if (urlParameters.toLowerCase().indexOf("startdate") !== -1 && location.search.toLowerCase().indexOf("startdate") !== -1) {
                            var restOfUrlStartDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("startdate")));
                            var startDate = restOfUrlStartDate.substring(restOfUrlStartDate.indexOf("=") + 1, restOfUrlStartDate.indexOf("&") !== -1 ? restOfUrlStartDate.indexOf("&") : null);
                            searchFilter.append("<input type='hidden' id='startDate' name='startDate' value='" + startDate + "' />");
                        }
                        if (urlParameters.toLowerCase().indexOf("enddate") !== -1 && location.search.toLowerCase().indexOf("enddate") !== -1) {
                            var restOfUrlEndDate = decodeURIComponent(location.search.substring(location.search.toLowerCase().indexOf("enddate")));
                            var endDate = restOfUrlEndDate.substring(restOfUrlEndDate.indexOf("=") + 1, restOfUrlEndDate.indexOf("&") !== -1 ? restOfUrlEndDate.indexOf("&") : restOfUrlEndDate.length);
                            searchFilter.append("<input type='hidden' id='endDate' name='endDate' value='" + endDate + "' />");
                        }
                        if (urlParameters.toLowerCase().indexOf("stopid") !== -1) {
                            searchFilter.append("<input type='hidden' id='stopId' name='stopId' value='" + b + "' />");
                        }
                        if (returnUrl.indexOf("journeyPlannerNoSubmit") === -1 && returnUrl.indexOf("acc-stats") === -1) {
                            returnUrl = returnUrl.substring(0, returnUrl.indexOf("?"));
                        }
                    }
                    actionUrl = returnUrl.replace("{{lat}}", encodeURI(d)).replace("{{lon}}", encodeURI(e)).replace("{{stopName}}", encodeURI(a.toLowerCase().replace(/'/g, "").replace(/[^a-z0-9]/g, "-").replace(/-+/g, "-").replace(/-$/g, "").replace(/^-/g, "")));
                    searchFilter.attr("action", actionUrl);
                }
                if (ajaxEnabled) {
                    searchResultSelected(searchFilter, {
                        resultType: o.resultType.TaxiRank,
                        boundingBox: g,
                        placesExtraFullName: a,
                        id: tfl.utils.stringFormat("{0},{1}", d, e),
                        placeName: a,
                        modes: [ "generic" ],
                        icons: [ c ],
                        dataset: tfl.disambiguationDataSets.taxiRanks
                    });
                } else {
                    searchFilter.submit();
                }
                return callback;
            };
        }
    };
    if (!$(".jp-external-widget-container").length) {
        o.init();
    }
})(window.tfl.searchFilter = window.tfl.searchFilter || {});

(function(mapTrack, $, undefined) {
    "use strict";
    tfl.logs.create("tfl.mapTracking: loaded");
    var evar = tfl.dictionary.TrackingEvar;
    var event = tfl.dictionary.TrackingEvent;
    var prop = tfl.dictionary.TrackingProp;
    mapTrack.mapActivity = {
        UNSPECIFIED: 0,
        LOAD: 1,
        OPENFULLSCREEN: 2
    };
    mapTrack.trackOpenMapView = function(e) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        var trackingItem = {};
        trackingItem[event.Name] = event.MapViewClicked_prop45;
        trackingItem[prop.MapView_45.Name] = prop.MapView_45.Value;
        trackingItem[prop.PageName_46.Name] = tfl.stats.pageName;
        tfl.stats.tealiumTracking(trackingItem);
    };
    mapTrack.trackMapActivity = function(activity) {
        if (!tfl.stats.tealiumTracking) {
            return;
        }
        function getValue(activity) {
            switch (activity) {
              case mapTrack.mapActivity.LOAD:
                return prop.MapActivity_47.ValueLoadMap;

              case mapTrack.mapActivity.OPENFULLSCREEN:
                return prop.MapActivity_47.ValueOpenFullScreen;

              default:
                return prop.MapActivity_47.Value;
            }
        }
        var trackingItem = {};
        trackingItem[prop.PageName_46.Name] = tfl.stats.pageName;
        trackingItem[event.Name] = event.MapActivity_prop47;
        trackingItem[prop.MapActivity_47.Name] = getValue(activity);
        tfl.stats.tealiumTracking(trackingItem);
    };
})(window.tfl.mapTrack = window.tfl.mapTrack || {}, jQuery);

(function ActivateDisableButtonOnSubmit(DisableButtonOnSubmit) {
    var disableButtonClass = ".button--submit-disabled", showPleaseWait = false, pleaseWaitMessage = "Please Wait";
    function getFormSelector() {
        var parts = [ "form:has(input[type='submit']", disableButtonClass, ")" ];
        return $(parts.join(""));
    }
    function disableSubmitButton($targetButton) {
        if ($targetButton.data("button-clicked")) {
            $targetButton.preventDefault();
            return;
        }
        $targetButton.data("button-clicked", true);
        $targetButton.addClass("disabled-button");
    }
    function overrideFormSubmit($this) {
        var $targetButton = $this.find(disableButtonClass);
        if (showPleaseWait) {
            $targetButton.val(pleaseWaitMessage);
        }
        disableSubmitButton($targetButton);
        return true;
    }
    function compose() {
        var $formsWithDisableButtons = getFormSelector();
        if ($formsWithDisableButtons.length > 0) {
            $formsWithDisableButtons.submit(function() {
                overrideFormSubmit($(this));
            });
        }
    }
    function initialiseParameters(submitButtonClass, showPleaseWaitMessage, pleaseWaitMessageText) {
        disableButtonClass = submitButtonClass || ".button--submit-disabled";
        showPleaseWait = showPleaseWaitMessage || false;
        pleaseWaitMessageText = pleaseWaitMessageText || "Please Wait";
    }
    DisableButtonOnSubmit.init = activate;
    function activate(submitButtonClass, showPleaseWaitMessage, pleaseWaitMessageText) {
        initialiseParameters(submitButtonClass, showPleaseWaitMessage, pleaseWaitMessageText);
        $(function() {
            compose();
        });
    }
})(window.tfl.DisableButtonOnSubmit = window.tfl.DisableButtonOnSubmit || {});